<!doctype html><html lang=zh-tw><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>SnowFlake DistributionKey - Bill.Lin's Notes</title><meta name=description content="技術筆記與開發心得分享"><link rel=stylesheet href=http://localhost:1313/css/style.min.css><link rel=stylesheet href=http://localhost:1313/css/chroma.min.css><link rel=icon type=image/svg+xml href=/images/Bill-coding.svg><link rel=icon type=image/x-icon href=/images/Bill-coding.ico><meta property="og:title" content="SnowFlake DistributionKey"><meta property="og:description" content="技術筆記與開發心得分享"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/post/architecture/snowflake-distributionkey/"></head><body><div class=container><header class=header><nav class=nav><div class=nav-left><a href=http://localhost:1313/ class=nav-title><img src=/images/Bill-coding.svg alt="Site Icon" class=nav-icon>
Bill.Lin's Notes</a></div><div class=nav-center><a href=http://localhost:1313/ class=avatar-link><div class=avatar-container><div class=avatar-ring></div><img src=/images/Bill-coding.svg alt="Bill's Avatar" class=nav-avatar-center></div></a></div><div class=nav-right><ul class=nav-menu><li class=nav-item><a href=http://localhost:1313/ class=nav-link>Me</a></li><li class=nav-item><a href=/posts/ class="nav-link posts">Posts</a></li><li class=nav-item><a href=/categories/ class="nav-link categories">Categories</a></li></ul></div></nav></header><main class=main-content><article class=post><header class=post-header><h1 class=post-title>SnowFlake DistributionKey</h1><div class=post-meta><div class=post-info><time class=post-date>2022年09月13日</time>
<span class=post-author>by Bill.Lin</span>
<span class=reading-time>4 分鐘閱讀</span></div><div class=post-categories><a href=/categories/architecture class=category-link>Architecture</a></div></div></header><div class=post-content><h1 id=snowflake---distribution-key>Snowflake - Distribution Key</h1><h3 id=單體式-id>單體式 ID</h3><p>一般單體式 UUID(Universally Unique identifier)
8-4-4-4-12 總共 32 個 16 進位</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>()</span><span class=w>  </span><span class=c1>// 80e06459-942d-4a63-9fd4-81691b127363</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>優點<ul><li>性能高</li><li>本地生成</li><li>無網路延遲</li></ul></li><li>缺點<ul><li>無順序性</li><li>字串不適合存 db 當 index or PK 且 32 長度太長</li><li>因無序 所以對 b+ Tree 來說 插入時效能低</li><li>極小機會但 會重複
=> ＤＢ 解法: replace into<br>跟insert功能類似, 但 replace into 會檢查是否存在, 如存在則先刪除, 再插入, 否则直接插入</li></ul></li></ul><h3 id=分佈式-id>分佈式 ID</h3><p>twitter 開發的 雪花算法 - snowflake
總共 64 bit</p><ul><li><p>1bit
不用，因為二進制中最高位是符號位，1表示負數，0表示正數。
生成的id一般都是用整數，所以最高位固定為0。</p></li><li><p>41bit-時間戳，用來記錄時間戳，亳秒級。
41位可以表示 2^41-1個數字，
如果只用來表示正整數(計算機中正數包含0)，可以表示的數值範圍是: 0 至 2^41 - 1， 減1是因為可表示的數值範圍是從0開始算的，而不是1.也就是說41位可以表示 2^41 - 1 個毫秒的值，轉化成單位年則是( 2^41 - 1 )/ (1000* 60 * 60 * 24 *365)= 69年</p></li><li><p>10bit-工作機器id,用來記錄工作機器id.
可以部署在 2^10 = 1024 個節點，包括5位 dataCenterId 和 15 位 workerId
5位(bit) 可以表示的最大正整數是 2^5-1 = 31，即可以用 0, 1, 2, 3&mldr; 這 32 個數字來表示不同的 dataCenterId 或 workerId</p></li><li><p>12bit, 序列號，序列號，用來記錄同毫秒內產生的不同id.
12位(bit) 可以表示的最大正整數是 2^12 - 1 = 4095，即可以用 0, 1, 2, 3&mldr; 4094 這 4095 個數字,
來表示同一機器同一時間截(毫秒)內產生的 4095 個ID序號。</p></li></ul><ul><li>優點</li></ul><ul><li>全局唯一性</li><li>递增性, 確保生成 ID 對於用户或業務是递增的。</li><li>高可用性, 確保任何時候都能生成正確的 ID</li><li>高性能, 在高併發下依然 ok</li><li>亳秒数在高位，自增序列在低位，整個 ID 都是遞增的。</li></ul><ul><li>缺點</li></ul><ul><li>依賴機器時鐘，如果機器時鐘回撥，會導致重複 ID 生成</li><li>在單機上是遞增的，但是由於設計到分佈式環境，每台機器上的時鐘不可能完全同步，有時候會出現不是全局遞增的情況(此缺點可以認為無所謂，- .般分佈式ID只要求趨勢遞增，並不會嚴格要求遞增，90%的需求都只要求趨勢遞增)</li></ul><ul><li>additional 解決機器時鐘回撥問題</li></ul><ul><li>Leaf - 美團點評分佈式ID生成系統</li><li>百度 open source - UidGenerator</li></ul><h3 id=java-sample-code>java sample code</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SnowflakeIdWorker</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 开始时间截 (2015-01-01)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>twepoch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1420041600000L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 机器id所占的位数
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>workerIdBits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 数据标识id所占的位数
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>datacenterIdBits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 支持的最大机器id，结果是31 (这个移位算法可以很快的计算出几位二进制数所能表示的最大十进制数)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>maxWorkerId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1L</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=o>-</span><span class=n>1L</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>workerIdBits</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 支持的最大数据标识id，结果是31
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>maxDatacenterId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1L</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=o>-</span><span class=n>1L</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>datacenterIdBits</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 序列在id中占的位数
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>sequenceBits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>12L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 机器ID向左移12位
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>workerIdShift</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sequenceBits</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 数据标识id向左移17位(12+5)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>datacenterIdShift</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sequenceBits</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>workerIdBits</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 时间截向左移22位(5+5+12)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>timestampLeftShift</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sequenceBits</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>workerIdBits</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>datacenterIdBits</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 生成序列的掩码，这里为4095 (0b111111111111=0xfff=4095)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>sequenceMask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1L</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=o>-</span><span class=n>1L</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>sequenceBits</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 工作机器ID(0~31)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>workerId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 数据中心ID(0~31)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>datacenterId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 毫秒内序列(0~4095)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>sequence</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 上次生成ID的时间截
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>lastTimestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 构造函数
</span></span></span><span class=line><span class=cl><span class=cm>     * @param workerId     工作ID (0~31)
</span></span></span><span class=line><span class=cl><span class=cm>     * @param datacenterId 数据中心ID (0~31)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SnowflakeIdWorker</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>workerId</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>datacenterId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>workerId</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>maxWorkerId</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>workerId</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;worker Id can&#39;t be greater than %d or less than 0&#34;</span><span class=p>,</span><span class=w> </span><span class=n>maxWorkerId</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>datacenterId</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>maxDatacenterId</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>datacenterId</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;datacenter Id can&#39;t be greater than %d or less than 0&#34;</span><span class=p>,</span><span class=w> </span><span class=n>maxDatacenterId</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>workerId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>workerId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>datacenterId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>datacenterId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获得下一个ID (该方法是线程安全的)
</span></span></span><span class=line><span class=cl><span class=cm>     * @return SnowflakeId
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>nextId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeGen</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果当前时间小于上一次ID生成的时间戳，说明系统时钟回退过这个时候应当抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>timestamp</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>lastTimestamp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;Clock moved backwards.  Refusing to generate id for %d milliseconds&#34;</span><span class=p>,</span><span class=w> </span><span class=n>lastTimestamp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timestamp</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果是同一时间生成的，则进行毫秒内序列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastTimestamp</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>timestamp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sequence</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>sequence</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sequenceMask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 毫秒内序列溢出</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sequence</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//阻塞到下一个毫秒,获得新的时间戳</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tilNextMillis</span><span class=p>(</span><span class=n>lastTimestamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 时间戳改变，毫秒内序列重置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sequence</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 上次生成ID的时间截</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastTimestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timestamp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 移位并通过或运算拼到一起组成64位的ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>timestamp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>twepoch</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>timestampLeftShift</span><span class=p>)</span><span class=w> </span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>datacenterId</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>datacenterIdShift</span><span class=p>)</span><span class=w> </span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>workerId</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>workerIdShift</span><span class=p>)</span><span class=w> </span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>|</span><span class=w> </span><span class=n>sequence</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 阻塞到下一个毫秒，直到获得新的时间戳
</span></span></span><span class=line><span class=cl><span class=cm>     * @param lastTimestamp 上次生成ID的时间截
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 当前时间戳
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>tilNextMillis</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>lastTimestamp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeGen</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>timestamp</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>lastTimestamp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timeGen</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>timestamp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 返回以毫秒为单位的当前时间
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 当前时间(毫秒)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>timeGen</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SnowflakeIdWorker</span><span class=w> </span><span class=n>idWorker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SnowflakeIdWorker</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>idWorker</span><span class=p>.</span><span class=na>nextId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>reference:<br><a href=https://github.com/twitter-archive/snowflake>https://github.com/twitter-archive/snowflake</a><br><a href=https://github.com/beyondfengyu/SnowFlake/blob/master/SnowFlake.java>https://github.com/beyondfengyu/SnowFlake/blob/master/SnowFlake.java</a><br><a href=https://blog.csdn.net/qq_45408390/article/details/119793810>https://blog.csdn.net/qq_45408390/article/details/119793810</a><br></p></div></article><nav class=post-nav><div class=post-nav-links><div class=post-nav-prev><span class=post-nav-label>上一篇</span>
<a href=http://localhost:1313/post/algorithm/backtracking/ class=post-nav-link>回溯演算法（Backtracking）完整指南</a></div><div class=post-nav-next><span class=post-nav-label>下一篇</span>
<a href=http://localhost:1313/post/algorithm/unionfind/ class=post-nav-link>並查集（Union-Find）演算法完整指南</a></div></div></nav></main><footer class=footer><div class=footer-content><p>&copy; 2025 Bill Lin. All rights reserved.</p><div class=social-links><a href=https://github.com/xinqilin class=social-link target=_blank rel=noopener>github</a></div></div></footer></div></body></html>