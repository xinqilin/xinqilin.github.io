<!doctype html><html lang=zh-tw><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Kotlin lateinit 完整實作指南：延遲初始化與企業級開發最佳實踐 - Bill.Lin's Notes</title><meta name=description content="深入探討 Kotlin lateinit 關鍵字的完整實作指南，包含延遲初始化機制、與 lazy 的比較、企業級應用場景、效能優化與最佳實踐"><link rel=stylesheet href=https://xinqilin.github.io/css/style.min.css><link rel=stylesheet href=https://xinqilin.github.io/css/chroma.min.css><link rel=icon type=image/svg+xml href=/images/Bill-coding.svg><link rel=icon type=image/x-icon href=/images/Bill-coding.ico><meta property="og:title" content="Kotlin lateinit 完整實作指南：延遲初始化與企業級開發最佳實踐"><meta property="og:description" content="深入探討 Kotlin lateinit 關鍵字的完整實作指南，包含延遲初始化機制、與 lazy 的比較、企業級應用場景、效能優化與最佳實踐"><meta property="og:type" content="article"><meta property="og:url" content="https://xinqilin.github.io/post/backend/lateinit/"></head><body><div class=container><header class=header><nav class=nav><div class=nav-left><a href=https://xinqilin.github.io/ class=nav-title><img src=/images/Bill-coding.svg alt="Site Icon" class=nav-icon>
Bill.Lin's Notes</a></div><div class=nav-center><a href=https://xinqilin.github.io/ class=avatar-link><div class=avatar-container><div class=avatar-ring></div><img src=/images/Bill-coding.svg alt="Bill's Avatar" class=nav-avatar-center></div></a></div><div class=nav-right><ul class=nav-menu><li class=nav-item><a href=https://xinqilin.github.io/ class=nav-link>Me</a></li><li class=nav-item><a href=/posts/ class="nav-link posts">Posts</a></li><li class=nav-item><a href=/categories/ class="nav-link categories">Categories</a></li><li class=nav-item id=search-container><a href=# id=search-trigger class=nav-link>Search</a>
<input type=text id=search-input placeholder=Search...><div id=search-results-container></div></li></ul></div></nav></header><style>.container{max-width:1100px}#search-container{position:relative}#search-input{position:absolute;top:50%;left:0;transform:translateY(-50%);height:100%;width:0;padding:0;margin:0;opacity:0;visibility:hidden;border:none;border-radius:12px;font-family:inherit;font-size:1em;color:#4a5568;background-color:#fff;outline:none;transition:width .35s ease,opacity .3s ease,padding .35s ease;z-index:10}#search-container.search-active #search-trigger{opacity:0;visibility:hidden}#search-container.search-active #search-input{width:220px;padding:.6rem 1.2rem;opacity:1;visibility:visible;box-shadow:0 4px 20px rgba(0,0,0,.1);border:1px solid #e2e8f0}#search-results-container{display:none;position:absolute;top:calc(100% + 5px);left:0;width:320px;max-height:400px;overflow-y:auto;background-color:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 8px 25px rgba(0,0,0,.15);z-index:1001}.search-result-link{display:block;text-decoration:none;color:inherit;padding:12px 15px;border-bottom:1px solid #eee;transition:background-color .2s ease}.search-result-link:hover{background-color:#f8f9fa}.search-result-link:last-child{border-bottom:none}.search-result-title{font-size:1em;font-weight:600;color:#333;margin:0 0 5px}.search-result-link:hover .search-result-title{color:#61c8e0}.search-result-summary{font-size:.9em;color:#666;margin:0;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}</style><main class=main-content><article class=post><header class=post-header><h1 class=post-title>Kotlin lateinit 完整實作指南：延遲初始化與企業級開發最佳實踐</h1><div class=post-meta><div class=post-info><time class=post-date>2021年08月05日</time>
<span class=post-author>by Bill.Lin</span>
<span class=reading-time>15 分鐘閱讀</span></div><div class=post-categories><a href=/categories/backend class=category-link>Backend</a></div></div></header><div class=post-content><h2 id=kotlin-lateinit-完整實作指南>Kotlin lateinit 完整實作指南</h2><h3 id=簡介>簡介</h3><p>在 Kotlin 開發中，<code>lateinit</code> 關鍵字提供了一種延遲初始化屬性的優雅方式，特別適用於依賴注入、Android 開發和 Spring Boot 應用。本文將深入探討 <code>lateinit</code> 的工作原理、使用場景、與 <code>lazy</code> 的比較，以及在企業級開發中的最佳實踐。</p><h3 id=lateinit-基本概念>lateinit 基本概念</h3><h4 id=核心特性>核心特性</h4><p><code>lateinit</code> 是 Kotlin 提供的延遲初始化修飾符，允許開發者聲明非空屬性而不需要立即初始化：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 延遲初始化，避免空值檢查
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>userRepository</span><span class=p>:</span> <span class=n>UserRepository</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>cacheManager</span><span class=p>:</span> <span class=n>CacheManager</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeServices</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>userRepository</span> <span class=p>=</span> <span class=n>UserRepositoryImpl</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cacheManager</span> <span class=p>=</span> <span class=n>RedisCacheManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>findUser</span><span class=p>(</span><span class=n>id</span><span class=p>:</span> <span class=n>Long</span><span class=p>):</span> <span class=n>User</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 直接使用，無需空值檢查
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>userRepository</span><span class=p>.</span><span class=n>findById</span><span class=p>(</span><span class=n>id</span><span class=p>)</span> <span class=o>?:</span> <span class=k>throw</span> <span class=n>UserNotFoundException</span><span class=p>(</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=語法規則與限制>語法規則與限制</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>PropertyRules</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ✅ 正確：var 屬性
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>validProperty</span><span class=p>:</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// ❌ 錯誤：lateinit 不能用於 val
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// lateinit val invalidProperty: String // 編譯錯誤
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=c1>// ❌ 錯誤：原始類型不支援
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// lateinit var invalidInt: Int // 編譯錯誤
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=c1>// ❌ 錯誤：可空類型不支援
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// lateinit var invalidNullable: String? // 編譯錯誤
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=c1>// ✅ 正確：自定義類別
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>database</span><span class=p>:</span> <span class=n>Database</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// ✅ 正確：介面類型
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>service</span><span class=p>:</span> <span class=n>ServiceInterface</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=lateinit-詳細機制>lateinit 詳細機制</h3><h4 id=內部實現原理>內部實現原理</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=c1>// Kotlin 編譯後的 Java 等效代碼
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>public</span> <span class=k>class</span> <span class=nc>UserService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=n>String</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>final</span> <span class=n>String</span> <span class=n>getName</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>var1</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>var1</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nc>Intrinsics</span><span class=p>.</span><span class=n>throwUninitializedPropertyAccessException</span><span class=p>(</span><span class=s2>&#34;name&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>var1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>final</span> <span class=n>void</span> <span class=n>setName</span><span class=p>(</span><span class=n>String</span> <span class=k>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nc>Intrinsics</span><span class=p>.</span><span class=n>checkNotNullParameter</span><span class=p>(</span><span class=k>value</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>name</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=初始化檢查機制>初始化檢查機制</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>InitializationChecker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>database</span><span class=p>:</span> <span class=n>Database</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>config</span><span class=p>:</span> <span class=n>AppConfig</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>checkInitialization</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 檢查是否已初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>database</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>println</span><span class=p>(</span><span class=s2>&#34;Database is ready&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>println</span><span class=p>(</span><span class=s2>&#34;Database not initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 安全初始化模式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>config</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>config</span> <span class=p>=</span> <span class=n>loadDefaultConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>safeAccess</span><span class=p>():</span> <span class=n>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>database</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>database</span><span class=p>.</span><span class=n>getConnectionInfo</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Database not available&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=企業級應用場景>企業級應用場景</h3><h4 id=1-spring-boot-依賴注入>1. Spring Boot 依賴注入</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserManagementService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>userRepository</span><span class=p>:</span> <span class=n>UserRepository</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>emailService</span><span class=p>:</span> <span class=n>EmailService</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>auditService</span><span class=p>:</span> <span class=n>AuditService</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\$</span><span class=s2>{app.user.max-login-attempts}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>maxLoginAttempts</span><span class=p>:</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@PostConstruct</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>validateDependencies</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>userRepository</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;UserRepository not injected&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>emailService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;EmailService not injected&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>auditService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;AuditService not injected&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;All dependencies initialized successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>createUser</span><span class=p>(</span><span class=n>userData</span><span class=p>:</span> <span class=n>UserCreateRequest</span><span class=p>):</span> <span class=n>User</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>user</span> <span class=p>=</span> <span class=n>User</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>email</span> <span class=p>=</span> <span class=n>userData</span><span class=p>.</span><span class=n>email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>username</span> <span class=p>=</span> <span class=n>userData</span><span class=p>.</span><span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>hashedPassword</span> <span class=p>=</span> <span class=n>hashPassword</span><span class=p>(</span><span class=n>userData</span><span class=p>.</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>savedUser</span> <span class=p>=</span> <span class=n>userRepository</span><span class=p>.</span><span class=n>save</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 發送歡迎郵件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>emailService</span><span class=p>.</span><span class=n>sendWelcomeEmail</span><span class=p>(</span><span class=n>savedUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 記錄審計日誌
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>auditService</span><span class=p>.</span><span class=n>logUserCreation</span><span class=p>(</span><span class=n>savedUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>savedUser</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>UserManagementService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-android-開發中的應用>2. Android 開發中的應用</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// View 元件延遲初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>recyclerView</span><span class=p>:</span> <span class=n>RecyclerView</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>adapter</span><span class=p>:</span> <span class=n>UserAdapter</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>viewModel</span><span class=p>:</span> <span class=n>UserViewModel</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 網路元件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>apiService</span><span class=p>:</span> <span class=n>ApiService</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>networkManager</span><span class=p>:</span> <span class=n>NetworkManager</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=nc>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_main</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>initializeViews</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>initializeNetwork</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>initializeViewModel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>setupObservers</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>initializeViews</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>recyclerView</span> <span class=p>=</span> <span class=n>findViewById</span><span class=p>(</span><span class=nc>R</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>recyclerView</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>adapter</span> <span class=p>=</span> <span class=n>UserAdapter</span> <span class=p>{</span> <span class=n>user</span> <span class=o>-&gt;</span> <span class=n>onUserClicked</span><span class=p>(</span><span class=n>user</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>recyclerView</span><span class=p>.</span><span class=n>adapter</span> <span class=p>=</span> <span class=n>adapter</span>
</span></span><span class=line><span class=cl>        <span class=n>recyclerView</span><span class=p>.</span><span class=n>layoutManager</span> <span class=p>=</span> <span class=n>LinearLayoutManager</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>initializeNetwork</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>apiService</span> <span class=p>=</span> <span class=nc>RetrofitBuilder</span><span class=p>.</span><span class=n>createApiService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>networkManager</span> <span class=p>=</span> <span class=n>NetworkManager</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>initializeViewModel</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span> <span class=p>=</span> <span class=n>ViewModelProvider</span><span class=p>(</span><span class=k>this</span><span class=p>)[</span><span class=n>UserViewModel</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>setupObservers</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 確保所有元件都已初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>viewModel</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;ViewModel not initialized&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>adapter</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;Adapter not initialized&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=p>.</span><span class=n>users</span><span class=p>.</span><span class=n>observe</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span> <span class=n>users</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=n>adapter</span><span class=p>.</span><span class=n>submitList</span><span class=p>(</span><span class=n>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=p>.</span><span class=n>loading</span><span class=p>.</span><span class=n>observe</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span> <span class=n>isLoading</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 處理載入狀態
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>onUserClicked</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>networkManager</span><span class=p>.</span><span class=n>isInitialized</span> <span class=o>&amp;&amp;</span> <span class=n>networkManager</span><span class=p>.</span><span class=n>isConnected</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 處理用戶點擊事件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>viewModel</span><span class=p>.</span><span class=n>loadUserDetails</span><span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>showNoNetworkError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3-配置管理系統>3. 配置管理系統</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ConfigurationManager</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\$</span><span class=s2>{database.url}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>databaseUrl</span><span class=p>:</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\$</span><span class=s2>{database.username}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>databaseUsername</span><span class=p>:</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\$</span><span class=s2>{redis.host}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>redisHost</span><span class=p>:</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Value</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\$</span><span class=s2>{jwt.secret}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>jwtSecret</span><span class=p>:</span> <span class=n>String</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>databaseConfig</span><span class=p>:</span> <span class=n>DatabaseConfig</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>redisConfig</span><span class=p>:</span> <span class=n>RedisConfig</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>securityConfig</span><span class=p>:</span> <span class=n>SecurityConfig</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@PostConstruct</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeConfigurations</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>validateRequiredProperties</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>buildConfigurations</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logConfigurationStatus</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>validateRequiredProperties</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>errors</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>databaseUrl</span><span class=p>.</span><span class=n>isInitialized</span> <span class=o>||</span> <span class=n>databaseUrl</span><span class=p>.</span><span class=n>isBlank</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;Database URL not configured&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>databaseUsername</span><span class=p>.</span><span class=n>isInitialized</span> <span class=o>||</span> <span class=n>databaseUsername</span><span class=p>.</span><span class=n>isBlank</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;Database username not configured&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>redisHost</span><span class=p>.</span><span class=n>isInitialized</span> <span class=o>||</span> <span class=n>redisHost</span><span class=p>.</span><span class=n>isBlank</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;Redis host not configured&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>jwtSecret</span><span class=p>.</span><span class=n>isInitialized</span> <span class=o>||</span> <span class=n>jwtSecret</span><span class=p>.</span><span class=n>isBlank</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;JWT secret not configured&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>errors</span><span class=p>.</span><span class=n>isNotEmpty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>ConfigurationException</span><span class=p>(</span><span class=s2>&#34;Configuration errors: </span><span class=si>${errors.joinToString(&#34;, &#34;)}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>buildConfigurations</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>databaseConfig</span> <span class=p>=</span> <span class=n>DatabaseConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>url</span> <span class=p>=</span> <span class=n>databaseUrl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>username</span> <span class=p>=</span> <span class=n>databaseUsername</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>maxPoolSize</span> <span class=p>=</span> <span class=m>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>connectionTimeout</span> <span class=p>=</span> <span class=nc>Duration</span><span class=p>.</span><span class=n>ofSeconds</span><span class=p>(</span><span class=m>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>redisConfig</span> <span class=p>=</span> <span class=n>RedisConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>host</span> <span class=p>=</span> <span class=n>redisHost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>port</span> <span class=p>=</span> <span class=m>6379</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timeout</span> <span class=p>=</span> <span class=nc>Duration</span><span class=p>.</span><span class=n>ofSeconds</span><span class=p>(</span><span class=m>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>securityConfig</span> <span class=p>=</span> <span class=n>SecurityConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>jwtSecret</span> <span class=p>=</span> <span class=n>jwtSecret</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tokenExpiration</span> <span class=p>=</span> <span class=nc>Duration</span><span class=p>.</span><span class=n>ofHours</span><span class=p>(</span><span class=m>24</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>refreshTokenExpiration</span> <span class=p>=</span> <span class=nc>Duration</span><span class=p>.</span><span class=n>ofDays</span><span class=p>(</span><span class=m>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>logConfigurationStatus</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Configuration initialized successfully:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;- Database: </span><span class=si>${databaseConfig.url}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;- Redis: </span><span class=si>${redisConfig.host}</span><span class=s2>:</span><span class=si>${redisConfig.port}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;- Security: JWT configured with </span><span class=si>${securityConfig.tokenExpiration}</span><span class=s2> expiration&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getDatabaseConfig</span><span class=p>():</span> <span class=n>DatabaseConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>databaseConfig</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;Database configuration not initialized&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>databaseConfig</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getRedisConfig</span><span class=p>():</span> <span class=n>RedisConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>redisConfig</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;Redis configuration not initialized&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redisConfig</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getSecurityConfig</span><span class=p>():</span> <span class=n>SecurityConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>securityConfig</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;Security configuration not initialized&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>securityConfig</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>ConfigurationManager</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=lateinit-vs-lazy-詳細比較>lateinit vs lazy 詳細比較</h3><h4 id=特性對比表>特性對比表</h4><table><thead><tr><th>特性</th><th>lateinit</th><th>lazy</th></tr></thead><tbody><tr><td>初始化時機</td><td>手動控制</td><td>首次訪問時</td></tr><tr><td>線程安全</td><td>否</td><td>是（預設）</td></tr><tr><td>可變性</td><td>var（可重新賦值）</td><td>val（不可變）</td></tr><tr><td>初始化檢查</td><td>::property.isInitialized</td><td>無需檢查</td></tr><tr><td>記憶體開銷</td><td>低</td><td>略高（Lazy包裝）</td></tr><tr><td>適用場景</td><td>依賴注入、外部初始化</td><td>延遲計算、高開銷操作</td></tr></tbody></table><h4 id=使用場景比較>使用場景比較</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>ComparisonExample</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// lateinit：適合依賴注入
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>repository</span><span class=p>:</span> <span class=n>UserRepository</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// lazy：適合計算密集型初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>val</span> <span class=py>expensiveResource</span><span class=p>:</span> <span class=n>DatabaseConnection</span> <span class=k>by</span> <span class=n>lazy</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>createDatabaseConnection</span><span class=p>()</span> <span class=c1>// 僅在首次使用時執行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// lateinit：可重新賦值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>currentUser</span><span class=p>:</span> <span class=n>User</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>switchUser</span><span class=p>(</span><span class=n>newUser</span><span class=p>:</span> <span class=n>User</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>currentUser</span> <span class=p>=</span> <span class=n>newUser</span> <span class=c1>// 可以重新賦值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// lazy：線程安全的單例初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>val</span> <span class=py>singleton</span><span class=p>:</span> <span class=n>ServiceManager</span> <span class=k>by</span> <span class=n>lazy</span><span class=p>(</span><span class=nc>LazyThreadSafetyMode</span><span class=p>.</span><span class=n>SYNCHRONIZED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nc>ServiceManager</span><span class=p>.</span><span class=n>create</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// lateinit：手動控制初始化時機
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>testDatabase</span><span class=p>:</span> <span class=n>TestDatabase</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>setupTest</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>testDatabase</span> <span class=p>=</span> <span class=n>createTestDatabase</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@AfterEach</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>cleanupTest</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>testDatabase</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>testDatabase</span><span class=p>.</span><span class=n>cleanup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=進階使用模式>進階使用模式</h3><h4 id=1-條件初始化模式>1. 條件初始化模式</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>ConditionalInitialization</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>primaryDatabase</span><span class=p>:</span> <span class=n>Database</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>secondaryDatabase</span><span class=p>:</span> <span class=n>Database</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeDatabases</span><span class=p>(</span><span class=n>config</span><span class=p>:</span> <span class=n>DatabaseConfig</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 主資料庫總是初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>primaryDatabase</span> <span class=p>=</span> <span class=n>createDatabase</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>primary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 次要資料庫僅在啟用時初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>enableSecondary</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>secondaryDatabase</span> <span class=p>=</span> <span class=n>createDatabase</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=n>secondary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>executeQuery</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>QueryResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>primaryDatabase</span><span class=p>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 安全地使用次要資料庫
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>secondaryDatabase</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>secondaryDatabase</span><span class=p>.</span><span class=n>logQuery</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-初始化鏈模式>2. 初始化鏈模式</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>InitializationChain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>configService</span><span class=p>:</span> <span class=n>ConfigService</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>databaseService</span><span class=p>:</span> <span class=n>DatabaseService</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>cacheService</span><span class=p>:</span> <span class=n>CacheService</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>businessService</span><span class=p>:</span> <span class=n>BusinessService</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeAll</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>initializeConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>initializeDatabase</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>initializeCache</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>initializeBusiness</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>validateInitialization</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>initializeConfig</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>configService</span> <span class=p>=</span> <span class=n>ConfigService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Config service initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>initializeDatabase</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>configService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;Config service must be initialized first&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>databaseService</span> <span class=p>=</span> <span class=n>DatabaseService</span><span class=p>(</span><span class=n>configService</span><span class=p>.</span><span class=n>getDatabaseConfig</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Database service initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>initializeCache</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>configService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;Config service must be initialized first&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>cacheService</span> <span class=p>=</span> <span class=n>CacheService</span><span class=p>(</span><span class=n>configService</span><span class=p>.</span><span class=n>getCacheConfig</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Cache service initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>initializeBusiness</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>databaseService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;Database service must be initialized first&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>require</span><span class=p>(</span><span class=o>::</span><span class=n>cacheService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span> <span class=s2>&#34;Cache service must be initialized first&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>businessService</span> <span class=p>=</span> <span class=n>BusinessService</span><span class=p>(</span><span class=n>databaseService</span><span class=p>,</span> <span class=n>cacheService</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Business service initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>validateInitialization</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>errors</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>configService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;ConfigService&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>databaseService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;DatabaseService&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>cacheService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;CacheService&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>businessService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;BusinessService&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>errors</span><span class=p>.</span><span class=n>isNotEmpty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>InitializationException</span><span class=p>(</span><span class=s2>&#34;未初始化的服務: </span><span class=si>${errors.joinToString(&#34;, &#34;)}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;所有服務初始化完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>InitializationChain</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3-資源管理模式>3. 資源管理模式</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResourceManager</span> <span class=p>:</span> <span class=n>AutoCloseable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>connectionPool</span><span class=p>:</span> <span class=n>ConnectionPool</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>cacheManager</span><span class=p>:</span> <span class=n>CacheManager</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>fileManager</span><span class=p>:</span> <span class=n>FileManager</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>initializedResources</span> <span class=p>=</span> <span class=n>mutableSetOf</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeConnectionPool</span><span class=p>(</span><span class=n>config</span><span class=p>:</span> <span class=n>ConnectionConfig</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>connectionPool</span> <span class=p>=</span> <span class=nc>ConnectionPool</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>initializedResources</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;connectionPool&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Connection pool initialized with </span><span class=si>${config.maxConnections}</span><span class=s2> connections&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeCacheManager</span><span class=p>(</span><span class=n>config</span><span class=p>:</span> <span class=n>CacheConfig</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cacheManager</span> <span class=p>=</span> <span class=nc>CacheManager</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>initializedResources</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;cacheManager&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Cache manager initialized with </span><span class=si>${config.maxSize}</span><span class=s2> max size&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeFileManager</span><span class=p>(</span><span class=n>config</span><span class=p>:</span> <span class=n>FileConfig</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fileManager</span> <span class=p>=</span> <span class=nc>FileManager</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>initializedResources</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;fileManager&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;File manager initialized with root: </span><span class=si>${config.rootPath}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getResourceStatus</span><span class=p>():</span> <span class=n>Map</span><span class=p>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Boolean</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;connectionPool&#34;</span> <span class=n>to</span> <span class=o>::</span><span class=n>connectionPool</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;cacheManager&#34;</span> <span class=n>to</span> <span class=o>::</span><span class=n>cacheManager</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;fileManager&#34;</span> <span class=n>to</span> <span class=o>::</span><span class=n>fileManager</span><span class=p>.</span><span class=n>isInitialized</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>close</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;開始關閉資源管理器&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 按相反順序關閉資源
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>fileManager</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>fileManager</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;File manager closed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Error closing file manager&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>cacheManager</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>cacheManager</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Cache manager closed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Error closing cache manager&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>connectionPool</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>connectionPool</span><span class=p>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Connection pool closed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Error closing connection pool&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>initializedResources</span><span class=p>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;資源管理器關閉完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>ResourceManager</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=測試策略>測試策略</h3><h4 id=1-單元測試模式>1. 單元測試模式</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserServiceTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>userRepository</span><span class=p>:</span> <span class=n>UserRepository</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>emailService</span><span class=p>:</span> <span class=n>EmailService</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@InjectMocks</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>userService</span><span class=p>:</span> <span class=n>UserService</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>setup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nc>MockitoAnnotations</span><span class=p>.</span><span class=n>openMocks</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 驗證依賴注入是否成功
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>assertTrue</span><span class=p>(</span><span class=o>::</span><span class=n>userRepository</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>,</span> <span class=s2>&#34;UserRepository should be initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>assertTrue</span><span class=p>(</span><span class=o>::</span><span class=n>emailService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>,</span> <span class=s2>&#34;EmailService should be initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>assertTrue</span><span class=p>(</span><span class=o>::</span><span class=n>userService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>,</span> <span class=s2>&#34;UserService should be initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>`should create user successfully`</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Given
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>userData</span> <span class=p>=</span> <span class=n>UserCreateRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>email</span> <span class=p>=</span> <span class=s2>&#34;test@example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>username</span> <span class=p>=</span> <span class=s2>&#34;testuser&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>expectedUser</span> <span class=p>=</span> <span class=n>User</span><span class=p>(</span><span class=m>1L</span><span class=p>,</span> <span class=s2>&#34;test@example.com&#34;</span><span class=p>,</span> <span class=s2>&#34;testuser&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>`when`</span><span class=p>(</span><span class=n>userRepository</span><span class=p>.</span><span class=n>save</span><span class=p>(</span><span class=n>any</span><span class=p>())).</span><span class=n>thenReturn</span><span class=p>(</span><span class=n>expectedUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>doNothing</span><span class=p>().</span><span class=n>`when`</span><span class=p>(</span><span class=n>emailService</span><span class=p>).</span><span class=n>sendWelcomeEmail</span><span class=p>(</span><span class=n>any</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// When
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>userService</span><span class=p>.</span><span class=n>createUser</span><span class=p>(</span><span class=n>userData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// Then
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>assertEquals</span><span class=p>(</span><span class=n>expectedUser</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>verify</span><span class=p>(</span><span class=n>userRepository</span><span class=p>).</span><span class=n>save</span><span class=p>(</span><span class=n>any</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>verify</span><span class=p>(</span><span class=n>emailService</span><span class=p>).</span><span class=n>sendWelcomeEmail</span><span class=p>(</span><span class=n>expectedUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>`should handle uninitialized dependencies gracefully`</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 測試未初始化的情況
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>service</span> <span class=p>=</span> <span class=n>UserService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>assertFalse</span><span class=p>(</span><span class=n>service</span><span class=o>::</span><span class=n>userRepository</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>assertFalse</span><span class=p>(</span><span class=n>service</span><span class=o>::</span><span class=n>emailService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>assertThrows</span><span class=p>&lt;</span><span class=n>UninitializedPropertyAccessException</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>service</span><span class=p>.</span><span class=n>createUser</span><span class=p>(</span><span class=n>UserCreateRequest</span><span class=p>(</span><span class=s2>&#34;test@example.com&#34;</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-整合測試模式>2. 整合測試模式</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@SpringBootTest</span>
</span></span><span class=line><span class=cl><span class=nd>@TestPropertySource</span><span class=p>(</span><span class=n>properties</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;spring.datasource.url=jdbc:h2:mem:testdb&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;spring.jpa.hibernate.ddl-auto=create-drop&#34;</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserServiceIntegrationTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>userService</span><span class=p>:</span> <span class=n>UserService</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Autowired</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>userRepository</span><span class=p>:</span> <span class=n>UserRepository</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@TestConfiguration</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>TestConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>        <span class=nd>@Primary</span>
</span></span><span class=line><span class=cl>        <span class=k>fun</span> <span class=nf>mockEmailService</span><span class=p>():</span> <span class=n>EmailService</span> <span class=p>=</span> <span class=n>mockk</span><span class=p>(</span><span class=n>relaxed</span> <span class=p>=</span> <span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>`should initialize all dependencies in Spring context`</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 驗證 Spring 上下文中的依賴注入
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>assertTrue</span><span class=p>(</span><span class=n>userService</span><span class=o>::</span><span class=n>userRepository</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>assertTrue</span><span class=p>(</span><span class=n>userService</span><span class=o>::</span><span class=n>emailService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 執行實際的業務邏輯測試
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>userData</span> <span class=p>=</span> <span class=n>UserCreateRequest</span><span class=p>(</span><span class=s2>&#34;integration@test.com&#34;</span><span class=p>,</span> <span class=s2>&#34;integrationuser&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>userService</span><span class=p>.</span><span class=n>createUser</span><span class=p>(</span><span class=n>userData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>assertNotNull</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>assertEquals</span><span class=p>(</span><span class=s2>&#34;integration@test.com&#34;</span><span class=p>,</span> <span class=n>result</span><span class=p>.</span><span class=n>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>assertEquals</span><span class=p>(</span><span class=s2>&#34;integrationuser&#34;</span><span class=p>,</span> <span class=n>result</span><span class=p>.</span><span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>// 驗證資料實際儲存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=py>savedUser</span> <span class=p>=</span> <span class=n>userRepository</span><span class=p>.</span><span class=n>findById</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>id</span><span class=o>!!</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>assertTrue</span><span class=p>(</span><span class=n>savedUser</span><span class=p>.</span><span class=n>isPresent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>assertEquals</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>email</span><span class=p>,</span> <span class=n>savedUser</span><span class=p>.</span><span class=k>get</span><span class=p>().</span><span class=n>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=效能優化與最佳實踐>效能優化與最佳實踐</h3><h4 id=1-記憶體管理>1. 記憶體管理</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemoryOptimizedService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 大型物件使用 lateinit 延遲初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>largeDataSet</span><span class=p>:</span> <span class=n>LargeDataSet</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>heavyProcessor</span><span class=p>:</span> <span class=n>HeavyProcessor</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 小型配置物件可以直接初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>val</span> <span class=py>config</span> <span class=p>=</span> <span class=n>ServiceConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeHeavyResources</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>largeDataSet</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>largeDataSet</span> <span class=p>=</span> <span class=nc>LargeDataSet</span><span class=p>.</span><span class=n>loadFromDatabase</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Large dataset loaded: </span><span class=si>${largeDataSet.size}</span><span class=s2> records&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>heavyProcessor</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>heavyProcessor</span> <span class=p>=</span> <span class=n>HeavyProcessor</span><span class=p>(</span><span class=n>largeDataSet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Heavy processor initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>processDataIfReady</span><span class=p>(</span><span class=n>input</span><span class=p>:</span> <span class=n>String</span><span class=p>):</span> <span class=n>String</span><span class=p>?</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>heavyProcessor</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>heavyProcessor</span><span class=p>.</span><span class=n>process</span><span class=p>(</span><span class=n>input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>warn</span><span class=p>(</span><span class=s2>&#34;Heavy processor not initialized, skipping processing&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>null</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 清理資源
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>fun</span> <span class=nf>cleanup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>heavyProcessor</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>heavyProcessor</span><span class=p>.</span><span class=n>cleanup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>largeDataSet</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>largeDataSet</span><span class=p>.</span><span class=n>cleanup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>MemoryOptimizedService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-線程安全考量>2. 線程安全考量</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>ThreadSafeService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Volatile</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>sharedResource</span><span class=p>:</span> <span class=n>SharedResource</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>initializationLock</span> <span class=p>=</span> <span class=n>ReentrantLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>condition</span> <span class=p>=</span> <span class=n>initializationLock</span><span class=p>.</span><span class=n>newCondition</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initializeSharedResource</span><span class=p>(</span><span class=n>config</span><span class=p>:</span> <span class=n>ResourceConfig</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>initializationLock</span><span class=p>.</span><span class=n>withLock</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>sharedResource</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>sharedResource</span> <span class=p>=</span> <span class=nc>SharedResource</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>condition</span><span class=p>.</span><span class=n>signalAll</span><span class=p>()</span> <span class=c1>// 通知等待的線程
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Shared resource initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>accessSharedResource</span><span class=p>():</span> <span class=n>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 等待初始化完成
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>initializationLock</span><span class=p>.</span><span class=n>withLock</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=p>(!</span><span class=o>::</span><span class=n>sharedResource</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>condition</span><span class=p>.</span><span class=n>await</span><span class=p>(</span><span class=m>5</span><span class=p>,</span> <span class=nc>TimeUnit</span><span class=p>.</span><span class=n>SECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>sharedResource</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>throw</span> <span class=n>TimeoutException</span><span class=p>(</span><span class=s2>&#34;Shared resource initialization timeout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sharedResource</span><span class=p>.</span><span class=n>getData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>isResourceReady</span><span class=p>():</span> <span class=n>Boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>::</span><span class=n>sharedResource</span><span class=p>.</span><span class=n>isInitialized</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>ThreadSafeService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=常見陷阱與錯誤處理>常見陷阱與錯誤處理</h3><h4 id=1-常見錯誤模式>1. 常見錯誤模式</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>CommonMistakes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>service</span><span class=p>:</span> <span class=n>SomeService</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// ❌ 錯誤：在初始化前訪問
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>fun</span> <span class=nf>badExample1</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>service</span><span class=p>.</span><span class=n>doSomething</span><span class=p>()</span> <span class=c1>// UninitializedPropertyAccessException
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// ❌ 錯誤：忘記檢查初始化狀態
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>fun</span> <span class=nf>badExample2</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>service</span><span class=p>.</span><span class=n>getData</span><span class=p>()</span> <span class=c1>// 可能未初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// ✅ 正確：檢查後訪問
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>fun</span> <span class=nf>goodExample1</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>service</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>service</span><span class=p>.</span><span class=n>doSomething</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>warn</span><span class=p>(</span><span class=s2>&#34;Service not initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// ✅ 正確：防禦性初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>fun</span> <span class=nf>goodExample2</span><span class=p>():</span> <span class=n>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!</span><span class=o>::</span><span class=n>service</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>service</span> <span class=p>=</span> <span class=nc>SomeService</span><span class=p>.</span><span class=n>createDefault</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>service</span><span class=p>.</span><span class=n>getData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-錯誤處理策略>2. 錯誤處理策略</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>ErrorHandlingService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>primaryService</span><span class=p>:</span> <span class=n>PrimaryService</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>backupService</span><span class=p>:</span> <span class=n>BackupService</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>processRequest</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>):</span> <span class=n>Response</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 嘗試使用主要服務
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>primaryService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>primaryService</span><span class=p>.</span><span class=n>process</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=n>ServiceNotInitializedException</span><span class=p>(</span><span class=s2>&#34;Primary service not available&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>ServiceNotInitializedException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>warn</span><span class=p>(</span><span class=s2>&#34;Primary service unavailable, falling back to backup&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1>// 備援服務處理
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=o>::</span><span class=n>backupService</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>backupService</span><span class=p>.</span><span class=n>process</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=n>ServiceUnavailableException</span><span class=p>(</span><span class=s2>&#34;No services available&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Unexpected error processing request&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=n>ProcessingException</span><span class=p>(</span><span class=s2>&#34;Failed to process request&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>healthCheck</span><span class=p>():</span> <span class=n>HealthStatus</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>status</span> <span class=p>=</span> <span class=n>HealthStatus</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>status</span><span class=p>.</span><span class=n>primaryServiceAvailable</span> <span class=p>=</span> <span class=o>::</span><span class=n>primaryService</span><span class=p>.</span><span class=n>isInitialized</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span><span class=p>.</span><span class=n>backupServiceAvailable</span> <span class=p>=</span> <span class=o>::</span><span class=n>backupService</span><span class=p>.</span><span class=n>isInitialized</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>status</span><span class=p>.</span><span class=n>overallStatus</span> <span class=p>=</span> <span class=k>when</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span><span class=p>.</span><span class=n>primaryServiceAvailable</span> <span class=o>-&gt;</span> <span class=nc>HealthStatus</span><span class=p>.</span><span class=nc>Status</span><span class=p>.</span><span class=n>HEALTHY</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span><span class=p>.</span><span class=n>backupServiceAvailable</span> <span class=o>-&gt;</span> <span class=nc>HealthStatus</span><span class=p>.</span><span class=nc>Status</span><span class=p>.</span><span class=n>DEGRADED</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=o>-&gt;</span> <span class=nc>HealthStatus</span><span class=p>.</span><span class=nc>Status</span><span class=p>.</span><span class=n>UNHEALTHY</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>status</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>ErrorHandlingService</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=企業級最佳實踐>企業級最佳實踐</h3><h4 id=1-初始化驗證框架>1. 初始化驗證框架</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>InitializationValidator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>validateObject</span><span class=p>(</span><span class=n>obj</span><span class=p>:</span> <span class=n>Any</span><span class=p>):</span> <span class=n>ValidationResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>ValidationResult</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>clazz</span> <span class=p>=</span> <span class=n>obj</span><span class=o>::</span><span class=k>class</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=err>// </span><span class=nc>使用反射檢查所有</span> <span class=k>lateinit</span> <span class=n>屬性</span>
</span></span><span class=line><span class=cl>        <span class=n>clazz</span><span class=p>.</span><span class=n>memberProperties</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>filterIsInstance</span><span class=p>&lt;</span><span class=n>KMutableProperty1</span><span class=p>&lt;</span><span class=n>Any</span><span class=p>,</span> <span class=n>Any</span><span class=p>&gt;&gt;()</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>filter</span> <span class=p>{</span> <span class=k>it</span><span class=p>.</span><span class=n>isLateinit</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>forEach</span> <span class=p>{</span> <span class=k>property</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(!</span><span class=k>property</span><span class=p>.</span><span class=n>isInitialized</span><span class=p>(</span><span class=n>obj</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>result</span><span class=p>.</span><span class=n>addError</span><span class=p>(</span><span class=s2>&#34;Property &#39;</span><span class=si>${property.name}</span><span class=s2>&#39; is not initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>result</span><span class=p>.</span><span class=n>addSuccess</span><span class=p>(</span><span class=s2>&#34;Property &#39;</span><span class=si>${property.name}</span><span class=s2>&#39; is initialized&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span><span class=p>.</span><span class=n>addError</span><span class=p>(</span><span class=s2>&#34;Error checking property &#39;</span><span class=si>${property.name}</span><span class=s2>&#39;: </span><span class=si>${e.message}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@EventListener</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>onApplicationReady</span><span class=p>(</span><span class=n>event</span><span class=p>:</span> <span class=n>ApplicationReadyEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;開始驗證應用程式初始化狀態&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>context</span> <span class=p>=</span> <span class=n>event</span><span class=p>.</span><span class=n>applicationContext</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>beanNames</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>beanDefinitionNames</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>var</span> <span class=py>totalBeans</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>        <span class=k>var</span> <span class=py>validatedBeans</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>        <span class=k>var</span> <span class=py>errorCount</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>beanNames</span><span class=p>.</span><span class=n>forEach</span> <span class=p>{</span> <span class=n>beanName</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>bean</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>getBean</span><span class=p>(</span><span class=n>beanName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>totalBeans</span><span class=o>++</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>validateObject</span><span class=p>(</span><span class=n>bean</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>hasErrors</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>logger</span><span class=p>.</span><span class=n>warn</span><span class=p>(</span><span class=s2>&#34;Bean &#39;</span><span class=si>$beanName</span><span class=s2>&#39; has initialization issues: </span><span class=si>${result.getErrors()}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>errorCount</span> <span class=o>+=</span> <span class=n>result</span><span class=p>.</span><span class=n>getErrorCount</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>validatedBeans</span><span class=o>++</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;Skipped validation for bean &#39;</span><span class=si>$beanName</span><span class=s2>&#39;: </span><span class=si>${e.message}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;初始化驗證完成: </span><span class=si>$validatedBeans</span><span class=s2>/</span><span class=si>$totalBeans</span><span class=s2> beans validated, </span><span class=si>$errorCount</span><span class=s2> errors found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>InitializationValidator</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>data</span> <span class=k>class</span> <span class=nc>ValidationResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>errors</span><span class=p>:</span> <span class=n>MutableList</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>successes</span><span class=p>:</span> <span class=n>MutableList</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>mutableListOf</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>addError</span><span class=p>(</span><span class=n>error</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>=</span> <span class=n>errors</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>addSuccess</span><span class=p>(</span><span class=n>success</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>=</span> <span class=n>successes</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=n>success</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>hasErrors</span><span class=p>()</span> <span class=p>=</span> <span class=n>errors</span><span class=p>.</span><span class=n>isNotEmpty</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getErrors</span><span class=p>()</span> <span class=p>=</span> <span class=n>errors</span><span class=p>.</span><span class=n>toList</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getSuccesses</span><span class=p>()</span> <span class=p>=</span> <span class=n>successes</span><span class=p>.</span><span class=n>toList</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getErrorCount</span><span class=p>()</span> <span class=p>=</span> <span class=n>errors</span><span class=p>.</span><span class=n>size</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-監控與診斷>2. 監控與診斷</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LateinitMonitor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>meterRegistry</span><span class=p>:</span> <span class=n>MeterRegistry</span> <span class=p>=</span> <span class=nc>Metrics</span><span class=p>.</span><span class=n>globalRegistry</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>initializationTimer</span> <span class=p>=</span> <span class=nc>Timer</span><span class=p>.</span><span class=n>builder</span><span class=p>(</span><span class=s2>&#34;lateinit.initialization.time&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>description</span><span class=p>(</span><span class=s2>&#34;Time taken to initialize lateinit properties&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=n>meterRegistry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=p>&lt;</span><span class=nc>T</span><span class=p>&gt;</span> <span class=nf>monitorInitialization</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>propertyName</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>initializer</span><span class=p>:</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>T</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span> <span class=n>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nc>Timer</span><span class=p>.</span><span class=nc>Sample</span><span class=p>.</span><span class=n>start</span><span class=p>(</span><span class=n>meterRegistry</span><span class=p>).</span><span class=n>use</span> <span class=p>{</span> <span class=n>sample</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>initializer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1>// 記錄成功的初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nc>Counter</span><span class=p>.</span><span class=n>builder</span><span class=p>(</span><span class=s2>&#34;lateinit.initialization.success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>tag</span><span class=p>(</span><span class=s2>&#34;property&#34;</span><span class=p>,</span> <span class=n>propertyName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=n>meterRegistry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>increment</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>sample</span><span class=p>.</span><span class=n>stop</span><span class=p>(</span><span class=n>initializationTimer</span><span class=p>.</span><span class=n>withTag</span><span class=p>(</span><span class=s2>&#34;property&#34;</span><span class=p>,</span> <span class=n>propertyName</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Successfully initialized property: </span><span class=si>$propertyName</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>result</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 記錄失敗的初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nc>Counter</span><span class=p>.</span><span class=n>builder</span><span class=p>(</span><span class=s2>&#34;lateinit.initialization.failure&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>tag</span><span class=p>(</span><span class=s2>&#34;property&#34;</span><span class=p>,</span> <span class=n>propertyName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>tag</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>.</span><span class=n>javaClass</span><span class=p>.</span><span class=n>simpleName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=n>meterRegistry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>increment</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=p>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Failed to initialize property: </span><span class=si>$propertyName</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Scheduled</span><span class=p>(</span><span class=n>fixedRate</span> <span class=p>=</span> <span class=m>60000</span><span class=p>)</span> <span class=c1>// 每分鐘檢查一次
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>fun</span> <span class=nf>reportInitializationStatus</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>successCount</span> <span class=p>=</span> <span class=n>meterRegistry</span><span class=p>.</span><span class=n>counter</span><span class=p>(</span><span class=s2>&#34;lateinit.initialization.success&#34;</span><span class=p>).</span><span class=n>count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>failureCount</span> <span class=p>=</span> <span class=n>meterRegistry</span><span class=p>.</span><span class=n>counter</span><span class=p>(</span><span class=s2>&#34;lateinit.initialization.failure&#34;</span><span class=p>).</span><span class=n>count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>totalCount</span> <span class=p>=</span> <span class=n>successCount</span> <span class=p>+</span> <span class=n>failureCount</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>totalCount</span> <span class=p>&gt;</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>successRate</span> <span class=p>=</span> <span class=p>(</span><span class=n>successCount</span> <span class=p>/</span> <span class=n>totalCount</span><span class=p>)</span> <span class=p>*</span> <span class=m>100</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Lateinit initialization statistics - Success rate: </span><span class=si>${&#34;%.2f&#34;.format(successRate)}</span><span class=s2>% (</span><span class=si>$successCount</span><span class=s2>/</span><span class=si>$totalCount</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>logger</span> <span class=p>=</span> <span class=nc>LoggerFactory</span><span class=p>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>LateinitMonitor</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=效能基準測試>效能基準測試</h3><h4 id=初始化效能比較>初始化效能比較</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@BenchmarkMode</span><span class=p>(</span><span class=nc>Mode</span><span class=p>.</span><span class=n>AverageTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@OutputTimeUnit</span><span class=p>(</span><span class=nc>TimeUnit</span><span class=p>.</span><span class=n>NANOSECONDS</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@State</span><span class=p>(</span><span class=nc>Scope</span><span class=p>.</span><span class=n>Benchmark</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LateinitPerformanceBenchmark</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 測試類別
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>class</span> <span class=nc>LateinitExample</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>lateinit</span> <span class=k>var</span> <span class=py>service</span><span class=p>:</span> <span class=n>ExpensiveService</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>fun</span> <span class=nf>initializeService</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>service</span> <span class=p>=</span> <span class=n>ExpensiveService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>LazyExample</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>service</span><span class=p>:</span> <span class=n>ExpensiveService</span> <span class=k>by</span> <span class=n>lazy</span> <span class=p>{</span> <span class=n>ExpensiveService</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>fun</span> <span class=nf>getService</span><span class=p>():</span> <span class=n>ExpensiveService</span> <span class=p>=</span> <span class=n>service</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>EagerExample</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>val</span> <span class=py>service</span><span class=p>:</span> <span class=n>ExpensiveService</span> <span class=p>=</span> <span class=n>ExpensiveService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>fun</span> <span class=nf>getService</span><span class=p>():</span> <span class=n>ExpensiveService</span> <span class=p>=</span> <span class=n>service</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Benchmark</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>lateinitInitialization</span><span class=p>():</span> <span class=n>ExpensiveService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>example</span> <span class=p>=</span> <span class=n>LateinitExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>example</span><span class=p>.</span><span class=n>initializeService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>example</span><span class=p>.</span><span class=n>service</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Benchmark</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>lazyInitialization</span><span class=p>():</span> <span class=n>ExpensiveService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>example</span> <span class=p>=</span> <span class=n>LazyExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>example</span><span class=p>.</span><span class=n>getService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Benchmark</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>eagerInitialization</span><span class=p>():</span> <span class=n>ExpensiveService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>example</span> <span class=p>=</span> <span class=n>EagerExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>example</span><span class=p>.</span><span class=n>getService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Benchmark</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>lateinitAccessAfterInit</span><span class=p>():</span> <span class=n>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>example</span> <span class=p>=</span> <span class=n>LateinitExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>example</span><span class=p>.</span><span class=n>initializeService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>example</span><span class=p>.</span><span class=n>service</span><span class=p>.</span><span class=n>getData</span><span class=p>()</span> <span class=c1>// 訪問已初始化的屬性
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Benchmark</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>lazyAccess</span><span class=p>():</span> <span class=n>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>example</span> <span class=p>=</span> <span class=n>LazyExample</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>example</span><span class=p>.</span><span class=n>getService</span><span class=p>()</span> <span class=c1>// 首次訪問，觸發初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>example</span><span class=p>.</span><span class=n>getService</span><span class=p>().</span><span class=n>getData</span><span class=p>()</span> <span class=c1>// 再次訪問，使用快取值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=總結>總結</h3><p><code>lateinit</code> 是 Kotlin 中強大的延遲初始化機制，特別適用於：</p><ol><li><strong>依賴注入場景</strong>：Spring Boot、Android 等框架的依賴注入</li><li><strong>外部初始化</strong>：需要在物件創建後由外部代碼初始化的屬性</li><li><strong>測試場景</strong>：Mock 物件和測試設置</li><li><strong>條件初始化</strong>：根據運行時條件決定是否初始化的屬性</li></ol><h4 id=關鍵最佳實踐>關鍵最佳實踐</h4><ol><li><strong>總是檢查初始化狀態</strong>：使用 <code>::property.isInitialized</code> 進行安全檢查</li><li><strong>提供錯誤處理</strong>：妥善處理 <code>UninitializedPropertyAccessException</code></li><li><strong>文檔化初始化需求</strong>：清楚說明何時和如何初始化屬性</li><li><strong>考慮線程安全</strong>：在多線程環境中使用適當的同步機制</li><li><strong>監控和診斷</strong>：在生產環境中監控初始化狀態和效能</li></ol><p>選擇 <code>lateinit</code> 還是 <code>lazy</code> 取決於具體需求：使用 <code>lateinit</code> 進行手動控制的延遲初始化，使用 <code>lazy</code> 進行自動的懶加載。正確使用這些機制可以顯著改善應用程式的效能和記憶體使用效率。</p></div><footer class=post-footer><div class=post-tags><span class=tags-label>標籤：</span>
<a href=/tags/kotlin class=tag-link>#Kotlin</a>
<a href=/tags/lateinit class=tag-link>#lateinit</a>
<a href=/tags/lazy class=tag-link>#lazy</a>
<a href=/tags/property-initialization class=tag-link>#Property Initialization</a>
<a href=/tags/android class=tag-link>#Android</a>
<a href=/tags/spring-boot class=tag-link>#Spring Boot</a>
<a href=/tags/dependency-injection class=tag-link>#Dependency Injection</a>
<a href=/tags/performance class=tag-link>#Performance</a>
<a href=/tags/memory-management class=tag-link>#Memory Management</a>
<a href=/tags/best-practices class=tag-link>#Best Practices</a>
<a href=/tags/enterprise class=tag-link>#Enterprise</a>
<a href=/tags/thread-safety class=tag-link>#Thread Safety</a>
<a href=/tags/reflection class=tag-link>#Reflection</a>
<a href=/tags/testing class=tag-link>#Testing</a></div></footer></article><nav class=post-nav><div class=post-nav-links><div class=post-nav-prev><span class=post-nav-label>上一篇</span>
<a href=https://xinqilin.github.io/post/tools/curl/ class=post-nav-link>cURL 完整指南：HTTP 客戶端工具與 API 測試利器</a></div><div class=post-nav-next><span class=post-nav-label>下一篇</span>
<a href=https://xinqilin.github.io/post/backend/querydsl/ class=post-nav-link>QueryDSL 完整實戰指南：類型安全的動態查詢解決方案</a></div></div></nav></main><footer class=footer><div class=footer-content><p>&copy; 2025 Bill Lin. All rights reserved.</p><div class=social-links><a href=https://github.com/xinqilin class=social-link target=_blank rel=noopener>github</a></div></div></footer><script src=/js/search.js></script></div><script src=/js/code-enhance.js></script></body></html>