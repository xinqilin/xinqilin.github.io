[{"content":"ğŸ‘‹ æ­¡è¿ä¾†åˆ° Bill.Lin\u0026rsquo;s Notes é€™è£¡æ˜¯æˆ‘çš„æŠ€è¡“å­¸ç¿’ç­†è¨˜å’Œå¿ƒå¾—åˆ†äº«ç©ºé–“ã€‚ä¸»è¦è¨˜éŒ„ç¨‹å¼é–‹ç™¼éç¨‹ä¸­é‡åˆ°çš„å•é¡Œã€è§£æ±ºæ–¹æ¡ˆï¼Œä»¥åŠå°å„ç¨®æŠ€è¡“çš„ç†è§£å’Œå¯¦è¸ç¶“é©—ã€‚\nğŸ“š ä¸»è¦å…§å®¹ ğŸ§® æ¼”ç®—æ³•èˆ‡è³‡æ–™çµæ§‹ ç¶“å…¸æ¼”ç®—æ³•å¯¦ä½œèˆ‡åˆ†æ LeetCode è§£é¡Œæ€è·¯èˆ‡æŠ€å·§ è³‡æ–™çµæ§‹çš„æ‡‰ç”¨å ´æ™¯ ğŸ’» å¾Œç«¯é–‹ç™¼ Java: èªè¨€ç‰¹æ€§ã€é›†åˆæ¡†æ¶ã€ä¸¦ç™¼ç¨‹å¼è¨­è¨ˆ Kotlin: èªæ³•ç³–ã€å”ç¨‹ã€èˆ‡ Java äº’æ“ä½œ Spring: IoC/DIã€AOPã€MVCã€Securityã€Boot ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ è¨­è¨ˆæ¨¡å¼: GoF 23 ç¨®è¨­è¨ˆæ¨¡å¼çš„ç†è«–èˆ‡å¯¦è¸ SOLID åŸå‰‡: ç‰©ä»¶å°å‘è¨­è¨ˆçš„äº”å¤§åŸå‰‡ åˆ†æ•£å¼ç³»çµ±: å¾®æœå‹™ã€è¨Šæ¯ä½‡åˆ—ã€åˆ†æ•£å¼é– ğŸ³ DevOps Docker: å®¹å™¨åŒ–éƒ¨ç½²èˆ‡æœ€ä½³å¯¦è¸ CI/CD: è‡ªå‹•åŒ–å»ºæ§‹èˆ‡éƒ¨ç½²æµç¨‹ ç›£æ§: æ‡‰ç”¨æ•ˆèƒ½ç›£æ§èˆ‡æ—¥èªŒç®¡ç† ğŸ› ï¸ é–‹ç™¼å·¥å…· Linux: å¸¸ç”¨æŒ‡ä»¤èˆ‡è…³æœ¬ç·¨å¯« Git: ç‰ˆæœ¬æ§åˆ¶èˆ‡å”ä½œå·¥ä½œæµ Hugo: éœæ…‹ç¶²ç«™ç”Ÿæˆå™¨çš„ä½¿ç”¨å¿ƒå¾— ğŸ¯ å¯«ä½œç›®æ¨™ è¨˜éŒ„å­¸ç¿’éç¨‹: å°‡å­¸ç¿’åˆ°çš„çŸ¥è­˜é»æ•´ç†æˆç­†è¨˜ï¼ŒåŠ æ·±ç†è§£ åˆ†äº«å¯¦è¸ç¶“é©—: åˆ†äº«åœ¨å¯¦éš›å°ˆæ¡ˆä¸­é‡åˆ°çš„å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ å»ºç«‹çŸ¥è­˜é«”ç³»: é€éæŒçºŒå¯«ä½œï¼Œå»ºç«‹å®Œæ•´çš„æŠ€è¡“çŸ¥è­˜æ¶æ§‹ å¹«åŠ©ä»–äººå­¸ç¿’: å¸Œæœ›é€™äº›ç­†è¨˜èƒ½å°å…¶ä»–é–‹ç™¼è€…æœ‰æ‰€å¹«åŠ© ğŸ“– æ–‡ç« ç‰¹è‰² ç†è«–èˆ‡å¯¦è¸ä¸¦é‡: ä¸åƒ…èªªæ˜åŸç†ï¼Œæ›´è‘—é‡å¯¦éš›æ‡‰ç”¨ ç¨‹å¼ç¢¼ç¯„ä¾‹è±å¯Œ: æä¾›å®Œæ•´å¯åŸ·è¡Œçš„ç¨‹å¼ç¢¼ç¤ºä¾‹ å¾ªåºæ¼¸é€²: å¾åŸºç¤æ¦‚å¿µåˆ°é€²éšæ‡‰ç”¨ï¼Œé€æ­¥æ·±å…¥ æŒçºŒæ›´æ–°: æ ¹æ“šæ–°çš„å­¸ç¿’å¿ƒå¾—å’ŒæŠ€è¡“ç™¼å±•æŒçºŒæ›´æ–°å…§å®¹ ğŸ¤ è¯çµ¡æ–¹å¼ å¦‚æœæ‚¨å°æ–‡ç« å…§å®¹æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿é€éä»¥ä¸‹æ–¹å¼è¯çµ¡ï¼š\nGitHub: xinqilin Email: è«‹é€é GitHub è¯çµ¡ ğŸ™ è‡´è¬ æ„Ÿè¬æ‰€æœ‰åœ¨æŠ€è¡“å­¸ç¿’è·¯ä¸Šçµ¦äºˆå¹«åŠ©çš„åŒäº‹ã€æœ‹å‹å’Œé–‹æºç¤¾ç¾¤ã€‚ç‰¹åˆ¥æ„Ÿè¬é‚£äº›ç„¡ç§åˆ†äº«æŠ€è¡“çŸ¥è­˜çš„éƒ¨è½æ ¼ä½œè€…å’Œæ•™ç¨‹å‰µä½œè€…ï¼Œæ‚¨å€‘çš„åˆ†äº«è®“æˆ‘å—ç›Šè‰¯å¤šã€‚\nã€Œå­¸è€Œæ™‚ç¿’ä¹‹ï¼Œä¸äº¦èªªä¹ã€- è«–èª\nå¸Œæœ›é€™å€‹å°å°çš„æŠ€è¡“ç­†è¨˜ç©ºé–“ï¼Œèƒ½æˆç‚ºçŸ¥è­˜åˆ†äº«å’Œäº¤æµçš„å¹³å°ã€‚è®“æˆ‘å€‘ä¸€èµ·åœ¨æŠ€è¡“çš„æµ·æ´‹ä¸­æ¢ç´¢å’Œæˆé•·ï¼\n","permalink":"https://xinqilin.github.io/about/","tags":null,"title":"é—œæ–¼ Bill.Lin's Notes"},{"content":"æ¦‚è¿° FTPï¼ˆFile Transfer Protocolï¼‰æ˜¯ä¼æ¥­ç’°å¢ƒä¸­å¸¸ç”¨çš„æª”æ¡ˆå‚³è¼¸å”å®šã€‚æœ¬æ–‡æä¾›ä¸€å€‹å®Œæ•´ã€å®‰å…¨ä¸”å¯é çš„ FTP å·¥å…·é¡å¯¦ä½œï¼Œé©ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒçš„æª”æ¡ˆä¸Šå‚³ã€ä¸‹è¼‰å’Œç®¡ç†éœ€æ±‚ã€‚\næ ¸å¿ƒç‰¹æ€§ âœ… é…ç½®å¤–éƒ¨åŒ–ï¼šæ‰€æœ‰é€£ç·šè³‡è¨Šé€éé…ç½®æª”æ¡ˆç®¡ç† âœ… é€£ç·šæ± ç®¡ç†ï¼šæ”¯æ´é€£ç·šè¤‡ç”¨ï¼Œæå‡æ•ˆèƒ½ âœ… å®Œæ•´éŒ¯èª¤è™•ç†ï¼šè©³ç´°çš„ç•°å¸¸è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶ âœ… æª”æ¡ˆæ“ä½œï¼šä¸Šå‚³ã€ä¸‹è¼‰ã€åˆªé™¤ã€åˆ—è¡¨ç­‰å®Œæ•´åŠŸèƒ½ âœ… å®‰å…¨è€ƒé‡ï¼šå¯†ç¢¼åŠ å¯†ã€é€£ç·šè¶…æ™‚ã€è³‡æºé‡‹æ”¾ âœ… æ—¥èªŒè¨˜éŒ„ï¼šå®Œæ•´çš„æ“ä½œæ—¥èªŒå’Œç›£æ§ ä¾è³´é…ç½® Maven ä¾è³´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 \u0026lt;dependencies\u0026gt; \u0026lt;!-- Apache Commons Net --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-net\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-net\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.9.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Spring Boot Starter --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- é…ç½®è™•ç† --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; Gradle ä¾è³´ 1 2 3 4 5 dependencies { implementation \u0026#39;commons-net:commons-net:3.9.0\u0026#39; implementation \u0026#39;org.springframework.boot:spring-boot-starter\u0026#39; annotationProcessor \u0026#39;org.springframework.boot:spring-boot-configuration-processor\u0026#39; } é…ç½®é¡è¨­è¨ˆ FTP é…ç½®å±¬æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 package com.example.config; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.stereotype.Component; @Component @ConfigurationProperties(prefix = \u0026#34;ftp\u0026#34;) public class FtpProperties { private String host; private int port = 21; private String username; private String password; private String basePath = \u0026#34;/\u0026#34;; private int connectTimeout = 30000; // 30 ç§’ private int dataTimeout = 60000; // 60 ç§’ private int bufferSize = 8192; // 8KB private String encoding = \u0026#34;UTF-8\u0026#34;; private boolean passiveMode = true; private int maxConnections = 10; // Getters and Setters public String getHost() { return host; } public void setHost(String host) { this.host = host; } public int getPort() { return port; } public void setPort(int port) { this.port = port; } public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getPassword() { return password; } public void setPassword(String password) { this.password = password; } public String getBasePath() { return basePath; } public void setBasePath(String basePath) { this.basePath = basePath; } public int getConnectTimeout() { return connectTimeout; } public void setConnectTimeout(int connectTimeout) { this.connectTimeout = connectTimeout; } public int getDataTimeout() { return dataTimeout; } public void setDataTimeout(int dataTimeout) { this.dataTimeout = dataTimeout; } public int getBufferSize() { return bufferSize; } public void setBufferSize(int bufferSize) { this.bufferSize = bufferSize; } public String getEncoding() { return encoding; } public void setEncoding(String encoding) { this.encoding = encoding; } public boolean isPassiveMode() { return passiveMode; } public void setPassiveMode(boolean passiveMode) { this.passiveMode = passiveMode; } public int getMaxConnections() { return maxConnections; } public void setMaxConnections(int maxConnections) { this.maxConnections = maxConnections; } } æ‡‰ç”¨é…ç½®æª”æ¡ˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # application.yml ftp: host: ${FTP_HOST:ftp.example.com} port: ${FTP_PORT:21} username: ${FTP_USERNAME:} password: ${FTP_PASSWORD:} base-path: ${FTP_BASE_PATH:/uploads} connect-timeout: 30000 data-timeout: 60000 buffer-size: 8192 encoding: UTF-8 passive-mode: true max-connections: 10 # ç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ # export FTP_HOST=your-ftp-server.com # export FTP_USERNAME=your-username # export FTP_PASSWORD=your-secure-password æ ¸å¿ƒå·¥å…·é¡å¯¦ä½œ FTP é€£ç·šå·¥å»  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 package com.example.util; import org.apache.commons.net.ftp.FTPClient; import org.apache.commons.net.ftp.FTPReply; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Component; import com.example.config.FtpProperties; import java.io.IOException; import java.util.concurrent.BlockingQueue; import java.util.concurrent.LinkedBlockingQueue; @Component public class FtpConnectionFactory { private static final Logger logger = LoggerFactory.getLogger(FtpConnectionFactory.class); @Autowired private FtpProperties ftpProperties; private final BlockingQueue\u0026lt;FTPClient\u0026gt; connectionPool = new LinkedBlockingQueue\u0026lt;\u0026gt;(); /** * å»ºç«‹ FTP é€£ç·š */ public FTPClient createConnection() throws IOException { FTPClient ftpClient = new FTPClient(); try { // è¨­å®šé€£ç·šåƒæ•¸ ftpClient.setConnectTimeout(ftpProperties.getConnectTimeout()); ftpClient.setDataTimeout(ftpProperties.getDataTimeout()); ftpClient.setControlEncoding(ftpProperties.getEncoding()); ftpClient.setBufferSize(ftpProperties.getBufferSize()); // å»ºç«‹é€£ç·š ftpClient.connect(ftpProperties.getHost(), ftpProperties.getPort()); // æª¢æŸ¥é€£ç·šå›æ‡‰ int replyCode = ftpClient.getReplyCode(); if (!FTPReply.isPositiveCompletion(replyCode)) { ftpClient.disconnect(); throw new IOException(\u0026#34;FTP ä¼ºæœå™¨æ‹’çµ•é€£ç·šï¼Œå›æ‡‰ç¢¼ï¼š\u0026#34; + replyCode); } // ç™»å…¥ boolean loginSuccess = ftpClient.login(ftpProperties.getUsername(), ftpProperties.getPassword()); if (!loginSuccess) { ftpClient.disconnect(); throw new IOException(\u0026#34;FTP ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼\u0026#34;); } // è¨­å®šæª”æ¡ˆå‚³è¼¸æ¨¡å¼ ftpClient.setFileType(FTPClient.BINARY_FILE_TYPE); // è¨­å®šè¢«å‹•/ä¸»å‹•æ¨¡å¼ if (ftpProperties.isPassiveMode()) { ftpClient.enterLocalPassiveMode(); } else { ftpClient.enterLocalActiveMode(); } logger.info(\u0026#34;FTP é€£ç·šå»ºç«‹æˆåŠŸï¼š{}:{}\u0026#34;, ftpProperties.getHost(), ftpProperties.getPort()); return ftpClient; } catch (IOException e) { logger.error(\u0026#34;å»ºç«‹ FTP é€£ç·šå¤±æ•—ï¼š{}\u0026#34;, e.getMessage()); if (ftpClient.isConnected()) { try { ftpClient.disconnect(); } catch (IOException ex) { logger.warn(\u0026#34;é—œé–‰å¤±æ•—çš„ FTP é€£ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{}\u0026#34;, ex.getMessage()); } } throw e; } } /** * æ­¸é‚„é€£ç·šåˆ°é€£ç·šæ±  */ public void returnConnection(FTPClient ftpClient) { if (ftpClient != null \u0026amp;\u0026amp; ftpClient.isConnected()) { if (connectionPool.size() \u0026lt; ftpProperties.getMaxConnections()) { connectionPool.offer(ftpClient); } else { closeConnection(ftpClient); } } } /** * å¾é€£ç·šæ± ç²å–é€£ç·š */ public FTPClient getConnection() throws IOException { FTPClient ftpClient = connectionPool.poll(); if (ftpClient == null || !ftpClient.isConnected()) { return createConnection(); } return ftpClient; } /** * é—œé–‰é€£ç·š */ public void closeConnection(FTPClient ftpClient) { if (ftpClient != null) { try { if (ftpClient.isConnected()) { ftpClient.logout(); ftpClient.disconnect(); } } catch (IOException e) { logger.warn(\u0026#34;é—œé–‰ FTP é€£ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{}\u0026#34;, e.getMessage()); } } } } ä¸»è¦ FTP å·¥å…·é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 package com.example.util; import org.apache.commons.net.ftp.FTPClient; import org.apache.commons.net.ftp.FTPFile; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.stereotype.Component; import org.springframework.util.StringUtils; import com.example.config.FtpProperties; import java.io.*; import java.time.LocalDateTime; import java.time.format.DateTimeFormatter; import java.util.ArrayList; import java.util.List; @Component public class FtpUtil { private static final Logger logger = LoggerFactory.getLogger(FtpUtil.class); @Autowired private FtpConnectionFactory connectionFactory; @Autowired private FtpProperties ftpProperties; /** * ä¸Šå‚³æª”æ¡ˆ * * @param localFile æœ¬åœ°æª”æ¡ˆ * @param remotePath é ç«¯è·¯å¾‘ï¼ˆç›¸å°æ–¼ basePathï¼‰ * @return ä¸Šå‚³æ˜¯å¦æˆåŠŸ */ public boolean uploadFile(File localFile, String remotePath) { if (!localFile.exists() || !localFile.isFile()) { logger.error(\u0026#34;æœ¬åœ°æª”æ¡ˆä¸å­˜åœ¨æˆ–ä¸æ˜¯æª”æ¡ˆï¼š{}\u0026#34;, localFile.getAbsolutePath()); return false; } try (FileInputStream fis = new FileInputStream(localFile)) { return uploadFile(fis, remotePath, localFile.getName()); } catch (IOException e) { logger.error(\u0026#34;è®€å–æœ¬åœ°æª”æ¡ˆå¤±æ•—ï¼š{}\u0026#34;, e.getMessage()); return false; } } /** * ä¸Šå‚³æª”æ¡ˆæµ * * @param inputStream è¼¸å…¥æµ * @param remotePath é ç«¯è·¯å¾‘ * @param fileName æª”æ¡ˆåç¨± * @return ä¸Šå‚³æ˜¯å¦æˆåŠŸ */ public boolean uploadFile(InputStream inputStream, String remotePath, String fileName) { FTPClient ftpClient = null; try { ftpClient = connectionFactory.getConnection(); // ç¢ºä¿é ç«¯ç›®éŒ„å­˜åœ¨ String fullPath = buildFullPath(remotePath); createDirectoryIfNotExists(ftpClient, fullPath); // åˆ‡æ›åˆ°ç›®æ¨™ç›®éŒ„ if (!ftpClient.changeWorkingDirectory(fullPath)) { logger.error(\u0026#34;ç„¡æ³•åˆ‡æ›åˆ°ç›®éŒ„ï¼š{}\u0026#34;, fullPath); return false; } // ä¸Šå‚³æª”æ¡ˆ boolean result = ftpClient.storeFile(fileName, inputStream); if (result) { logger.info(\u0026#34;æª”æ¡ˆä¸Šå‚³æˆåŠŸï¼š{}/{}\u0026#34;, fullPath, fileName); } else { logger.error(\u0026#34;æª”æ¡ˆä¸Šå‚³å¤±æ•—ï¼š{}/{}\u0026#34;, fullPath, fileName); } return result; } catch (IOException e) { logger.error(\u0026#34;ä¸Šå‚³æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{}\u0026#34;, e.getMessage()); return false; } finally { connectionFactory.returnConnection(ftpClient); closeQuietly(inputStream); } } /** * ä¸‹è¼‰æª”æ¡ˆ * * @param remotePath é ç«¯è·¯å¾‘ * @param fileName æª”æ¡ˆåç¨± * @param localFile æœ¬åœ°æª”æ¡ˆ * @return ä¸‹è¼‰æ˜¯å¦æˆåŠŸ */ public boolean downloadFile(String remotePath, String fileName, File localFile) { FTPClient ftpClient = null; try { ftpClient = connectionFactory.getConnection(); String fullPath = buildFullPath(remotePath); if (!ftpClient.changeWorkingDirectory(fullPath)) { logger.error(\u0026#34;é ç«¯ç›®éŒ„ä¸å­˜åœ¨ï¼š{}\u0026#34;, fullPath); return false; } // ç¢ºä¿æœ¬åœ°ç›®éŒ„å­˜åœ¨ File parentDir = localFile.getParentFile(); if (!parentDir.exists()) { parentDir.mkdirs(); } try (FileOutputStream fos = new FileOutputStream(localFile)) { boolean result = ftpClient.retrieveFile(fileName, fos); if (result) { logger.info(\u0026#34;æª”æ¡ˆä¸‹è¼‰æˆåŠŸï¼š{}/{} -\u0026gt; {}\u0026#34;, fullPath, fileName, localFile.getAbsolutePath()); } else { logger.error(\u0026#34;æª”æ¡ˆä¸‹è¼‰å¤±æ•—ï¼š{}/{}\u0026#34;, fullPath, fileName); } return result; } } catch (IOException e) { logger.error(\u0026#34;ä¸‹è¼‰æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{}\u0026#34;, e.getMessage()); return false; } finally { connectionFactory.returnConnection(ftpClient); } } /** * åˆªé™¤æª”æ¡ˆ * * @param remotePath é ç«¯è·¯å¾‘ * @param fileName æª”æ¡ˆåç¨± * @return åˆªé™¤æ˜¯å¦æˆåŠŸ */ public boolean deleteFile(String remotePath, String fileName) { FTPClient ftpClient = null; try { ftpClient = connectionFactory.getConnection(); String fullPath = buildFullPath(remotePath); if (!ftpClient.changeWorkingDirectory(fullPath)) { logger.error(\u0026#34;é ç«¯ç›®éŒ„ä¸å­˜åœ¨ï¼š{}\u0026#34;, fullPath); return false; } boolean result = ftpClient.deleteFile(fileName); if (result) { logger.info(\u0026#34;æª”æ¡ˆåˆªé™¤æˆåŠŸï¼š{}/{}\u0026#34;, fullPath, fileName); } else { logger.error(\u0026#34;æª”æ¡ˆåˆªé™¤å¤±æ•—ï¼š{}/{}\u0026#34;, fullPath, fileName); } return result; } catch (IOException e) { logger.error(\u0026#34;åˆªé™¤æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{}\u0026#34;, e.getMessage()); return false; } finally { connectionFactory.returnConnection(ftpClient); } } /** * åˆ—å‡ºç›®éŒ„ä¸­çš„æª”æ¡ˆ * * @param remotePath é ç«¯è·¯å¾‘ * @return æª”æ¡ˆåˆ—è¡¨ */ public List\u0026lt;FtpFileInfo\u0026gt; listFiles(String remotePath) { FTPClient ftpClient = null; List\u0026lt;FtpFileInfo\u0026gt; fileList = new ArrayList\u0026lt;\u0026gt;(); try { ftpClient = connectionFactory.getConnection(); String fullPath = buildFullPath(remotePath); if (!ftpClient.changeWorkingDirectory(fullPath)) { logger.error(\u0026#34;é ç«¯ç›®éŒ„ä¸å­˜åœ¨ï¼š{}\u0026#34;, fullPath); return fileList; } FTPFile[] ftpFiles = ftpClient.listFiles(); for (FTPFile ftpFile : ftpFiles) { FtpFileInfo fileInfo = new FtpFileInfo(); fileInfo.setName(ftpFile.getName()); fileInfo.setSize(ftpFile.getSize()); fileInfo.setDirectory(ftpFile.isDirectory()); fileInfo.setModifyTime(ftpFile.getTimestamp()); fileList.add(fileInfo); } logger.info(\u0026#34;æˆåŠŸåˆ—å‡ºç›®éŒ„ {} ä¸­çš„ {} å€‹æª”æ¡ˆ\u0026#34;, fullPath, fileList.size()); } catch (IOException e) { logger.error(\u0026#34;åˆ—å‡ºæª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{}\u0026#34;, e.getMessage()); } finally { connectionFactory.returnConnection(ftpClient); } return fileList; } /** * æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ * * @param remotePath é ç«¯è·¯å¾‘ * @param fileName æª”æ¡ˆåç¨± * @return æª”æ¡ˆæ˜¯å¦å­˜åœ¨ */ public boolean fileExists(String remotePath, String fileName) { FTPClient ftpClient = null; try { ftpClient = connectionFactory.getConnection(); String fullPath = buildFullPath(remotePath); if (!ftpClient.changeWorkingDirectory(fullPath)) { return false; } FTPFile[] files = ftpClient.listFiles(fileName); return files != null \u0026amp;\u0026amp; files.length \u0026gt; 0; } catch (IOException e) { logger.error(\u0026#34;æª¢æŸ¥æª”æ¡ˆå­˜åœ¨æ€§æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{}\u0026#34;, e.getMessage()); return false; } finally { connectionFactory.returnConnection(ftpClient); } } /** * å»ºç«‹å®Œæ•´è·¯å¾‘ */ private String buildFullPath(String remotePath) { String basePath = ftpProperties.getBasePath(); if (!StringUtils.hasText(remotePath)) { return basePath; } // è¦ç¯„åŒ–è·¯å¾‘ String normalizedBasePath = basePath.endsWith(\u0026#34;/\u0026#34;) ? basePath : basePath + \u0026#34;/\u0026#34;; String normalizedRemotePath = remotePath.startsWith(\u0026#34;/\u0026#34;) ? remotePath.substring(1) : remotePath; return normalizedBasePath + normalizedRemotePath; } /** * éè¿´å»ºç«‹ç›®éŒ„ */ private void createDirectoryIfNotExists(FTPClient ftpClient, String path) throws IOException { String[] pathElements = path.split(\u0026#34;/\u0026#34;); StringBuilder currentPath = new StringBuilder(); for (String element : pathElements) { if (StringUtils.hasText(element)) { currentPath.append(\u0026#34;/\u0026#34;).append(element); if (!ftpClient.changeWorkingDirectory(currentPath.toString())) { if (ftpClient.makeDirectory(currentPath.toString())) { logger.debug(\u0026#34;å»ºç«‹ç›®éŒ„ï¼š{}\u0026#34;, currentPath.toString()); } else { throw new IOException(\u0026#34;ç„¡æ³•å»ºç«‹ç›®éŒ„ï¼š\u0026#34; + currentPath.toString()); } } } } } /** * å®‰éœåœ°é—œé–‰è³‡æº */ private void closeQuietly(Closeable closeable) { if (closeable != null) { try { closeable.close(); } catch (IOException e) { // å¿½ç•¥é—œé–‰æ™‚çš„éŒ¯èª¤ } } } } æª”æ¡ˆè³‡è¨Šå¯¦é«”é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package com.example.util; import java.util.Calendar; public class FtpFileInfo { private String name; private long size; private boolean isDirectory; private Calendar modifyTime; // Getters and Setters public String getName() { return name; } public void setName(String name) { this.name = name; } public long getSize() { return size; } public void setSize(long size) { this.size = size; } public boolean isDirectory() { return isDirectory; } public void setDirectory(boolean directory) { isDirectory = directory; } public Calendar getModifyTime() { return modifyTime; } public void setModifyTime(Calendar modifyTime) { this.modifyTime = modifyTime; } @Override public String toString() { return String.format(\u0026#34;FtpFileInfo{name=\u0026#39;%s\u0026#39;, size=%d, isDirectory=%s}\u0026#34;, name, size, isDirectory); } } ä½¿ç”¨ç¯„ä¾‹ åŸºæœ¬ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 @Service public class FileService { @Autowired private FtpUtil ftpUtil; /** * ä¸Šå‚³ä½¿ç”¨è€…é ­åƒ */ public boolean uploadAvatar(MultipartFile file, String userId) { try { String remotePath = \u0026#34;avatars/\u0026#34; + userId; String fileName = generateFileName(file.getOriginalFilename()); return ftpUtil.uploadFile(file.getInputStream(), remotePath, fileName); } catch (IOException e) { logger.error(\u0026#34;ä¸Šå‚³é ­åƒå¤±æ•—ï¼š{}\u0026#34;, e.getMessage()); return false; } } /** * æ‰¹é‡ä¸Šå‚³æª”æ¡ˆ */ public List\u0026lt;String\u0026gt; batchUpload(List\u0026lt;MultipartFile\u0026gt; files, String category) { List\u0026lt;String\u0026gt; successFiles = new ArrayList\u0026lt;\u0026gt;(); String remotePath = \u0026#34;uploads/\u0026#34; + category + \u0026#34;/\u0026#34; + getCurrentDate(); for (MultipartFile file : files) { try { String fileName = generateFileName(file.getOriginalFilename()); if (ftpUtil.uploadFile(file.getInputStream(), remotePath, fileName)) { successFiles.add(fileName); } } catch (IOException e) { logger.error(\u0026#34;æ‰¹é‡ä¸Šå‚³æª”æ¡ˆå¤±æ•—ï¼š{}\u0026#34;, file.getOriginalFilename()); } } return successFiles; } private String generateFileName(String originalName) { String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern(\u0026#34;yyyyMMddHHmmss\u0026#34;)); String extension = originalName.substring(originalName.lastIndexOf(\u0026#34;.\u0026#34;)); return timestamp + \u0026#34;_\u0026#34; + UUID.randomUUID().toString().substring(0, 8) + extension; } private String getCurrentDate() { return LocalDateTime.now().format(DateTimeFormatter.ofPattern(\u0026#34;yyyy/MM/dd\u0026#34;)); } } é€²éšåŠŸèƒ½ï¼šæª”æ¡ˆåŒæ­¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 @Component public class FtpSyncService { @Autowired private FtpUtil ftpUtil; /** * åŒæ­¥æœ¬åœ°ç›®éŒ„åˆ° FTP */ public void syncDirectoryToFtp(String localDirPath, String remotePath) { File localDir = new File(localDirPath); if (!localDir.exists() || !localDir.isDirectory()) { logger.error(\u0026#34;æœ¬åœ°ç›®éŒ„ä¸å­˜åœ¨ï¼š{}\u0026#34;, localDirPath); return; } syncDirectoryRecursive(localDir, remotePath); } private void syncDirectoryRecursive(File localDir, String remotePath) { File[] files = localDir.listFiles(); if (files == null) return; for (File file : files) { if (file.isDirectory()) { // éè¿´è™•ç†å­ç›®éŒ„ String subRemotePath = remotePath + \u0026#34;/\u0026#34; + file.getName(); syncDirectoryRecursive(file, subRemotePath); } else { // ä¸Šå‚³æª”æ¡ˆ if (!ftpUtil.fileExists(remotePath, file.getName())) { ftpUtil.uploadFile(file, remotePath); logger.info(\u0026#34;åŒæ­¥æª”æ¡ˆï¼š{} -\u0026gt; {}/{}\u0026#34;, file.getAbsolutePath(), remotePath, file.getName()); } } } } } å®‰å…¨æœ€ä½³å¯¦è¸ 1. é…ç½®å®‰å…¨ 1 2 3 4 5 # ä½¿ç”¨ç’°å¢ƒè®Šæ•¸æˆ–åŠ å¯†é…ç½® ftp: host: ${FTP_HOST} username: ${FTP_USERNAME} password: ${FTP_PASSWORD:#{null}} # å¯ä»¥ç‚ºç©ºï¼Œä½¿ç”¨ SSH Key 2. æª”æ¡ˆé©—è­‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @Component public class FileValidator { private static final List\u0026lt;String\u0026gt; ALLOWED_EXTENSIONS = Arrays.asList(\u0026#34;.jpg\u0026#34;, \u0026#34;.png\u0026#34;, \u0026#34;.pdf\u0026#34;, \u0026#34;.doc\u0026#34;, \u0026#34;.docx\u0026#34;, \u0026#34;.xls\u0026#34;, \u0026#34;.xlsx\u0026#34;); private static final long MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB public boolean isValidFile(MultipartFile file) { // æª¢æŸ¥æª”æ¡ˆå¤§å° if (file.getSize() \u0026gt; MAX_FILE_SIZE) { return false; } // æª¢æŸ¥æª”æ¡ˆå‰¯æª”å String fileName = file.getOriginalFilename(); if (fileName == null) return false; String extension = fileName.substring(fileName.lastIndexOf(\u0026#34;.\u0026#34;)).toLowerCase(); return ALLOWED_EXTENSIONS.contains(extension); } } 3. å­˜å–æ§åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 @Component public class FtpAccessControl { /** * æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™å­˜å–æŒ‡å®šè·¯å¾‘ */ public boolean hasAccess(String userId, String remotePath) { // å¯¦ä½œå­˜å–æ§åˆ¶é‚è¼¯ // ä¾‹å¦‚ï¼šä½¿ç”¨è€…åªèƒ½å­˜å–è‡ªå·±çš„ç›®éŒ„ return remotePath.startsWith(\u0026#34;users/\u0026#34; + userId + \u0026#34;/\u0026#34;); } } ç›£æ§èˆ‡ç¶­è­· å¥åº·æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @Component public class FtpHealthIndicator implements HealthIndicator { @Autowired private FtpConnectionFactory connectionFactory; @Override public Health health() { try { FTPClient ftpClient = connectionFactory.getConnection(); boolean isConnected = ftpClient.isConnected(); connectionFactory.returnConnection(ftpClient); return isConnected ? Health.up().withDetail(\u0026#34;status\u0026#34;, \u0026#34;FTP connection available\u0026#34;).build() : Health.down().withDetail(\u0026#34;status\u0026#34;, \u0026#34;FTP connection failed\u0026#34;).build(); } catch (Exception e) { return Health.down().withDetail(\u0026#34;error\u0026#34;, e.getMessage()).build(); } } } æ•ˆèƒ½ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Aspect @Component public class FtpPerformanceAspect { private static final Logger logger = LoggerFactory.getLogger(FtpPerformanceAspect.class); @Around(\u0026#34;execution(* com.example.util.FtpUtil.*(..))\u0026#34;) public Object logExecutionTime(ProceedingJoinPoint joinPoint) throws Throwable { long startTime = System.currentTimeMillis(); try { Object result = joinPoint.proceed(); long endTime = System.currentTimeMillis(); logger.info(\u0026#34;FTP æ“ä½œ {} åŸ·è¡Œæ™‚é–“ï¼š{}ms\u0026#34;, joinPoint.getSignature().getName(), endTime - startTime); return result; } catch (Exception e) { long endTime = System.currentTimeMillis(); logger.error(\u0026#34;FTP æ“ä½œ {} å¤±æ•—ï¼ŒåŸ·è¡Œæ™‚é–“ï¼š{}msï¼ŒéŒ¯èª¤ï¼š{}\u0026#34;, joinPoint.getSignature().getName(), endTime - startTime, e.getMessage()); throw e; } } } å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ 1. é€£ç·šé€¾æ™‚å•é¡Œ 1 2 3 4 5 // å¢åŠ é‡è©¦æ©Ÿåˆ¶ @Retryable(value = {IOException.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000)) public boolean uploadFileWithRetry(InputStream inputStream, String remotePath, String fileName) { return uploadFile(inputStream, remotePath, fileName); } 2. ä¸­æ–‡æª”åå•é¡Œ 1 2 3 4 5 // åœ¨ FTP é…ç½®ä¸­è¨­å®šæ­£ç¢ºçš„ç·¨ç¢¼ ftpClient.setControlEncoding(\u0026#34;UTF-8\u0026#34;); // æˆ–è€…å°æª”åé€²è¡Œç·¨ç¢¼è™•ç† String encodedFileName = new String(fileName.getBytes(\u0026#34;UTF-8\u0026#34;), \u0026#34;ISO-8859-1\u0026#34;); 3. é˜²ç«ç‰†å•é¡Œ 1 2 3 # ä½¿ç”¨è¢«å‹•æ¨¡å¼é¿å…é˜²ç«ç‰†å•é¡Œ ftp: passive-mode: true æ¸¬è©¦ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @SpringBootTest class FtpUtilTest { @Autowired private FtpUtil ftpUtil; @Test void testUploadFile() { // å»ºç«‹æ¸¬è©¦æª”æ¡ˆ File testFile = createTestFile(); // åŸ·è¡Œä¸Šå‚³ boolean result = ftpUtil.uploadFile(testFile, \u0026#34;test\u0026#34;, \u0026#34;test.txt\u0026#34;); // é©—è­‰çµæœ assertTrue(result); assertTrue(ftpUtil.fileExists(\u0026#34;test\u0026#34;, \u0026#34;test.txt\u0026#34;)); // æ¸…ç† ftpUtil.deleteFile(\u0026#34;test\u0026#34;, \u0026#34;test.txt\u0026#34;); } private File createTestFile() { try { File tempFile = File.createTempFile(\u0026#34;test\u0026#34;, \u0026#34;.txt\u0026#34;); Files.write(tempFile.toPath(), \u0026#34;æ¸¬è©¦å…§å®¹\u0026#34;.getBytes()); return tempFile; } catch (IOException e) { throw new RuntimeException(e); } } } ç¸½çµ æœ¬æ–‡æä¾›çš„ FTP å·¥å…·é¡å…·å‚™ä»¥ä¸‹å„ªå‹¢ï¼š\nå®‰å…¨æ€§ï¼šé…ç½®å¤–éƒ¨åŒ–ï¼Œé¿å…ç¡¬ç·¨ç¢¼æ•æ„Ÿè³‡è¨Š å¯é æ€§ï¼šå®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶ æ•ˆèƒ½ï¼šé€£ç·šæ± ç®¡ç†ï¼Œæ”¯æ´ä½µç™¼æ“ä½œ å¯ç¶­è­·æ€§ï¼šæ¨¡çµ„åŒ–è¨­è¨ˆï¼Œæ˜“æ–¼æ“´å±•å’Œç¶­è­· ç”Ÿç”¢å°±ç·’ï¼šåŒ…å«ç›£æ§ã€æ—¥èªŒå’Œå¥åº·æª¢æŸ¥ åœ¨å¯¦éš›ä½¿ç”¨æ™‚ï¼Œè«‹æ ¹æ“šå…·é«”éœ€æ±‚èª¿æ•´é…ç½®åƒæ•¸å’Œå®‰å…¨è¨­å®šï¼Œç¢ºä¿ç¬¦åˆæ‚¨çš„æ¥­å‹™å ´æ™¯å’Œå®‰å…¨è¦æ±‚ã€‚\nåƒè€ƒè³‡æ–™ Apache Commons Net å®˜æ–¹æ–‡æª” Spring Boot Configuration Properties FTP RFC 959 å”å®šè¦ç¯„ Java FTP æœ€ä½³å¯¦è¸ ","permalink":"https://xinqilin.github.io/post/backend/ftputil/","tags":["Java","FTP","FileTransfer","Spring","Commons-Net","Security"],"title":"FTP å·¥å…·é¡å¯¦ä½œæŒ‡å—ï¼šå®‰å…¨ã€å¯é çš„æª”æ¡ˆå‚³è¼¸è§£æ±ºæ–¹æ¡ˆ"},{"content":"æ¦‚è¿° åœ¨ä¼æ¥­ç´šæ‡‰ç”¨ç¨‹å¼é–‹ç™¼ä¸­ï¼ŒEnumï¼ˆåˆ—èˆ‰ï¼‰æ˜¯è¡¨ç¤ºæœ‰é™ç‹€æ…‹é›†åˆçš„ç†æƒ³é¸æ“‡ï¼Œå¦‚è¨‚å–®ç‹€æ…‹ã€ä½¿ç”¨è€…è§’è‰²ã€å¯©æ ¸ç‹€æ…‹ç­‰ã€‚æœ¬æ–‡æ·±å…¥æ¢è¨å¦‚ä½•åœ¨ JPA/Hibernate ä¸­æœ‰æ•ˆè™•ç† Enum å‹åˆ¥ï¼ŒåŒ…å«å„ç¨®æ˜ å°„ç­–ç•¥ã€æ•ˆèƒ½è€ƒé‡å’Œå¯¦éš›æ‡‰ç”¨å ´æ™¯ã€‚\nåŸºæœ¬ Enum æ˜ å°„ 1. @Enumerated è¨»è§£ JPA æä¾› @Enumerated è¨»è§£ä¾†è™•ç† Enum æ˜ å°„ï¼Œæ”¯æ´å…©ç¨®ç­–ç•¥ï¼š\nEnumType.ORDINALï¼ˆæ•¸å­—æ˜ å°„ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // å®šç¾©ç‹€æ…‹åˆ—èˆ‰ public enum OrderStatus { PENDING, // 0 CONFIRMED, // 1 SHIPPED, // 2 DELIVERED, // 3 CANCELLED // 4 } // å¯¦é«”é¡ä½¿ç”¨ @Entity @Table(name = \u0026#34;orders\u0026#34;) public class Order { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @Enumerated(EnumType.ORDINAL) @Column(name = \u0026#34;status\u0026#34;, nullable = false) private OrderStatus status = OrderStatus.PENDING; // å…¶ä»–å±¬æ€§... } è³‡æ–™åº«å„²å­˜ï¼š\n1 2 3 4 5 6 7 CREATE TABLE orders ( id BIGINT PRIMARY KEY AUTO_INCREMENT, status TINYINT NOT NULL DEFAULT 0, -- å…¶ä»–æ¬„ä½ ); -- å„²å­˜çš„å€¼ï¼š0=PENDING, 1=CONFIRMED, 2=SHIPPED, 3=DELIVERED, 4=CANCELLED EnumType.STRINGï¼ˆå­—ä¸²æ˜ å°„ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Entity @Table(name = \u0026#34;orders\u0026#34;) public class Order { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @Enumerated(EnumType.STRING) @Column(name = \u0026#34;status\u0026#34;, length = 20, nullable = false) private OrderStatus status = OrderStatus.PENDING; // å…¶ä»–å±¬æ€§... } è³‡æ–™åº«å„²å­˜ï¼š\n1 2 3 4 5 6 7 CREATE TABLE orders ( id BIGINT PRIMARY KEY AUTO_INCREMENT, status VARCHAR(20) NOT NULL DEFAULT \u0026#39;PENDING\u0026#39;, -- å…¶ä»–æ¬„ä½ ); -- å„²å­˜çš„å€¼ï¼š\u0026#39;PENDING\u0026#39;, \u0026#39;CONFIRMED\u0026#39;, \u0026#39;SHIPPED\u0026#39;, \u0026#39;DELIVERED\u0026#39;, \u0026#39;CANCELLED\u0026#39; 2. æ˜ å°„ç­–ç•¥æ¯”è¼ƒ ç‰¹æ€§ ORDINAL STRING å„²å­˜ç©ºé–“ å°ï¼ˆ1-4 bytesï¼‰ å¤§ï¼ˆå­—ä¸²é•·åº¦ï¼‰ å¯è®€æ€§ å·®ï¼ˆæ•¸å­—ï¼‰ å¥½ï¼ˆæ–‡å­—ï¼‰ é †åºè®Šæ›´é¢¨éšª é«˜ï¼ˆç ´å£æ€§ï¼‰ ç„¡ æ–°å¢é …ç›® åªèƒ½è¿½åŠ  ä»»æ„ä½ç½® è³‡æ–™åº«æŸ¥è©¢ å¿«é€Ÿ è¼ƒæ…¢ é™¤éŒ¯å‹å–„ å›°é›£ å®¹æ˜“ å»ºè­°ï¼šç”Ÿç”¢ç’°å¢ƒé€šå¸¸ä½¿ç”¨ EnumType.STRINGï¼Œå› ç‚ºå…¶å…·å‚™æ›´å¥½çš„å¯ç¶­è­·æ€§å’Œå¯è®€æ€§ã€‚\né€²éš Enum è™•ç† 1. è‡ªè¨‚ Enum å€¼ ç•¶éœ€è¦æ›´å…·èªæ„çš„è³‡æ–™åº«å€¼æ™‚ï¼Œå¯ä»¥ç‚º Enum æ·»åŠ è‡ªè¨‚å±¬æ€§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 public enum OrderStatus { PENDING(\u0026#34;PND\u0026#34;, \u0026#34;è¨‚å–®å¾…è™•ç†\u0026#34;), CONFIRMED(\u0026#34;CNF\u0026#34;, \u0026#34;è¨‚å–®å·²ç¢ºèª\u0026#34;), SHIPPED(\u0026#34;SHP\u0026#34;, \u0026#34;å•†å“å·²å‡ºè²¨\u0026#34;), DELIVERED(\u0026#34;DLV\u0026#34;, \u0026#34;å•†å“å·²é€é”\u0026#34;), CANCELLED(\u0026#34;CXL\u0026#34;, \u0026#34;è¨‚å–®å·²å–æ¶ˆ\u0026#34;); private final String code; private final String description; OrderStatus(String code, String description) { this.code = code; this.description = description; } public String getCode() { return code; } public String getDescription() { return description; } // å¾ä»£ç¢¼æŸ¥æ‰¾ Enum public static OrderStatus fromCode(String code) { return Arrays.stream(values()) .filter(status -\u0026gt; status.code.equals(code)) .findFirst() .orElseThrow(() -\u0026gt; new IllegalArgumentException(\u0026#34;æœªçŸ¥çš„è¨‚å–®ç‹€æ…‹ä»£ç¢¼: \u0026#34; + code)); } // å–å¾—æ‰€æœ‰ä»£ç¢¼ public static List\u0026lt;String\u0026gt; getAllCodes() { return Arrays.stream(values()) .map(OrderStatus::getCode) .collect(Collectors.toList()); } } 2. è‡ªè¨‚ AttributeConverter ä½¿ç”¨ JPA 2.1 çš„ @Converter è¨»è§£ä¾†å¯¦ç¾è‡ªè¨‚è½‰æ›ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Converter(autoApply = true) public class OrderStatusConverter implements AttributeConverter\u0026lt;OrderStatus, String\u0026gt; { @Override public String convertToDatabaseColumn(OrderStatus orderStatus) { if (orderStatus == null) { return null; } return orderStatus.getCode(); } @Override public OrderStatus convertToEntityAttribute(String code) { if (code == null || code.isEmpty()) { return null; } return OrderStatus.fromCode(code); } } å¯¦é«”é¡ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Entity @Table(name = \u0026#34;orders\u0026#34;) public class Order { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @Convert(converter = OrderStatusConverter.class) @Column(name = \u0026#34;status\u0026#34;, length = 3, nullable = false) private OrderStatus status = OrderStatus.PENDING; // å…¶ä»–å±¬æ€§... } è³‡æ–™åº«å„²å­˜çµæœï¼š\n1 2 -- å„²å­˜çš„å€¼ï¼š\u0026#39;PND\u0026#39;, \u0026#39;CNF\u0026#39;, \u0026#39;SHP\u0026#39;, \u0026#39;DLV\u0026#39;, \u0026#39;CXL\u0026#39; INSERT INTO orders (status) VALUES (\u0026#39;PND\u0026#39;); 3. é€šç”¨ Enum è½‰æ›å™¨ å»ºç«‹é€šç”¨çš„ Enum è½‰æ›å™¨åŸºé¡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public interface CodedEnum { String getCode(); static \u0026lt;T extends Enum\u0026lt;T\u0026gt; \u0026amp; CodedEnum\u0026gt; T fromCode(Class\u0026lt;T\u0026gt; enumClass, String code) { return Arrays.stream(enumClass.getEnumConstants()) .filter(e -\u0026gt; e.getCode().equals(code)) .findFirst() .orElseThrow(() -\u0026gt; new IllegalArgumentException( \u0026#34;æœªçŸ¥çš„ \u0026#34; + enumClass.getSimpleName() + \u0026#34; ä»£ç¢¼: \u0026#34; + code)); } } // é€šç”¨è½‰æ›å™¨åŸºé¡ public abstract class CodedEnumConverter\u0026lt;T extends Enum\u0026lt;T\u0026gt; \u0026amp; CodedEnum\u0026gt; implements AttributeConverter\u0026lt;T, String\u0026gt; { private final Class\u0026lt;T\u0026gt; enumClass; protected CodedEnumConverter(Class\u0026lt;T\u0026gt; enumClass) { this.enumClass = enumClass; } @Override public String convertToDatabaseColumn(T attribute) { return attribute != null ? attribute.getCode() : null; } @Override public T convertToEntityAttribute(String dbData) { return dbData != null ? CodedEnum.fromCode(enumClass, dbData) : null; } } å…·é«”å¯¦ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // å¯¦ä½œ CodedEnum ä»‹é¢ public enum Priority implements CodedEnum { LOW(\u0026#34;L\u0026#34;), MEDIUM(\u0026#34;M\u0026#34;), HIGH(\u0026#34;H\u0026#34;), URGENT(\u0026#34;U\u0026#34;); private final String code; Priority(String code) { this.code = code; } @Override public String getCode() { return code; } } // å…·é«”è½‰æ›å™¨ @Converter(autoApply = true) public class PriorityConverter extends CodedEnumConverter\u0026lt;Priority\u0026gt; { public PriorityConverter() { super(Priority.class); } } è¤‡é›œæ‡‰ç”¨å ´æ™¯ 1. å¤šç‹€æ…‹ Enum è¨­è¨ˆ è¨­è¨ˆåŒ…å«ç‹€æ…‹è½‰æ›é‚è¼¯çš„ Enumï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 public enum OrderStatus implements CodedEnum { DRAFT(\u0026#34;DFT\u0026#34;, \u0026#34;è‰ç¨¿\u0026#34;, Set.of()), PENDING(\u0026#34;PND\u0026#34;, \u0026#34;å¾…è™•ç†\u0026#34;, Set.of(DRAFT)), CONFIRMED(\u0026#34;CNF\u0026#34;, \u0026#34;å·²ç¢ºèª\u0026#34;, Set.of(PENDING)), PAID(\u0026#34;PAD\u0026#34;, \u0026#34;å·²ä»˜æ¬¾\u0026#34;, Set.of(CONFIRMED)), SHIPPED(\u0026#34;SHP\u0026#34;, \u0026#34;å·²å‡ºè²¨\u0026#34;, Set.of(PAID)), DELIVERED(\u0026#34;DLV\u0026#34;, \u0026#34;å·²é€é”\u0026#34;, Set.of(SHIPPED)), CANCELLED(\u0026#34;CXL\u0026#34;, \u0026#34;å·²å–æ¶ˆ\u0026#34;, Set.of(DRAFT, PENDING, CONFIRMED, PAID)), REFUNDED(\u0026#34;RFD\u0026#34;, \u0026#34;å·²é€€æ¬¾\u0026#34;, Set.of(PAID, SHIPPED, DELIVERED)); private final String code; private final String description; private final Set\u0026lt;OrderStatus\u0026gt; allowedPreviousStatuses; OrderStatus(String code, String description, Set\u0026lt;OrderStatus\u0026gt; allowedPreviousStatuses) { this.code = code; this.description = description; this.allowedPreviousStatuses = allowedPreviousStatuses; } @Override public String getCode() { return code; } public String getDescription() { return description; } // æª¢æŸ¥ç‹€æ…‹è½‰æ›æ˜¯å¦åˆæ³• public boolean canTransitionFrom(OrderStatus currentStatus) { return allowedPreviousStatuses.contains(currentStatus); } // å–å¾—å¯è½‰æ›åˆ°çš„ç‹€æ…‹ public Set\u0026lt;OrderStatus\u0026gt; getNextPossibleStatuses() { return Arrays.stream(values()) .filter(status -\u0026gt; status.canTransitionFrom(this)) .collect(Collectors.toSet()); } // æª¢æŸ¥æ˜¯å¦ç‚ºçµ‚çµç‹€æ…‹ public boolean isFinalStatus() { return this == DELIVERED || this == CANCELLED || this == REFUNDED; } // æª¢æŸ¥æ˜¯å¦å¯å–æ¶ˆ public boolean isCancellable() { return CANCELLED.canTransitionFrom(this); } } 2. æ¥­å‹™é‚è¼¯æ•´åˆ åœ¨ Service å±¤ä¸­æ•´åˆç‹€æ…‹è½‰æ›é‚è¼¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 @Service @Transactional public class OrderService { @Autowired private OrderRepository orderRepository; @Autowired private OrderStatusHistoryService statusHistoryService; public void updateOrderStatus(Long orderId, OrderStatus newStatus, String reason) { Order order = orderRepository.findById(orderId) .orElseThrow(() -\u0026gt; new EntityNotFoundException(\u0026#34;è¨‚å–®ä¸å­˜åœ¨: \u0026#34; + orderId)); OrderStatus currentStatus = order.getStatus(); // é©—è­‰ç‹€æ…‹è½‰æ› if (!newStatus.canTransitionFrom(currentStatus)) { throw new IllegalStateException(String.format( \u0026#34;ç„¡æ³•å¾ %s è½‰æ›åˆ° %s\u0026#34;, currentStatus.getDescription(), newStatus.getDescription() )); } // æ›´æ–°ç‹€æ…‹ order.setStatus(newStatus); order.setLastModified(LocalDateTime.now()); // è¨˜éŒ„ç‹€æ…‹è®Šæ›´æ­·å² statusHistoryService.recordStatusChange(orderId, currentStatus, newStatus, reason); // è§¸ç™¼ç›¸é—œæ¥­å‹™é‚è¼¯ handleStatusChange(order, currentStatus, newStatus); orderRepository.save(order); } private void handleStatusChange(Order order, OrderStatus from, OrderStatus to) { switch (to) { case CONFIRMED: // ç™¼é€ç¢ºèªéƒµä»¶ emailService.sendOrderConfirmation(order); break; case SHIPPED: // ç™¼é€å‡ºè²¨é€šçŸ¥ emailService.sendShippingNotification(order); // æ¸›å°‘åº«å­˜ inventoryService.decreaseStock(order.getItems()); break; case DELIVERED: // ç™¼é€é€é”é€šçŸ¥ emailService.sendDeliveryNotification(order); break; case CANCELLED: // æ¢å¾©åº«å­˜ inventoryService.restoreStock(order.getItems()); // è™•ç†é€€æ¬¾ if (from == OrderStatus.PAID) { paymentService.processRefund(order); } break; } } // æ‰¹é‡ç‹€æ…‹æŸ¥è©¢ public List\u0026lt;Order\u0026gt; findOrdersByStatuses(Set\u0026lt;OrderStatus\u0026gt; statuses) { return orderRepository.findByStatusIn(statuses); } // å–å¾—å¯æ“ä½œçš„è¨‚å–® public List\u0026lt;Order\u0026gt; findOrdersReadyForShipping() { return orderRepository.findByStatus(OrderStatus.PAID); } } 3. ç‹€æ…‹æ­·å²è¿½è¹¤ å»ºç«‹ç‹€æ…‹è®Šæ›´æ­·å²è¡¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Entity @Table(name = \u0026#34;order_status_history\u0026#34;) public class OrderStatusHistory { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @Column(name = \u0026#34;order_id\u0026#34;, nullable = false) private Long orderId; @Convert(converter = OrderStatusConverter.class) @Column(name = \u0026#34;from_status\u0026#34;, length = 3) private OrderStatus fromStatus; @Convert(converter = OrderStatusConverter.class) @Column(name = \u0026#34;to_status\u0026#34;, length = 3, nullable = false) private OrderStatus toStatus; @Column(name = \u0026#34;reason\u0026#34;, length = 500) private String reason; @Column(name = \u0026#34;changed_by\u0026#34;) private String changedBy; @Column(name = \u0026#34;changed_at\u0026#34;, nullable = false) private LocalDateTime changedAt; // å»ºæ§‹å­ã€Getterã€Setter... } 4. Repository æŸ¥è©¢æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Repository public interface OrderRepository extends JpaRepository\u0026lt;Order, Long\u0026gt; { // åŸºæœ¬ç‹€æ…‹æŸ¥è©¢ List\u0026lt;Order\u0026gt; findByStatus(OrderStatus status); List\u0026lt;Order\u0026gt; findByStatusIn(Collection\u0026lt;OrderStatus\u0026gt; statuses); List\u0026lt;Order\u0026gt; findByStatusNot(OrderStatus status); // è¤‡åˆæŸ¥è©¢ List\u0026lt;Order\u0026gt; findByStatusAndCreatedAtBetween( OrderStatus status, LocalDateTime start, LocalDateTime end ); // çµ±è¨ˆæŸ¥è©¢ @Query(\u0026#34;SELECT o.status, COUNT(o) FROM Order o GROUP BY o.status\u0026#34;) List\u0026lt;Object[]\u0026gt; countOrdersByStatus(); // è‡ªè¨‚æŸ¥è©¢ @Query(\u0026#34;SELECT o FROM Order o WHERE o.status IN :statuses AND o.totalAmount \u0026gt; :minAmount\u0026#34;) List\u0026lt;Order\u0026gt; findHighValueOrdersByStatuses( @Param(\u0026#34;statuses\u0026#34;) Collection\u0026lt;OrderStatus\u0026gt; statuses, @Param(\u0026#34;minAmount\u0026#34;) BigDecimal minAmount ); // åŸç”Ÿ SQL æŸ¥è©¢ @Query(value = \u0026#34;SELECT * FROM orders WHERE status IN :statusCodes AND DATE(created_at) = CURDATE()\u0026#34;, nativeQuery = true) List\u0026lt;Order\u0026gt; findTodayOrdersByStatusCodes(@Param(\u0026#34;statusCodes\u0026#34;) Collection\u0026lt;String\u0026gt; statusCodes); } æ•ˆèƒ½å„ªåŒ– 1. ç´¢å¼•è¨­è¨ˆ 1 2 3 4 5 6 7 8 9 -- ç‹€æ…‹æ¬„ä½ç´¢å¼• CREATE INDEX idx_orders_status ON orders(status); -- è¤‡åˆç´¢å¼• CREATE INDEX idx_orders_status_created ON orders(status, created_at); -- éƒ¨åˆ†ç´¢å¼•ï¼ˆé‡å°ç‰¹å®šç‹€æ…‹ï¼‰ CREATE INDEX idx_orders_active_status ON orders(status) WHERE status IN (\u0026#39;PND\u0026#39;, \u0026#39;CNF\u0026#39;, \u0026#39;PAD\u0026#39;, \u0026#39;SHP\u0026#39;); 2. æŸ¥è©¢å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Service public class OrderQueryService { // ä½¿ç”¨ Specification é€²è¡Œå‹•æ…‹æŸ¥è©¢ public Page\u0026lt;Order\u0026gt; findOrdersWithCriteria(OrderSearchCriteria criteria, Pageable pageable) { return orderRepository.findAll(Specification .where(hasStatus(criteria.getStatuses())) .and(createdBetween(criteria.getStartDate(), criteria.getEndDate())) .and(hasCustomer(criteria.getCustomerId())), pageable); } private static Specification\u0026lt;Order\u0026gt; hasStatus(Set\u0026lt;OrderStatus\u0026gt; statuses) { return (root, query, cb) -\u0026gt; statuses == null || statuses.isEmpty() ? cb.conjunction() : root.get(\u0026#34;status\u0026#34;).in(statuses); } // å¿«å–å¸¸ç”¨çµ±è¨ˆ @Cacheable(\u0026#34;orderStatusStats\u0026#34;) public Map\u0026lt;OrderStatus, Long\u0026gt; getOrderStatusStatistics() { List\u0026lt;Object[]\u0026gt; results = orderRepository.countOrdersByStatus(); return results.stream() .collect(Collectors.toMap( row -\u0026gt; (OrderStatus) row[0], row -\u0026gt; (Long) row[1] )); } } 3. å¿«å–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 @Service public class OrderStatusCacheService { private final Cache\u0026lt;String, List\u0026lt;Order\u0026gt;\u0026gt; orderCache; public OrderStatusCacheService() { this.orderCache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(Duration.ofMinutes(5)) .build(); } public List\u0026lt;Order\u0026gt; getCachedOrdersByStatus(OrderStatus status) { return orderCache.get(status.getCode(), code -\u0026gt; orderRepository.findByStatus(status)); } @EventListener public void handleOrderStatusChanged(OrderStatusChangedEvent event) { // æ¸…é™¤ç›¸é—œå¿«å– orderCache.invalidate(event.getOldStatus().getCode()); orderCache.invalidate(event.getNewStatus().getCode()); } } æ¸¬è©¦ç­–ç•¥ 1. å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 @ExtendWith(MockitoExtension.class) class OrderServiceTest { @Mock private OrderRepository orderRepository; @Mock private OrderStatusHistoryService statusHistoryService; @InjectMocks private OrderService orderService; @Test void testValidStatusTransition() { // Given Order order = createOrderWithStatus(OrderStatus.PENDING); when(orderRepository.findById(1L)).thenReturn(Optional.of(order)); // When orderService.updateOrderStatus(1L, OrderStatus.CONFIRMED, \u0026#34;å®¢æˆ¶ç¢ºèª\u0026#34;); // Then assertEquals(OrderStatus.CONFIRMED, order.getStatus()); verify(statusHistoryService).recordStatusChange( eq(1L), eq(OrderStatus.PENDING), eq(OrderStatus.CONFIRMED), eq(\u0026#34;å®¢æˆ¶ç¢ºèª\u0026#34;)); } @Test void testInvalidStatusTransition() { // Given Order order = createOrderWithStatus(OrderStatus.DELIVERED); when(orderRepository.findById(1L)).thenReturn(Optional.of(order)); // When \u0026amp; Then assertThatThrownBy(() -\u0026gt; orderService.updateOrderStatus(1L, OrderStatus.PENDING, \u0026#34;ç„¡æ•ˆè½‰æ›\u0026#34;)) .isInstanceOf(IllegalStateException.class) .hasMessageContaining(\u0026#34;ç„¡æ³•å¾\u0026#34;); } @Test void testOrderStatusEnumProperties() { // æ¸¬è©¦ç‹€æ…‹è½‰æ›é‚è¼¯ assertTrue(OrderStatus.CONFIRMED.canTransitionFrom(OrderStatus.PENDING)); assertFalse(OrderStatus.PENDING.canTransitionFrom(OrderStatus.DELIVERED)); // æ¸¬è©¦çµ‚çµç‹€æ…‹ assertTrue(OrderStatus.DELIVERED.isFinalStatus()); assertFalse(OrderStatus.PENDING.isFinalStatus()); // æ¸¬è©¦å¯å–æ¶ˆç‹€æ…‹ assertTrue(OrderStatus.PENDING.isCancellable()); assertFalse(OrderStatus.DELIVERED.isCancellable()); } } 2. æ•´åˆæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 @SpringBootTest @TestPropertySource(properties = \u0026#34;spring.jpa.hibernate.ddl-auto=create-drop\u0026#34;) class OrderStatusIntegrationTest { @Autowired private OrderService orderService; @Autowired private OrderRepository orderRepository; @Test @Transactional void testCompleteOrderWorkflow() { // å»ºç«‹è¨‚å–® Order order = createTestOrder(); order = orderRepository.save(order); // ç¢ºèªè¨‚å–® orderService.updateOrderStatus(order.getId(), OrderStatus.CONFIRMED, \u0026#34;è‡ªå‹•ç¢ºèª\u0026#34;); // ä»˜æ¬¾ orderService.updateOrderStatus(order.getId(), OrderStatus.PAID, \u0026#34;ä¿¡ç”¨å¡ä»˜æ¬¾\u0026#34;); // å‡ºè²¨ orderService.updateOrderStatus(order.getId(), OrderStatus.SHIPPED, \u0026#34;ç‰©æµå‡ºè²¨\u0026#34;); // é€é” orderService.updateOrderStatus(order.getId(), OrderStatus.DELIVERED, \u0026#34;å®¢æˆ¶ç°½æ”¶\u0026#34;); // é©—è­‰æœ€çµ‚ç‹€æ…‹ Order finalOrder = orderRepository.findById(order.getId()).orElseThrow(); assertEquals(OrderStatus.DELIVERED, finalOrder.getStatus()); } @Test void testDatabaseEnumPersistence() { // æ¸¬è©¦ Enum å€¼æ­£ç¢ºå„²å­˜å’Œè®€å– Order order = createTestOrder(); order.setStatus(OrderStatus.CONFIRMED); order = orderRepository.save(order); // æ¸…é™¤ JPA å¿«å– orderRepository.flush(); entityManager.clear(); // é‡æ–°è®€å– Order reloadedOrder = orderRepository.findById(order.getId()).orElseThrow(); assertEquals(OrderStatus.CONFIRMED, reloadedOrder.getStatus()); } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. è¨­è¨ˆåŸå‰‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // âœ… å¥½çš„å¯¦è¸ï¼šä½¿ç”¨æœ‰æ„ç¾©çš„åç¨±å’Œæè¿° public enum UserRole implements CodedEnum { ADMIN(\u0026#34;ADM\u0026#34;, \u0026#34;ç³»çµ±ç®¡ç†å“¡\u0026#34;, Set.of(\u0026#34;*\u0026#34;)), MANAGER(\u0026#34;MGR\u0026#34;, \u0026#34;éƒ¨é–€ä¸»ç®¡\u0026#34;, Set.of(\u0026#34;USER_MANAGE\u0026#34;, \u0026#34;REPORT_VIEW\u0026#34;)), USER(\u0026#34;USR\u0026#34;, \u0026#34;ä¸€èˆ¬ä½¿ç”¨è€…\u0026#34;, Set.of(\u0026#34;PROFILE_EDIT\u0026#34;)); private final String code; private final String description; private final Set\u0026lt;String\u0026gt; permissions; // å»ºæ§‹å­å’Œæ–¹æ³•... } // âŒ é¿å…ï¼šéæ–¼ç°¡å–®æˆ–ä¸æ¸…æ¥šçš„åˆ—èˆ‰ public enum Status { A, B, C, D // ä¸æ¸…æ¥šçš„å«ç¾© } 2. ç‰ˆæœ¬ç®¡ç†ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // æ”¯æ´å‘å¾Œç›¸å®¹çš„ Enum è¨­è¨ˆ public enum OrderStatus implements CodedEnum { // æ–°ç‰ˆæœ¬å¯ä»¥å®‰å…¨æ·»åŠ æ–°ç‹€æ…‹ PENDING(\u0026#34;PND\u0026#34;, \u0026#34;å¾…è™•ç†\u0026#34;), CONFIRMED(\u0026#34;CNF\u0026#34;, \u0026#34;å·²ç¢ºèª\u0026#34;), SHIPPED(\u0026#34;SHP\u0026#34;, \u0026#34;å·²å‡ºè²¨\u0026#34;), DELIVERED(\u0026#34;DLV\u0026#34;, \u0026#34;å·²é€é”\u0026#34;), CANCELLED(\u0026#34;CXL\u0026#34;, \u0026#34;å·²å–æ¶ˆ\u0026#34;), // æ–°å¢ç‹€æ…‹ï¼ˆå‘å¾Œç›¸å®¹ï¼‰ PARTIAL_SHIPPED(\u0026#34;PSH\u0026#34;, \u0026#34;éƒ¨åˆ†å‡ºè²¨\u0026#34;), // v2.0 æ–°å¢ RETURNED(\u0026#34;RET\u0026#34;, \u0026#34;å·²é€€è²¨\u0026#34;); // v2.1 æ–°å¢ // è™•ç†æœªçŸ¥ç‹€æ…‹çš„å®‰å…¨æ©Ÿåˆ¶ public static OrderStatus fromCodeSafely(String code, OrderStatus defaultValue) { try { return fromCode(code); } catch (IllegalArgumentException e) { logger.warn(\u0026#34;é‡åˆ°æœªçŸ¥çš„è¨‚å–®ç‹€æ…‹ä»£ç¢¼: {}, ä½¿ç”¨é è¨­å€¼: {}\u0026#34;, code, defaultValue); return defaultValue; } } } 3. åœ‹éš›åŒ–æ”¯æ´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Component public class OrderStatusI18nService { @Autowired private MessageSource messageSource; public String getLocalizedDescription(OrderStatus status, Locale locale) { String key = \u0026#34;order.status.\u0026#34; + status.name().toLowerCase(); return messageSource.getMessage(key, null, status.getDescription(), locale); } public Map\u0026lt;OrderStatus, String\u0026gt; getAllLocalizedStatuses(Locale locale) { return Arrays.stream(OrderStatus.values()) .collect(Collectors.toMap( status -\u0026gt; status, status -\u0026gt; getLocalizedDescription(status, locale) )); } } ç›£æ§èˆ‡ç¶­è­· 1. ç‹€æ…‹åˆ†ä½ˆç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Component public class OrderStatusMetrics { private final MeterRegistry meterRegistry; private final OrderRepository orderRepository; public OrderStatusMetrics(MeterRegistry meterRegistry, OrderRepository orderRepository) { this.meterRegistry = meterRegistry; this.orderRepository = orderRepository; // è¨»å†Šåº¦é‡ Gauge.builder(\u0026#34;orders.by.status\u0026#34;) .description(\u0026#34;è¨‚å–®ç‹€æ…‹åˆ†ä½ˆ\u0026#34;) .tag(\u0026#34;status\u0026#34;, \u0026#34;all\u0026#34;) .register(meterRegistry, this, OrderStatusMetrics::getTotalOrderCount); } @EventListener public void handleOrderStatusChanged(OrderStatusChangedEvent event) { // è¨˜éŒ„ç‹€æ…‹è½‰æ›æ¬¡æ•¸ Counter.builder(\u0026#34;order.status.transitions\u0026#34;) .description(\u0026#34;è¨‚å–®ç‹€æ…‹è½‰æ›æ¬¡æ•¸\u0026#34;) .tag(\u0026#34;from\u0026#34;, event.getOldStatus().getCode()) .tag(\u0026#34;to\u0026#34;, event.getNewStatus().getCode()) .register(meterRegistry) .increment(); } private double getTotalOrderCount() { return orderRepository.count(); } } 2. æ•ˆèƒ½ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Aspect @Component public class OrderStatusPerformanceAspect { @Around(\u0026#34;execution(* com.example.service.OrderService.updateOrderStatus(..))\u0026#34;) public Object measureStatusUpdate(ProceedingJoinPoint joinPoint) throws Throwable { Timer.Sample sample = Timer.start(meterRegistry); try { return joinPoint.proceed(); } finally { sample.stop(Timer.builder(\u0026#34;order.status.update.duration\u0026#34;) .description(\u0026#34;è¨‚å–®ç‹€æ…‹æ›´æ–°è€—æ™‚\u0026#34;) .register(meterRegistry)); } } } ç¸½çµ JPA ä¸­çš„ Enum è™•ç†æ˜¯ä¼æ¥­ç´šæ‡‰ç”¨ç¨‹å¼é–‹ç™¼çš„é‡è¦æŠ€èƒ½ã€‚é€éæœ¬æ–‡çš„æ·±å…¥æ¢è¨ï¼Œæˆ‘å€‘äº†è§£åˆ°ï¼š\næ ¸å¿ƒè¦é» é¸æ“‡é©ç•¶çš„æ˜ å°„ç­–ç•¥ï¼šç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ EnumType.STRING æˆ–è‡ªè¨‚è½‰æ›å™¨ è¨­è¨ˆå¯æ“´å±•çš„ Enumï¼šè€ƒæ…®æœªä¾†éœ€æ±‚ï¼Œæ”¯æ´ç‹€æ…‹è½‰æ›é‚è¼¯ æ•ˆèƒ½å„ªåŒ–ï¼šåˆç†ä½¿ç”¨ç´¢å¼•ã€å¿«å–å’ŒæŸ¥è©¢å„ªåŒ– æ¸¬è©¦å®Œæ•´æ€§ï¼šæ¶µè“‹ç‹€æ…‹è½‰æ›é‚è¼¯å’ŒæŒä¹…åŒ–æ¸¬è©¦ ç›£æ§ç¶­è­·ï¼šå»ºç«‹é©ç•¶çš„ç›£æ§æ©Ÿåˆ¶ å¯¦éš›æ‡‰ç”¨å»ºè­° å°æ–¼ç°¡å–®ç‹€æ…‹ï¼Œä½¿ç”¨åŸºæœ¬çš„ @Enumerated(EnumType.STRING) å°æ–¼è¤‡é›œæ¥­å‹™é‚è¼¯ï¼Œå¯¦ä½œ CodedEnum ä»‹é¢å’Œè‡ªè¨‚è½‰æ›å™¨ å»ºç«‹ç‹€æ…‹è½‰æ›è¦å‰‡å’Œæ­·å²è¿½è¹¤æ©Ÿåˆ¶ è€ƒæ…®åœ‹éš›åŒ–å’Œå‘å¾Œç›¸å®¹æ€§ å¯¦æ–½é©ç•¶çš„ç›£æ§å’Œæ•ˆèƒ½å„ªåŒ–ç­–ç•¥ æ­£ç¢ºè™•ç† Enum å‹åˆ¥ä¸åƒ…èƒ½æå‡ç¨‹å¼ç¢¼çš„å¯è®€æ€§å’Œç¶­è­·æ€§ï¼Œé‚„èƒ½ç¢ºä¿è³‡æ–™çš„ä¸€è‡´æ€§å’Œæ¥­å‹™é‚è¼¯çš„æ­£ç¢ºåŸ·è¡Œã€‚\nåƒè€ƒè³‡æ–™ JPA 2.2 Specification Hibernate ORM Documentation Spring Data JPA Reference Java Enum Best Practices Database Design Patterns ","permalink":"https://xinqilin.github.io/post/backend/ormenumtype/","tags":["Java","JPA","Hibernate","Enum","ORM","Database","Spring","MySQL"],"title":"JPA Enum å‹åˆ¥è™•ç†å®Œæ•´æŒ‡å—ï¼šæ˜ å°„ç­–ç•¥èˆ‡æœ€ä½³å¯¦è¸"},{"content":"æ¦‚è¿° xargsï¼ˆeXtended ARGumentsï¼‰æ˜¯ Unix/Linux ç³»çµ±ä¸­çš„å¼·å¤§å·¥å…·ï¼Œç”¨æ–¼å¾æ¨™æº–è¼¸å…¥è®€å–è³‡æ–™ä¸¦å°‡å…¶ä½œç‚ºåƒæ•¸å‚³éçµ¦å…¶ä»–å‘½ä»¤ã€‚å®ƒè§£æ±ºäº†å‘½ä»¤è¡Œåƒæ•¸é•·åº¦é™åˆ¶çš„å•é¡Œï¼Œä¸¦æä¾›äº†ä¸¦è¡Œè™•ç†èƒ½åŠ›ï¼Œæ˜¯ç®¡é“æ“ä½œå’Œæ‰¹æ¬¡è™•ç†çš„é‡è¦å·¥å…·ã€‚\næ ¸å¿ƒç‰¹å¾µ åƒæ•¸è½‰æ›ï¼šå°‡è¼¸å…¥æµè½‰æ›ç‚ºå‘½ä»¤åƒæ•¸ æ‰¹æ¬¡è™•ç†ï¼šæ”¯æ´åˆ†æ‰¹åŸ·è¡Œå¤§é‡æ“ä½œ ä¸¦è¡ŒåŸ·è¡Œï¼šå¯åŒæ™‚åŸ·è¡Œå¤šå€‹ç¨‹åºæå‡æ•ˆç‡ å®‰å…¨è™•ç†ï¼šæ­£ç¢ºè™•ç†åŒ…å«ç©ºæ ¼çš„æª”æ¡ˆåç¨± éˆæ´»æ§åˆ¶ï¼šè±å¯Œçš„é¸é …æ§åˆ¶åŸ·è¡Œè¡Œç‚º åŸºæœ¬èªæ³• 1 xargs [é¸é …] [å‘½ä»¤ [åˆå§‹åƒæ•¸]] å·¥ä½œåŸç† 1 2 3 4 5 # åŸºæœ¬æ¦‚å¿µ command1 | xargs command2 # ç­‰åŒæ–¼ command2 arg1 arg2 arg3 ... ç°¡å–®ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 # é è¨­è¡Œç‚ºï¼ˆä½¿ç”¨ echoï¼‰ echo \u0026#34;a b c d\u0026#34; | xargs # è¼¸å‡º: a b c d # æŒ‡å®šå‘½ä»¤ echo \u0026#34;file1 file2 file3\u0026#34; | xargs ls -l # å¾æª”æ¡ˆè®€å– cat filelist.txt | xargs rm -f # èˆ‡ find çµ„åˆ find . -name \u0026#34;*.tmp\u0026#34; | xargs rm -f æ ¸å¿ƒé¸é …è©³è§£ åŸºæœ¬æ§åˆ¶é¸é … 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # -t (--verbose) - é¡¯ç¤ºåŸ·è¡Œçš„å‘½ä»¤ echo \u0026#34;a b c\u0026#34; | xargs -t rm # è¼¸å‡º: rm a b c # ç„¶å¾ŒåŸ·è¡Œ rm a b c # -p (--interactive) - äº¤äº’å¼ç¢ºèª echo \u0026#34;file1 file2\u0026#34; | xargs -p rm # è¼¸å‡º: rm file1 file2?... # ç­‰å¾…ä½¿ç”¨è€…è¼¸å…¥ y/n # -r (--no-run-if-empty) - ç©ºè¼¸å…¥æ™‚ä¸åŸ·è¡Œ echo \u0026#34;\u0026#34; | xargs -r echo \u0026#34;åŸ·è¡Œäº†\u0026#34; # ä¸æœƒåŸ·è¡Œ echo \u0026#34;\u0026#34; | xargs echo \u0026#34;åŸ·è¡Œäº†\u0026#34; # æœƒåŸ·è¡Œ # --help - é¡¯ç¤ºå¹«åŠ©è³‡è¨Š xargs --help åƒæ•¸åˆ†çµ„é¸é … 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # -n max-args - é™åˆ¶æ¯æ¬¡åŸ·è¡Œçš„åƒæ•¸æ•¸é‡ echo \u0026#34;1 2 3 4 5 6\u0026#34; | xargs -n 2 echo # è¼¸å‡º: # 1 2 # 3 4 # 5 6 # -L max-lines - é™åˆ¶æ¯æ¬¡è™•ç†çš„è¡Œæ•¸ printf \u0026#34;a\\nb\\nc\\nd\\n\u0026#34; | xargs -L 2 echo # è¼¸å‡º: # a b # c d # -s max-chars - é™åˆ¶å‘½ä»¤è¡Œé•·åº¦ echo \u0026#34;very long arguments here\u0026#34; | xargs -s 20 echo åˆ†éš”ç¬¦è™•ç† 1 2 3 4 5 6 7 8 9 # -d delimiter - è‡ªè¨‚åˆ†éš”ç¬¦ echo \u0026#34;a,b,c,d\u0026#34; | xargs -d, echo # è¼¸å‡º: a b c d # -0 (--null) - ä½¿ç”¨ null å­—å…ƒä½œåˆ†éš”ç¬¦ find . -name \u0026#34;*.txt\u0026#34; -print0 | xargs -0 ls -l # è™•ç†åŒ…å«ç©ºæ ¼çš„æª”æ¡ˆå echo -e \u0026#34;file 1.txt\\nfile 2.txt\u0026#34; | xargs -d\u0026#39;\\n\u0026#39; ls -l æ›¿æ›å­—ä¸²é¸é … 1 2 3 4 5 6 7 8 # -I replace-str - æŒ‡å®šæ›¿æ›å­—ä¸² echo \u0026#34;file1 file2 file3\u0026#34; | xargs -I {} cp {} {}.backup # -i æˆ– -I{} - ä½¿ç”¨ {} ä½œç‚ºæ›¿æ›å­—ä¸² ls *.txt | xargs -I{} cp {} backup/{} # è¤‡é›œæ›¿æ›ç¯„ä¾‹ find . -name \u0026#34;*.log\u0026#34; | xargs -I{} sh -c \u0026#39;echo \u0026#34;Processing: {}\u0026#34;; gzip {}\u0026#39; ä¸¦è¡Œè™•ç†é¸é … 1 2 3 4 5 6 7 8 9 # -P max-procs - ä¸¦è¡ŒåŸ·è¡Œ echo \u0026#34;1 2 3 4 5\u0026#34; | xargs -n 1 -P 3 sleep # åŒæ™‚åŸ·è¡Œæœ€å¤š 3 å€‹ sleep å‘½ä»¤ # -P 0 - ç„¡é™åˆ¶ä¸¦è¡Œ seq 1 10 | xargs -n 1 -P 0 echo # å¯¦éš›ä¸¦è¡Œç¯„ä¾‹ find . -name \u0026#34;*.jpg\u0026#34; | xargs -n 1 -P 4 -I{} convert {} {}.thumb.jpg å¯¦æˆ°æ‡‰ç”¨å ´æ™¯ 1. æª”æ¡ˆç®¡ç†æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # æ‰¹æ¬¡åˆªé™¤æª”æ¡ˆ find /tmp -name \u0026#34;*.tmp\u0026#34; -mtime +7 | xargs rm -f # æ‰¹æ¬¡è¤‡è£½æª”æ¡ˆ ls *.txt | xargs -I{} cp {} backup/ # æ‰¹æ¬¡ç§»å‹•æª”æ¡ˆ find . -name \u0026#34;*.old\u0026#34; | xargs -I{} mv {} archive/ # æ‰¹æ¬¡é‡å‘½å ls *.jpeg | xargs -I{} sh -c \u0026#39;mv \u0026#34;$1\u0026#34; \u0026#34;${1%.jpeg}.jpg\u0026#34;\u0026#39; _ {} # å»ºç«‹å¤šå€‹ç›®éŒ„ echo \u0026#34;dir1 dir2 dir3\u0026#34; | xargs mkdir -p # ä¿®æ”¹æª”æ¡ˆæ¬Šé™ find /var/www -name \u0026#34;*.php\u0026#34; | xargs chmod 644 find /var/www -type d | xargs chmod 755 # æ‰¹æ¬¡å£“ç¸®æª”æ¡ˆ find . -name \u0026#34;*.log\u0026#34; -size +100M | xargs -I{} gzip {} 2. æ–‡æœ¬è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # æ‰¹æ¬¡æœå°‹æ–‡æœ¬ find . -name \u0026#34;*.txt\u0026#34; | xargs grep -l \u0026#34;pattern\u0026#34; # æ‰¹æ¬¡æ›¿æ›æ–‡æœ¬ find . -name \u0026#34;*.conf\u0026#34; | xargs sed -i \u0026#39;s/old/new/g\u0026#39; # çµ±è¨ˆè¡Œæ•¸ find . -name \u0026#34;*.py\u0026#34; | xargs wc -l # æ‰¹æ¬¡ç·¨ç¢¼è½‰æ› find . -name \u0026#34;*.txt\u0026#34; | xargs -I{} iconv -f gbk -t utf8 {} -o {}.utf8 # æ‰¹æ¬¡æ ¼å¼åŒ–ç¨‹å¼ç¢¼ find . -name \u0026#34;*.js\u0026#34; | xargs prettier --write # æ‰¹æ¬¡æª¢æŸ¥èªæ³• find . -name \u0026#34;*.sh\u0026#34; | xargs -I{} bash -n {} 3. ç³»çµ±ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # æ‰¹æ¬¡æ®ºæ­»ç¨‹åº ps aux | grep \u0026#34;process_name\u0026#34; | awk \u0026#39;{print $2}\u0026#39; | xargs kill # æ‰¹æ¬¡æœå‹™é‡å•Ÿ echo \u0026#34;nginx apache2 mysql\u0026#34; | xargs -n 1 systemctl restart # æ‰¹æ¬¡å®‰è£è»Ÿé«”åŒ… cat package_list.txt | xargs apt-get install -y # ç£ç¢Ÿä½¿ç”¨çµ±è¨ˆ find /var/log -name \u0026#34;*.log\u0026#34; | xargs du -sh # æ‰¹æ¬¡ä¸‹è¼‰æª”æ¡ˆ cat urls.txt | xargs -n 1 -P 5 wget # æ‰¹æ¬¡å‚™ä»½ echo \u0026#34;/etc /var/log /home\u0026#34; | xargs -I{} tar -czf {//}.tar.gz {} 4. é–‹ç™¼èˆ‡éƒ¨ç½² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # æ‰¹æ¬¡ç·¨è­¯ find . -name \u0026#34;*.c\u0026#34; | xargs gcc -o output # æ‰¹æ¬¡æ¸¬è©¦ find . -name \u0026#34;*_test.py\u0026#34; | xargs -I{} python {} # æ‰¹æ¬¡éƒ¨ç½² cat server_list.txt | xargs -I{} scp deploy.sh user@{}:/tmp/ # æ‰¹æ¬¡åŸ·è¡Œé ç¨‹å‘½ä»¤ cat servers.txt | xargs -I{} ssh {} \u0026#34;uptime\u0026#34; # æ‰¹æ¬¡ Git æ“ä½œ find . -name \u0026#34;.git\u0026#34; -type d | xargs -I{} sh -c \u0026#39;cd {} \u0026amp;\u0026amp; git pull\u0026#39; # æ‰¹æ¬¡å»ºæ§‹ Docker æ˜ åƒ ls */Dockerfile | xargs -I{} sh -c \u0026#39;cd $(dirname {}) \u0026amp;\u0026amp; docker build -t $(basename $(pwd)) .\u0026#39; 5. ç›£æ§èˆ‡æ—¥èªŒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æ‰¹æ¬¡ç›£æ§æª”æ¡ˆè®ŠåŒ– find /var/log -name \u0026#34;*.log\u0026#34; | xargs -I{} tail -f {} # æ‰¹æ¬¡æ—¥èªŒåˆ†æ find . -name \u0026#34;access.log*\u0026#34; | xargs zcat | grep \u0026#34;ERROR\u0026#34; # æ‰¹æ¬¡æ¸…ç†æ—¥èªŒ find /var/log -name \u0026#34;*.log\u0026#34; -size +100M | xargs truncate -s 0 # ç³»çµ±è³‡è¨Šæ”¶é›† echo \u0026#34;/proc/cpuinfo /proc/meminfo /proc/loadavg\u0026#34; | xargs -I{} sh -c \u0026#39;echo \u0026#34;=== {} ===\u0026#34;; cat {}\u0026#39; # æ‰¹æ¬¡æª¢æŸ¥æœå‹™ç‹€æ…‹ echo \u0026#34;nginx mysql redis\u0026#34; | xargs -I{} systemctl status {} é€²éšæŠ€å·§ 1. è¤‡é›œå‘½ä»¤çµ„åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # å¤šå‘½ä»¤åŸ·è¡Œ find . -name \u0026#34;*.log\u0026#34; | xargs -I{} sh -c \u0026#39;echo \u0026#34;Processing {}\u0026#34;; wc -l {}; echo \u0026#34;Done\u0026#34;\u0026#39; # æ¢ä»¶åŸ·è¡Œ find . -name \u0026#34;*.txt\u0026#34; | xargs -I{} sh -c \u0026#39;if [ -s \u0026#34;{}\u0026#34; ]; then echo \u0026#34;Non-empty: {}\u0026#34;; fi\u0026#39; # éŒ¯èª¤è™•ç† find . -name \u0026#34;*.sh\u0026#34; | xargs -I{} sh -c \u0026#39;bash -n \u0026#34;{}\u0026#34; || echo \u0026#34;Syntax error in {}\u0026#34;\u0026#39; # çµæœæ”¶é›† find . -name \u0026#34;*.py\u0026#34; | xargs -I{} sh -c \u0026#39;echo \u0026#34;{}: $(wc -l \u0026lt; \u0026#34;{}\u0026#34;)\u0026#34;\u0026#39; | sort -k2 -nr # ç®¡é“çµ„åˆ find . -name \u0026#34;*.log\u0026#34; | xargs -I{} sh -c \u0026#39;cat \u0026#34;{}\u0026#34; | grep ERROR | wc -l\u0026#39; | awk \u0026#39;{sum+=$1} END {print sum}\u0026#39; 2. ä¸¦è¡Œè™•ç†æœ€ä½³åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # CPU å¯†é›†å‹ä»»å‹™ seq 1 100 | xargs -n 1 -P $(nproc) sh -c \u0026#39;echo \u0026#34;Processing $1\u0026#34;; sleep 1; echo \u0026#34;Done $1\u0026#34;\u0026#39; _ # I/O å¯†é›†å‹ä»»å‹™ cat urls.txt | xargs -n 1 -P 10 -I{} sh -c \u0026#39;echo \u0026#34;Downloading {}\u0026#34;; wget -q {}\u0026#39; # è¨˜æ†¶é«”ç®¡ç† find . -name \u0026#34;*.big\u0026#34; | xargs -n 1 -P 2 -I{} process_large_file {} # ä¸¦è¡Œæ—¥èªŒè™•ç† find /var/log -name \u0026#34;*.log\u0026#34; | xargs -n 1 -P 4 -I{} sh -c \u0026#39;gzip \u0026#34;{}\u0026#34; \u0026amp;\u0026amp; echo \u0026#34;Compressed {}\u0026#34;\u0026#39; # è² è¼‰å‡è¡¡ seq 1 1000 | xargs -n 10 -P 8 -I{} process_batch {} 3. å®‰å…¨æ€§è€ƒæ…® 1 2 3 4 5 6 7 8 9 10 11 # è™•ç†ç‰¹æ®Šå­—å…ƒ find . -name \u0026#34;*.txt\u0026#34; -print0 | xargs -0 ls -l # é¿å…å‘½ä»¤æ³¨å…¥ echo \u0026#34;file; rm -rf /\u0026#34; | xargs -I{} sh -c \u0026#39;ls \u0026#34;$1\u0026#34;\u0026#39; _ {} # åƒæ•¸é©—è­‰ cat files.txt | xargs -I{} sh -c \u0026#39;if [ -f \u0026#34;$1\u0026#34; ]; then process \u0026#34;$1\u0026#34;; fi\u0026#39; _ {} # è·¯å¾‘å®‰å…¨ find . -name \u0026#34;*.conf\u0026#34; | xargs -I{} sh -c \u0026#39;realpath \u0026#34;$1\u0026#34; | grep \u0026#34;^/safe/path\u0026#34; \u0026amp;\u0026amp; process \u0026#34;$1\u0026#34;\u0026#39; _ {} 4. æ•ˆèƒ½å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 # æ‰¹æ¬¡å¤§å°å„ªåŒ– find . -name \u0026#34;*.txt\u0026#34; | xargs -n 100 process_files # è¨˜æ†¶é«”é™åˆ¶ find . -name \u0026#34;*.log\u0026#34; | xargs -s 4096 process_with_memory_limit # ä¸¦è¡Œæ•¸èª¿æ•´ find . -name \u0026#34;*.jpg\u0026#34; | xargs -n 1 -P $(nproc) optimize_image # ç·©è¡å€å„ªåŒ– find . -name \u0026#34;*.data\u0026#34; | xargs -n 50 -P 4 process_data_batch éŒ¯èª¤è™•ç†èˆ‡é™¤éŒ¯ 1. å¸¸è¦‹å•é¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # å•é¡Œï¼šåƒæ•¸éé•· # è§£æ±ºï¼šä½¿ç”¨ -s é™åˆ¶æˆ–åˆ†æ‰¹è™•ç† find . -name \u0026#34;*.txt\u0026#34; | xargs -s 1000 rm # å•é¡Œï¼šæª”æ¡ˆååŒ…å«ç©ºæ ¼ # è§£æ±ºï¼šä½¿ç”¨ -0 å’Œ -print0 find . -name \u0026#34;*.txt\u0026#34; -print0 | xargs -0 rm # å•é¡Œï¼šç©ºè¼¸å…¥åŸ·è¡Œ # è§£æ±ºï¼šä½¿ç”¨ -r é¸é … echo \u0026#34;\u0026#34; | xargs -r echo \u0026#34;ä¸æœƒåŸ·è¡Œ\u0026#34; # å•é¡Œï¼šä¸¦è¡Œç«¶çˆ­ # è§£æ±ºï¼šä½¿ç”¨é©ç•¶çš„é–æ©Ÿåˆ¶ find . -name \u0026#34;*.log\u0026#34; | xargs -n 1 -P 4 -I{} flock /tmp/lock process {} 2. é™¤éŒ¯æŠ€å·§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # ä½¿ç”¨ -t æŸ¥çœ‹åŸ·è¡Œå‘½ä»¤ find . -name \u0026#34;*.txt\u0026#34; | xargs -t rm # ä½¿ç”¨ -p äº¤äº’å¼ç¢ºèª find . -name \u0026#34;*.tmp\u0026#34; | xargs -p rm # é€æ­¥æ¸¬è©¦ echo \u0026#34;test1 test2\u0026#34; | xargs -n 1 echo # æª¢æŸ¥åƒæ•¸ find . -name \u0026#34;*.txt\u0026#34; | xargs -I{} echo \u0026#34;Will process: {}\u0026#34; # éŒ¯èª¤æ—¥èªŒ find . -name \u0026#34;*.sh\u0026#34; | xargs -I{} sh -c \u0026#39;bash -n \u0026#34;{}\u0026#34; 2\u0026gt;\u0026gt;error.log || echo \u0026#34;Error in {}\u0026#34;\u0026#39; 3. æ•ˆèƒ½ç›£æ§ 1 2 3 4 5 6 7 8 9 # åŸ·è¡Œæ™‚é–“æ¸¬é‡ time find . -name \u0026#34;*.txt\u0026#34; | xargs wc -l # ä¸¦è¡Œæ•ˆèƒ½æ¯”è¼ƒ time seq 1 100 | xargs -n 1 sleep 0.1 # ä¸²è¡Œ time seq 1 100 | xargs -n 1 -P 10 sleep 0.1 # ä¸¦è¡Œ # è³‡æºä½¿ç”¨ç›£æ§ find . -name \u0026#34;*.big\u0026#34; | xargs -n 1 -P 4 -I{} sh -c \u0026#39;echo \u0026#34;Processing {}\u0026#34;; /usr/bin/time -v process {}\u0026#39; èˆ‡å…¶ä»–å·¥å…·æ•´åˆ 1. èˆ‡ find çµ„åˆ 1 2 3 4 5 6 7 8 9 10 11 # åŸºæœ¬çµ„åˆ find /path -name \u0026#34;pattern\u0026#34; | xargs command # å®‰å…¨è™•ç† find /path -name \u0026#34;pattern\u0026#34; -print0 | xargs -0 command # æ¢ä»¶éæ¿¾ find /path -name \u0026#34;*.txt\u0026#34; -size +1M | xargs -I{} sh -c \u0026#39;echo \u0026#34;Large file: {}\u0026#34;\u0026#39; # è¤‡é›œæœå°‹ find /path -type f -mtime -7 \\( -name \u0026#34;*.log\u0026#34; -o -name \u0026#34;*.txt\u0026#34; \\) | xargs grep \u0026#34;pattern\u0026#34; 2. èˆ‡ grep çµ„åˆ 1 2 3 4 5 6 7 8 9 10 11 # æª”æ¡ˆå…§å®¹æœå°‹ find . -name \u0026#34;*.py\u0026#34; | xargs grep -l \u0026#34;import numpy\u0026#34; # å¤šæ¨¡å¼æœå°‹ find . -name \u0026#34;*.conf\u0026#34; | xargs grep -E \u0026#34;(error|warning|critical)\u0026#34; # çµ±è¨ˆåŒ¹é… find . -name \u0026#34;*.log\u0026#34; | xargs grep \u0026#34;ERROR\u0026#34; | wc -l # çµæœè™•ç† find . -name \u0026#34;*.txt\u0026#34; | xargs grep -H \u0026#34;pattern\u0026#34; | cut -d: -f1 | sort | uniq 3. èˆ‡ ssh çµ„åˆ 1 2 3 4 5 6 7 8 9 10 11 # é ç¨‹ä¸¦è¡ŒåŸ·è¡Œ cat servers.txt | xargs -n 1 -P 5 -I{} ssh {} \u0026#34;command\u0026#34; # æ‰¹æ¬¡æª”æ¡ˆå‚³è¼¸ cat servers.txt | xargs -I{} scp file.txt user@{}:/tmp/ # é ç¨‹ç›£æ§ cat servers.txt | xargs -I{} ssh {} \u0026#34;uptime; df -h\u0026#34; # åˆ†å¸ƒå¼è™•ç† cat servers.txt | xargs -n 1 -P 10 -I{} ssh {} \u0026#34;process_data input.txt\u0026#34; å¯¦ç”¨è…³æœ¬ç¯„ä¾‹ 1. æ‰¹æ¬¡æª”æ¡ˆè™•ç†è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 #!/bin/bash # batch_process.sh - æ‰¹æ¬¡è™•ç†æª”æ¡ˆ SCRIPT_DIR=\u0026#34;$(cd \u0026#34;$(dirname \u0026#34;${BASH_SOURCE[0]}\u0026#34;)\u0026#34; \u0026amp;\u0026amp; pwd)\u0026#34; INPUT_DIR=\u0026#34;${1:-./input}\u0026#34; OUTPUT_DIR=\u0026#34;${2:-./output}\u0026#34; MAX_PARALLEL=\u0026#34;${3:-4}\u0026#34; # å»ºç«‹è¼¸å‡ºç›®éŒ„ mkdir -p \u0026#34;$OUTPUT_DIR\u0026#34; # æ‰¹æ¬¡è™•ç† find \u0026#34;$INPUT_DIR\u0026#34; -name \u0026#34;*.txt\u0026#34; -print0 | \\ xargs -0 -n 1 -P \u0026#34;$MAX_PARALLEL\u0026#34; -I{} \\ sh -c \u0026#39; input_file=\u0026#34;$1\u0026#34; output_file=\u0026#34;\u0026#39;\u0026#34;$OUTPUT_DIR\u0026#34;\u0026#39;/$(basename \u0026#34;$1\u0026#34; .txt).processed.txt\u0026#34; echo \u0026#34;Processing: $input_file\u0026#34; # è™•ç†é‚è¼¯ sed \u0026#34;s/old/new/g\u0026#34; \u0026#34;$input_file\u0026#34; \u0026gt; \u0026#34;$output_file\u0026#34; echo \u0026#34;Completed: $output_file\u0026#34; \u0026#39; _ {} echo \u0026#34;æ‰¹æ¬¡è™•ç†å®Œæˆ\u0026#34; 2. ç³»çµ±æ¸…ç†è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 #!/bin/bash # system_cleanup.sh - ç³»çµ±æ¸…ç†è…³æœ¬ LOG_FILE=\u0026#34;/var/log/cleanup.log\u0026#34; DRY_RUN=\u0026#34;${1:-false}\u0026#34; log() { echo \u0026#34;$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) - $1\u0026#34; | tee -a \u0026#34;$LOG_FILE\u0026#34; } cleanup_logs() { log \u0026#34;é–‹å§‹æ¸…ç†æ—¥èªŒæª”æ¡ˆ\u0026#34; if [ \u0026#34;$DRY_RUN\u0026#34; = \u0026#34;true\u0026#34; ]; then find /var/log -name \u0026#34;*.log\u0026#34; -size +100M | xargs -I{} echo \u0026#34;Will compress: {}\u0026#34; else find /var/log -name \u0026#34;*.log\u0026#34; -size +100M | \\ xargs -n 1 -P 4 -I{} sh -c \u0026#39;gzip \u0026#34;$1\u0026#34; \u0026amp;\u0026amp; echo \u0026#34;Compressed: $1\u0026#34;\u0026#39; _ {} | \\ tee -a \u0026#34;$LOG_FILE\u0026#34; fi } cleanup_temp() { log \u0026#34;é–‹å§‹æ¸…ç†è‡¨æ™‚æª”æ¡ˆ\u0026#34; if [ \u0026#34;$DRY_RUN\u0026#34; = \u0026#34;true\u0026#34; ]; then find /tmp -type f -mtime +7 | xargs -I{} echo \u0026#34;Will remove: {}\u0026#34; else find /tmp -type f -mtime +7 | \\ xargs -r rm -f fi } cleanup_cache() { log \u0026#34;é–‹å§‹æ¸…ç†å¿«å–æª”æ¡ˆ\u0026#34; if [ \u0026#34;$DRY_RUN\u0026#34; = \u0026#34;true\u0026#34; ]; then find /var/cache -name \u0026#34;*.cache\u0026#34; -mtime +30 | xargs -I{} echo \u0026#34;Will remove: {}\u0026#34; else find /var/cache -name \u0026#34;*.cache\u0026#34; -mtime +30 | \\ xargs -r rm -f fi } # ä¸»åŸ·è¡Œ log \u0026#34;é–‹å§‹ç³»çµ±æ¸…ç† (DRY_RUN: $DRY_RUN)\u0026#34; cleanup_logs cleanup_temp cleanup_cache log \u0026#34;ç³»çµ±æ¸…ç†å®Œæˆ\u0026#34; 3. ä¸¦è¡Œä¸‹è¼‰è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 #!/bin/bash # parallel_download.sh - ä¸¦è¡Œä¸‹è¼‰è…³æœ¬ URL_FILE=\u0026#34;${1:-urls.txt}\u0026#34; DOWNLOAD_DIR=\u0026#34;${2:-./downloads}\u0026#34; MAX_PARALLEL=\u0026#34;${3:-5}\u0026#34; TIMEOUT=\u0026#34;${4:-30}\u0026#34; # æª¢æŸ¥è¼¸å…¥æª”æ¡ˆ if [ ! -f \u0026#34;$URL_FILE\u0026#34; ]; then echo \u0026#34;éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° URL æª”æ¡ˆ $URL_FILE\u0026#34; exit 1 fi # å»ºç«‹ä¸‹è¼‰ç›®éŒ„ mkdir -p \u0026#34;$DOWNLOAD_DIR\u0026#34; # ä¸¦è¡Œä¸‹è¼‰ cat \u0026#34;$URL_FILE\u0026#34; | \\ xargs -n 1 -P \u0026#34;$MAX_PARALLEL\u0026#34; -I{} \\ sh -c \u0026#39; url=\u0026#34;$1\u0026#34; dir=\u0026#34;$2\u0026#34; timeout=\u0026#34;$3\u0026#34; filename=$(basename \u0026#34;$url\u0026#34;) output_path=\u0026#34;$dir/$filename\u0026#34; echo \u0026#34;é–‹å§‹ä¸‹è¼‰: $url\u0026#34; if timeout \u0026#34;$timeout\u0026#34; wget -q -O \u0026#34;$output_path\u0026#34; \u0026#34;$url\u0026#34;; then echo \u0026#34;ä¸‹è¼‰æˆåŠŸ: $filename\u0026#34; else echo \u0026#34;ä¸‹è¼‰å¤±æ•—: $url\u0026#34; rm -f \u0026#34;$output_path\u0026#34; fi \u0026#39; _ {} \u0026#34;$DOWNLOAD_DIR\u0026#34; \u0026#34;$TIMEOUT\u0026#34; echo \u0026#34;ä¸‹è¼‰ä»»å‹™å®Œæˆ\u0026#34; # çµ±è¨ˆçµæœ total_files=$(wc -l \u0026lt; \u0026#34;$URL_FILE\u0026#34;) downloaded_files=$(find \u0026#34;$DOWNLOAD_DIR\u0026#34; -type f | wc -l) echo \u0026#34;ç¸½è¨ˆ: $total_files å€‹æª”æ¡ˆï¼ŒæˆåŠŸä¸‹è¼‰: $downloaded_files å€‹æª”æ¡ˆ\u0026#34; æ•ˆèƒ½æœ€ä½³åŒ– 1. ä¸¦è¡Œåº¦èª¿æ•´ 1 2 3 4 5 6 7 8 9 10 11 # CPU ç¶å®šä»»å‹™ CPU_CORES=$(nproc) find . -name \u0026#34;*.c\u0026#34; | xargs -n 1 -P \u0026#34;$CPU_CORES\u0026#34; gcc -c # I/O ç¶å®šä»»å‹™ IO_PARALLEL=$(($(nproc) * 2)) cat urls.txt | xargs -n 1 -P \u0026#34;$IO_PARALLEL\u0026#34; wget # æ··åˆè² è¼‰ MIXED_PARALLEL=$(($(nproc) + 2)) find . -name \u0026#34;*.log\u0026#34; | xargs -n 1 -P \u0026#34;$MIXED_PARALLEL\u0026#34; process_log 2. è¨˜æ†¶é«”ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 # é™åˆ¶æ‰¹æ¬¡å¤§å° find . -name \u0026#34;*.big\u0026#34; | xargs -n 1 process_large_file # é™åˆ¶å‘½ä»¤è¡Œé•·åº¦ find . -name \u0026#34;*.txt\u0026#34; | xargs -s 4096 process_files # åˆ†æ®µè™•ç† find . -name \u0026#34;*.data\u0026#34; | split -l 1000 - batch_ for batch in batch_*; do cat \u0026#34;$batch\u0026#34; | xargs -n 10 -P 4 process_data done 3. ç¶²è·¯å„ªåŒ– 1 2 3 4 5 6 7 8 # é€£æ¥æ±  cat servers.txt | xargs -n 1 -P 10 -I{} ssh -o ControlMaster=auto -o ControlPath=/tmp/ssh-%r@%h:%p {} \u0026#34;command\u0026#34; # é‡è©¦æ©Ÿåˆ¶ cat urls.txt | xargs -n 1 -I{} sh -c \u0026#39;for i in {1..3}; do wget \u0026#34;{}\u0026#34; \u0026amp;\u0026amp; break; sleep 5; done\u0026#39; # é »å¯¬é™åˆ¶ cat large_files.txt | xargs -n 1 -P 2 -I{} rsync --bwlimit=1000 {} destination/ ç¸½çµ æ ¸å¿ƒå„ªå‹¢ åƒæ•¸è™•ç†ï¼šè§£æ±ºå‘½ä»¤è¡Œåƒæ•¸é•·åº¦é™åˆ¶ æ‰¹æ¬¡æ“ä½œï¼šé«˜æ•ˆè™•ç†å¤§é‡æª”æ¡ˆå’Œè³‡æ–™ ä¸¦è¡ŒåŸ·è¡Œï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸å¿ƒç³»çµ±è³‡æº ç®¡é“å‹å¥½ï¼šèˆ‡å…¶ä»– Unix å·¥å…·å®Œç¾æ•´åˆ éˆæ´»æ§åˆ¶ï¼šè±å¯Œçš„é¸é …æ»¿è¶³å„ç¨®éœ€æ±‚ æœ€ä½³å¯¦è¸ å®‰å…¨ç¬¬ä¸€ï¼šè™•ç†åŒ…å«ç©ºæ ¼çš„æª”æ¡ˆåä½¿ç”¨ -0 å’Œ -print0 é©ç•¶ä¸¦è¡Œï¼šæ ¹æ“šä»»å‹™é¡å‹èª¿æ•´ä¸¦è¡Œåº¦ éŒ¯èª¤è™•ç†ï¼šä½¿ç”¨ -r é¿å…ç©ºè¼¸å…¥åŸ·è¡Œ æ¸¬è©¦å…ˆè¡Œï¼šä½¿ç”¨ -t å’Œ -p é¸é …æ¸¬è©¦å‘½ä»¤ æ•ˆèƒ½ç›£æ§ï¼šæ¸¬é‡ä¸¦å„ªåŒ–æ‰¹æ¬¡å¤§å°å’Œä¸¦è¡Œåº¦ å¸¸ç”¨æ¨¡å¼è¨˜æ†¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åŸºæœ¬æ¨¡å¼ find . -name \u0026#34;pattern\u0026#34; | xargs command # å®‰å…¨æ¨¡å¼ find . -name \u0026#34;pattern\u0026#34; -print0 | xargs -0 command # ä¸¦è¡Œæ¨¡å¼ command | xargs -n 1 -P 4 process # æ›¿æ›æ¨¡å¼ echo \u0026#34;files\u0026#34; | xargs -I{} cp {} backup/{} # äº¤äº’æ¨¡å¼ find . -name \u0026#34;*.tmp\u0026#34; | xargs -p rm xargs æ˜¯å‘½ä»¤è¡Œæ‰¹æ¬¡è™•ç†å’Œä¸¦è¡ŒåŸ·è¡Œçš„ç‘å£«è»åˆ€ï¼ŒæŒæ¡å…¶æ ¸å¿ƒæ¦‚å¿µå’Œå¸¸ç”¨æŠ€å·§ï¼Œèƒ½å¤ å¤§å¹…æå‡ Linux ç³»çµ±ç®¡ç†å’Œè‡ªå‹•åŒ–ä»»å‹™çš„æ•ˆç‡ã€‚è¨˜ä½ï¼šåˆç†ä½¿ç”¨ä¸¦è¡Œè™•ç†èƒ½å¤ é¡¯è‘—æå‡æ•ˆèƒ½ï¼Œä½†è¦æ³¨æ„è³‡æºç®¡ç†å’ŒéŒ¯èª¤è™•ç†ã€‚\nåƒè€ƒè³‡æ–™ GNU Findutils Manual - xargs Linux man xargs Advanced Bash-Scripting Guide Unix Power Tools ","permalink":"https://xinqilin.github.io/post/tools/xargs/","tags":["Linux","Xargs","Command Line","Parallel Processing","Pipe","Shell","Unix"],"title":"Xargs å‘½ä»¤å®Œæ•´æŒ‡å—ï¼šLinux åƒæ•¸è™•ç†èˆ‡ä¸¦è¡ŒåŸ·è¡Œçš„å¼·å¤§å·¥å…·"},{"content":"æ¦‚è¿° find æ˜¯ Linux/Unix ç³»çµ±ä¸­æœ€å¼·å¤§ä¸”æœ€å¸¸ç”¨çš„æª”æ¡ˆæœå°‹å‘½ä»¤ä¹‹ä¸€ã€‚å®ƒä¸åƒ…èƒ½å¤ æ ¹æ“šå„ç¨®æ¢ä»¶æœå°‹æª”æ¡ˆå’Œç›®éŒ„ï¼Œé‚„èƒ½å°æœå°‹çµæœåŸ·è¡Œå„ç¨®æ“ä½œï¼Œæ˜¯ç³»çµ±ç®¡ç†å“¡å’Œé–‹ç™¼è€…å¿…å‚™çš„æ ¸å¿ƒå·¥å…·ã€‚\næ ¸å¿ƒç‰¹å¾µ éæ­¸æœå°‹ï¼šå¯æ·±å…¥å­ç›®éŒ„é€²è¡Œæœå°‹ å¤šé‡æ¢ä»¶ï¼šæ”¯æ´æª”åã€é¡å‹ã€å¤§å°ã€æ™‚é–“ç­‰å¤šç¨®æœå°‹æ¢ä»¶ å‹•ä½œåŸ·è¡Œï¼šå¯å°æœå°‹çµæœåŸ·è¡Œå„ç¨®æ“ä½œ é‚è¼¯çµ„åˆï¼šæ”¯æ´ ANDã€ORã€NOT ç­‰é‚è¼¯é‹ç®— é«˜æ•ˆèƒ½ï¼šé‡å°å¤§å‹æª”æ¡ˆç³»çµ±å„ªåŒ– åŸºæœ¬èªæ³• 1 find [æœå°‹è·¯å¾‘] [æœå°‹æ¢ä»¶] [å‹•ä½œ] åŸºæœ¬ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 # åœ¨ç•¶å‰ç›®éŒ„æœå°‹æª”æ¡ˆ find . -name \u0026#34;test.txt\u0026#34; # åœ¨æŒ‡å®šç›®éŒ„æœå°‹ find /home/user -name \u0026#34;*.log\u0026#34; # å¿½ç•¥å¤§å°å¯«æœå°‹ find . -iname \u0026#34;README.md\u0026#34; # æœå°‹å¤šå€‹ç›®éŒ„ find /var/log /tmp -name \u0026#34;*.tmp\u0026#34; ä¾æ“šæª”æ¡ˆåç¨±æœå°‹ åŸºæœ¬æª”åæœå°‹ 1 2 3 4 5 6 7 8 9 10 11 # ç²¾ç¢ºæª”ååŒ¹é… find /home -name \u0026#34;config.conf\u0026#34; # è¬ç”¨å­—å…ƒæœå°‹ find . -name \u0026#34;*.txt\u0026#34; # æ‰€æœ‰ .txt æª”æ¡ˆ find . -name \u0026#34;test*\u0026#34; # ä»¥ test é–‹é ­çš„æª”æ¡ˆ find . -name \u0026#34;*backup*\u0026#34; # åŒ…å« backup çš„æª”æ¡ˆ # å¿½ç•¥å¤§å°å¯« find . -iname \u0026#34;*.PDF\u0026#34; # ä¸åˆ†å¤§å°å¯«æœå°‹ PDF æª”æ¡ˆ find . -iname \u0026#34;readme*\u0026#34; # ä¸åˆ†å¤§å°å¯«æœå°‹ readme é–‹é ­çš„æª”æ¡ˆ é€²éšæª”åæœå°‹ 1 2 3 4 5 6 7 8 9 10 11 # ä½¿ç”¨æ­£è¦è¡¨é”å¼ find . -regex \u0026#34;.*\\.\\(jpg\\|png\\|gif\\)$\u0026#34; # æœå°‹åœ–ç‰‡æª”æ¡ˆ find . -iregex \u0026#34;.*\\.\\(mp3\\|mp4\\|avi\\)$\u0026#34; # ä¸åˆ†å¤§å°å¯«æœå°‹åª’é«”æª”æ¡ˆ # æ’é™¤ç‰¹å®šæª”æ¡ˆ find . -name \u0026#34;*.txt\u0026#34; ! -name \u0026#34;temp*\u0026#34; # æœå°‹ txt ä½†æ’é™¤ temp é–‹é ­ find . ! -name \u0026#34;.*\u0026#34; # æ’é™¤éš±è—æª”æ¡ˆ # å¤šå€‹æ¢ä»¶çµ„åˆ find . \\( -name \u0026#34;*.log\u0026#34; -o -name \u0026#34;*.tmp\u0026#34; \\) # OR æ¢ä»¶ find . -name \u0026#34;*.txt\u0026#34; -a -size +1M # AND æ¢ä»¶ ä¾æ“šæª”æ¡ˆé¡å‹æœå°‹ åŸºæœ¬æª”æ¡ˆé¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # æª”æ¡ˆé¡å‹åƒæ•¸èªªæ˜ # f: ä¸€èˆ¬æª”æ¡ˆ d: ç›®éŒ„ # l: ç¬¦è™Ÿé€£çµ p: å‘½åç®¡é“ (FIFO) # s: socket b: å€å¡Šè£ç½® # c: å­—å…ƒè£ç½® # æœå°‹ç›®éŒ„ find /var -type d -name \u0026#34;log*\u0026#34; # æœå°‹ä¸€èˆ¬æª”æ¡ˆ find . -type f -name \u0026#34;*.sh\u0026#34; # æœå°‹ç¬¦è™Ÿé€£çµ find /usr/bin -type l # æœå°‹ç©ºæª”æ¡ˆ find /tmp -type f -empty # æœå°‹ç©ºç›®éŒ„ find /home -type d -empty å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 # æ‰¾å‡ºæ‰€æœ‰ shell è…³æœ¬ find /usr/local/bin -type f -name \u0026#34;*.sh\u0026#34; -executable # æ‰¾å‡ºæ‰€æœ‰æå£çš„ç¬¦è™Ÿé€£çµ find /usr -type l ! -exec test -e {} \\; -print # æ‰¾å‡ºåŒ…å«ç‰¹å®šå‰¯æª”åçš„ç›®éŒ„ find . -type d -exec sh -c \u0026#39;ls \u0026#34;$1\u0026#34;/*.log \u0026gt;/dev/null 2\u0026gt;\u0026amp;1\u0026#39; _ {} \\; -print ä¾æ“šæª”æ¡ˆå¤§å°æœå°‹ åŸºæœ¬å¤§å°æœå°‹ 1 2 3 4 5 6 7 8 9 10 # å¤§å°å–®ä½èªªæ˜ # c: bytes k: KB (1024 bytes) # M: MB G: GB # +: å¤§æ–¼ -: å°æ–¼ ç²¾ç¢ºå€¼: ç­‰æ–¼ # åŸºæœ¬å¤§å°æœå°‹ find . -size 50M # ç­‰æ–¼ 50MB find . -size +100M # å¤§æ–¼ 100MB find . -size -1G # å°æ–¼ 1GB find /var/log -size +10M -size -100M # 10MB åˆ° 100MB ä¹‹é–“ é€²éšå¤§å°æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æ‰¾å‡ºæœ€å¤§çš„æª”æ¡ˆï¼ˆå‰ 10 å€‹ï¼‰ find /home -type f -exec ls -la {} \\; | sort -k5 -nr | head -10 # æ‰¾å‡ºè¶…é 1GB çš„æª”æ¡ˆä¸¦é¡¯ç¤ºå¤§å° find / -size +1G -type f -exec du -h {} \\; 2\u0026gt;/dev/null # æ‰¾å‡ºç©ºæª”æ¡ˆä¸¦åˆªé™¤ find /tmp -type f -empty -delete # æ‰¾å‡ºå¤§æª”æ¡ˆä¸¦è©¢å•æ˜¯å¦åˆªé™¤ find /var/log -size +100M -type f -ok rm {} \\; # æŒ‰å¤§å°ç¯„åœåˆ†é¡é¡¯ç¤º find . -type f -size +10M -size -100M -printf \u0026#34;%s %p\\n\u0026#34; | sort -nr ä¾æ“šæ™‚é–“æœå°‹ æ™‚é–“é¡å‹èªªæ˜ 1 2 3 4 5 6 7 8 9 10 # æ™‚é–“é¡å‹ # mtime: ä¿®æ”¹æ™‚é–“ (modify time) # atime: å­˜å–æ™‚é–“ (access time) # ctime: ç‹€æ…‹æ”¹è®Šæ™‚é–“ (change time) # æ™‚é–“å–®ä½ # é è¨­å–®ä½: å¤© (24å°æ™‚) # +n: nå¤©ä¹‹å‰ # -n: nå¤©ä¹‹å…§ # n: æ°å¥½nå¤©å‰ åŸºæœ¬æ™‚é–“æœå°‹ 1 2 3 4 5 6 7 8 9 10 11 12 # ä¿®æ”¹æ™‚é–“æœå°‹ find . -mtime 3 # æ°å¥½ 3 å¤©å‰ä¿®æ”¹ find . -mtime -7 # 7 å¤©å…§ä¿®æ”¹ find . -mtime +30 # 30 å¤©å‰ä¿®æ”¹ find . -mtime +7 -mtime -30 # 7-30 å¤©å‰ä¿®æ”¹ # å­˜å–æ™‚é–“æœå°‹ find /home -atime -1 # 1 å¤©å…§è¢«å­˜å– find /tmp -atime +7 # 7 å¤©ä»¥ä¸Šæœªè¢«å­˜å– # ç‹€æ…‹æ”¹è®Šæ™‚é–“ find . -ctime -1 # 1 å¤©å…§ç‹€æ…‹æ”¹è®Š ç²¾ç¢ºæ™‚é–“æœå°‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # åˆ†é˜ç‚ºå–®ä½çš„æ™‚é–“æœå°‹ find /var/log -mmin -60 # 60 åˆ†é˜å…§ä¿®æ”¹ find . -amin +120 # 120 åˆ†é˜å‰å­˜å– find /tmp -cmin -30 # 30 åˆ†é˜å…§ç‹€æ…‹æ”¹è®Š # æ¯”è¼ƒæª”æ¡ˆæ™‚é–“ find . -newer reference.txt # æ¯” reference.txt æ–°çš„æª”æ¡ˆ find . -cnewer backup.tar # ç‹€æ…‹æ¯” backup.tar æ–° # æŒ‡å®šæ—¥æœŸç¯„åœ find /var/log -newermt \u0026#34;2023-01-01\u0026#34; ! -newermt \u0026#34;2023-12-31\u0026#34; # ä»Šå¤©ä¿®æ”¹çš„æª”æ¡ˆ find . -daystart -mtime 0 # æ˜¨å¤©ä¿®æ”¹çš„æª”æ¡ˆ find . -daystart -mtime 1 ä¾æ“šæ¬Šé™æœå°‹ åŸºæœ¬æ¬Šé™æœå°‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # ç²¾ç¢ºæ¬Šé™åŒ¹é… find /home -perm 755 # æ¬Šé™æ°å¥½æ˜¯ 755 find . -perm 644 # æ¬Šé™æ°å¥½æ˜¯ 644 # åŒ…å«æŒ‡å®šæ¬Šé™ find /usr/bin -perm -755 # è‡³å°‘æœ‰ 755 æ¬Šé™ find . -perm -u+x # æ“æœ‰è€…æœ‰åŸ·è¡Œæ¬Šé™ # ä»»ä¸€ç¬¦åˆæ¬Šé™ find /tmp -perm /222 # ä»»ä½•äººæœ‰å¯«å…¥æ¬Šé™ find . -perm /u+w,g+w,o+w # ä»»ä½•äººæœ‰å¯«å…¥æ¬Šé™ # å¯åŸ·è¡Œæª”æ¡ˆ find /usr/local/bin -type f -executable find . -type f -perm -u+x # æ“æœ‰è€…å¯åŸ·è¡Œ é€²éšæ¬Šé™æœå°‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æ‰¾å‡º SUID æª”æ¡ˆ find /usr -perm -4000 -type f 2\u0026gt;/dev/null # æ‰¾å‡º SGID æª”æ¡ˆ find /usr -perm -2000 -type f 2\u0026gt;/dev/null # æ‰¾å‡º sticky bit ç›®éŒ„ find /tmp -perm -1000 -type d # æ‰¾å‡ºå¯å¯«çš„æª”æ¡ˆï¼ˆå®‰å…¨æª¢æŸ¥ï¼‰ find /etc -type f -writable 2\u0026gt;/dev/null # æ‰¾å‡ºç„¡æ¬Šé™è®€å–çš„æª”æ¡ˆ find /home -type f ! -readable 2\u0026gt;/dev/null ä¾æ“šæ“æœ‰è€…æœå°‹ åŸºæœ¬æ“æœ‰è€…æœå°‹ 1 2 3 4 5 6 7 8 9 10 11 12 # ä¾æ“šä½¿ç”¨è€…æœå°‹ find /home -user john # å±¬æ–¼ john çš„æª”æ¡ˆ find /var -user root # å±¬æ–¼ root çš„æª”æ¡ˆ find . -user $(whoami) # å±¬æ–¼ç•¶å‰ä½¿ç”¨è€…çš„æª”æ¡ˆ # ä¾æ“šç¾¤çµ„æœå°‹ find /home -group developers # å±¬æ–¼ developers ç¾¤çµ„ find /var/www -group www-data # å±¬æ–¼ www-data ç¾¤çµ„ # ä¾æ“š UID/GID æœå°‹ find /home -uid 1000 # UID ç‚º 1000 çš„æª”æ¡ˆ find /var -gid 100 # GID ç‚º 100 çš„æª”æ¡ˆ é€²éšæ“æœ‰è€…æœå°‹ 1 2 3 4 5 6 7 8 9 10 # æ‰¾å‡ºç„¡ä¸»æª”æ¡ˆï¼ˆå­¤å…’æª”æ¡ˆï¼‰ find /home -nouser # æ²’æœ‰å°æ‡‰ä½¿ç”¨è€…çš„æª”æ¡ˆ find /var -nogroup # æ²’æœ‰å°æ‡‰ç¾¤çµ„çš„æª”æ¡ˆ # çµ„åˆæ¢ä»¶æœå°‹ find /home -user john -group staff # å±¬æ–¼ john ä¸”ç¾¤çµ„æ˜¯ staff find /tmp -user root ! -group root # å±¬æ–¼ root ä½†ç¾¤çµ„ä¸æ˜¯ root # æ‰¾å‡ºç‰¹å®šä½¿ç”¨è€…çš„å¤§æª”æ¡ˆ find /home -user john -size +100M -type f åŸ·è¡Œå‹•ä½œ (-exec å’Œ -ok) åŸºæœ¬ -exec ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # åŸºæœ¬èªæ³•ï¼š-exec command {} \\; # {} ä»£è¡¨æ‰¾åˆ°çš„æª”æ¡ˆ # \\; è¡¨ç¤ºå‘½ä»¤çµæŸ # åˆªé™¤æ‰¾åˆ°çš„æª”æ¡ˆ find /tmp -name \u0026#34;*.tmp\u0026#34; -exec rm {} \\; # è¤‡è£½æª”æ¡ˆ find . -name \u0026#34;*.txt\u0026#34; -exec cp {} backup/ \\; # ç§»å‹•æª”æ¡ˆ find . -name \u0026#34;*.log\u0026#34; -exec mv {} /var/log/ \\; # ä¿®æ”¹æ¬Šé™ find /var/www -type f -exec chmod 644 {} \\; find /var/www -type d -exec chmod 755 {} \\; é€²éš -exec ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 # ä½¿ç”¨ -exec {} + æé«˜æ•ˆèƒ½ï¼ˆæ‰¹æ¬¡è™•ç†ï¼‰ find . -name \u0026#34;*.txt\u0026#34; -exec grep \u0026#34;pattern\u0026#34; {} + find /tmp -name \u0026#34;*.tmp\u0026#34; -exec rm {} + # åŸ·è¡Œè¤‡é›œå‘½ä»¤ find . -type f -name \u0026#34;*.sh\u0026#34; -exec sh -c \u0026#39;echo \u0026#34;Processing: $1\u0026#34;; chmod +x \u0026#34;$1\u0026#34;\u0026#39; _ {} \\; # åœ¨æ‰¾åˆ°çš„ç›®éŒ„ä¸­åŸ·è¡Œå‘½ä»¤ find /var/log -type d -exec sh -c \u0026#39;echo \u0026#34;Directory: $1\u0026#34;; ls -la \u0026#34;$1\u0026#34;\u0026#39; _ {} \\; # æ¢ä»¶åŸ·è¡Œ find . -name \u0026#34;*.txt\u0026#34; -exec test -s {} \\; -exec echo \u0026#34;Non-empty: {}\u0026#34; \\; äº’å‹•å¼ -ok ç”¨æ³• 1 2 3 4 5 6 7 8 # -ok æœƒåœ¨åŸ·è¡Œå‰è©¢å•ç¢ºèª find /tmp -name \u0026#34;*.old\u0026#34; -ok rm {} \\; # äº’å‹•å¼ç§»å‹•æª”æ¡ˆ find . -name \u0026#34;*.bak\u0026#34; -ok mv {} backup/ \\; # äº’å‹•å¼æ¬Šé™ä¿®æ”¹ find /home -name \u0026#34;*.sh\u0026#34; -ok chmod +x {} \\; é‚è¼¯é‹ç®—ç¬¦ åŸºæœ¬é‚è¼¯é‹ç®— 1 2 3 4 5 6 7 8 9 10 11 # AND é‹ç®—ï¼ˆé è¨­ï¼‰ find . -name \u0026#34;*.txt\u0026#34; -size +1M # åç¨±æ˜¯ *.txt ä¸”å¤§å° \u0026gt; 1M find . -type f -user john # æ˜¯æª”æ¡ˆä¸”å±¬æ–¼ john # OR é‹ç®— find . \\( -name \u0026#34;*.txt\u0026#34; -o -name \u0026#34;*.md\u0026#34; \\) # txt æˆ– md æª”æ¡ˆ find . -type f \\( -name \u0026#34;*.log\u0026#34; -o -name \u0026#34;*.tmp\u0026#34; \\) # NOT é‹ç®— find . -type f ! -name \u0026#34;*.txt\u0026#34; # ä¸æ˜¯ txt çš„æª”æ¡ˆ find . ! -path \u0026#34;*/.*\u0026#34; # æ’é™¤éš±è—ç›®éŒ„ è¤‡é›œé‚è¼¯çµ„åˆ 1 2 3 4 5 6 7 8 # è¤‡é›œæ¢ä»¶çµ„åˆ find . \\( -name \u0026#34;*.txt\u0026#34; -o -name \u0026#34;*.md\u0026#34; \\) -a -size +1k -a ! -path \u0026#34;*/tmp/*\u0026#34; # å¤šé‡æ’é™¤æ¢ä»¶ find /var/log \\( ! -name \u0026#34;*.gz\u0026#34; ! -name \u0026#34;*.old\u0026#34; \\) -type f -mtime -7 # å·¢ç‹€é‚è¼¯æ¢ä»¶ find . \\( \\( -name \u0026#34;*.c\u0026#34; -o -name \u0026#34;*.h\u0026#34; \\) -a -mtime -7 \\) -o \\( -name \u0026#34;*.py\u0026#34; -a -size +10k \\) è¼¸å‡ºæ ¼å¼åŒ– ä½¿ç”¨ -printf æ ¼å¼åŒ–è¼¸å‡º 1 2 3 4 5 6 7 8 9 10 11 # åŸºæœ¬æ ¼å¼åŒ– find . -type f -printf \u0026#34;%f\\n\u0026#34; # åªé¡¯ç¤ºæª”å find . -type f -printf \u0026#34;%p\\t%s\\n\u0026#34; # è·¯å¾‘å’Œå¤§å° find . -type f -printf \u0026#34;%M %u %g %s %p\\n\u0026#34; # æ¬Šé™ã€æ“æœ‰è€…ã€ç¾¤çµ„ã€å¤§å°ã€è·¯å¾‘ # æ™‚é–“æ ¼å¼åŒ– find . -type f -printf \u0026#34;%TY-%Tm-%Td %TH:%TM %p\\n\u0026#34; # ä¿®æ”¹æ™‚é–“å’Œè·¯å¾‘ find . -type f -printf \u0026#34;%Ac %p\\n\u0026#34; # å­˜å–æ™‚é–“ # å¤§å°æ ¼å¼åŒ– find . -type f -printf \u0026#34;%10s %p\\n\u0026#34; | sort -nr # æŒ‰å¤§å°æ’åº æ ¼å¼åŒ–åƒæ•¸èªªæ˜ 1 2 3 4 5 6 7 8 9 10 # å¸¸ç”¨æ ¼å¼åŒ–åƒæ•¸ # %p: æª”æ¡ˆè·¯å¾‘ # %f: æª”æ¡ˆåç¨± # %s: æª”æ¡ˆå¤§å°ï¼ˆbytesï¼‰ # %M: æª”æ¡ˆæ¬Šé™ # %u: æ“æœ‰è€…åç¨± # %g: ç¾¤çµ„åç¨± # %T: æ™‚é–“ç›¸é—œï¼ˆéœ€é…åˆæ™‚é–“æ ¼å¼ï¼‰ # %h: ç›®éŒ„è·¯å¾‘ # %d: æª”æ¡ˆæ·±åº¦ å¯¦æˆ°æ‡‰ç”¨å ´æ™¯ ç³»çµ±æ¸…ç†èˆ‡ç¶­è­· 1 2 3 4 5 6 7 8 9 # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ find /tmp -type f -atime +7 -delete # åˆªé™¤ 7 å¤©æœªå­˜å–çš„æª”æ¡ˆ find /var/log -name \u0026#34;*.log\u0026#34; -size +100M -delete # åˆªé™¤å¤§æ—¥èªŒæª”æ¡ˆ # æ¸…ç†å¿«å–æª”æ¡ˆ find ~/.cache -type f -atime +30 -delete # æ¸…ç†èˆŠå¿«å– # å‚™ä»½å‰æ¸…ç† find /backup -name \u0026#34;*.tar.gz\u0026#34; -mtime +30 -delete # åˆªé™¤ 30 å¤©å‰çš„å‚™ä»½ æª”æ¡ˆæ•´ç†èˆ‡æ­¸æª” 1 2 3 4 5 6 7 8 # æŒ‰æ—¥æœŸæ­¸æª”æª”æ¡ˆ find /data -type f -name \u0026#34;*.log\u0026#34; -mtime +1 -exec gzip {} \\; # æŒ‰å¤§å°åˆ†é¡æª”æ¡ˆ find /home -type f -size +1G -exec ls -lh {} \\; # ç§»å‹•èˆŠæª”æ¡ˆåˆ°æ­¸æª”ç›®éŒ„ find /project -type f -mtime +90 -exec mv {} /archive/ \\; å®‰å…¨æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 # æª¢æŸ¥ SUID/SGID æª”æ¡ˆ find /usr -type f \\( -perm -4000 -o -perm -2000 \\) -exec ls -l {} \\; # æª¢æŸ¥å¯å¯«æª”æ¡ˆ find /etc -type f -writable 2\u0026gt;/dev/null # æª¢æŸ¥ç„¡ä¸»æª”æ¡ˆ find /home -nouser -o -nogroup # æª¢æŸ¥ç•°å¸¸æ¬Šé™ find /var/www -type f ! -perm 644 -o -type d ! -perm 755 é–‹ç™¼èˆ‡é™¤éŒ¯ 1 2 3 4 5 6 7 8 9 10 11 12 # æœå°‹ç¨‹å¼ç¢¼ find . -name \u0026#34;*.java\u0026#34; -exec grep -l \u0026#34;className\u0026#34; {} \\; # æ‰¾å‡ºç·¨è­¯ç”¢ç”Ÿçš„æª”æ¡ˆ find . \\( -name \u0026#34;*.class\u0026#34; -o -name \u0026#34;*.o\u0026#34; -o -name \u0026#34;*.pyc\u0026#34; \\) -delete # çµ±è¨ˆä¸åŒé¡å‹æª”æ¡ˆæ•¸é‡ find . -type f -name \u0026#34;*.java\u0026#34; | wc -l find . -type f -name \u0026#34;*.py\u0026#34; -exec wc -l {} + | tail -1 # æª¢æŸ¥ç¨‹å¼ç¢¼è¡Œæ•¸ find . -name \u0026#34;*.py\u0026#34; -exec wc -l {} + | sort -nr | head -10 ç›£æ§èˆ‡åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 # æ‰¾å‡ºæœ€è¿‘ä¿®æ”¹çš„æª”æ¡ˆ find /var/log -type f -mmin -60 -exec ls -lt {} \\; # ç›£æ§æª”æ¡ˆç³»çµ±è®ŠåŒ– find /etc -newer /tmp/baseline -type f # åˆ†æç£ç¢Ÿä½¿ç”¨ find /home -type f -printf \u0026#34;%s %p\\n\u0026#34; | sort -nr | head -20 # æ‰¾å‡ºé‡è¤‡æª”æ¡ˆï¼ˆåŸºæ–¼å¤§å°ï¼‰ find /data -type f -printf \u0026#34;%s %p\\n\u0026#34; | sort | uniq -d -w 10 æ•ˆèƒ½å„ªåŒ–æŠ€å·§ æå‡æœå°‹æ•ˆèƒ½ 1 2 3 4 5 6 7 8 9 10 11 12 13 # é™åˆ¶æœå°‹æ·±åº¦ find /usr -maxdepth 3 -name \u0026#34;*.conf\u0026#34; # æ’é™¤ä¸å¿…è¦çš„ç›®éŒ„ find / -path /proc -prune -o -path /sys -prune -o -name \u0026#34;*.txt\u0026#34; -print # ä½¿ç”¨æ›´å…·é«”çš„è·¯å¾‘ find /var/log -name \u0026#34;*.log\u0026#34; # å¥½ find / -name \u0026#34;*.log\u0026#34; # è¼ƒæ…¢ # å°‡æœ€å…·é¸æ“‡æ€§çš„æ¢ä»¶æ”¾åœ¨å‰é¢ find . -name \u0026#34;*.txt\u0026#34; -size +1M # å¥½ find . -size +1M -name \u0026#34;*.txt\u0026#34; # ä¹Ÿå¯ä»¥ï¼Œä½†é †åºå½±éŸ¿æ•ˆèƒ½ æ‰¹æ¬¡è™•ç†å„ªåŒ– 1 2 3 4 5 6 7 8 9 # ä½¿ç”¨ {} + è€Œé {} \\; æå‡æ•ˆèƒ½ find . -name \u0026#34;*.txt\u0026#34; -exec wc -l {} + # å¿« find . -name \u0026#34;*.txt\u0026#34; -exec wc -l {} \\; # æ…¢ # ä½¿ç”¨ç®¡é“è™•ç†å¤§é‡çµæœ find /var/log -name \u0026#34;*.log\u0026#34; -print0 | xargs -0 grep \u0026#34;ERROR\u0026#34; # ä¸¦è¡Œè™•ç† find . -name \u0026#34;*.jpg\u0026#34; -print0 | xargs -0 -P 4 -I {} convert {} {}.thumb.jpg å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±ºæ–¹æ¡ˆ æ¬Šé™éŒ¯èª¤è™•ç† 1 2 3 4 5 6 7 8 # å¿½ç•¥æ¬Šé™éŒ¯èª¤ find /var -name \u0026#34;*.log\u0026#34; 2\u0026gt;/dev/null # åªæœå°‹æœ‰æ¬Šé™çš„ç›®éŒ„ find /var -readable -name \u0026#34;*.log\u0026#34; # ä½¿ç”¨ sudo æœå°‹å—ä¿è­·çš„ç›®éŒ„ sudo find /root -name \u0026#34;*.conf\u0026#34; ç‰¹æ®Šå­—å…ƒè™•ç† 1 2 3 4 5 6 # è™•ç†æª”åä¸­çš„ç©ºæ ¼ find . -name \u0026#34;* *\u0026#34; -print0 | xargs -0 ls -l # è™•ç†ç‰¹æ®Šå­—å…ƒ find . -name \u0026#34;file[1-3].txt\u0026#34; find . -name \u0026#34;*.txt\u0026#34; -not -name \u0026#34;*\\\u0026amp;*\u0026#34; è¨˜æ†¶é«”ä½¿ç”¨å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 # é¿å…ä¸€æ¬¡è¼‰å…¥éå¤šçµæœ find /large_dir -name \u0026#34;*.txt\u0026#34; | head -100 # ä½¿ç”¨ -quit åœ¨æ‰¾åˆ°ç¬¬ä¸€å€‹çµæœå¾Œåœæ­¢ find . -name \u0026#34;target.txt\u0026#34; -quit # åˆ†æ®µè™•ç†å¤§ç›®éŒ„ find /huge_dir -maxdepth 1 -type d | while read dir; do find \u0026#34;$dir\u0026#34; -name \u0026#34;*.txt\u0026#34; done èˆ‡å…¶ä»–å·¥å…·çµ„åˆ èˆ‡ grep çµ„åˆ 1 2 3 4 5 6 7 8 9 # åœ¨æª”æ¡ˆä¸­æœå°‹å…§å®¹ find . -name \u0026#34;*.txt\u0026#34; -exec grep -l \u0026#34;pattern\u0026#34; {} \\; # æœå°‹ä¸¦é¡¯ç¤ºåŒ¹é…è¡Œ find . -name \u0026#34;*.log\u0026#34; -exec grep -Hn \u0026#34;ERROR\u0026#34; {} \\; # ä½¿ç”¨ xargs æå‡æ•ˆèƒ½ find . -name \u0026#34;*.txt\u0026#34; | xargs grep \u0026#34;pattern\u0026#34; find . -name \u0026#34;*.txt\u0026#34; -print0 | xargs -0 grep \u0026#34;pattern\u0026#34; èˆ‡ tar çµ„åˆ 1 2 3 4 5 # å‚™ä»½æ‰¾åˆ°çš„æª”æ¡ˆ find /home -name \u0026#34;*.doc\u0026#34; -print0 | tar -czf backup.tar.gz --null -T - # æ­¸æª”èˆŠæª”æ¡ˆ find /data -mtime +30 -print0 | tar -czf old_files.tar.gz --null -T - èˆ‡ rsync çµ„åˆ 1 2 # åŒæ­¥æ‰¾åˆ°çš„æª”æ¡ˆ find /source -name \u0026#34;*.txt\u0026#34; -print0 | rsync -av --files-from=- --from0 /source/ /destination/ ç¸½çµ æ ¸å¿ƒå„ªå‹¢ å¼·å¤§çš„æœå°‹èƒ½åŠ›ï¼šæ”¯æ´å¤šç¨®æ¢ä»¶çµ„åˆæœå°‹ æ‰¹æ¬¡æ“ä½œï¼šå¯å°æœå°‹çµæœåŸ·è¡Œå„ç¨®å‹•ä½œ é«˜åº¦å¯é…ç½®ï¼šè±å¯Œçš„åƒæ•¸å’Œé¸é … è·¨å¹³å°ç›¸å®¹ï¼šåœ¨å„ç¨® Unix-like ç³»çµ±ä¸­ä¸€è‡´ æœ€ä½³å¯¦è¸ æ˜ç¢ºæœå°‹ç¯„åœï¼šä½¿ç”¨å…·é«”çš„è·¯å¾‘è€Œéæ ¹ç›®éŒ„ åˆç†ä½¿ç”¨æ¢ä»¶ï¼šå°‡æœ€å…·é¸æ“‡æ€§çš„æ¢ä»¶æ”¾åœ¨å‰é¢ å–„ç”¨é‚è¼¯é‹ç®—ï¼šåˆç†çµ„åˆ ANDã€ORã€NOT æ¢ä»¶ æ³¨æ„æ•ˆèƒ½ï¼šå¤§ç›®éŒ„æœå°‹æ™‚è€ƒæ…®ä½¿ç”¨ -maxdepth é™åˆ¶ å®‰å…¨æ“ä½œï¼šä½¿ç”¨ -ok è€Œé -exec é€²è¡Œå±éšªæ“ä½œ å¸¸ç”¨æŠ€å·§è¨˜æ†¶ 1 2 3 4 5 6 # æ—¥å¸¸æœ€å¸¸ç”¨çš„æ¨¡å¼ find . -name \u0026#34;*.txt\u0026#34; # åŸºæœ¬æª”åæœå°‹ find . -type f -size +100M # å¤§æª”æ¡ˆæœå°‹ find . -mtime -7 # æœ€è¿‘ä¿®æ”¹æª”æ¡ˆ find . -name \u0026#34;*.tmp\u0026#34; -delete # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ find . -name \u0026#34;*.sh\u0026#34; -exec chmod +x {} \\; # æ‰¹æ¬¡ä¿®æ”¹æ¬Šé™ find å‘½ä»¤çš„å¼·å¤§ä¹‹è™•åœ¨æ–¼å…¶éˆæ´»æ€§å’Œå¯çµ„åˆæ€§ã€‚ç†Ÿç·´æŒæ¡é€™å€‹å·¥å…·ï¼Œèƒ½å¤ å¤§å¹…æå‡ Linux ç³»çµ±ç®¡ç†å’Œæ—¥å¸¸å·¥ä½œçš„æ•ˆç‡ã€‚è¨˜ä½ï¼šå¯¦å‹™ä¸­æœ€é‡è¦çš„æ˜¯ç†è§£å„ç¨®æ¢ä»¶çš„çµ„åˆé‚è¼¯ï¼Œä¸¦æ ¹æ“šå¯¦éš›éœ€æ±‚é¸æ“‡æœ€é©åˆçš„æœå°‹ç­–ç•¥ã€‚\nåƒè€ƒè³‡æ–™ GNU Findutils Manual Linux man find Advanced Bash-Scripting Guide Unix Power Tools ","permalink":"https://xinqilin.github.io/post/tools/find/","tags":["Linux","Find","Command Line","File Search","System Administration","Shell","Unix"],"title":"Find å‘½ä»¤å®Œæ•´æŒ‡å—ï¼šLinux æª”æ¡ˆæœå°‹èˆ‡ç®¡ç†çš„ç‘å£«è»åˆ€"},{"content":"æ¦‚è¿° Ubuntu æ˜¯åŸºæ–¼ Debian çš„ Linux ç™¼è¡Œç‰ˆï¼Œä»¥å…¶ç©©å®šæ€§ã€æ˜“ç”¨æ€§å’Œè±å¯Œçš„è»Ÿé«”ç”Ÿæ…‹ç³»çµ±è€Œèåã€‚å®ƒæ˜¯é›²ç«¯é‹ç®—ã€ä¼ºæœå™¨éƒ¨ç½²å’Œé–‹ç™¼ç’°å¢ƒçš„é¦–é¸å¹³å°ï¼Œæä¾›é•·æœŸæ”¯æ´ï¼ˆLTSï¼‰ç‰ˆæœ¬å’Œå®šæœŸæ›´æ–°çš„æ¨™æº–ç‰ˆæœ¬ã€‚\næ ¸å¿ƒç‰¹å¾µ ç©©å®šå¯é ï¼šåŸºæ–¼ Debian ç©©å®šåˆ†æ”¯ï¼Œç¶“éåš´æ ¼æ¸¬è©¦ å¥—ä»¶è±å¯Œï¼šAPT å¥—ä»¶ç®¡ç†ç³»çµ±ï¼Œæ•¸è¬å€‹è»Ÿé«”åŒ… ç¤¾ç¾¤æ”¯æ´ï¼šæ´»èºçš„é–‹ç™¼è€…å’Œä½¿ç”¨è€…ç¤¾ç¾¤ å®¹å™¨å‹å¥½ï¼šå„ªç§€çš„ Docker å’Œå®¹å™¨åŒ–æ”¯æ´ é›²ç«¯æ•´åˆï¼šåŸç”Ÿæ”¯æ´å„å¤§é›²ç«¯å¹³å° ç³»çµ±å®‰è£èˆ‡åˆå§‹è¨­ç½® åŸºæœ¬å®‰è£ 1 2 3 4 5 6 7 8 9 10 11 12 13 # æª¢æŸ¥ç³»çµ±ç‰ˆæœ¬ lsb_release -a cat /etc/os-release # æª¢æŸ¥ç¡¬é«”è³‡è¨Š uname -a lscpu free -h df -h # æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ ip addr show netstat -tuln ç³»çµ±æ›´æ–° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æ›´æ–°å¥—ä»¶åˆ—è¡¨ sudo apt update # å‡ç´šå·²å®‰è£çš„å¥—ä»¶ sudo apt upgrade -y # å®Œæ•´ç³»çµ±å‡ç´š sudo apt full-upgrade -y # æ¸…ç†ä¸éœ€è¦çš„å¥—ä»¶ sudo apt autoremove -y sudo apt autoclean # æª¢æŸ¥å¯å‡ç´šçš„å¥—ä»¶ apt list --upgradable æ™‚å€å’Œèªè¨€è¨­å®š 1 2 3 4 5 6 7 8 9 10 # è¨­å®šæ™‚å€ sudo timedatectl set-timezone Asia/Taipei timedatectl status # èªè¨€å’Œåœ°å€è¨­å®š sudo locale-gen zh_TW.UTF-8 sudo update-locale LANG=zh_TW.UTF-8 # æª¢æŸ¥ç•¶å‰èªè¨€è¨­å®š locale å¥—ä»¶ç®¡ç†ç³»çµ± APT åŸºæœ¬æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # æœå°‹å¥—ä»¶ apt search keyword apt-cache search keyword # æŸ¥çœ‹å¥—ä»¶è³‡è¨Š apt show package-name apt-cache show package-name # å®‰è£å¥—ä»¶ sudo apt install package-name sudo apt install package1 package2 package3 # é‡æ–°å®‰è£å¥—ä»¶ sudo apt reinstall package-name # ç§»é™¤å¥—ä»¶ sudo apt remove package-name # ä¿ç•™é…ç½®æª”æ¡ˆ sudo apt purge package-name # å®Œå…¨ç§»é™¤ # æª¢æŸ¥ä¾è³´é—œä¿‚ apt depends package-name apt rdepends package-name # åˆ—å‡ºå·²å®‰è£å¥—ä»¶ dpkg -l apt list --installed å¥—ä»¶åº«ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æ·»åŠ  PPA å¥—ä»¶åº« sudo add-apt-repository ppa:user/ppa-name sudo apt update # ç§»é™¤ PPA sudo add-apt-repository --remove ppa:user/ppa-name # ç®¡ç†å¥—ä»¶åº«é‡‘é‘° wget -qO - https://example.com/key.gpg | sudo apt-key add - sudo apt-key list sudo apt-key del KEY_ID # ç·¨è¼¯å¥—ä»¶ä¾†æº sudo nano /etc/apt/sources.list ls /etc/apt/sources.list.d/ DEB å¥—ä»¶è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # å®‰è£æœ¬åœ° DEB å¥—ä»¶ sudo dpkg -i package.deb # ä¿®å¾©ä¾è³´å•é¡Œ sudo apt install -f # ç§»é™¤ DEB å¥—ä»¶ sudo dpkg -r package-name # æŸ¥è©¢ DEB å¥—ä»¶å…§å®¹ dpkg -L package-name dpkg -c package.deb # æŸ¥è©¢æª”æ¡ˆå±¬æ–¼å“ªå€‹å¥—ä»¶ dpkg -S /path/to/file å¿…å‚™è»Ÿé«”å®‰è£ é–‹ç™¼å·¥å…· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åŸºæœ¬é–‹ç™¼å·¥å…· sudo apt install build-essential git vim curl wget htop tree # ç¨‹å¼èªè¨€ç’°å¢ƒ sudo apt install python3 python3-pip nodejs npm default-jdk # ç‰ˆæœ¬æ§åˆ¶ sudo apt install git subversion # ç·¨è¼¯å™¨å’Œ IDE sudo apt install vim neovim emacs code # è³‡æ–™åº«å·¥å…· sudo apt install mysql-client postgresql-client redis-tools ç³»çµ±ç›£æ§å·¥å…· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # ç³»çµ±ç›£æ§ sudo apt install htop iotop iftop nethogs # ç³»çµ±è³‡è¨Š sudo apt install neofetch screenfetch inxi # ç¶²è·¯å·¥å…· sudo apt install net-tools traceroute nmap tcpdump wireshark # æ•ˆèƒ½åˆ†æ sudo apt install sysstat dstat glances # æ—¥èªŒåˆ†æ sudo apt install logwatch fail2ban åª’é«”å’Œè¾¦å…¬è»Ÿé«” 1 2 3 4 5 6 7 8 9 10 11 # åª’é«”æ’­æ”¾ sudo apt install vlc audacity gimp # è¾¦å…¬è»Ÿé«” sudo apt install libreoffice thunderbird firefox # å£“ç¸®å·¥å…· sudo apt install zip unzip rar unrar 7zip # æ–‡ä»¶è™•ç† sudo apt install pandoc texlive-full Docker ç’°å¢ƒè¨­ç½® Docker å®‰è£èˆ‡é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # ç§»é™¤èˆŠç‰ˆæœ¬ sudo apt remove docker docker-engine docker.io containerd runc # å®‰è£ä¾è³´ sudo apt update sudo apt install apt-transport-https ca-certificates curl gnupg lsb-release # æ·»åŠ  Docker å®˜æ–¹ GPG é‡‘é‘° curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg # æ·»åŠ å¥—ä»¶åº« echo \u0026#34;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\u0026#34; | sudo tee /etc/apt/sources.list.d/docker.list \u0026gt; /dev/null # å®‰è£ Docker Engine sudo apt update sudo apt install docker-ce docker-ce-cli containerd.io docker-compose-plugin # å•Ÿå‹•ä¸¦å•Ÿç”¨ Docker æœå‹™ sudo systemctl start docker sudo systemctl enable docker # å°‡ä½¿ç”¨è€…åŠ å…¥ docker ç¾¤çµ„ sudo usermod -aG docker $USER newgrp docker # é©—è­‰å®‰è£ docker --version docker run hello-world Ubuntu Docker å®¹å™¨è¨­ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 # æ‹‰å– Ubuntu æ˜ åƒ docker pull ubuntu:latest docker pull ubuntu:20.04 docker pull ubuntu:22.04 # å»ºç«‹ Docker ç¶²è·¯ docker network create ubuntu-network # å•Ÿå‹• Ubuntu å®¹å™¨ docker run -dit \\ --name ubuntu-container \\ --network ubuntu-network \\ -p 2222:22 \\ -p 8080:8080 \\ -v $(pwd)/workspace:/workspace \\ ubuntu:latest # é€²å…¥å®¹å™¨ docker exec -it ubuntu-container bash # å®¹å™¨å…§åˆå§‹åŒ– apt update \u0026amp;\u0026amp; apt upgrade -y yes | unminimize # å®‰è£åŸºæœ¬å·¥å…· apt install -y \\ curl \\ wget \\ git \\ vim \\ nano \\ htop \\ tree \\ less \\ man-db \\ openssh-server \\ sudo \\ zip \\ unzip \\ jq \\ python3 \\ python3-pip \\ nodejs \\ npm # è¨­å®š SSH æœå‹™ echo \u0026#39;PermitRootLogin yes\u0026#39; \u0026gt;\u0026gt; /etc/ssh/sshd_config echo \u0026#39;PasswordAuthentication yes\u0026#39; \u0026gt;\u0026gt; /etc/ssh/sshd_config service ssh start # å»ºç«‹ä½¿ç”¨è€… useradd -m -s /bin/bash developer echo \u0026#39;developer:password\u0026#39; | chpasswd usermod -aG sudo developer å®¹å™¨ç®¡ç†è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 #!/bin/bash # ubuntu_container_manager.sh - Ubuntu å®¹å™¨ç®¡ç†è…³æœ¬ CONTAINER_NAME=\u0026#34;ubuntu-dev\u0026#34; NETWORK_NAME=\u0026#34;ubuntu-network\u0026#34; IMAGE=\u0026#34;ubuntu:22.04\u0026#34; start_container() { echo \u0026#34;Starting Ubuntu development container...\u0026#34; # æª¢æŸ¥ç¶²è·¯æ˜¯å¦å­˜åœ¨ if ! docker network ls | grep -q \u0026#34;$NETWORK_NAME\u0026#34;; then echo \u0026#34;Creating network: $NETWORK_NAME\u0026#34; docker network create \u0026#34;$NETWORK_NAME\u0026#34; fi # æª¢æŸ¥å®¹å™¨æ˜¯å¦å·²å­˜åœ¨ if docker ps -a | grep -q \u0026#34;$CONTAINER_NAME\u0026#34;; then echo \u0026#34;Starting existing container...\u0026#34; docker start \u0026#34;$CONTAINER_NAME\u0026#34; else echo \u0026#34;Creating new container...\u0026#34; docker run -dit \\ --name \u0026#34;$CONTAINER_NAME\u0026#34; \\ --network \u0026#34;$NETWORK_NAME\u0026#34; \\ -p 2222:22 \\ -p 8080:8080 \\ -p 3000:3000 \\ -v \u0026#34;$(pwd)/workspace:/workspace\u0026#34; \\ -v \u0026#34;$(pwd)/config:/config\u0026#34; \\ \u0026#34;$IMAGE\u0026#34; # åˆå§‹åŒ–å®¹å™¨ echo \u0026#34;Initializing container...\u0026#34; docker exec \u0026#34;$CONTAINER_NAME\u0026#34; bash -c \u0026#34; apt update \u0026amp;\u0026amp; apt upgrade -y yes | unminimize apt install -y curl wget git vim htop tree less man-db openssh-server sudo zip unzip jq python3 python3-pip nodejs npm echo \u0026#39;PermitRootLogin yes\u0026#39; \u0026gt;\u0026gt; /etc/ssh/sshd_config echo \u0026#39;PasswordAuthentication yes\u0026#39; \u0026gt;\u0026gt; /etc/ssh/sshd_config service ssh start useradd -m -s /bin/bash developer echo \u0026#39;developer:developer\u0026#39; | chpasswd usermod -aG sudo developer \u0026#34; fi echo \u0026#34;Container started successfully!\u0026#34; echo \u0026#34;SSH: ssh -p 2222 developer@localhost\u0026#34; echo \u0026#34;Enter: docker exec -it $CONTAINER_NAME bash\u0026#34; } stop_container() { echo \u0026#34;Stopping container...\u0026#34; docker stop \u0026#34;$CONTAINER_NAME\u0026#34; } remove_container() { echo \u0026#34;Removing container...\u0026#34; docker stop \u0026#34;$CONTAINER_NAME\u0026#34; 2\u0026gt;/dev/null || true docker rm \u0026#34;$CONTAINER_NAME\u0026#34; 2\u0026gt;/dev/null || true } status_container() { echo \u0026#34;Container status:\u0026#34; docker ps -a | grep \u0026#34;$CONTAINER_NAME\u0026#34; || echo \u0026#34;Container not found\u0026#34; } case \u0026#34;$1\u0026#34; in start) start_container ;; stop) stop_container ;; remove) remove_container ;; status) status_container ;; restart) stop_container sleep 2 start_container ;; *) echo \u0026#34;Usage: $0 {start|stop|remove|status|restart}\u0026#34; exit 1 ;; esac ç³»çµ±ç®¡ç†èˆ‡ç¶­è­· æœå‹™ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # æª¢æŸ¥æœå‹™ç‹€æ…‹ sudo systemctl status service-name sudo systemctl list-units --type=service # å•Ÿå‹•/åœæ­¢/é‡å•Ÿæœå‹™ sudo systemctl start service-name sudo systemctl stop service-name sudo systemctl restart service-name sudo systemctl reload service-name # å•Ÿç”¨/åœç”¨æœå‹™ sudo systemctl enable service-name sudo systemctl disable service-name # æª¢æŸ¥æœå‹™æ—¥èªŒ sudo journalctl -u service-name sudo journalctl -u service-name -f # å³æ™‚æ—¥èªŒ # æª¢æŸ¥é–‹æ©Ÿå•Ÿå‹•çš„æœå‹™ sudo systemctl list-unit-files --state=enabled ä½¿ç”¨è€…å’Œæ¬Šé™ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # ä½¿ç”¨è€…ç®¡ç† sudo useradd -m -s /bin/bash username sudo passwd username sudo userdel username sudo usermod -aG group username # ç¾¤çµ„ç®¡ç† sudo groupadd groupname sudo groupdel groupname groups username # æ¬Šé™ç®¡ç† chmod 755 file chmod u+x file chown user:group file sudo chown -R user:group directory/ # æŸ¥çœ‹ä½¿ç”¨è€…è³‡è¨Š id username who w last ç³»çµ±ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # CPU å’Œè¨˜æ†¶é«”ä½¿ç”¨ç‡ top htop free -h cat /proc/meminfo # ç£ç¢Ÿä½¿ç”¨æƒ…æ³ df -h du -sh directory/ lsblk fdisk -l # ç¶²è·¯ç‹€æ…‹ netstat -tuln ss -tuln iftop nethogs # ç³»çµ±è² è¼‰ uptime cat /proc/loadavg vmstat 1 5 iostat 1 5 æ—¥èªŒç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # ç³»çµ±æ—¥èªŒ sudo journalctl sudo journalctl -f # å³æ™‚æ—¥èªŒ sudo journalctl --since \u0026#34;1 hour ago\u0026#34; sudo journalctl --until \u0026#34;2023-01-01\u0026#34; # æ—¥èªŒå¤§å°ç®¡ç† sudo journalctl --disk-usage sudo journalctl --vacuum-size=100M sudo journalctl --vacuum-time=30d # å‚³çµ±æ—¥èªŒæª”æ¡ˆ tail -f /var/log/syslog tail -f /var/log/auth.log tail -f /var/log/apache2/access.log # æ—¥èªŒè¼ªè½‰ sudo logrotate -d /etc/logrotate.conf sudo logrotate -f /etc/logrotate.conf ç¶²è·¯é…ç½® ç¶²è·¯æ¥å£ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # æª¢æŸ¥ç¶²è·¯æ¥å£ ip addr show ip link show ifconfig # ç¶²è·¯é…ç½®ï¼ˆNetplanï¼‰ sudo nano /etc/netplan/00-installer-config.yaml # ç¯„ä¾‹ Netplan é…ç½® network: version: 2 renderer: networkd ethernets: enp0s3: dhcp4: true enp0s8: addresses: - 192.168.1.100/24 gateway4: 192.168.1.1 nameservers: addresses: [8.8.8.8, 1.1.1.1] # æ‡‰ç”¨ç¶²è·¯é…ç½® sudo netplan try sudo netplan apply # é‡å•Ÿç¶²è·¯æœå‹™ sudo systemctl restart networking sudo systemctl restart systemd-networkd é˜²ç«ç‰†è¨­å®š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # UFW é˜²ç«ç‰† sudo ufw status sudo ufw enable sudo ufw disable # é–‹æ”¾é€£æ¥åŸ  sudo ufw allow 22/tcp sudo ufw allow 80/tcp sudo ufw allow 443/tcp sudo ufw allow from 192.168.1.0/24 # æ‹’çµ•é€£æ¥ sudo ufw deny 23/tcp sudo ufw deny from 192.168.2.100 # æª¢æŸ¥è¦å‰‡ sudo ufw status numbered sudo ufw delete 1 # é‡è¨­é˜²ç«ç‰† sudo ufw --force reset SSH é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # å®‰è£å’Œå•Ÿå‹• SSH sudo apt install openssh-server sudo systemctl start ssh sudo systemctl enable ssh # SSH é…ç½® sudo nano /etc/ssh/sshd_config # é‡è¦ SSH è¨­å®š Port 22 PermitRootLogin no PasswordAuthentication yes PubkeyAuthentication yes AllowUsers username # é‡å•Ÿ SSH æœå‹™ sudo systemctl restart ssh # SSH é‡‘é‘°ç®¡ç† ssh-keygen -t rsa -b 4096 ssh-copy-id user@host å®‰å…¨åŠ å›º ç³»çµ±å®‰å…¨è¨­å®š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # æ›´æ–°ç³»çµ± sudo apt update \u0026amp;\u0026amp; sudo apt upgrade -y # å®‰è£å®‰å…¨å·¥å…· sudo apt install fail2ban ufw rkhunter chkrootkit # è¨­å®š fail2ban sudo nano /etc/fail2ban/jail.local [DEFAULT] bantime = 3600 findtime = 600 maxretry = 3 [sshd] enabled = true port = ssh filter = sshd logpath = /var/log/auth.log sudo systemctl restart fail2ban # æª¢æŸ¥å®‰å…¨ç‹€æ…‹ sudo rkhunter --check sudo chkrootkit æª”æ¡ˆç³»çµ±å®‰å…¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 # è¨­å®šé©ç•¶çš„æª”æ¡ˆæ¬Šé™ sudo chmod 644 /etc/passwd sudo chmod 600 /etc/shadow sudo chmod 644 /etc/group # æŸ¥æ‰¾å…·æœ‰ç‰¹æ®Šæ¬Šé™çš„æª”æ¡ˆ find / -perm -4000 -type f 2\u0026gt;/dev/null # SUID find / -perm -2000 -type f 2\u0026gt;/dev/null # SGID find / -perm -1000 -type d 2\u0026gt;/dev/null # Sticky bit # æª”æ¡ˆç³»çµ±æƒæ sudo find / -nouser -print 2\u0026gt;/dev/null sudo find / -nogroup -print 2\u0026gt;/dev/null æ•ˆèƒ½èª¿æ•´èˆ‡æœ€ä½³åŒ– ç³»çµ±æ•ˆèƒ½ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # ç³»çµ±æ•ˆèƒ½ç›£æ§è…³æœ¬ #!/bin/bash # system_monitor.sh echo \u0026#34;=== System Performance Monitor ===\u0026#34; echo \u0026#34;Timestamp: $(date)\u0026#34; echo echo \u0026#34;=== CPU Information ===\u0026#34; echo \u0026#34;CPU Usage:\u0026#34; top -bn1 | grep \u0026#34;Cpu(s)\u0026#34; | awk \u0026#39;{print \u0026#34;CPU Load: \u0026#34; $2}\u0026#39; echo -e \u0026#34;\\nCPU Cores:\u0026#34; nproc echo \u0026#34;=== Memory Information ===\u0026#34; free -h echo -e \u0026#34;\\n=== Disk Usage ===\u0026#34; df -h | grep -E \u0026#39;^/dev/\u0026#39; echo -e \u0026#34;\\n=== Network Statistics ===\u0026#34; ss -tuln | wc -l | awk \u0026#39;{print \u0026#34;Active Connections: \u0026#34; $1}\u0026#39; echo -e \u0026#34;\\n=== System Load ===\u0026#34; uptime echo -e \u0026#34;\\n=== Top Processes by CPU ===\u0026#34; ps aux --sort=-%cpu | head -6 echo -e \u0026#34;\\n=== Top Processes by Memory ===\u0026#34; ps aux --sort=-%mem | head -6 ç³»çµ±æ¸…ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #!/bin/bash # system_cleanup.sh - ç³»çµ±æ¸…ç†è…³æœ¬ echo \u0026#34;Starting system cleanup...\u0026#34; # æ¸…ç†å¥—ä»¶å¿«å– echo \u0026#34;Cleaning package cache...\u0026#34; sudo apt autoclean sudo apt autoremove -y # æ¸…ç†æ—¥èªŒæª”æ¡ˆ echo \u0026#34;Cleaning log files...\u0026#34; sudo journalctl --vacuum-time=30d # æ¸…ç†æš«å­˜æª”æ¡ˆ echo \u0026#34;Cleaning temporary files...\u0026#34; sudo rm -rf /tmp/* sudo rm -rf /var/tmp/* # æ¸…ç†ä½¿ç”¨è€…æš«å­˜ echo \u0026#34;Cleaning user cache...\u0026#34; rm -rf ~/.cache/* rm -rf ~/.local/share/Trash/* # æ¸…ç†èˆŠæ ¸å¿ƒ echo \u0026#34;Cleaning old kernels...\u0026#34; dpkg -l | grep linux-image | awk \u0026#39;{print $2}\u0026#39; | sort -V | head -n -2 | xargs sudo apt purge -y # æª¢æŸ¥ç£ç¢Ÿç©ºé–“ echo \u0026#34;Disk space after cleanup:\u0026#34; df -h echo \u0026#34;System cleanup completed!\u0026#34; å‚™ä»½èˆ‡æ¢å¾© ç³»çµ±å‚™ä»½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 #!/bin/bash # backup_system.sh - ç³»çµ±å‚™ä»½è…³æœ¬ BACKUP_DIR=\u0026#34;/backup\u0026#34; DATE=$(date +%Y%m%d_%H%M%S) HOSTNAME=$(hostname) mkdir -p \u0026#34;$BACKUP_DIR\u0026#34; echo \u0026#34;Starting system backup...\u0026#34; # å‚™ä»½é‡è¦é…ç½®æª”æ¡ˆ echo \u0026#34;Backing up configuration files...\u0026#34; tar -czf \u0026#34;$BACKUP_DIR/config_$HOSTNAME_$DATE.tar.gz\u0026#34; \\ /etc \\ /var/log \\ /home \\ --exclude=/home/*/.cache \\ --exclude=/home/*/Downloads # å‚™ä»½å·²å®‰è£å¥—ä»¶åˆ—è¡¨ echo \u0026#34;Backing up package list...\u0026#34; dpkg --get-selections \u0026gt; \u0026#34;$BACKUP_DIR/packages_$HOSTNAME_$DATE.txt\u0026#34; apt-mark showmanual \u0026gt; \u0026#34;$BACKUP_DIR/manual_packages_$HOSTNAME_$DATE.txt\u0026#34; # å‚™ä»½ç³»çµ±è³‡è¨Š echo \u0026#34;Backing up system information...\u0026#34; { echo \u0026#34;=== System Information ===\u0026#34; uname -a lsb_release -a echo -e \u0026#34;\\n=== Hardware Information ===\u0026#34; lscpu free -h df -h echo -e \u0026#34;\\n=== Network Configuration ===\u0026#34; ip addr show } \u0026gt; \u0026#34;$BACKUP_DIR/system_info_$HOSTNAME_$DATE.txt\u0026#34; echo \u0026#34;Backup completed: $BACKUP_DIR\u0026#34; ls -la \u0026#34;$BACKUP_DIR\u0026#34;/*$DATE* ç³»çµ±æ¢å¾© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 #!/bin/bash # restore_system.sh - ç³»çµ±æ¢å¾©è…³æœ¬ BACKUP_FILE=\u0026#34;$1\u0026#34; if [ -z \u0026#34;$BACKUP_FILE\u0026#34; ]; then echo \u0026#34;Usage: $0 \u0026lt;backup_file.tar.gz\u0026gt;\u0026#34; exit 1 fi if [ ! -f \u0026#34;$BACKUP_FILE\u0026#34; ]; then echo \u0026#34;Backup file not found: $BACKUP_FILE\u0026#34; exit 1 fi echo \u0026#34;WARNING: This will restore system files from backup.\u0026#34; echo \u0026#34;Backup file: $BACKUP_FILE\u0026#34; read -p \u0026#34;Continue? (y/N): \u0026#34; confirm if [[ $confirm != [yY] ]]; then echo \u0026#34;Restore cancelled.\u0026#34; exit 0 fi echo \u0026#34;Starting system restore...\u0026#34; # å‚™ä»½ç•¶å‰é…ç½® echo \u0026#34;Backing up current configuration...\u0026#34; sudo tar -czf \u0026#34;/tmp/current_config_$(date +%Y%m%d_%H%M%S).tar.gz\u0026#34; /etc # æ¢å¾©æª”æ¡ˆ echo \u0026#34;Restoring files...\u0026#34; sudo tar -xzf \u0026#34;$BACKUP_FILE\u0026#34; -C / echo \u0026#34;Restore completed. Please reboot the system.\u0026#34; è‡ªå‹•åŒ–è…³æœ¬ ç³»çµ±åˆå§‹åŒ–è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 #!/bin/bash # ubuntu_setup.sh - Ubuntu ç³»çµ±åˆå§‹åŒ–è…³æœ¬ set -e echo \u0026#34;=== Ubuntu System Setup Script ===\u0026#34; # æ›´æ–°ç³»çµ± echo \u0026#34;Updating system...\u0026#34; sudo apt update \u0026amp;\u0026amp; sudo apt upgrade -y # å®‰è£åŸºæœ¬å·¥å…· echo \u0026#34;Installing essential tools...\u0026#34; sudo apt install -y \\ curl \\ wget \\ git \\ vim \\ htop \\ tree \\ unzip \\ zip \\ jq \\ build-essential \\ software-properties-common \\ apt-transport-https \\ ca-certificates \\ gnupg \\ lsb-release # å®‰è£é–‹ç™¼å·¥å…· echo \u0026#34;Installing development tools...\u0026#34; sudo apt install -y \\ python3 \\ python3-pip \\ nodejs \\ npm \\ default-jdk \\ golang-go # å®‰è£ Docker echo \u0026#34;Installing Docker...\u0026#34; curl -fsSL https://get.docker.com | sh sudo usermod -aG docker $USER # é…ç½® Git echo \u0026#34;Configuring Git...\u0026#34; read -p \u0026#34;Enter your Git username: \u0026#34; git_username read -p \u0026#34;Enter your Git email: \u0026#34; git_email git config --global user.name \u0026#34;$git_username\u0026#34; git config --global user.email \u0026#34;$git_email\u0026#34; # è¨­å®š SSH echo \u0026#34;Setting up SSH...\u0026#34; sudo systemctl enable ssh sudo systemctl start ssh # å®‰è£å¸¸ç”¨è»Ÿé«” echo \u0026#34;Installing common applications...\u0026#34; sudo apt install -y \\ firefox \\ vlc \\ gimp \\ libreoffice \\ thunderbird # æ¸…ç† echo \u0026#34;Cleaning up...\u0026#34; sudo apt autoremove -y sudo apt autoclean echo \u0026#34;=== Setup completed! ===\u0026#34; echo \u0026#34;Please reboot the system to ensure all changes take effect.\u0026#34; æ•…éšœæ’é™¤ å¸¸è¦‹å•é¡Œè§£æ±º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # å¥—ä»¶ç®¡ç†å•é¡Œ sudo apt update --fix-missing sudo dpkg --configure -a sudo apt install -f # ç¶²è·¯é€£æ¥å•é¡Œ sudo systemctl restart networking sudo systemctl restart systemd-resolved sudo dhclient -r \u0026amp;\u0026amp; sudo dhclient # SSH é€£æ¥å•é¡Œ sudo systemctl status ssh sudo systemctl restart ssh sudo tail -f /var/log/auth.log # ç£ç¢Ÿç©ºé–“ä¸è¶³ sudo du -sh /* | sort -hr sudo find / -type f -size +100M sudo apt autoremove sudo apt autoclean # è¨˜æ†¶é«”ä¸è¶³ free -h sudo swapoff -a \u0026amp;\u0026amp; sudo swapon -a echo 3 | sudo tee /proc/sys/vm/drop_caches ç¸½çµ æ ¸å¿ƒå„ªå‹¢ ç©©å®šå¯é ï¼šä¼æ¥­ç´šç©©å®šæ€§å’Œé•·æœŸæ”¯æ´ æ˜“æ–¼ä½¿ç”¨ï¼šå‹å¥½çš„ä½¿ç”¨è€…ä»‹é¢å’Œè±å¯Œçš„æ–‡æª” å¥—ä»¶è±å¯Œï¼šå¼·å¤§çš„ APT å¥—ä»¶ç®¡ç†ç³»çµ± ç¤¾ç¾¤æ”¯æ´ï¼šæ´»èºçš„é–‹ç™¼è€…å’Œä½¿ç”¨è€…ç¤¾ç¾¤ å®¹å™¨åŒ–å‹å¥½ï¼šå„ªç§€çš„ Docker å’Œé›²ç«¯æ”¯æ´ æœ€ä½³å¯¦è¸ å®šæœŸæ›´æ–°ï¼šä¿æŒç³»çµ±å’Œè»Ÿé«”åŒ…çš„æœ€æ–°ç‹€æ…‹ å®‰å…¨åŠ å›ºï¼šé…ç½®é˜²ç«ç‰†ã€fail2ban å’Œé©ç•¶çš„ä½¿ç”¨è€…æ¬Šé™ ç›£æ§ç³»çµ±ï¼šå®šæœŸæª¢æŸ¥ç³»çµ±æ•ˆèƒ½å’Œè³‡æºä½¿ç”¨æƒ…æ³ å‚™ä»½é‡è¦è³‡æ–™ï¼šå»ºç«‹å®šæœŸå‚™ä»½ç­–ç•¥ æ–‡æª”è¨˜éŒ„ï¼šè¨˜éŒ„ç³»çµ±é…ç½®å’Œè®Šæ›´ å­¸ç¿’è·¯å¾‘ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åˆå­¸è€…éšæ®µ sudo apt update \u0026amp;\u0026amp; sudo apt upgrade # ç³»çµ±æ›´æ–° sudo apt install package-name # è»Ÿé«”å®‰è£ systemctl status service-name # æœå‹™ç®¡ç† # é€²éšéšæ®µ docker run -it ubuntu:latest # å®¹å™¨åŒ–æ‡‰ç”¨ sudo ufw allow 80/tcp # é˜²ç«ç‰†é…ç½® sudo journalctl -u service-name # æ—¥èªŒåˆ†æ # å°ˆå®¶éšæ®µ netplan apply # ç¶²è·¯é…ç½® systemctl edit service-name # æœå‹™è‡ªå®šç¾© crontab -e # è‡ªå‹•åŒ–ä»»å‹™ Ubuntu æ˜¯ç¾ä»£ Linux ç™¼è¡Œç‰ˆçš„ä»£è¡¨ï¼ŒæŒæ¡å…¶ä½¿ç”¨æŠ€å·§èƒ½å¤ å¤§å¹…æå‡ç³»çµ±ç®¡ç†å’Œé–‹ç™¼æ•ˆç‡ã€‚è¨˜ä½ï¼šç†è§£ Linux åŸºç¤æ¦‚å¿µæ˜¯æœ‰æ•ˆä½¿ç”¨ Ubuntu çš„é—œéµï¼Œå–„ç”¨ç¤¾ç¾¤è³‡æºå’Œæ–‡æª”å¯ä»¥è§£æ±ºå¤§éƒ¨åˆ†å•é¡Œã€‚\nåƒè€ƒè³‡æ–™ Ubuntu Official Documentation Ubuntu Community Help Wiki APT User\u0026rsquo;s Guide systemd Documentation Docker on Ubuntu ","permalink":"https://xinqilin.github.io/post/tools/ubuntu/","tags":["Ubuntu","Linux","System Administration","Package Management","Docker","Server","Command Line"],"title":"Ubuntu ç³»çµ±ç®¡ç†å®Œæ•´æŒ‡å—ï¼šLinux å…¥é–€åˆ°é€²éšå¯¦æˆ°"},{"content":"Java TreeSet å®Œæ•´å¯¦ä½œæŒ‡å— ç°¡ä»‹ TreeSet æ˜¯ Java é›†åˆæ¡†æ¶ä¸­å¯¦ç¾æœ‰åºé›†åˆçš„æ ¸å¿ƒé¡åˆ¥ï¼ŒåŸºæ–¼ TreeMap å¯¦ç¾ä¸¦ä½¿ç”¨ç´…é»‘æ¨¹ï¼ˆRed-Black Treeï¼‰æ•¸æ“šçµæ§‹ã€‚å®ƒä¿è­‰å…ƒç´ çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§ï¼Œæä¾›äº† O(log n) çš„æ™‚é–“è¤‡é›œåº¦é€²è¡Œæœç´¢ã€æ’å…¥å’Œåˆªé™¤æ“ä½œã€‚æœ¬æ–‡å°‡æ·±å…¥æ¢è¨ TreeSet çš„å…§éƒ¨å¯¦ç¾ã€å„ç¨®æ–¹æ³•ä½¿ç”¨ã€æ•ˆèƒ½ç‰¹æ€§ä»¥åŠåœ¨ä¼æ¥­ç´šé–‹ç™¼ä¸­çš„æœ€ä½³å¯¦è¸ã€‚\nTreeSet æ¶æ§‹èˆ‡ç¹¼æ‰¿é—œä¿‚ é¡åˆ¥ç¹¼æ‰¿çµæ§‹ 1 2 3 4 5 6 7 8 9 Collection\u0026lt;E\u0026gt; â†‘ Set\u0026lt;E\u0026gt; â†‘ SortedSet\u0026lt;E\u0026gt; â†‘ NavigableSet\u0026lt;E\u0026gt; â†‘ TreeSet\u0026lt;E\u0026gt; æ ¸å¿ƒä»‹é¢é—œä¿‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // åŸºæœ¬é›†åˆä»‹é¢ public interface Set\u0026lt;E\u0026gt; extends Collection\u0026lt;E\u0026gt; { boolean add(E e); boolean remove(Object o); boolean contains(Object o); int size(); boolean isEmpty(); Iterator\u0026lt;E\u0026gt; iterator(); } // æœ‰åºé›†åˆä»‹é¢ public interface SortedSet\u0026lt;E\u0026gt; extends Set\u0026lt;E\u0026gt; { Comparator\u0026lt;? super E\u0026gt; comparator(); SortedSet\u0026lt;E\u0026gt; subSet(E fromElement, E toElement); SortedSet\u0026lt;E\u0026gt; headSet(E toElement); SortedSet\u0026lt;E\u0026gt; tailSet(E fromElement); E first(); E last(); } // å¯å°èˆªé›†åˆä»‹é¢ public interface NavigableSet\u0026lt;E\u0026gt; extends SortedSet\u0026lt;E\u0026gt; { E lower(E e); E floor(E e); E ceiling(E e); E higher(E e); E pollFirst(); E pollLast(); Iterator\u0026lt;E\u0026gt; iterator(); NavigableSet\u0026lt;E\u0026gt; descendingSet(); Iterator\u0026lt;E\u0026gt; descendingIterator(); NavigableSet\u0026lt;E\u0026gt; subSet(E fromElement, boolean fromInclusive, E toElement, boolean toInclusive); NavigableSet\u0026lt;E\u0026gt; headSet(E toElement, boolean inclusive); NavigableSet\u0026lt;E\u0026gt; tailSet(E fromElement, boolean inclusive); } TreeSet æ ¸å¿ƒç‰¹æ€§ 1. åŸºæ–¼ TreeMap çš„å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // TreeSet å…§éƒ¨å¯¦ç¾ public class TreeSet\u0026lt;E\u0026gt; extends AbstractSet\u0026lt;E\u0026gt; implements NavigableSet\u0026lt;E\u0026gt;, Cloneable, java.io.Serializable { // å…§éƒ¨ä½¿ç”¨ TreeMap å­˜å„²å…ƒç´  private transient NavigableMap\u0026lt;E,Object\u0026gt; m; // è™›æ“¬å€¼ï¼Œç”¨æ–¼å°‡ Set è½‰æ›ç‚º Map private static final Object PRESENT = new Object(); // æ§‹é€ å‡½æ•¸ public TreeSet() { this(new TreeMap\u0026lt;E,Object\u0026gt;()); } public TreeSet(Comparator\u0026lt;? super E\u0026gt; comparator) { this(new TreeMap\u0026lt;\u0026gt;(comparator)); } // åŸºæœ¬æ“ä½œ public boolean add(E e) { return m.put(e, PRESENT) == null; } public boolean remove(Object o) { return m.remove(o) == PRESENT; } public boolean contains(Object o) { return m.containsKey(o); } public int size() { return m.size(); } } 2. è‡ªç„¶æ’åºèˆ‡è‡ªå®šç¾©æ¯”è¼ƒå™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // è‡ªç„¶æ’åº TreeSet TreeSet\u0026lt;String\u0026gt; naturalOrder = new TreeSet\u0026lt;\u0026gt;(); naturalOrder.add(\u0026#34;Charlie\u0026#34;); naturalOrder.add(\u0026#34;Alice\u0026#34;); naturalOrder.add(\u0026#34;Bob\u0026#34;); // çµæœï¼š[Alice, Bob, Charlie] // è‡ªå®šç¾©æ¯”è¼ƒå™¨ - æŒ‰é•·åº¦æ’åº TreeSet\u0026lt;String\u0026gt; lengthOrder = new TreeSet\u0026lt;\u0026gt;( Comparator.comparing(String::length) .thenComparing(String::compareTo) // é•·åº¦ç›¸åŒæ™‚æŒ‰å­—å…¸åº ); lengthOrder.add(\u0026#34;Java\u0026#34;); lengthOrder.add(\u0026#34;C++\u0026#34;); lengthOrder.add(\u0026#34;Python\u0026#34;); lengthOrder.add(\u0026#34;Go\u0026#34;); // çµæœï¼š[Go, C++, Java, Python] // é™åºæ’åº TreeSet\u0026lt;Integer\u0026gt; descendingOrder = new TreeSet\u0026lt;\u0026gt;(Collections.reverseOrder()); descendingOrder.add(5); descendingOrder.add(2); descendingOrder.add(8); descendingOrder.add(1); // çµæœï¼š[8, 5, 2, 1] // è¤‡é›œå°è±¡æ’åº TreeSet\u0026lt;Person\u0026gt; personSet = new TreeSet\u0026lt;\u0026gt;( Comparator.comparing(Person::getAge) .thenComparing(Person::getName) ); SortedSet ä»‹é¢è©³è§£ åŸºæœ¬æ–¹æ³•å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 public class TreeSetSortedExample { public static void main(String[] args) { TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(); // æ·»åŠ å…ƒç´  treeSet.add(5); treeSet.add(2); treeSet.add(8); treeSet.add(1); treeSet.add(9); treeSet.add(3); demonstrateSortedSetMethods(treeSet); } private static void demonstrateSortedSetMethods(TreeSet\u0026lt;Integer\u0026gt; set) { System.out.println(\u0026#34;Original set: \u0026#34; + set); // [1, 2, 3, 5, 8, 9] // ç²å–æ¯”è¼ƒå™¨ Comparator\u0026lt;? super Integer\u0026gt; comparator = set.comparator(); System.out.println(\u0026#34;Comparator: \u0026#34; + comparator); // null (natural ordering) // ç¬¬ä¸€å€‹å’Œæœ€å¾Œä¸€å€‹å…ƒç´  System.out.println(\u0026#34;First element: \u0026#34; + set.first()); // 1 System.out.println(\u0026#34;Last element: \u0026#34; + set.last()); // 9 // å­é›†åˆï¼ˆå«é ­ä¸å«å°¾ï¼‰ SortedSet\u0026lt;Integer\u0026gt; subSet = set.subSet(2, 8); System.out.println(\u0026#34;SubSet [2, 8): \u0026#34; + subSet); // [2, 3, 5] // é ­éƒ¨é›†åˆï¼ˆä¸åŒ…å«æŒ‡å®šå…ƒç´ ï¼‰ SortedSet\u0026lt;Integer\u0026gt; headSet = set.headSet(5); System.out.println(\u0026#34;HeadSet (\u0026lt; 5): \u0026#34; + headSet); // [1, 2, 3] // å°¾éƒ¨é›†åˆï¼ˆåŒ…å«æŒ‡å®šå…ƒç´ ï¼‰ SortedSet\u0026lt;Integer\u0026gt; tailSet = set.tailSet(5); System.out.println(\u0026#34;TailSet (\u0026gt;= 5): \u0026#34; + tailSet); // [5, 8, 9] // è¿­ä»£å™¨ System.out.print(\u0026#34;Forward iteration: \u0026#34;); for (Integer value : set) { System.out.print(value + \u0026#34; \u0026#34;); } System.out.println(); // é™åºè¿­ä»£å™¨ System.out.print(\u0026#34;Descending iteration: \u0026#34;); Iterator\u0026lt;Integer\u0026gt; descendingIterator = set.descendingIterator(); while (descendingIterator.hasNext()) { System.out.print(descendingIterator.next() + \u0026#34; \u0026#34;); } System.out.println(); } } NavigableSet ä»‹é¢è©³è§£ å°èˆªæ–¹æ³•å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 public class TreeSetNavigableExample { public static void main(String[] args) { TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(); // æ·»åŠ æ¸¬è©¦æ•¸æ“š treeSet.add(1); treeSet.add(3); treeSet.add(5); treeSet.add(7); treeSet.add(9); demonstrateNavigableMethods(treeSet); } private static void demonstrateNavigableMethods(TreeSet\u0026lt;Integer\u0026gt; set) { System.out.println(\u0026#34;Original set: \u0026#34; + set); // [1, 3, 5, 7, 9] // Lower æ–¹æ³•ï¼šè¿”å›åš´æ ¼å°æ–¼æŒ‡å®šå…ƒç´ çš„æœ€å¤§å…ƒç´  Integer lower = set.lower(5); System.out.println(\u0026#34;Lower (\u0026lt; 5): \u0026#34; + lower); // 3 // Floor æ–¹æ³•ï¼šè¿”å›å°æ–¼æˆ–ç­‰æ–¼æŒ‡å®šå…ƒç´ çš„æœ€å¤§å…ƒç´  Integer floor1 = set.floor(4); Integer floor2 = set.floor(5); System.out.println(\u0026#34;Floor (\u0026lt;= 4): \u0026#34; + floor1); // 3 System.out.println(\u0026#34;Floor (\u0026lt;= 5): \u0026#34; + floor2); // 5 // Ceiling æ–¹æ³•ï¼šè¿”å›å¤§æ–¼æˆ–ç­‰æ–¼æŒ‡å®šå…ƒç´ çš„æœ€å°å…ƒç´  Integer ceiling1 = set.ceiling(4); Integer ceiling2 = set.ceiling(5); System.out.println(\u0026#34;Ceiling (\u0026gt;= 4): \u0026#34; + ceiling1); // 5 System.out.println(\u0026#34;Ceiling (\u0026gt;= 5): \u0026#34; + ceiling2); // 5 // Higher æ–¹æ³•ï¼šè¿”å›åš´æ ¼å¤§æ–¼æŒ‡å®šå…ƒç´ çš„æœ€å°å…ƒç´  Integer higher = set.higher(5); System.out.println(\u0026#34;Higher (\u0026gt; 5): \u0026#34; + higher); // 7 // å½ˆå‡ºé¦–å°¾å…ƒç´ ï¼ˆæœƒåˆªé™¤å…ƒç´ ï¼‰ TreeSet\u0026lt;Integer\u0026gt; copySet = new TreeSet\u0026lt;\u0026gt;(set); Integer pollFirst = copySet.pollFirst(); Integer pollLast = copySet.pollLast(); System.out.println(\u0026#34;Poll first: \u0026#34; + pollFirst); // 1 System.out.println(\u0026#34;Poll last: \u0026#34; + pollLast); // 9 System.out.println(\u0026#34;After polling: \u0026#34; + copySet); // [3, 5, 7] // é™åºè¦–åœ– NavigableSet\u0026lt;Integer\u0026gt; descendingSet = set.descendingSet(); System.out.println(\u0026#34;Descending set: \u0026#34; + descendingSet); // [9, 7, 5, 3, 1] // ç¯„åœè¦–åœ– NavigableSet\u0026lt;Integer\u0026gt; rangeSet = set.subSet(3, true, 7, false); System.out.println(\u0026#34;Range [3, 7): \u0026#34; + rangeSet); // [3, 5] NavigableSet\u0026lt;Integer\u0026gt; headSet = set.headSet(5, true); System.out.println(\u0026#34;Head set (\u0026lt;= 5): \u0026#34; + headSet); // [1, 3, 5] NavigableSet\u0026lt;Integer\u0026gt; tailSet = set.tailSet(5, false); System.out.println(\u0026#34;Tail set (\u0026gt; 5): \u0026#34; + tailSet); // [7, 9] // æŸ¥æ‰¾æ“ä½œ demonstrateSearchOperations(set); } private static void demonstrateSearchOperations(TreeSet\u0026lt;Integer\u0026gt; set) { System.out.println(\u0026#34;\\n=== Search Operations ===\u0026#34;); // æ¸¬è©¦ä¸å­˜åœ¨çš„å…ƒç´  int target = 4; System.out.println(\u0026#34;Searching for: \u0026#34; + target); System.out.println(\u0026#34;Contains: \u0026#34; + set.contains(target)); // false System.out.println(\u0026#34;Lower: \u0026#34; + set.lower(target)); // 3 System.out.println(\u0026#34;Floor: \u0026#34; + set.floor(target)); // 3 System.out.println(\u0026#34;Ceiling: \u0026#34; + set.ceiling(target)); // 5 System.out.println(\u0026#34;Higher: \u0026#34; + set.higher(target)); // 5 // æ¸¬è©¦é‚Šç•Œæƒ…æ³ System.out.println(\u0026#34;\\n=== Boundary Cases ===\u0026#34;); System.out.println(\u0026#34;Lower than first: \u0026#34; + set.lower(1)); // null System.out.println(\u0026#34;Higher than last: \u0026#34; + set.higher(9)); // null System.out.println(\u0026#34;Floor of first: \u0026#34; + set.floor(1)); // 1 System.out.println(\u0026#34;Ceiling of last: \u0026#34; + set.ceiling(9)); // 9 } } ä¼æ¥­ç´šæ‡‰ç”¨å¯¦ä¾‹ 1. äº‹ä»¶èª¿åº¦ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 public class EventScheduler { private final TreeSet\u0026lt;Event\u0026gt; eventQueue; private final ScheduledExecutorService scheduler; private final AtomicBoolean running; public EventScheduler() { // æŒ‰æ™‚é–“æ’åºäº‹ä»¶ this.eventQueue = new TreeSet\u0026lt;\u0026gt;(Comparator.comparing(Event::getScheduledTime)); this.scheduler = Executors.newScheduledThreadPool(2); this.running = new AtomicBoolean(false); } // èª¿åº¦äº‹ä»¶ public void scheduleEvent(Event event) { synchronized (eventQueue) { eventQueue.add(event); // å¦‚æœæ˜¯æœ€æ—©çš„äº‹ä»¶ï¼Œé‡æ–°èª¿åº¦ if (event.equals(eventQueue.first())) { rescheduleNext(); } } } // å–æ¶ˆäº‹ä»¶ public boolean cancelEvent(Event event) { synchronized (eventQueue) { boolean removed = eventQueue.remove(event); if (removed \u0026amp;\u0026amp; !eventQueue.isEmpty()) { rescheduleNext(); } return removed; } } // ç²å–å³å°‡åŸ·è¡Œçš„äº‹ä»¶ public List\u0026lt;Event\u0026gt; getUpcomingEvents(int count) { synchronized (eventQueue) { return eventQueue.stream() .limit(count) .collect(Collectors.toList()); } } // ç²å–æŒ‡å®šæ™‚é–“ç¯„åœå…§çš„äº‹ä»¶ public List\u0026lt;Event\u0026gt; getEventsInRange(LocalDateTime start, LocalDateTime end) { synchronized (eventQueue) { Event startEvent = new Event(\u0026#34;\u0026#34;, start, null); Event endEvent = new Event(\u0026#34;\u0026#34;, end, null); return eventQueue.subSet(startEvent, true, endEvent, false) .stream() .collect(Collectors.toList()); } } // å•Ÿå‹•èª¿åº¦å™¨ public void start() { if (running.compareAndSet(false, true)) { rescheduleNext(); } } // åœæ­¢èª¿åº¦å™¨ public void stop() { running.set(false); scheduler.shutdown(); } // é‡æ–°èª¿åº¦ä¸‹ä¸€å€‹äº‹ä»¶ private void rescheduleNext() { if (!running.get()) { return; } synchronized (eventQueue) { if (eventQueue.isEmpty()) { return; } Event nextEvent = eventQueue.first(); LocalDateTime now = LocalDateTime.now(); if (nextEvent.getScheduledTime().isBefore(now)) { // ç«‹å³åŸ·è¡ŒéæœŸäº‹ä»¶ scheduler.submit(this::processNextEvent); } else { // è¨ˆç®—å»¶é²æ™‚é–“ long delay = Duration.between(now, nextEvent.getScheduledTime()).toMillis(); scheduler.schedule(this::processNextEvent, delay, TimeUnit.MILLISECONDS); } } } // è™•ç†ä¸‹ä¸€å€‹äº‹ä»¶ private void processNextEvent() { Event event = null; synchronized (eventQueue) { if (!eventQueue.isEmpty()) { event = eventQueue.pollFirst(); } } if (event != null) { try { event.execute(); } catch (Exception e) { System.err.println(\u0026#34;Event execution failed: \u0026#34; + event.getName()); e.printStackTrace(); } } // èª¿åº¦ä¸‹ä¸€å€‹äº‹ä»¶ rescheduleNext(); } // æ¸…ç†éæœŸäº‹ä»¶ public int cleanupExpiredEvents() { synchronized (eventQueue) { LocalDateTime cutoff = LocalDateTime.now().minusHours(24); Event cutoffEvent = new Event(\u0026#34;\u0026#34;, cutoff, null); NavigableSet\u0026lt;Event\u0026gt; expiredEvents = eventQueue.headSet(cutoffEvent, true); int count = expiredEvents.size(); expiredEvents.clear(); return count; } } // ç²å–çµ±è¨ˆä¿¡æ¯ public EventStatistics getStatistics() { synchronized (eventQueue) { LocalDateTime now = LocalDateTime.now(); long pendingEvents = eventQueue.size(); long overdueEvents = eventQueue.stream() .filter(event -\u0026gt; event.getScheduledTime().isBefore(now)) .count(); LocalDateTime nextEventTime = eventQueue.isEmpty() ? null : eventQueue.first().getScheduledTime(); return new EventStatistics(pendingEvents, overdueEvents, nextEventTime); } } // äº‹ä»¶é¡ public static class Event { private final String name; private final LocalDateTime scheduledTime; private final Runnable action; public Event(String name, LocalDateTime scheduledTime, Runnable action) { this.name = name; this.scheduledTime = scheduledTime; this.action = action; } public void execute() { if (action != null) { action.run(); } } // Getters public String getName() { return name; } public LocalDateTime getScheduledTime() { return scheduledTime; } @Override public boolean equals(Object obj) { if (this == obj) return true; if (obj == null || getClass() != obj.getClass()) return false; Event event = (Event) obj; return Objects.equals(name, event.name) \u0026amp;\u0026amp; Objects.equals(scheduledTime, event.scheduledTime); } @Override public int hashCode() { return Objects.hash(name, scheduledTime); } } // çµ±è¨ˆä¿¡æ¯é¡ public static class EventStatistics { private final long pendingEvents; private final long overdueEvents; private final LocalDateTime nextEventTime; public EventStatistics(long pendingEvents, long overdueEvents, LocalDateTime nextEventTime) { this.pendingEvents = pendingEvents; this.overdueEvents = overdueEvents; this.nextEventTime = nextEventTime; } // Getters public long getPendingEvents() { return pendingEvents; } public long getOverdueEvents() { return overdueEvents; } public LocalDateTime getNextEventTime() { return nextEventTime; } } } 2. ç¯„åœæŸ¥è©¢ç·©å­˜ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 public class RangeQueryCache\u0026lt;T extends Comparable\u0026lt;T\u0026gt;\u0026gt; { private final TreeSet\u0026lt;CacheEntry\u0026lt;T\u0026gt;\u0026gt; cache; private final int maxSize; private final long ttlMillis; public RangeQueryCache(int maxSize, long ttlMillis) { this.cache = new TreeSet\u0026lt;\u0026gt;(Comparator.comparing(CacheEntry::getKey)); this.maxSize = maxSize; this.ttlMillis = ttlMillis; } // æ·»åŠ ç·©å­˜é … public void put(T key, Object value) { synchronized (cache) { // ç§»é™¤èˆŠå€¼ cache.removeIf(entry -\u0026gt; entry.getKey().equals(key)); // æ·»åŠ æ–°å€¼ CacheEntry\u0026lt;T\u0026gt; entry = new CacheEntry\u0026lt;\u0026gt;(key, value, System.currentTimeMillis() + ttlMillis); cache.add(entry); // æ¸…ç†éæœŸé … cleanupExpired(); // å¦‚æœè¶…éå®¹é‡ï¼Œç§»é™¤æœ€èˆŠçš„é … if (cache.size() \u0026gt; maxSize) { cache.pollFirst(); } } } // ç²å–å–®å€‹å€¼ public Object get(T key) { synchronized (cache) { CacheEntry\u0026lt;T\u0026gt; searchEntry = new CacheEntry\u0026lt;\u0026gt;(key, null, 0); CacheEntry\u0026lt;T\u0026gt; found = cache.floor(searchEntry); if (found != null \u0026amp;\u0026amp; found.getKey().equals(key) \u0026amp;\u0026amp; !found.isExpired()) { return found.getValue(); } return null; } } // ç¯„åœæŸ¥è©¢ public List\u0026lt;Object\u0026gt; getRangeValues(T fromKey, T toKey) { synchronized (cache) { CacheEntry\u0026lt;T\u0026gt; fromEntry = new CacheEntry\u0026lt;\u0026gt;(fromKey, null, 0); CacheEntry\u0026lt;T\u0026gt; toEntry = new CacheEntry\u0026lt;\u0026gt;(toKey, null, 0); return cache.subSet(fromEntry, true, toEntry, true) .stream() .filter(entry -\u0026gt; !entry.isExpired()) .map(CacheEntry::getValue) .collect(Collectors.toList()); } } // ç²å–æœ€æ¥è¿‘çš„å€¼ public Object getClosest(T key) { synchronized (cache) { CacheEntry\u0026lt;T\u0026gt; searchEntry = new CacheEntry\u0026lt;\u0026gt;(key, null, 0); CacheEntry\u0026lt;T\u0026gt; floor = cache.floor(searchEntry); CacheEntry\u0026lt;T\u0026gt; ceiling = cache.ceiling(searchEntry); CacheEntry\u0026lt;T\u0026gt; closest = null; if (floor != null \u0026amp;\u0026amp; !floor.isExpired()) { closest = floor; } if (ceiling != null \u0026amp;\u0026amp; !ceiling.isExpired()) { if (closest == null || key.compareTo(ceiling.getKey()) \u0026lt; closest.getKey().compareTo(key)) { closest = ceiling; } } return closest != null ? closest.getValue() : null; } } // ç²å–å‰ N å€‹å€¼ public List\u0026lt;Object\u0026gt; getTopN(int n) { synchronized (cache) { return cache.stream() .filter(entry -\u0026gt; !entry.isExpired()) .limit(n) .map(CacheEntry::getValue) .collect(Collectors.toList()); } } // æ¸…ç†éæœŸé … private void cleanupExpired() { long now = System.currentTimeMillis(); cache.removeIf(entry -\u0026gt; entry.getExpirationTime() \u0026lt; now); } // æ¸…ç©ºç·©å­˜ public void clear() { synchronized (cache) { cache.clear(); } } // ç²å–ç·©å­˜çµ±è¨ˆ public CacheStatistics getStatistics() { synchronized (cache) { cleanupExpired(); return new CacheStatistics(cache.size(), maxSize, getHitRatio()); } } private double getHitRatio() { // ç°¡åŒ–å¯¦ç¾ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­éœ€è¦è·Ÿè¹¤å‘½ä¸­ç‡ return 0.85; // ç¤ºä¾‹å€¼ } // ç·©å­˜é … private static class CacheEntry\u0026lt;T\u0026gt; { private final T key; private final Object value; private final long expirationTime; public CacheEntry(T key, Object value, long expirationTime) { this.key = key; this.value = value; this.expirationTime = expirationTime; } public boolean isExpired() { return System.currentTimeMillis() \u0026gt; expirationTime; } // Getters public T getKey() { return key; } public Object getValue() { return value; } public long getExpirationTime() { return expirationTime; } } // çµ±è¨ˆä¿¡æ¯ public static class CacheStatistics { private final int currentSize; private final int maxSize; private final double hitRatio; public CacheStatistics(int currentSize, int maxSize, double hitRatio) { this.currentSize = currentSize; this.maxSize = maxSize; this.hitRatio = hitRatio; } // Getters public int getCurrentSize() { return currentSize; } public int getMaxSize() { return maxSize; } public double getHitRatio() { return hitRatio; } } } 3. åˆ†æ•¸æ’åç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 public class LeaderboardSystem { private final TreeSet\u0026lt;Player\u0026gt; leaderboard; private final Map\u0026lt;String, Player\u0026gt; playerMap; private final int maxSize; public LeaderboardSystem(int maxSize) { // æŒ‰åˆ†æ•¸é™åºæ’åˆ—ï¼Œåˆ†æ•¸ç›¸åŒæ™‚æŒ‰åç¨±å‡åº this.leaderboard = new TreeSet\u0026lt;\u0026gt;( Comparator.comparing(Player::getScore, Comparator.reverseOrder()) .thenComparing(Player::getName) ); this.playerMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); this.maxSize = maxSize; } // æ›´æ–°ç©å®¶åˆ†æ•¸ public void updateScore(String playerName, int score) { synchronized (leaderboard) { // ç§»é™¤èˆŠè¨˜éŒ„ Player oldPlayer = playerMap.get(playerName); if (oldPlayer != null) { leaderboard.remove(oldPlayer); } // æ·»åŠ æ–°è¨˜éŒ„ Player newPlayer = new Player(playerName, score, System.currentTimeMillis()); leaderboard.add(newPlayer); playerMap.put(playerName, newPlayer); // ä¿æŒæ’è¡Œæ¦œå¤§å° if (leaderboard.size() \u0026gt; maxSize) { Player removed = leaderboard.pollLast(); playerMap.remove(removed.getName()); } } } // ç²å–æ’è¡Œæ¦œ public List\u0026lt;Player\u0026gt; getLeaderboard() { synchronized (leaderboard) { return new ArrayList\u0026lt;\u0026gt;(leaderboard); } } // ç²å–å‰ N å public List\u0026lt;Player\u0026gt; getTopN(int n) { synchronized (leaderboard) { return leaderboard.stream() .limit(n) .collect(Collectors.toList()); } } // ç²å–ç©å®¶æ’å public int getPlayerRank(String playerName) { synchronized (leaderboard) { Player player = playerMap.get(playerName); if (player == null) { return -1; } return leaderboard.headSet(player, false).size() + 1; } } // ç²å–ç©å®¶åˆ†æ•¸ public int getPlayerScore(String playerName) { Player player = playerMap.get(playerName); return player != null ? player.getScore() : -1; } // ç²å–åˆ†æ•¸ç¯„åœå…§çš„ç©å®¶ public List\u0026lt;Player\u0026gt; getPlayersInScoreRange(int minScore, int maxScore) { synchronized (leaderboard) { // å‰µå»ºé‚Šç•Œå°è±¡ Player minPlayer = new Player(\u0026#34;\u0026#34;, minScore, 0); Player maxPlayer = new Player(\u0026#34;\u0026#34;, maxScore, 0); return leaderboard.subSet(maxPlayer, true, minPlayer, true) .stream() .filter(p -\u0026gt; p.getScore() \u0026gt;= minScore \u0026amp;\u0026amp; p.getScore() \u0026lt;= maxScore) .collect(Collectors.toList()); } } // ç²å–ç©å®¶å‘¨åœçš„æ’å public List\u0026lt;Player\u0026gt; getPlayersAround(String playerName, int radius) { synchronized (leaderboard) { Player player = playerMap.get(playerName); if (player == null) { return new ArrayList\u0026lt;\u0026gt;(); } List\u0026lt;Player\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); // ç²å–å‰é¢çš„ç©å®¶ NavigableSet\u0026lt;Player\u0026gt; before = leaderboard.headSet(player, false); before.descendingSet().stream() .limit(radius) .forEach(result::add); Collections.reverse(result); // æ·»åŠ ç•¶å‰ç©å®¶ result.add(player); // ç²å–å¾Œé¢çš„ç©å®¶ NavigableSet\u0026lt;Player\u0026gt; after = leaderboard.tailSet(player, false); after.stream() .limit(radius) .forEach(result::add); return result; } } // ç§»é™¤ç©å®¶ public boolean removePlayer(String playerName) { synchronized (leaderboard) { Player player = playerMap.remove(playerName); if (player != null) { return leaderboard.remove(player); } return false; } } // æ¸…ç©ºæ’è¡Œæ¦œ public void clear() { synchronized (leaderboard) { leaderboard.clear(); playerMap.clear(); } } // ç²å–çµ±è¨ˆä¿¡æ¯ public LeaderboardStatistics getStatistics() { synchronized (leaderboard) { if (leaderboard.isEmpty()) { return new LeaderboardStatistics(0, 0, 0, 0); } int totalPlayers = leaderboard.size(); int highestScore = leaderboard.first().getScore(); int lowestScore = leaderboard.last().getScore(); double averageScore = leaderboard.stream() .mapToInt(Player::getScore) .average() .orElse(0.0); return new LeaderboardStatistics(totalPlayers, highestScore, lowestScore, averageScore); } } // ç©å®¶é¡ public static class Player { private final String name; private final int score; private final long timestamp; public Player(String name, int score, long timestamp) { this.name = name; this.score = score; this.timestamp = timestamp; } // Getters public String getName() { return name; } public int getScore() { return score; } public long getTimestamp() { return timestamp; } @Override public boolean equals(Object obj) { if (this == obj) return true; if (obj == null || getClass() != obj.getClass()) return false; Player player = (Player) obj; return score == player.score \u0026amp;\u0026amp; Objects.equals(name, player.name); } @Override public int hashCode() { return Objects.hash(name, score); } @Override public String toString() { return String.format(\u0026#34;Player{name=\u0026#39;%s\u0026#39;, score=%d}\u0026#34;, name, score); } } // çµ±è¨ˆä¿¡æ¯ public static class LeaderboardStatistics { private final int totalPlayers; private final int highestScore; private final int lowestScore; private final double averageScore; public LeaderboardStatistics(int totalPlayers, int highestScore, int lowestScore, double averageScore) { this.totalPlayers = totalPlayers; this.highestScore = highestScore; this.lowestScore = lowestScore; this.averageScore = averageScore; } // Getters public int getTotalPlayers() { return totalPlayers; } public int getHighestScore() { return highestScore; } public int getLowestScore() { return lowestScore; } public double getAverageScore() { return averageScore; } } } æ•ˆèƒ½åˆ†æèˆ‡å„ªåŒ– 1. æ™‚é–“è¤‡é›œåº¦åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 public class TreeSetPerformanceAnalysis { public static void main(String[] args) { performanceComparison(); memoryAnalysis(); concurrencyTest(); } // æ•ˆèƒ½æ¯”è¼ƒ private static void performanceComparison() { int[] sizes = {1000, 10000, 100000, 1000000}; for (int size : sizes) { System.out.println(\u0026#34;Size: \u0026#34; + size); // TreeSet æ¸¬è©¦ long startTime = System.nanoTime(); TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; size; i++) { treeSet.add(i); } long treeSetInsertTime = System.nanoTime() - startTime; // æœç´¢æ¸¬è©¦ startTime = System.nanoTime(); for (int i = 0; i \u0026lt; 1000; i++) { treeSet.contains(i * size / 1000); } long treeSetSearchTime = System.nanoTime() - startTime; // HashSet æ¯”è¼ƒ startTime = System.nanoTime(); HashSet\u0026lt;Integer\u0026gt; hashSet = new HashSet\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; size; i++) { hashSet.add(i); } long hashSetInsertTime = System.nanoTime() - startTime; startTime = System.nanoTime(); for (int i = 0; i \u0026lt; 1000; i++) { hashSet.contains(i * size / 1000); } long hashSetSearchTime = System.nanoTime() - startTime; System.out.printf(\u0026#34;TreeSet - Insert: %d ns, Search: %d ns\\n\u0026#34;, treeSetInsertTime, treeSetSearchTime); System.out.printf(\u0026#34;HashSet - Insert: %d ns, Search: %d ns\\n\\n\u0026#34;, hashSetInsertTime, hashSetSearchTime); } } // è¨˜æ†¶é«”åˆ†æ private static void memoryAnalysis() { Runtime runtime = Runtime.getRuntime(); runtime.gc(); long beforeMemory = runtime.totalMemory() - runtime.freeMemory(); TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 100000; i++) { treeSet.add(i); } long afterMemory = runtime.totalMemory() - runtime.freeMemory(); System.out.println(\u0026#34;TreeSet memory usage: \u0026#34; + (afterMemory - beforeMemory) + \u0026#34; bytes\u0026#34;); // å°æ¯” HashSet runtime.gc(); beforeMemory = runtime.totalMemory() - runtime.freeMemory(); HashSet\u0026lt;Integer\u0026gt; hashSet = new HashSet\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 100000; i++) { hashSet.add(i); } afterMemory = runtime.totalMemory() - runtime.freeMemory(); System.out.println(\u0026#34;HashSet memory usage: \u0026#34; + (afterMemory - beforeMemory) + \u0026#34; bytes\u0026#34;); } // ä¸¦ç™¼æ¸¬è©¦ private static void concurrencyTest() { TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(); ConcurrentSkipListSet\u0026lt;Integer\u0026gt; concurrentSet = new ConcurrentSkipListSet\u0026lt;\u0026gt;(); // å¡«å……åˆå§‹æ•¸æ“š for (int i = 0; i \u0026lt; 10000; i++) { treeSet.add(i); concurrentSet.add(i); } // ä¸¦ç™¼è®€å–æ¸¬è©¦ int threadCount = 4; ExecutorService executor = Executors.newFixedThreadPool(threadCount); System.out.println(\u0026#34;Concurrent read test:\u0026#34;); // TreeSet åŒæ­¥è®€å– long startTime = System.nanoTime(); CountDownLatch latch = new CountDownLatch(threadCount); for (int i = 0; i \u0026lt; threadCount; i++) { executor.submit(() -\u0026gt; { try { for (int j = 0; j \u0026lt; 10000; j++) { synchronized (treeSet) { treeSet.contains(j); } } } finally { latch.countDown(); } }); } try { latch.await(); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } long treeSetTime = System.nanoTime() - startTime; System.out.println(\u0026#34;TreeSet (synchronized): \u0026#34; + treeSetTime + \u0026#34; ns\u0026#34;); // ConcurrentSkipListSet æ¸¬è©¦ startTime = System.nanoTime(); latch = new CountDownLatch(threadCount); for (int i = 0; i \u0026lt; threadCount; i++) { executor.submit(() -\u0026gt; { try { for (int j = 0; j \u0026lt; 10000; j++) { concurrentSet.contains(j); } } finally { latch.countDown(); } }); } try { latch.await(); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } long concurrentSetTime = System.nanoTime() - startTime; System.out.println(\u0026#34;ConcurrentSkipListSet: \u0026#34; + concurrentSetTime + \u0026#34; ns\u0026#34;); executor.shutdown(); } } 2. æœ€ä½³åŒ–å»ºè­° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 public class TreeSetOptimizationTips { // 1. ä½¿ç”¨é©ç•¶çš„æ¯”è¼ƒå™¨ public static void comparatorOptimization() { // é¿å…åœ¨æ¯”è¼ƒå™¨ä¸­é€²è¡Œè¤‡é›œè¨ˆç®— TreeSet\u0026lt;String\u0026gt; badExample = new TreeSet\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { // å£ä¾‹å­ï¼šæ¯æ¬¡æ¯”è¼ƒéƒ½é€²è¡Œæ˜‚è²´çš„è¨ˆç®— return expensiveCalculation(s1) - expensiveCalculation(s2); }); // å¥½ä¾‹å­ï¼šé å…ˆè¨ˆç®—æˆ–ä½¿ç”¨ç·©å­˜ Map\u0026lt;String, Integer\u0026gt; cache = new ConcurrentHashMap\u0026lt;\u0026gt;(); TreeSet\u0026lt;String\u0026gt; goodExample = new TreeSet\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { int val1 = cache.computeIfAbsent(s1, TreeSetOptimizationTips::expensiveCalculation); int val2 = cache.computeIfAbsent(s2, TreeSetOptimizationTips::expensiveCalculation); return val1 - val2; }); } // 2. æ‰¹é‡æ“ä½œå„ªåŒ– public static void batchOperationOptimization() { TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(); // æ‰¹é‡æ·»åŠ æ¯”å–®å€‹æ·»åŠ æ•ˆç‡æ›´é«˜ Collection\u0026lt;Integer\u0026gt; batchData = Arrays.asList(1, 2, 3, 4, 5); treeSet.addAll(batchData); // ä½¿ç”¨å­é›†åˆé€²è¡Œæ‰¹é‡æ“ä½œ NavigableSet\u0026lt;Integer\u0026gt; subSet = treeSet.subSet(2, true, 4, false); subSet.clear(); // æ¯”é€å€‹åˆªé™¤æ•ˆç‡æ›´é«˜ } // 3. è¨˜æ†¶é«”å„ªåŒ– public static void memoryOptimization() { // ä½¿ç”¨åŸå§‹é¡å‹åŒ…è£å™¨æ™‚æ³¨æ„è‡ªå‹•è£ç®± TreeSet\u0026lt;Integer\u0026gt; set = new TreeSet\u0026lt;\u0026gt;(); // é¿å…ä¸å¿…è¦çš„å°è±¡å‰µå»º for (int i = 0; i \u0026lt; 1000; i++) { set.add(i); // æœƒå‰µå»º Integer å°è±¡ } // è€ƒæ…®ä½¿ç”¨å°ˆé–€çš„åŸå§‹é¡å‹é›†åˆåº« // å¦‚ Eclipse Collections çš„ IntSortedSet } // 4. ä¸¦ç™¼å„ªåŒ– public static void concurrencyOptimization() { TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(); // ä½¿ç”¨ ConcurrentSkipListSet æ›¿ä»£åŒæ­¥çš„ TreeSet ConcurrentSkipListSet\u0026lt;Integer\u0026gt; concurrentSet = new ConcurrentSkipListSet\u0026lt;\u0026gt;(); // æˆ–è€…ä½¿ç”¨è®€å¯«é– ReadWriteLock lock = new ReentrantReadWriteLock(); ReadLock readLock = lock.readLock(); WriteLock writeLock = lock.writeLock(); // è®€æ“ä½œ readLock.lock(); try { treeSet.contains(1); } finally { readLock.unlock(); } // å¯«æ“ä½œ writeLock.lock(); try { treeSet.add(1); } finally { writeLock.unlock(); } } private static int expensiveCalculation(String s) { // æ¨¡æ“¬æ˜‚è²´çš„è¨ˆç®— return s.hashCode() * 31; } } å¯¦éš›æ‡‰ç”¨å ´æ™¯ 1. LeetCode å•é¡Œè§£æ±º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 public class TreeSetLeetCodeSolutions { // LeetCode 1845: åº§ä½é ç´„ç®¡ç†ç³»çµ± static class SeatManager { private TreeSet\u0026lt;Integer\u0026gt; availableSeats; public SeatManager(int n) { availableSeats = new TreeSet\u0026lt;\u0026gt;(); for (int i = 1; i \u0026lt;= n; i++) { availableSeats.add(i); } } public int reserve() { return availableSeats.pollFirst(); } public void unreserve(int seatNumber) { availableSeats.add(seatNumber); } } // LeetCode 855: è€ƒå ´å°±åº§ static class ExamRoom { private TreeSet\u0026lt;Integer\u0026gt; seats; private int n; public ExamRoom(int n) { this.n = n; this.seats = new TreeSet\u0026lt;\u0026gt;(); } public int seat() { int seat = 0; if (!seats.isEmpty()) { int maxDistance = seats.first(); // æª¢æŸ¥ä¸­é–“ä½ç½® Integer prev = null; for (Integer s : seats) { if (prev != null) { int distance = (s - prev) / 2; if (distance \u0026gt; maxDistance) { maxDistance = distance; seat = prev + distance; } } prev = s; } // æª¢æŸ¥æœ€å¾Œä½ç½® if (n - 1 - seats.last() \u0026gt; maxDistance) { seat = n - 1; } } seats.add(seat); return seat; } public void leave(int p) { seats.remove(p); } } // LeetCode 895: æœ€å¤§é »ç‡æ£§ static class FreqStack { private TreeSet\u0026lt;Element\u0026gt; elements; private Map\u0026lt;Integer, Integer\u0026gt; freq; private int timestamp; public FreqStack() { elements = new TreeSet\u0026lt;\u0026gt;((a, b) -\u0026gt; { if (a.frequency != b.frequency) { return b.frequency - a.frequency; // é »ç‡é™åº } return b.timestamp - a.timestamp; // æ™‚é–“é™åº }); freq = new HashMap\u0026lt;\u0026gt;(); timestamp = 0; } public void push(int x) { int oldFreq = freq.getOrDefault(x, 0); int newFreq = oldFreq + 1; if (oldFreq \u0026gt; 0) { elements.remove(new Element(x, oldFreq, -1)); } elements.add(new Element(x, newFreq, timestamp++)); freq.put(x, newFreq); } public int pop() { Element top = elements.pollFirst(); int val = top.value; int newFreq = freq.get(val) - 1; if (newFreq \u0026gt; 0) { freq.put(val, newFreq); elements.add(new Element(val, newFreq, timestamp++)); } else { freq.remove(val); } return val; } static class Element { int value; int frequency; int timestamp; Element(int value, int frequency, int timestamp) { this.value = value; this.frequency = frequency; this.timestamp = timestamp; } @Override public boolean equals(Object obj) { if (this == obj) return true; if (obj == null || getClass() != obj.getClass()) return false; Element element = (Element) obj; return value == element.value \u0026amp;\u0026amp; frequency == element.frequency; } @Override public int hashCode() { return Objects.hash(value, frequency); } } } // LeetCode 1499: æ»¿è¶³ä¸ç­‰å¼çš„æœ€å¤§å€¼ public int findMaxValueOfEquation(int[][] points, int k) { // ä½¿ç”¨ TreeSet ç¶­è­·æ»‘å‹•çª—å£ TreeSet\u0026lt;Point\u0026gt; window = new TreeSet\u0026lt;\u0026gt;((a, b) -\u0026gt; { if (a.yMinusX != b.yMinusX) { return b.yMinusX - a.yMinusX; // æŒ‰ y-x é™åº } return a.x - b.x; // æŒ‰ x å‡åº }); int maxValue = Integer.MIN_VALUE; for (int[] point : points) { int x = point[0]; int y = point[1]; // ç§»é™¤çª—å£å¤–çš„é» window.removeIf(p -\u0026gt; x - p.x \u0026gt; k); // å¦‚æœçª—å£ä¸ç‚ºç©ºï¼Œè¨ˆç®—æœ€å¤§å€¼ if (!window.isEmpty()) { Point best = window.first(); maxValue = Math.max(maxValue, y + x + best.yMinusX); } // æ·»åŠ ç•¶å‰é» window.add(new Point(x, y - x)); } return maxValue; } static class Point { int x; int yMinusX; Point(int x, int yMinusX) { this.x = x; this.yMinusX = yMinusX; } } } 2. æ•¸æ“šçµæ§‹æ‡‰ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 public class TreeSetDataStructureApplications { // æ»‘å‹•çª—å£æœ€å¤§å€¼ public static class SlidingWindowMaximum { private TreeSet\u0026lt;Element\u0026gt; window; private int windowSize; private int index; public SlidingWindowMaximum(int windowSize) { this.window = new TreeSet\u0026lt;\u0026gt;((a, b) -\u0026gt; { if (a.value != b.value) { return b.value - a.value; // å€¼é™åº } return a.index - b.index; // ç´¢å¼•å‡åº }); this.windowSize = windowSize; this.index = 0; } public void addNumber(int num) { // æ·»åŠ æ–°å…ƒç´  window.add(new Element(num, index)); // ç§»é™¤çª—å£å¤–çš„å…ƒç´  if (index \u0026gt;= windowSize) { window.removeIf(e -\u0026gt; e.index \u0026lt;= index - windowSize); } index++; } public int getMaximum() { return window.isEmpty() ? 0 : window.first().value; } static class Element { int value; int index; Element(int value, int index) { this.value = value; this.index = index; } } } // å‹•æ…‹ä¸­ä½æ•¸ public static class DynamicMedian { private TreeSet\u0026lt;Element\u0026gt; elements; private int index; public DynamicMedian() { this.elements = new TreeSet\u0026lt;\u0026gt;((a, b) -\u0026gt; { if (a.value != b.value) { return a.value - b.value; // å€¼å‡åº } return a.index - b.index; // ç´¢å¼•å‡åº }); this.index = 0; } public void addNumber(int num) { elements.add(new Element(num, index++)); } public double getMedian() { int size = elements.size(); if (size == 0) return 0; List\u0026lt;Element\u0026gt; sortedElements = new ArrayList\u0026lt;\u0026gt;(elements); if (size % 2 == 1) { return sortedElements.get(size / 2).value; } else { return (sortedElements.get(size / 2 - 1).value + sortedElements.get(size / 2).value) / 2.0; } } static class Element { int value; int index; Element(int value, int index) { this.value = value; this.index = index; } } } // å€é–“èª¿åº¦ public static class IntervalScheduler { private TreeSet\u0026lt;Interval\u0026gt; intervals; public IntervalScheduler() { this.intervals = new TreeSet\u0026lt;\u0026gt;(Comparator.comparing(Interval::getStart)); } public boolean canSchedule(int start, int end) { Interval newInterval = new Interval(start, end); // æª¢æŸ¥æ˜¯å¦èˆ‡ç¾æœ‰å€é–“é‡ç–Š Interval floor = intervals.floor(newInterval); if (floor != null \u0026amp;\u0026amp; floor.getEnd() \u0026gt; start) { return false; } Interval ceiling = intervals.ceiling(newInterval); if (ceiling != null \u0026amp;\u0026amp; ceiling.getStart() \u0026lt; end) { return false; } return true; } public boolean schedule(int start, int end) { if (canSchedule(start, end)) { intervals.add(new Interval(start, end)); return true; } return false; } public List\u0026lt;Interval\u0026gt; getSchedule() { return new ArrayList\u0026lt;\u0026gt;(intervals); } static class Interval { private final int start; private final int end; public Interval(int start, int end) { this.start = start; this.end = end; } public int getStart() { return start; } public int getEnd() { return end; } @Override public boolean equals(Object obj) { if (this == obj) return true; if (obj == null || getClass() != obj.getClass()) return false; Interval interval = (Interval) obj; return start == interval.start \u0026amp;\u0026amp; end == interval.end; } @Override public int hashCode() { return Objects.hash(start, end); } } } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. é¸æ“‡é©ç•¶çš„æ¯”è¼ƒç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 public class TreeSetBestPractices { // 1. è‡ªç„¶æ’åº vs è‡ªå®šç¾©æ¯”è¼ƒå™¨ public static void comparatorChoice() { // å°æ–¼å¯¦ç¾ Comparable çš„é¡å‹ï¼Œä½¿ç”¨è‡ªç„¶æ’åº TreeSet\u0026lt;String\u0026gt; naturalOrder = new TreeSet\u0026lt;\u0026gt;(); // å°æ–¼éœ€è¦è‡ªå®šç¾©æ’åºçš„æƒ…æ³ï¼Œä½¿ç”¨æ¯”è¼ƒå™¨ TreeSet\u0026lt;String\u0026gt; customOrder = new TreeSet\u0026lt;\u0026gt;(String.CASE_INSENSITIVE_ORDER); // è¤‡é›œå°è±¡çš„å¤šå­—æ®µæ’åº TreeSet\u0026lt;Person\u0026gt; personSet = new TreeSet\u0026lt;\u0026gt;( Comparator.comparing(Person::getAge) .thenComparing(Person::getName) ); } // 2. ç©ºå€¼è™•ç† public static void nullHandling() { // TreeSet ä¸å…è¨± null å…ƒç´  TreeSet\u0026lt;String\u0026gt; set = new TreeSet\u0026lt;\u0026gt;(); // set.add(null); // æœƒæ‹‹å‡º NullPointerException // å¦‚æœéœ€è¦æ”¯æŒ null å€¼ï¼Œä½¿ç”¨è‡ªå®šç¾©æ¯”è¼ƒå™¨ TreeSet\u0026lt;String\u0026gt; nullSafeSet = new TreeSet\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { if (s1 == null \u0026amp;\u0026amp; s2 == null) return 0; if (s1 == null) return -1; if (s2 == null) return 1; return s1.compareTo(s2); }); } // 3. ç·šç¨‹å®‰å…¨è™•ç† public static void threadSafety() { TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(); // æ–¹æ³•1ï¼šä½¿ç”¨ Collections.synchronizedSet Set\u0026lt;Integer\u0026gt; syncSet = Collections.synchronizedSet(treeSet); // æ–¹æ³•2ï¼šä½¿ç”¨ ConcurrentSkipListSet ConcurrentSkipListSet\u0026lt;Integer\u0026gt; concurrentSet = new ConcurrentSkipListSet\u0026lt;\u0026gt;(); // æ–¹æ³•3ï¼šä½¿ç”¨è®€å¯«é– ReadWriteLock lock = new ReentrantReadWriteLock(); // åœ¨è®€å¯«æ“ä½œæ™‚ä½¿ç”¨ç›¸æ‡‰çš„é– } // 4. æ•ˆèƒ½è€ƒæ…® public static void performanceConsiderations() { // æ‰¹é‡æ·»åŠ æ¯”å–®å€‹æ·»åŠ æ•ˆç‡æ›´é«˜ Collection\u0026lt;Integer\u0026gt; data = Arrays.asList(1, 2, 3, 4, 5); TreeSet\u0026lt;Integer\u0026gt; treeSet = new TreeSet\u0026lt;\u0026gt;(data); // é¿å…é »ç¹çš„ç¯„åœæŸ¥è©¢æ“ä½œ NavigableSet\u0026lt;Integer\u0026gt; subSet = treeSet.subSet(2, true, 4, false); // å° subSet çš„æ“ä½œæœƒå½±éŸ¿åŸå§‹ set } static class Person { private String name; private int age; public Person(String name, int age) { this.name = name; this.age = age; } public String getName() { return name; } public int getAge() { return age; } } } 2. å¸¸è¦‹éŒ¯èª¤é¿å… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 public class TreeSetCommonMistakes { // éŒ¯èª¤1ï¼šåœ¨è¿­ä»£éç¨‹ä¸­ä¿®æ”¹ TreeSet public static void avoidConcurrentModification() { TreeSet\u0026lt;Integer\u0026gt; set = new TreeSet\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 10; i++) { set.add(i); } // éŒ¯èª¤çš„åšæ³• // for (Integer value : set) { // if (value % 2 == 0) { // set.remove(value); // ConcurrentModificationException // } // } // æ­£ç¢ºçš„åšæ³•1ï¼šä½¿ç”¨è¿­ä»£å™¨ Iterator\u0026lt;Integer\u0026gt; iterator = set.iterator(); while (iterator.hasNext()) { if (iterator.next() % 2 == 0) { iterator.remove(); } } // æ­£ç¢ºçš„åšæ³•2ï¼šæ”¶é›†è¦åˆªé™¤çš„å…ƒç´  Set\u0026lt;Integer\u0026gt; toRemove = set.stream() .filter(value -\u0026gt; value % 2 == 0) .collect(Collectors.toSet()); set.removeAll(toRemove); } // éŒ¯èª¤2ï¼šæ¯”è¼ƒå™¨ä¸ä¸€è‡´ public static void avoidInconsistentComparator() { // éŒ¯èª¤ï¼šæ¯”è¼ƒå™¨èˆ‡ equals ä¸ä¸€è‡´ TreeSet\u0026lt;String\u0026gt; badSet = new TreeSet\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { return s1.length() - s2.length(); // åªæ¯”è¼ƒé•·åº¦ }); badSet.add(\u0026#34;abc\u0026#34;); badSet.add(\u0026#34;def\u0026#34;); // æœƒè¢«å¿½ç•¥ï¼Œå› ç‚ºé•·åº¦ç›¸åŒ // æ­£ç¢ºï¼šç¢ºä¿æ¯”è¼ƒå™¨ä¸€è‡´æ€§ TreeSet\u0026lt;String\u0026gt; goodSet = new TreeSet\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { int lengthCompare = s1.length() - s2.length(); if (lengthCompare != 0) { return lengthCompare; } return s1.compareTo(s2); // é•·åº¦ç›¸åŒæ™‚æ¯”è¼ƒå…§å®¹ }); } // éŒ¯èª¤3ï¼šèª¤ç”¨å­é›†åˆ public static void avoidSubSetMisuse() { TreeSet\u0026lt;Integer\u0026gt; set = new TreeSet\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 10; i++) { set.add(i); } // éŒ¯èª¤ï¼šèªç‚ºå­é›†åˆæ˜¯ç¨ç«‹çš„ NavigableSet\u0026lt;Integer\u0026gt; subSet = set.subSet(2, true, 8, false); subSet.clear(); // é€™æœƒå½±éŸ¿åŸå§‹ set // æ­£ç¢ºï¼šå¦‚æœéœ€è¦ç¨ç«‹çš„å‰¯æœ¬ NavigableSet\u0026lt;Integer\u0026gt; independentCopy = new TreeSet\u0026lt;\u0026gt;(subSet); } } ç¸½çµ TreeSet æ˜¯ Java é›†åˆæ¡†æ¶ä¸­åŠŸèƒ½å¼·å¤§çš„æœ‰åºé›†åˆå¯¦ç¾ï¼ŒåŸºæ–¼ç´…é»‘æ¨¹æä¾›äº† O(log n) çš„é«˜æ•ˆæ“ä½œã€‚é€šéæœ¬æ–‡çš„æ·±å…¥åˆ†æï¼Œæˆ‘å€‘äº†è§£äº†ï¼š\næ ¸å¿ƒç‰¹æ€§ï¼šåŸºæ–¼ TreeMap çš„æœ‰åºå­˜å„²ï¼Œæ”¯æŒè‡ªç„¶æ’åºå’Œè‡ªå®šç¾©æ¯”è¼ƒå™¨ ä»‹é¢å±¤æ¬¡ï¼šå¾ Set åˆ° SortedSet å†åˆ° NavigableSet çš„å®Œæ•´åŠŸèƒ½ å¯¦ç”¨æ–¹æ³•ï¼šè±å¯Œçš„ç¯„åœæŸ¥è©¢ã€å°èˆªæ“ä½œå’Œè¦–åœ–æ–¹æ³• ä¼æ¥­æ‡‰ç”¨ï¼šäº‹ä»¶èª¿åº¦ã€ç¯„åœæŸ¥è©¢ã€æ’åç³»çµ±ç­‰å¯¦éš›å ´æ™¯ æ•ˆèƒ½å„ªåŒ–ï¼šæ¯”è¼ƒå™¨å„ªåŒ–ã€æ‰¹é‡æ“ä½œã€ä¸¦ç™¼è™•ç†ç­‰æœ€ä½³å¯¦è¸ å¸¸è¦‹é™·é˜±ï¼šä¸¦ç™¼ä¿®æ”¹ã€æ¯”è¼ƒå™¨ä¸€è‡´æ€§ã€å­é›†åˆä½¿ç”¨ç­‰éœ€è¦æ³¨æ„çš„å•é¡Œ æ­£ç¢ºä½¿ç”¨ TreeSet å¯ä»¥åœ¨éœ€è¦æœ‰åºé›†åˆçš„å ´æ™¯ä¸­æä¾›é«˜æ•ˆã€å¯é çš„è§£æ±ºæ–¹æ¡ˆï¼Œæ˜¯ Java é–‹ç™¼è€…å¿…é ˆæŒæ¡çš„é‡è¦å·¥å…·ä¹‹ä¸€ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/treeset/","tags":["Java","TreeSet","Data Structure","Red-Black Tree","Collections","Sorting","NavigableSet","SortedSet","Binary Search Tree","Performance","Algorithms","Enterprise","Best Practices","Thread Safety","Concurrency"],"title":"Java TreeSet å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šç´…é»‘æ¨¹æœ‰åºé›†åˆèˆ‡ NavigableSet ä»‹é¢è©³è§£"},{"content":"æ¦‚è¿° åœ¨æ’°å¯« Shell Script æ™‚ï¼Œæˆ‘å€‘ç¶“å¸¸éœ€è¦å°æª”æ¡ˆã€ç›®éŒ„æˆ–å­—ä¸²çš„ç‹€æ…‹é€²è¡Œåˆ¤æ–·ï¼Œä¾‹å¦‚æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€æ˜¯å¦å¯è®€ï¼Œæˆ–åˆ¤æ–·å­—ä¸²æ˜¯å¦ç‚ºç©ºã€‚é€™æ™‚å°±éœ€è¦ä½¿ç”¨æ¸¬è©¦è¡¨é”å¼ [ ... ] æˆ– test æŒ‡ä»¤ã€‚æœ¬æ–‡å°‡è©³ç´°ä»‹ç´¹é€™äº›å¸¸ç”¨çš„è¡¨é”å¼åŠå…¶ç”¨æ³•ã€‚\næª”æ¡ˆæ¸¬è©¦è¡¨é”å¼ æª”æ¡ˆæ¸¬è©¦è¡¨é”å¼ç”¨æ–¼åˆ¤æ–·æª”æ¡ˆçš„é¡å‹æˆ–æ¬Šé™ç‹€æ…‹ã€‚å…¶å›å‚³å€¼ç‚ºå¸ƒæ—å€¼ï¼ˆtrue æˆ– falseï¼‰ï¼Œå¯æ­é… if æ¢ä»¶å¼ä½¿ç”¨ã€‚\nèªæ³• 1 2 3 if [ -\u0026lt;operator\u0026gt; \u0026lt;filename\u0026gt; ]; then # do something fi å¸¸ç”¨é‹ç®—å­ é‹ç®—å­ èªªæ˜ ç¯„ä¾‹ -e å¦‚æœæª”æ¡ˆå­˜åœ¨ (exist)ï¼Œå‰‡ç‚º true [ -e /etc/hosts ] -d å¦‚æœæª”æ¡ˆæ˜¯ç›®éŒ„ (directory)ï¼Œå‰‡ç‚º true [ -d /home/user ] -f å¦‚æœæª”æ¡ˆæ˜¯å¸¸è¦æª”æ¡ˆ (regular file)ï¼Œå‰‡ç‚º true [ -f /etc/passwd ] -L å¦‚æœæª”æ¡ˆæ˜¯ç¬¦è™Ÿé€£çµ (symbolic link)ï¼Œå‰‡ç‚º true [ -L /usr/bin/python ] -h èˆ‡ -L ç›¸åŒï¼Œå¦‚æœæª”æ¡ˆæ˜¯ç¬¦è™Ÿé€£çµï¼Œå‰‡ç‚º true [ -h /usr/bin/python ] -r å¦‚æœæª”æ¡ˆå¯è®€ (readable)ï¼Œå‰‡ç‚º true [ -r /etc/shadow ] -w å¦‚æœæª”æ¡ˆå¯å¯« (writable)ï¼Œå‰‡ç‚º true [ -w /tmp/test.log ] -x å¦‚æœæª”æ¡ˆå¯åŸ·è¡Œ (executable)ï¼Œå‰‡ç‚º true [ -x ./deploy.sh ] -s å¦‚æœæª”æ¡ˆå¤§å°ä¸ç‚º 0ï¼Œå‰‡ç‚º true [ -s /var/log/syslog ] æª”æ¡ˆæ¯”è¼ƒé‹ç®—å­ ç”¨æ–¼æ¯”è¼ƒå…©å€‹æª”æ¡ˆçš„æ–°èˆŠé—œä¿‚ã€‚\né‹ç®—å­ èªªæ˜ ç¯„ä¾‹ f1 -nt f2 å¦‚æœæª”æ¡ˆ f1 æ¯” f2 æ–° (newer than)ï¼Œå‰‡ç‚º true [ file1.log -nt file2.log ] f1 -ot f2 å¦‚æœæª”æ¡ˆ f1 æ¯” f2 èˆŠ (older than)ï¼Œå‰‡ç‚º true [ file1.log -ot file2.log ] å­—ä¸²èˆ‡æ•¸å€¼æ¸¬è©¦è¡¨é”å¼ é™¤äº†æª”æ¡ˆï¼Œæ¸¬è©¦è¡¨é”å¼ä¹Ÿå¸¸ç”¨æ–¼æ¯”è¼ƒæ•¸å€¼æˆ–åˆ¤æ–·å­—ä¸²ç‹€æ…‹ã€‚\næ•¸å€¼æ¯”è¼ƒ é‹ç®—å­ èªªæ˜ ç­‰åƒ¹ç¬¦è™Ÿ -eq ç­‰æ–¼ (equal) == -ne ä¸ç­‰æ–¼ (not equal) != -gt å¤§æ–¼ (greater than) \u0026gt; -ge å¤§æ–¼æˆ–ç­‰æ–¼ (greater or equal) \u0026gt;= -lt å°æ–¼ (less than) \u0026lt; -le å°æ–¼æˆ–ç­‰æ–¼ (less or equal) \u0026lt;= å­—ä¸²æ¯”è¼ƒ é‹ç®—å­ èªªæ˜ ç¯„ä¾‹ -n å¦‚æœå­—ä¸²é•·åº¦ä¸ç‚º 0ï¼Œå‰‡ç‚º true [ -n \u0026quot;$my_var\u0026quot; ] -z å¦‚æœå­—ä¸²é•·åº¦ç‚º 0 (zero)ï¼Œå‰‡ç‚º true [ -z \u0026quot;$my_var\u0026quot; ] $string å¦‚æœå­—ä¸²ä¸ç‚ºç©ºï¼Œå‰‡ç‚º true (èˆ‡ -n æ•ˆæœç›¸åŒ) [ \u0026quot;$my_var\u0026quot; ] é‚è¼¯é‹ç®—å­ ç”¨æ–¼çµ„åˆå¤šå€‹è¡¨é”å¼ã€‚\né‹ç®—å­ èªªæ˜ ç¯„ä¾‹ ! NOTï¼šåè½‰è¡¨é”å¼çš„çµæœ [ ! -d /tmp/non_existent ] -a ANDï¼šå…©å€‹è¡¨é”å¼éƒ½ç‚º true æ™‚ï¼Œçµæœæ‰ç‚º true [ -r \u0026quot;$file\u0026quot; -a -s \u0026quot;$file\u0026quot; ] -o ORï¼šå…©å€‹è¡¨é”å¼åªè¦æœ‰ä¸€å€‹ç‚º trueï¼Œçµæœå°±ç‚º true [ -d \u0026quot;$dir\u0026quot; -o -f \u0026quot;$dir\u0026quot; ] æ³¨æ„ï¼šå»ºè­°ä½¿ç”¨ \u0026amp;\u0026amp; å’Œ || ä¾†å–ä»£ -a å’Œ -oï¼Œå› ç‚ºå®ƒå€‘æ›´ç¬¦åˆç¾ä»£ Shell çš„æ¨™æº–ä¸”æ›´å®‰å…¨ã€‚\n1 2 3 4 5 6 7 8 9 # ä½¿ç”¨ \u0026amp;\u0026amp; (AND) if [ -r \u0026#34;$file\u0026#34; ] \u0026amp;\u0026amp; [ -s \u0026#34;$file\u0026#34; ]; then echo \u0026#34;æª”æ¡ˆå¯è®€ä¸”å…§å®¹ä¸ç‚ºç©º\u0026#34; fi # ä½¿ç”¨ || (OR) if [ -d \u0026#34;$path\u0026#34; ] || [ -f \u0026#34;$path\u0026#34; ]; then echo \u0026#34;è·¯å¾‘æ˜¯ä¸€å€‹ç›®éŒ„æˆ–æª”æ¡ˆ\u0026#34; fi å¯¦ç”¨ç¯„ä¾‹ ç¯„ä¾‹ 1ï¼šæª¢æŸ¥ç›®éŒ„æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å»ºç«‹ 1 2 3 4 5 6 7 8 9 10 #!/bin/bash LOG_DIR=\u0026#34;/var/log/myapp\u0026#34; if [ ! -d \u0026#34;$LOG_DIR\u0026#34; ]; then echo \u0026#34;æ—¥èªŒç›®éŒ„ä¸å­˜åœ¨ï¼Œæ­£åœ¨å»ºç«‹: $LOG_DIR\u0026#34; mkdir -p \u0026#34;$LOG_DIR\u0026#34; else echo \u0026#34;æ—¥èªŒç›®éŒ„å·²å­˜åœ¨ã€‚\u0026#34; fi ç¯„ä¾‹ 2ï¼šæª¢æŸ¥å­—ä¸²è®Šæ•¸æ˜¯å¦ç‚ºç©º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #!/bin/bash USERNAME=\u0026#34;\u0026#34; # ... å¾æŸè™•è®€å–ä½¿ç”¨è€…åç¨± ... if [ -z \u0026#34;$USERNAME\u0026#34; ]; then echo \u0026#34;éŒ¯èª¤ï¼šä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©ºï¼\u0026#34; exit 1 fi # å¦ä¸€ç¨®å¯«æ³• if [ ! \u0026#34;$USERNAME\u0026#34; ]; then echo \u0026#34;éŒ¯èª¤ï¼šä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©ºï¼\u0026#34; exit 1 fi ç¯„ä¾‹ 3ï¼šçµåˆå¤šå€‹æ¢ä»¶ 1 2 3 4 5 6 7 8 9 10 #!/bin/bash CONFIG_FILE=\u0026#34;config.conf\u0026#34; if [ -f \u0026#34;$CONFIG_FILE\u0026#34; ] \u0026amp;\u0026amp; [ -r \u0026#34;$CONFIG_FILE\u0026#34; ]; then echo \u0026#34;è¨­å®šæª”å­˜åœ¨ä¸”å¯è®€å–ï¼Œè¼‰å…¥è¨­å®š...\u0026#34; source \u0026#34;$CONFIG_FILE\u0026#34; else echo \u0026#34;è­¦å‘Šï¼šæ‰¾ä¸åˆ°è¨­å®šæª”æˆ–ç„¡æ³•è®€å–ã€‚\u0026#34; fi ","permalink":"https://xinqilin.github.io/post/tools/fileexpress/","tags":["Shell","Bash","File System","Scripting"],"title":"Shell æª”æ¡ˆèˆ‡å­—ä¸²è¡¨é”å¼è©³è§£"},{"content":"æ¦‚è¿° éˆè¡¨åè½‰æ˜¯æ•¸æ“šçµæ§‹èˆ‡æ¼”ç®—æ³•ä¸­çš„ç¶“å…¸å•é¡Œï¼Œè¦æ±‚å°‡å–®å‘éˆè¡¨çš„æŒ‡å‘é—œä¿‚å®Œå…¨åè½‰ã€‚é€™å€‹å•é¡Œçœ‹ä¼¼ç°¡å–®ï¼Œä½†æ¶‰åŠåˆ°æŒ‡æ¨™æ“ä½œçš„ç´°ç¯€ï¼Œæ˜¯è€ƒé©—ç·¨ç¨‹åŸºæœ¬åŠŸçš„é‡è¦é¡Œå‹ã€‚\nå•é¡Œå®šç¾© çµ¦å®šä¸€å€‹å–®å‘éˆè¡¨ï¼Œå°‡å…¶åè½‰ä¸¦å›å‚³æ–°çš„é ­ç¯€é»ã€‚\nç¯„ä¾‹ï¼š\n1 2 è¼¸å…¥ï¼š1 -\u0026gt; 2 -\u0026gt; 3 -\u0026gt; 4 -\u0026gt; 5 -\u0026gt; NULL è¼¸å‡ºï¼š5 -\u0026gt; 4 -\u0026gt; 3 -\u0026gt; 2 -\u0026gt; 1 -\u0026gt; NULL éˆè¡¨ç¯€é»å®šç¾© 1 2 3 4 5 6 7 8 9 10 11 public class ListNode { int val; ListNode next; ListNode() {} ListNode(int val) { this.val = val; } ListNode(int val, ListNode next) { this.val = val; this.next = next; } } è§£æ³•ä¸€ï¼šè¿­ä»£å¯¦ä½œ åŸºæœ¬æ€è·¯ ä½¿ç”¨ä¸‰å€‹æŒ‡æ¨™ prevã€currentã€next ä¾†é€æ­¥æ”¹è®Šæ¯å€‹ç¯€é»çš„æŒ‡å‘é—œä¿‚ã€‚\nç®—æ³•æ­¥é©Ÿ åˆå§‹åŒ– prev = nullï¼Œcurrent = head ç•¶ current != null æ™‚ï¼š ä¿å­˜ current.next åˆ° next å°‡ current.next æŒ‡å‘ prev ç§»å‹• prev å’Œ current æŒ‡æ¨™ å›å‚³ prevï¼ˆæ–°çš„é ­ç¯€é»ï¼‰ å¯¦ä½œä»£ç¢¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public class Solution { public ListNode reverseList(ListNode head) { ListNode prev = null; ListNode current = head; while (current != null) { ListNode next = current.next; // ä¿å­˜ä¸‹ä¸€å€‹ç¯€é» current.next = prev; // åè½‰æŒ‡æ¨™ prev = current; // ç§»å‹• prev current = next; // ç§»å‹• current } return prev; // prev ç¾åœ¨æ˜¯æ–°çš„é ­ç¯€é» } } åœ–è§£éç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 åˆå§‹ç‹€æ…‹ï¼š prev = null, current = 1 null 1 -\u0026gt; 2 -\u0026gt; 3 -\u0026gt; 4 -\u0026gt; 5 -\u0026gt; null ç¬¬ä¸€æ­¥ï¼š next = 2, current.next = prev null \u0026lt;- 1 2 -\u0026gt; 3 -\u0026gt; 4 -\u0026gt; 5 -\u0026gt; null prev current ç¬¬äºŒæ­¥ï¼š next = 3, current.next = prev null \u0026lt;- 1 \u0026lt;- 2 3 -\u0026gt; 4 -\u0026gt; 5 -\u0026gt; null prev current ... æœ€çµ‚ç‹€æ…‹ï¼š null \u0026lt;- 1 \u0026lt;- 2 \u0026lt;- 3 \u0026lt;- 4 \u0026lt;- 5 null prev current è§£æ³•äºŒï¼šéæ­¸å¯¦ä½œ åŸºæœ¬æ€è·¯ ä½¿ç”¨éæ­¸çš„æ–¹å¼ï¼Œå¾éˆè¡¨å°¾éƒ¨é–‹å§‹åè½‰ï¼Œåˆ©ç”¨éæ­¸å›æº¯çš„ç‰¹æ€§ä¾†æ”¹è®ŠæŒ‡æ¨™æŒ‡å‘ã€‚\nç®—æ³•æ­¥é©Ÿ éæ­¸åˆ°éˆè¡¨æœ€å¾Œä¸€å€‹ç¯€é» åœ¨å›æº¯éç¨‹ä¸­ï¼Œé€æ­¥åè½‰æ¯å€‹ç¯€é»çš„æŒ‡å‘ å›å‚³åŸéˆè¡¨çš„å°¾ç¯€é»ï¼ˆæ–°çš„é ­ç¯€é»ï¼‰ å¯¦ä½œä»£ç¢¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public class Solution { public ListNode reverseList(ListNode head) { // åŸºç¤æƒ…æ³ï¼šç©ºç¯€é»æˆ–åªæœ‰ä¸€å€‹ç¯€é» if (head == null || head.next == null) { return head; } // éæ­¸åè½‰å­éˆè¡¨ ListNode newHead = reverseList(head.next); // åè½‰ç•¶å‰ç¯€é»çš„æŒ‡å‘ head.next.next = head; head.next = null; return newHead; } } éæ­¸éç¨‹åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 åŸéˆè¡¨ï¼š1 -\u0026gt; 2 -\u0026gt; 3 -\u0026gt; 4 -\u0026gt; 5 -\u0026gt; null éæ­¸èª¿ç”¨æ£§ï¼š reverseList(1) -\u0026gt; reverseList(2) -\u0026gt; ... -\u0026gt; reverseList(5) å›æº¯éšæ®µï¼š 1. reverseList(5) å›å‚³ 5 2. reverseList(4)ï¼š - newHead = 5 - 4.next.next = 4 (å³ 5.next = 4) - 4.next = null - å›å‚³ 5 3. reverseList(3)ï¼š - newHead = 5 - 3.next.next = 3 (å³ 4.next = 3) - 3.next = null - å›å‚³ 5 ... æœ€çµ‚çµæœï¼š5 -\u0026gt; 4 -\u0026gt; 3 -\u0026gt; 2 -\u0026gt; 1 -\u0026gt; null æ™‚é–“èˆ‡ç©ºé–“è¤‡é›œåº¦åˆ†æ æ–¹æ³• æ™‚é–“è¤‡é›œåº¦ ç©ºé–“è¤‡é›œåº¦ å„ªé» ç¼ºé» è¿­ä»£ O(n) O(1) ç©ºé–“æ•ˆç‡é«˜ï¼Œç›´è§€æ˜“æ‡‚ éœ€è¦è™•ç†å¤šå€‹æŒ‡æ¨™ éæ­¸ O(n) O(n) ä»£ç¢¼ç°¡æ½”ï¼Œé‚è¼¯æ¸…æ™° ä½¿ç”¨é¡å¤–å †ç–Šç©ºé–“ é€²éšæ‡‰ç”¨ 1. åè½‰éˆè¡¨çš„å‰ N å€‹ç¯€é» å•é¡Œï¼šåè½‰éˆè¡¨çš„å‰ N å€‹ç¯€é»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public class Solution { private ListNode successor = null; // å¾Œé©…ç¯€é» public ListNode reverseN(ListNode head, int n) { if (n == 1) { // è¨˜éŒ„ç¬¬ n+1 å€‹ç¯€é» successor = head.next; return head; } // ä»¥ head.next ç‚ºèµ·é»ï¼Œéœ€è¦åè½‰å‰ n-1 å€‹ç¯€é» ListNode last = reverseN(head.next, n - 1); head.next.next = head; head.next = successor; // è®“åè½‰ä¹‹å¾Œçš„ head ç¯€é»å’Œå¾Œé¢çš„ç¯€é»é€£èµ·ä¾† return last; } } 2. åè½‰éˆè¡¨çš„æŒ‡å®šå€é–“ï¼ˆLeetCode 92ï¼‰ å•é¡Œï¼šåè½‰å¾ä½ç½® m åˆ° n çš„éˆè¡¨ã€‚è«‹ä½¿ç”¨ä¸€è¶Ÿæƒæå®Œæˆåè½‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public class Solution { public ListNode reverseBetween(ListNode head, int left, int right) { // å‰µå»ºè™›æ“¬é ­ç¯€é» ListNode dummy = new ListNode(0); dummy.next = head; // æ‰¾åˆ° left çš„å‰ä¸€å€‹ç¯€é» ListNode prev = dummy; for (int i = 0; i \u0026lt; left - 1; i++) { prev = prev.next; } // é–‹å§‹åè½‰ ListNode current = prev.next; ListNode next = null; for (int i = 0; i \u0026lt; right - left; i++) { next = current.next; current.next = next.next; next.next = prev.next; prev.next = next; } return dummy.next; } } 3. K å€‹ä¸€çµ„åè½‰éˆè¡¨ï¼ˆLeetCode 25ï¼‰ å•é¡Œï¼šçµ¦å®šä¸€å€‹éˆè¡¨ï¼Œæ¯ k å€‹ç¯€é»ä¸€çµ„é€²è¡Œåè½‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 public class Solution { public ListNode reverseKGroup(ListNode head, int k) { if (head == null) return null; // æª¢æŸ¥å‰©é¤˜ç¯€é»æ˜¯å¦è¶³å¤  k å€‹ ListNode a = head, b = head; for (int i = 0; i \u0026lt; k; i++) { if (b == null) return head; // ä¸è¶³ k å€‹ï¼Œç›´æ¥è¿”å› b = b.next; } // åè½‰å‰ k å€‹å…ƒç´  ListNode newHead = reverse(a, b); // éæ­¸åè½‰å¾ŒçºŒçš„éˆè¡¨ä¸¦é€£æ¥ a.next = reverseKGroup(b, k); return newHead; } // åè½‰ [a, b) å€é–“çš„éˆè¡¨ private ListNode reverse(ListNode a, ListNode b) { ListNode prev = null; ListNode current = a; while (current != b) { ListNode next = current.next; current.next = prev; prev = current; current = next; } return prev; } } å¯¦ä½œæŠ€å·§èˆ‡æ³¨æ„äº‹é … 1. é‚Šç•Œæ¢ä»¶è™•ç† 1 2 3 4 // æª¢æŸ¥ç©ºéˆè¡¨å’Œå–®ç¯€é»éˆè¡¨ if (head == null || head.next == null) { return head; } 2. ä½¿ç”¨è™›æ“¬é ­ç¯€é» åœ¨è™•ç†éˆè¡¨é ­éƒ¨è®ŠåŒ–çš„å•é¡Œæ™‚ï¼Œè™›æ“¬é ­ç¯€é»å¯ä»¥ç°¡åŒ–é‚è¼¯ï¼š\n1 2 3 4 ListNode dummy = new ListNode(0); dummy.next = head; // ... æ“ä½œ return dummy.next; 3. æŒ‡æ¨™æ“ä½œçš„é †åº åœ¨æ”¹è®ŠæŒ‡æ¨™æŒ‡å‘æ™‚ï¼Œå¿…é ˆå…ˆä¿å­˜ä¸‹ä¸€å€‹ç¯€é»ï¼š\n1 2 ListNode next = current.next; // å…ˆä¿å­˜ current.next = prev; // å†ä¿®æ”¹ 4. éæ­¸çµ‚æ­¢æ¢ä»¶ ç¢ºä¿éæ­¸æœ‰æ˜ç¢ºçš„çµ‚æ­¢æ¢ä»¶ï¼š\n1 2 3 if (head == null || head.next == null) { return head; // åŸºç¤æƒ…æ³ } å¸¸è¦‹è®Šé«”å•é¡Œ 1. åˆ¤æ–·éˆè¡¨æ˜¯å¦ç‚ºå›æ–‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public boolean isPalindrome(ListNode head) { if (head == null) return true; // æ‰¾åˆ°ä¸­é» ListNode slow = head, fast = head; while (fast.next != null \u0026amp;\u0026amp; fast.next.next != null) { slow = slow.next; fast = fast.next.next; } // åè½‰å¾ŒåŠéƒ¨åˆ† ListNode secondHalf = reverseList(slow.next); // æ¯”è¼ƒå‰å¾Œå…©éƒ¨åˆ† ListNode p1 = head, p2 = secondHalf; while (p2 != null) { if (p1.val != p2.val) return false; p1 = p1.next; p2 = p2.next; } return true; } 2. å…©å…©äº¤æ›éˆè¡¨ä¸­çš„ç¯€é» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public ListNode swapPairs(ListNode head) { ListNode dummy = new ListNode(0); dummy.next = head; ListNode prev = dummy; while (prev.next != null \u0026amp;\u0026amp; prev.next.next != null) { ListNode first = prev.next; ListNode second = prev.next.next; // äº¤æ› prev.next = second; first.next = second.next; second.next = first; // ç§»å‹• prev prev = first; } return dummy.next; } æœ€ä½³å¯¦è¸ é¸æ“‡åˆé©çš„æ–¹æ³•ï¼šå°æ–¼ç°¡å–®çš„éˆè¡¨åè½‰ï¼Œæ¨è–¦ä½¿ç”¨è¿­ä»£æ–¹æ³• æ³¨æ„ç©ºé–“è¤‡é›œåº¦ï¼šåœ¨ç©ºé–“å—é™çš„ç’°å¢ƒä¸‹é¿å…ä½¿ç”¨éæ­¸ è™•ç†é‚Šç•Œæƒ…æ³ï¼šå§‹çµ‚æª¢æŸ¥ç©ºéˆè¡¨å’Œå–®ç¯€é»æƒ…æ³ ä½¿ç”¨è™›æ“¬ç¯€é»ï¼šç°¡åŒ–é ­ç¯€é»çš„è™•ç†é‚è¼¯ æ¸¬è©¦å……åˆ†ï¼šæ¸¬è©¦å„ç¨®é‚Šç•Œæƒ…æ³å’Œç‰¹æ®Šè¼¸å…¥ ç¸½çµ éˆè¡¨åè½‰æ˜¯ä¸€å€‹çœ‹ä¼¼ç°¡å–®ä½†ç´°ç¯€è±å¯Œçš„å•é¡Œã€‚æŒæ¡é€™å€‹å•é¡Œçš„é—œéµåœ¨æ–¼ï¼š\nç†è§£æŒ‡æ¨™æ“ä½œï¼šæ­£ç¢ºè™•ç†ç¯€é»é–“çš„æŒ‡å‘é—œä¿‚ é¸æ“‡åˆé©æ–¹æ³•ï¼šæ ¹æ“šå ´æ™¯é¸æ“‡è¿­ä»£æˆ–éæ­¸å¯¦ä½œ è™•ç†é‚Šç•Œæƒ…æ³ï¼šç¢ºä¿ç®—æ³•åœ¨å„ç¨®è¼¸å…¥ä¸‹éƒ½èƒ½æ­£ç¢ºé‹è¡Œ éˆæ´»æ‡‰ç”¨ï¼šå°‡åŸºæœ¬æŠ€å·§æ‡‰ç”¨åˆ°æ›´è¤‡é›œçš„è®Šé«”å•é¡Œä¸­ é€šéåå¾©ç·´ç¿’å’Œç†è§£ï¼Œéˆè¡¨åè½‰å°‡æˆç‚ºè§£æ±ºæ›´è¤‡é›œéˆè¡¨å•é¡Œçš„åŸºç¤æŠ€èƒ½ã€‚\nåƒè€ƒè³‡æ–™ LeetCode 206. Reverse Linked List LeetCode 92. Reverse Linked List II LeetCode 25. Reverse Nodes in k-Group LeetCode 234. Palindrome Linked List æ¼”ç®—æ³•å°è«– - éˆè¡¨æ“ä½œ ","permalink":"https://xinqilin.github.io/post/algorithm/reverselinkedlist/","tags":["Algorithm","LinkedList","Recursion","Java","Pointer"],"title":"éˆè¡¨åè½‰ï¼ˆReverse Linked Listï¼‰å®Œæ•´è§£æ"},{"content":"æ¦‚è¿° ä¸¦æŸ¥é›†ï¼ˆUnion-Findï¼‰åˆç¨±ç‚ºä¸ç›¸äº¤é›†åˆï¼ˆDisjoint Setï¼‰ï¼Œæ˜¯ä¸€ç¨®ç”¨ä¾†è™•ç†ä¸ç›¸äº¤é›†åˆçš„åˆä½µå’ŒæŸ¥è©¢å•é¡Œçš„æ•¸æ“šçµæ§‹ã€‚å®ƒæ”¯æ´å…©ç¨®ä¸»è¦æ“ä½œï¼š\nFindï¼šæŸ¥æ‰¾å…ƒç´ æ‰€å±¬çš„é›†åˆï¼ˆè¿”å›é›†åˆçš„ä»£è¡¨å…ƒç´ ï¼‰ Unionï¼šåˆä½µå…©å€‹ä¸åŒçš„é›†åˆ ä¸¦æŸ¥é›†åœ¨åœ–è«–æ¼”ç®—æ³•ä¸­æ‡‰ç”¨å»£æ³›ï¼Œç‰¹åˆ¥é©ç”¨æ–¼è§£æ±ºé€£é€šæ€§å•é¡Œã€‚\nåŸºæœ¬åŸç† æ ¸å¿ƒæ¦‚å¿µ ä¸¦æŸ¥é›†å°‡æ¯å€‹é›†åˆè¡¨ç¤ºç‚ºä¸€æ£µæ¨¹ï¼Œæ¨¹çš„æ ¹ç¯€é»ä½œç‚ºè©²é›†åˆçš„ä»£è¡¨å…ƒç´ ã€‚åˆå§‹ç‹€æ…‹ä¸‹ï¼Œæ¯å€‹å…ƒç´ éƒ½æ˜¯ç¨ç«‹çš„é›†åˆï¼ˆè‡ªå·±æ˜¯è‡ªå·±çš„çˆ¶ç¯€é»ï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 åˆå§‹ç‹€æ…‹ï¼š 0 1 2 3 4 â†“ â†“ â†“ â†“ â†“ 0 1 2 3 4 åˆä½µ 0 å’Œ 1 å¾Œï¼š 0 2 3 4 â†™ â†“ â†“ â†“ 1 2 3 4 åˆä½µ 2 å’Œ 3 å¾Œï¼š 0 2 4 â†™ â†™ â†“ 1 3 4 åŸºæœ¬å¯¦ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 public class UnionFind { private int[] parent; // parent[i] è¡¨ç¤ºå…ƒç´  i çš„çˆ¶ç¯€é» private int[] rank; // rank[i] è¡¨ç¤ºä»¥ i ç‚ºæ ¹çš„æ¨¹çš„é«˜åº¦ private int components; // é€£é€šåˆ†é‡çš„æ•¸é‡ public UnionFind(int n) { parent = new int[n]; rank = new int[n]; components = n; // åˆå§‹åŒ–ï¼šæ¯å€‹å…ƒç´ éƒ½æ˜¯ç¨ç«‹çš„é›†åˆ for (int i = 0; i \u0026lt; n; i++) { parent[i] = i; // è‡ªå·±æ˜¯è‡ªå·±çš„çˆ¶ç¯€é» rank[i] = 0; // åˆå§‹é«˜åº¦ç‚º 0 } } /** * æŸ¥æ‰¾å…ƒç´  x æ‰€å±¬é›†åˆçš„ä»£è¡¨å…ƒç´  */ public int find(int x) { if (parent[x] != x) { // è·¯å¾‘å£“ç¸®ï¼šå°‡è·¯å¾‘ä¸Šæ‰€æœ‰ç¯€é»ç›´æ¥é€£æ¥åˆ°æ ¹ç¯€é» parent[x] = find(parent[x]); } return parent[x]; } /** * åˆä½µå…ƒç´  x å’Œ y æ‰€å±¬çš„é›†åˆ */ public boolean union(int x, int y) { int rootX = find(x); int rootY = find(y); // å¦‚æœå·²ç¶“åœ¨åŒä¸€å€‹é›†åˆä¸­ï¼Œè¿”å› false if (rootX == rootY) { return false; } // æŒ‰ç§©åˆä½µï¼šå°‡è¼ƒçŸ®çš„æ¨¹åˆä½µåˆ°è¼ƒé«˜çš„æ¨¹ä¸‹ if (rank[rootX] \u0026lt; rank[rootY]) { parent[rootX] = rootY; } else if (rank[rootX] \u0026gt; rank[rootY]) { parent[rootY] = rootX; } else { parent[rootY] = rootX; rank[rootX]++; // é«˜åº¦ç›¸åŒæ™‚ï¼Œåˆä½µå¾Œé«˜åº¦åŠ  1 } components--; // é€£é€šåˆ†é‡æ¸› 1 return true; } /** * æª¢æŸ¥å…©å€‹å…ƒç´ æ˜¯å¦åœ¨åŒä¸€å€‹é›†åˆä¸­ */ public boolean connected(int x, int y) { return find(x) == find(y); } /** * ç²å–é€£é€šåˆ†é‡çš„æ•¸é‡ */ public int getComponentCount() { return components; } } å„ªåŒ–æŠ€å·§ 1. è·¯å¾‘å£“ç¸®ï¼ˆPath Compressionï¼‰ åœ¨ find æ“ä½œä¸­ï¼Œå°‡æŸ¥æ‰¾è·¯å¾‘ä¸Šçš„æ‰€æœ‰ç¯€é»ç›´æ¥é€£æ¥åˆ°æ ¹ç¯€é»ï¼Œä½¿æ¨¹è®Šå¾—æ›´åŠ æ‰å¹³ã€‚\n1 2 3 4 5 6 public int find(int x) { if (parent[x] != x) { parent[x] = find(parent[x]); // éæ­¸å£“ç¸®è·¯å¾‘ } return parent[x]; } 2. æŒ‰ç§©åˆä½µï¼ˆUnion by Rankï¼‰ ç¸½æ˜¯å°‡è¼ƒçŸ®çš„æ¨¹åˆä½µåˆ°è¼ƒé«˜çš„æ¨¹ä¸‹ï¼Œé¿å…æ¨¹è®Šå¾—éé«˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public boolean union(int x, int y) { int rootX = find(x); int rootY = find(y); if (rootX == rootY) return false; // æŒ‰ç§©åˆä½µ if (rank[rootX] \u0026lt; rank[rootY]) { parent[rootX] = rootY; } else if (rank[rootX] \u0026gt; rank[rootY]) { parent[rootY] = rootX; } else { parent[rootY] = rootX; rank[rootX]++; } return true; } 3. æŒ‰å¤§å°åˆä½µï¼ˆUnion by Sizeï¼‰ å¦ä¸€ç¨®å„ªåŒ–ç­–ç•¥æ˜¯å°‡è¼ƒå°çš„é›†åˆåˆä½µåˆ°è¼ƒå¤§çš„é›†åˆä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public class UnionFindBySize { private int[] parent; private int[] size; // size[i] è¡¨ç¤ºä»¥ i ç‚ºæ ¹çš„é›†åˆå¤§å° public UnionFindBySize(int n) { parent = new int[n]; size = new int[n]; for (int i = 0; i \u0026lt; n; i++) { parent[i] = i; size[i] = 1; // åˆå§‹æ¯å€‹é›†åˆå¤§å°ç‚º 1 } } public boolean union(int x, int y) { int rootX = find(x); int rootY = find(y); if (rootX == rootY) return false; // æŒ‰å¤§å°åˆä½µï¼šå°‡å°é›†åˆåˆä½µåˆ°å¤§é›†åˆ if (size[rootX] \u0026lt; size[rootY]) { parent[rootX] = rootY; size[rootY] += size[rootX]; } else { parent[rootY] = rootX; size[rootX] += size[rootY]; } return true; } } æ™‚é–“è¤‡é›œåº¦ æ“ä½œ æ™‚é–“è¤‡é›œåº¦ èªªæ˜ åˆå§‹åŒ– O(n) å»ºç«‹ n å€‹ç¨ç«‹é›†åˆ Findï¼ˆç„¡å„ªåŒ–ï¼‰ O(n) æœ€å£æƒ…æ³ä¸‹éœ€è¦éæ­·æ•´æ¢éˆ Unionï¼ˆç„¡å„ªåŒ–ï¼‰ O(n) éœ€è¦èª¿ç”¨ Find æ“ä½œ Findï¼ˆè·¯å¾‘å£“ç¸®ï¼‰ O(Î±(n)) Î±(n) æ˜¯é˜¿å…‹æ›¼å‡½æ•¸çš„åå‡½æ•¸ Unionï¼ˆæŒ‰ç§©åˆä½µï¼‰ O(Î±(n)) è¿‘ä¼¼å¸¸æ•¸æ™‚é–“ å…¶ä¸­ Î±(n) æ˜¯é˜¿å…‹æ›¼å‡½æ•¸çš„åå‡½æ•¸ï¼Œåœ¨å¯¦éš›æ‡‰ç”¨ä¸­å¯è¦–ç‚ºå¸¸æ•¸ã€‚\nç¶“å…¸æ‡‰ç”¨é¡Œå‹ 1. ç­‰å¼æ–¹ç¨‹çš„å¯æ»¿è¶³æ€§ï¼ˆLeetCode 990ï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹ç”±è¡¨ç¤ºè®Šæ•¸ä¹‹é–“é—œä¿‚çš„å­—ä¸²çµ„æˆçš„é™£åˆ— equationsï¼Œæ¯å€‹å­—ä¸² equations[i] çš„é•·åº¦ç‚º 4ï¼Œæœ‰å…©ç¨®å½¢å¼ï¼š\u0026quot;a==b\u0026quot; æˆ– \u0026quot;a!=b\u0026quot;ã€‚åˆ¤æ–·æ˜¯å¦æ‰€æœ‰ç­‰å¼éƒ½èƒ½åŒæ™‚æ»¿è¶³ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 class Solution { private int[] parent = new int[26]; // 26 å€‹å­—æ¯ public boolean equationsPossible(String[] equations) { // åˆå§‹åŒ–ä¸¦æŸ¥é›† for (int i = 0; i \u0026lt; 26; i++) { parent[i] = i; } // ç¬¬ä¸€éï¼šè™•ç†æ‰€æœ‰ç­‰å¼ï¼Œåˆä½µç›¸ç­‰çš„è®Šæ•¸ for (String equation : equations) { if (equation.charAt(1) == \u0026#39;=\u0026#39;) { union(equation.charAt(0) - \u0026#39;a\u0026#39;, equation.charAt(3) - \u0026#39;a\u0026#39;); } } // ç¬¬äºŒéï¼šæª¢æŸ¥ä¸ç­‰å¼æ˜¯å¦é•åäº†ç­‰å¼çš„çµæœ for (String equation : equations) { if (equation.charAt(1) == \u0026#39;!\u0026#39;) { int x = equation.charAt(0) - \u0026#39;a\u0026#39;; int y = equation.charAt(3) - \u0026#39;a\u0026#39;; if (find(x) == find(y)) { return false; // ä¸ç­‰å¼çŸ›ç›¾ } } } return true; } private int find(int x) { if (parent[x] != x) { parent[x] = find(parent[x]); } return parent[x]; } private void union(int x, int y) { parent[find(x)] = find(y); } } 2. æœ‹å‹åœˆæ•¸é‡ï¼ˆLeetCode 547ï¼‰ å•é¡Œæè¿°ï¼šç­ä¸Šæœ‰ N åå­¸ç”Ÿã€‚å…¶ä¸­æœ‰äº›äººæ˜¯æœ‹å‹ï¼Œæœ‰äº›å‰‡ä¸æ˜¯ã€‚ä»–å€‘çš„å‹èª¼å…·æœ‰å‚³éæ€§ã€‚æ‰¾å‡ºæœ‹å‹åœˆçš„ç¸½æ•¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 class Solution { public int findCircleNum(int[][] isConnected) { int n = isConnected.length; UnionFind uf = new UnionFind(n); // éæ­·æ‰€æœ‰å­¸ç”Ÿå°ï¼Œå¦‚æœæ˜¯æœ‹å‹å°±åˆä½µ for (int i = 0; i \u0026lt; n; i++) { for (int j = i + 1; j \u0026lt; n; j++) { if (isConnected[i][j] == 1) { uf.union(i, j); } } } return uf.getComponentCount(); } } 3. å³¶å¶¼æ•¸é‡ï¼ˆLeetCode 200ï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹ç”± \u0026lsquo;1\u0026rsquo;ï¼ˆé™¸åœ°ï¼‰å’Œ \u0026lsquo;0\u0026rsquo;ï¼ˆæ°´ï¼‰çµ„æˆçš„äºŒç¶­ç¶²æ ¼ï¼Œè¨ˆç®—å³¶å¶¼çš„æ•¸é‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 class Solution { public int numIslands(char[][] grid) { if (grid == null || grid.length == 0) return 0; int rows = grid.length; int cols = grid[0].length; UnionFind uf = new UnionFind(rows * cols); int waterCells = 0; // æ–¹å‘é™£åˆ—ï¼šä¸Šã€ä¸‹ã€å·¦ã€å³ int[][] directions = {{-1, 0}, {1, 0}, {0, -1}, {0, 1}}; for (int i = 0; i \u0026lt; rows; i++) { for (int j = 0; j \u0026lt; cols; j++) { if (grid[i][j] == \u0026#39;0\u0026#39;) { waterCells++; } else { // æª¢æŸ¥å››å€‹æ–¹å‘çš„ç›¸é„°é™¸åœ° for (int[] dir : directions) { int newRow = i + dir[0]; int newCol = j + dir[1]; if (newRow \u0026gt;= 0 \u0026amp;\u0026amp; newRow \u0026lt; rows \u0026amp;\u0026amp; newCol \u0026gt;= 0 \u0026amp;\u0026amp; newCol \u0026lt; cols \u0026amp;\u0026amp; grid[newRow][newCol] == \u0026#39;1\u0026#39;) { uf.union(i * cols + j, newRow * cols + newCol); } } } } } return uf.getComponentCount() - waterCells; } } 4. å†—ä½™é€£æ¥ï¼ˆLeetCode 684ï¼‰ å•é¡Œæè¿°ï¼šåœ¨ç„¡å‘åœ–ä¸­æ‰¾åˆ°ä¸€æ¢é‚Šï¼Œç§»é™¤å®ƒå¾Œåœ–å°‡è®Šæˆæ¨¹ã€‚å¦‚æœæœ‰å¤šå€‹ç­”æ¡ˆï¼Œè¿”å›æœ€å¾Œå‡ºç¾åœ¨çµ¦å®šäºŒç¶­é™£åˆ—ä¸­çš„é‚Šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 class Solution { public int[] findRedundantConnection(int[][] edges) { UnionFind uf = new UnionFind(edges.length + 1); for (int[] edge : edges) { // å¦‚æœå…©å€‹ç¯€é»å·²ç¶“é€£é€šï¼Œé€™æ¢é‚Šå°±æ˜¯å†—ä½™çš„ if (!uf.union(edge[0], edge[1])) { return edge; } } return new int[0]; // ç†è«–ä¸Šä¸æœƒåˆ°é”é€™è£¡ } } 5. è³¬æˆ¶åˆä½µï¼ˆLeetCode 721ï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹è³¬æˆ¶åˆ—è¡¨ï¼Œæ¯å€‹å…ƒç´  accounts[i] æ˜¯ä¸€å€‹å­—ä¸²åˆ—è¡¨ï¼Œå…¶ä¸­ç¬¬ä¸€å€‹å…ƒç´ æ˜¯åå­—ï¼Œå…¶é¤˜å…ƒç´ æ˜¯ emailsã€‚åˆä½µå±¬æ–¼åŒä¸€äººçš„è³¬æˆ¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 class Solution { public List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; accountsMerge(List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; accounts) { Map\u0026lt;String, Integer\u0026gt; emailToIndex = new HashMap\u0026lt;\u0026gt;(); Map\u0026lt;String, String\u0026gt; emailToName = new HashMap\u0026lt;\u0026gt;(); int emailCount = 0; // ç‚ºæ¯å€‹ email åˆ†é…å”¯ä¸€ç´¢å¼• for (List\u0026lt;String\u0026gt; account : accounts) { String name = account.get(0); for (int i = 1; i \u0026lt; account.size(); i++) { String email = account.get(i); if (!emailToIndex.containsKey(email)) { emailToIndex.put(email, emailCount++); } emailToName.put(email, name); } } UnionFind uf = new UnionFind(emailCount); // åˆä½µåŒä¸€è³¬æˆ¶ä¸‹çš„æ‰€æœ‰ email for (List\u0026lt;String\u0026gt; account : accounts) { String firstEmail = account.get(1); for (int i = 2; i \u0026lt; account.size(); i++) { uf.union(emailToIndex.get(firstEmail), emailToIndex.get(account.get(i))); } } // æ ¹æ“šä¸¦æŸ¥é›†çµæœåˆ†çµ„ email Map\u0026lt;Integer, List\u0026lt;String\u0026gt;\u0026gt; groups = new HashMap\u0026lt;\u0026gt;(); for (String email : emailToIndex.keySet()) { int root = uf.find(emailToIndex.get(email)); groups.computeIfAbsent(root, k -\u0026gt; new ArrayList\u0026lt;\u0026gt;()).add(email); } // æ§‹å»ºæœ€çµ‚çµæœ List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); for (List\u0026lt;String\u0026gt; emails : groups.values()) { Collections.sort(emails); List\u0026lt;String\u0026gt; account = new ArrayList\u0026lt;\u0026gt;(); account.add(emailToName.get(emails.get(0))); account.addAll(emails); result.add(account); } return result; } } é«˜ç´šæ‡‰ç”¨ å‹•æ…‹é€£é€šæ€§å•é¡Œ ä¸¦æŸ¥é›†ç‰¹åˆ¥é©ç”¨æ–¼è™•ç†å‹•æ…‹é€£é€šæ€§å•é¡Œï¼Œå³åœ¨ç·šå›ç­”ã€Œå…©å€‹ç¯€é»æ˜¯å¦é€£é€šã€çš„æŸ¥è©¢ã€‚\næœ€å°ç”Ÿæˆæ¨¹ï¼ˆKruskal æ¼”ç®—æ³•ï¼‰ Kruskal æ¼”ç®—æ³•ä½¿ç”¨ä¸¦æŸ¥é›†ä¾†æª¢æ¸¬ç’°çš„å­˜åœ¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public class KruskalMST { public int kruskalMST(int n, int[][] edges) { // æŒ‰æ¬Šé‡æ’åºé‚Š Arrays.sort(edges, (a, b) -\u0026gt; a[2] - b[2]); UnionFind uf = new UnionFind(n); int mstWeight = 0; int edgesUsed = 0; for (int[] edge : edges) { int u = edge[0], v = edge[1], weight = edge[2]; // å¦‚æœä¸æœƒå½¢æˆç’°ï¼ŒåŠ å…¥ MST if (uf.union(u, v)) { mstWeight += weight; edgesUsed++; // MST æœ‰ n-1 æ¢é‚Š if (edgesUsed == n - 1) { break; } } } return mstWeight; } } å¯¦ä½œæŠ€å·§èˆ‡æ³¨æ„äº‹é … è·¯å¾‘å£“ç¸®ï¼šåœ¨ find æ“ä½œä¸­ä½¿ç”¨è·¯å¾‘å£“ç¸®å¯ä»¥é¡¯è‘—æå‡æ€§èƒ½ æŒ‰ç§©åˆä½µï¼šé¿å…æ¨¹è®Šå¾—éé«˜ï¼Œä¿æŒæ“ä½œçš„é«˜æ•ˆæ€§ å…ƒç´ æ˜ å°„ï¼šç•¶å…ƒç´ ä¸æ˜¯é€£çºŒæ•´æ•¸æ™‚ï¼Œéœ€è¦å»ºç«‹æ˜ å°„é—œä¿‚ é€£é€šåˆ†é‡è¨ˆæ•¸ï¼šç¶­è­·é€£é€šåˆ†é‡çš„æ•¸é‡å¯ä»¥å¿«é€Ÿå›ç­”ç›¸é—œæŸ¥è©¢ ç¸½çµ ä¸¦æŸ¥é›†æ˜¯è§£æ±ºå‹•æ…‹é€£é€šæ€§å•é¡Œçš„é«˜æ•ˆæ•¸æ“šçµæ§‹ï¼Œåœ¨åœ–è«–ã€ç¶²è·¯åˆ†æã€é›†åˆåŠƒåˆ†ç­‰é ˜åŸŸæœ‰å»£æ³›æ‡‰ç”¨ã€‚æŒæ¡ä¸¦æŸ¥é›†çš„é—œéµåœ¨æ–¼ï¼š\nç†è§£åŸºæœ¬åŸç†ï¼šæ¨¹å½¢çµæ§‹è¡¨ç¤ºé›†åˆï¼Œæ ¹ç¯€é»ä½œç‚ºä»£è¡¨å…ƒç´  æŒæ¡å„ªåŒ–æŠ€å·§ï¼šè·¯å¾‘å£“ç¸®å’ŒæŒ‰ç§©/æŒ‰å¤§å°åˆä½µ éˆæ´»æ‡‰ç”¨ï¼šæ ¹æ“šå•é¡Œç‰¹é»é¸æ“‡åˆé©çš„å¯¦ä½œæ–¹å¼ æ³¨æ„ç´°ç¯€ï¼šé‚Šç•Œæ¢ä»¶è™•ç†å’Œå…ƒç´ æ˜ å°„ åƒè€ƒè³‡æ–™ LeetCode 990. Satisfiability of Equality Equations LeetCode 547. Number of Provinces LeetCode 200. Number of Islands LeetCode 684. Redundant Connection LeetCode 721. Accounts Merge æ¼”ç®—æ³•å°è«– - ä¸ç›¸äº¤é›†åˆçš„æ•¸æ“šçµæ§‹ ","permalink":"https://xinqilin.github.io/post/algorithm/unionfind/","tags":["Algorithm","UnionFind","DisjointSet","Graph","Java"],"title":"ä¸¦æŸ¥é›†ï¼ˆUnion-Findï¼‰æ¼”ç®—æ³•å®Œæ•´æŒ‡å—"},{"content":"Snowflake - Distribution Key å–®é«”å¼ ID ä¸€èˆ¬å–®é«”å¼ UUID(Universally Unique identifier) 8-4-4-4-12 ç¸½å…± 32 å€‹ 16 é€²ä½\n1 UUID.randomUUID() // 80e06459-942d-4a63-9fd4-81691b127363 å„ªé» æ€§èƒ½é«˜ æœ¬åœ°ç”Ÿæˆ ç„¡ç¶²è·¯å»¶é² ç¼ºé» ç„¡é †åºæ€§ å­—ä¸²ä¸é©åˆå­˜ db ç•¶ index or PK ä¸” 32 é•·åº¦å¤ªé•· å› ç„¡åº æ‰€ä»¥å° b+ Tree ä¾†èªª æ’å…¥æ™‚æ•ˆèƒ½ä½ æ¥µå°æ©Ÿæœƒä½† æœƒé‡è¤‡ =\u0026gt; ï¼¤ï¼¢ è§£æ³•: replace into è·ŸinsertåŠŸèƒ½é¡ä¼¼, ä½† replace into æœƒæª¢æŸ¥æ˜¯å¦å­˜åœ¨, å¦‚å­˜åœ¨å‰‡å…ˆåˆªé™¤, å†æ’å…¥, å¦åˆ™ç›´æ¥æ’å…¥ åˆ†ä½ˆå¼ ID twitter é–‹ç™¼çš„ é›ªèŠ±ç®—æ³• - snowflake ç¸½å…± 64 bit\n1bit ä¸ç”¨ï¼Œå› ç‚ºäºŒé€²åˆ¶ä¸­æœ€é«˜ä½æ˜¯ç¬¦è™Ÿä½ï¼Œ1è¡¨ç¤ºè² æ•¸ï¼Œ0è¡¨ç¤ºæ­£æ•¸ã€‚ ç”Ÿæˆçš„idä¸€èˆ¬éƒ½æ˜¯ç”¨æ•´æ•¸ï¼Œæ‰€ä»¥æœ€é«˜ä½å›ºå®šç‚º0ã€‚\n41bit-æ™‚é–“æˆ³ï¼Œç”¨ä¾†è¨˜éŒ„æ™‚é–“æˆ³ï¼Œäº³ç§’ç´šã€‚ 41ä½å¯ä»¥è¡¨ç¤º 2^41-1å€‹æ•¸å­—ï¼Œ å¦‚æœåªç”¨ä¾†è¡¨ç¤ºæ­£æ•´æ•¸(è¨ˆç®—æ©Ÿä¸­æ­£æ•¸åŒ…å«0)ï¼Œå¯ä»¥è¡¨ç¤ºçš„æ•¸å€¼ç¯„åœæ˜¯: 0 è‡³ 2^41 - 1ï¼Œ æ¸›1æ˜¯å› ç‚ºå¯è¡¨ç¤ºçš„æ•¸å€¼ç¯„åœæ˜¯å¾0é–‹å§‹ç®—çš„ï¼Œè€Œä¸æ˜¯1.ä¹Ÿå°±æ˜¯èªª41ä½å¯ä»¥è¡¨ç¤º 2^41 - 1 å€‹æ¯«ç§’çš„å€¼ï¼Œè½‰åŒ–æˆå–®ä½å¹´å‰‡æ˜¯( 2^41 - 1 )/ (1000* 60 * 60 * 24 *365)= 69å¹´\n10bit-å·¥ä½œæ©Ÿå™¨id,ç”¨ä¾†è¨˜éŒ„å·¥ä½œæ©Ÿå™¨id. å¯ä»¥éƒ¨ç½²åœ¨ 2^10 = 1024 å€‹ç¯€é»ï¼ŒåŒ…æ‹¬5ä½ dataCenterId å’Œ 15 ä½ workerId 5ä½(bit) å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•¸æ˜¯ 2^5-1 = 31ï¼Œå³å¯ä»¥ç”¨ 0, 1, 2, 3\u0026hellip; é€™ 32 å€‹æ•¸å­—ä¾†è¡¨ç¤ºä¸åŒçš„ dataCenterId æˆ– workerId\n12bit, åºåˆ—è™Ÿï¼Œåºåˆ—è™Ÿï¼Œç”¨ä¾†è¨˜éŒ„åŒæ¯«ç§’å…§ç”¢ç”Ÿçš„ä¸åŒid. 12ä½(bit) å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•¸æ˜¯ 2^12 - 1 = 4095ï¼Œå³å¯ä»¥ç”¨ 0, 1, 2, 3\u0026hellip; 4094 é€™ 4095 å€‹æ•¸å­—, ä¾†è¡¨ç¤ºåŒä¸€æ©Ÿå™¨åŒä¸€æ™‚é–“æˆª(æ¯«ç§’)å…§ç”¢ç”Ÿçš„ 4095 å€‹IDåºè™Ÿã€‚\nå„ªé» å…¨å±€å”¯ä¸€æ€§ é€’å¢æ€§, ç¢ºä¿ç”Ÿæˆ ID å°æ–¼ç”¨æˆ·æˆ–æ¥­å‹™æ˜¯é€’å¢çš„ã€‚ é«˜å¯ç”¨æ€§, ç¢ºä¿ä»»ä½•æ™‚å€™éƒ½èƒ½ç”Ÿæˆæ­£ç¢ºçš„ ID é«˜æ€§èƒ½, åœ¨é«˜ä½µç™¼ä¸‹ä¾ç„¶ ok äº³ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œæ•´å€‹ ID éƒ½æ˜¯éå¢çš„ã€‚ ç¼ºé» ä¾è³´æ©Ÿå™¨æ™‚é˜ï¼Œå¦‚æœæ©Ÿå™¨æ™‚é˜å›æ’¥ï¼Œæœƒå°è‡´é‡è¤‡ ID ç”Ÿæˆ åœ¨å–®æ©Ÿä¸Šæ˜¯éå¢çš„ï¼Œä½†æ˜¯ç”±æ–¼è¨­è¨ˆåˆ°åˆ†ä½ˆå¼ç’°å¢ƒï¼Œæ¯å°æ©Ÿå™¨ä¸Šçš„æ™‚é˜ä¸å¯èƒ½å®Œå…¨åŒæ­¥ï¼Œæœ‰æ™‚å€™æœƒå‡ºç¾ä¸æ˜¯å…¨å±€éå¢çš„æƒ…æ³(æ­¤ç¼ºé»å¯ä»¥èªç‚ºç„¡æ‰€è¬‚ï¼Œ- .èˆ¬åˆ†ä½ˆå¼IDåªè¦æ±‚è¶¨å‹¢éå¢ï¼Œä¸¦ä¸æœƒåš´æ ¼è¦æ±‚éå¢ï¼Œ90%çš„éœ€æ±‚éƒ½åªè¦æ±‚è¶¨å‹¢éå¢) additional è§£æ±ºæ©Ÿå™¨æ™‚é˜å›æ’¥å•é¡Œ Leaf - ç¾åœ˜é»è©•åˆ†ä½ˆå¼IDç”Ÿæˆç³»çµ± ç™¾åº¦ open source - UidGenerator java sample code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 public class SnowflakeIdWorker { /** * å¼€å§‹æ—¶é—´æˆª (2015-01-01) */ private final long twepoch = 1420041600000L; /** * æœºå™¨idæ‰€å çš„ä½æ•° */ private final long workerIdBits = 5L; /** * æ•°æ®æ ‡è¯†idæ‰€å çš„ä½æ•° */ private final long datacenterIdBits = 5L; /** * æ”¯æŒçš„æœ€å¤§æœºå™¨idï¼Œç»“æœæ˜¯31 (è¿™ä¸ªç§»ä½ç®—æ³•å¯ä»¥å¾ˆå¿«çš„è®¡ç®—å‡ºå‡ ä½äºŒè¿›åˆ¶æ•°æ‰€èƒ½è¡¨ç¤ºçš„æœ€å¤§åè¿›åˆ¶æ•°) */ private final long maxWorkerId = -1L ^ (-1L \u0026lt;\u0026lt; workerIdBits); /** * æ”¯æŒçš„æœ€å¤§æ•°æ®æ ‡è¯†idï¼Œç»“æœæ˜¯31 */ private final long maxDatacenterId = -1L ^ (-1L \u0026lt;\u0026lt; datacenterIdBits); /** * åºåˆ—åœ¨idä¸­å çš„ä½æ•° */ private final long sequenceBits = 12L; /** * æœºå™¨IDå‘å·¦ç§»12ä½ */ private final long workerIdShift = sequenceBits; /** * æ•°æ®æ ‡è¯†idå‘å·¦ç§»17ä½(12+5) */ private final long datacenterIdShift = sequenceBits + workerIdBits; /** * æ—¶é—´æˆªå‘å·¦ç§»22ä½(5+5+12) */ private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits; /** * ç”Ÿæˆåºåˆ—çš„æ©ç ï¼Œè¿™é‡Œä¸º4095 (0b111111111111=0xfff=4095) */ private final long sequenceMask = -1L ^ (-1L \u0026lt;\u0026lt; sequenceBits); /** * å·¥ä½œæœºå™¨ID(0~31) */ private long workerId; /** * æ•°æ®ä¸­å¿ƒID(0~31) */ private long datacenterId; /** * æ¯«ç§’å†…åºåˆ—(0~4095) */ private long sequence = 0L; /** * ä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆª */ private long lastTimestamp = -1L; /** * æ„é€ å‡½æ•° * @param workerId å·¥ä½œID (0~31) * @param datacenterId æ•°æ®ä¸­å¿ƒID (0~31) */ public SnowflakeIdWorker(long workerId, long datacenterId) { if (workerId \u0026gt; maxWorkerId || workerId \u0026lt; 0) { throw new IllegalArgumentException(String.format(\u0026#34;worker Id can\u0026#39;t be greater than %d or less than 0\u0026#34;, maxWorkerId)); } if (datacenterId \u0026gt; maxDatacenterId || datacenterId \u0026lt; 0) { throw new IllegalArgumentException(String.format(\u0026#34;datacenter Id can\u0026#39;t be greater than %d or less than 0\u0026#34;, maxDatacenterId)); } this.workerId = workerId; this.datacenterId = datacenterId; } /** * è·å¾—ä¸‹ä¸€ä¸ªID (è¯¥æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„) * @return SnowflakeId */ public synchronized long nextId() { long timestamp = timeGen(); // å¦‚æœå½“å‰æ—¶é—´å°äºä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ï¼Œè¯´æ˜ç³»ç»Ÿæ—¶é’Ÿå›é€€è¿‡è¿™ä¸ªæ—¶å€™åº”å½“æŠ›å‡ºå¼‚å¸¸ if (timestamp \u0026lt; lastTimestamp) { throw new RuntimeException( String.format(\u0026#34;Clock moved backwards. Refusing to generate id for %d milliseconds\u0026#34;, lastTimestamp - timestamp)); } // å¦‚æœæ˜¯åŒä¸€æ—¶é—´ç”Ÿæˆçš„ï¼Œåˆ™è¿›è¡Œæ¯«ç§’å†…åºåˆ— if (lastTimestamp == timestamp) { sequence = (sequence + 1) \u0026amp; sequenceMask; // æ¯«ç§’å†…åºåˆ—æº¢å‡º if (sequence == 0) { //é˜»å¡åˆ°ä¸‹ä¸€ä¸ªæ¯«ç§’,è·å¾—æ–°çš„æ—¶é—´æˆ³ timestamp = tilNextMillis(lastTimestamp); } } // æ—¶é—´æˆ³æ”¹å˜ï¼Œæ¯«ç§’å†…åºåˆ—é‡ç½® else { sequence = 0L; } // ä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆª lastTimestamp = timestamp; // ç§»ä½å¹¶é€šè¿‡æˆ–è¿ç®—æ‹¼åˆ°ä¸€èµ·ç»„æˆ64ä½çš„ID return ((timestamp - twepoch) \u0026lt;\u0026lt; timestampLeftShift) // | (datacenterId \u0026lt;\u0026lt; datacenterIdShift) // | (workerId \u0026lt;\u0026lt; workerIdShift) // | sequence; } /** * é˜»å¡åˆ°ä¸‹ä¸€ä¸ªæ¯«ç§’ï¼Œç›´åˆ°è·å¾—æ–°çš„æ—¶é—´æˆ³ * @param lastTimestamp ä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆª * @return å½“å‰æ—¶é—´æˆ³ */ protected long tilNextMillis(long lastTimestamp) { long timestamp = timeGen(); while (timestamp \u0026lt;= lastTimestamp) { timestamp = timeGen(); } return timestamp; } /** * è¿”å›ä»¥æ¯«ç§’ä¸ºå•ä½çš„å½“å‰æ—¶é—´ * @return å½“å‰æ—¶é—´(æ¯«ç§’) */ protected long timeGen() { return System.currentTimeMillis(); } public static void main(String[] args) throws InterruptedException { SnowflakeIdWorker idWorker = new SnowflakeIdWorker(0, 0); for (int i = 0; i \u0026lt; 10; i++) { long id = idWorker.nextId(); Thread.sleep(1); System.out.println(id); } } } reference: https://github.com/twitter-archive/snowflake https://github.com/beyondfengyu/SnowFlake/blob/master/SnowFlake.java https://blog.csdn.net/qq_45408390/article/details/119793810 ","permalink":"https://xinqilin.github.io/post/architecture/snowflake-distributionkey/","tags":[],"title":"SnowFlake DistributionKey"},{"content":"æ¦‚è¿° å›æº¯æ¼”ç®—æ³•ï¼ˆBacktrackingï¼‰æ˜¯ä¸€ç¨®é€éè©¦éŒ¯ä¾†å°‹æ‰¾å•é¡Œè§£æ±ºæ–¹æ¡ˆçš„ç®—æ³•ç­–ç•¥ã€‚å®ƒç³»çµ±æ€§åœ°æœå°‹æ‰€æœ‰å¯èƒ½çš„å€™é¸è§£ï¼Œç•¶ç™¼ç¾å€™é¸è§£ä¸å¯èƒ½å®Œæˆæœ‰æ•ˆè§£æ™‚ï¼Œæœƒæ”¾æ£„è©²å€™é¸è§£ä¸¦ã€Œå›æº¯ã€åˆ°ä¸Šä¸€æ­¥ã€‚\nåŸºæœ¬åŸç† å›æº¯æ¼”ç®—æ³•éµå¾ªä¸‰å€‹æ ¸å¿ƒæ­¥é©Ÿï¼š\né¸æ“‡ï¼ˆChooseï¼‰ï¼šå¾ç•¶å‰ç‹€æ…‹çš„å¯é¸é …ä¸­åšå‡ºé¸æ“‡ æ¢ç´¢ï¼ˆExploreï¼‰ï¼šRecursionåœ°æ¢ç´¢é€™å€‹é¸æ“‡çš„å¾Œæœ æ’¤éŠ·ï¼ˆUn-chooseï¼‰ï¼šæ’¤éŠ·é¸æ“‡ï¼Œæ¢å¾©åˆ°é¸æ“‡å‰çš„ç‹€æ…‹ æ¼”ç®—æ³•æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 void backtrack(è·¯å¾‘, é¸æ“‡åˆ—è¡¨) { if (æ»¿è¶³çµæŸæ¢ä»¶) { result.add(è·¯å¾‘); return; } for (é¸æ“‡ : é¸æ“‡åˆ—è¡¨) { åšé¸æ“‡; // Choose backtrack(è·¯å¾‘, é¸æ“‡åˆ—è¡¨); // Explore æ’¤éŠ·é¸æ“‡; // Un-choose } } æ™‚é–“è¤‡é›œåº¦ ä¸€èˆ¬æƒ…æ³ä¸‹ï¼Œå›æº¯æ¼”ç®—æ³•çš„æ™‚é–“è¤‡é›œåº¦ç‚º O(b^d)ï¼Œå…¶ä¸­ï¼š\nb æ˜¯åˆ†æ”¯å› å­ï¼ˆæ¯å€‹ç¯€é»çš„å¹³å‡å­ç¯€é»æ•¸ï¼‰ d æ˜¯æœå°‹æ·±åº¦ ç¶“å…¸æ‡‰ç”¨é¡Œå‹ 1. å­é›†å•é¡Œï¼ˆSubsetsï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹æ•´æ•¸é™£åˆ— numsï¼Œå›å‚³è©²é™£åˆ—æ‰€æœ‰å¯èƒ½çš„å­é›†ï¼ˆå†ªé›†åˆï¼‰ã€‚\nè§£é¡Œæ€è·¯ï¼š\nå°æ–¼æ¯å€‹å…ƒç´ ï¼Œæˆ‘å€‘éƒ½æœ‰ã€Œé¸æ“‡ã€æˆ–ã€Œä¸é¸æ“‡ã€å…©ç¨®æ±ºç­– ä½¿ç”¨å›æº¯æ³•éæ­·æ‰€æœ‰å¯èƒ½çš„çµ„åˆ æ¯æ¬¡Recursionéƒ½å°‡ç•¶å‰è·¯å¾‘åŠ å…¥çµæœé›† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; subsets(int[] nums) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); Arrays.sort(nums); // æ’åºä¾¿æ–¼è™•ç† backtrack(result, new ArrayList\u0026lt;\u0026gt;(), nums, 0); return result; } private void backtrack(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result, List\u0026lt;Integer\u0026gt; currentPath, int[] nums, int startIndex) { // æ¯å€‹ç‹€æ…‹éƒ½æ˜¯ä¸€å€‹æœ‰æ•ˆçš„å­é›† result.add(new ArrayList\u0026lt;\u0026gt;(currentPath)); // å¾ startIndex é–‹å§‹éæ­·ï¼Œé¿å…é‡è¤‡çµ„åˆ for (int i = startIndex; i \u0026lt; nums.length; i++) { // åšé¸æ“‡ï¼šå°‡ç•¶å‰å…ƒç´ åŠ å…¥è·¯å¾‘ currentPath.add(nums[i]); // Recursionæ¢ç´¢ï¼šç¹¼çºŒé¸æ“‡ä¸‹ä¸€å€‹å…ƒç´  backtrack(result, currentPath, nums, i + 1); // æ’¤éŠ·é¸æ“‡ï¼šç§»é™¤ç•¶å‰å…ƒç´ ï¼Œå›æº¯ currentPath.remove(currentPath.size() - 1); } } æ™‚é–“è¤‡é›œåº¦ï¼šO(2^n)ï¼Œå…¶ä¸­ n æ˜¯é™£åˆ—é•·åº¦ï¼Œå› ç‚ºæ¯å€‹å…ƒç´ éƒ½æœ‰é¸æˆ–ä¸é¸å…©ç¨®ç‹€æ…‹ã€‚\n2. å­é›†å•é¡Œ IIï¼ˆSubsets II - å«é‡è¤‡å…ƒç´ ï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹å¯èƒ½åŒ…å«é‡è¤‡æ•´æ•¸çš„é™£åˆ— numsï¼Œå›å‚³è©²é™£åˆ—æ‰€æœ‰å¯èƒ½çš„å­é›†ï¼ˆä¸åŒ…å«é‡è¤‡çš„å­é›†ï¼‰ã€‚\nè§£é¡Œæ€è·¯ï¼š\nåŸºæ–¼å­é›†å•é¡Œçš„è§£æ³•ï¼Œä½†éœ€è¦è™•ç†é‡è¤‡å…ƒç´  å…ˆæ’åºé™£åˆ—ï¼Œè®“ç›¸åŒå…ƒç´ ç›¸é„° é€éè·³éé‡è¤‡å…ƒç´ ä¾†é¿å…ç”¢ç”Ÿé‡è¤‡çš„å­é›† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; subsetsWithDup(int[] nums) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); Arrays.sort(nums); // æ’åºæ˜¯é—œéµï¼Œè®“é‡è¤‡å…ƒç´ ç›¸é„° backtrack(result, new ArrayList\u0026lt;\u0026gt;(), nums, 0); return result; } private void backtrack(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result, List\u0026lt;Integer\u0026gt; currentPath, int[] nums, int startIndex) { // æ¯å€‹ç‹€æ…‹éƒ½æ˜¯ä¸€å€‹æœ‰æ•ˆçš„å­é›† result.add(new ArrayList\u0026lt;\u0026gt;(currentPath)); for (int i = startIndex; i \u0026lt; nums.length; i++) { // è·³éé‡è¤‡å…ƒç´ ï¼šç•¶å‰å…ƒç´ èˆ‡å‰ä¸€å€‹å…ƒç´ ç›¸åŒï¼Œä¸”ä¸æ˜¯èµ·å§‹ä½ç½® if (i \u0026gt; startIndex \u0026amp;\u0026amp; nums[i] == nums[i - 1]) { continue; // è·³éé‡è¤‡å…ƒç´ é¿å…ç”¢ç”Ÿé‡è¤‡å­é›† } // åšé¸æ“‡ currentPath.add(nums[i]); // Recursionæ¢ç´¢ backtrack(result, currentPath, nums, i + 1); // æ’¤éŠ·é¸æ“‡ currentPath.remove(currentPath.size() - 1); } } å»é‡é—œéµï¼ši \u0026gt; startIndex \u0026amp;\u0026amp; nums[i] == nums[i-1] é€™å€‹æ¢ä»¶ç¢ºä¿åœ¨åŒä¸€å±¤Recursionä¸­è·³éé‡è¤‡å…ƒç´ ã€‚\n3. å…¨æ’åˆ—ï¼ˆPermutationsï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹ä¸å«é‡è¤‡æ•¸å­—çš„é™£åˆ— numsï¼Œå›å‚³å…¶æ‰€æœ‰å¯èƒ½çš„å…¨æ’åˆ—ã€‚\nè§£é¡Œæ€è·¯ï¼š\nå…¨æ’åˆ—éœ€è¦ç”¨åˆ°é™£åˆ—ä¸­çš„æ¯ä¸€å€‹å…ƒç´ ï¼Œä¸”é †åºä¸åŒçµæœä¸åŒ ä½¿ç”¨ contains æª¢æŸ¥é¿å…é‡è¤‡ä½¿ç”¨åŒä¸€å€‹å…ƒç´  ç•¶è·¯å¾‘é•·åº¦ç­‰æ–¼é™£åˆ—é•·åº¦æ™‚ï¼Œæ‰¾åˆ°ä¸€å€‹å®Œæ•´çš„æ’åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 public List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; permute(int[] nums) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); backtrack(result, new ArrayList\u0026lt;\u0026gt;(), nums); return result; } private void backtrack(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result, List\u0026lt;Integer\u0026gt; currentPath, int[] nums) { // é”åˆ°ç›®æ¨™é•·åº¦ï¼Œæ‰¾åˆ°ä¸€å€‹å®Œæ•´çš„æ’åˆ— if (currentPath.size() == nums.length) { result.add(new ArrayList\u0026lt;\u0026gt;(currentPath)); return; } // å˜—è©¦æ·»åŠ æ¯ä¸€å€‹å…ƒç´  for (int i = 0; i \u0026lt; nums.length; i++) { // è·³éå·²ç¶“ä½¿ç”¨çš„å…ƒç´  if (currentPath.contains(nums[i])) { continue; // è©²å…ƒç´ å·²åœ¨ç•¶å‰è·¯å¾‘ä¸­ï¼Œè·³é } // åšé¸æ“‡ currentPath.add(nums[i]); // Recursionæ¢ç´¢ backtrack(result, currentPath, nums); // æ’¤éŠ·é¸æ“‡ currentPath.remove(currentPath.size() - 1); } } æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ boolean[] used é™£åˆ—å–ä»£ contains æ–¹æ³•å¯ä»¥æå‡æ•ˆèƒ½ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 private void backtrackOptimized(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result, List\u0026lt;Integer\u0026gt; currentPath, int[] nums, boolean[] used) { if (currentPath.size() == nums.length) { result.add(new ArrayList\u0026lt;\u0026gt;(currentPath)); return; } for (int i = 0; i \u0026lt; nums.length; i++) { if (used[i]) continue; // O(1) æ™‚é–“æª¢æŸ¥ used[i] = true; currentPath.add(nums[i]); backtrackOptimized(result, currentPath, nums, used); currentPath.remove(currentPath.size() - 1); used[i] = false; } } æ™‚é–“è¤‡é›œåº¦ï¼šO(n Ã— n!)ï¼Œå…¶ä¸­ n! æ˜¯æ’åˆ—çš„æ•¸é‡ï¼Œn æ˜¯è¤‡è£½æ¯å€‹æ’åˆ—æ‰€éœ€çš„æ™‚é–“ã€‚\n4. å…¨æ’åˆ— IIï¼ˆPermutations II - å«é‡è¤‡å…ƒç´ ï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹å¯åŒ…å«é‡è¤‡æ•¸å­—çš„åºåˆ— numsï¼ŒæŒ‰ä»»æ„é †åºå›å‚³æ‰€æœ‰ä¸é‡è¤‡çš„å…¨æ’åˆ—ã€‚\nè§£é¡Œæ€è·¯ï¼š\nåœ¨å…¨æ’åˆ—çš„åŸºç¤ä¸Šå¢åŠ å»é‡é‚è¼¯ å…ˆæ’åºè®“ç›¸åŒå…ƒç´ ç›¸é„° ä½¿ç”¨å‰ªææ¢ä»¶é¿å…ç”¢ç”Ÿé‡è¤‡çš„æ’åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 public List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; permuteUnique(int[] nums) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); Arrays.sort(nums); // æ’åºæ˜¯å»é‡çš„é—œéµ boolean[] used = new boolean[nums.length]; backtrack(result, new ArrayList\u0026lt;\u0026gt;(), nums, used); return result; } private void backtrack(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result, List\u0026lt;Integer\u0026gt; currentPath, int[] nums, boolean[] used) { // é”åˆ°ç›®æ¨™é•·åº¦ï¼Œæ‰¾åˆ°ä¸€å€‹å®Œæ•´çš„æ’åˆ— if (currentPath.size() == nums.length) { result.add(new ArrayList\u0026lt;\u0026gt;(currentPath)); return; } for (int i = 0; i \u0026lt; nums.length; i++) { // è·³éå·²ä½¿ç”¨çš„å…ƒç´  if (used[i]) continue; // å»é‡é—œéµï¼šè·³éé‡è¤‡å…ƒç´  // ç•¶å‰å…ƒç´ èˆ‡å‰ä¸€å€‹å…ƒç´ ç›¸åŒï¼Œä¸”å‰ä¸€å€‹å…ƒç´ æœªè¢«ä½¿ç”¨ if (i \u0026gt; 0 \u0026amp;\u0026amp; nums[i] == nums[i - 1] \u0026amp;\u0026amp; !used[i - 1]) { continue; } // åšé¸æ“‡ used[i] = true; currentPath.add(nums[i]); // Recursionæ¢ç´¢ backtrack(result, currentPath, nums, used); // æ’¤éŠ·é¸æ“‡ currentPath.remove(currentPath.size() - 1); used[i] = false; } } å»é‡åŸç†ï¼š!used[i-1] ç¢ºä¿åœ¨åŒä¸€å±¤Recursionä¸­ï¼Œç›¸åŒçš„å…ƒç´ åªæœƒè¢«é¸æ“‡ä¸€æ¬¡ï¼Œå¾è€Œé¿å…é‡è¤‡æ’åˆ—ã€‚\n5. çµ„åˆç¸½å’Œï¼ˆCombination Sum - å¯é‡è¤‡ä½¿ç”¨å…ƒç´ ï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹ç„¡é‡è¤‡å…ƒç´ çš„é™£åˆ— candidates å’Œä¸€å€‹ç›®æ¨™æ•¸ targetï¼Œæ‰¾å‡ºæ‰€æœ‰ä½¿å…ƒç´ å’Œç‚º target çš„çµ„åˆã€‚åŒä¸€å€‹æ•¸å­—å¯ä»¥è¢«é‡è¤‡é¸æ“‡ã€‚\nè§£é¡Œæ€è·¯ï¼š\næ¯å€‹å…ƒç´ éƒ½å¯ä»¥è¢«ç„¡é™æ¬¡é‡è¤‡ä½¿ç”¨ ä½¿ç”¨ startIndex é¿å…ç”¢ç”Ÿé‡è¤‡çµ„åˆï¼ˆå¦‚ [2,3] å’Œ [3,2]ï¼‰ ç•¶å‰©é¤˜ç›®æ¨™å€¼ç‚º 0 æ™‚æ‰¾åˆ°ä¸€å€‹æœ‰æ•ˆçµ„åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; combinationSum(int[] candidates, int target) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); Arrays.sort(candidates); // æ’åºä¾¿æ–¼å‰ªæ backtrack(result, new ArrayList\u0026lt;\u0026gt;(), candidates, target, 0); return result; } private void backtrack(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result, List\u0026lt;Integer\u0026gt; currentPath, int[] candidates, int remainingTarget, int startIndex) { // å‰ªæï¼šå‰©é¤˜ç›®æ¨™å€¼å°æ–¼ 0ï¼Œç„¡æ•ˆè·¯å¾‘ if (remainingTarget \u0026lt; 0) { return; } // æ‰¾åˆ°ä¸€å€‹æœ‰æ•ˆçµ„åˆ if (remainingTarget == 0) { result.add(new ArrayList\u0026lt;\u0026gt;(currentPath)); return; } for (int i = startIndex; i \u0026lt; candidates.length; i++) { // å‰ªæå„ªåŒ–ï¼šå¦‚æœç•¶å‰å…ƒç´ å·²ç¶“å¤§æ–¼å‰©é¤˜ç›®æ¨™å€¼ï¼Œå¾Œé¢çš„å…ƒç´ ä¹Ÿæœƒæ›´å¤§ if (candidates[i] \u0026gt; remainingTarget) { break; } // åšé¸æ“‡ currentPath.add(candidates[i]); // Recursionæ¢ç´¢ï¼šæ³¨æ„é€™è£¡å‚³å…¥ i è€Œä¸æ˜¯ i+1ï¼Œå› ç‚ºå¯ä»¥é‡è¤‡ä½¿ç”¨åŒä¸€å…ƒç´  backtrack(result, currentPath, candidates, remainingTarget - candidates[i], i); // æ’¤éŠ·é¸æ“‡ currentPath.remove(currentPath.size() - 1); } } é—œéµé»ï¼š\nRecursionæ™‚å‚³å…¥ i è€Œé i+1ï¼Œå…è¨±é‡è¤‡ä½¿ç”¨ç•¶å‰å…ƒç´  æ’åºå¾Œå¯ä»¥é€²è¡Œå‰ªæå„ªåŒ–ï¼Œææ—©çµ‚æ­¢ç„¡æ•ˆåˆ†æ”¯ 6. çµ„åˆç¸½å’Œ IIï¼ˆCombination Sum II - å«é‡è¤‡å…ƒç´ ä½†ä¸å¯é‡è¤‡ä½¿ç”¨ï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹é™£åˆ— candidates å’Œä¸€å€‹ç›®æ¨™æ•¸ targetï¼Œæ‰¾å‡ºæ‰€æœ‰ä½¿å…ƒç´ å’Œç‚º target çš„çµ„åˆã€‚é™£åˆ—ä¸­æ¯å€‹å…ƒç´ åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œä½†é™£åˆ—ä¸­å¯èƒ½åŒ…å«é‡è¤‡å…ƒç´ ã€‚\nè§£é¡Œæ€è·¯ï¼š\næ¯å€‹å…ƒç´ åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œéœ€è¦è·³éé‡è¤‡å…ƒç´ é¿å…é‡è¤‡çµ„åˆ æ’åºå¾Œä½¿ç”¨å»é‡é‚è¼¯ Recursionæ™‚å‚³å…¥ i+1 ç¢ºä¿æ¯å€‹ä½ç½®çš„å…ƒç´ åªèƒ½ä½¿ç”¨ä¸€æ¬¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 public List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; combinationSum2(int[] candidates, int target) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); Arrays.sort(candidates); // æ’åºæ˜¯å»é‡çš„å‰æ backtrack(result, new ArrayList\u0026lt;\u0026gt;(), candidates, target, 0); return result; } private void backtrack(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; result, List\u0026lt;Integer\u0026gt; currentPath, int[] candidates, int remainingTarget, int startIndex) { // å‰ªæï¼šå‰©é¤˜ç›®æ¨™å€¼å°æ–¼ 0 if (remainingTarget \u0026lt; 0) { return; } // æ‰¾åˆ°ä¸€å€‹æœ‰æ•ˆçµ„åˆ if (remainingTarget == 0) { result.add(new ArrayList\u0026lt;\u0026gt;(currentPath)); return; } for (int i = startIndex; i \u0026lt; candidates.length; i++) { // è·³éé‡è¤‡å…ƒç´ ï¼šé¿å…åœ¨åŒä¸€å±¤Recursionä¸­ä½¿ç”¨ç›¸åŒçš„å…ƒç´  if (i \u0026gt; startIndex \u0026amp;\u0026amp; candidates[i] == candidates[i - 1]) { continue; // è·³éé‡è¤‡å…ƒç´  } // å‰ªæå„ªåŒ– if (candidates[i] \u0026gt; remainingTarget) { break; } // åšé¸æ“‡ currentPath.add(candidates[i]); // Recursionæ¢ç´¢ï¼šå‚³å…¥ i+1 ç¢ºä¿æ¯å€‹å…ƒç´ åªä½¿ç”¨ä¸€æ¬¡ backtrack(result, currentPath, candidates, remainingTarget - candidates[i], i + 1); // æ’¤éŠ·é¸æ“‡ currentPath.remove(currentPath.size() - 1); } } èˆ‡ Combination Sum çš„å·®ç•°ï¼š\nRecursionæ™‚å‚³å…¥ i+1 è€Œé iï¼Œæ¯å€‹å…ƒç´ åªèƒ½ä½¿ç”¨ä¸€æ¬¡ å¢åŠ å»é‡é‚è¼¯è™•ç†é™£åˆ—ä¸­çš„é‡è¤‡å…ƒç´  7. å›æ–‡å­—ä¸²åˆ†å‰²ï¼ˆPalindrome Partitioningï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šä¸€å€‹å­—ä¸² sï¼Œå°‡ s åˆ†å‰²æˆä¸€äº›å­å­—ä¸²ï¼Œä½¿å¾—æ¯å€‹å­å­—ä¸²éƒ½æ˜¯å›æ–‡å­—ä¸²ã€‚å›å‚³æ‰€æœ‰å¯èƒ½çš„åˆ†å‰²æ–¹æ¡ˆã€‚\nè§£é¡Œæ€è·¯ï¼š\né€éå›æº¯æ³•å˜—è©¦æ‰€æœ‰å¯èƒ½çš„åˆ†å‰²é» å°æ–¼æ¯å€‹åˆ†å‰²é»ï¼Œæª¢æŸ¥å­å­—ä¸²æ˜¯å¦ç‚ºå›æ–‡ åªæœ‰ç•¶å­å­—ä¸²æ˜¯å›æ–‡æ™‚ï¼Œæ‰ç¹¼çºŒRecursionåˆ†å‰² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 public List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; partition(String s) { List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); backtrack(result, new ArrayList\u0026lt;\u0026gt;(), s, 0); return result; } private void backtrack(List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; result, List\u0026lt;String\u0026gt; currentPath, String s, int startIndex) { // é”åˆ°å­—ä¸²çµå°¾ï¼Œæ‰¾åˆ°ä¸€å€‹å®Œæ•´çš„åˆ†å‰²æ–¹æ¡ˆ if (startIndex == s.length()) { result.add(new ArrayList\u0026lt;\u0026gt;(currentPath)); return; } // å˜—è©¦æ‰€æœ‰å¯èƒ½çš„åˆ†å‰²é» for (int endIndex = startIndex; endIndex \u0026lt; s.length(); endIndex++) { // æª¢æŸ¥ç•¶å‰å­å­—ä¸²æ˜¯å¦ç‚ºå›æ–‡ if (isPalindrome(s, startIndex, endIndex)) { // åšé¸æ“‡ï¼šå°‡å›æ–‡å­å­—ä¸²åŠ å…¥è·¯å¾‘ currentPath.add(s.substring(startIndex, endIndex + 1)); // Recursionæ¢ç´¢ï¼šç¹¼çºŒåˆ†å‰²å‰©é¤˜éƒ¨åˆ† backtrack(result, currentPath, s, endIndex + 1); // æ’¤éŠ·é¸æ“‡ currentPath.remove(currentPath.size() - 1); } } } /** * æª¢æŸ¥å­—ä¸²çš„æŒ‡å®šç¯„åœæ˜¯å¦ç‚ºå›æ–‡ */ private boolean isPalindrome(String s, int left, int right) { while (left \u0026lt; right) { if (s.charAt(left) != s.charAt(right)) { return false; } left++; right--; } return true; } å„ªåŒ–æŠ€å·§ï¼šå¯ä»¥é è™•ç†å›æ–‡åˆ¤æ–·çµæœï¼Œä½¿ç”¨å‹•æ…‹è¦åŠƒå»ºç«‹å›æ–‡æŸ¥è©¢è¡¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // é è™•ç†å„ªåŒ–ç‰ˆæœ¬ private boolean[][] precomputePalindromes(String s) { int n = s.length(); boolean[][] isPalin = new boolean[n][n]; // å–®å€‹å­—å…ƒéƒ½æ˜¯å›æ–‡ for (int i = 0; i \u0026lt; n; i++) { isPalin[i][i] = true; } // æª¢æŸ¥é•·åº¦ç‚º 2 çš„å­å­—ä¸² for (int i = 0; i \u0026lt; n - 1; i++) { isPalin[i][i + 1] = (s.charAt(i) == s.charAt(i + 1)); } // æª¢æŸ¥é•·åº¦å¤§æ–¼ 2 çš„å­å­—ä¸² for (int len = 3; len \u0026lt;= n; len++) { for (int i = 0; i \u0026lt;= n - len; i++) { int j = i + len - 1; isPalin[i][j] = (s.charAt(i) == s.charAt(j)) \u0026amp;\u0026amp; isPalin[i + 1][j - 1]; } } return isPalin; } æœ€ä½³å¯¦è¸èˆ‡æŠ€å·§ 1. å‰ªæå„ªåŒ– ææ—©çµ‚æ­¢ï¼šç•¶ç™¼ç¾ç•¶å‰è·¯å¾‘ä¸å¯èƒ½ç”¢ç”Ÿæœ‰æ•ˆè§£æ™‚ï¼Œç«‹å³è¿”å› æ’åºå„ªåŒ–ï¼šå°è¼¸å…¥é€²è¡Œæ’åºï¼Œä¾¿æ–¼è·³éé‡è¤‡å…ƒç´ å’Œé€²è¡Œç¯„åœå‰ªæ é‚Šç•Œæª¢æŸ¥ï¼šåœ¨Recursionå‰æª¢æŸ¥é‚Šç•Œæ¢ä»¶ï¼Œé¿å…ç„¡æ•ˆRecursion 2. å»é‡æŠ€å·§ å›æº¯å•é¡Œä¸­çš„å»é‡é€šå¸¸æœ‰å…©ç¨®æƒ…æ³ï¼š\næ¨¹æå»é‡ï¼šé¿å…åœ¨åŒä¸€æ¢è·¯å¾‘ä¸Šé‡è¤‡ä½¿ç”¨åŒä¸€å€‹å…ƒç´  æ¨¹å±¤å»é‡ï¼šé¿å…åœ¨åŒä¸€å±¤Recursionä¸­ç”¢ç”Ÿé‡è¤‡çš„é¸æ“‡ 1 2 3 4 5 // æ¨¹å±¤å»é‡ï¼ˆé©ç”¨æ–¼æœ‰é‡è¤‡å…ƒç´ çš„çµ„åˆå•é¡Œï¼‰ if (i \u0026gt; startIndex \u0026amp;\u0026amp; nums[i] == nums[i-1]) continue; // æ¨¹æå»é‡ï¼ˆé©ç”¨æ–¼æ’åˆ—å•é¡Œï¼‰ if (i \u0026gt; 0 \u0026amp;\u0026amp; nums[i] == nums[i-1] \u0026amp;\u0026amp; !used[i-1]) continue; 3. æ•ˆèƒ½å„ªåŒ– ä½¿ç”¨ boolean[] å–ä»£ List.contains() é€²è¡Œå…ƒç´ æŸ¥æ‰¾ é è™•ç†è¨ˆç®—çµæœï¼ˆå¦‚å›æ–‡åˆ¤æ–·è¡¨ï¼‰ åˆç†é¸æ“‡è³‡æ–™çµæ§‹ï¼ˆå¦‚ä½¿ç”¨ StringBuilder è™•ç†å­—ä¸²ï¼‰ å¸¸è¦‹éŒ¯èª¤èˆ‡é™·é˜± å¿˜è¨˜æ’¤éŠ·é¸æ“‡ï¼šé€™æ˜¯å›æº¯æ¼”ç®—æ³•æœ€å¸¸è¦‹çš„éŒ¯èª¤ é‡è¤‡è§£è™•ç†ä¸ç•¶ï¼šæ²’æœ‰æ­£ç¢ºå¯¦ç¾å»é‡é‚è¼¯ é‚Šç•Œæ¢ä»¶éŒ¯èª¤ï¼šRecursionçµ‚æ­¢æ¢ä»¶è¨­ç½®ä¸æ­£ç¢º ç´¢å¼•ä½¿ç”¨éŒ¯èª¤ï¼šåœ¨çµ„åˆå’Œæ’åˆ—å•é¡Œä¸­æ··æ·† i å’Œ i+1 çš„ä½¿ç”¨ ç¸½çµ å›æº¯æ¼”ç®—æ³•æ˜¯è§£æ±ºçµ„åˆã€æ’åˆ—ã€åˆ†å‰²ç­‰å•é¡Œçš„é‡è¦å·¥å…·ã€‚æŒæ¡ä»¥ä¸‹è¦é»ï¼š\nç†è§£æ¨¡æ¿ï¼šChoose â†’ Explore â†’ Un-choose ä¸‰æ­¥é©Ÿ è­˜åˆ¥å•é¡Œé¡å‹ï¼šå­é›†ã€æ’åˆ—ã€çµ„åˆã€åˆ†å‰²ç­‰ä¸åŒé¡å‹æœ‰ä¸åŒçš„è™•ç†æ–¹å¼ æŒæ¡å»é‡æŠ€å·§ï¼šæ¨¹å±¤å»é‡å’Œæ¨¹æå»é‡çš„å€åˆ¥å’Œæ‡‰ç”¨ å–„ç”¨å‰ªæï¼šé€éå‰ªæå¤§å¹…æå‡æ¼”ç®—æ³•æ•ˆèƒ½ ç´°å¿ƒå¯¦ä½œï¼šæ³¨æ„é‚Šç•Œæ¢ä»¶å’Œç´¢å¼•ä½¿ç”¨ é€éå¤§é‡ç·´ç¿’å’Œç†è§£é€™äº›ç¶“å…¸é¡Œå‹ï¼Œèƒ½å¤ å¹«åŠ©æˆ‘å€‘æ›´å¥½åœ°æŒæ¡å›æº¯æ¼”ç®—æ³•çš„ç²¾é«“ã€‚\n","permalink":"https://xinqilin.github.io/post/algorithm/backtracking/","tags":["Algorithm","Backtracking","Recursion"],"title":"å›æº¯æ¼”ç®—æ³•ï¼ˆBacktrackingï¼‰å®Œæ•´æŒ‡å—"},{"content":"ä»£ç¢¼å£å‘³é“ (Code Smells) å®Œæ•´è­˜åˆ¥èˆ‡é‡æ§‹æŒ‡å— æ¦‚è¿° ä»£ç¢¼å£å‘³é“æ˜¯æŒ‡ä»£ç¢¼ä¸­å­˜åœ¨çš„è¨­è¨ˆç¼ºé™·å’Œçµæ§‹å•é¡Œï¼Œé›–ç„¶ä¸æœƒå°è‡´ç¨‹åºåŠŸèƒ½éŒ¯èª¤ï¼Œä½†æœƒå½±éŸ¿ä»£ç¢¼çš„å¯è®€æ€§ã€å¯ç¶­è­·æ€§å’Œå¯æ“´å±•æ€§ã€‚æœ¬æ–‡å°‡æ·±å…¥æ¢è¨å„ç¨®ä»£ç¢¼å£å‘³é“çš„è­˜åˆ¥æ–¹æ³•ã€é‡æ§‹æŠ€å·§å’Œé é˜²ç­–ç•¥ã€‚\nç¶“å…¸å››å¤§è»Ÿé«”è¨­è¨ˆå•é¡Œ 1. Rigidity (åƒµåŒ–æ€§) - é›£ä»¥è®Šæ›´ å•é¡Œæè¿°ï¼š ç³»çµ±ä¸­å­˜åœ¨éå¤šçš„ç›¸ä¾æ€§ï¼Œå°è‡´ä»»ä½•å°çš„è®Šæ›´éƒ½éœ€è¦ä¿®æ”¹å¤§é‡ç›¸é—œä»£ç¢¼ã€‚\nç—‡ç‹€ï¼š\nä¿®æ”¹ä¸€å€‹å°åŠŸèƒ½éœ€è¦æ”¹å‹•å¤šå€‹æ¨¡çµ„ é–‹ç™¼äººå“¡å®³æ€•é€²è¡Œä»£ç¢¼è®Šæ›´ ä¼°ç®—å·¥ä½œé‡å›°é›£ï¼Œå› ç‚ºè®Šæ›´ç¯„åœé›£ä»¥é æ¸¬ å£å‘³é“ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // åƒµåŒ–çš„è¨‚å–®è™•ç†ç³»çµ± public class OrderService { private DatabaseConnection dbConnection; private EmailService emailService; private InventoryService inventoryService; private PaymentService paymentService; private LoggingService loggingService; public void processOrder(Order order) { // ç›´æ¥ä¾è³´å…·é«”å¯¦ç¾ï¼Œé›£ä»¥è®Šæ›´ dbConnection.connect(\u0026#34;jdbc:mysql://localhost:3306/orders\u0026#34;); // ç¡¬ç·¨ç¢¼çš„æ¥­å‹™é‚è¼¯ if (order.getType().equals(\u0026#34;PREMIUM\u0026#34;)) { order.setDiscount(0.1); } else if (order.getType().equals(\u0026#34;STANDARD\u0026#34;)) { order.setDiscount(0.05); } // ç·Šå¯†è€¦åˆçš„æ“ä½œé †åº inventoryService.reserveItems(order.getItems()); paymentService.processPayment(order.getPayment()); dbConnection.saveOrder(order); emailService.sendConfirmationEmail(order.getCustomer()); loggingService.log(\u0026#34;Order processed: \u0026#34; + order.getId()); } } é‡æ§‹è§£æ±ºæ–¹æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 // ä½¿ç”¨ä¾è³´æ³¨å…¥å’Œç­–ç•¥æ¨¡å¼è§£æ±ºåƒµåŒ–æ€§ public class OrderService { private final OrderRepository orderRepository; private final NotificationService notificationService; private final InventoryService inventoryService; private final PaymentService paymentService; private final AuditService auditService; private final DiscountCalculator discountCalculator; public OrderService(OrderRepository orderRepository, NotificationService notificationService, InventoryService inventoryService, PaymentService paymentService, AuditService auditService, DiscountCalculator discountCalculator) { this.orderRepository = orderRepository; this.notificationService = notificationService; this.inventoryService = inventoryService; this.paymentService = paymentService; this.auditService = auditService; this.discountCalculator = discountCalculator; } public void processOrder(Order order) { // ä½¿ç”¨ç­–ç•¥æ¨¡å¼è¨ˆç®—æŠ˜æ‰£ order.setDiscount(discountCalculator.calculateDiscount(order)); // è§£è€¦çš„æ“ä½œæµç¨‹ inventoryService.reserveItems(order.getItems()); paymentService.processPayment(order.getPayment()); orderRepository.save(order); notificationService.sendNotification(order.getCustomer(), createConfirmationMessage(order)); auditService.logOrderProcessed(order); } private String createConfirmationMessage(Order order) { return \u0026#34;è¨‚å–® \u0026#34; + order.getId() + \u0026#34; å·²æˆåŠŸè™•ç†\u0026#34;; } } // ç­–ç•¥æ¨¡å¼å¯¦ç¾æŠ˜æ‰£è¨ˆç®— public interface DiscountCalculator { double calculateDiscount(Order order); } @Component public class CustomerTypeDiscountCalculator implements DiscountCalculator { private final Map\u0026lt;String, Double\u0026gt; discountRates; public CustomerTypeDiscountCalculator() { this.discountRates = Map.of( \u0026#34;PREMIUM\u0026#34;, 0.1, \u0026#34;STANDARD\u0026#34;, 0.05, \u0026#34;BASIC\u0026#34;, 0.0 ); } @Override public double calculateDiscount(Order order) { return discountRates.getOrDefault(order.getCustomerType(), 0.0); } } 2. Fragility (è„†å¼±æ€§) - å®¹æ˜“å£æ‰ å•é¡Œæè¿°ï¼š ç³»çµ±ä¸­ä¸€å€‹åœ°æ–¹çš„è®Šæ›´æœƒåœ¨æ„å¤–çš„åœ°æ–¹å¼•èµ·å•é¡Œï¼Œç‰¹åˆ¥æ˜¯åœ¨é‚è¼¯ä¸Šä¸ç›¸é—œçš„éƒ¨åˆ†ã€‚\nç—‡ç‹€ï¼š\nä¿®å¾©ä¸€å€‹bugæœƒå¼•èµ·å…¶ä»–åœ°æ–¹çš„å•é¡Œ æ¸¬è©¦ç¶“å¸¸å¤±æ•—ï¼Œä¸”å¤±æ•—åŸå› ä¸æ˜é¡¯ ç”Ÿç”¢ç’°å¢ƒç¶“å¸¸å‡ºç¾æ„å¤–å•é¡Œ å£å‘³é“ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // è„†å¼±çš„ç”¨æˆ¶ç®¡ç†ç³»çµ± public class UserManager { private static List\u0026lt;User\u0026gt; users = new ArrayList\u0026lt;\u0026gt;(); private static int nextId = 1; public static User createUser(String name, String email) { User user = new User(nextId++, name, email); users.add(user); // è„†å¼±çš„å‰¯ä½œç”¨ï¼šä¿®æ”¹å…¨å±€ç‹€æ…‹ System.setProperty(\u0026#34;last.user.created\u0026#34;, user.getName()); // è„†å¼±çš„ä¾è³´ï¼šç›´æ¥æ“ä½œæ–‡ä»¶ç³»çµ± try (FileWriter writer = new FileWriter(\u0026#34;users.log\u0026#34;, true)) { writer.write(user.toString() + \u0026#34;\\n\u0026#34;); } catch (IOException e) { // éœé»˜è™•ç†ç•°å¸¸ï¼Œéš±è—å•é¡Œ } return user; } public static void deleteUser(int id) { users.removeIf(user -\u0026gt; user.getId() == id); // è„†å¼±çš„é‚è¼¯ï¼šå‡è¨­ç¸½æ˜¯å­˜åœ¨ç”¨æˆ¶ User lastUser = users.get(users.size() - 1); System.setProperty(\u0026#34;last.user.created\u0026#34;, lastUser.getName()); } public static List\u0026lt;User\u0026gt; getUsers() { // è¿”å›å¯è®Šå¼•ç”¨ï¼Œå…è¨±å¤–éƒ¨ä¿®æ”¹ return users; } } é‡æ§‹è§£æ±ºæ–¹æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 // ä½¿ç”¨å°è£å’Œä¸å¯è®Šæ€§è§£æ±ºè„†å¼±æ€§ @Service public class UserService { private final UserRepository userRepository; private final UserAuditService auditService; private final EventPublisher eventPublisher; public UserService(UserRepository userRepository, UserAuditService auditService, EventPublisher eventPublisher) { this.userRepository = userRepository; this.auditService = auditService; this.eventPublisher = eventPublisher; } @Transactional public User createUser(CreateUserRequest request) { validateUserRequest(request); User user = User.builder() .name(request.getName()) .email(request.getEmail()) .createdAt(LocalDateTime.now()) .build(); User savedUser = userRepository.save(user); // ä½¿ç”¨äº‹ä»¶ç™¼å¸ƒè§£è€¦å‰¯ä½œç”¨ eventPublisher.publish(new UserCreatedEvent(savedUser)); return savedUser; } @Transactional public void deleteUser(Long id) { User user = userRepository.findById(id) .orElseThrow(() -\u0026gt; new UserNotFoundException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨: \u0026#34; + id)); userRepository.delete(user); eventPublisher.publish(new UserDeletedEvent(user)); } public List\u0026lt;User\u0026gt; getUsers() { // è¿”å›ä¸å¯è®Šå‰¯æœ¬ return Collections.unmodifiableList(userRepository.findAll()); } private void validateUserRequest(CreateUserRequest request) { if (request.getName() == null || request.getName().trim().isEmpty()) { throw new ValidationException(\u0026#34;ç”¨æˆ¶åä¸èƒ½ç‚ºç©º\u0026#34;); } if (request.getEmail() == null || !isValidEmail(request.getEmail())) { throw new ValidationException(\u0026#34;ç„¡æ•ˆçš„é›»å­éƒµä»¶åœ°å€\u0026#34;); } } private boolean isValidEmail(String email) { return email.contains(\u0026#34;@\u0026#34;) \u0026amp;\u0026amp; email.contains(\u0026#34;.\u0026#34;); } } // äº‹ä»¶è™•ç†å™¨è™•ç†å‰¯ä½œç”¨ @Component public class UserEventHandler { private final UserAuditService auditService; public UserEventHandler(UserAuditService auditService) { this.auditService = auditService; } @EventListener public void handleUserCreated(UserCreatedEvent event) { auditService.logUserCreated(event.getUser()); } @EventListener public void handleUserDeleted(UserDeletedEvent event) { auditService.logUserDeleted(event.getUser()); } } 3. Immobility (ä¸å¯ç§»æ¤æ€§) - é›£ä»¥è¤‡ç”¨ å•é¡Œæè¿°ï¼š ç³»çµ±ä¸­çš„ä»£ç¢¼èˆ‡å…¶ç’°å¢ƒéåº¦è€¦åˆï¼Œé›£ä»¥åœ¨å…¶ä»–é …ç›®æˆ–æ¨¡çµ„ä¸­é‡è¤‡ä½¿ç”¨ã€‚\nç—‡ç‹€ï¼š\nç›¸ä¼¼çš„ä»£ç¢¼åœ¨å¤šå€‹åœ°æ–¹é‡è¤‡å‡ºç¾ æå–å…±ç”¨é‚è¼¯çš„æˆæœ¬å¾ˆé«˜ ä»£ç¢¼èˆ‡å…·é«”å¯¦ç¾ç´°ç¯€ç¶å®š å£å‘³é“ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 // ä¸å¯ç§»æ¤çš„å ±å‘Šç”Ÿæˆå™¨ public class SalesReportGenerator { public void generateDailySalesReport() { // ç¡¬ç·¨ç¢¼çš„æ•¸æ“šåº«æŸ¥è©¢ Connection conn = DriverManager.getConnection( \u0026#34;jdbc:mysql://localhost:3306/sales_db\u0026#34;, \u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;); PreparedStatement stmt = conn.prepareStatement( \u0026#34;SELECT product_id, SUM(quantity), SUM(amount) FROM orders WHERE date = ?\u0026#34;); stmt.setDate(1, Date.valueOf(LocalDate.now())); ResultSet rs = stmt.executeQuery(); // ç¡¬ç·¨ç¢¼çš„è¼¸å‡ºæ ¼å¼ System.out.println(\u0026#34;=== æ¯æ—¥éŠ·å”®å ±å‘Š ===\u0026#34;); while (rs.next()) { System.out.printf(\u0026#34;ç”¢å“ID: %d, æ•¸é‡: %d, é‡‘é¡: %.2f%n\u0026#34;, rs.getInt(1), rs.getInt(2), rs.getDouble(3)); } // ç¡¬ç·¨ç¢¼çš„æ–‡ä»¶ä¿å­˜ try (FileWriter writer = new FileWriter(\u0026#34;/tmp/daily_sales.txt\u0026#34;)) { writer.write(\u0026#34;å ±å‘Šç”Ÿæˆæ™‚é–“: \u0026#34; + LocalDateTime.now()); } } public void generateWeeklySalesReport() { // å¤§é‡é‡è¤‡çš„ä»£ç¢¼ Connection conn = DriverManager.getConnection( \u0026#34;jdbc:mysql://localhost:3306/sales_db\u0026#34;, \u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;); PreparedStatement stmt = conn.prepareStatement( \u0026#34;SELECT product_id, SUM(quantity), SUM(amount) FROM orders WHERE date \u0026gt;= ?\u0026#34;); stmt.setDate(1, Date.valueOf(LocalDate.now().minusDays(7))); ResultSet rs = stmt.executeQuery(); System.out.println(\u0026#34;=== æ¯é€±éŠ·å”®å ±å‘Š ===\u0026#34;); while (rs.next()) { System.out.printf(\u0026#34;ç”¢å“ID: %d, æ•¸é‡: %d, é‡‘é¡: %.2f%n\u0026#34;, rs.getInt(1), rs.getInt(2), rs.getDouble(3)); } } } é‡æ§‹è§£æ±ºæ–¹æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 // å¯è¤‡ç”¨çš„å ±å‘Šç”Ÿæˆæ¡†æ¶ public interface ReportDataSource { List\u0026lt;SalesData\u0026gt; getSalesData(DateRange dateRange); } public interface ReportFormatter { String format(List\u0026lt;SalesData\u0026gt; data, ReportMetadata metadata); } public interface ReportOutput { void output(String formattedReport, ReportMetadata metadata); } @Service public class ReportService { private final ReportDataSource dataSource; private final ReportFormatter formatter; private final List\u0026lt;ReportOutput\u0026gt; outputs; public ReportService(ReportDataSource dataSource, ReportFormatter formatter, List\u0026lt;ReportOutput\u0026gt; outputs) { this.dataSource = dataSource; this.formatter = formatter; this.outputs = outputs; } public void generateReport(ReportRequest request) { List\u0026lt;SalesData\u0026gt; data = dataSource.getSalesData(request.getDateRange()); ReportMetadata metadata = ReportMetadata.builder() .title(request.getTitle()) .generatedAt(LocalDateTime.now()) .dateRange(request.getDateRange()) .build(); String formattedReport = formatter.format(data, metadata); outputs.forEach(output -\u0026gt; output.output(formattedReport, metadata)); } } // å…·é«”å¯¦ç¾ @Component public class DatabaseReportDataSource implements ReportDataSource { private final SalesRepository salesRepository; public DatabaseReportDataSource(SalesRepository salesRepository) { this.salesRepository = salesRepository; } @Override public List\u0026lt;SalesData\u0026gt; getSalesData(DateRange dateRange) { return salesRepository.findSalesByDateRange( dateRange.getStartDate(), dateRange.getEndDate() ); } } @Component public class TextReportFormatter implements ReportFormatter { @Override public String format(List\u0026lt;SalesData\u0026gt; data, ReportMetadata metadata) { StringBuilder sb = new StringBuilder(); sb.append(\u0026#34;=== \u0026#34;).append(metadata.getTitle()).append(\u0026#34; ===\\n\u0026#34;); sb.append(\u0026#34;ç”Ÿæˆæ™‚é–“: \u0026#34;).append(metadata.getGeneratedAt()).append(\u0026#34;\\n\u0026#34;); sb.append(\u0026#34;å ±å‘ŠæœŸé–“: \u0026#34;).append(metadata.getDateRange()).append(\u0026#34;\\n\\n\u0026#34;); data.forEach(item -\u0026gt; sb.append(String.format(\u0026#34;ç”¢å“ID: %d, æ•¸é‡: %d, é‡‘é¡: %.2f%n\u0026#34;, item.getProductId(), item.getQuantity(), item.getAmount())) ); return sb.toString(); } } @Component public class ConsoleReportOutput implements ReportOutput { @Override public void output(String formattedReport, ReportMetadata metadata) { System.out.println(formattedReport); } } @Component public class FileReportOutput implements ReportOutput { @Value(\u0026#34;${report.output.directory:/tmp}\u0026#34;) private String outputDirectory; @Override public void output(String formattedReport, ReportMetadata metadata) { String filename = String.format(\u0026#34;%s_%s.txt\u0026#34;, metadata.getTitle().toLowerCase().replace(\u0026#34; \u0026#34;, \u0026#34;_\u0026#34;), metadata.getGeneratedAt().format(DateTimeFormatter.ofPattern(\u0026#34;yyyyMMdd_HHmmss\u0026#34;)) ); Path filePath = Paths.get(outputDirectory, filename); try { Files.write(filePath, formattedReport.getBytes()); } catch (IOException e) { throw new ReportOutputException(\u0026#34;ç„¡æ³•å¯«å…¥å ±å‘Šæ–‡ä»¶\u0026#34;, e); } } } 4. Viscosity (é»æ€§) - é›£ä»¥æ­£ç¢ºä¿®æ”¹ å•é¡Œæè¿°ï¼š æ­£ç¢ºçš„ä¿®æ”¹æ¯”éŒ¯èª¤çš„ä¿®æ”¹æ›´å›°é›£ï¼Œé–‹ç™¼äººå“¡å‚¾å‘æ–¼ä½¿ç”¨è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆè€Œéæ­£ç¢ºçš„è¨­è¨ˆã€‚\nç—‡ç‹€ï¼š\né–‹ç™¼äººå“¡é¸æ“‡å¿«é€Ÿä¿®å¾©è€Œéæ­£ç¢ºè§£æ±ºæ–¹æ¡ˆ ç³»çµ±ä¸­å……æ»¿äº†è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆå’Œ\u0026quot;hack\u0026quot; æ­£ç¢ºçš„ä¿®æ”¹éœ€è¦å¾ˆé•·æ™‚é–“æˆ–å¾ˆå¤šæ­¥é©Ÿ å£å‘³é“ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // é«˜é»æ€§çš„é…ç½®ç®¡ç†ç³»çµ± public class ConfigManager { private static Properties props = new Properties(); private static boolean initialized = false; static { try { props.load(new FileInputStream(\u0026#34;config.properties\u0026#34;)); initialized = true; } catch (IOException e) { // è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ç¡¬ç·¨ç¢¼é»˜èªå€¼ props.setProperty(\u0026#34;db.host\u0026#34;, \u0026#34;localhost\u0026#34;); props.setProperty(\u0026#34;db.port\u0026#34;, \u0026#34;3306\u0026#34;); props.setProperty(\u0026#34;db.timeout\u0026#34;, \u0026#34;30\u0026#34;); initialized = true; } } public static String getProperty(String key) { if (!initialized) { throw new RuntimeException(\u0026#34;é…ç½®æœªåˆå§‹åŒ–\u0026#34;); } return props.getProperty(key); } public static void setProperty(String key, String value) { // è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆï¼šé‹è¡Œæ™‚ä¿®æ”¹é…ç½® props.setProperty(key, value); // æ›´å¤šè‡¨æ™‚è§£æ±ºæ–¹æ¡ˆï¼šç«‹å³ä¿å­˜åˆ°æ–‡ä»¶ try (FileOutputStream out = new FileOutputStream(\u0026#34;config.properties\u0026#34;)) { props.store(out, \u0026#34;Updated at \u0026#34; + new Date()); } catch (IOException e) { // å¿½ç•¥éŒ¯èª¤ï¼Œç¹¼çºŒåŸ·è¡Œ } } // è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆï¼šæ·»åŠ å°ˆé–€çš„æ–¹æ³•ä¾†è™•ç†ç‰¹æ®Šæƒ…æ³ public static int getDatabaseTimeout() { String timeout = getProperty(\u0026#34;db.timeout\u0026#34;); try { return Integer.parseInt(timeout); } catch (NumberFormatException e) { // åˆä¸€å€‹è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆ return 30; } } } é‡æ§‹è§£æ±ºæ–¹æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 // ä½é»æ€§çš„é…ç½®ç®¡ç†ç³»çµ± public interface ConfigurationSource { Optional\u0026lt;String\u0026gt; getProperty(String key); Map\u0026lt;String, String\u0026gt; getAllProperties(); void reload(); } public interface ConfigurationValidator { void validate(Map\u0026lt;String, String\u0026gt; properties) throws ValidationException; } @Component public class ConfigurationService { private final List\u0026lt;ConfigurationSource\u0026gt; sources; private final ConfigurationValidator validator; private final ConfigurationCache cache; public ConfigurationService(List\u0026lt;ConfigurationSource\u0026gt; sources, ConfigurationValidator validator, ConfigurationCache cache) { this.sources = sources; this.validator = validator; this.cache = cache; } public \u0026lt;T\u0026gt; T getProperty(String key, Class\u0026lt;T\u0026gt; type, T defaultValue) { return cache.get(key, type) .orElseGet(() -\u0026gt; loadProperty(key, type, defaultValue)); } public \u0026lt;T\u0026gt; T getRequiredProperty(String key, Class\u0026lt;T\u0026gt; type) { return getProperty(key, type, null) .orElseThrow(() -\u0026gt; new ConfigurationException(\u0026#34;Required property not found: \u0026#34; + key)); } private \u0026lt;T\u0026gt; T loadProperty(String key, Class\u0026lt;T\u0026gt; type, T defaultValue) { for (ConfigurationSource source : sources) { Optional\u0026lt;String\u0026gt; value = source.getProperty(key); if (value.isPresent()) { T convertedValue = convertValue(value.get(), type); cache.put(key, convertedValue); return convertedValue; } } return defaultValue; } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) private \u0026lt;T\u0026gt; T convertValue(String value, Class\u0026lt;T\u0026gt; type) { if (type == String.class) { return (T) value; } else if (type == Integer.class) { return (T) Integer.valueOf(value); } else if (type == Boolean.class) { return (T) Boolean.valueOf(value); } else if (type == Duration.class) { return (T) Duration.parse(value); } throw new ConfigurationException(\u0026#34;Unsupported type: \u0026#34; + type); } public void reload() { sources.forEach(ConfigurationSource::reload); cache.clear(); // é‡æ–°åŠ è¼‰å¾Œé©—è­‰é…ç½® Map\u0026lt;String, String\u0026gt; allProperties = getAllProperties(); validator.validate(allProperties); } private Map\u0026lt;String, String\u0026gt; getAllProperties() { Map\u0026lt;String, String\u0026gt; allProperties = new HashMap\u0026lt;\u0026gt;(); sources.forEach(source -\u0026gt; allProperties.putAll(source.getAllProperties())); return allProperties; } } // å…·é«”å¯¦ç¾ @Component @Order(1) public class FileConfigurationSource implements ConfigurationSource { private final String configFile; private Properties properties; public FileConfigurationSource(@Value(\u0026#34;${config.file:config.properties}\u0026#34;) String configFile) { this.configFile = configFile; this.properties = new Properties(); reload(); } @Override public Optional\u0026lt;String\u0026gt; getProperty(String key) { return Optional.ofNullable(properties.getProperty(key)); } @Override public Map\u0026lt;String, String\u0026gt; getAllProperties() { return properties.entrySet().stream() .collect(Collectors.toMap( e -\u0026gt; e.getKey().toString(), e -\u0026gt; e.getValue().toString() )); } @Override public void reload() { try (InputStream is = new FileInputStream(configFile)) { properties.load(is); } catch (IOException e) { throw new ConfigurationException(\u0026#34;Failed to load configuration from \u0026#34; + configFile, e); } } } @Component @Order(2) public class EnvironmentConfigurationSource implements ConfigurationSource { @Override public Optional\u0026lt;String\u0026gt; getProperty(String key) { return Optional.ofNullable(System.getenv(key.toUpperCase().replace(\u0026#39;.\u0026#39;, \u0026#39;_\u0026#39;))); } @Override public Map\u0026lt;String, String\u0026gt; getAllProperties() { return System.getenv(); } @Override public void reload() { // ç’°å¢ƒè®Šé‡ä¸éœ€è¦é‡æ–°åŠ è¼‰ } } å¸¸è¦‹ä»£ç¢¼å£å‘³é“é¡å‹èˆ‡é‡æ§‹æŠ€å·§ 1. Long Method (å†—é•·æ–¹æ³•) å•é¡Œæè¿°ï¼š æ–¹æ³•éé•·ï¼Œé›£ä»¥ç†è§£å’Œç¶­è­·ã€‚\nè­˜åˆ¥æ¨™æº–ï¼š\næ–¹æ³•è¶…é20-30è¡Œ æ–¹æ³•æœ‰å¤šå€‹è·è²¬ æ–¹æ³•æœ‰å¤šå±¤åµŒå¥— é‡æ§‹æŠ€å·§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 // å£å‘³é“ï¼šå†—é•·çš„è¨‚å–®è™•ç†æ–¹æ³• public class OrderProcessor { public void processOrder(Order order) { // é©—è­‰è¨‚å–® if (order == null) { throw new IllegalArgumentException(\u0026#34;è¨‚å–®ä¸èƒ½ç‚ºç©º\u0026#34;); } if (order.getItems() == null || order.getItems().isEmpty()) { throw new IllegalArgumentException(\u0026#34;è¨‚å–®é …ç›®ä¸èƒ½ç‚ºç©º\u0026#34;); } for (OrderItem item : order.getItems()) { if (item.getQuantity() \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;è¨‚å–®é …ç›®æ•¸é‡å¿…é ˆå¤§æ–¼0\u0026#34;); } if (item.getPrice() \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;è¨‚å–®é …ç›®åƒ¹æ ¼å¿…é ˆå¤§æ–¼0\u0026#34;); } } // è¨ˆç®—ç¸½é‡‘é¡ double totalAmount = 0; for (OrderItem item : order.getItems()) { totalAmount += item.getQuantity() * item.getPrice(); } // è¨ˆç®—æŠ˜æ‰£ double discount = 0; if (order.getCustomer().getType() == CustomerType.VIP) { discount = totalAmount * 0.1; } else if (order.getCustomer().getType() == CustomerType.PREMIUM) { discount = totalAmount * 0.05; } // è¨ˆç®—ç¨…è²» double tax = (totalAmount - discount) * 0.08; // è¨­ç½®è¨‚å–®é‡‘é¡ order.setSubtotal(totalAmount); order.setDiscount(discount); order.setTax(tax); order.setTotal(totalAmount - discount + tax); // ä¿å­˜è¨‚å–® Connection conn = null; try { conn = DriverManager.getConnection(\u0026#34;jdbc:mysql://localhost:3306/orders\u0026#34;); PreparedStatement stmt = conn.prepareStatement( \u0026#34;INSERT INTO orders (customer_id, subtotal, discount, tax, total) VALUES (?, ?, ?, ?, ?)\u0026#34;); stmt.setLong(1, order.getCustomer().getId()); stmt.setDouble(2, order.getSubtotal()); stmt.setDouble(3, order.getDiscount()); stmt.setDouble(4, order.getTax()); stmt.setDouble(5, order.getTotal()); stmt.executeUpdate(); } catch (SQLException e) { throw new RuntimeException(\u0026#34;ä¿å­˜è¨‚å–®å¤±æ•—\u0026#34;, e); } finally { if (conn != null) { try { conn.close(); } catch (SQLException e) { // å¿½ç•¥ } } } // ç™¼é€ç¢ºèªéƒµä»¶ try { String subject = \u0026#34;è¨‚å–®ç¢ºèª - \u0026#34; + order.getId(); String body = \u0026#34;æ‚¨çš„è¨‚å–®å·²æˆåŠŸè™•ç†ã€‚è¨‚å–®ç¸½é‡‘é¡: \u0026#34; + order.getTotal(); sendEmail(order.getCustomer().getEmail(), subject, body); } catch (Exception e) { // è¨˜éŒ„éŒ¯èª¤ä½†ä¸å½±éŸ¿è¨‚å–®è™•ç† System.err.println(\u0026#34;ç™¼é€ç¢ºèªéƒµä»¶å¤±æ•—: \u0026#34; + e.getMessage()); } } } é‡æ§‹å¾Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 // é‡æ§‹å¾Œï¼šè·è²¬åˆ†é›¢ï¼Œæ–¹æ³•ç°¡æ½” @Service public class OrderProcessor { private final OrderValidator orderValidator; private final OrderCalculator orderCalculator; private final OrderRepository orderRepository; private final NotificationService notificationService; public OrderProcessor(OrderValidator orderValidator, OrderCalculator orderCalculator, OrderRepository orderRepository, NotificationService notificationService) { this.orderValidator = orderValidator; this.orderCalculator = orderCalculator; this.orderRepository = orderRepository; this.notificationService = notificationService; } @Transactional public void processOrder(Order order) { orderValidator.validate(order); orderCalculator.calculateAmounts(order); orderRepository.save(order); notificationService.sendOrderConfirmation(order); } } @Component public class OrderValidator { public void validate(Order order) { validateOrderNotNull(order); validateOrderItems(order.getItems()); } private void validateOrderNotNull(Order order) { if (order == null) { throw new IllegalArgumentException(\u0026#34;è¨‚å–®ä¸èƒ½ç‚ºç©º\u0026#34;); } } private void validateOrderItems(List\u0026lt;OrderItem\u0026gt; items) { if (items == null || items.isEmpty()) { throw new IllegalArgumentException(\u0026#34;è¨‚å–®é …ç›®ä¸èƒ½ç‚ºç©º\u0026#34;); } items.forEach(this::validateOrderItem); } private void validateOrderItem(OrderItem item) { if (item.getQuantity() \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;è¨‚å–®é …ç›®æ•¸é‡å¿…é ˆå¤§æ–¼0\u0026#34;); } if (item.getPrice() \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;è¨‚å–®é …ç›®åƒ¹æ ¼å¿…é ˆå¤§æ–¼0\u0026#34;); } } } @Component public class OrderCalculator { private final DiscountService discountService; private final TaxService taxService; public OrderCalculator(DiscountService discountService, TaxService taxService) { this.discountService = discountService; this.taxService = taxService; } public void calculateAmounts(Order order) { double subtotal = calculateSubtotal(order.getItems()); double discount = discountService.calculateDiscount(order); double tax = taxService.calculateTax(subtotal - discount); double total = subtotal - discount + tax; order.setSubtotal(subtotal); order.setDiscount(discount); order.setTax(tax); order.setTotal(total); } private double calculateSubtotal(List\u0026lt;OrderItem\u0026gt; items) { return items.stream() .mapToDouble(item -\u0026gt; item.getQuantity() * item.getPrice()) .sum(); } } 2. Large Class (å·¨å¤§é¡) å•é¡Œæè¿°ï¼š é¡éå¤§ï¼Œæ‰¿æ“”éå¤šè·è²¬ã€‚\nè­˜åˆ¥æ¨™æº–ï¼š\né¡è¶…é200-300è¡Œ é¡æœ‰å¤ªå¤šå¯¦ä¾‹è®Šé‡ é¡æœ‰å¤ªå¤šæ–¹æ³• é‡æ§‹æŠ€å·§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 // å£å‘³é“ï¼šå·¨å¤§çš„ç”¨æˆ¶ç®¡ç†é¡ public class UserManager { private Connection dbConnection; private EmailService emailService; private Logger logger; private PasswordEncoder passwordEncoder; private UserValidator userValidator; private UserCache userCache; private SecurityService securityService; private AuditService auditService; private NotificationService notificationService; // ç”¨æˆ¶CRUDæ“ä½œ public User createUser(UserRequest request) { /* ... */ } public User updateUser(Long id, UserRequest request) { /* ... */ } public void deleteUser(Long id) { /* ... */ } public User findUserById(Long id) { /* ... */ } public List\u0026lt;User\u0026gt; findAllUsers() { /* ... */ } public List\u0026lt;User\u0026gt; findUsersByEmail(String email) { /* ... */ } // ç”¨æˆ¶èªè­‰ public boolean authenticate(String username, String password) { /* ... */ } public String generateToken(User user) { /* ... */ } public boolean validateToken(String token) { /* ... */ } public void logout(String token) { /* ... */ } // å¯†ç¢¼ç®¡ç† public void changePassword(Long userId, String oldPassword, String newPassword) { /* ... */ } public void resetPassword(String email) { /* ... */ } public boolean isPasswordExpired(User user) { /* ... */ } // ç”¨æˆ¶æ¬Šé™ public void assignRole(Long userId, String role) { /* ... */ } public void removeRole(Long userId, String role) { /* ... */ } public Set\u0026lt;String\u0026gt; getUserRoles(Long userId) { /* ... */ } public boolean hasPermission(Long userId, String permission) { /* ... */ } // ç”¨æˆ¶é€šçŸ¥ public void sendWelcomeEmail(User user) { /* ... */ } public void sendPasswordResetEmail(User user) { /* ... */ } public void sendAccountLockedNotification(User user) { /* ... */ } // ç”¨æˆ¶çµ±è¨ˆ public int getTotalUserCount() { /* ... */ } public int getActiveUserCount() { /* ... */ } public List\u0026lt;User\u0026gt; getRecentlyRegisteredUsers() { /* ... */ } // ç”¨æˆ¶å¯©è¨ˆ public void logUserActivity(Long userId, String activity) { /* ... */ } public List\u0026lt;AuditRecord\u0026gt; getUserAuditHistory(Long userId) { /* ... */ } } é‡æ§‹å¾Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 // é‡æ§‹å¾Œï¼šæŒ‰è·è²¬åˆ†é›¢ç‚ºå¤šå€‹å°ˆé–€çš„é¡ @Service public class UserService { private final UserRepository userRepository; private final UserValidator userValidator; private final UserMapper userMapper; private final ApplicationEventPublisher eventPublisher; public UserService(UserRepository userRepository, UserValidator userValidator, UserMapper userMapper, ApplicationEventPublisher eventPublisher) { this.userRepository = userRepository; this.userValidator = userValidator; this.userMapper = userMapper; this.eventPublisher = eventPublisher; } @Transactional public User createUser(CreateUserRequest request) { userValidator.validate(request); User user = userMapper.toEntity(request); User savedUser = userRepository.save(user); eventPublisher.publishEvent(new UserCreatedEvent(savedUser)); return savedUser; } @Transactional public User updateUser(Long id, UpdateUserRequest request) { User existingUser = userRepository.findById(id) .orElseThrow(() -\u0026gt; new UserNotFoundException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨: \u0026#34; + id)); userValidator.validate(request); userMapper.updateEntity(existingUser, request); User updatedUser = userRepository.save(existingUser); eventPublisher.publishEvent(new UserUpdatedEvent(updatedUser)); return updatedUser; } @Transactional public void deleteUser(Long id) { User user = userRepository.findById(id) .orElseThrow(() -\u0026gt; new UserNotFoundException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨: \u0026#34; + id)); userRepository.delete(user); eventPublisher.publishEvent(new UserDeletedEvent(user)); } public User findUserById(Long id) { return userRepository.findById(id) .orElseThrow(() -\u0026gt; new UserNotFoundException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨: \u0026#34; + id)); } public List\u0026lt;User\u0026gt; findAllUsers() { return userRepository.findAll(); } public List\u0026lt;User\u0026gt; findUsersByEmail(String email) { return userRepository.findByEmailContaining(email); } } @Service public class UserAuthenticationService { private final UserRepository userRepository; private final PasswordEncoder passwordEncoder; private final JwtTokenProvider tokenProvider; private final AuthenticationEventPublisher eventPublisher; public UserAuthenticationService(UserRepository userRepository, PasswordEncoder passwordEncoder, JwtTokenProvider tokenProvider, AuthenticationEventPublisher eventPublisher) { this.userRepository = userRepository; this.passwordEncoder = passwordEncoder; this.tokenProvider = tokenProvider; this.eventPublisher = eventPublisher; } public AuthenticationResult authenticate(String username, String password) { User user = userRepository.findByUsername(username) .orElseThrow(() -\u0026gt; new AuthenticationException(\u0026#34;ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤\u0026#34;)); if (!passwordEncoder.matches(password, user.getPassword())) { eventPublisher.publishEvent(new AuthenticationFailedEvent(user)); throw new AuthenticationException(\u0026#34;ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤\u0026#34;); } String token = tokenProvider.generateToken(user); eventPublisher.publishEvent(new AuthenticationSuccessEvent(user)); return AuthenticationResult.success(user, token); } public boolean validateToken(String token) { return tokenProvider.validateToken(token); } public void logout(String token) { tokenProvider.invalidateToken(token); } } @Service public class UserPasswordService { private final UserRepository userRepository; private final PasswordEncoder passwordEncoder; private final PasswordValidator passwordValidator; private final ApplicationEventPublisher eventPublisher; public UserPasswordService(UserRepository userRepository, PasswordEncoder passwordEncoder, PasswordValidator passwordValidator, ApplicationEventPublisher eventPublisher) { this.userRepository = userRepository; this.passwordEncoder = passwordEncoder; this.passwordValidator = passwordValidator; this.eventPublisher = eventPublisher; } @Transactional public void changePassword(Long userId, String oldPassword, String newPassword) { User user = userRepository.findById(userId) .orElseThrow(() -\u0026gt; new UserNotFoundException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨: \u0026#34; + userId)); if (!passwordEncoder.matches(oldPassword, user.getPassword())) { throw new InvalidPasswordException(\u0026#34;èˆŠå¯†ç¢¼ä¸æ­£ç¢º\u0026#34;); } passwordValidator.validate(newPassword); user.setPassword(passwordEncoder.encode(newPassword)); user.setPasswordChangedAt(LocalDateTime.now()); userRepository.save(user); eventPublisher.publishEvent(new PasswordChangedEvent(user)); } @Transactional public void resetPassword(String email) { User user = userRepository.findByEmail(email) .orElseThrow(() -\u0026gt; new UserNotFoundException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨: \u0026#34; + email)); String resetToken = generateResetToken(); user.setPasswordResetToken(resetToken); user.setPasswordResetTokenExpiresAt(LocalDateTime.now().plusHours(24)); userRepository.save(user); eventPublisher.publishEvent(new PasswordResetRequestedEvent(user, resetToken)); } private String generateResetToken() { return UUID.randomUUID().toString(); } } 3. Duplicate Code (é‡è¤‡ä»£ç¢¼) å•é¡Œæè¿°ï¼š ç›¸åŒæˆ–ç›¸ä¼¼çš„ä»£ç¢¼åœ¨å¤šå€‹åœ°æ–¹é‡è¤‡å‡ºç¾ã€‚\né‡æ§‹æŠ€å·§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 // å£å‘³é“ï¼šé‡è¤‡çš„é©—è­‰é‚è¼¯ public class UserController { @PostMapping(\u0026#34;/users\u0026#34;) public ResponseEntity\u0026lt;User\u0026gt; createUser(@RequestBody CreateUserRequest request) { // é‡è¤‡çš„é©—è­‰é‚è¼¯ if (request.getEmail() == null || request.getEmail().trim().isEmpty()) { throw new ValidationException(\u0026#34;é›»å­éƒµä»¶ä¸èƒ½ç‚ºç©º\u0026#34;); } if (!request.getEmail().contains(\u0026#34;@\u0026#34;)) { throw new ValidationException(\u0026#34;é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º\u0026#34;); } if (request.getPassword() == null || request.getPassword().length() \u0026lt; 8) { throw new ValidationException(\u0026#34;å¯†ç¢¼é•·åº¦è‡³å°‘8ä½\u0026#34;); } // æ¥­å‹™é‚è¼¯ User user = userService.createUser(request); return ResponseEntity.ok(user); } @PutMapping(\u0026#34;/users/{id}\u0026#34;) public ResponseEntity\u0026lt;User\u0026gt; updateUser(@PathVariable Long id, @RequestBody UpdateUserRequest request) { // é‡è¤‡çš„é©—è­‰é‚è¼¯ if (request.getEmail() == null || request.getEmail().trim().isEmpty()) { throw new ValidationException(\u0026#34;é›»å­éƒµä»¶ä¸èƒ½ç‚ºç©º\u0026#34;); } if (!request.getEmail().contains(\u0026#34;@\u0026#34;)) { throw new ValidationException(\u0026#34;é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º\u0026#34;); } // æ¥­å‹™é‚è¼¯ User user = userService.updateUser(id, request); return ResponseEntity.ok(user); } } public class AdminController { @PostMapping(\u0026#34;/admin/users\u0026#34;) public ResponseEntity\u0026lt;User\u0026gt; createAdminUser(@RequestBody CreateUserRequest request) { // åˆä¸€æ¬¡é‡è¤‡çš„é©—è­‰é‚è¼¯ if (request.getEmail() == null || request.getEmail().trim().isEmpty()) { throw new ValidationException(\u0026#34;é›»å­éƒµä»¶ä¸èƒ½ç‚ºç©º\u0026#34;); } if (!request.getEmail().contains(\u0026#34;@\u0026#34;)) { throw new ValidationException(\u0026#34;é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º\u0026#34;); } if (request.getPassword() == null || request.getPassword().length() \u0026lt; 8) { throw new ValidationException(\u0026#34;å¯†ç¢¼é•·åº¦è‡³å°‘8ä½\u0026#34;); } // æ¥­å‹™é‚è¼¯ User user = adminService.createAdminUser(request); return ResponseEntity.ok(user); } } é‡æ§‹å¾Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 // é‡æ§‹å¾Œï¼šæå–å…±ç”¨é©—è­‰é‚è¼¯ @Component public class UserRequestValidator { private final EmailValidator emailValidator; private final PasswordValidator passwordValidator; public UserRequestValidator(EmailValidator emailValidator, PasswordValidator passwordValidator) { this.emailValidator = emailValidator; this.passwordValidator = passwordValidator; } public void validate(CreateUserRequest request) { validateEmail(request.getEmail()); validatePassword(request.getPassword()); validateName(request.getName()); } public void validate(UpdateUserRequest request) { validateEmail(request.getEmail()); validateName(request.getName()); } private void validateEmail(String email) { if (email == null || email.trim().isEmpty()) { throw new ValidationException(\u0026#34;é›»å­éƒµä»¶ä¸èƒ½ç‚ºç©º\u0026#34;); } if (!emailValidator.isValid(email)) { throw new ValidationException(\u0026#34;é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º\u0026#34;); } } private void validatePassword(String password) { if (password == null || password.length() \u0026lt; 8) { throw new ValidationException(\u0026#34;å¯†ç¢¼é•·åº¦è‡³å°‘8ä½\u0026#34;); } if (!passwordValidator.isValid(password)) { throw new ValidationException(\u0026#34;å¯†ç¢¼å¼·åº¦ä¸è¶³\u0026#34;); } } private void validateName(String name) { if (name == null || name.trim().isEmpty()) { throw new ValidationException(\u0026#34;å§“åä¸èƒ½ç‚ºç©º\u0026#34;); } if (name.length() \u0026gt; 50) { throw new ValidationException(\u0026#34;å§“åé•·åº¦ä¸èƒ½è¶…é50å€‹å­—ç¬¦\u0026#34;); } } } @RestController @RequestMapping(\u0026#34;/api\u0026#34;) public class UserController { private final UserService userService; private final UserRequestValidator validator; public UserController(UserService userService, UserRequestValidator validator) { this.userService = userService; this.validator = validator; } @PostMapping(\u0026#34;/users\u0026#34;) public ResponseEntity\u0026lt;User\u0026gt; createUser(@RequestBody CreateUserRequest request) { validator.validate(request); User user = userService.createUser(request); return ResponseEntity.ok(user); } @PutMapping(\u0026#34;/users/{id}\u0026#34;) public ResponseEntity\u0026lt;User\u0026gt; updateUser(@PathVariable Long id, @RequestBody UpdateUserRequest request) { validator.validate(request); User user = userService.updateUser(id, request); return ResponseEntity.ok(user); } } @RestController @RequestMapping(\u0026#34;/api/admin\u0026#34;) public class AdminController { private final AdminService adminService; private final UserRequestValidator validator; public AdminController(AdminService adminService, UserRequestValidator validator) { this.adminService = adminService; this.validator = validator; } @PostMapping(\u0026#34;/users\u0026#34;) public ResponseEntity\u0026lt;User\u0026gt; createAdminUser(@RequestBody CreateUserRequest request) { validator.validate(request); User user = adminService.createAdminUser(request); return ResponseEntity.ok(user); } } ä»£ç¢¼å£å‘³é“æª¢æ¸¬å·¥å…· 1. SonarQube æ•´åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 \u0026lt;!-- pom.xml --\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.sonarsource.scanner.maven\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;sonar-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.9.1.2184\u0026lt;/version\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.jacoco\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jacoco-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.8.7\u0026lt;/version\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;prepare-agent\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;id\u0026gt;report\u0026lt;/id\u0026gt; \u0026lt;phase\u0026gt;test\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;report\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; 2. PMD é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;!-- pmd-ruleset.xml --\u0026gt; \u0026lt;ruleset name=\u0026#34;Custom PMD Rules\u0026#34; xmlns=\u0026#34;http://pmd.sourceforge.net/ruleset/2.0.0\u0026#34;\u0026gt; \u0026lt;rule ref=\u0026#34;category/java/bestpractices.xml/AvoidReassigningParameters\u0026#34; /\u0026gt; \u0026lt;rule ref=\u0026#34;category/java/bestpractices.xml/SwitchStmtsShouldHaveDefault\u0026#34; /\u0026gt; \u0026lt;rule ref=\u0026#34;category/java/codestyle.xml/LongVariable\u0026#34; /\u0026gt; \u0026lt;rule ref=\u0026#34;category/java/design.xml/ExcessiveMethodLength\u0026#34;\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;property name=\u0026#34;minimum\u0026#34; value=\u0026#34;30\u0026#34; /\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;/rule\u0026gt; \u0026lt;rule ref=\u0026#34;category/java/design.xml/TooManyMethods\u0026#34;\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;property name=\u0026#34;maxmethods\u0026#34; value=\u0026#34;15\u0026#34; /\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;/rule\u0026gt; \u0026lt;/ruleset\u0026gt; 3. CheckStyle é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 \u0026lt;!-- checkstyle.xml --\u0026gt; \u0026lt;module name=\u0026#34;Checker\u0026#34;\u0026gt; \u0026lt;module name=\u0026#34;TreeWalker\u0026#34;\u0026gt; \u0026lt;module name=\u0026#34;MethodLength\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;tokens\u0026#34; value=\u0026#34;METHOD_DEF\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;max\u0026#34; value=\u0026#34;30\u0026#34;/\u0026gt; \u0026lt;/module\u0026gt; \u0026lt;module name=\u0026#34;ParameterNumber\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;max\u0026#34; value=\u0026#34;5\u0026#34;/\u0026gt; \u0026lt;/module\u0026gt; \u0026lt;module name=\u0026#34;CyclomaticComplexity\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;max\u0026#34; value=\u0026#34;10\u0026#34;/\u0026gt; \u0026lt;/module\u0026gt; \u0026lt;module name=\u0026#34;ClassDataAbstractionCoupling\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;max\u0026#34; value=\u0026#34;10\u0026#34;/\u0026gt; \u0026lt;/module\u0026gt; \u0026lt;module name=\u0026#34;ClassFanOutComplexity\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;max\u0026#34; value=\u0026#34;20\u0026#34;/\u0026gt; \u0026lt;/module\u0026gt; \u0026lt;/module\u0026gt; \u0026lt;/module\u0026gt; ä»£ç¢¼å“è³ªç›£æ§ 1. ä»£ç¢¼å“è³ªæŒ‡æ¨™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 @Component public class CodeQualityMetrics { private final MeterRegistry meterRegistry; public CodeQualityMetrics(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; } public void recordMethodComplexity(String className, String methodName, int complexity) { Gauge.builder(\u0026#34;code.complexity.cyclomatic\u0026#34;) .tag(\u0026#34;class\u0026#34;, className) .tag(\u0026#34;method\u0026#34;, methodName) .register(meterRegistry, complexity); } public void recordCodeDuplication(String className, double duplicationPercentage) { Gauge.builder(\u0026#34;code.duplication.percentage\u0026#34;) .tag(\u0026#34;class\u0026#34;, className) .register(meterRegistry, duplicationPercentage); } public void recordTestCoverage(String className, double coveragePercentage) { Gauge.builder(\u0026#34;code.coverage.percentage\u0026#34;) .tag(\u0026#34;class\u0026#34;, className) .register(meterRegistry, coveragePercentage); } } 2. è‡ªå‹•åŒ–ä»£ç¢¼æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 @Component public class CodeQualityChecker { private final CodeQualityMetrics metrics; private final NotificationService notificationService; public CodeQualityChecker(CodeQualityMetrics metrics, NotificationService notificationService) { this.metrics = metrics; this.notificationService = notificationService; } @EventListener public void onCodeCommit(CodeCommitEvent event) { CodeQualityReport report = analyzeCode(event.getChangedFiles()); if (report.hasQualityIssues()) { notificationService.sendQualityAlert(report); } updateMetrics(report); } private CodeQualityReport analyzeCode(List\u0026lt;String\u0026gt; changedFiles) { CodeQualityReport report = new CodeQualityReport(); for (String file : changedFiles) { if (file.endsWith(\u0026#34;.java\u0026#34;)) { analyzeJavaFile(file, report); } } return report; } private void analyzeJavaFile(String filePath, CodeQualityReport report) { // åˆ†æä»£ç¢¼è¤‡é›œåº¦ int complexity = calculateCyclomaticComplexity(filePath); if (complexity \u0026gt; 10) { report.addIssue(new QualityIssue(filePath, \u0026#34;é«˜è¤‡é›œåº¦\u0026#34;, \u0026#34;åœˆè¤‡é›œåº¦: \u0026#34; + complexity)); } // åˆ†ææ–¹æ³•é•·åº¦ int methodLength = calculateAverageMethodLength(filePath); if (methodLength \u0026gt; 30) { report.addIssue(new QualityIssue(filePath, \u0026#34;æ–¹æ³•éé•·\u0026#34;, \u0026#34;å¹³å‡æ–¹æ³•é•·åº¦: \u0026#34; + methodLength)); } // åˆ†æé‡è¤‡ä»£ç¢¼ double duplication = calculateDuplication(filePath); if (duplication \u0026gt; 0.1) { report.addIssue(new QualityIssue(filePath, \u0026#34;ä»£ç¢¼é‡è¤‡\u0026#34;, \u0026#34;é‡è¤‡ç‡: \u0026#34; + (duplication * 100) + \u0026#34;%\u0026#34;)); } } private int calculateCyclomaticComplexity(String filePath) { // å¯¦ç¾è¤‡é›œåº¦è¨ˆç®—é‚è¼¯ return 0; } private int calculateAverageMethodLength(String filePath) { // å¯¦ç¾æ–¹æ³•é•·åº¦è¨ˆç®—é‚è¼¯ return 0; } private double calculateDuplication(String filePath) { // å¯¦ç¾é‡è¤‡åº¦è¨ˆç®—é‚è¼¯ return 0.0; } private void updateMetrics(CodeQualityReport report) { report.getIssues().forEach(issue -\u0026gt; { String className = extractClassName(issue.getFilePath()); switch (issue.getType()) { case \u0026#34;é«˜è¤‡é›œåº¦\u0026#34;: metrics.recordMethodComplexity(className, \u0026#34;unknown\u0026#34;, extractComplexityValue(issue.getDescription())); break; case \u0026#34;ä»£ç¢¼é‡è¤‡\u0026#34;: metrics.recordCodeDuplication(className, extractDuplicationValue(issue.getDescription())); break; } }); } private String extractClassName(String filePath) { return filePath.substring(filePath.lastIndexOf(\u0026#39;/\u0026#39;) + 1, filePath.lastIndexOf(\u0026#39;.\u0026#39;)); } private int extractComplexityValue(String description) { // å¾æè¿°ä¸­æå–è¤‡é›œåº¦å€¼ return 0; } private double extractDuplicationValue(String description) { // å¾æè¿°ä¸­æå–é‡è¤‡åº¦å€¼ return 0.0; } } ç¸½çµ ä»£ç¢¼å£å‘³é“çš„è­˜åˆ¥èˆ‡é‡æ§‹æ˜¯æå‡è»Ÿé«”å“è³ªçš„é‡è¦æ‰‹æ®µï¼š\né—œéµæœ€ä½³å¯¦è¸ æŒçºŒç›£æ§ï¼šä½¿ç”¨è‡ªå‹•åŒ–å·¥å…·æŒçºŒç›£æ§ä»£ç¢¼å“è³ª æ¼¸é€²å¼é‡æ§‹ï¼šå°æ­¥é©Ÿã€é«˜é »ç‡çš„é‡æ§‹æ¯”å¤§è¦æ¨¡é‡æ§‹æ›´å®‰å…¨ æ¸¬è©¦ä¿è­·ï¼šåœ¨é‡æ§‹å‰ç¢ºä¿æœ‰å……åˆ†çš„æ¸¬è©¦è¦†è“‹ åœ˜éšŠæ¨™æº–ï¼šå»ºç«‹çµ±ä¸€çš„ä»£ç¢¼å“è³ªæ¨™æº–å’Œè©•å¯©æµç¨‹ æ•™è‚²åŸ¹è¨“ï¼šå®šæœŸåŸ¹è¨“é–‹ç™¼äººå“¡è­˜åˆ¥å’Œé¿å…ä»£ç¢¼å£å‘³é“ é é˜²ç­–ç•¥ è¨­è¨ˆéšæ®µï¼šåœ¨è¨­è¨ˆéšæ®µå°±è€ƒæ…®ä»£ç¢¼å“è³ª ç·¨ç¢¼æ¨™æº–ï¼šåˆ¶å®šä¸¦éµå¾ªç·¨ç¢¼æ¨™æº– ä»£ç¢¼è©•å¯©ï¼šå¯¦æ–½åš´æ ¼çš„ä»£ç¢¼è©•å¯©æµç¨‹ è‡ªå‹•åŒ–æª¢æŸ¥ï¼šé›†æˆè‡ªå‹•åŒ–ä»£ç¢¼å“è³ªæª¢æŸ¥å·¥å…· é‡æ§‹æ–‡åŒ–ï¼šåŸ¹é¤ŠæŒçºŒé‡æ§‹çš„æ–‡åŒ– é€šéç³»çµ±æ€§çš„ä»£ç¢¼å£å‘³é“è­˜åˆ¥èˆ‡é‡æ§‹ï¼Œå¯ä»¥å¤§å¹…æå‡ä»£ç¢¼å“è³ªï¼Œé™ä½ç¶­è­·æˆæœ¬ï¼Œæé«˜é–‹ç™¼æ•ˆç‡ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/badsmell/","tags":["Code Smells","Code Quality","Refactoring","Clean Code","Software Architecture","Best Practices","Technical Debt","Software Maintenance","Code Review","Design Patterns","SOLID Principles","Java","Enterprise Development"],"title":"ä»£ç¢¼å£å‘³é“ (Code Smells) å®Œæ•´è­˜åˆ¥èˆ‡é‡æ§‹æŒ‡å—ï¼šè»Ÿé«”å“è³ªæ”¹å–„æœ€ä½³å¯¦è¸"},{"content":"GitHub SSH Setting 1 2 3 4 5 6 7 8 9 10 11 12 cd ~/ mkdir .ssh ssh-keygen -t ed25519 -C \u0026#34;your_email@example.com\u0026#34; (æ˜¯å¦è¦ç”¨é è¨­æª”å) enter \u0026gt;\u0026gt; (å¯†ç¢¼) enter \u0026gt;\u0026gt; (å¯†ç¢¼ç¢ºèª) enter cat .ssh/id_ed25519.pub \u0026gt;\u0026gt; è·‘å‡ºå…¬é‘° è²¼åˆ° github ä¸Š ssh -T git@github.com \u0026gt;\u0026gt; æ¸¬è©¦é€£ç·š \u0026gt;\u0026gt; \u0026#34;Hi xinqilin! You\u0026#39;ve successfully authenticated, but GitHub does not provide shell access.\u0026#34; é‡è¨­ remote url =\u0026gt; https æ”¹ ssh 1 2 git remote rm origin git remote add origin [url] æ‡‰ç”¨ç¨‹å¼è¦ç”¨çš„ token setting -\u0026gt; developer setting -\u0026gt; personal access token -\u0026gt; generate new token\nGitHub æ•™å­¸ ","permalink":"https://xinqilin.github.io/post/tools/github-ssh/","tags":[],"title":"Github Ssh"},{"content":"æ¦‚è¿° åœ¨ç¾ä»£é–‹ç™¼æµç¨‹ä¸­ï¼Œä½¿ç”¨ Docker éƒ¨ç½²è³‡æ–™åº«å·²æˆç‚ºä¸»æµã€‚å°‡ MySQL é‹è¡Œåœ¨ Docker å®¹å™¨ä¸­ï¼Œå¯ä»¥å¸¶ä¾†è¨±å¤šå¥½è™•ï¼šç’°å¢ƒéš”é›¢ã€å¿«é€Ÿéƒ¨ç½²ã€ç‰ˆæœ¬æ§åˆ¶ã€ä»¥åŠæ–¹ä¾¿çš„é·ç§»ã€‚é€™ç¯‡æ–‡ç« å°‡å¼•å°æ‚¨å¦‚ä½•åœ¨ Docker ä¸­è¨­å®šå’Œç®¡ç† MySQL å®¹å™¨ã€‚\nå•Ÿå‹• MySQL å®¹å™¨ ä½¿ç”¨ docker run æŒ‡ä»¤å¯ä»¥å¿«é€Ÿå•Ÿå‹•ä¸€å€‹ MySQL å®¹å™¨ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹å¸¸ç”¨çš„ç¯„ä¾‹ï¼ŒåŒ…å«äº†å¯†ç¢¼è¨­å®šã€åŸ æ˜ å°„å’Œå­—å…ƒé›†è¨­å®šã€‚\n1 2 3 4 5 6 7 8 9 docker run \\ --name mysql-server \\ -e MYSQL_ROOT_PASSWORD=your_strong_password \\ -p 3306:3306 \\ -d \\ mysql/mysql-server \\ --character-set-server=utf8mb4 \\ --collation-server=utf8mb4_unicode_ci \\ --skip-character-set-client-handshake æŒ‡ä»¤åƒæ•¸èªªæ˜ --name mysql-server: ç‚ºå®¹å™¨æŒ‡å®šä¸€å€‹æ˜“æ–¼è­˜åˆ¥çš„åç¨±ï¼Œé€™è£¡å‘½åç‚º mysql-serverã€‚ -e MYSQL_ROOT_PASSWORD=your_strong_password: è¨­å®š MySQL root ä½¿ç”¨è€…çš„å¯†ç¢¼ã€‚è«‹å‹™å¿…å°‡ your_strong_password æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„å¼·å¯†ç¢¼ã€‚ -p 3306:3306: å°‡ä¸»æ©Ÿçš„ 3306 åŸ æ˜ å°„åˆ°å®¹å™¨çš„ 3306 åŸ ã€‚é€™æ¨£æ‚¨å°±å¯ä»¥å¾ä¸»æ©Ÿé€é 3306 åŸ é€£æ¥åˆ°å®¹å™¨å…§çš„ MySQL æœå‹™ã€‚ -d: ä»¥èƒŒæ™¯æ¨¡å¼ (detached mode) é‹è¡Œå®¹å™¨ï¼Œè®“å®¹å™¨åœ¨èƒŒæ™¯åŸ·è¡Œã€‚ mysql/mysql-server: æŒ‡å®šè¦ä½¿ç”¨çš„ Docker æ˜ åƒæª”ã€‚mysql/mysql-server æ˜¯ MySQL å®˜æ–¹æä¾›çš„æ˜ åƒæª”ã€‚ --character-set-server=utf8mb4: è¨­å®š MySQL ä¼ºæœå™¨çš„é è¨­å­—å…ƒé›†ç‚º utf8mb4ï¼Œä»¥æ”¯æ´æ›´å»£æ³›çš„å­—å…ƒï¼ŒåŒ…æ‹¬è¡¨æƒ…ç¬¦è™Ÿã€‚ --collation-server=utf8mb4_unicode_ci: è¨­å®šä¼ºæœå™¨çš„é è¨­æ’åºè¦å‰‡ç‚º utf8mb4_unicode_ciï¼Œé€™æ˜¯ä¸€ç¨®ä¸å€åˆ†å¤§å°å¯«å’Œé‡éŸ³çš„æ’åºè¦å‰‡ã€‚ --skip-character-set-client-handshake: ç¦ç”¨å®¢æˆ¶ç«¯å­—å…ƒé›†æ¡æ‰‹ã€‚é€™æœ‰åŠ©æ–¼ç¢ºä¿å®¢æˆ¶ç«¯å’Œä¼ºæœå™¨ä¹‹é–“çš„å­—å…ƒé›†ä¸€è‡´æ€§ï¼Œé¿å…äº‚ç¢¼å•é¡Œã€‚ å­—å…ƒé›†è¨­å®šçš„ç­‰æ•ˆé…ç½® ä¸Šè¿°å­—å…ƒé›†ç›¸é—œçš„ docker run åƒæ•¸ï¼Œåœ¨ MySQL çš„é…ç½®æª” (my.cnf) ä¸­ï¼Œç­‰æ•ˆæ–¼ä»¥ä¸‹è¨­å®šï¼š\n1 2 3 4 5 6 7 8 9 [client] default-character-set=utf8mb4 [mysql] default-character-set=utf8mb4 [mysqld] collation-server = utf8mb4_unicode_ci character-set-server = utf8mb4 è³‡æ–™æŒä¹…åŒ– (Data Persistence) å°æ–¼è³‡æ–™åº«å®¹å™¨ï¼Œè³‡æ–™æŒä¹…åŒ–æ˜¯è‡³é—œé‡è¦çš„ã€‚å¦‚æœæ²’æœ‰å°‡è³‡æ–™å„²å­˜åˆ°ä¸»æ©Ÿä¸Šï¼Œä¸€æ—¦å®¹å™¨è¢«ç§»é™¤ï¼Œæ‰€æœ‰è³‡æ–™éƒ½å°‡ä¸Ÿå¤±ã€‚Docker æä¾›äº†å…©ç¨®ä¸»è¦æ–¹å¼ä¾†å¯¦ç¾è³‡æ–™æŒä¹…åŒ–ï¼šç¶å®šæ›è¼‰ (Bind Mounts) å’Œ å…·åå„²å­˜å· (Named Volumes)ã€‚\nä½¿ç”¨å…·åå„²å­˜å· (æ¨è–¦) å…·åå„²å­˜å·ç”± Docker ç®¡ç†ï¼Œæ˜¯æŒä¹…åŒ–è³‡æ–™çš„æœ€ä½³æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 docker run \\ --name mysql-server \\ -e MYSQL_ROOT_PASSWORD=your_strong_password \\ -p 3306:3306 \\ -d \\ -v mysql_data:/var/lib/mysql \\ mysql/mysql-server \\ --character-set-server=utf8mb4 \\ --collation-server=utf8mb4_unicode_ci \\ --skip-character-set-client-handshake -v mysql_data:/var/lib/mysql: é€™è£¡ mysql_data æ˜¯ä¸€å€‹å…·åå„²å­˜å·ã€‚Docker æœƒè‡ªå‹•å‰µå»ºä¸¦ç®¡ç†é€™å€‹å„²å­˜å·ï¼Œå°‡å®¹å™¨å…§ /var/lib/mysql (MySQL è³‡æ–™é è¨­å„²å­˜è·¯å¾‘) çš„è³‡æ–™æŒä¹…åŒ–åˆ°é€™å€‹å„²å­˜å·ä¸­ã€‚ æ‚¨å¯ä»¥é€é docker volume ls æŸ¥çœ‹æ‰€æœ‰å…·åå„²å­˜å·ï¼Œä¸¦é€é docker volume inspect mysql_data æŸ¥çœ‹å…¶è©³ç´°è³‡è¨Šã€‚\nä½¿ç”¨ç¶å®šæ›è¼‰ ç¶å®šæ›è¼‰å…è¨±æ‚¨å°‡ä¸»æ©Ÿä¸Šçš„ä»»æ„ç›®éŒ„ç›´æ¥æ›è¼‰åˆ°å®¹å™¨ä¸­ã€‚\n1 2 3 4 5 6 7 8 9 10 docker run \\ --name mysql-server \\ -e MYSQL_ROOT_PASSWORD=your_strong_password \\ -p 3306:3306 \\ -d \\ -v /path/to/your/mysql_data:/var/lib/mysql \\ mysql/mysql-server \\ --character-set-server=utf8mb4 \\ --collation-server=utf8mb4_unicode_ci \\ --skip-character-set-client-handshake -v /path/to/your/mysql_data:/var/lib/mysql: å°‡ä¸»æ©Ÿä¸Šçš„ /path/to/your/mysql_data ç›®éŒ„æ›è¼‰åˆ°å®¹å™¨å…§çš„ /var/lib/mysqlã€‚è«‹å°‡ /path/to/your/mysql_data æ›¿æ›ç‚ºæ‚¨ä¸»æ©Ÿä¸Šçš„å¯¦éš›è·¯å¾‘ã€‚ é€£æ¥åˆ° MySQL å®¹å™¨ ä¸€æ—¦ MySQL å®¹å™¨é‹è¡Œèµ·ä¾†ï¼Œæ‚¨æœ‰å¤šç¨®æ–¹å¼å¯ä»¥é€£æ¥åˆ°å®ƒã€‚\nå¾ä¸»æ©Ÿé€£æ¥ å¦‚æœæ‚¨çš„ä¸»æ©Ÿä¸Šå®‰è£äº† MySQL å®¢æˆ¶ç«¯ï¼Œå¯ä»¥ç›´æ¥é€é localhost å’Œæ˜ å°„çš„åŸ é€£æ¥ï¼š\n1 mysql -h 127.0.0.1 -P 3306 -u root -p ç„¶å¾Œè¼¸å…¥æ‚¨åœ¨ docker run æŒ‡ä»¤ä¸­è¨­å®šçš„ MYSQL_ROOT_PASSWORDã€‚\né€²å…¥å®¹å™¨å…§éƒ¨é€£æ¥ æ‚¨å¯ä»¥ä½¿ç”¨ docker exec æŒ‡ä»¤é€²å…¥é‹è¡Œä¸­çš„å®¹å™¨ï¼Œç„¶å¾Œåœ¨å®¹å™¨å…§éƒ¨ä½¿ç”¨ MySQL å®¢æˆ¶ç«¯ï¼š\n1 2 3 4 5 # é€²å…¥å®¹å™¨çš„ bash shell docker exec -it mysql-server /bin/bash # åœ¨å®¹å™¨å…§éƒ¨åŸ·è¡Œ MySQL å®¢æˆ¶ç«¯ mysql -u root -p ç„¶å¾Œè¼¸å…¥å¯†ç¢¼ã€‚\næœ€ä½³å¯¦è¸èˆ‡è€ƒé‡ å¯†ç¢¼å®‰å…¨ï¼šåœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œè«‹å‹¿å°‡å¯†ç¢¼ç›´æ¥å¯«åœ¨ docker run æŒ‡ä»¤ä¸­ã€‚è€ƒæ…®ä½¿ç”¨ Docker Secrets æˆ–ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ (.env) ä¾†ç®¡ç†æ•æ„Ÿè³‡è¨Šã€‚ è³‡æºé™åˆ¶ï¼šå°æ–¼ç”Ÿç”¢ç’°å¢ƒï¼Œå»ºè­°ç‚º MySQL å®¹å™¨è¨­å®š CPU å’Œè¨˜æ†¶é«”é™åˆ¶ï¼Œä»¥é¿å…å…¶ä½”ç”¨éå¤šä¸»æ©Ÿè³‡æºã€‚ æ—¥èªŒç®¡ç†ï¼šç›£æ§ MySQL å®¹å™¨çš„æ—¥èªŒ (docker logs mysql-server) å°æ–¼æ•…éšœæ’é™¤éå¸¸é‡è¦ã€‚ Docker Composeï¼šå°æ–¼å¤šæœå‹™æ‡‰ç”¨ç¨‹å¼ï¼Œå¼·çƒˆå»ºè­°ä½¿ç”¨ Docker Compose ä¾†å®šç¾©å’Œç®¡ç† MySQL æœå‹™ï¼Œé€™æœƒè®“æ•´å€‹æ‡‰ç”¨ç¨‹å¼çš„éƒ¨ç½²å’Œç®¡ç†æ›´åŠ ä¾¿æ·ã€‚ é€é Docker å®¹å™¨åŒ–éƒ¨ç½² MySQLï¼Œæ‚¨å¯ä»¥æ›´é«˜æ•ˆã€æ›´éˆæ´»åœ°ç®¡ç†æ‚¨çš„è³‡æ–™åº«ç’°å¢ƒã€‚\n","permalink":"https://xinqilin.github.io/post/devops/docker-mysql/","tags":["Docker","MySQL","DevOps","Database","Containerization"],"title":"Docker MySQLï¼šå®¹å™¨åŒ–éƒ¨ç½²èˆ‡è¨­å®š"},{"content":"Basic u: All Users +: add permission x: execute chmod u+x *.sh\nHomebrew /usr/bin/ruby -e \u0026quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\u0026quot; brew install cask brew install wget\nSDKMAN curl -s \u0026quot;https://get.sdkman.io\u0026quot; | bash source \u0026quot;$HOME/.sdkman/bin/sdkman-init.sh\u0026quot;\nOPENJDK /Library/Java/JavaVirtualMachines/ ä¸‹é¢ /usr/libexec/java_home --verbose\nremove\n1 2 cd /Library/Java/JavaVirtualMachines/ sudo rm -rf amazon-corretto-11.jdk MAVEN \u0026amp; GRADLE 1 2 3 4 5 6 7 8 9 10 sdk list java sdk current java sdk list java sdk list gradle sdk install gradle \u0026#39;version\u0026#39; sdk list maven sdk list java history| grep sdk sdk list maven sdk install maven \u0026#39;version\u0026#39; NVM curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.2/install.sh | bash\nCheatSheet Fig brew install --cask fig\nleave end of file to change userName 1 2 3 4 5 prompt_context() { if [[ \u0026#34;$USER\u0026#34; != \u0026#34;$DEFAULT_USER\u0026#34; || -n \u0026#34;$SSH_CLIENT\u0026#34; ]]; then prompt_segment black default \u0026#34;%(!.%{%F{yellow}%}.)Bill\u0026#34; fi } zsh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 # Fig pre block. Keep at the top of this file. [[ -f \u0026#34;$HOME/.fig/shell/zshrc.pre.zsh\u0026#34; ]] \u0026amp;\u0026amp; builtin source \u0026#34;$HOME/.fig/shell/zshrc.pre.zsh\u0026#34; # Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc. # Initialization code that may require console input (password prompts, [y/n] # confirmations, etc.) must go above this block; everything else may go below. if [[ -r \u0026#34;${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh\u0026#34; ]]; then source \u0026#34;${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh\u0026#34; fi # æ‡¶äººæŒ‡ä»¤ alias hist=\u0026#39;history\u0026#39; alias d=\u0026#39;docker\u0026#39; alias gs=\u0026#39;git status\u0026#39; alias g=\u0026#39;git\u0026#39; # JDK # JAVA_HOME=/Library/Java/JavaVirtualMachines/amazon-corretto-11.jdk/Contents/Home JAVA_HOME=/Library/Java/JavaVirtualMachines/amazon-corretto-17.jdk/Contents/Home # JAVA_HOME=/Library/Java/JavaVirtualMachines/graalvm-ce-lts-java11-20.3.4/Contents/Home # JAVA_HOME=/Library/Java/JavaVirtualMachines/graalvm-ce-java17-22.1.0/Contents/Home PATH=$JAVA_HOME/bin:$PATH:. CLASSPATH=$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:. export JAVA_HOME export PATH export CLASSPATH #THIS MUST BE AT THE END OF THE FILE FOR SDKMAN TO WORK!!! export SDKMAN_DIR=\u0026#34;$HOME/.sdkman\u0026#34; [[ -s \u0026#34;$HOME/.sdkman/bin/sdkman-init.sh\u0026#34; ]] \u0026amp;\u0026amp; source \u0026#34;$HOME/.sdkman/bin/sdkman-init.sh\u0026#34; # homebrew # x86_64 version brew path # é€™é‚ŠæœƒæŠŠèˆŠç‰ˆæœ¬å–ç‚º brow (o for old) export PATH=/opt/homebrew/bin:$PATH alias brow=\u0026#39;arch --x86_64 /usr/local/Homebrew/bin/brew\u0026#39; # nvm export NVM_DIR=\u0026#34;$([ -z \u0026#34;${XDG_CONFIG_HOME-}\u0026#34; ] \u0026amp;\u0026amp; printf %s \u0026#34;${HOME}/.nvm\u0026#34; || printf %s \u0026#34;${XDG_CONFIG_HOME}/nvm\u0026#34;)\u0026#34; [ -s \u0026#34;$NVM_DIR/nvm.sh\u0026#34; ] \u0026amp;\u0026amp; \\. \u0026#34;$NVM_DIR/nvm.sh\u0026#34; # This loads nvm # If you come from bash you might have to change your $PATH. # export PATH=$HOME/bin:/usr/local/bin:$PATH # Path to your oh-my-zsh installation. export ZSH=\u0026#34;$HOME/.oh-my-zsh\u0026#34; # Set name of the theme to load --- if set to \u0026#34;random\u0026#34;, it will # load a random theme each time oh-my-zsh is loaded, in which case, # to know which specific one was loaded, run: echo $RANDOM_THEME # See https://github.com/ohmyzsh/ohmyzsh/wiki/Themes ZSH_THEME=\u0026#34;agnoster\u0026#34; # ZSH_THEME=\u0026#34;powerlevel10k/powerlevel10k\u0026#34; # Set list of themes to pick from when loading at random # Setting this variable when ZSH_THEME=random will cause zsh to load # a theme from this variable instead of looking in $ZSH/themes/ # If set to an empty array, this variable will have no effect. # ZSH_THEME_RANDOM_CANDIDATES=( \u0026#34;robbyrussell\u0026#34; \u0026#34;agnoster\u0026#34; ) # Uncomment the following line to use case-sensitive completion. # CASE_SENSITIVE=\u0026#34;true\u0026#34; # Uncomment the following line to use hyphen-insensitive completion. # Case-sensitive completion must be off. _ and - will be interchangeable. # HYPHEN_INSENSITIVE=\u0026#34;true\u0026#34; # Uncomment one of the following lines to change the auto-update behavior # zstyle \u0026#39;:omz:update\u0026#39; mode disabled # disable automatic updates # zstyle \u0026#39;:omz:update\u0026#39; mode auto # update automatically without asking # zstyle \u0026#39;:omz:update\u0026#39; mode reminder # just remind me to update when it\u0026#39;s time # Uncomment the following line to change how often to auto-update (in days). # zstyle \u0026#39;:omz:update\u0026#39; frequency 13 # Uncomment the following line if pasting URLs and other text is messed up. # DISABLE_MAGIC_FUNCTIONS=\u0026#34;true\u0026#34; # Uncomment the following line to disable colors in ls. # DISABLE_LS_COLORS=\u0026#34;true\u0026#34; # Uncomment the following line to disable auto-setting terminal title. # DISABLE_AUTO_TITLE=\u0026#34;true\u0026#34; # Uncomment the following line to enable command auto-correction. # ENABLE_CORRECTION=\u0026#34;true\u0026#34; # Uncomment the following line to display red dots whilst waiting for completion. # You can also set it to another string to have that shown instead of the default red dots. # e.g. COMPLETION_WAITING_DOTS=\u0026#34;%F{yellow}waiting...%f\u0026#34; # Caution: this setting can cause issues with multiline prompts in zsh \u0026lt; 5.7.1 (see #5765) # COMPLETION_WAITING_DOTS=\u0026#34;true\u0026#34; # Uncomment the following line if you want to disable marking untracked files # under VCS as dirty. This makes repository status check for large repositories # much, much faster. # DISABLE_UNTRACKED_FILES_DIRTY=\u0026#34;true\u0026#34; # Uncomment the following line if you want to change the command execution time # stamp shown in the history command output. # You can set one of the optional three formats: # \u0026#34;mm/dd/yyyy\u0026#34;|\u0026#34;dd.mm.yyyy\u0026#34;|\u0026#34;yyyy-mm-dd\u0026#34; # or set a custom format using the strftime function format specifications, # see \u0026#39;man strftime\u0026#39; for details. # HIST_STAMPS=\u0026#34;mm/dd/yyyy\u0026#34; # Would you like to use another custom folder than $ZSH/custom? # ZSH_CUSTOM=/path/to/new-custom-folder # Which plugins would you like to load? # Standard plugins can be found in $ZSH/plugins/ # Custom plugins may be added to $ZSH_CUSTOM/plugins/ # Example format: plugins=(rails git textmate ruby lighthouse) # Add wisely, as too many plugins slow down shell startup. plugins=(git) source $ZSH/oh-my-zsh.sh # User configuration # export MANPATH=\u0026#34;/usr/local/man:$MANPATH\u0026#34; # You may need to manually set your language environment # export LANG=en_US.UTF-8 # Preferred editor for local and remote sessions # if [[ -n $SSH_CONNECTION ]]; then # export EDITOR=\u0026#39;vim\u0026#39; # else # export EDITOR=\u0026#39;mvim\u0026#39; # fi # Compilation flags # export ARCHFLAGS=\u0026#34;-arch x86_64\u0026#34; # Set personal aliases, overriding those provided by oh-my-zsh libs, # plugins, and themes. Aliases can be placed here, though oh-my-zsh # users are encouraged to define aliases within the ZSH_CUSTOM folder. # For a full list of active aliases, run `alias`. # # Example aliases # alias zshconfig=\u0026#34;mate ~/.zshrc\u0026#34; # alias ohmyzsh=\u0026#34;mate ~/.oh-my-zsh\u0026#34; code () { VSCODE_CWD=\u0026#34;$PWD\u0026#34; open -n -b \u0026#34;com.microsoft.VSCode\u0026#34; --args $* ;} plugins=( git zsh-syntax-highlighting zsh-autosuggestions ) # To customize prompt, run `p10k configure` or edit ~/.p10k.zsh. [[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh # é€™è¡Œæ§åˆ¶ userName prompt_context() { if [[ \u0026#34;$USER\u0026#34; != \u0026#34;$DEFAULT_USER\u0026#34; || -n \u0026#34;$SSH_CLIENT\u0026#34; ]]; then prompt_segment black default \u0026#34;%(!.%{%F{yellow}%}.)Bill\u0026#34; fi } # Fig post block. Keep at the bottom of this file. [[ -f \u0026#34;$HOME/.fig/shell/zshrc.post.zsh\u0026#34; ]] \u0026amp;\u0026amp; builtin source \u0026#34;$HOME/.fig/shell/zshrc.post.zsh\u0026#34; ","permalink":"https://xinqilin.github.io/post/tools/env/","tags":[],"title":"Env"},{"content":"æ¦‚è¿° æ‹“æ’²æ’åºï¼ˆTopological Sortï¼‰æ˜¯å°**æœ‰å‘ç„¡ç’°åœ–ï¼ˆDAG, Directed Acyclic Graphï¼‰**é€²è¡Œæ’åºçš„æ¼”ç®—æ³•ã€‚æ’åºçµæœæ˜¯ä¸€å€‹ç·šæ€§åºåˆ—ï¼Œä½¿å¾—å°æ–¼åœ–ä¸­ä»»æ„æœ‰å‘é‚Š (u, v)ï¼Œåœ¨æ’åºçµæœä¸­ u éƒ½å‡ºç¾åœ¨ v ä¹‹å‰ã€‚\nåŸºæœ¬æ¦‚å¿µ æ‡‰ç”¨å ´æ™¯ èª²ç¨‹æ’èª²ï¼šæŸäº›èª²ç¨‹æœ‰å…ˆä¿®èª²ç¨‹çš„è¦æ±‚ ç·¨è­¯ä¾è³´ï¼šç¨‹å¼æ¨¡çµ„é–“çš„ç·¨è­¯é †åº ä»»å‹™èª¿åº¦ï¼šæœ‰ä¾è³´é—œä¿‚çš„ä»»å‹™åŸ·è¡Œé †åº Makefile å»ºæ§‹ï¼šæª”æ¡ˆé–“çš„ä¾è³´é—œä¿‚ å‰ææ¢ä»¶ åœ–å¿…é ˆæ˜¯æœ‰å‘ç„¡ç’°åœ–ï¼ˆDAGï¼‰ å¦‚æœåœ–ä¸­å­˜åœ¨ç’°ï¼Œå‰‡ç„¡æ³•é€²è¡Œæ‹“æ’²æ’åº æ¼”ç®—æ³•å¯¦ä½œ æ–¹æ³•ä¸€ï¼šKahn æ¼”ç®—æ³•ï¼ˆBFS åŸºç¤ï¼‰ åŸºæœ¬æ€è·¯ è¨ˆç®—æ‰€æœ‰ç¯€é»çš„å…¥åº¦ å°‡å…¥åº¦ç‚º 0 çš„ç¯€é»åŠ å…¥ä½‡åˆ— ä¸æ–·å¾ä½‡åˆ—ä¸­å–å‡ºç¯€é»ï¼Œä¸¦æ¸›å°‘å…¶ç›¸é„°ç¯€é»çš„å…¥åº¦ å¦‚æœç›¸é„°ç¯€é»çš„å…¥åº¦è®Šç‚º 0ï¼Œå‰‡åŠ å…¥ä½‡åˆ— é‡è¤‡ç›´åˆ°ä½‡åˆ—ç‚ºç©º å¯¦ä½œä»£ç¢¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 public class TopologicalSort { public List\u0026lt;Integer\u0026gt; topologicalSort(int numNodes, List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; edges) { // å»ºç«‹é„°æ¥è¡¨å’Œå…¥åº¦é™£åˆ— List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; graph = new ArrayList\u0026lt;\u0026gt;(); int[] indegree = new int[numNodes]; for (int i = 0; i \u0026lt; numNodes; i++) { graph.add(new ArrayList\u0026lt;\u0026gt;()); } // å»ºæ§‹åœ–ä¸¦è¨ˆç®—å…¥åº¦ for (List\u0026lt;Integer\u0026gt; edge : edges) { int from = edge.get(0); int to = edge.get(1); graph.get(from).add(to); indegree[to]++; } // å°‡å…¥åº¦ç‚º 0 çš„ç¯€é»åŠ å…¥ä½‡åˆ— Queue\u0026lt;Integer\u0026gt; queue = new LinkedList\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; numNodes; i++) { if (indegree[i] == 0) { queue.offer(i); } } List\u0026lt;Integer\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); // BFS è™•ç† while (!queue.isEmpty()) { int node = queue.poll(); result.add(node); // æ¸›å°‘ç›¸é„°ç¯€é»çš„å…¥åº¦ for (int neighbor : graph.get(node)) { indegree[neighbor]--; if (indegree[neighbor] == 0) { queue.offer(neighbor); } } } // æª¢æŸ¥æ˜¯å¦å­˜åœ¨ç’° if (result.size() != numNodes) { return new ArrayList\u0026lt;\u0026gt;(); // å­˜åœ¨ç’°ï¼Œç„¡æ³•æ‹“æ’²æ’åº } return result; } } æ–¹æ³•äºŒï¼šDFS åŸºç¤ åŸºæœ¬æ€è·¯ å°æ¯å€‹æœªè¨ªå•çš„ç¯€é»é€²è¡Œ DFS åœ¨ DFS å›æº¯æ™‚å°‡ç¯€é»åŠ å…¥çµæœ åè½‰çµæœå¾—åˆ°æ‹“æ’²æ’åº å¯¦ä½œä»£ç¢¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 public class TopologicalSortDFS { private static final int WHITE = 0; // æœªè¨ªå• private static final int GRAY = 1; // æ­£åœ¨è¨ªå• private static final int BLACK = 2; // å·²å®Œæˆ public List\u0026lt;Integer\u0026gt; topologicalSort(int numNodes, List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; edges) { // å»ºç«‹é„°æ¥è¡¨ List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; graph = new ArrayList\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; numNodes; i++) { graph.add(new ArrayList\u0026lt;\u0026gt;()); } for (List\u0026lt;Integer\u0026gt; edge : edges) { graph.get(edge.get(0)).add(edge.get(1)); } int[] color = new int[numNodes]; Stack\u0026lt;Integer\u0026gt; stack = new Stack\u0026lt;\u0026gt;(); // å°æ¯å€‹æœªè¨ªå•çš„ç¯€é»é€²è¡Œ DFS for (int i = 0; i \u0026lt; numNodes; i++) { if (color[i] == WHITE) { if (!dfs(graph, i, color, stack)) { return new ArrayList\u0026lt;\u0026gt;(); // å­˜åœ¨ç’° } } } // åè½‰çµæœ List\u0026lt;Integer\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); while (!stack.isEmpty()) { result.add(stack.pop()); } return result; } private boolean dfs(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; graph, int node, int[] color, Stack\u0026lt;Integer\u0026gt; stack) { color[node] = GRAY; // æ¨™è¨˜ç‚ºæ­£åœ¨è¨ªå• for (int neighbor : graph.get(node)) { if (color[neighbor] == GRAY) { return false; // ç™¼ç¾å¾Œå‘é‚Šï¼Œå­˜åœ¨ç’° } if (color[neighbor] == WHITE \u0026amp;\u0026amp; !dfs(graph, neighbor, color, stack)) { return false; } } color[node] = BLACK; // æ¨™è¨˜ç‚ºå·²å®Œæˆ stack.push(node); // å¾Œåºéæ­·é †åº return true; } } å¯¦éš›æ‡‰ç”¨é¡Œå‹ 1. èª²ç¨‹å®‰æ’ï¼ˆLeetCode 207 \u0026amp; 210ï¼‰ å•é¡Œ 207ï¼šåˆ¤æ–·æ˜¯å¦å¯ä»¥å®Œæˆæ‰€æœ‰èª²ç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 public boolean canFinish(int numCourses, int[][] prerequisites) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; graph = new ArrayList\u0026lt;\u0026gt;(); int[] indegree = new int[numCourses]; // åˆå§‹åŒ–åœ– for (int i = 0; i \u0026lt; numCourses; i++) { graph.add(new ArrayList\u0026lt;\u0026gt;()); } // å»ºæ§‹åœ– for (int[] prereq : prerequisites) { graph.get(prereq[1]).add(prereq[0]); indegree[prereq[0]]++; } // Kahn æ¼”ç®—æ³• Queue\u0026lt;Integer\u0026gt; queue = new LinkedList\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; numCourses; i++) { if (indegree[i] == 0) { queue.offer(i); } } int completedCourses = 0; while (!queue.isEmpty()) { int course = queue.poll(); completedCourses++; for (int nextCourse : graph.get(course)) { indegree[nextCourse]--; if (indegree[nextCourse] == 0) { queue.offer(nextCourse); } } } return completedCourses == numCourses; } å•é¡Œ 210ï¼šè¿”å›èª²ç¨‹å®‰æ’çš„é †åºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 public int[] findOrder(int numCourses, int[][] prerequisites) { List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; graph = new ArrayList\u0026lt;\u0026gt;(); int[] indegree = new int[numCourses]; // å»ºæ§‹åœ–ï¼ˆåŒä¸Šï¼‰ for (int i = 0; i \u0026lt; numCourses; i++) { graph.add(new ArrayList\u0026lt;\u0026gt;()); } for (int[] prereq : prerequisites) { graph.get(prereq[1]).add(prereq[0]); indegree[prereq[0]]++; } Queue\u0026lt;Integer\u0026gt; queue = new LinkedList\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; numCourses; i++) { if (indegree[i] == 0) { queue.offer(i); } } int[] result = new int[numCourses]; int index = 0; while (!queue.isEmpty()) { int course = queue.poll(); result[index++] = course; for (int nextCourse : graph.get(course)) { indegree[nextCourse]--; if (indegree[nextCourse] == 0) { queue.offer(nextCourse); } } } return index == numCourses ? result : new int[0]; } 2. æ‰€æœ‰å¯èƒ½çš„èœè­œï¼ˆLeetCode 2115ï¼‰ å•é¡Œæè¿°ï¼šçµ¦å®šå¯è£½ä½œçš„èœè­œã€æ‰€éœ€åŸæ–™ä»¥åŠç¾æœ‰åŸæ–™ï¼Œæ‰¾å‡ºæ‰€æœ‰å¯èƒ½è£½ä½œçš„èœè­œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 class Solution { private static final int NOT_VISITED = 0; private static final int VISITING = 1; private static final int VISITED = 2; public List\u0026lt;String\u0026gt; findAllRecipes(String[] recipes, List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; ingredients, String[] supplies) { Map\u0026lt;String, Integer\u0026gt; status = new HashMap\u0026lt;\u0026gt;(); Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; prereqs = new HashMap\u0026lt;\u0026gt;(); // åˆå§‹åŒ–é£Ÿè­œå’Œå…¶æ‰€éœ€åŸæ–™ for (int i = 0; i \u0026lt; recipes.length; i++) { status.put(recipes[i], NOT_VISITED); prereqs.put(recipes[i], ingredients.get(i)); } // å°‡ç¾æœ‰åŸæ–™æ¨™è¨˜ç‚ºå·²è¨ªå• for (String supply : supplies) { status.put(supply, VISITED); } List\u0026lt;String\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); // å°æ¯å€‹é£Ÿè­œé€²è¡Œ DFS for (String recipe : recipes) { dfs(recipe, prereqs, status, result); } return result; } private boolean dfs(String item, Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; prereqs, Map\u0026lt;String, Integer\u0026gt; status, List\u0026lt;String\u0026gt; result) { if (!status.containsKey(item)) { return false; // ä¸å­˜åœ¨æ­¤åŸæ–™æˆ–é£Ÿè­œ } if (status.get(item) == VISITING) { return false; // ç™¼ç¾ç’°ï¼Œç„¡æ³•è£½ä½œ } if (status.get(item) == VISITED) { return true; // å·²ç¶“å¯ä»¥è£½ä½œ } // æ¨™è¨˜ç‚ºæ­£åœ¨è¨ªå• status.put(item, VISITING); // æª¢æŸ¥æ‰€æœ‰å‰ç½®æ¢ä»¶ if (prereqs.containsKey(item)) { for (String ingredient : prereqs.get(item)) { if (!dfs(ingredient, prereqs, status, result)) { return false; } } } // æ¨™è¨˜ç‚ºå·²å®Œæˆ status.put(item, VISITED); result.add(item); return true; } } è¤‡é›œåº¦åˆ†æ æ¼”ç®—æ³• æ™‚é–“è¤‡é›œåº¦ ç©ºé–“è¤‡é›œåº¦ å„ªé» ç¼ºé» Kahn (BFS) O(V + E) O(V) å¯¦ä½œç°¡å–®ï¼Œæ˜“æ–¼ç†è§£ éœ€è¦é¡å¤–çš„å…¥åº¦é™£åˆ— DFS O(V + E) O(V) å¯ä»¥æª¢æ¸¬ç’°ï¼Œè¨˜æ†¶é«”ä½¿ç”¨è¼ƒå°‘ å¯¦ä½œç¨è¤‡é›œ å…¶ä¸­ V æ˜¯ç¯€é»æ•¸ï¼ŒE æ˜¯é‚Šæ•¸ã€‚\nå¯¦ä½œæŠ€å·§ 1. ç’°çš„æª¢æ¸¬ 1 2 3 4 5 6 7 8 9 10 // Kahn æ¼”ç®—æ³•ï¼šå¦‚æœè™•ç†çš„ç¯€é»æ•¸ä¸ç­‰æ–¼ç¸½ç¯€é»æ•¸ï¼Œå‰‡å­˜åœ¨ç’° if (processedNodes != totalNodes) { // å­˜åœ¨ç’° } // DFSï¼šä½¿ç”¨ä¸‰è‰²æ¨™è¨˜æ³•æª¢æ¸¬å¾Œå‘é‚Š if (color[neighbor] == GRAY) { // ç™¼ç¾å¾Œå‘é‚Šï¼Œå­˜åœ¨ç’° return false; } 2. å¤šå€‹æ‹“æ’²æ’åºè§£ å¦‚æœéœ€è¦æ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„æ‹“æ’²æ’åºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 public void findAllTopologicalSorts(List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; graph, int[] indegree, List\u0026lt;Integer\u0026gt; current, List\u0026lt;List\u0026lt;Integer\u0026gt;\u0026gt; allResults) { Queue\u0026lt;Integer\u0026gt; available = new LinkedList\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; indegree.length; i++) { if (indegree[i] == 0) { available.offer(i); } } if (available.isEmpty()) { if (current.size() == indegree.length) { allResults.add(new ArrayList\u0026lt;\u0026gt;(current)); } return; } // å˜—è©¦æ‰€æœ‰å¯èƒ½çš„ä¸‹ä¸€å€‹ç¯€é» for (int node : available) { // é¸æ“‡ current.add(node); int[] newIndegree = indegree.clone(); newIndegree[node] = -1; // æ¨™è¨˜ç‚ºå·²ä½¿ç”¨ for (int neighbor : graph.get(node)) { newIndegree[neighbor]--; } // éæ­¸ findAllTopologicalSorts(graph, newIndegree, current, allResults); // æ’¤éŠ·é¸æ“‡ current.remove(current.size() - 1); } } ç¸½çµ æ‹“æ’²æ’åºæ˜¯è™•ç†æœ‰ä¾è³´é—œä¿‚å•é¡Œçš„é‡è¦æ¼”ç®—æ³•ã€‚æŒæ¡è¦é»ï¼š\né©ç”¨æ¢ä»¶ï¼šåªèƒ½ç”¨æ–¼æœ‰å‘ç„¡ç’°åœ– å…©ç¨®æ–¹æ³•ï¼šKahn æ¼”ç®—æ³•ï¼ˆBFSï¼‰å’Œ DFS æ–¹æ³• ç’°çš„æª¢æ¸¬ï¼šå…©ç¨®æ–¹æ³•éƒ½èƒ½æª¢æ¸¬åœ–ä¸­æ˜¯å¦å­˜åœ¨ç’° å¯¦éš›æ‡‰ç”¨ï¼šèª²ç¨‹å®‰æ’ã€ä»»å‹™èª¿åº¦ã€ç·¨è­¯ä¾è³´ç­‰ é¸æ“‡æ¼”ç®—æ³•æ™‚ï¼š\nKahn æ¼”ç®—æ³•ï¼šé‚è¼¯ç›´è§€ï¼Œé©åˆåˆå­¸è€… DFS æ–¹æ³•ï¼šæ›´éˆæ´»ï¼Œèƒ½æä¾›æ›´å¤šä¿¡æ¯ï¼ˆå¦‚å®Œæˆæ™‚é–“ï¼‰ åƒè€ƒè³‡æ–™ LeetCode 207. Course Schedule LeetCode 210. Course Schedule II LeetCode 2115. Find All Possible Recipes from Given Supplies æ¼”ç®—æ³•å°è«– - åœ–çš„æ‹“æ’²æ’åº ","permalink":"https://xinqilin.github.io/post/algorithm/topologicalsort/","tags":["Algorithm","Graph","TopologicalSort","DFS","BFS","Java"],"title":"æ‹“æ’²æ’åºï¼ˆTopological Sortï¼‰æ¼”ç®—æ³•è©³è§£"},{"content":"æ¦‚è¿° Reactive Programmingï¼ˆéŸ¿æ‡‰å¼ç¨‹å¼è¨­è¨ˆï¼‰æ˜¯ä¸€ç¨®åŸºæ–¼è³‡æ–™æµå’Œè®ŠåŒ–å‚³æ’­çš„ç¨‹å¼è¨­è¨ˆæ¨¡å¼ã€‚åœ¨ Java ç”Ÿæ…‹ç³»çµ±ä¸­ï¼ŒProject Reactor æ˜¯å¯¦ç¾éŸ¿æ‡‰å¼ç¨‹å¼è¨­è¨ˆçš„æ ¸å¿ƒå‡½å¼åº«ï¼Œè€Œ Spring WebFlux å‰‡å»ºç«‹åœ¨å…¶ä¹‹ä¸Šï¼Œæä¾›éé˜»å¡å¼çš„ Web æ‡‰ç”¨ç¨‹å¼é–‹ç™¼èƒ½åŠ›ã€‚\næ ¸å¿ƒæ¦‚å¿µ ä»€éº¼æ˜¯ Reactive Programmingï¼Ÿ éŸ¿æ‡‰å¼ç¨‹å¼è¨­è¨ˆçš„æ ¸å¿ƒç‰¹å¾µï¼š\néé˜»å¡ï¼ˆNon-blockingï¼‰ï¼šåŸ·è¡Œç·’ä¸æœƒè¢« I/O æ“ä½œé˜»å¡ äº‹ä»¶é©…å‹•ï¼ˆEvent-drivenï¼‰ï¼šåŸºæ–¼äº‹ä»¶æµè™•ç†è³‡æ–™ èƒŒå£“æ”¯æ´ï¼ˆBackpressureï¼‰ï¼šè‡ªå‹•è™•ç†ç”Ÿç”¢è€…å’Œæ¶ˆè²»è€…ä¹‹é–“çš„é€Ÿåº¦å·®ç•° å½ˆæ€§ï¼ˆResilientï¼‰ï¼šå…·å‚™éŒ¯èª¤è™•ç†å’Œæ¢å¾©èƒ½åŠ› éŸ¿æ‡‰æ€§ï¼ˆResponsiveï¼‰ï¼šå¿«é€Ÿå›æ‡‰ä½¿ç”¨è€…è«‹æ±‚ Reactive Streams è¦ç¯„ Reactive Streams å®šç¾©äº†å››å€‹æ ¸å¿ƒä»‹é¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public interface Publisher\u0026lt;T\u0026gt; { void subscribe(Subscriber\u0026lt;? super T\u0026gt; s); } public interface Subscriber\u0026lt;T\u0026gt; { void onSubscribe(Subscription s); void onNext(T t); void onError(Throwable t); void onComplete(); } public interface Subscription { void request(long n); void cancel(); } public interface Processor\u0026lt;T, R\u0026gt; extends Subscriber\u0026lt;T\u0026gt;, Publisher\u0026lt;R\u0026gt; { } Project Reactor åŸºç¤ Mono èˆ‡ Flux Project Reactor æä¾›å…©å€‹æ ¸å¿ƒé¡å‹ï¼š\nMonoï¼šç™¼å‡º 0 æˆ– 1 å€‹å…ƒç´ çš„éŸ¿æ‡‰å¼æµ Fluxï¼šç™¼å‡º 0 åˆ° N å€‹å…ƒç´ çš„éŸ¿æ‡‰å¼æµ å‰µå»ºéŸ¿æ‡‰å¼æµ Mono å‰µå»ºæ–¹å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // å‰µå»ºåŒ…å«å–®ä¸€å€¼çš„ Mono Mono\u0026lt;String\u0026gt; mono1 = Mono.just(\u0026#34;Hello Reactive\u0026#34;); // å‰µå»ºç©ºçš„ Mono Mono\u0026lt;String\u0026gt; empty = Mono.empty(); // å¾ Optional å‰µå»º Mono\u0026lt;String\u0026gt; mono2 = Mono.justOrEmpty(Optional.of(\u0026#34;Optional Value\u0026#34;)); // å»¶é²å‰µå»º Mono\u0026lt;String\u0026gt; lazy = Mono.fromSupplier(() -\u0026gt; { // è¤‡é›œçš„è¨ˆç®—é‚è¼¯ return \u0026#34;Computed Value\u0026#34;; }); // å¾ Callable å‰µå»º Mono\u0026lt;String\u0026gt; callable = Mono.fromCallable(() -\u0026gt; { Thread.sleep(1000); // æ¨¡æ“¬è€—æ™‚æ“ä½œ return \u0026#34;Delayed Value\u0026#34;; }); // éŒ¯èª¤ Mono Mono\u0026lt;String\u0026gt; error = Mono.error(new RuntimeException(\u0026#34;Something went wrong\u0026#34;)); Flux å‰µå»ºæ–¹å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // å¾å¯è®Šåƒæ•¸å‰µå»º Flux\u0026lt;String\u0026gt; flux1 = Flux.just(\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;, \u0026#34;D\u0026#34;); // å¾é›†åˆå‰µå»º List\u0026lt;String\u0026gt; list = Arrays.asList(\u0026#34;Apple\u0026#34;, \u0026#34;Banana\u0026#34;, \u0026#34;Cherry\u0026#34;); Flux\u0026lt;String\u0026gt; flux2 = Flux.fromIterable(list); // å‰µå»ºæ•¸å­—ç¯„åœ Flux\u0026lt;Integer\u0026gt; range = Flux.range(1, 10); // 1 åˆ° 10 // å®šæ™‚ç™¼å°„ Flux\u0026lt;Long\u0026gt; interval = Flux.interval(Duration.ofSeconds(1)); // æ¯ç§’ç™¼å°„ä¸€å€‹éå¢æ•¸å­— // å¾é™£åˆ—å‰µå»º String[] array = {\u0026#34;X\u0026#34;, \u0026#34;Y\u0026#34;, \u0026#34;Z\u0026#34;}; Flux\u0026lt;String\u0026gt; flux3 = Flux.fromArray(array); // å¾ Stream å‰µå»º Flux\u0026lt;String\u0026gt; flux4 = Flux.fromStream(Stream.of(\u0026#34;Stream1\u0026#34;, \u0026#34;Stream2\u0026#34;)); è¨‚é–±èˆ‡æ¶ˆè²» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // åŸºæœ¬è¨‚é–± Flux\u0026lt;Integer\u0026gt; numbers = Flux.range(1, 5); // åªè™•ç†æ•¸æ“š numbers.subscribe(System.out::println); // è™•ç†æ•¸æ“šå’ŒéŒ¯èª¤ numbers.subscribe( data -\u0026gt; System.out.println(\u0026#34;Data: \u0026#34; + data), error -\u0026gt; System.err.println(\u0026#34;Error: \u0026#34; + error) ); // å®Œæ•´çš„è¨‚é–±è™•ç† numbers.subscribe( data -\u0026gt; System.out.println(\u0026#34;Next: \u0026#34; + data), // onNext error -\u0026gt; System.err.println(\u0026#34;Error: \u0026#34; + error), // onError () -\u0026gt; System.out.println(\u0026#34;Completed!\u0026#34;) // onComplete ); // ä½¿ç”¨è‡ªè¨‚ Subscriber numbers.subscribe(new BaseSubscriber\u0026lt;Integer\u0026gt;() { @Override protected void hookOnSubscribe(Subscription subscription) { System.out.println(\u0026#34;Subscribed\u0026#34;); request(1); // è«‹æ±‚ç¬¬ä¸€å€‹å…ƒç´  } @Override protected void hookOnNext(Integer value) { System.out.println(\u0026#34;Value: \u0026#34; + value); if (value \u0026lt; 3) { request(1); // ç¹¼çºŒè«‹æ±‚ä¸‹ä¸€å€‹ } else { cancel(); // å–æ¶ˆè¨‚é–± } } }); æ ¸å¿ƒæ“ä½œç¬¦è©³è§£ è½‰æ›æ“ä½œç¬¦ map - å…ƒç´ è½‰æ› 1 2 3 4 5 6 7 8 9 Flux\u0026lt;String\u0026gt; names = Flux.just(\u0026#34;alice\u0026#34;, \u0026#34;bob\u0026#34;, \u0026#34;charlie\u0026#34;); // è½‰æ›ç‚ºå¤§å¯« Flux\u0026lt;String\u0026gt; upperNames = names.map(String::toUpperCase); upperNames.subscribe(System.out::println); // ALICE, BOB, CHARLIE // è½‰æ›ç‚ºé•·åº¦ Flux\u0026lt;Integer\u0026gt; lengths = names.map(String::length); lengths.subscribe(System.out::println); // 5, 3, 7 flatMap - æ‰å¹³åŒ–è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Flux\u0026lt;String\u0026gt; sentences = Flux.just(\u0026#34;Hello World\u0026#34;, \u0026#34;Reactive Programming\u0026#34;); // å°‡æ¯å€‹å¥å­æ‹†åˆ†ç‚ºå–®è© Flux\u0026lt;String\u0026gt; words = sentences.flatMap(sentence -\u0026gt; Flux.fromArray(sentence.split(\u0026#34; \u0026#34;)) ); words.subscribe(System.out::println); // Hello, World, Reactive, Programming // éåŒæ­¥è™•ç† Flux\u0026lt;String\u0026gt; urls = Flux.just(\u0026#34;url1\u0026#34;, \u0026#34;url2\u0026#34;, \u0026#34;url3\u0026#34;); Flux\u0026lt;String\u0026gt; responses = urls.flatMap(url -\u0026gt; Mono.fromCallable(() -\u0026gt; { // æ¨¡æ“¬ HTTP è«‹æ±‚ Thread.sleep(100); return \u0026#34;Response from \u0026#34; + url; }).subscribeOn(Schedulers.boundedElastic()) ); concatMap - é †åºè™•ç† 1 2 3 4 5 // èˆ‡ flatMap ä¸åŒï¼ŒconcatMap ä¿æŒé †åº Flux\u0026lt;String\u0026gt; ordered = urls.concatMap(url -\u0026gt; Mono.fromCallable(() -\u0026gt; \u0026#34;Response from \u0026#34; + url) .subscribeOn(Schedulers.boundedElastic()) ); éæ¿¾æ“ä½œç¬¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 Flux\u0026lt;Integer\u0026gt; numbers = Flux.range(1, 10); // éæ¿¾å¶æ•¸ Flux\u0026lt;Integer\u0026gt; evenNumbers = numbers.filter(n -\u0026gt; n % 2 == 0); // å–å‰ 3 å€‹å…ƒç´  Flux\u0026lt;Integer\u0026gt; first3 = numbers.take(3); // è·³éå‰ 5 å€‹å…ƒç´  Flux\u0026lt;Integer\u0026gt; skip5 = numbers.skip(5); // å»é‡ Flux\u0026lt;String\u0026gt; duplicates = Flux.just(\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;A\u0026#34;, \u0026#34;C\u0026#34;, \u0026#34;B\u0026#34;); Flux\u0026lt;String\u0026gt; distinct = duplicates.distinct(); // å–ä¸é‡è¤‡å…ƒç´ ç›´åˆ°é‡åˆ°é‡è¤‡ Flux\u0026lt;String\u0026gt; distinctUntilChanged = Flux.just(\u0026#34;A\u0026#34;, \u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;) .distinctUntilChanged(); çµ„åˆæ“ä½œç¬¦ merge - åˆä½µå¤šå€‹æµ 1 2 3 4 5 6 7 8 9 Flux\u0026lt;String\u0026gt; flux1 = Flux.just(\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;).delayElements(Duration.ofMillis(100)); Flux\u0026lt;String\u0026gt; flux2 = Flux.just(\u0026#34;C\u0026#34;, \u0026#34;D\u0026#34;).delayElements(Duration.ofMillis(150)); // åˆä½µï¼ˆé †åºä¸ä¿è­‰ï¼‰ Flux\u0026lt;String\u0026gt; merged = Flux.merge(flux1, flux2); merged.subscribe(System.out::println); // å¯èƒ½è¼¸å‡º: A, C, B, D // ä½¿ç”¨ mergeWith Flux\u0026lt;String\u0026gt; merged2 = flux1.mergeWith(flux2); concat - é€£æ¥æµ 1 2 3 4 5 6 // é€£æ¥ï¼ˆä¿æŒé †åºï¼‰ Flux\u0026lt;String\u0026gt; concatenated = Flux.concat(flux1, flux2); concatenated.subscribe(System.out::println); // è¼¸å‡º: A, B, C, D // ä½¿ç”¨ concatWith Flux\u0026lt;String\u0026gt; concatenated2 = flux1.concatWith(flux2); zip - é…å°å…ƒç´  1 2 3 4 5 6 7 8 9 10 11 Flux\u0026lt;String\u0026gt; names = Flux.just(\u0026#34;Alice\u0026#34;, \u0026#34;Bob\u0026#34;, \u0026#34;Charlie\u0026#34;); Flux\u0026lt;Integer\u0026gt; ages = Flux.just(25, 30, 35); // é…å°å…ƒç´  Flux\u0026lt;String\u0026gt; people = Flux.zip(names, ages, (name, age) -\u0026gt; name + \u0026#34; is \u0026#34; + age + \u0026#34; years old\u0026#34; ); people.subscribe(System.out::println); // Alice is 25 years old // Bob is 30 years old // Charlie is 35 years old éŒ¯èª¤è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 Flux\u0026lt;String\u0026gt; source = Flux.just(\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;) .map(s -\u0026gt; { if (\u0026#34;B\u0026#34;.equals(s)) { throw new RuntimeException(\u0026#34;Error on B\u0026#34;); } return s; }); // æä¾›é è¨­å€¼ Flux\u0026lt;String\u0026gt; withDefault = source.onErrorReturn(\u0026#34;DEFAULT\u0026#34;); // ç¹¼çºŒå…¶ä»–æµ Flux\u0026lt;String\u0026gt; fallback = source.onErrorResume(error -\u0026gt; Flux.just(\u0026#34;FALLBACK1\u0026#34;, \u0026#34;FALLBACK2\u0026#34;) ); // é‡è©¦ Flux\u0026lt;String\u0026gt; withRetry = source.retry(3); // é‡è©¦ä¸”å»¶é² Flux\u0026lt;String\u0026gt; withRetryDelay = source.retryWhen( Retry.backoff(3, Duration.ofSeconds(1)) ); // æ•ç²éŒ¯èª¤ä¸¦ç¹¼çºŒ Flux\u0026lt;String\u0026gt; continueOnError = source.onErrorContinue((error, item) -\u0026gt; { System.err.println(\u0026#34;Error on item \u0026#34; + item + \u0026#34;: \u0026#34; + error.getMessage()); }); èƒŒå£“ï¼ˆBackpressureï¼‰è™•ç† èƒŒå£“æ˜¯éŸ¿æ‡‰å¼ç¨‹å¼è¨­è¨ˆä¸­çš„é‡è¦æ¦‚å¿µï¼Œç”¨æ–¼è™•ç†ç”Ÿç”¢è€…é€Ÿåº¦è¶…éæ¶ˆè²»è€…è™•ç†èƒ½åŠ›çš„æƒ…æ³ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // èƒŒå£“ç­–ç•¥ç¤ºä¾‹ Flux\u0026lt;Integer\u0026gt; fastProducer = Flux.range(1, 1000) .delayElements(Duration.ofMillis(1)); // æ¶ˆè²»è€…è™•ç†è¼ƒæ…¢ fastProducer .onBackpressureBuffer(10) // ç·©è¡å€å¤§å°ç‚º 10 .subscribe(new BaseSubscriber\u0026lt;Integer\u0026gt;() { @Override protected void hookOnSubscribe(Subscription subscription) { request(1); } @Override protected void hookOnNext(Integer value) { try { Thread.sleep(100); // æ¨¡æ“¬æ…¢è™•ç† System.out.println(\u0026#34;Processed: \u0026#34; + value); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } request(1); } }); // å…¶ä»–èƒŒå£“ç­–ç•¥ Flux\u0026lt;Integer\u0026gt; dropped = fastProducer.onBackpressureDrop(); Flux\u0026lt;Integer\u0026gt; latest = fastProducer.onBackpressureLatest(); Flux\u0026lt;Integer\u0026gt; error = fastProducer.onBackpressureError(); æ’ç¨‹å™¨ï¼ˆSchedulerï¼‰ Reactor æä¾›å¤šç¨®æ’ç¨‹å™¨ä¾†æ§åˆ¶åŸ·è¡Œä¸Šä¸‹æ–‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // ä¸åŒé¡å‹çš„æ’ç¨‹å™¨ Scheduler single = Schedulers.single(); // å–®åŸ·è¡Œç·’ Scheduler parallel = Schedulers.parallel(); // ä¸¦è¡Œè™•ç†ï¼ˆCPU å¯†é›†ï¼‰ Scheduler boundedElastic = Schedulers.boundedElastic(); // å½ˆæ€§åŸ·è¡Œç·’æ± ï¼ˆI/O å¯†é›†ï¼‰ Scheduler immediate = Schedulers.immediate(); // ç•¶å‰åŸ·è¡Œç·’ // ä½¿ç”¨æ’ç¨‹å™¨ Flux\u0026lt;String\u0026gt; source = Flux.just(\u0026#34;A\u0026#34;, \u0026#34;B\u0026#34;, \u0026#34;C\u0026#34;); // åœ¨æŒ‡å®šæ’ç¨‹å™¨ä¸Šç™¼å¸ƒ Flux\u0026lt;String\u0026gt; published = source.publishOn(Schedulers.parallel()); // åœ¨æŒ‡å®šæ’ç¨‹å™¨ä¸Šè¨‚é–± Flux\u0026lt;String\u0026gt; subscribed = source.subscribeOn(Schedulers.boundedElastic()); // çµ„åˆä½¿ç”¨ source .subscribeOn(Schedulers.boundedElastic()) // è¨‚é–±åœ¨å½ˆæ€§åŸ·è¡Œç·’æ±  .map(s -\u0026gt; s.toLowerCase()) // è½‰æ›æ“ä½œ .publishOn(Schedulers.parallel()) // å¾ŒçºŒæ“ä½œåœ¨ä¸¦è¡Œæ’ç¨‹å™¨ .map(s -\u0026gt; s.toUpperCase()) .subscribe(System.out::println); Spring WebFlux å¯¦æˆ° ä¾è³´é…ç½® 1 2 3 4 5 6 7 8 9 10 \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-webflux\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-r2dbc\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; éŸ¿æ‡‰å¼ REST Controller 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 @RestController @RequestMapping(\u0026#34;/api/users\u0026#34;) public class UserController { private final UserService userService; public UserController(UserService userService) { this.userService = userService; } @GetMapping public Flux\u0026lt;User\u0026gt; getAllUsers() { return userService.findAll(); } @GetMapping(\u0026#34;/{id}\u0026#34;) public Mono\u0026lt;ResponseEntity\u0026lt;User\u0026gt;\u0026gt; getUserById(@PathVariable String id) { return userService.findById(id) .map(user -\u0026gt; ResponseEntity.ok(user)) .defaultIfEmpty(ResponseEntity.notFound().build()); } @PostMapping public Mono\u0026lt;User\u0026gt; createUser(@RequestBody User user) { return userService.save(user); } @PutMapping(\u0026#34;/{id}\u0026#34;) public Mono\u0026lt;ResponseEntity\u0026lt;User\u0026gt;\u0026gt; updateUser(@PathVariable String id, @RequestBody User user) { return userService.update(id, user) .map(updatedUser -\u0026gt; ResponseEntity.ok(updatedUser)) .defaultIfEmpty(ResponseEntity.notFound().build()); } @DeleteMapping(\u0026#34;/{id}\u0026#34;) public Mono\u0026lt;ResponseEntity\u0026lt;Void\u0026gt;\u0026gt; deleteUser(@PathVariable String id) { return userService.deleteById(id) .then(Mono.just(ResponseEntity.noContent().\u0026lt;Void\u0026gt;build())) .defaultIfEmpty(ResponseEntity.notFound().build()); } // ä¸²æµç«¯é» @GetMapping(value = \u0026#34;/stream\u0026#34;, produces = MediaType.TEXT_EVENT_STREAM_VALUE) public Flux\u0026lt;User\u0026gt; getUserStream() { return userService.findAll() .delayElements(Duration.ofSeconds(1)); // æ¯ç§’ç™¼é€ä¸€å€‹ç”¨æˆ¶ } } éŸ¿æ‡‰å¼ Service å±¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 @Service public class UserService { private final UserRepository userRepository; private final WebClient webClient; public UserService(UserRepository userRepository, WebClient.Builder webClientBuilder) { this.userRepository = userRepository; this.webClient = webClientBuilder.baseUrl(\u0026#34;https://api.external.com\u0026#34;).build(); } public Flux\u0026lt;User\u0026gt; findAll() { return userRepository.findAll(); } public Mono\u0026lt;User\u0026gt; findById(String id) { return userRepository.findById(id); } public Mono\u0026lt;User\u0026gt; save(User user) { return userRepository.save(user); } public Mono\u0026lt;User\u0026gt; update(String id, User user) { return userRepository.findById(id) .flatMap(existingUser -\u0026gt; { existingUser.setName(user.getName()); existingUser.setEmail(user.getEmail()); return userRepository.save(existingUser); }); } public Mono\u0026lt;Void\u0026gt; deleteById(String id) { return userRepository.deleteById(id); } // çµ„åˆå¤šå€‹éåŒæ­¥æ“ä½œ public Mono\u0026lt;UserProfile\u0026gt; getUserProfile(String userId) { Mono\u0026lt;User\u0026gt; userMono = findById(userId); Mono\u0026lt;List\u0026lt;Order\u0026gt;\u0026gt; ordersMono = getOrdersByUserId(userId); Mono\u0026lt;UserPreferences\u0026gt; preferencesMono = getUserPreferences(userId); return Mono.zip(userMono, ordersMono, preferencesMono) .map(tuple -\u0026gt; new UserProfile( tuple.getT1(), // User tuple.getT2(), // Orders tuple.getT3() // Preferences )); } // å¤–éƒ¨ API å‘¼å« private Mono\u0026lt;List\u0026lt;Order\u0026gt;\u0026gt; getOrdersByUserId(String userId) { return webClient.get() .uri(\u0026#34;/orders?userId={userId}\u0026#34;, userId) .retrieve() .bodyToFlux(Order.class) .collectList() .timeout(Duration.ofSeconds(5)) // 5 ç§’é€¾æ™‚ .onErrorReturn(Collections.emptyList()); // éŒ¯èª¤æ™‚è¿”å›ç©ºåˆ—è¡¨ } private Mono\u0026lt;UserPreferences\u0026gt; getUserPreferences(String userId) { return webClient.get() .uri(\u0026#34;/preferences/{userId}\u0026#34;, userId) .retrieve() .bodyToMono(UserPreferences.class) .onErrorReturn(new UserPreferences()); // é è¨­åå¥½è¨­å®š } } éŸ¿æ‡‰å¼è³‡æ–™åº«å­˜å– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // R2DBC Repository @Repository public interface UserRepository extends ReactiveCrudRepository\u0026lt;User, String\u0026gt; { Flux\u0026lt;User\u0026gt; findByNameContaining(String name); Flux\u0026lt;User\u0026gt; findByEmailDomain(String domain); @Query(\u0026#34;SELECT * FROM users WHERE created_at \u0026gt; :date\u0026#34;) Flux\u0026lt;User\u0026gt; findUsersCreatedAfter(LocalDateTime date); @Modifying @Query(\u0026#34;UPDATE users SET last_login = :loginTime WHERE id = :userId\u0026#34;) Mono\u0026lt;Integer\u0026gt; updateLastLogin(String userId, LocalDateTime loginTime); } // è‡ªè¨‚ Repository å¯¦ä½œ @Component public class CustomUserRepository { private final DatabaseClient databaseClient; public CustomUserRepository(DatabaseClient databaseClient) { this.databaseClient = databaseClient; } public Flux\u0026lt;User\u0026gt; findUsersByComplexCriteria(UserSearchCriteria criteria) { return databaseClient.sql(\u0026#34;\u0026#34;\u0026#34; SELECT * FROM users WHERE (:name IS NULL OR name LIKE :name) AND (:email IS NULL OR email = :email) AND (:minAge IS NULL OR age \u0026gt;= :minAge) ORDER BY created_at DESC \u0026#34;\u0026#34;\u0026#34;) .bind(\u0026#34;name\u0026#34;, criteria.getName() != null ? \u0026#34;%\u0026#34; + criteria.getName() + \u0026#34;%\u0026#34; : null) .bind(\u0026#34;email\u0026#34;, criteria.getEmail()) .bind(\u0026#34;minAge\u0026#34;, criteria.getMinAge()) .map((row, metadata) -\u0026gt; User.builder() .id(row.get(\u0026#34;id\u0026#34;, String.class)) .name(row.get(\u0026#34;name\u0026#34;, String.class)) .email(row.get(\u0026#34;email\u0026#34;, String.class)) .age(row.get(\u0026#34;age\u0026#34;, Integer.class)) .createdAt(row.get(\u0026#34;created_at\u0026#34;, LocalDateTime.class)) .build()) .all(); } } WebClient ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 @Component public class ExternalApiClient { private final WebClient webClient; public ExternalApiClient(WebClient.Builder webClientBuilder) { this.webClient = webClientBuilder .baseUrl(\u0026#34;https://jsonplaceholder.typicode.com\u0026#34;) .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE) .build(); } // GET è«‹æ±‚ public Mono\u0026lt;Post\u0026gt; getPost(Long id) { return webClient.get() .uri(\u0026#34;/posts/{id}\u0026#34;, id) .retrieve() .onStatus(HttpStatus::is4xxClientError, response -\u0026gt; Mono.error(new NotFoundException(\u0026#34;Post not found\u0026#34;))) .onStatus(HttpStatus::is5xxServerError, response -\u0026gt; Mono.error(new ServiceException(\u0026#34;Server error\u0026#34;))) .bodyToMono(Post.class) .timeout(Duration.ofSeconds(10)) .retry(3); } // POST è«‹æ±‚ public Mono\u0026lt;Post\u0026gt; createPost(Post post) { return webClient.post() .uri(\u0026#34;/posts\u0026#34;) .bodyValue(post) .retrieve() .bodyToMono(Post.class); } // æ‰¹é‡è«‹æ±‚ public Flux\u0026lt;Post\u0026gt; getAllPosts() { return webClient.get() .uri(\u0026#34;/posts\u0026#34;) .retrieve() .bodyToFlux(Post.class) .onBackpressureBuffer(100); // ç·©è¡è™•ç† } // ä¸¦è¡Œè«‹æ±‚ public Mono\u0026lt;List\u0026lt;PostWithComments\u0026gt;\u0026gt; getPostsWithComments(List\u0026lt;Long\u0026gt; postIds) { return Flux.fromIterable(postIds) .flatMap(this::getPostWithComments, 5) // æœ€å¤š 5 å€‹ä¸¦è¡Œè«‹æ±‚ .collectList(); } private Mono\u0026lt;PostWithComments\u0026gt; getPostWithComments(Long postId) { Mono\u0026lt;Post\u0026gt; postMono = getPost(postId); Mono\u0026lt;List\u0026lt;Comment\u0026gt;\u0026gt; commentsMono = getCommentsByPostId(postId); return Mono.zip(postMono, commentsMono, PostWithComments::new); } private Mono\u0026lt;List\u0026lt;Comment\u0026gt;\u0026gt; getCommentsByPostId(Long postId) { return webClient.get() .uri(\u0026#34;/posts/{postId}/comments\u0026#34;, postId) .retrieve() .bodyToFlux(Comment.class) .collectList(); } } æ¸¬è©¦éŸ¿æ‡‰å¼ç¨‹å¼ç¢¼ æ¸¬è©¦é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 @ExtendWith(MockitoExtension.class) class UserServiceTest { @Mock private UserRepository userRepository; @Mock private WebClient webClient; @Mock private WebClient.RequestHeadersUriSpec requestHeadersUriSpec; @Mock private WebClient.ResponseSpec responseSpec; @InjectMocks private UserService userService; @Test void testFindById() { // Given String userId = \u0026#34;123\u0026#34;; User expectedUser = new User(userId, \u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;); when(userRepository.findById(userId)).thenReturn(Mono.just(expectedUser)); // When Mono\u0026lt;User\u0026gt; result = userService.findById(userId); // Then StepVerifier.create(result) .expectNext(expectedUser) .verifyComplete(); verify(userRepository).findById(userId); } @Test void testFindByIdNotFound() { // Given String userId = \u0026#34;999\u0026#34;; when(userRepository.findById(userId)).thenReturn(Mono.empty()); // When Mono\u0026lt;User\u0026gt; result = userService.findById(userId); // Then StepVerifier.create(result) .verifyComplete(); // æœŸæœ›ç©ºçµæœ } @Test void testGetAllUsers() { // Given List\u0026lt;User\u0026gt; users = Arrays.asList( new User(\u0026#34;1\u0026#34;, \u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;), new User(\u0026#34;2\u0026#34;, \u0026#34;Jane\u0026#34;, \u0026#34;jane@example.com\u0026#34;) ); when(userRepository.findAll()).thenReturn(Flux.fromIterable(users)); // When Flux\u0026lt;User\u0026gt; result = userService.findAll(); // Then StepVerifier.create(result) .expectNext(users.get(0)) .expectNext(users.get(1)) .verifyComplete(); } @Test void testSaveUser() { // Given User userToSave = new User(null, \u0026#34;New User\u0026#34;, \u0026#34;new@example.com\u0026#34;); User savedUser = new User(\u0026#34;123\u0026#34;, \u0026#34;New User\u0026#34;, \u0026#34;new@example.com\u0026#34;); when(userRepository.save(userToSave)).thenReturn(Mono.just(savedUser)); // When Mono\u0026lt;User\u0026gt; result = userService.save(userToSave); // Then StepVerifier.create(result) .expectNext(savedUser) .verifyComplete(); } @Test void testErrorHandling() { // Given String userId = \u0026#34;123\u0026#34;; when(userRepository.findById(userId)) .thenReturn(Mono.error(new RuntimeException(\u0026#34;Database error\u0026#34;))); // When Mono\u0026lt;User\u0026gt; result = userService.findById(userId); // Then StepVerifier.create(result) .expectError(RuntimeException.class) .verify(); } } æ•´åˆæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) class UserControllerIntegrationTest { @Autowired private WebTestClient webTestClient; @MockBean private UserService userService; @Test void testGetAllUsers() { // Given List\u0026lt;User\u0026gt; users = Arrays.asList( new User(\u0026#34;1\u0026#34;, \u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;), new User(\u0026#34;2\u0026#34;, \u0026#34;Jane\u0026#34;, \u0026#34;jane@example.com\u0026#34;) ); when(userService.findAll()).thenReturn(Flux.fromIterable(users)); // When \u0026amp; Then webTestClient.get() .uri(\u0026#34;/api/users\u0026#34;) .exchange() .expectStatus().isOk() .expectBodyList(User.class) .hasSize(2) .contains(users.toArray(new User[0])); } @Test void testGetUserById() { // Given String userId = \u0026#34;123\u0026#34;; User user = new User(userId, \u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;); when(userService.findById(userId)).thenReturn(Mono.just(user)); // When \u0026amp; Then webTestClient.get() .uri(\u0026#34;/api/users/{id}\u0026#34;, userId) .exchange() .expectStatus().isOk() .expectBody(User.class) .isEqualTo(user); } @Test void testGetUserByIdNotFound() { // Given String userId = \u0026#34;999\u0026#34;; when(userService.findById(userId)).thenReturn(Mono.empty()); // When \u0026amp; Then webTestClient.get() .uri(\u0026#34;/api/users/{id}\u0026#34;, userId) .exchange() .expectStatus().isNotFound(); } @Test void testCreateUser() { // Given User userToCreate = new User(null, \u0026#34;New User\u0026#34;, \u0026#34;new@example.com\u0026#34;); User createdUser = new User(\u0026#34;123\u0026#34;, \u0026#34;New User\u0026#34;, \u0026#34;new@example.com\u0026#34;); when(userService.save(any(User.class))).thenReturn(Mono.just(createdUser)); // When \u0026amp; Then webTestClient.post() .uri(\u0026#34;/api/users\u0026#34;) .bodyValue(userToCreate) .exchange() .expectStatus().isOk() .expectBody(User.class) .isEqualTo(createdUser); } } æ•ˆèƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. é©ç•¶çš„èƒŒå£“ç­–ç•¥ 1 2 3 4 5 6 7 8 9 // æ ¹æ“šæƒ…æ³é¸æ“‡åˆé©çš„èƒŒå£“ç­–ç•¥ public Flux\u0026lt;ProcessedData\u0026gt; processLargeDataset(Flux\u0026lt;RawData\u0026gt; input) { return input .onBackpressureBuffer(1000) // é©åº¦ç·©è¡ .flatMap(this::processData, 10) // é™åˆ¶ä¸¦è¡Œåº¦ .onErrorContinue((error, item) -\u0026gt; { log.warn(\u0026#34;è™•ç†é …ç›® {} æ™‚ç™¼ç”ŸéŒ¯èª¤: {}\u0026#34;, item, error.getMessage()); }); } 2. åˆç†ä½¿ç”¨æ’ç¨‹å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Service public class OptimizedService { // CPU å¯†é›†å‹æ“ä½œä½¿ç”¨ parallel() public Mono\u0026lt;String\u0026gt; cpuIntensiveTask(String input) { return Mono.fromCallable(() -\u0026gt; { // è¤‡é›œè¨ˆç®— return performComplexCalculation(input); }).subscribeOn(Schedulers.parallel()); } // I/O æ“ä½œä½¿ç”¨ boundedElastic() public Mono\u0026lt;String\u0026gt; ioTask(String filename) { return Mono.fromCallable(() -\u0026gt; { // æª”æ¡ˆè®€å– return readFromFile(filename); }).subscribeOn(Schedulers.boundedElastic()); } } 3. è³‡æºç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // ä½¿ç”¨ using() ç¢ºä¿è³‡æºæ­£ç¢ºé‡‹æ”¾ public Mono\u0026lt;String\u0026gt; processFileWithProperCleanup(String filename) { return Mono.using( () -\u0026gt; Files.newBufferedReader(Paths.get(filename)), // è³‡æºä¾›æ‡‰å•† reader -\u0026gt; Mono.fromCallable(() -\u0026gt; { // ä½¿ç”¨è³‡æº return reader.lines().collect(Collectors.joining(\u0026#34;\\n\u0026#34;)); }).subscribeOn(Schedulers.boundedElastic()), reader -\u0026gt; { // æ¸…ç†è³‡æº try { reader.close(); } catch (IOException e) { log.warn(\u0026#34;é—œé–‰æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤\u0026#34;, e); } } ); } 4. å¿«å–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Service public class CachedUserService { private final Cache\u0026lt;String, User\u0026gt; userCache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(Duration.ofMinutes(10)) .build(); public Mono\u0026lt;User\u0026gt; getUserWithCache(String userId) { User cachedUser = userCache.getIfPresent(userId); if (cachedUser != null) { return Mono.just(cachedUser); } return userRepository.findById(userId) .doOnNext(user -\u0026gt; userCache.put(userId, user)) .cache(Duration.ofMinutes(5)); // Reactor å±¤ç´šå¿«å– } } ç›£æ§èˆ‡é™¤éŒ¯ 1. æ—¥èªŒè¨˜éŒ„ 1 2 3 4 5 6 7 8 public Flux\u0026lt;User\u0026gt; processUsers() { return userRepository.findAll() .doOnSubscribe(subscription -\u0026gt; log.info(\u0026#34;é–‹å§‹è™•ç†ç”¨æˆ¶\u0026#34;)) .doOnNext(user -\u0026gt; log.debug(\u0026#34;è™•ç†ç”¨æˆ¶: {}\u0026#34;, user.getId())) .doOnError(error -\u0026gt; log.error(\u0026#34;è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤\u0026#34;, error)) .doOnComplete(() -\u0026gt; log.info(\u0026#34;ç”¨æˆ¶è™•ç†å®Œæˆ\u0026#34;)) .doFinally(signalType -\u0026gt; log.info(\u0026#34;è™•ç†çµæŸï¼Œä¿¡è™Ÿé¡å‹: {}\u0026#34;, signalType)); } 2. åº¦é‡æ”¶é›† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 @Component public class MetricsService { private final MeterRegistry meterRegistry; private final Counter userProcessedCounter; private final Timer userProcessingTimer; public MetricsService(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.userProcessedCounter = Counter.builder(\u0026#34;users.processed\u0026#34;) .description(\u0026#34;è™•ç†çš„ç”¨æˆ¶æ•¸é‡\u0026#34;) .register(meterRegistry); this.userProcessingTimer = Timer.builder(\u0026#34;users.processing.time\u0026#34;) .description(\u0026#34;ç”¨æˆ¶è™•ç†æ™‚é–“\u0026#34;) .register(meterRegistry); } public Mono\u0026lt;User\u0026gt; processUserWithMetrics(User user) { return Mono.fromCallable(() -\u0026gt; { // è™•ç†é‚è¼¯ return processUser(user); }) .doOnNext(u -\u0026gt; userProcessedCounter.increment()) .doOnSuccess(u -\u0026gt; userProcessingTimer.recordCallable(() -\u0026gt; { // è¨ˆæ™‚é‚è¼¯ return u; })) .subscribeOn(Schedulers.boundedElastic()); } } ç¸½çµ Reactive Programming ç‚º Java é–‹ç™¼è€…æä¾›äº†è™•ç†éåŒæ­¥ã€éé˜»å¡ç¨‹å¼è¨­è¨ˆçš„å¼·å¤§å·¥å…·ã€‚é€é Project Reactor å’Œ Spring WebFluxï¼Œæˆ‘å€‘å¯ä»¥ï¼š\næ ¸å¿ƒå„ªå‹¢ é«˜æ•ˆèƒ½ï¼šéé˜»å¡ I/O æå‡ç³»çµ±ååé‡ å¯æ“´å±•æ€§ï¼šæ›´å¥½åœ°åˆ©ç”¨ç³»çµ±è³‡æº å½ˆæ€§ï¼šå…§å»ºéŒ¯èª¤è™•ç†å’Œæ¢å¾©æ©Ÿåˆ¶ çµ„åˆæ€§ï¼šè±å¯Œçš„æ“ä½œç¬¦æ”¯æ´è¤‡é›œçš„è³‡æ–™æµè™•ç† æœ€ä½³å¯¦è¸è¦é» é©ç•¶å ´æ™¯ï¼šI/O å¯†é›†å‹æ‡‰ç”¨ç¨‹å¼æœ€é©åˆ æ“ä½œç¬¦é¸æ“‡ï¼šç†è§£ä¸åŒæ“ä½œç¬¦çš„ç‰¹æ€§å’Œé©ç”¨å ´æ™¯ éŒ¯èª¤è™•ç†ï¼šè¨­è¨ˆå®Œå–„çš„éŒ¯èª¤è™•ç†ç­–ç•¥ æ¸¬è©¦ï¼šä½¿ç”¨ StepVerifier é€²è¡Œå®Œæ•´æ¸¬è©¦ ç›£æ§ï¼šå»ºç«‹é©ç•¶çš„æ—¥èªŒå’Œåº¦é‡æ©Ÿåˆ¶ éŸ¿æ‡‰å¼ç¨‹å¼è¨­è¨ˆé›–ç„¶å­¸ç¿’æ›²ç·šè¼ƒé™¡ï¼Œä½†æŒæ¡å¾Œèƒ½é¡¯è‘—æå‡æ‡‰ç”¨ç¨‹å¼çš„æ•ˆèƒ½å’Œå¯ç¶­è­·æ€§ï¼Œç‰¹åˆ¥é©åˆç¾ä»£å¾®æœå‹™æ¶æ§‹å’Œé›²ç«¯ç’°å¢ƒã€‚\nåƒè€ƒè³‡æ–™ Project Reactor å®˜æ–¹æ–‡æª” Spring WebFlux åƒè€ƒæŒ‡å— Reactive Streams è¦ç¯„ R2DBC éŸ¿æ‡‰å¼è³‡æ–™åº«å­˜å– Reactor 3 Reference Guide ","permalink":"https://xinqilin.github.io/post/backend/reactivejava/","tags":["Java","Spring","WebFlux","Reactor","Reactive","Async","Mono","Flux"],"title":"Reactive Programming å®Œæ•´æŒ‡å—ï¼šSpring WebFlux èˆ‡ Project Reactor"},{"content":"#721 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 Input: accounts = [ [\u0026#34;John\u0026#34;,\u0026#34;johnsmith@mail.com\u0026#34;,\u0026#34;john_newyork@mail.com\u0026#34;], [\u0026#34;John\u0026#34;,\u0026#34;johnsmith@mail.com\u0026#34;,\u0026#34;john00@mail.com\u0026#34;], [\u0026#34;Mary\u0026#34;,\u0026#34;mary@mail.com\u0026#34;], [\u0026#34;John\u0026#34;,\u0026#34;johnnybravo@mail.com\u0026#34;] ] Output: [ [\u0026#34;John\u0026#34;,\u0026#34;john00@mail.com\u0026#34;,\u0026#34;john_newyork@mail.com\u0026#34;,\u0026#34;johnsmith@mail.com\u0026#34;], [\u0026#34;Mary\u0026#34;,\u0026#34;mary@mail.com\u0026#34;], [\u0026#34;John\u0026#34;,\u0026#34;johnnybravo@mail.com\u0026#34;] ] Explanation: The first and second John\u0026#39;s are the same person as they have the common email \u0026#34;johnsmith@mail.com\u0026#34;. The third John and Mary are different people as none of their email addresses are used by other accounts. We could return these lists in any order, for example the answer [[\u0026#39;Mary\u0026#39;, \u0026#39;mary@mail.com\u0026#39;], [\u0026#39;John\u0026#39;, \u0026#39;johnnybravo@mail.com\u0026#39;], [\u0026#39;John\u0026#39;, \u0026#39;john00@mail.com\u0026#39;, \u0026#39;john_newyork@mail.com\u0026#39;, \u0026#39;johnsmith@mail.com\u0026#39;]] would still be accepted. Sol: Graph + DFS ref: click me!\n1 2 3 4 5 6 7 Use these edges to build some components. Common email addresses are like the intersections that connect each single component for each account. Because each component represents a merged account, do DFS search for each components and add into a list. Before add the name into this list, sort the emails. Then add name string into it. Examples: Assume we have three accounts, we connect them like this in order to use DFS. {Name, 1, 2, 3} =\u0026gt; Name -- 1 -- 2 -- 3 {Name, 2, 4, 5} =\u0026gt; Name -- 2 -- 4 -- 5 (The same graph node 2 appears) {Name, 6, 7, 8} =\u0026gt; Name -- 6 -- 7 -- 8 (Where numbers represent email addresses). 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 class Solution { public List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; accountsMerge(List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; accounts) { List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); if(accounts==null || accounts.size()==0) return result; Map\u0026lt;String, String\u0026gt; names = new HashMap\u0026lt;String, String\u0026gt;(); //email - username Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; map = new HashMap\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt;(); //email - neighbors Set\u0026lt;String\u0026gt; emails = new HashSet\u0026lt;String\u0026gt;(); for(List\u0026lt;String\u0026gt; list : accounts){ String name = list.get(0); for(int i=1; i\u0026lt;list.size(); i++){ String email = list.get(i); emails.add( email ); names.put( email, name ); map.putIfAbsent( email, new HashSet\u0026lt;String\u0026gt;() ); if(i==1) continue; //build the \u0026#34;edge\u0026#34; between two adjacent email-nodes map.get( list.get(i-1) ).add( email ); map.get( email ).add( list.get(i-1) ); } } Set\u0026lt;String\u0026gt; visited = new HashSet\u0026lt;String\u0026gt;(); for(String s : emails) if( !visited.contains(s) ){ visited.add(s); List\u0026lt;String\u0026gt; buffer = new ArrayList\u0026lt;String\u0026gt;(); buffer.add(s); helper(s, map, visited, buffer); Collections.sort(buffer); buffer.add(0, names.get(s)); result.add(buffer); } return result; } private void helper(String s, Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; map, Set\u0026lt;String\u0026gt; visited, List\u0026lt;String\u0026gt; buffer){ for(String node : map.get(s)) if( !visited.contains(node) ){ visited.add(node); buffer.add(node); helper(node, map, visited, buffer); } } } BFS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 public List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; accountsMerge(List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; accounts) { HashMap\u0026lt;String,String\u0026gt; emailName = new HashMap\u0026lt;\u0026gt;(); HashMap\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; graph = new HashMap\u0026lt;\u0026gt;(); for(List\u0026lt;String\u0026gt; account: accounts){ String name = account.get(0); graph.putIfAbsent(account.get(1), new LinkedList\u0026lt;\u0026gt;()); emailName.put(account.get(1), name); for(int i = 2; i \u0026lt; account.size(); i++){ emailName.put(account.get(i), name); graph.putIfAbsent(account.get(i), new LinkedList\u0026lt;\u0026gt;()); graph.get(account.get(i)).add(account.get(1)); graph.get(account.get(1)).add(account.get(i)); } } List\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; res = new LinkedList\u0026lt;\u0026gt;(); HashSet\u0026lt;String\u0026gt; visited = new HashSet\u0026lt;\u0026gt;(); for(String email: graph.keySet()){ if(visited.contains(email)) continue; visited.add(email); String name = emailName.get(email); List\u0026lt;String\u0026gt; emails = new LinkedList\u0026lt;\u0026gt;(); Queue\u0026lt;String\u0026gt; queue = new LinkedList\u0026lt;\u0026gt;(); queue.offer(email); while(!queue.isEmpty()){ String cur = queue.poll(); emails.add(cur); for(String next: graph.get(cur)){ if(!visited.contains(next)){ queue.offer(next); visited.add(next); } } } Collections.sort(emails); emails.add(0,name); res.add(emails); } return res; } ","permalink":"https://xinqilin.github.io/post/algorithm/graphaccountmerge/","tags":["Algorithm"],"title":"GraphAccountMerge"},{"content":"æ¦‚è¿° äºŒå…ƒæ¨¹éæ­·æ˜¯è³‡æ–™çµæ§‹èˆ‡æ¼”ç®—æ³•ä¸­çš„åŸºæœ¬æ¦‚å¿µï¼Œä¸»è¦æœ‰ä¸‰ç¨®éæ­·æ–¹å¼ï¼šå‰åºéæ­·ï¼ˆPreOrderï¼‰ã€ä¸­åºéæ­·ï¼ˆInOrderï¼‰ã€å¾Œåºéæ­·ï¼ˆPostOrderï¼‰ã€‚æ¯ç¨®éæ­·æ–¹å¼éƒ½æœ‰å…¶ç‰¹å®šçš„æ‡‰ç”¨å ´æ™¯å’Œå„ªå‹¢ã€‚\nåŸºæœ¬æ¦‚å¿µ è€ƒæ…®ä»¥ä¸‹äºŒå…ƒæ¨¹çµæ§‹ï¼š\n1 2 3 4 5 4 / \\ 2 6 / \\ / \\ 1 3 5 7 ä¸‰ç¨®éæ­·æ–¹å¼çš„é †åº å‰åºéæ­·ï¼ˆPreOrderï¼‰ï¼šä¸­ â†’ å·¦ â†’ å³\néæ­·é †åºï¼š4 â†’ 2 â†’ 1 â†’ 3 â†’ 6 â†’ 5 â†’ 7 ä¸­åºéæ­·ï¼ˆInOrderï¼‰ï¼šå·¦ â†’ ä¸­ â†’ å³\néæ­·é †åºï¼š1 â†’ 2 â†’ 3 â†’ 4 â†’ 5 â†’ 6 â†’ 7 å°æ–¼äºŒå…ƒæœå°‹æ¨¹ï¼Œä¸­åºéæ­·å¯å¾—åˆ°æœ‰åºåºåˆ— å¾Œåºéæ­·ï¼ˆPostOrderï¼‰ï¼šå·¦ â†’ å³ â†’ ä¸­\néæ­·é †åºï¼š1 â†’ 3 â†’ 2 â†’ 5 â†’ 7 â†’ 6 â†’ 4 éæ­·å¯¦ä½œ 1. ä¸­åºéæ­·ï¼ˆInOrder Traversalï¼‰ ä¸­åºéæ­·åœ¨äºŒå…ƒæœå°‹æ¨¹ä¸­ç‰¹åˆ¥æœ‰ç”¨ï¼Œå› ç‚ºå®ƒæœƒæŒ‰å‡åºè¨ªå•æ‰€æœ‰ç¯€é»ã€‚\néæ­¸å¯¦ä½œ 1 2 3 4 5 6 7 public void inorderTraversal(TreeNode root) { if (root == null) return; inorderTraversal(root.left); // éæ­·å·¦å­æ¨¹ System.out.print(root.val + \u0026#34; \u0026#34;); // è™•ç†æ ¹ç¯€é» inorderTraversal(root.right); // éæ­·å³å­æ¨¹ } è¿­ä»£å¯¦ä½œï¼ˆä½¿ç”¨å †ç–Šï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public List\u0026lt;Integer\u0026gt; inorderTraversal(TreeNode root) { List\u0026lt;Integer\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); Stack\u0026lt;TreeNode\u0026gt; stack = new Stack\u0026lt;\u0026gt;(); TreeNode current = root; while (current != null || !stack.isEmpty()) { // å°‡æ‰€æœ‰å·¦å­ç¯€é»æ¨å…¥å †ç–Š while (current != null) { stack.push(current); current = current.left; } // è™•ç†å †ç–Šé ‚éƒ¨ç¯€é» current = stack.pop(); result.add(current.val); // ç§»å‹•åˆ°å³å­æ¨¹ current = current.right; } return result; } 2. å‰åºéæ­·ï¼ˆPreOrder Traversalï¼‰ å‰åºéæ­·é©ç”¨æ–¼è¤‡è£½æ¨¹çµæ§‹æˆ–å»ºç«‹è¡¨é”å¼æ¨¹ç­‰å ´æ™¯ã€‚\néæ­¸å¯¦ä½œ 1 2 3 4 5 6 7 public void preorderTraversal(TreeNode root) { if (root == null) return; System.out.print(root.val + \u0026#34; \u0026#34;); // è™•ç†æ ¹ç¯€é» preorderTraversal(root.left); // éæ­·å·¦å­æ¨¹ preorderTraversal(root.right); // éæ­·å³å­æ¨¹ } è¿­ä»£å¯¦ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public List\u0026lt;Integer\u0026gt; preorderTraversal(TreeNode root) { List\u0026lt;Integer\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); if (root == null) return result; Stack\u0026lt;TreeNode\u0026gt; stack = new Stack\u0026lt;\u0026gt;(); stack.push(root); while (!stack.isEmpty()) { TreeNode current = stack.pop(); result.add(current.val); // æ³¨æ„ï¼šå…ˆæ¨å…¥å³å­ç¯€é»ï¼Œå†æ¨å…¥å·¦å­ç¯€é» // é€™æ¨£ç¢ºä¿å·¦å­ç¯€é»å…ˆè¢«è™•ç† if (current.right != null) { stack.push(current.right); } if (current.left != null) { stack.push(current.left); } } return result; } 3. å¾Œåºéæ­·ï¼ˆPostOrder Traversalï¼‰ å¾Œåºéæ­·é©ç”¨æ–¼è¨ˆç®—æ¨¹çš„å¤§å°ã€åˆªé™¤ç¯€é»æˆ–è¨ˆç®—è¡¨é”å¼å€¼ç­‰å ´æ™¯ã€‚\néæ­¸å¯¦ä½œ 1 2 3 4 5 6 7 public void postorderTraversal(TreeNode root) { if (root == null) return; postorderTraversal(root.left); // éæ­·å·¦å­æ¨¹ postorderTraversal(root.right); // éæ­·å³å­æ¨¹ System.out.print(root.val + \u0026#34; \u0026#34;); // è™•ç†æ ¹ç¯€é» } è¿­ä»£å¯¦ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public List\u0026lt;Integer\u0026gt; postorderTraversal(TreeNode root) { List\u0026lt;Integer\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); if (root == null) return result; Stack\u0026lt;TreeNode\u0026gt; stack = new Stack\u0026lt;\u0026gt;(); TreeNode lastVisited = null; TreeNode current = root; while (current != null || !stack.isEmpty()) { if (current != null) { stack.push(current); current = current.left; } else { TreeNode peekNode = stack.peek(); // å¦‚æœå³å­ç¯€é»å­˜åœ¨ä¸”æœªè¢«è¨ªå•é if (peekNode.right != null \u0026amp;\u0026amp; lastVisited != peekNode.right) { current = peekNode.right; } else { result.add(peekNode.val); lastVisited = stack.pop(); } } } return result; } å¯¦éš›æ‡‰ç”¨ï¼šå¾éæ­·åºåˆ—é‡å»ºäºŒå…ƒæ¨¹ 1. å¾ä¸­åºèˆ‡å¾Œåºéæ­·é‡å»ºäºŒå…ƒæ¨¹ LeetCode 106. Construct Binary Tree from Inorder and Postorder Traversal\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 public class Solution { public TreeNode buildTree(int[] inorder, int[] postorder) { if (inorder == null || inorder.length == 0 || postorder == null || postorder.length == 0) { return null; } return helper(postorder, postorder.length - 1, inorder, 0, inorder.length - 1); } private TreeNode helper(int[] postorder, int postIndex, int[] inorder, int inStart, int inEnd) { if (inStart \u0026gt; inEnd || postIndex \u0026lt; 0) { return null; } // å¾Œåºéæ­·çš„æœ€å¾Œä¸€å€‹å…ƒç´ æ˜¯æ ¹ç¯€é» TreeNode root = new TreeNode(postorder[postIndex]); // åœ¨ä¸­åºéæ­·ä¸­æ‰¾åˆ°æ ¹ç¯€é»çš„ä½ç½® int rootIndex = 0; for (int i = inStart; i \u0026lt;= inEnd; i++) { if (inorder[i] == root.val) { rootIndex = i; break; } } // éæ­¸å»ºæ§‹å·¦å³å­æ¨¹ // æ³¨æ„ï¼šå…ˆå»ºæ§‹å³å­æ¨¹ï¼Œå› ç‚ºå¾Œåºéæ­·æ˜¯å·¦-å³-æ ¹ root.right = helper(postorder, postIndex - 1, inorder, rootIndex + 1, inEnd); root.left = helper(postorder, postIndex - (inEnd - rootIndex + 1), inorder, inStart, rootIndex - 1); return root; } } 2. å¾å‰åºèˆ‡ä¸­åºéæ­·é‡å»ºäºŒå…ƒæ¨¹ LeetCode 105. Construct Binary Tree from Preorder and Inorder Traversal\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public class Solution { public TreeNode buildTree(int[] preorder, int[] inorder) { return helper(preorder, inorder, 0, 0, inorder.length - 1); } private TreeNode helper(int[] preorder, int[] inorder, int preStart, int inStart, int inEnd) { if (preStart \u0026gt; preorder.length - 1 || inStart \u0026gt; inEnd) { return null; } // å‰åºéæ­·çš„ç¬¬ä¸€å€‹å…ƒç´ æ˜¯æ ¹ç¯€é» TreeNode root = new TreeNode(preorder[preStart]); // åœ¨ä¸­åºéæ­·ä¸­æ‰¾åˆ°æ ¹ç¯€é»çš„ä½ç½® int rootIndex = 0; for (int i = inStart; i \u0026lt;= inEnd; i++) { if (inorder[i] == preorder[preStart]) { rootIndex = i; break; } } // éæ­¸å»ºæ§‹å·¦å³å­æ¨¹ root.left = helper(preorder, inorder, preStart + 1, inStart, rootIndex - 1); root.right = helper(preorder, inorder, preStart + rootIndex - inStart + 1, rootIndex + 1, inEnd); return root; } } æ™‚é–“èˆ‡ç©ºé–“è¤‡é›œåº¦ éæ­·æ–¹å¼ æ™‚é–“è¤‡é›œåº¦ ç©ºé–“è¤‡é›œåº¦ï¼ˆéæ­¸ï¼‰ ç©ºé–“è¤‡é›œåº¦ï¼ˆè¿­ä»£ï¼‰ å‰åºéæ­· O(n) O(h) O(h) ä¸­åºéæ­· O(n) O(h) O(h) å¾Œåºéæ­· O(n) O(h) O(h) å…¶ä¸­ n æ˜¯ç¯€é»æ•¸é‡ï¼Œh æ˜¯æ¨¹çš„é«˜åº¦ï¼ˆæœ€å£æƒ…æ³ä¸‹ h = nï¼Œæœ€ä½³æƒ…æ³ä¸‹ h = log nï¼‰ã€‚\næ‡‰ç”¨å ´æ™¯ç¸½çµ å‰åºéæ­·ï¼šè¤‡è£½æ¨¹ã€åºåˆ—åŒ–æ¨¹çµæ§‹ã€å»ºç«‹è¡¨é”å¼æ¨¹ ä¸­åºéæ­·ï¼šäºŒå…ƒæœå°‹æ¨¹çš„æœ‰åºè¼¸å‡ºã€é©—è­‰äºŒå…ƒæœå°‹æ¨¹ å¾Œåºéæ­·ï¼šè¨ˆç®—æ¨¹çš„å¤§å°ã€åˆªé™¤æ¨¹ã€è¨ˆç®—è¡¨é”å¼å€¼ã€é‡‹æ”¾è¨˜æ†¶é«” åƒè€ƒè³‡æ–™ LeetCode 94. Binary Tree Inorder Traversal LeetCode 144. Binary Tree Preorder Traversal LeetCode 145. Binary Tree Postorder Traversal æ¼”ç®—æ³•å°è«– - äºŒå…ƒæ¨¹çš„åŸºæœ¬æ“ä½œ ","permalink":"https://xinqilin.github.io/post/algorithm/treetraversal/","tags":["Algorithm","Tree","éæ­¸","Java"],"title":"äºŒå…ƒæ¨¹éæ­·ï¼ˆBinary Tree Traversalï¼‰å®Œæ•´æŒ‡å—"},{"content":"Java TreeMap å®Œæ•´å¯¦ä½œæŒ‡å— ç°¡ä»‹ TreeMap æ˜¯ Java é›†åˆæ¡†æ¶ä¸­å¯¦ç¾æœ‰åºæ˜ å°„çš„æ ¸å¿ƒé¡åˆ¥ï¼ŒåŸºæ–¼ç´…é»‘æ¨¹ï¼ˆRed-Black Treeï¼‰æ•¸æ“šçµæ§‹å¯¦ç¾ã€‚å®ƒæä¾›äº† O(log n) çš„æ™‚é–“è¤‡é›œåº¦é€²è¡Œæœç´¢ã€æ’å…¥å’Œåˆªé™¤æ“ä½œï¼Œä¸¦ä¿è­‰éµçš„æœ‰åºæ€§ã€‚æœ¬æ–‡å°‡æ·±å…¥æ¢è¨ TreeMap çš„å…§éƒ¨å¯¦ç¾ã€å„ç¨®æ–¹æ³•ä½¿ç”¨ã€æ•ˆèƒ½ç‰¹æ€§ä»¥åŠåœ¨ä¼æ¥­ç´šé–‹ç™¼ä¸­çš„æœ€ä½³å¯¦è¸ã€‚\nTreeMap æ¶æ§‹èˆ‡ç¹¼æ‰¿é—œä¿‚ é¡åˆ¥ç¹¼æ‰¿çµæ§‹ 1 2 3 4 5 6 7 Map\u0026lt;K,V\u0026gt; â†‘ SortedMap\u0026lt;K,V\u0026gt; â†‘ NavigableMap\u0026lt;K,V\u0026gt; â†‘ TreeMap\u0026lt;K,V\u0026gt; æ ¸å¿ƒä»‹é¢é—œä¿‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // åŸºæœ¬æ˜ å°„ä»‹é¢ public interface Map\u0026lt;K,V\u0026gt; { V put(K key, V value); V get(Object key); V remove(Object key); boolean containsKey(Object key); Set\u0026lt;K\u0026gt; keySet(); Collection\u0026lt;V\u0026gt; values(); Set\u0026lt;Map.Entry\u0026lt;K, V\u0026gt;\u0026gt; entrySet(); } // æœ‰åºæ˜ å°„ä»‹é¢ public interface SortedMap\u0026lt;K,V\u0026gt; extends Map\u0026lt;K,V\u0026gt; { Comparator\u0026lt;? super K\u0026gt; comparator(); SortedMap\u0026lt;K,V\u0026gt; subMap(K fromKey, K toKey); SortedMap\u0026lt;K,V\u0026gt; headMap(K toKey); SortedMap\u0026lt;K,V\u0026gt; tailMap(K fromKey); K firstKey(); K lastKey(); } // å¯å°èˆªæ˜ å°„ä»‹é¢ public interface NavigableMap\u0026lt;K,V\u0026gt; extends SortedMap\u0026lt;K,V\u0026gt; { Map.Entry\u0026lt;K,V\u0026gt; lowerEntry(K key); K lowerKey(K key); Map.Entry\u0026lt;K,V\u0026gt; floorEntry(K key); K floorKey(K key); Map.Entry\u0026lt;K,V\u0026gt; ceilingEntry(K key); K ceilingKey(K key); Map.Entry\u0026lt;K,V\u0026gt; higherEntry(K key); K higherKey(K key); Map.Entry\u0026lt;K,V\u0026gt; firstEntry(); Map.Entry\u0026lt;K,V\u0026gt; lastEntry(); Map.Entry\u0026lt;K,V\u0026gt; pollFirstEntry(); Map.Entry\u0026lt;K,V\u0026gt; pollLastEntry(); NavigableMap\u0026lt;K,V\u0026gt; descendingMap(); NavigableSet\u0026lt;K\u0026gt; navigableKeySet(); NavigableSet\u0026lt;K\u0026gt; descendingKeySet(); } TreeMap æ ¸å¿ƒç‰¹æ€§ 1. ç´…é»‘æ¨¹å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // TreeMap å…§éƒ¨ç¯€é»çµæ§‹ static final class Entry\u0026lt;K,V\u0026gt; implements Map.Entry\u0026lt;K,V\u0026gt; { K key; V value; Entry\u0026lt;K,V\u0026gt; left; Entry\u0026lt;K,V\u0026gt; right; Entry\u0026lt;K,V\u0026gt; parent; boolean color = BLACK; Entry(K key, V value, Entry\u0026lt;K,V\u0026gt; parent) { this.key = key; this.value = value; this.parent = parent; } } // ç´…é»‘æ¨¹é¡è‰²å¸¸é‡ private static final boolean RED = false; private static final boolean BLACK = true; // æ ¹ç¯€é»å’Œå¤§å° private transient Entry\u0026lt;K,V\u0026gt; root; private transient int size = 0; private transient int modCount = 0; // æ¯”è¼ƒå™¨ private final Comparator\u0026lt;? super K\u0026gt; comparator; 2. è‡ªç„¶æ’åºèˆ‡è‡ªå®šç¾©æ¯”è¼ƒå™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // è‡ªç„¶æ’åº TreeMap TreeMap\u0026lt;String, Integer\u0026gt; naturalOrder = new TreeMap\u0026lt;\u0026gt;(); naturalOrder.put(\u0026#34;Charlie\u0026#34;, 3); naturalOrder.put(\u0026#34;Alice\u0026#34;, 1); naturalOrder.put(\u0026#34;Bob\u0026#34;, 2); // çµæœï¼š{Alice=1, Bob=2, Charlie=3} // è‡ªå®šç¾©æ¯”è¼ƒå™¨ TreeMap\u0026lt;String, Integer\u0026gt; customOrder = new TreeMap\u0026lt;\u0026gt;( (s1, s2) -\u0026gt; s2.compareTo(s1) // é™åº ); customOrder.put(\u0026#34;Charlie\u0026#34;, 3); customOrder.put(\u0026#34;Alice\u0026#34;, 1); customOrder.put(\u0026#34;Bob\u0026#34;, 2); // çµæœï¼š{Charlie=3, Bob=2, Alice=1} // è¤‡é›œå°è±¡æ¯”è¼ƒå™¨ TreeMap\u0026lt;Student, String\u0026gt; studentMap = new TreeMap\u0026lt;\u0026gt;( Comparator.comparing(Student::getGrade) .thenComparing(Student::getName) ); SortedMap ä»‹é¢è©³è§£ åŸºæœ¬æ–¹æ³•å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 public class TreeMapSortedExample { public static void main(String[] args) { TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(); // æ·»åŠ å…ƒç´  treeMap.put(5, \u0026#34;Five\u0026#34;); treeMap.put(2, \u0026#34;Two\u0026#34;); treeMap.put(8, \u0026#34;Eight\u0026#34;); treeMap.put(1, \u0026#34;One\u0026#34;); treeMap.put(9, \u0026#34;Nine\u0026#34;); // åŸºæœ¬æ’åºæ–¹æ³• demonstrateSortedMapMethods(treeMap); } private static void demonstrateSortedMapMethods(TreeMap\u0026lt;Integer, String\u0026gt; map) { System.out.println(\u0026#34;Original map: \u0026#34; + map); // ç²å–æ¯”è¼ƒå™¨ Comparator\u0026lt;? super Integer\u0026gt; comparator = map.comparator(); System.out.println(\u0026#34;Comparator: \u0026#34; + comparator); // null (natural ordering) // ç¬¬ä¸€å€‹å’Œæœ€å¾Œä¸€å€‹éµ System.out.println(\u0026#34;First key: \u0026#34; + map.firstKey()); // 1 System.out.println(\u0026#34;Last key: \u0026#34; + map.lastKey()); // 9 // å­æ˜ å°„ï¼ˆå«é ­ä¸å«å°¾ï¼‰ SortedMap\u0026lt;Integer, String\u0026gt; subMap = map.subMap(2, 8); System.out.println(\u0026#34;SubMap [2, 8): \u0026#34; + subMap); // {2=Two, 5=Five} // é ­éƒ¨æ˜ å°„ï¼ˆä¸åŒ…å«æŒ‡å®šéµï¼‰ SortedMap\u0026lt;Integer, String\u0026gt; headMap = map.headMap(5); System.out.println(\u0026#34;HeadMap (\u0026lt; 5): \u0026#34; + headMap); // {1=One, 2=Two} // å°¾éƒ¨æ˜ å°„ï¼ˆåŒ…å«æŒ‡å®šéµï¼‰ SortedMap\u0026lt;Integer, String\u0026gt; tailMap = map.tailMap(5); System.out.println(\u0026#34;TailMap (\u0026gt;= 5): \u0026#34; + tailMap); // {5=Five, 8=Eight, 9=Nine} // éµé›†åˆã€å€¼é›†åˆã€æ¢ç›®é›†åˆ System.out.println(\u0026#34;Keys: \u0026#34; + map.keySet()); System.out.println(\u0026#34;Values: \u0026#34; + map.values()); System.out.println(\u0026#34;Entries: \u0026#34; + map.entrySet()); } } NavigableMap ä»‹é¢è©³è§£ å°èˆªæ–¹æ³•å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 public class TreeMapNavigableExample { public static void main(String[] args) { TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(); // æ·»åŠ æ¸¬è©¦æ•¸æ“š treeMap.put(1, \u0026#34;One\u0026#34;); treeMap.put(3, \u0026#34;Three\u0026#34;); treeMap.put(5, \u0026#34;Five\u0026#34;); treeMap.put(7, \u0026#34;Seven\u0026#34;); treeMap.put(9, \u0026#34;Nine\u0026#34;); demonstrateNavigableMethods(treeMap); } private static void demonstrateNavigableMethods(TreeMap\u0026lt;Integer, String\u0026gt; map) { System.out.println(\u0026#34;Original map: \u0026#34; + map); // Lower æ–¹æ³•ï¼šè¿”å›åš´æ ¼å°æ–¼æŒ‡å®šéµçš„æœ€å¤§éµ Map.Entry\u0026lt;Integer, String\u0026gt; lowerEntry = map.lowerEntry(5); System.out.println(\u0026#34;Lower entry (\u0026lt; 5): \u0026#34; + lowerEntry); // 3=Three Integer lowerKey = map.lowerKey(5); System.out.println(\u0026#34;Lower key (\u0026lt; 5): \u0026#34; + lowerKey); // 3 // Floor æ–¹æ³•ï¼šè¿”å›å°æ–¼æˆ–ç­‰æ–¼æŒ‡å®šéµçš„æœ€å¤§éµ Map.Entry\u0026lt;Integer, String\u0026gt; floorEntry = map.floorEntry(4); System.out.println(\u0026#34;Floor entry (\u0026lt;= 4): \u0026#34; + floorEntry); // 3=Three Map.Entry\u0026lt;Integer, String\u0026gt; floorEntry2 = map.floorEntry(5); System.out.println(\u0026#34;Floor entry (\u0026lt;= 5): \u0026#34; + floorEntry2); // 5=Five // Ceiling æ–¹æ³•ï¼šè¿”å›å¤§æ–¼æˆ–ç­‰æ–¼æŒ‡å®šéµçš„æœ€å°éµ Map.Entry\u0026lt;Integer, String\u0026gt; ceilingEntry = map.ceilingEntry(4); System.out.println(\u0026#34;Ceiling entry (\u0026gt;= 4): \u0026#34; + ceilingEntry); // 5=Five Map.Entry\u0026lt;Integer, String\u0026gt; ceilingEntry2 = map.ceilingEntry(5); System.out.println(\u0026#34;Ceiling entry (\u0026gt;= 5): \u0026#34; + ceilingEntry2); // 5=Five // Higher æ–¹æ³•ï¼šè¿”å›åš´æ ¼å¤§æ–¼æŒ‡å®šéµçš„æœ€å°éµ Map.Entry\u0026lt;Integer, String\u0026gt; higherEntry = map.higherEntry(5); System.out.println(\u0026#34;Higher entry (\u0026gt; 5): \u0026#34; + higherEntry); // 7=Seven // é¦–å°¾æ¢ç›® Map.Entry\u0026lt;Integer, String\u0026gt; firstEntry = map.firstEntry(); Map.Entry\u0026lt;Integer, String\u0026gt; lastEntry = map.lastEntry(); System.out.println(\u0026#34;First entry: \u0026#34; + firstEntry); // 1=One System.out.println(\u0026#34;Last entry: \u0026#34; + lastEntry); // 9=Nine // å½ˆå‡ºé¦–å°¾æ¢ç›®ï¼ˆæœƒåˆªé™¤å…ƒç´ ï¼‰ TreeMap\u0026lt;Integer, String\u0026gt; copyMap = new TreeMap\u0026lt;\u0026gt;(map); Map.Entry\u0026lt;Integer, String\u0026gt; pollFirst = copyMap.pollFirstEntry(); Map.Entry\u0026lt;Integer, String\u0026gt; pollLast = copyMap.pollLastEntry(); System.out.println(\u0026#34;Poll first: \u0026#34; + pollFirst); // 1=One System.out.println(\u0026#34;Poll last: \u0026#34; + pollLast); // 9=Nine System.out.println(\u0026#34;After polling: \u0026#34; + copyMap); // {3=Three, 5=Five, 7=Seven} // é™åºè¦–åœ– NavigableMap\u0026lt;Integer, String\u0026gt; descendingMap = map.descendingMap(); System.out.println(\u0026#34;Descending map: \u0026#34; + descendingMap); // å°èˆªéµé›†åˆ NavigableSet\u0026lt;Integer\u0026gt; navigableKeySet = map.navigableKeySet(); NavigableSet\u0026lt;Integer\u0026gt; descendingKeySet = map.descendingKeySet(); System.out.println(\u0026#34;Navigable key set: \u0026#34; + navigableKeySet); System.out.println(\u0026#34;Descending key set: \u0026#34; + descendingKeySet); // ç¯„åœè¦–åœ– NavigableMap\u0026lt;Integer, String\u0026gt; rangeMap = map.subMap(3, true, 7, false); System.out.println(\u0026#34;Range [3, 7): \u0026#34; + rangeMap); // {3=Three, 5=Five} NavigableMap\u0026lt;Integer, String\u0026gt; headMap = map.headMap(5, true); System.out.println(\u0026#34;Head map (\u0026lt;= 5): \u0026#34; + headMap); // {1=One, 3=Three, 5=Five} NavigableMap\u0026lt;Integer, String\u0026gt; tailMap = map.tailMap(5, false); System.out.println(\u0026#34;Tail map (\u0026gt; 5): \u0026#34; + tailMap); // {7=Seven, 9=Nine} } } ä¼æ¥­ç´šæ‡‰ç”¨å¯¦ä¾‹ 1. æ™‚é–“åºåˆ—æ•¸æ“šç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 public class TimeSeriesDataManager { private final TreeMap\u0026lt;LocalDateTime, Double\u0026gt; timeSeriesData; public TimeSeriesDataManager() { this.timeSeriesData = new TreeMap\u0026lt;\u0026gt;(); } // æ·»åŠ æ•¸æ“šé» public void addDataPoint(LocalDateTime timestamp, Double value) { timeSeriesData.put(timestamp, value); } // ç²å–æŒ‡å®šæ™‚é–“ç¯„åœçš„æ•¸æ“š public NavigableMap\u0026lt;LocalDateTime, Double\u0026gt; getDataInRange( LocalDateTime startTime, LocalDateTime endTime) { return timeSeriesData.subMap(startTime, true, endTime, true); } // ç²å–æœ€æ–°æ•¸æ“š public Map.Entry\u0026lt;LocalDateTime, Double\u0026gt; getLatestData() { return timeSeriesData.lastEntry(); } // ç²å–æŒ‡å®šæ™‚é–“ä¹‹å‰çš„æœ€æ–°æ•¸æ“š public Map.Entry\u0026lt;LocalDateTime, Double\u0026gt; getLatestDataBefore(LocalDateTime time) { return timeSeriesData.lowerEntry(time); } // ç²å–æŒ‡å®šæ™‚é–“ä¹‹å¾Œçš„æœ€æ—©æ•¸æ“š public Map.Entry\u0026lt;LocalDateTime, Double\u0026gt; getEarliestDataAfter(LocalDateTime time) { return timeSeriesData.higherEntry(time); } // è¨ˆç®—æ™‚é–“ç¯„åœå…§çš„å¹³å‡å€¼ public double getAverageInRange(LocalDateTime startTime, LocalDateTime endTime) { NavigableMap\u0026lt;LocalDateTime, Double\u0026gt; rangeData = getDataInRange(startTime, endTime); return rangeData.values().stream() .mapToDouble(Double::doubleValue) .average() .orElse(0.0); } // æ¸…ç†èˆŠæ•¸æ“š public void cleanupOldData(LocalDateTime cutoffTime) { timeSeriesData.headMap(cutoffTime, false).clear(); } // ç²å–æ•¸æ“šçµ±è¨ˆä¿¡æ¯ public DataStatistics getStatistics() { if (timeSeriesData.isEmpty()) { return new DataStatistics(); } DoubleSummaryStatistics stats = timeSeriesData.values().stream() .mapToDouble(Double::doubleValue) .summaryStatistics(); return new DataStatistics( timeSeriesData.firstKey(), timeSeriesData.lastKey(), stats.getCount(), stats.getMin(), stats.getMax(), stats.getAverage() ); } public static class DataStatistics { private final LocalDateTime earliestTime; private final LocalDateTime latestTime; private final long count; private final double min; private final double max; private final double average; public DataStatistics() { this(null, null, 0, 0, 0, 0); } public DataStatistics(LocalDateTime earliestTime, LocalDateTime latestTime, long count, double min, double max, double average) { this.earliestTime = earliestTime; this.latestTime = latestTime; this.count = count; this.min = min; this.max = max; this.average = average; } // Getters public LocalDateTime getEarliestTime() { return earliestTime; } public LocalDateTime getLatestTime() { return latestTime; } public long getCount() { return count; } public double getMin() { return min; } public double getMax() { return max; } public double getAverage() { return average; } } } 2. ç¯„åœæŸ¥è©¢ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 public class RangeQuerySystem\u0026lt;T extends Comparable\u0026lt;T\u0026gt;, V\u0026gt; { private final TreeMap\u0026lt;T, V\u0026gt; dataMap; private final ReentrantReadWriteLock lock; private final ReadLock readLock; private final WriteLock writeLock; public RangeQuerySystem() { this.dataMap = new TreeMap\u0026lt;\u0026gt;(); this.lock = new ReentrantReadWriteLock(); this.readLock = lock.readLock(); this.writeLock = lock.writeLock(); } // ç·šç¨‹å®‰å…¨çš„æ’å…¥æ“ä½œ public void put(T key, V value) { writeLock.lock(); try { dataMap.put(key, value); } finally { writeLock.unlock(); } } // ç·šç¨‹å®‰å…¨çš„ç²å–æ“ä½œ public V get(T key) { readLock.lock(); try { return dataMap.get(key); } finally { readLock.unlock(); } } // ç¯„åœæŸ¥è©¢ public List\u0026lt;Map.Entry\u0026lt;T, V\u0026gt;\u0026gt; rangeQuery(T start, T end) { readLock.lock(); try { return new ArrayList\u0026lt;\u0026gt;(dataMap.subMap(start, true, end, true).entrySet()); } finally { readLock.unlock(); } } // å‰ç¶´æŸ¥è©¢ public List\u0026lt;Map.Entry\u0026lt;T, V\u0026gt;\u0026gt; prefixQuery(T prefix) { readLock.lock(); try { NavigableMap\u0026lt;T, V\u0026gt; tailMap = dataMap.tailMap(prefix, true); List\u0026lt;Map.Entry\u0026lt;T, V\u0026gt;\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); for (Map.Entry\u0026lt;T, V\u0026gt; entry : tailMap.entrySet()) { if (entry.getKey().toString().startsWith(prefix.toString())) { result.add(entry); } else { break; } } return result; } finally { readLock.unlock(); } } // ç²å–æœ€æ¥è¿‘çš„å€¼ public Map.Entry\u0026lt;T, V\u0026gt; getClosest(T target) { readLock.lock(); try { Map.Entry\u0026lt;T, V\u0026gt; floor = dataMap.floorEntry(target); Map.Entry\u0026lt;T, V\u0026gt; ceiling = dataMap.ceilingEntry(target); if (floor == null) return ceiling; if (ceiling == null) return floor; // æ¯”è¼ƒè·é›¢ if (target.compareTo(floor.getKey()) \u0026lt;= ceiling.getKey().compareTo(target)) { return floor; } else { return ceiling; } } finally { readLock.unlock(); } } // æ‰¹é‡æ’å…¥ public void putAll(Map\u0026lt;T, V\u0026gt; map) { writeLock.lock(); try { dataMap.putAll(map); } finally { writeLock.unlock(); } } // æ¢ä»¶åˆªé™¤ public int removeIf(Predicate\u0026lt;Map.Entry\u0026lt;T, V\u0026gt;\u0026gt; condition) { writeLock.lock(); try { List\u0026lt;T\u0026gt; keysToRemove = dataMap.entrySet().stream() .filter(condition) .map(Map.Entry::getKey) .collect(Collectors.toList()); keysToRemove.forEach(dataMap::remove); return keysToRemove.size(); } finally { writeLock.unlock(); } } // ç²å–çµ±è¨ˆä¿¡æ¯ public RangeStatistics getStatistics() { readLock.lock(); try { return new RangeStatistics( dataMap.size(), dataMap.isEmpty() ? null : dataMap.firstKey(), dataMap.isEmpty() ? null : dataMap.lastKey() ); } finally { readLock.unlock(); } } public static class RangeStatistics { private final int size; private final Object minKey; private final Object maxKey; public RangeStatistics(int size, Object minKey, Object maxKey) { this.size = size; this.minKey = minKey; this.maxKey = maxKey; } // Getters public int getSize() { return size; } public Object getMinKey() { return minKey; } public Object getMaxKey() { return maxKey; } } } 3. å„ªå…ˆç´šä»»å‹™èª¿åº¦å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 public class PriorityTaskScheduler { private final TreeMap\u0026lt;Priority, Queue\u0026lt;Task\u0026gt;\u0026gt; taskQueues; private final ExecutorService executor; private final ScheduledExecutorService scheduler; private final AtomicBoolean running; public PriorityTaskScheduler(int threadPoolSize) { this.taskQueues = new TreeMap\u0026lt;\u0026gt;(); this.executor = Executors.newFixedThreadPool(threadPoolSize); this.scheduler = Executors.newScheduledThreadPool(2); this.running = new AtomicBoolean(true); // åˆå§‹åŒ–å„ªå…ˆç´šéšŠåˆ— for (Priority priority : Priority.values()) { taskQueues.put(priority, new ConcurrentLinkedQueue\u0026lt;\u0026gt;()); } // å•Ÿå‹•ä»»å‹™èª¿åº¦ startTaskScheduling(); } // æäº¤ä»»å‹™ public void submitTask(Task task) { if (!running.get()) { throw new IllegalStateException(\u0026#34;Scheduler is shutdown\u0026#34;); } taskQueues.get(task.getPriority()).offer(task); } // æäº¤å»¶é²ä»»å‹™ public void submitDelayedTask(Task task, long delay, TimeUnit unit) { scheduler.schedule(() -\u0026gt; submitTask(task), delay, unit); } // æäº¤é€±æœŸæ€§ä»»å‹™ public void submitPeriodicTask(Task task, long initialDelay, long period, TimeUnit unit) { scheduler.scheduleAtFixedRate(() -\u0026gt; { if (running.get()) { submitTask(task); } }, initialDelay, period, unit); } // å•Ÿå‹•ä»»å‹™èª¿åº¦ private void startTaskScheduling() { scheduler.scheduleAtFixedRate(this::processNextTask, 0, 10, TimeUnit.MILLISECONDS); } // è™•ç†ä¸‹ä¸€å€‹ä»»å‹™ private void processNextTask() { if (!running.get()) { return; } // å¾æœ€é«˜å„ªå…ˆç´šé–‹å§‹æŸ¥æ‰¾ä»»å‹™ NavigableMap\u0026lt;Priority, Queue\u0026lt;Task\u0026gt;\u0026gt; descendingMap = taskQueues.descendingMap(); for (Map.Entry\u0026lt;Priority, Queue\u0026lt;Task\u0026gt;\u0026gt; entry : descendingMap.entrySet()) { Queue\u0026lt;Task\u0026gt; queue = entry.getValue(); Task task = queue.poll(); if (task != null) { executor.submit(new TaskRunner(task)); return; } } } // ç²å–éšŠåˆ—çµ±è¨ˆä¿¡æ¯ public QueueStatistics getQueueStatistics() { Map\u0026lt;Priority, Integer\u0026gt; queueSizes = new EnumMap\u0026lt;\u0026gt;(Priority.class); int totalTasks = 0; for (Map.Entry\u0026lt;Priority, Queue\u0026lt;Task\u0026gt;\u0026gt; entry : taskQueues.entrySet()) { int size = entry.getValue().size(); queueSizes.put(entry.getKey(), size); totalTasks += size; } return new QueueStatistics(queueSizes, totalTasks); } // æ¸…ç©ºæŒ‡å®šå„ªå…ˆç´šçš„ä»»å‹™ public int clearTasks(Priority priority) { Queue\u0026lt;Task\u0026gt; queue = taskQueues.get(priority); int size = queue.size(); queue.clear(); return size; } // é—œé–‰èª¿åº¦å™¨ public void shutdown() { running.set(false); executor.shutdown(); scheduler.shutdown(); try { if (!executor.awaitTermination(30, TimeUnit.SECONDS)) { executor.shutdownNow(); } if (!scheduler.awaitTermination(30, TimeUnit.SECONDS)) { scheduler.shutdownNow(); } } catch (InterruptedException e) { executor.shutdownNow(); scheduler.shutdownNow(); Thread.currentThread().interrupt(); } } // å„ªå…ˆç´šæšèˆ‰ public enum Priority { LOW(1), NORMAL(2), HIGH(3), CRITICAL(4); private final int value; Priority(int value) { this.value = value; } public int getValue() { return value; } } // ä»»å‹™ä»‹é¢ public interface Task { void execute(); Priority getPriority(); String getName(); } // ä»»å‹™é‹è¡Œå™¨ private static class TaskRunner implements Runnable { private final Task task; public TaskRunner(Task task) { this.task = task; } @Override public void run() { try { task.execute(); } catch (Exception e) { System.err.println(\u0026#34;Task execution failed: \u0026#34; + task.getName()); e.printStackTrace(); } } } // éšŠåˆ—çµ±è¨ˆä¿¡æ¯ public static class QueueStatistics { private final Map\u0026lt;Priority, Integer\u0026gt; queueSizes; private final int totalTasks; public QueueStatistics(Map\u0026lt;Priority, Integer\u0026gt; queueSizes, int totalTasks) { this.queueSizes = queueSizes; this.totalTasks = totalTasks; } public Map\u0026lt;Priority, Integer\u0026gt; getQueueSizes() { return queueSizes; } public int getTotalTasks() { return totalTasks; } } } æ•ˆèƒ½åˆ†æèˆ‡å„ªåŒ– 1. æ™‚é–“è¤‡é›œåº¦åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 public class TreeMapPerformanceAnalysis { public static void main(String[] args) { performanceComparison(); memoryAnalysis(); concurrencyTest(); } // æ•ˆèƒ½æ¯”è¼ƒ private static void performanceComparison() { int[] sizes = {1000, 10000, 100000, 1000000}; for (int size : sizes) { System.out.println(\u0026#34;Size: \u0026#34; + size); // TreeMap æ¸¬è©¦ long startTime = System.nanoTime(); TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; size; i++) { treeMap.put(i, \u0026#34;value\u0026#34; + i); } long treeMapInsertTime = System.nanoTime() - startTime; // æœç´¢æ¸¬è©¦ startTime = System.nanoTime(); for (int i = 0; i \u0026lt; 1000; i++) { treeMap.get(i * size / 1000); } long treeMapSearchTime = System.nanoTime() - startTime; // HashMap æ¯”è¼ƒ startTime = System.nanoTime(); HashMap\u0026lt;Integer, String\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; size; i++) { hashMap.put(i, \u0026#34;value\u0026#34; + i); } long hashMapInsertTime = System.nanoTime() - startTime; startTime = System.nanoTime(); for (int i = 0; i \u0026lt; 1000; i++) { hashMap.get(i * size / 1000); } long hashMapSearchTime = System.nanoTime() - startTime; System.out.printf(\u0026#34;TreeMap - Insert: %d ns, Search: %d ns\\n\u0026#34;, treeMapInsertTime, treeMapSearchTime); System.out.printf(\u0026#34;HashMap - Insert: %d ns, Search: %d ns\\n\\n\u0026#34;, hashMapInsertTime, hashMapSearchTime); } } // è¨˜æ†¶é«”åˆ†æ private static void memoryAnalysis() { Runtime runtime = Runtime.getRuntime(); runtime.gc(); long beforeMemory = runtime.totalMemory() - runtime.freeMemory(); TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 100000; i++) { treeMap.put(i, \u0026#34;value\u0026#34; + i); } long afterMemory = runtime.totalMemory() - runtime.freeMemory(); System.out.println(\u0026#34;TreeMap memory usage: \u0026#34; + (afterMemory - beforeMemory) + \u0026#34; bytes\u0026#34;); // å°æ¯” HashMap runtime.gc(); beforeMemory = runtime.totalMemory() - runtime.freeMemory(); HashMap\u0026lt;Integer, String\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 100000; i++) { hashMap.put(i, \u0026#34;value\u0026#34; + i); } afterMemory = runtime.totalMemory() - runtime.freeMemory(); System.out.println(\u0026#34;HashMap memory usage: \u0026#34; + (afterMemory - beforeMemory) + \u0026#34; bytes\u0026#34;); } // ä¸¦ç™¼æ¸¬è©¦ private static void concurrencyTest() { TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(); ConcurrentSkipListMap\u0026lt;Integer, String\u0026gt; concurrentMap = new ConcurrentSkipListMap\u0026lt;\u0026gt;(); // å¡«å……åˆå§‹æ•¸æ“š for (int i = 0; i \u0026lt; 10000; i++) { treeMap.put(i, \u0026#34;value\u0026#34; + i); concurrentMap.put(i, \u0026#34;value\u0026#34; + i); } // ä¸¦ç™¼è®€å–æ¸¬è©¦ int threadCount = 4; ExecutorService executor = Executors.newFixedThreadPool(threadCount); System.out.println(\u0026#34;Concurrent read test:\u0026#34;); // TreeMap åŒæ­¥è®€å– long startTime = System.nanoTime(); CountDownLatch latch = new CountDownLatch(threadCount); for (int i = 0; i \u0026lt; threadCount; i++) { executor.submit(() -\u0026gt; { try { for (int j = 0; j \u0026lt; 10000; j++) { synchronized (treeMap) { treeMap.get(j); } } } finally { latch.countDown(); } }); } try { latch.await(); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } long treeMapTime = System.nanoTime() - startTime; System.out.println(\u0026#34;TreeMap (synchronized): \u0026#34; + treeMapTime + \u0026#34; ns\u0026#34;); // ConcurrentSkipListMap æ¸¬è©¦ startTime = System.nanoTime(); latch = new CountDownLatch(threadCount); for (int i = 0; i \u0026lt; threadCount; i++) { executor.submit(() -\u0026gt; { try { for (int j = 0; j \u0026lt; 10000; j++) { concurrentMap.get(j); } } finally { latch.countDown(); } }); } try { latch.await(); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } long concurrentMapTime = System.nanoTime() - startTime; System.out.println(\u0026#34;ConcurrentSkipListMap: \u0026#34; + concurrentMapTime + \u0026#34; ns\u0026#34;); executor.shutdown(); } } 2. æœ€ä½³åŒ–å»ºè­° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 public class TreeMapOptimizationTips { // 1. ä½¿ç”¨é©ç•¶çš„æ¯”è¼ƒå™¨ public static void comparatorOptimization() { // é¿å…åœ¨æ¯”è¼ƒå™¨ä¸­é€²è¡Œè¤‡é›œè¨ˆç®— TreeMap\u0026lt;String, Integer\u0026gt; badExample = new TreeMap\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { // å£ä¾‹å­ï¼šæ¯æ¬¡æ¯”è¼ƒéƒ½é€²è¡Œæ˜‚è²´çš„è¨ˆç®— return expensiveCalculation(s1) - expensiveCalculation(s2); }); // å¥½ä¾‹å­ï¼šé å…ˆè¨ˆç®—æˆ–ä½¿ç”¨ç·©å­˜ Map\u0026lt;String, Integer\u0026gt; cache = new ConcurrentHashMap\u0026lt;\u0026gt;(); TreeMap\u0026lt;String, Integer\u0026gt; goodExample = new TreeMap\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { int val1 = cache.computeIfAbsent(s1, TreeMapOptimizationTips::expensiveCalculation); int val2 = cache.computeIfAbsent(s2, TreeMapOptimizationTips::expensiveCalculation); return val1 - val2; }); } // 2. æ‰¹é‡æ“ä½œå„ªåŒ– public static void batchOperationOptimization() { TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(); // æ‰¹é‡æ’å…¥æ¯”å–®å€‹æ’å…¥æ•ˆç‡æ›´é«˜ Map\u0026lt;Integer, String\u0026gt; batchData = new HashMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 1000; i++) { batchData.put(i, \u0026#34;value\u0026#34; + i); } treeMap.putAll(batchData); // ä½¿ç”¨å­æ˜ å°„é€²è¡Œæ‰¹é‡æ“ä½œ NavigableMap\u0026lt;Integer, String\u0026gt; subMap = treeMap.subMap(100, true, 200, false); subMap.clear(); // æ¯”é€å€‹åˆªé™¤æ•ˆç‡æ›´é«˜ } // 3. è¨˜æ†¶é«”å„ªåŒ– public static void memoryOptimization() { // ä½¿ç”¨åŸå§‹é¡å‹åŒ…è£å™¨æ™‚æ³¨æ„è‡ªå‹•è£ç®± TreeMap\u0026lt;Integer, Integer\u0026gt; map = new TreeMap\u0026lt;\u0026gt;(); // é¿å…ä¸å¿…è¦çš„å°è±¡å‰µå»º for (int i = 0; i \u0026lt; 1000; i++) { map.put(i, i * 2); // æœƒå‰µå»º Integer å°è±¡ } // è€ƒæ…®ä½¿ç”¨å°ˆé–€çš„åŸå§‹é¡å‹é›†åˆåº«ï¼ˆå¦‚ Eclipse Collectionsï¼‰ // æˆ–è€…ä½¿ç”¨ TIntIntMap ç­‰åŸå§‹é¡å‹æ˜ å°„ } // 4. ä¸¦ç™¼å„ªåŒ– public static void concurrencyOptimization() { TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(); // ä½¿ç”¨ ConcurrentSkipListMap æ›¿ä»£åŒæ­¥çš„ TreeMap ConcurrentSkipListMap\u0026lt;Integer, String\u0026gt; concurrentMap = new ConcurrentSkipListMap\u0026lt;\u0026gt;(); // æˆ–è€…ä½¿ç”¨è®€å¯«é– ReadWriteLock lock = new ReentrantReadWriteLock(); ReadLock readLock = lock.readLock(); WriteLock writeLock = lock.writeLock(); // è®€æ“ä½œ readLock.lock(); try { treeMap.get(1); } finally { readLock.unlock(); } // å¯«æ“ä½œ writeLock.lock(); try { treeMap.put(1, \u0026#34;value\u0026#34;); } finally { writeLock.unlock(); } } private static int expensiveCalculation(String s) { // æ¨¡æ“¬æ˜‚è²´çš„è¨ˆç®— return s.hashCode() * 31; } } å¯¦éš›æ‡‰ç”¨å ´æ™¯ 1. LeetCode å•é¡Œè§£æ±º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 public class TreeMapLeetCodeSolutions { // LeetCode 2055: è Ÿç‡­ä¹‹é–“çš„ç›¤å­ public int[] platesBetweenCandles(String s, int[][] queries) { TreeMap\u0026lt;Integer, Integer\u0026gt; candlePositions = new TreeMap\u0026lt;\u0026gt;(); // è¨˜éŒ„è Ÿç‡­ä½ç½® for (int i = 0; i \u0026lt; s.length(); i++) { if (s.charAt(i) == \u0026#39;|\u0026#39;) { candlePositions.put(i, i); } } int[] result = new int[queries.length]; for (int i = 0; i \u0026lt; queries.length; i++) { int left = queries[i][0]; int right = queries[i][1]; // æ‰¾åˆ°ç¯„åœå…§çš„ç¬¬ä¸€å€‹å’Œæœ€å¾Œä¸€å€‹è Ÿç‡­ Integer firstCandle = candlePositions.ceilingKey(left); Integer lastCandle = candlePositions.floorKey(right); if (firstCandle != null \u0026amp;\u0026amp; lastCandle != null \u0026amp;\u0026amp; firstCandle \u0026lt;= lastCandle) { // è¨ˆç®—è Ÿç‡­ä¹‹é–“çš„ç›¤å­æ•¸é‡ int totalLength = lastCandle - firstCandle + 1; int candleCount = candlePositions.subMap(firstCandle, true, lastCandle, true).size(); result[i] = totalLength - candleCount; } else { result[i] = 0; } } return result; } // LeetCode 220: å­˜åœ¨é‡è¤‡å…ƒç´  III public boolean containsNearbyAlmostDuplicate(int[] nums, int k, int t) { TreeMap\u0026lt;Integer, Integer\u0026gt; window = new TreeMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; nums.length; i++) { int num = nums[i]; // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å·®å€¼å°æ–¼ç­‰æ–¼ t çš„æ•¸å­— Integer floor = window.floorKey(num); Integer ceiling = window.ceilingKey(num); if ((floor != null \u0026amp;\u0026amp; (long) num - floor \u0026lt;= t) || (ceiling != null \u0026amp;\u0026amp; (long) ceiling - num \u0026lt;= t)) { return true; } // æ·»åŠ ç•¶å‰æ•¸å­—åˆ°çª—å£ window.put(num, window.getOrDefault(num, 0) + 1); // ç¶­è­·çª—å£å¤§å° if (i \u0026gt;= k) { int oldNum = nums[i - k]; window.put(oldNum, window.get(oldNum) - 1); if (window.get(oldNum) == 0) { window.remove(oldNum); } } } return false; } // LeetCode 732: æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III static class MyCalendarThree { private TreeMap\u0026lt;Integer, Integer\u0026gt; timeline; public MyCalendarThree() { timeline = new TreeMap\u0026lt;\u0026gt;(); } public int book(int start, int end) { timeline.put(start, timeline.getOrDefault(start, 0) + 1); timeline.put(end, timeline.getOrDefault(end, 0) - 1); int activeEvents = 0; int maxEvents = 0; for (int count : timeline.values()) { activeEvents += count; maxEvents = Math.max(maxEvents, activeEvents); } return maxEvents; } } } 2. åˆ†ä½ˆå¼ç³»çµ±ä¸­çš„æ‡‰ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 public class DistributedSystemApplications { // ä¸€è‡´æ€§å“ˆå¸Œç’° public static class ConsistentHashRing { private final TreeMap\u0026lt;Long, String\u0026gt; ring; private final int virtualNodes; public ConsistentHashRing(int virtualNodes) { this.ring = new TreeMap\u0026lt;\u0026gt;(); this.virtualNodes = virtualNodes; } public void addNode(String node) { for (int i = 0; i \u0026lt; virtualNodes; i++) { long hash = hash(node + \u0026#34;:\u0026#34; + i); ring.put(hash, node); } } public void removeNode(String node) { for (int i = 0; i \u0026lt; virtualNodes; i++) { long hash = hash(node + \u0026#34;:\u0026#34; + i); ring.remove(hash); } } public String getNode(String key) { if (ring.isEmpty()) { return null; } long hash = hash(key); Map.Entry\u0026lt;Long, String\u0026gt; entry = ring.ceilingEntry(hash); if (entry == null) { entry = ring.firstEntry(); } return entry.getValue(); } private long hash(String key) { return key.hashCode() \u0026amp; 0xFFFFFFFFL; } } // è² è¼‰å¹³è¡¡å™¨ public static class LoadBalancer { private final TreeMap\u0026lt;Integer, List\u0026lt;String\u0026gt;\u0026gt; weightedServers; private final AtomicInteger currentWeight; public LoadBalancer() { this.weightedServers = new TreeMap\u0026lt;\u0026gt;(); this.currentWeight = new AtomicInteger(0); } public void addServer(String server, int weight) { weightedServers.computeIfAbsent(weight, k -\u0026gt; new ArrayList\u0026lt;\u0026gt;()).add(server); } public String selectServer() { if (weightedServers.isEmpty()) { return null; } // åŠ æ¬Šè¼ªè©¢ç®—æ³• int totalWeight = weightedServers.lastKey(); int current = currentWeight.updateAndGet(w -\u0026gt; (w + 1) % totalWeight); for (Map.Entry\u0026lt;Integer, List\u0026lt;String\u0026gt;\u0026gt; entry : weightedServers.descendingMap().entrySet()) { if (current \u0026lt; entry.getKey()) { List\u0026lt;String\u0026gt; servers = entry.getValue(); return servers.get(current % servers.size()); } } return null; } } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. é¸æ“‡é©ç•¶çš„æ¯”è¼ƒç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 public class TreeMapBestPractices { // 1. è‡ªç„¶æ’åº vs è‡ªå®šç¾©æ¯”è¼ƒå™¨ public static void comparatorChoice() { // å°æ–¼å¯¦ç¾ Comparable çš„é¡å‹ï¼Œä½¿ç”¨è‡ªç„¶æ’åº TreeMap\u0026lt;String, Integer\u0026gt; naturalOrder = new TreeMap\u0026lt;\u0026gt;(); // å°æ–¼éœ€è¦è‡ªå®šç¾©æ’åºçš„æƒ…æ³ï¼Œä½¿ç”¨æ¯”è¼ƒå™¨ TreeMap\u0026lt;String, Integer\u0026gt; customOrder = new TreeMap\u0026lt;\u0026gt;(String.CASE_INSENSITIVE_ORDER); // è¤‡é›œå°è±¡çš„å¤šå­—æ®µæ’åº TreeMap\u0026lt;Person, String\u0026gt; personMap = new TreeMap\u0026lt;\u0026gt;( Comparator.comparing(Person::getAge) .thenComparing(Person::getName) ); } // 2. ç©ºå€¼è™•ç† public static void nullHandling() { // TreeMap ä¸å…è¨± null éµ TreeMap\u0026lt;String, Integer\u0026gt; map = new TreeMap\u0026lt;\u0026gt;(); // map.put(null, 1); // æœƒæ‹‹å‡º NullPointerException // ä½†å…è¨± null å€¼ map.put(\u0026#34;key\u0026#34;, null); // å¦‚æœéœ€è¦æ”¯æŒ null éµï¼Œä½¿ç”¨è‡ªå®šç¾©æ¯”è¼ƒå™¨ TreeMap\u0026lt;String, Integer\u0026gt; nullSafeMap = new TreeMap\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { if (s1 == null \u0026amp;\u0026amp; s2 == null) return 0; if (s1 == null) return -1; if (s2 == null) return 1; return s1.compareTo(s2); }); } // 3. ç·šç¨‹å®‰å…¨è™•ç† public static void threadSafety() { TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(); // æ–¹æ³•1ï¼šä½¿ç”¨ Collections.synchronizedMap Map\u0026lt;Integer, String\u0026gt; syncMap = Collections.synchronizedMap(treeMap); // æ–¹æ³•2ï¼šä½¿ç”¨ ConcurrentSkipListMap ConcurrentSkipListMap\u0026lt;Integer, String\u0026gt; concurrentMap = new ConcurrentSkipListMap\u0026lt;\u0026gt;(); // æ–¹æ³•3ï¼šä½¿ç”¨è®€å¯«é– ReadWriteLock lock = new ReentrantReadWriteLock(); // åœ¨è®€å¯«æ“ä½œæ™‚ä½¿ç”¨ç›¸æ‡‰çš„é– } // 4. æ•ˆèƒ½è€ƒæ…® public static void performanceConsiderations() { // é å…ˆæŒ‡å®šåˆå§‹å®¹é‡ï¼ˆTreeMap æ²’æœ‰åˆå§‹å®¹é‡æ¦‚å¿µï¼Œä½†å¯ä»¥æ‰¹é‡æ’å…¥ï¼‰ Map\u0026lt;Integer, String\u0026gt; initialData = new HashMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 1000; i++) { initialData.put(i, \u0026#34;value\u0026#34; + i); } TreeMap\u0026lt;Integer, String\u0026gt; treeMap = new TreeMap\u0026lt;\u0026gt;(initialData); // é¿å…é »ç¹çš„ç¯„åœæŸ¥è©¢æ“ä½œ NavigableMap\u0026lt;Integer, String\u0026gt; subMap = treeMap.subMap(100, true, 200, false); // å° subMap çš„æ“ä½œæœƒå½±éŸ¿åŸå§‹ map } static class Person { private String name; private int age; public Person(String name, int age) { this.name = name; this.age = age; } public String getName() { return name; } public int getAge() { return age; } } } 2. å¸¸è¦‹éŒ¯èª¤é¿å… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 public class TreeMapCommonMistakes { // éŒ¯èª¤1ï¼šåœ¨è¿­ä»£éç¨‹ä¸­ä¿®æ”¹ TreeMap public static void avoidConcurrentModification() { TreeMap\u0026lt;Integer, String\u0026gt; map = new TreeMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 10; i++) { map.put(i, \u0026#34;value\u0026#34; + i); } // éŒ¯èª¤çš„åšæ³• // for (Integer key : map.keySet()) { // if (key % 2 == 0) { // map.remove(key); // ConcurrentModificationException // } // } // æ­£ç¢ºçš„åšæ³•1ï¼šä½¿ç”¨è¿­ä»£å™¨ Iterator\u0026lt;Integer\u0026gt; iterator = map.keySet().iterator(); while (iterator.hasNext()) { if (iterator.next() % 2 == 0) { iterator.remove(); } } // æ­£ç¢ºçš„åšæ³•2ï¼šæ”¶é›†è¦åˆªé™¤çš„éµ List\u0026lt;Integer\u0026gt; keysToRemove = map.keySet().stream() .filter(key -\u0026gt; key % 2 == 0) .collect(Collectors.toList()); keysToRemove.forEach(map::remove); } // éŒ¯èª¤2ï¼šæ¯”è¼ƒå™¨ä¸ä¸€è‡´ public static void avoidInconsistentComparator() { // éŒ¯èª¤ï¼šæ¯”è¼ƒå™¨èˆ‡ equals ä¸ä¸€è‡´ TreeMap\u0026lt;String, Integer\u0026gt; badMap = new TreeMap\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { return s1.length() - s2.length(); // åªæ¯”è¼ƒé•·åº¦ }); badMap.put(\u0026#34;abc\u0026#34;, 1); badMap.put(\u0026#34;def\u0026#34;, 2); // æœƒè¦†è“‹ \u0026#34;abc\u0026#34;ï¼Œå› ç‚ºé•·åº¦ç›¸åŒ // æ­£ç¢ºï¼šç¢ºä¿æ¯”è¼ƒå™¨ä¸€è‡´æ€§ TreeMap\u0026lt;String, Integer\u0026gt; goodMap = new TreeMap\u0026lt;\u0026gt;((s1, s2) -\u0026gt; { int lengthCompare = s1.length() - s2.length(); if (lengthCompare != 0) { return lengthCompare; } return s1.compareTo(s2); // é•·åº¦ç›¸åŒæ™‚æ¯”è¼ƒå…§å®¹ }); } // éŒ¯èª¤3ï¼šèª¤ç”¨å­æ˜ å°„ public static void avoidSubMapMisuse() { TreeMap\u0026lt;Integer, String\u0026gt; map = new TreeMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; 10; i++) { map.put(i, \u0026#34;value\u0026#34; + i); } // éŒ¯èª¤ï¼šèªç‚ºå­æ˜ å°„æ˜¯ç¨ç«‹çš„ NavigableMap\u0026lt;Integer, String\u0026gt; subMap = map.subMap(2, true, 8, false); subMap.clear(); // é€™æœƒå½±éŸ¿åŸå§‹ map // æ­£ç¢ºï¼šå¦‚æœéœ€è¦ç¨ç«‹çš„å‰¯æœ¬ NavigableMap\u0026lt;Integer, String\u0026gt; independentCopy = new TreeMap\u0026lt;\u0026gt;(subMap); } } ç¸½çµ TreeMap æ˜¯ Java é›†åˆæ¡†æ¶ä¸­åŠŸèƒ½å¼·å¤§çš„æœ‰åºæ˜ å°„å¯¦ç¾ï¼ŒåŸºæ–¼ç´…é»‘æ¨¹æä¾›äº† O(log n) çš„é«˜æ•ˆæ“ä½œã€‚é€šéæœ¬æ–‡çš„æ·±å…¥åˆ†æï¼Œæˆ‘å€‘äº†è§£äº†ï¼š\næ ¸å¿ƒç‰¹æ€§ï¼šåŸºæ–¼ç´…é»‘æ¨¹çš„æœ‰åºå­˜å„²ï¼Œæ”¯æŒè‡ªç„¶æ’åºå’Œè‡ªå®šç¾©æ¯”è¼ƒå™¨ ä»‹é¢å±¤æ¬¡ï¼šå¾ Map åˆ° SortedMap å†åˆ° NavigableMap çš„å®Œæ•´åŠŸèƒ½ å¯¦ç”¨æ–¹æ³•ï¼šè±å¯Œçš„ç¯„åœæŸ¥è©¢ã€å°èˆªæ“ä½œå’Œè¦–åœ–æ–¹æ³• ä¼æ¥­æ‡‰ç”¨ï¼šæ™‚é–“åºåˆ—æ•¸æ“šã€ç¯„åœæŸ¥è©¢ã€ä»»å‹™èª¿åº¦ç­‰å¯¦éš›å ´æ™¯ æ•ˆèƒ½å„ªåŒ–ï¼šæ¯”è¼ƒå™¨å„ªåŒ–ã€æ‰¹é‡æ“ä½œã€ä¸¦ç™¼è™•ç†ç­‰æœ€ä½³å¯¦è¸ å¸¸è¦‹é™·é˜±ï¼šä¸¦ç™¼ä¿®æ”¹ã€æ¯”è¼ƒå™¨ä¸€è‡´æ€§ã€å­æ˜ å°„ä½¿ç”¨ç­‰éœ€è¦æ³¨æ„çš„å•é¡Œ æ­£ç¢ºä½¿ç”¨ TreeMap å¯ä»¥åœ¨éœ€è¦æœ‰åºæ˜ å°„çš„å ´æ™¯ä¸­æä¾›é«˜æ•ˆã€å¯é çš„è§£æ±ºæ–¹æ¡ˆï¼Œæ˜¯ Java é–‹ç™¼è€…å¿…é ˆæŒæ¡çš„é‡è¦å·¥å…·ä¹‹ä¸€ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/treemap/","tags":["Java","TreeMap","NavigableMap","Red-Black Tree","Data Structure","Sorting","SortedMap","Binary Search Tree","Performance","Algorithms","Collections","Enterprise","Best Practices","Thread Safety","Concurrency"],"title":"Java TreeMap å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šç´…é»‘æ¨¹æœ‰åºæ˜ å°„èˆ‡ NavigableMap ä»‹é¢è©³è§£"},{"content":"æ¦‚è¿° QueryDSL æ˜¯ä¸€å€‹å¼·å¤§çš„ Java æŸ¥è©¢æ¡†æ¶ï¼Œæä¾›é¡å‹å®‰å…¨çš„ SQL æŸ¥è©¢å»ºæ§‹åŠŸèƒ½ã€‚å®ƒé€šéä»£ç¢¼ç”ŸæˆæŠ€è¡“å‰µå»ºæŸ¥è©¢é¡å‹ï¼Œåœ¨ç·¨è­¯æ™‚æœŸå°±èƒ½ç™¼ç¾æŸ¥è©¢éŒ¯èª¤ï¼Œå¤§å¹…æå‡é–‹ç™¼æ•ˆç‡å’Œä»£ç¢¼è³ªé‡ã€‚æœ¬æ–‡å°‡æ·±å…¥ä»‹ç´¹ QueryDSL çš„å„ç¨®ç”¨æ³•å’Œæœ€ä½³å¯¦è¸ã€‚\næ ¸å¿ƒå„ªå‹¢ é¡å‹å®‰å…¨ï¼šç·¨è­¯æ™‚æª¢æŸ¥ï¼Œé¿å…åŸ·è¡ŒæœŸéŒ¯èª¤ IDE æ”¯æ´ï¼šå®Œæ•´çš„è‡ªå‹•å®Œæˆå’Œé‡æ§‹åŠŸèƒ½ çµ±ä¸€ APIï¼šæ”¯æ´ JPAã€SQLã€MongoDB ç­‰å¤šç¨®æ•¸æ“šæº å‹•æ…‹æŸ¥è©¢ï¼šéˆæ´»çš„æ¢ä»¶çµ„åˆå’ŒæŸ¥è©¢å»ºæ§‹ æ•ˆèƒ½å„ªåŒ–ï¼šç”Ÿæˆé«˜æ•ˆçš„ SQL æŸ¥è©¢ æ”¯æ´çš„æŠ€è¡“æ£§ JPA/Hibernateï¼šæœ€å¸¸ç”¨çš„ ORM æ•´åˆ Spring Data JPAï¼šèˆ‡ Spring ç”Ÿæ…‹å®Œç¾æ•´åˆ SQL æ•¸æ“šåº«ï¼šMySQLã€PostgreSQLã€Oracle ç­‰ NoSQL æ•¸æ“šåº«ï¼šMongoDBã€Lucene ç­‰ ç’°å¢ƒé…ç½®èˆ‡è¨­å®š 1. Maven ä¾è³´é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 \u0026lt;properties\u0026gt; \u0026lt;querydsl.version\u0026gt;5.0.0\u0026lt;/querydsl.version\u0026gt; \u0026lt;maven.compiler.source\u0026gt;17\u0026lt;/maven.compiler.source\u0026gt; \u0026lt;maven.compiler.target\u0026gt;17\u0026lt;/maven.compiler.target\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;!-- Spring Boot Starter Data JPA --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-jpa\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- QueryDSL JPA --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.querydsl\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;querydsl-jpa\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${querydsl.version}\u0026lt;/version\u0026gt; \u0026lt;classifier\u0026gt;jakarta\u0026lt;/classifier\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- QueryDSL APT (Annotation Processing Tool) --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.querydsl\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;querydsl-apt\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${querydsl.version}\u0026lt;/version\u0026gt; \u0026lt;classifier\u0026gt;jakarta\u0026lt;/classifier\u0026gt; \u0026lt;scope\u0026gt;provided\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Database Driver --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Validation --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-validation\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;!-- Maven Compiler Plugin --\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-compiler-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.11.0\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;source\u0026gt;17\u0026lt;/source\u0026gt; \u0026lt;target\u0026gt;17\u0026lt;/target\u0026gt; \u0026lt;annotationProcessorPaths\u0026gt; \u0026lt;path\u0026gt; \u0026lt;groupId\u0026gt;com.querydsl\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;querydsl-apt\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${querydsl.version}\u0026lt;/version\u0026gt; \u0026lt;classifier\u0026gt;jakarta\u0026lt;/classifier\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;path\u0026gt; \u0026lt;groupId\u0026gt;jakarta.persistence\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jakarta.persistence-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.1.0\u0026lt;/version\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;path\u0026gt; \u0026lt;groupId\u0026gt;jakarta.annotation\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jakarta.annotation-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.1.1\u0026lt;/version\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;/annotationProcessorPaths\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;!-- Generate Sources Plugin --\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.codehaus.mojo\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;build-helper-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.4.0\u0026lt;/version\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;phase\u0026gt;generate-sources\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;add-source\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;sources\u0026gt; \u0026lt;source\u0026gt;target/generated-sources/annotations\u0026lt;/source\u0026gt; \u0026lt;/sources\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; 2. Gradle é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 plugins { id \u0026#39;org.springframework.boot\u0026#39; version \u0026#39;3.1.0\u0026#39; id \u0026#39;io.spring.dependency-management\u0026#39; version \u0026#39;1.1.0\u0026#39; id \u0026#39;java\u0026#39; } dependencies { implementation \u0026#39;org.springframework.boot:spring-boot-starter-data-jpa\u0026#39; implementation \u0026#39;org.springframework.boot:spring-boot-starter-web\u0026#39; implementation \u0026#39;org.springframework.boot:spring-boot-starter-validation\u0026#39; // QueryDSL implementation \u0026#39;com.querydsl:querydsl-jpa:5.0.0:jakarta\u0026#39; annotationProcessor \u0026#39;com.querydsl:querydsl-apt:5.0.0:jakarta\u0026#39; annotationProcessor \u0026#39;jakarta.persistence:jakarta.persistence-api\u0026#39; annotationProcessor \u0026#39;jakarta.annotation:jakarta.annotation-api\u0026#39; runtimeOnly \u0026#39;mysql:mysql-connector-java\u0026#39; testImplementation \u0026#39;org.springframework.boot:spring-boot-starter-test\u0026#39; } // QueryDSL é…ç½® def queryDslDir = \u0026#34;$buildDir/generated/querydsl\u0026#34; querydsl { jpa = true querydslSourcesDir = queryDslDir } sourceSets { main.java.srcDir queryDslDir } configurations { querydsl.extendsFrom compileClasspath } compileQuerydsl { options.annotationProcessorPath = configurations.querydsl } 3. Spring Boot é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package com.example.querydsl.config; import com.querydsl.jpa.impl.JPAQueryFactory; import jakarta.persistence.EntityManager; import jakarta.persistence.PersistenceContext; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; @Configuration public class QueryDSLConfig { @PersistenceContext private EntityManager entityManager; @Bean public JPAQueryFactory jpaQueryFactory() { return new JPAQueryFactory(entityManager); } } å¯¦é«”é¡å®šç¾©èˆ‡ Q é¡ç”Ÿæˆ 1. å¯¦é«”é¡å®šç¾© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 package com.example.querydsl.entity; import jakarta.persistence.*; import jakarta.validation.constraints.NotBlank; import jakarta.validation.constraints.Email; import org.hibernate.annotations.CreationTimestamp; import org.hibernate.annotations.UpdateTimestamp; import java.time.LocalDateTime; import java.util.Set; @Entity @Table(name = \u0026#34;users\u0026#34;, indexes = { @Index(name = \u0026#34;idx_username\u0026#34;, columnList = \u0026#34;username\u0026#34;), @Index(name = \u0026#34;idx_email\u0026#34;, columnList = \u0026#34;email\u0026#34;), @Index(name = \u0026#34;idx_department_id\u0026#34;, columnList = \u0026#34;department_id\u0026#34;), @Index(name = \u0026#34;idx_status\u0026#34;, columnList = \u0026#34;status\u0026#34;) }) public class User { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @NotBlank @Column(unique = true, nullable = false, length = 50) private String username; @NotBlank @Email @Column(unique = true, nullable = false, length = 100) private String email; @Column(name = \u0026#34;first_name\u0026#34;, length = 50) private String firstName; @Column(name = \u0026#34;last_name\u0026#34;, length = 50) private String lastName; @Column(nullable = false) private Integer age; @Column(length = 20) private String phone; @Enumerated(EnumType.STRING) @Column(nullable = false) private UserStatus status = UserStatus.ACTIVE; @Column(precision = 10, scale = 2) private Double salary; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \u0026#34;department_id\u0026#34;) private Department department; @OneToMany(mappedBy = \u0026#34;user\u0026#34;, cascade = CascadeType.ALL, fetch = FetchType.LAZY) private Set\u0026lt;UserRole\u0026gt; userRoles; @OneToMany(mappedBy = \u0026#34;assignee\u0026#34;, fetch = FetchType.LAZY) private Set\u0026lt;Project\u0026gt; assignedProjects; @CreationTimestamp @Column(name = \u0026#34;created_at\u0026#34;, nullable = false, updatable = false) private LocalDateTime createdAt; @UpdateTimestamp @Column(name = \u0026#34;updated_at\u0026#34;, nullable = false) private LocalDateTime updatedAt; // å»ºæ§‹å­ã€getterã€setter å’Œ toString æ–¹æ³• public User() {} public User(String username, String email, String firstName, String lastName, Integer age) { this.username = username; this.email = email; this.firstName = firstName; this.lastName = lastName; this.age = age; } // å®Œæ•´çš„ getter å’Œ setter æ–¹æ³• public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public String getFirstName() { return firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getLastName() { return lastName; } public void setLastName(String lastName) { this.lastName = lastName; } public Integer getAge() { return age; } public void setAge(Integer age) { this.age = age; } public String getPhone() { return phone; } public void setPhone(String phone) { this.phone = phone; } public UserStatus getStatus() { return status; } public void setStatus(UserStatus status) { this.status = status; } public Double getSalary() { return salary; } public void setSalary(Double salary) { this.salary = salary; } public Department getDepartment() { return department; } public void setDepartment(Department department) { this.department = department; } public Set\u0026lt;UserRole\u0026gt; getUserRoles() { return userRoles; } public void setUserRoles(Set\u0026lt;UserRole\u0026gt; userRoles) { this.userRoles = userRoles; } public Set\u0026lt;Project\u0026gt; getAssignedProjects() { return assignedProjects; } public void setAssignedProjects(Set\u0026lt;Project\u0026gt; assignedProjects) { this.assignedProjects = assignedProjects; } public LocalDateTime getCreatedAt() { return createdAt; } public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; } } // æšèˆ‰é¡å‹ enum UserStatus { ACTIVE, INACTIVE, SUSPENDED, DELETED } 2. ç›¸é—œå¯¦é«”é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 // Department å¯¦é«” @Entity @Table(name = \u0026#34;departments\u0026#34;) public class Department { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @NotBlank @Column(unique = true, nullable = false, length = 100) private String name; @Column(length = 500) private String description; @Column(name = \u0026#34;budget\u0026#34;, precision = 15, scale = 2) private Double budget; @OneToMany(mappedBy = \u0026#34;department\u0026#34;, fetch = FetchType.LAZY) private Set\u0026lt;User\u0026gt; employees; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \u0026#34;manager_id\u0026#34;) private User manager; @CreationTimestamp @Column(name = \u0026#34;created_at\u0026#34;, nullable = false, updatable = false) private LocalDateTime createdAt; // å»ºæ§‹å­ã€getterã€setter æ–¹æ³• public Department() {} public Department(String name, String description, Double budget) { this.name = name; this.description = description; this.budget = budget; } // getter å’Œ setter æ–¹æ³•çœç•¥... } // Project å¯¦é«” @Entity @Table(name = \u0026#34;projects\u0026#34;) public class Project { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @NotBlank @Column(nullable = false, length = 200) private String title; @Column(length = 1000) private String description; @Column(name = \u0026#34;start_date\u0026#34;) private LocalDateTime startDate; @Column(name = \u0026#34;end_date\u0026#34;) private LocalDateTime endDate; @Enumerated(EnumType.STRING) @Column(nullable = false) private ProjectStatus status = ProjectStatus.PLANNING; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \u0026#34;assignee_id\u0026#34;) private User assignee; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \u0026#34;department_id\u0026#34;) private Department department; // getter å’Œ setter æ–¹æ³•çœç•¥... } enum ProjectStatus { PLANNING, IN_PROGRESS, COMPLETED, CANCELLED, ON_HOLD } // UserRole å¯¦é«”ï¼ˆå¤šå°å¤šé—œè¯è¡¨ï¼‰ @Entity @Table(name = \u0026#34;user_roles\u0026#34;) public class UserRole { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \u0026#34;user_id\u0026#34;, nullable = false) private User user; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \u0026#34;role_id\u0026#34;, nullable = false) private Role role; @CreationTimestamp @Column(name = \u0026#34;assigned_at\u0026#34;, nullable = false, updatable = false) private LocalDateTime assignedAt; // getter å’Œ setter æ–¹æ³•çœç•¥... } @Entity @Table(name = \u0026#34;roles\u0026#34;) public class Role { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @NotBlank @Column(unique = true, nullable = false, length = 50) private String name; @Column(length = 200) private String description; @OneToMany(mappedBy = \u0026#34;role\u0026#34;, fetch = FetchType.LAZY) private Set\u0026lt;UserRole\u0026gt; userRoles; // getter å’Œ setter æ–¹æ³•çœç•¥... } 3. Q é¡ç”Ÿæˆ åŸ·è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ Q é¡ï¼š\n1 2 3 4 5 # Maven é …ç›® mvn clean compile # Gradle é …ç›® ./gradlew compileQuerydsl ç”Ÿæˆçš„ Q é¡å°‡ä½æ–¼ target/generated-sources/annotations (Maven) æˆ– build/generated/querydsl (Gradle) ç›®éŒ„ä¸­ã€‚\nåŸºç¤æŸ¥è©¢æ“ä½œ 1. Repository ä»‹é¢å®šç¾© 1 2 3 4 5 6 7 8 9 10 11 12 package com.example.querydsl.repository; import com.example.querydsl.entity.User; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.querydsl.QuerydslPredicateExecutor; import org.springframework.stereotype.Repository; @Repository public interface UserRepository extends JpaRepository\u0026lt;User, Long\u0026gt;, QuerydslPredicateExecutor\u0026lt;User\u0026gt; { // åŸºæœ¬çš„ CRUD æ“ä½œç”± JpaRepository æä¾› // QuerydslPredicateExecutor æä¾› QueryDSL æŸ¥è©¢æ”¯æ´ } 2. Service å±¤å¯¦ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 package com.example.querydsl.service; import com.example.querydsl.entity.*; import com.example.querydsl.repository.UserRepository; import com.querydsl.core.BooleanBuilder; import com.querydsl.core.types.OrderSpecifier; import com.querydsl.core.types.Predicate; import com.querydsl.core.types.Projections; import com.querydsl.core.types.dsl.BooleanExpression; import com.querydsl.jpa.impl.JPAQueryFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.domain.Page; import org.springframework.data.domain.Pageable; import org.springframework.stereotype.Service; import org.springframework.transaction.annotation.Transactional; import java.time.LocalDateTime; import java.util.List; import java.util.Optional; @Service @Transactional(readOnly = true) public class UserService { @Autowired private JPAQueryFactory queryFactory; @Autowired private UserRepository userRepository; // Q é¡å¯¦ä¾‹ private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; private final QProject qProject = QProject.project; private final QUserRole qUserRole = QUserRole.userRole; private final QRole qRole = QRole.role; /** * åŸºç¤æŸ¥è©¢ï¼šæ ¹æ“šç”¨æˆ¶åæŸ¥æ‰¾ç”¨æˆ¶ */ public Optional\u0026lt;User\u0026gt; findByUsername(String username) { User user = queryFactory.selectFrom(qUser) .where(qUser.username.eq(username)) .fetchOne(); return Optional.ofNullable(user); } /** * æ¢ä»¶æŸ¥è©¢ï¼šæ ¹æ“šå¤šå€‹æ¢ä»¶æŸ¥æ‰¾ç”¨æˆ¶ */ public List\u0026lt;User\u0026gt; findUsersByConditions(String username, String email, Integer minAge, Integer maxAge, UserStatus status) { BooleanBuilder builder = new BooleanBuilder(); if (username != null \u0026amp;\u0026amp; !username.trim().isEmpty()) { builder.and(qUser.username.containsIgnoreCase(username)); } if (email != null \u0026amp;\u0026amp; !email.trim().isEmpty()) { builder.and(qUser.email.containsIgnoreCase(email)); } if (minAge != null) { builder.and(qUser.age.goe(minAge)); } if (maxAge != null) { builder.and(qUser.age.loe(maxAge)); } if (status != null) { builder.and(qUser.status.eq(status)); } return queryFactory.selectFrom(qUser) .where(builder) .orderBy(qUser.createdAt.desc()) .fetch(); } /** * åˆ†é æŸ¥è©¢ï¼šä½¿ç”¨ Spring Data çš„åˆ†é æ”¯æ´ */ public Page\u0026lt;User\u0026gt; findUsersWithPagination(String keyword, UserStatus status, Pageable pageable) { BooleanBuilder builder = new BooleanBuilder(); if (keyword != null \u0026amp;\u0026amp; !keyword.trim().isEmpty()) { BooleanExpression keywordCondition = qUser.username.containsIgnoreCase(keyword) .or(qUser.firstName.containsIgnoreCase(keyword)) .or(qUser.lastName.containsIgnoreCase(keyword)) .or(qUser.email.containsIgnoreCase(keyword)); builder.and(keywordCondition); } if (status != null) { builder.and(qUser.status.eq(status)); } return userRepository.findAll(builder, pageable); } } é«˜ç´šæŸ¥è©¢åŠŸèƒ½ 1. Join æŸ¥è©¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 /** * Join æŸ¥è©¢ç¯„ä¾‹ */ @Service @Transactional(readOnly = true) public class AdvancedQueryService { @Autowired private JPAQueryFactory queryFactory; private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; private final QProject qProject = QProject.project; private final QUserRole qUserRole = QUserRole.userRole; private final QRole qRole = QRole.role; /** * Inner Joinï¼šæŸ¥è©¢ç”¨æˆ¶åŠå…¶éƒ¨é–€è³‡è¨Š */ public List\u0026lt;User\u0026gt; findUsersWithDepartment() { return queryFactory.selectFrom(qUser) .innerJoin(qUser.department, qDepartment).fetchJoin() .where(qDepartment.name.isNotNull()) .orderBy(qDepartment.name.asc(), qUser.username.asc()) .fetch(); } /** * Left Joinï¼šæŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶ï¼ˆåŒ…å«æ²’æœ‰éƒ¨é–€çš„ç”¨æˆ¶ï¼‰ */ public List\u0026lt;User\u0026gt; findAllUsersWithOptionalDepartment() { return queryFactory.selectFrom(qUser) .leftJoin(qUser.department, qDepartment).fetchJoin() .orderBy(qUser.username.asc()) .fetch(); } /** * è¤‡é›œ Joinï¼šæŸ¥è©¢ç”¨æˆ¶ã€éƒ¨é–€å’Œå°ˆæ¡ˆè³‡è¨Š */ public List\u0026lt;User\u0026gt; findUsersWithDepartmentAndProjects() { return queryFactory.selectFrom(qUser) .leftJoin(qUser.department, qDepartment).fetchJoin() .leftJoin(qUser.assignedProjects, qProject).fetchJoin() .where(qUser.status.eq(UserStatus.ACTIVE)) .orderBy(qDepartment.name.asc(), qUser.username.asc()) .fetch(); } /** * æ¢ä»¶ Joinï¼šæ ¹æ“šéƒ¨é–€é ç®—æŸ¥è©¢ç”¨æˆ¶ */ public List\u0026lt;User\u0026gt; findUsersByDepartmentBudget(Double minBudget) { return queryFactory.selectFrom(qUser) .innerJoin(qUser.department, qDepartment) .where(qDepartment.budget.goe(minBudget)) .orderBy(qDepartment.budget.desc(), qUser.username.asc()) .fetch(); } /** * å¤šå±¤ Joinï¼šæŸ¥è©¢ç”¨æˆ¶è§’è‰²è³‡è¨Š */ public List\u0026lt;User\u0026gt; findUsersWithRoles(String roleName) { return queryFactory.selectFrom(qUser) .innerJoin(qUser.userRoles, qUserRole) .innerJoin(qUserRole.role, qRole) .where(qRole.name.eq(roleName)) .orderBy(qUser.username.asc()) .fetch(); } } 2. å­æŸ¥è©¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 /** * å­æŸ¥è©¢ç¯„ä¾‹ */ public class SubQueryService { @Autowired private JPAQueryFactory queryFactory; private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; private final QProject qProject = QProject.project; /** * EXISTS å­æŸ¥è©¢ï¼šæŸ¥è©¢æœ‰å°ˆæ¡ˆçš„ç”¨æˆ¶ */ public List\u0026lt;User\u0026gt; findUsersWithProjects() { QProject subProject = new QProject(\u0026#34;subProject\u0026#34;); return queryFactory.selectFrom(qUser) .where(JPAExpressions.selectOne() .from(subProject) .where(subProject.assignee.eq(qUser)) .exists()) .orderBy(qUser.username.asc()) .fetch(); } /** * NOT EXISTS å­æŸ¥è©¢ï¼šæŸ¥è©¢æ²’æœ‰å°ˆæ¡ˆçš„ç”¨æˆ¶ */ public List\u0026lt;User\u0026gt; findUsersWithoutProjects() { QProject subProject = new QProject(\u0026#34;subProject\u0026#34;); return queryFactory.selectFrom(qUser) .where(JPAExpressions.selectOne() .from(subProject) .where(subProject.assignee.eq(qUser)) .notExists()) .orderBy(qUser.username.asc()) .fetch(); } /** * IN å­æŸ¥è©¢ï¼šæŸ¥è©¢ç‰¹å®šéƒ¨é–€çš„ç”¨æˆ¶ */ public List\u0026lt;User\u0026gt; findUsersByDepartmentNames(List\u0026lt;String\u0026gt; departmentNames) { QDepartment subDepartment = new QDepartment(\u0026#34;subDepartment\u0026#34;); return queryFactory.selectFrom(qUser) .where(qUser.department.id.in( JPAExpressions.select(subDepartment.id) .from(subDepartment) .where(subDepartment.name.in(departmentNames)) )) .orderBy(qUser.username.asc()) .fetch(); } /** * æ¯”è¼ƒå­æŸ¥è©¢ï¼šæŸ¥è©¢è–ªè³‡é«˜æ–¼å¹³å‡è–ªè³‡çš„ç”¨æˆ¶ */ public List\u0026lt;User\u0026gt; findUsersWithAboveAverageSalary() { QUser subUser = new QUser(\u0026#34;subUser\u0026#34;); return queryFactory.selectFrom(qUser) .where(qUser.salary.gt( JPAExpressions.select(subUser.salary.avg()) .from(subUser) .where(subUser.salary.isNotNull()) )) .orderBy(qUser.salary.desc()) .fetch(); } /** * ç›¸é—œå­æŸ¥è©¢ï¼šæŸ¥è©¢éƒ¨é–€å…§è–ªè³‡æœ€é«˜çš„ç”¨æˆ¶ */ public List\u0026lt;User\u0026gt; findTopSalaryUsersByDepartment() { QUser subUser = new QUser(\u0026#34;subUser\u0026#34;); return queryFactory.selectFrom(qUser) .where(qUser.salary.eq( JPAExpressions.select(subUser.salary.max()) .from(subUser) .where(subUser.department.eq(qUser.department) .and(subUser.salary.isNotNull())) )) .orderBy(qUser.department.name.asc(), qUser.username.asc()) .fetch(); } } 3. èšåˆæŸ¥è©¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 /** * èšåˆæŸ¥è©¢ç¯„ä¾‹ */ public class AggregationService { @Autowired private JPAQueryFactory queryFactory; private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; private final QProject qProject = QProject.project; /** * åŸºç¤èšåˆï¼šçµ±è¨ˆç”¨æˆ¶æ•¸é‡ */ public Long countActiveUsers() { return queryFactory.select(qUser.count()) .from(qUser) .where(qUser.status.eq(UserStatus.ACTIVE)) .fetchOne(); } /** * GROUP BYï¼šæŒ‰éƒ¨é–€çµ±è¨ˆç”¨æˆ¶æ•¸é‡ */ public List\u0026lt;DepartmentUserCount\u0026gt; countUsersByDepartment() { return queryFactory.select(Projections.constructor(DepartmentUserCount.class, qDepartment.id, qDepartment.name, qUser.count())) .from(qUser) .innerJoin(qUser.department, qDepartment) .where(qUser.status.eq(UserStatus.ACTIVE)) .groupBy(qDepartment.id, qDepartment.name) .orderBy(qUser.count().desc()) .fetch(); } /** * HAVINGï¼šæŸ¥è©¢ç”¨æˆ¶æ•¸é‡å¤§æ–¼æŒ‡å®šæ•¸é‡çš„éƒ¨é–€ */ public List\u0026lt;DepartmentUserCount\u0026gt; findDepartmentsWithMinUsers(Long minUserCount) { return queryFactory.select(Projections.constructor(DepartmentUserCount.class, qDepartment.id, qDepartment.name, qUser.count())) .from(qUser) .innerJoin(qUser.department, qDepartment) .where(qUser.status.eq(UserStatus.ACTIVE)) .groupBy(qDepartment.id, qDepartment.name) .having(qUser.count().goe(minUserCount)) .orderBy(qUser.count().desc()) .fetch(); } /** * å¤šæ¬„ä½èšåˆï¼šéƒ¨é–€è–ªè³‡çµ±è¨ˆ */ public List\u0026lt;DepartmentSalaryStats\u0026gt; calculateDepartmentSalaryStats() { return queryFactory.select(Projections.constructor(DepartmentSalaryStats.class, qDepartment.id, qDepartment.name, qUser.salary.sum(), qUser.salary.avg(), qUser.salary.min(), qUser.salary.max(), qUser.count())) .from(qUser) .innerJoin(qUser.department, qDepartment) .where(qUser.status.eq(UserStatus.ACTIVE) .and(qUser.salary.isNotNull())) .groupBy(qDepartment.id, qDepartment.name) .orderBy(qUser.salary.avg().desc()) .fetch(); } /** * æ™‚é–“èšåˆï¼šæŒ‰æœˆçµ±è¨ˆç”¨æˆ¶è¨»å†Šæ•¸é‡ */ public List\u0026lt;MonthlyUserRegistration\u0026gt; getUserRegistrationByMonth(int year) { return queryFactory.select(Projections.constructor(MonthlyUserRegistration.class, qUser.createdAt.month(), qUser.count())) .from(qUser) .where(qUser.createdAt.year().eq(year)) .groupBy(qUser.createdAt.month()) .orderBy(qUser.createdAt.month().asc()) .fetch(); } // DTO é¡åˆ¥å®šç¾© public static class DepartmentUserCount { private Long departmentId; private String departmentName; private Long userCount; public DepartmentUserCount(Long departmentId, String departmentName, Long userCount) { this.departmentId = departmentId; this.departmentName = departmentName; this.userCount = userCount; } // getter å’Œ setter æ–¹æ³•çœç•¥... } public static class DepartmentSalaryStats { private Long departmentId; private String departmentName; private Double totalSalary; private Double averageSalary; private Double minSalary; private Double maxSalary; private Long employeeCount; public DepartmentSalaryStats(Long departmentId, String departmentName, Double totalSalary, Double averageSalary, Double minSalary, Double maxSalary, Long employeeCount) { this.departmentId = departmentId; this.departmentName = departmentName; this.totalSalary = totalSalary; this.averageSalary = averageSalary; this.minSalary = minSalary; this.maxSalary = maxSalary; this.employeeCount = employeeCount; } // getter å’Œ setter æ–¹æ³•çœç•¥... } public static class MonthlyUserRegistration { private Integer month; private Long registrationCount; public MonthlyUserRegistration(Integer month, Long registrationCount) { this.month = month; this.registrationCount = registrationCount; } // getter å’Œ setter æ–¹æ³•çœç•¥... } } å‹•æ…‹æŸ¥è©¢å»ºæ§‹ 1. Predicate å»ºæ§‹å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 /** * å‹•æ…‹æŸ¥è©¢å»ºæ§‹å™¨ */ @Component public class UserPredicateBuilder { private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; /** * å»ºæ§‹ç”¨æˆ¶æŸ¥è©¢æ¢ä»¶ */ public BooleanBuilder buildUserPredicate(UserSearchCriteria criteria) { BooleanBuilder builder = new BooleanBuilder(); // åŸºæœ¬æ¬„ä½æ¢ä»¶ addStringCondition(builder, qUser.username, criteria.getUsername(), StringMatchType.CONTAINS); addStringCondition(builder, qUser.email, criteria.getEmail(), StringMatchType.CONTAINS); addStringCondition(builder, qUser.firstName, criteria.getFirstName(), StringMatchType.CONTAINS); addStringCondition(builder, qUser.lastName, criteria.getLastName(), StringMatchType.CONTAINS); addStringCondition(builder, qUser.phone, criteria.getPhone(), StringMatchType.EXACT); // æ•¸å€¼ç¯„åœæ¢ä»¶ addRangeCondition(builder, qUser.age, criteria.getMinAge(), criteria.getMaxAge()); addRangeCondition(builder, qUser.salary, criteria.getMinSalary(), criteria.getMaxSalary()); // æšèˆ‰æ¢ä»¶ addEnumCondition(builder, qUser.status, criteria.getStatuses()); // æ—¥æœŸç¯„åœæ¢ä»¶ addDateRangeCondition(builder, qUser.createdAt, criteria.getCreatedAfter(), criteria.getCreatedBefore()); addDateRangeCondition(builder, qUser.updatedAt, criteria.getUpdatedAfter(), criteria.getUpdatedBefore()); // é—œè¯æ¢ä»¶ addDepartmentConditions(builder, criteria); return builder; } /** * å­—ä¸²æ¢ä»¶è™•ç† */ private void addStringCondition(BooleanBuilder builder, StringPath path, String value, StringMatchType matchType) { if (value != null \u0026amp;\u0026amp; !value.trim().isEmpty()) { switch (matchType) { case EXACT: builder.and(path.eq(value)); break; case CONTAINS: builder.and(path.containsIgnoreCase(value.trim())); break; case STARTS_WITH: builder.and(path.startsWithIgnoreCase(value.trim())); break; case ENDS_WITH: builder.and(path.endsWithIgnoreCase(value.trim())); break; } } } /** * æ•¸å€¼ç¯„åœæ¢ä»¶è™•ç† */ private \u0026lt;T extends Number \u0026amp; Comparable\u0026lt;T\u0026gt;\u0026gt; void addRangeCondition( BooleanBuilder builder, NumberPath\u0026lt;T\u0026gt; path, T minValue, T maxValue) { if (minValue != null) { builder.and(path.goe(minValue)); } if (maxValue != null) { builder.and(path.loe(maxValue)); } } /** * æšèˆ‰æ¢ä»¶è™•ç† */ private \u0026lt;T extends Enum\u0026lt;T\u0026gt;\u0026gt; void addEnumCondition( BooleanBuilder builder, EnumPath\u0026lt;T\u0026gt; path, List\u0026lt;T\u0026gt; values) { if (values != null \u0026amp;\u0026amp; !values.isEmpty()) { builder.and(path.in(values)); } } /** * æ—¥æœŸç¯„åœæ¢ä»¶è™•ç† */ private void addDateRangeCondition(BooleanBuilder builder, DateTimePath\u0026lt;LocalDateTime\u0026gt; path, LocalDateTime after, LocalDateTime before) { if (after != null) { builder.and(path.goe(after)); } if (before != null) { builder.and(path.loe(before)); } } /** * éƒ¨é–€ç›¸é—œæ¢ä»¶è™•ç† */ private void addDepartmentConditions(BooleanBuilder builder, UserSearchCriteria criteria) { if (criteria.getDepartmentIds() != null \u0026amp;\u0026amp; !criteria.getDepartmentIds().isEmpty()) { builder.and(qUser.department.id.in(criteria.getDepartmentIds())); } if (criteria.getDepartmentName() != null \u0026amp;\u0026amp; !criteria.getDepartmentName().trim().isEmpty()) { builder.and(qUser.department.name.containsIgnoreCase(criteria.getDepartmentName().trim())); } if (criteria.getMinDepartmentBudget() != null) { builder.and(qUser.department.budget.goe(criteria.getMinDepartmentBudget())); } if (criteria.getMaxDepartmentBudget() != null) { builder.and(qUser.department.budget.loe(criteria.getMaxDepartmentBudget())); } } /** * å­—ä¸²åŒ¹é…é¡å‹æšèˆ‰ */ public enum StringMatchType { EXACT, CONTAINS, STARTS_WITH, ENDS_WITH } } /** * ç”¨æˆ¶æœå°‹æ¢ä»¶ DTO */ public class UserSearchCriteria { private String username; private String email; private String firstName; private String lastName; private String phone; private Integer minAge; private Integer maxAge; private Double minSalary; private Double maxSalary; private List\u0026lt;UserStatus\u0026gt; statuses; private LocalDateTime createdAfter; private LocalDateTime createdBefore; private LocalDateTime updatedAfter; private LocalDateTime updatedBefore; private List\u0026lt;Long\u0026gt; departmentIds; private String departmentName; private Double minDepartmentBudget; private Double maxDepartmentBudget; // å»ºæ§‹å­ã€getter å’Œ setter æ–¹æ³•çœç•¥... } 2. æŸ¥è©¢è¦æ ¼å»ºæ§‹å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 /** * æŸ¥è©¢è¦æ ¼å»ºæ§‹å™¨ */ @Component public class QuerySpecificationBuilder { private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; private final QProject qProject = QProject.project; /** * å»ºæ§‹è¤‡é›œæŸ¥è©¢è¦æ ¼ */ public JPAQuery\u0026lt;User\u0026gt; buildComplexUserQuery(JPAQueryFactory queryFactory, ComplexSearchCriteria criteria) { JPAQuery\u0026lt;User\u0026gt; query = queryFactory.selectFrom(qUser); // æ·»åŠ  Join addJoins(query, criteria); // æ·»åŠ  Where æ¢ä»¶ addWhereConditions(query, criteria); // æ·»åŠ æ’åº addOrderBy(query, criteria); return query; } /** * æ·»åŠ  Join æ¢ä»¶ */ private void addJoins(JPAQuery\u0026lt;User\u0026gt; query, ComplexSearchCriteria criteria) { if (criteria.isIncludeDepartment() || criteria.hasDepartmentConditions()) { query.leftJoin(qUser.department, qDepartment); if (criteria.isFetchDepartment()) { query.fetchJoin(); } } if (criteria.isIncludeProjects() || criteria.hasProjectConditions()) { query.leftJoin(qUser.assignedProjects, qProject); if (criteria.isFetchProjects()) { query.fetchJoin(); } } } /** * æ·»åŠ  Where æ¢ä»¶ */ private void addWhereConditions(JPAQuery\u0026lt;User\u0026gt; query, ComplexSearchCriteria criteria) { BooleanBuilder builder = new BooleanBuilder(); // ç”¨æˆ¶åŸºæœ¬æ¢ä»¶ addUserConditions(builder, criteria); // éƒ¨é–€æ¢ä»¶ addDepartmentConditions(builder, criteria); // å°ˆæ¡ˆæ¢ä»¶ addProjectConditions(builder, criteria); // è‡ªè¨‚æ¢ä»¶ addCustomConditions(builder, criteria); if (builder.hasValue()) { query.where(builder); } } /** * æ·»åŠ æ’åºæ¢ä»¶ */ private void addOrderBy(JPAQuery\u0026lt;User\u0026gt; query, ComplexSearchCriteria criteria) { List\u0026lt;OrderSpecifier\u0026lt;?\u0026gt;\u0026gt; orderSpecifiers = new ArrayList\u0026lt;\u0026gt;(); if (criteria.getSortFields() != null \u0026amp;\u0026amp; !criteria.getSortFields().isEmpty()) { for (SortField sortField : criteria.getSortFields()) { OrderSpecifier\u0026lt;?\u0026gt; orderSpecifier = createOrderSpecifier(sortField); if (orderSpecifier != null) { orderSpecifiers.add(orderSpecifier); } } } // é è¨­æ’åº if (orderSpecifiers.isEmpty()) { orderSpecifiers.add(qUser.createdAt.desc()); } query.orderBy(orderSpecifiers.toArray(new OrderSpecifier[0])); } /** * å‰µå»ºæ’åºè¦æ ¼ */ private OrderSpecifier\u0026lt;?\u0026gt; createOrderSpecifier(SortField sortField) { boolean isAsc = sortField.getDirection() == SortDirection.ASC; switch (sortField.getField()) { case \u0026#34;username\u0026#34;: return isAsc ? qUser.username.asc() : qUser.username.desc(); case \u0026#34;email\u0026#34;: return isAsc ? qUser.email.asc() : qUser.email.desc(); case \u0026#34;age\u0026#34;: return isAsc ? qUser.age.asc() : qUser.age.desc(); case \u0026#34;salary\u0026#34;: return isAsc ? qUser.salary.asc() : qUser.salary.desc(); case \u0026#34;createdAt\u0026#34;: return isAsc ? qUser.createdAt.asc() : qUser.createdAt.desc(); case \u0026#34;departmentName\u0026#34;: return isAsc ? qDepartment.name.asc() : qDepartment.name.desc(); default: return null; } } // è¼”åŠ©æ–¹æ³•çœç•¥... } æ›´æ–°å’Œåˆªé™¤æ“ä½œ 1. æ‰¹é‡æ›´æ–° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 /** * æ›´æ–°å’Œåˆªé™¤æ“ä½œæœå‹™ */ @Service @Transactional public class UserUpdateService { @Autowired private JPAQueryFactory queryFactory; private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; /** * æ‰¹é‡æ›´æ–°ç”¨æˆ¶ç‹€æ…‹ */ public long updateUserStatus(List\u0026lt;Long\u0026gt; userIds, UserStatus newStatus) { return queryFactory.update(qUser) .set(qUser.status, newStatus) .set(qUser.updatedAt, LocalDateTime.now()) .where(qUser.id.in(userIds)) .execute(); } /** * æ‰¹é‡æ›´æ–°ç”¨æˆ¶è–ªè³‡ */ public long updateSalaryByDepartment(Long departmentId, Double salaryIncrease) { return queryFactory.update(qUser) .set(qUser.salary, qUser.salary.add(salaryIncrease)) .set(qUser.updatedAt, LocalDateTime.now()) .where(qUser.department.id.eq(departmentId) .and(qUser.status.eq(UserStatus.ACTIVE)) .and(qUser.salary.isNotNull())) .execute(); } /** * æ¢ä»¶å¼æ›´æ–°ï¼šæ ¹æ“šå¹´é½¡èª¿æ•´è–ªè³‡ */ public long adjustSalaryByAge() { // ç‚ºå¹´é½¡å¤§æ–¼ 30 çš„å“¡å·¥å¢åŠ  10% è–ªè³‡ return queryFactory.update(qUser) .set(qUser.salary, qUser.salary.multiply(1.1)) .set(qUser.updatedAt, LocalDateTime.now()) .where(qUser.age.gt(30) .and(qUser.status.eq(UserStatus.ACTIVE)) .and(qUser.salary.isNotNull())) .execute(); } /** * Join æ›´æ–°ï¼šæ ¹æ“šéƒ¨é–€é ç®—æ›´æ–°å“¡å·¥ç‹€æ…‹ */ public long updateStatusByDepartmentBudget(Double minBudget, UserStatus newStatus) { return queryFactory.update(qUser) .set(qUser.status, newStatus) .set(qUser.updatedAt, LocalDateTime.now()) .where(qUser.department.budget.lt(minBudget)) .execute(); } } 2. æ‰¹é‡åˆªé™¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 /** * åˆªé™¤æ“ä½œæœå‹™ */ @Service @Transactional public class UserDeleteService { @Autowired private JPAQueryFactory queryFactory; private final QUser qUser = QUser.user; /** * è»Ÿåˆªé™¤ï¼šæ¨™è¨˜ç‚ºå·²åˆªé™¤ç‹€æ…‹ */ public long softDeleteUsers(List\u0026lt;Long\u0026gt; userIds) { return queryFactory.update(qUser) .set(qUser.status, UserStatus.DELETED) .set(qUser.updatedAt, LocalDateTime.now()) .where(qUser.id.in(userIds)) .execute(); } /** * ç¡¬åˆªé™¤ï¼šç‰©ç†åˆªé™¤è¨˜éŒ„ */ public long hardDeleteInactiveUsers(LocalDateTime before) { return queryFactory.delete(qUser) .where(qUser.status.eq(UserStatus.DELETED) .and(qUser.updatedAt.before(before))) .execute(); } /** * æ¢ä»¶åˆªé™¤ï¼šåˆªé™¤ç‰¹å®šæ¢ä»¶çš„ç”¨æˆ¶ */ public long deleteUsersByCondition(UserStatus status, Integer maxAge) { BooleanBuilder builder = new BooleanBuilder(); if (status != null) { builder.and(qUser.status.eq(status)); } if (maxAge != null) { builder.and(qUser.age.loe(maxAge)); } return queryFactory.delete(qUser) .where(builder) .execute(); } /** * æ¸…ç†å­¤ç«‹è¨˜éŒ„ï¼šåˆªé™¤æ²’æœ‰éƒ¨é–€çš„ç”¨æˆ¶ */ public long deleteUsersWithoutDepartment() { return queryFactory.delete(qUser) .where(qUser.department.isNull() .and(qUser.status.eq(UserStatus.INACTIVE))) .execute(); } } æ•ˆèƒ½å„ªåŒ–æŠ€å·§ 1. æŸ¥è©¢å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 /** * æ•ˆèƒ½å„ªåŒ–æœå‹™ */ @Service @Transactional(readOnly = true) public class QueryOptimizationService { @Autowired private JPAQueryFactory queryFactory; private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; /** * ä½¿ç”¨æŠ•å½±æ¸›å°‘è³‡æ–™å‚³è¼¸ */ public List\u0026lt;UserSummaryDTO\u0026gt; getUserSummaries() { return queryFactory.select(Projections.constructor(UserSummaryDTO.class, qUser.id, qUser.username, qUser.email, qUser.status, qDepartment.name)) .from(qUser) .leftJoin(qUser.department, qDepartment) .where(qUser.status.eq(UserStatus.ACTIVE)) .orderBy(qUser.username.asc()) .fetch(); } /** * ä½¿ç”¨ Fetch Join é¿å… N+1 å•é¡Œ */ public List\u0026lt;User\u0026gt; getUsersWithDepartmentOptimized() { return queryFactory.selectFrom(qUser) .leftJoin(qUser.department, qDepartment).fetchJoin() .where(qUser.status.eq(UserStatus.ACTIVE)) .orderBy(qUser.username.asc()) .fetch(); } /** * åˆ†é æŸ¥è©¢å„ªåŒ– */ public Page\u0026lt;User\u0026gt; getUsersWithOptimizedPaging(Pageable pageable) { // å…ˆæŸ¥è©¢ç¸½æ•¸ Long total = queryFactory.select(qUser.count()) .from(qUser) .where(qUser.status.eq(UserStatus.ACTIVE)) .fetchOne(); // å¦‚æœç¸½æ•¸ç‚º 0ï¼Œç›´æ¥è¿”å›ç©ºé é¢ if (total == 0) { return new PageImpl\u0026lt;\u0026gt;(Collections.emptyList(), pageable, 0); } // æŸ¥è©¢åˆ†é è³‡æ–™ List\u0026lt;User\u0026gt; users = queryFactory.selectFrom(qUser) .where(qUser.status.eq(UserStatus.ACTIVE)) .orderBy(qUser.username.asc()) .offset(pageable.getOffset()) .limit(pageable.getPageSize()) .fetch(); return new PageImpl\u0026lt;\u0026gt;(users, pageable, total); } /** * ä½¿ç”¨ç´¢å¼•æç¤ºå„ªåŒ–æŸ¥è©¢ */ public List\u0026lt;User\u0026gt; findUsersByIndexedFields(String username, String email) { BooleanBuilder builder = new BooleanBuilder(); // å„ªå…ˆä½¿ç”¨æœ‰ç´¢å¼•çš„æ¬„ä½ if (username != null \u0026amp;\u0026amp; !username.trim().isEmpty()) { builder.and(qUser.username.eq(username)); // username æœ‰å”¯ä¸€ç´¢å¼• } else if (email != null \u0026amp;\u0026amp; !email.trim().isEmpty()) { builder.and(qUser.email.eq(email)); // email æœ‰å”¯ä¸€ç´¢å¼• } return queryFactory.selectFrom(qUser) .where(builder) .fetch(); } /** * æ‰¹é‡æŸ¥è©¢å„ªåŒ– */ public Map\u0026lt;Long, User\u0026gt; getUsersByIdsOptimized(List\u0026lt;Long\u0026gt; userIds) { if (userIds.isEmpty()) { return Collections.emptyMap(); } List\u0026lt;User\u0026gt; users = queryFactory.selectFrom(qUser) .where(qUser.id.in(userIds)) .fetch(); return users.stream() .collect(Collectors.toMap(User::getId, Function.identity())); } } /** * ç”¨æˆ¶æ‘˜è¦ DTO */ public class UserSummaryDTO { private Long id; private String username; private String email; private UserStatus status; private String departmentName; public UserSummaryDTO(Long id, String username, String email, UserStatus status, String departmentName) { this.id = id; this.username = username; this.email = email; this.status = status; this.departmentName = departmentName; } // getter å’Œ setter æ–¹æ³•çœç•¥... } 2. å¿«å–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 /** * å¿«å–å„ªåŒ–æœå‹™ */ @Service @Transactional(readOnly = true) public class CachedQueryService { @Autowired private JPAQueryFactory queryFactory; @Autowired private CacheManager cacheManager; private final QUser qUser = QUser.user; private final QDepartment qDepartment = QDepartment.department; /** * å¿«å–ç”¨æˆ¶åŸºæœ¬è³‡è¨Š */ @Cacheable(value = \u0026#34;userCache\u0026#34;, key = \u0026#34;#userId\u0026#34;) public Optional\u0026lt;User\u0026gt; getCachedUser(Long userId) { User user = queryFactory.selectFrom(qUser) .where(qUser.id.eq(userId)) .fetchOne(); return Optional.ofNullable(user); } /** * å¿«å–éƒ¨é–€ç”¨æˆ¶åˆ—è¡¨ */ @Cacheable(value = \u0026#34;departmentUsersCache\u0026#34;, key = \u0026#34;#departmentId\u0026#34;) public List\u0026lt;User\u0026gt; getCachedDepartmentUsers(Long departmentId) { return queryFactory.selectFrom(qUser) .where(qUser.department.id.eq(departmentId) .and(qUser.status.eq(UserStatus.ACTIVE))) .orderBy(qUser.username.asc()) .fetch(); } /** * å¿«å–ç”¨æˆ¶çµ±è¨ˆè³‡è¨Š */ @Cacheable(value = \u0026#34;userStatsCache\u0026#34;, key = \u0026#34;\u0026#39;userStats\u0026#39;\u0026#34;) public UserStatistics getCachedUserStatistics() { Long totalUsers = queryFactory.select(qUser.count()) .from(qUser) .fetchOne(); Long activeUsers = queryFactory.select(qUser.count()) .from(qUser) .where(qUser.status.eq(UserStatus.ACTIVE)) .fetchOne(); Double averageSalary = queryFactory.select(qUser.salary.avg()) .from(qUser) .where(qUser.salary.isNotNull() .and(qUser.status.eq(UserStatus.ACTIVE))) .fetchOne(); return new UserStatistics(totalUsers, activeUsers, averageSalary); } /** * æ›´æ–°æ™‚æ¸…é™¤å¿«å– */ @CacheEvict(value = {\u0026#34;userCache\u0026#34;, \u0026#34;departmentUsersCache\u0026#34;, \u0026#34;userStatsCache\u0026#34;}, allEntries = true) public void evictAllCaches() { // æ¸…é™¤æ‰€æœ‰ç›¸é—œå¿«å– } /** * æ¸…é™¤ç‰¹å®šç”¨æˆ¶å¿«å– */ @CacheEvict(value = \u0026#34;userCache\u0026#34;, key = \u0026#34;#userId\u0026#34;) public void evictUserCache(Long userId) { // æ¸…é™¤ç‰¹å®šç”¨æˆ¶å¿«å– } } æ¸¬è©¦ç­–ç•¥ 1. å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 /** * QueryDSL å–®å…ƒæ¸¬è©¦ */ @DataJpaTest @TestPropertySource(locations = \u0026#34;classpath:application-test.properties\u0026#34;) class QueryDSLServiceTest { @Autowired private TestEntityManager entityManager; @Autowired private UserRepository userRepository; private JPAQueryFactory queryFactory; private UserService userService; @BeforeEach void setUp() { queryFactory = new JPAQueryFactory(entityManager.getEntityManager()); userService = new UserService(); ReflectionTestUtils.setField(userService, \u0026#34;queryFactory\u0026#34;, queryFactory); ReflectionTestUtils.setField(userService, \u0026#34;userRepository\u0026#34;, userRepository); } @Test @DisplayName(\u0026#34;æ ¹æ“šç”¨æˆ¶åæŸ¥æ‰¾ç”¨æˆ¶\u0026#34;) void testFindByUsername() { // Given User user = new User(\u0026#34;testuser\u0026#34;, \u0026#34;test@example.com\u0026#34;, \u0026#34;Test\u0026#34;, \u0026#34;User\u0026#34;, 25); user.setStatus(UserStatus.ACTIVE); entityManager.persistAndFlush(user); // When Optional\u0026lt;User\u0026gt; result = userService.findByUsername(\u0026#34;testuser\u0026#34;); // Then assertThat(result).isPresent(); assertThat(result.get().getUsername()).isEqualTo(\u0026#34;testuser\u0026#34;); assertThat(result.get().getEmail()).isEqualTo(\u0026#34;test@example.com\u0026#34;); } @Test @DisplayName(\u0026#34;å¤šæ¢ä»¶æŸ¥è©¢ç”¨æˆ¶\u0026#34;) void testFindUsersByConditions() { // Given Department department = new Department(\u0026#34;IT\u0026#34;, \u0026#34;Information Technology\u0026#34;, 100000.0); entityManager.persistAndFlush(department); User user1 = new User(\u0026#34;john\u0026#34;, \u0026#34;john@example.com\u0026#34;, \u0026#34;John\u0026#34;, \u0026#34;Doe\u0026#34;, 30); user1.setStatus(UserStatus.ACTIVE); user1.setDepartment(department); User user2 = new User(\u0026#34;jane\u0026#34;, \u0026#34;jane@example.com\u0026#34;, \u0026#34;Jane\u0026#34;, \u0026#34;Smith\u0026#34;, 25); user2.setStatus(UserStatus.INACTIVE); user2.setDepartment(department); entityManager.persistAndFlush(user1); entityManager.persistAndFlush(user2); // When List\u0026lt;User\u0026gt; activeUsers = userService.findUsersByConditions( null, null, 20, 35, UserStatus.ACTIVE); // Then assertThat(activeUsers).hasSize(1); assertThat(activeUsers.get(0).getUsername()).isEqualTo(\u0026#34;john\u0026#34;); } @Test @DisplayName(\u0026#34;æ¸¬è©¦ Join æŸ¥è©¢\u0026#34;) void testJoinQuery() { // Given Department department = new Department(\u0026#34;HR\u0026#34;, \u0026#34;Human Resources\u0026#34;, 80000.0); entityManager.persistAndFlush(department); User user = new User(\u0026#34;hr_user\u0026#34;, \u0026#34;hr@example.com\u0026#34;, \u0026#34;HR\u0026#34;, \u0026#34;Manager\u0026#34;, 35); user.setStatus(UserStatus.ACTIVE); user.setDepartment(department); entityManager.persistAndFlush(user); // When QUser qUser = QUser.user; QDepartment qDepartment = QDepartment.department; List\u0026lt;User\u0026gt; users = queryFactory.selectFrom(qUser) .innerJoin(qUser.department, qDepartment).fetchJoin() .where(qDepartment.name.eq(\u0026#34;HR\u0026#34;)) .fetch(); // Then assertThat(users).hasSize(1); assertThat(users.get(0).getDepartment().getName()).isEqualTo(\u0026#34;HR\u0026#34;); } @Test @DisplayName(\u0026#34;æ¸¬è©¦èšåˆæŸ¥è©¢\u0026#34;) void testAggregationQuery() { // Given Department department = new Department(\u0026#34;Sales\u0026#34;, \u0026#34;Sales Department\u0026#34;, 120000.0); entityManager.persistAndFlush(department); User user1 = new User(\u0026#34;sales1\u0026#34;, \u0026#34;sales1@example.com\u0026#34;, \u0026#34;Sales\u0026#34;, \u0026#34;Rep1\u0026#34;, 28); user1.setStatus(UserStatus.ACTIVE); user1.setDepartment(department); user1.setSalary(50000.0); User user2 = new User(\u0026#34;sales2\u0026#34;, \u0026#34;sales2@example.com\u0026#34;, \u0026#34;Sales\u0026#34;, \u0026#34;Rep2\u0026#34;, 32); user2.setStatus(UserStatus.ACTIVE); user2.setDepartment(department); user2.setSalary(60000.0); entityManager.persistAndFlush(user1); entityManager.persistAndFlush(user2); // When QUser qUser = QUser.user; QDepartment qDepartment = QDepartment.department; Tuple result = queryFactory.select( qDepartment.name, qUser.count(), qUser.salary.avg()) .from(qUser) .innerJoin(qUser.department, qDepartment) .where(qDepartment.name.eq(\u0026#34;Sales\u0026#34;)) .groupBy(qDepartment.name) .fetchOne(); // Then assertThat(result).isNotNull(); assertThat(result.get(qDepartment.name)).isEqualTo(\u0026#34;Sales\u0026#34;); assertThat(result.get(qUser.count())).isEqualTo(2L); assertThat(result.get(qUser.salary.avg())).isEqualTo(55000.0); } } 2. æ•´åˆæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 /** * QueryDSL æ•´åˆæ¸¬è©¦ */ @SpringBootTest @Transactional @TestPropertySource(locations = \u0026#34;classpath:application-integration-test.properties\u0026#34;) class QueryDSLIntegrationTest { @Autowired private UserService userService; @Autowired private UserRepository userRepository; @Autowired private DepartmentRepository departmentRepository; @Test @DisplayName(\u0026#34;å®Œæ•´çš„ç”¨æˆ¶ç®¡ç†æµç¨‹æ¸¬è©¦\u0026#34;) void testCompleteUserManagementFlow() { // 1. å‰µå»ºéƒ¨é–€ Department department = new Department(\u0026#34;Engineering\u0026#34;, \u0026#34;Software Engineering\u0026#34;, 200000.0); department = departmentRepository.save(department); // 2. å‰µå»ºç”¨æˆ¶ User user1 = new User(\u0026#34;engineer1\u0026#34;, \u0026#34;eng1@example.com\u0026#34;, \u0026#34;John\u0026#34;, \u0026#34;Engineer\u0026#34;, 30); user1.setStatus(UserStatus.ACTIVE); user1.setSalary(80000.0); user1.setDepartment(department); User user2 = new User(\u0026#34;engineer2\u0026#34;, \u0026#34;eng2@example.com\u0026#34;, \u0026#34;Jane\u0026#34;, \u0026#34;Developer\u0026#34;, 28); user2.setStatus(UserStatus.ACTIVE); user2.setSalary(75000.0); user2.setDepartment(department); userRepository.saveAll(Arrays.asList(user1, user2)); // 3. æ¸¬è©¦æŸ¥è©¢ List\u0026lt;User\u0026gt; engineers = userService.findUsersByConditions( null, null, 25, 35, UserStatus.ACTIVE); assertThat(engineers).hasSize(2); // 4. æ¸¬è©¦æ›´æ–° UserUpdateService updateService = new UserUpdateService(); // è¨­å®š queryFactory... long updatedCount = updateService.updateSalaryByDepartment( department.getId(), 5000.0); assertThat(updatedCount).isEqualTo(2); // 5. é©—è­‰æ›´æ–°çµæœ List\u0026lt;User\u0026gt; updatedUsers = userRepository.findAll(); assertThat(updatedUsers.stream() .mapToDouble(User::getSalary) .average() .orElse(0.0)) .isEqualTo(82500.0); // (85000 + 80000) / 2 } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. æŸ¥è©¢å„ªåŒ–å»ºè­° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 /** * QueryDSL æœ€ä½³å¯¦è¸æŒ‡å— */ @Component public class QueryDSLBestPractices { /** * 1. ä½¿ç”¨é©ç•¶çš„ Fetch ç­–ç•¥ */ public void demonstrateFetchStrategies() { // âœ… æ¨è–¦ï¼šä½¿ç”¨ fetchJoin é¿å… N+1 å•é¡Œ List\u0026lt;User\u0026gt; usersWithDepartment = queryFactory.selectFrom(qUser) .leftJoin(qUser.department, qDepartment).fetchJoin() .fetch(); // âŒ é¿å…ï¼šä¸ä½¿ç”¨ fetchJoin æœƒå°è‡´ N+1 å•é¡Œ List\u0026lt;User\u0026gt; users = queryFactory.selectFrom(qUser).fetch(); // å¾ŒçºŒå­˜å– user.getDepartment() æœƒè§¸ç™¼é¡å¤–æŸ¥è©¢ } /** * 2. ä½¿ç”¨æŠ•å½±æ¸›å°‘è¨˜æ†¶é«”ä½¿ç”¨ */ public void demonstrateProjections() { // âœ… æ¨è–¦ï¼šåªé¸æ“‡éœ€è¦çš„æ¬„ä½ List\u0026lt;UserSummaryDTO\u0026gt; summaries = queryFactory .select(Projections.constructor(UserSummaryDTO.class, qUser.id, qUser.username, qUser.email)) .from(qUser) .fetch(); // âŒ é¿å…ï¼šé¸æ“‡æ•´å€‹å¯¦é«”ä½†åªä½¿ç”¨éƒ¨åˆ†æ¬„ä½ List\u0026lt;User\u0026gt; allUsers = queryFactory.selectFrom(qUser).fetch(); } /** * 3. åˆç†ä½¿ç”¨ç´¢å¼• */ public void demonstrateIndexUsage() { // âœ… æ¨è–¦ï¼šæŸ¥è©¢æ¢ä»¶ä½¿ç”¨æœ‰ç´¢å¼•çš„æ¬„ä½ List\u0026lt;User\u0026gt; usersByUsername = queryFactory.selectFrom(qUser) .where(qUser.username.eq(\u0026#34;john\u0026#34;)) // username æœ‰ç´¢å¼• .fetch(); // âŒ é¿å…ï¼šåœ¨æ²’æœ‰ç´¢å¼•çš„æ¬„ä½ä¸Šä½¿ç”¨ LIKE æŸ¥è©¢ List\u0026lt;User\u0026gt; usersByDescription = queryFactory.selectFrom(qUser) .where(qUser.email.contains(\u0026#34;@gmail\u0026#34;)) // å¯èƒ½æ•ˆèƒ½è¼ƒå·® .fetch(); } /** * 4. æ‰¹é‡æ“ä½œå„ªåŒ– */ public void demonstrateBatchOperations() { // âœ… æ¨è–¦ï¼šä½¿ç”¨æ‰¹é‡æ›´æ–° long updated = queryFactory.update(qUser) .set(qUser.status, UserStatus.ACTIVE) .where(qUser.id.in(Arrays.asList(1L, 2L, 3L))) .execute(); // âŒ é¿å…ï¼šè¿´åœˆä¸­é€²è¡Œå–®å€‹æ›´æ–° for (Long id : Arrays.asList(1L, 2L, 3L)) { queryFactory.update(qUser) .set(qUser.status, UserStatus.ACTIVE) .where(qUser.id.eq(id)) .execute(); // å¤šæ¬¡è³‡æ–™åº«å¾€è¿” } } /** * 5. åˆ†é æŸ¥è©¢å„ªåŒ– */ public void demonstratePaginationOptimization() { // âœ… æ¨è–¦ï¼šå…ˆæŸ¥ç¸½æ•¸ï¼Œå†æŸ¥åˆ†é è³‡æ–™ Long total = queryFactory.select(qUser.count()) .from(qUser) .where(qUser.status.eq(UserStatus.ACTIVE)) .fetchOne(); if (total \u0026gt; 0) { List\u0026lt;User\u0026gt; users = queryFactory.selectFrom(qUser) .where(qUser.status.eq(UserStatus.ACTIVE)) .offset(0) .limit(20) .fetch(); } // âŒ é¿å…ï¼šä½¿ç”¨è¤‡é›œçš„å­æŸ¥è©¢é€²è¡Œåˆ†é  } } 2. éŒ¯èª¤è™•ç†èˆ‡é™¤éŒ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 /** * QueryDSL éŒ¯èª¤è™•ç†æŒ‡å— */ @Component public class QueryDSLErrorHandling { private static final Logger logger = LoggerFactory.getLogger(QueryDSLErrorHandling.class); /** * å®‰å…¨çš„æŸ¥è©¢åŸ·è¡Œ */ public Optional\u0026lt;User\u0026gt; safeQueryExecution(Long userId) { try { User user = queryFactory.selectFrom(qUser) .where(qUser.id.eq(userId)) .fetchOne(); return Optional.ofNullable(user); } catch (DataAccessException e) { logger.error(\u0026#34;Database error while fetching user with id: {}\u0026#34;, userId, e); return Optional.empty(); } catch (Exception e) { logger.error(\u0026#34;Unexpected error while fetching user with id: {}\u0026#34;, userId, e); throw new ServiceException(\u0026#34;Failed to fetch user\u0026#34;, e); } } /** * æŸ¥è©¢é™¤éŒ¯è¼”åŠ©æ–¹æ³• */ public void debugQuery() { // é–‹å•Ÿ SQL æ—¥èªŒè¨˜éŒ„ JPAQuery\u0026lt;User\u0026gt; query = queryFactory.selectFrom(qUser) .where(qUser.status.eq(UserStatus.ACTIVE)); // å°å‡ºç”Ÿæˆçš„ SQL logger.debug(\u0026#34;Generated SQL: {}\u0026#34;, query.toString()); // åŸ·è¡ŒæŸ¥è©¢ List\u0026lt;User\u0026gt; results = query.fetch(); logger.debug(\u0026#34;Query returned {} results\u0026#34;, results.size()); } /** * é©—è­‰æŸ¥è©¢åƒæ•¸ */ public List\u0026lt;User\u0026gt; validateAndQuery(UserSearchCriteria criteria) { // åƒæ•¸é©—è­‰ if (criteria == null) { throw new IllegalArgumentException(\u0026#34;Search criteria cannot be null\u0026#34;); } BooleanBuilder builder = new BooleanBuilder(); // å®‰å…¨çš„å­—ä¸²è™•ç† if (criteria.getUsername() != null) { String cleanUsername = criteria.getUsername().trim(); if (!cleanUsername.isEmpty()) { builder.and(qUser.username.containsIgnoreCase(cleanUsername)); } } // æ•¸å€¼ç¯„åœé©—è­‰ if (criteria.getMinAge() != null \u0026amp;\u0026amp; criteria.getMaxAge() != null) { if (criteria.getMinAge() \u0026gt; criteria.getMaxAge()) { throw new IllegalArgumentException(\u0026#34;Min age cannot be greater than max age\u0026#34;); } } return queryFactory.selectFrom(qUser) .where(builder) .fetch(); } } ç¸½çµ QueryDSL æ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§çš„é¡å‹å®‰å…¨æŸ¥è©¢æ¡†æ¶ï¼Œç‚º Java é–‹ç™¼è€…æä¾›äº†é«˜æ•ˆçš„å‹•æ…‹æŸ¥è©¢è§£æ±ºæ–¹æ¡ˆï¼š\nä¸»è¦å„ªå‹¢ é¡å‹å®‰å…¨ï¼šç·¨è­¯æ™‚æª¢æŸ¥ï¼Œæ¸›å°‘åŸ·è¡ŒæœŸéŒ¯èª¤ IDE å‹å¥½ï¼šå®Œæ•´çš„è‡ªå‹•å®Œæˆå’Œé‡æ§‹æ”¯æ´ çµ±ä¸€ APIï¼šæ”¯æ´å¤šç¨®è³‡æ–™æºçš„ä¸€è‡´æŸ¥è©¢ä»‹é¢ æ•ˆèƒ½å„ªåŒ–ï¼šç”Ÿæˆé«˜æ•ˆçš„ SQL æŸ¥è©¢èªå¥ å‹•æ…‹æŸ¥è©¢ï¼šéˆæ´»çš„æ¢ä»¶çµ„åˆå’ŒæŸ¥è©¢å»ºæ§‹ é©ç”¨å ´æ™¯ è¤‡é›œå‹•æ…‹æŸ¥è©¢ï¼šå¤šæ¢ä»¶çµ„åˆæŸ¥è©¢ å ±è¡¨ç³»çµ±ï¼šè¤‡é›œçš„èšåˆå’Œçµ±è¨ˆæŸ¥è©¢ æœå°‹åŠŸèƒ½ï¼šéˆæ´»çš„æœå°‹æ¢ä»¶çµ„åˆ è³‡æ–™åˆ†æï¼šå¤§é‡çš„è³‡æ–™è™•ç†å’Œåˆ†æ API é–‹ç™¼ï¼šRESTful API çš„æŸ¥è©¢åƒæ•¸è™•ç† æœ€ä½³å¯¦è¸è¦é» æ•ˆèƒ½å„ªåŒ–ï¼šåˆç†ä½¿ç”¨ Fetch Join å’ŒæŠ•å½± ç´¢å¼•åˆ©ç”¨ï¼šæŸ¥è©¢æ¢ä»¶å°æ‡‰é©ç•¶çš„è³‡æ–™åº«ç´¢å¼• æ‰¹é‡æ“ä½œï¼šä½¿ç”¨æ‰¹é‡æ›´æ–°å’Œåˆªé™¤æ“ä½œ éŒ¯èª¤è™•ç†ï¼šå®Œå–„çš„ç•°å¸¸è™•ç†å’Œæ—¥èªŒè¨˜éŒ„ æ¸¬è©¦è¦†è“‹ï¼šå……åˆ†çš„å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦ é€šéæŒæ¡ QueryDSL çš„ä½¿ç”¨æŠ€å·§å’Œæœ€ä½³å¯¦è¸ï¼Œå¯ä»¥å¤§å¹…æå‡ Java æ‡‰ç”¨ç¨‹å¼çš„æŸ¥è©¢æ•ˆç‡å’Œé–‹ç™¼é«”é©—ï¼Œå»ºæ§‹å‡ºé«˜æ•ˆèƒ½ã€å¯ç¶­è­·çš„è³‡æ–™å­˜å–å±¤ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/querydsl/","tags":["QueryDSL","JPA","Spring Data","Database","Query Builder","Type Safety","Criteria API","Dynamic Query","Performance"],"title":"QueryDSL å®Œæ•´å¯¦æˆ°æŒ‡å—ï¼šé¡å‹å®‰å…¨çš„å‹•æ…‹æŸ¥è©¢è§£æ±ºæ–¹æ¡ˆ"},{"content":"Kotlin lateinit å®Œæ•´å¯¦ä½œæŒ‡å— ç°¡ä»‹ åœ¨ Kotlin é–‹ç™¼ä¸­ï¼Œlateinit é—œéµå­—æä¾›äº†ä¸€ç¨®å»¶é²åˆå§‹åŒ–å±¬æ€§çš„å„ªé›…æ–¹å¼ï¼Œç‰¹åˆ¥é©ç”¨æ–¼ä¾è³´æ³¨å…¥ã€Android é–‹ç™¼å’Œ Spring Boot æ‡‰ç”¨ã€‚æœ¬æ–‡å°‡æ·±å…¥æ¢è¨ lateinit çš„å·¥ä½œåŸç†ã€ä½¿ç”¨å ´æ™¯ã€èˆ‡ lazy çš„æ¯”è¼ƒï¼Œä»¥åŠåœ¨ä¼æ¥­ç´šé–‹ç™¼ä¸­çš„æœ€ä½³å¯¦è¸ã€‚\nlateinit åŸºæœ¬æ¦‚å¿µ æ ¸å¿ƒç‰¹æ€§ lateinit æ˜¯ Kotlin æä¾›çš„å»¶é²åˆå§‹åŒ–ä¿®é£¾ç¬¦ï¼Œå…è¨±é–‹ç™¼è€…è²æ˜éç©ºå±¬æ€§è€Œä¸éœ€è¦ç«‹å³åˆå§‹åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 class UserService { // å»¶é²åˆå§‹åŒ–ï¼Œé¿å…ç©ºå€¼æª¢æŸ¥ lateinit var userRepository: UserRepository lateinit var cacheManager: CacheManager fun initializeServices() { userRepository = UserRepositoryImpl() cacheManager = RedisCacheManager() } fun findUser(id: Long): User { // ç›´æ¥ä½¿ç”¨ï¼Œç„¡éœ€ç©ºå€¼æª¢æŸ¥ return userRepository.findById(id) ?: throw UserNotFoundException(id) } } èªæ³•è¦å‰‡èˆ‡é™åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 class PropertyRules { // âœ… æ­£ç¢ºï¼švar å±¬æ€§ lateinit var validProperty: String // âŒ éŒ¯èª¤ï¼šlateinit ä¸èƒ½ç”¨æ–¼ val // lateinit val invalidProperty: String // ç·¨è­¯éŒ¯èª¤ // âŒ éŒ¯èª¤ï¼šåŸå§‹é¡å‹ä¸æ”¯æ´ // lateinit var invalidInt: Int // ç·¨è­¯éŒ¯èª¤ // âŒ éŒ¯èª¤ï¼šå¯ç©ºé¡å‹ä¸æ”¯æ´ // lateinit var invalidNullable: String? // ç·¨è­¯éŒ¯èª¤ // âœ… æ­£ç¢ºï¼šè‡ªå®šç¾©é¡åˆ¥ lateinit var database: Database // âœ… æ­£ç¢ºï¼šä»‹é¢é¡å‹ lateinit var service: ServiceInterface } lateinit è©³ç´°æ©Ÿåˆ¶ å…§éƒ¨å¯¦ç¾åŸç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // Kotlin ç·¨è­¯å¾Œçš„ Java ç­‰æ•ˆä»£ç¢¼ public class UserService { private String name; public final String getName() { String var1 = this.name; if (var1 == null) { Intrinsics.throwUninitializedPropertyAccessException(\u0026#34;name\u0026#34;); } return var1; } public final void setName(String value) { Intrinsics.checkNotNullParameter(value, \u0026#34;value\u0026#34;); this.name = value; } } åˆå§‹åŒ–æª¢æŸ¥æ©Ÿåˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 class InitializationChecker { lateinit var database: Database lateinit var config: AppConfig fun checkInitialization() { // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ– if (::database.isInitialized) { println(\u0026#34;Database is ready\u0026#34;) } else { println(\u0026#34;Database not initialized\u0026#34;) } // å®‰å…¨åˆå§‹åŒ–æ¨¡å¼ if (!::config.isInitialized) { config = loadDefaultConfig() } } fun safeAccess(): String { return if (::database.isInitialized) { database.getConnectionInfo() } else { \u0026#34;Database not available\u0026#34; } } } ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯ 1. Spring Boot ä¾è³´æ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 @Service class UserManagementService { @Autowired lateinit var userRepository: UserRepository @Autowired lateinit var emailService: EmailService @Autowired lateinit var auditService: AuditService @Value(\u0026#34;\\${app.user.max-login-attempts}\u0026#34;) lateinit var maxLoginAttempts: String @PostConstruct fun validateDependencies() { require(::userRepository.isInitialized) { \u0026#34;UserRepository not injected\u0026#34; } require(::emailService.isInitialized) { \u0026#34;EmailService not injected\u0026#34; } require(::auditService.isInitialized) { \u0026#34;AuditService not injected\u0026#34; } logger.info(\u0026#34;All dependencies initialized successfully\u0026#34;) } fun createUser(userData: UserCreateRequest): User { val user = User( email = userData.email, username = userData.username, hashedPassword = hashPassword(userData.password) ) val savedUser = userRepository.save(user) // ç™¼é€æ­¡è¿éƒµä»¶ emailService.sendWelcomeEmail(savedUser) // è¨˜éŒ„å¯©è¨ˆæ—¥èªŒ auditService.logUserCreation(savedUser) return savedUser } companion object { private val logger = LoggerFactory.getLogger(UserManagementService::class.java) } } 2. Android é–‹ç™¼ä¸­çš„æ‡‰ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 class MainActivity : AppCompatActivity() { // View å…ƒä»¶å»¶é²åˆå§‹åŒ– lateinit var recyclerView: RecyclerView lateinit var adapter: UserAdapter lateinit var viewModel: UserViewModel // ç¶²è·¯å…ƒä»¶ lateinit var apiService: ApiService lateinit var networkManager: NetworkManager override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContentView(R.layout.activity_main) initializeViews() initializeNetwork() initializeViewModel() setupObservers() } private fun initializeViews() { recyclerView = findViewById(R.id.recyclerView) adapter = UserAdapter { user -\u0026gt; onUserClicked(user) } recyclerView.adapter = adapter recyclerView.layoutManager = LinearLayoutManager(this) } private fun initializeNetwork() { apiService = RetrofitBuilder.createApiService() networkManager = NetworkManager(this) } private fun initializeViewModel() { viewModel = ViewModelProvider(this)[UserViewModel::class.java] } private fun setupObservers() { // ç¢ºä¿æ‰€æœ‰å…ƒä»¶éƒ½å·²åˆå§‹åŒ– require(::viewModel.isInitialized) { \u0026#34;ViewModel not initialized\u0026#34; } require(::adapter.isInitialized) { \u0026#34;Adapter not initialized\u0026#34; } viewModel.users.observe(this) { users -\u0026gt; adapter.submitList(users) } viewModel.loading.observe(this) { isLoading -\u0026gt; // è™•ç†è¼‰å…¥ç‹€æ…‹ } } private fun onUserClicked(user: User) { if (::networkManager.isInitialized \u0026amp;\u0026amp; networkManager.isConnected()) { // è™•ç†ç”¨æˆ¶é»æ“Šäº‹ä»¶ viewModel.loadUserDetails(user.id) } else { showNoNetworkError() } } } 3. é…ç½®ç®¡ç†ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 @Component class ConfigurationManager { @Value(\u0026#34;\\${database.url}\u0026#34;) lateinit var databaseUrl: String @Value(\u0026#34;\\${database.username}\u0026#34;) lateinit var databaseUsername: String @Value(\u0026#34;\\${redis.host}\u0026#34;) lateinit var redisHost: String @Value(\u0026#34;\\${jwt.secret}\u0026#34;) lateinit var jwtSecret: String lateinit var databaseConfig: DatabaseConfig lateinit var redisConfig: RedisConfig lateinit var securityConfig: SecurityConfig @PostConstruct fun initializeConfigurations() { validateRequiredProperties() buildConfigurations() logConfigurationStatus() } private fun validateRequiredProperties() { val errors = mutableListOf\u0026lt;String\u0026gt;() if (!::databaseUrl.isInitialized || databaseUrl.isBlank()) { errors.add(\u0026#34;Database URL not configured\u0026#34;) } if (!::databaseUsername.isInitialized || databaseUsername.isBlank()) { errors.add(\u0026#34;Database username not configured\u0026#34;) } if (!::redisHost.isInitialized || redisHost.isBlank()) { errors.add(\u0026#34;Redis host not configured\u0026#34;) } if (!::jwtSecret.isInitialized || jwtSecret.isBlank()) { errors.add(\u0026#34;JWT secret not configured\u0026#34;) } if (errors.isNotEmpty()) { throw ConfigurationException(\u0026#34;Configuration errors: ${errors.joinToString(\u0026#34;, \u0026#34;)}\u0026#34;) } } private fun buildConfigurations() { databaseConfig = DatabaseConfig( url = databaseUrl, username = databaseUsername, maxPoolSize = 20, connectionTimeout = Duration.ofSeconds(30) ) redisConfig = RedisConfig( host = redisHost, port = 6379, timeout = Duration.ofSeconds(10) ) securityConfig = SecurityConfig( jwtSecret = jwtSecret, tokenExpiration = Duration.ofHours(24), refreshTokenExpiration = Duration.ofDays(7) ) } private fun logConfigurationStatus() { logger.info(\u0026#34;Configuration initialized successfully:\u0026#34;) logger.info(\u0026#34;- Database: ${databaseConfig.url}\u0026#34;) logger.info(\u0026#34;- Redis: ${redisConfig.host}:${redisConfig.port}\u0026#34;) logger.info(\u0026#34;- Security: JWT configured with ${securityConfig.tokenExpiration} expiration\u0026#34;) } fun getDatabaseConfig(): DatabaseConfig { require(::databaseConfig.isInitialized) { \u0026#34;Database configuration not initialized\u0026#34; } return databaseConfig } fun getRedisConfig(): RedisConfig { require(::redisConfig.isInitialized) { \u0026#34;Redis configuration not initialized\u0026#34; } return redisConfig } fun getSecurityConfig(): SecurityConfig { require(::securityConfig.isInitialized) { \u0026#34;Security configuration not initialized\u0026#34; } return securityConfig } companion object { private val logger = LoggerFactory.getLogger(ConfigurationManager::class.java) } } lateinit vs lazy è©³ç´°æ¯”è¼ƒ ç‰¹æ€§å°æ¯”è¡¨ ç‰¹æ€§ lateinit lazy åˆå§‹åŒ–æ™‚æ©Ÿ æ‰‹å‹•æ§åˆ¶ é¦–æ¬¡è¨ªå•æ™‚ ç·šç¨‹å®‰å…¨ å¦ æ˜¯ï¼ˆé è¨­ï¼‰ å¯è®Šæ€§ varï¼ˆå¯é‡æ–°è³¦å€¼ï¼‰ valï¼ˆä¸å¯è®Šï¼‰ åˆå§‹åŒ–æª¢æŸ¥ ::property.isInitialized ç„¡éœ€æª¢æŸ¥ è¨˜æ†¶é«”é–‹éŠ· ä½ ç•¥é«˜ï¼ˆLazyåŒ…è£ï¼‰ é©ç”¨å ´æ™¯ ä¾è³´æ³¨å…¥ã€å¤–éƒ¨åˆå§‹åŒ– å»¶é²è¨ˆç®—ã€é«˜é–‹éŠ·æ“ä½œ ä½¿ç”¨å ´æ™¯æ¯”è¼ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 class ComparisonExample { // lateinitï¼šé©åˆä¾è³´æ³¨å…¥ @Autowired lateinit var repository: UserRepository // lazyï¼šé©åˆè¨ˆç®—å¯†é›†å‹åˆå§‹åŒ– private val expensiveResource: DatabaseConnection by lazy { createDatabaseConnection() // åƒ…åœ¨é¦–æ¬¡ä½¿ç”¨æ™‚åŸ·è¡Œ } // lateinitï¼šå¯é‡æ–°è³¦å€¼ lateinit var currentUser: User fun switchUser(newUser: User) { currentUser = newUser // å¯ä»¥é‡æ–°è³¦å€¼ } // lazyï¼šç·šç¨‹å®‰å…¨çš„å–®ä¾‹åˆå§‹åŒ– private val singleton: ServiceManager by lazy(LazyThreadSafetyMode.SYNCHRONIZED) { ServiceManager.create() } // lateinitï¼šæ‰‹å‹•æ§åˆ¶åˆå§‹åŒ–æ™‚æ©Ÿ lateinit var testDatabase: TestDatabase @BeforeEach fun setupTest() { testDatabase = createTestDatabase() } @AfterEach fun cleanupTest() { if (::testDatabase.isInitialized) { testDatabase.cleanup() } } } é€²éšä½¿ç”¨æ¨¡å¼ 1. æ¢ä»¶åˆå§‹åŒ–æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 class ConditionalInitialization { lateinit var primaryDatabase: Database lateinit var secondaryDatabase: Database fun initializeDatabases(config: DatabaseConfig) { // ä¸»è³‡æ–™åº«ç¸½æ˜¯åˆå§‹åŒ– primaryDatabase = createDatabase(config.primary) // æ¬¡è¦è³‡æ–™åº«åƒ…åœ¨å•Ÿç”¨æ™‚åˆå§‹åŒ– if (config.enableSecondary) { secondaryDatabase = createDatabase(config.secondary) } } fun executeQuery(query: String): QueryResult { val result = primaryDatabase.execute(query) // å®‰å…¨åœ°ä½¿ç”¨æ¬¡è¦è³‡æ–™åº« if (::secondaryDatabase.isInitialized) { secondaryDatabase.logQuery(query, result) } return result } } 2. åˆå§‹åŒ–éˆæ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 class InitializationChain { lateinit var configService: ConfigService lateinit var databaseService: DatabaseService lateinit var cacheService: CacheService lateinit var businessService: BusinessService fun initializeAll() { initializeConfig() initializeDatabase() initializeCache() initializeBusiness() validateInitialization() } private fun initializeConfig() { configService = ConfigService() logger.info(\u0026#34;Config service initialized\u0026#34;) } private fun initializeDatabase() { require(::configService.isInitialized) { \u0026#34;Config service must be initialized first\u0026#34; } databaseService = DatabaseService(configService.getDatabaseConfig()) logger.info(\u0026#34;Database service initialized\u0026#34;) } private fun initializeCache() { require(::configService.isInitialized) { \u0026#34;Config service must be initialized first\u0026#34; } cacheService = CacheService(configService.getCacheConfig()) logger.info(\u0026#34;Cache service initialized\u0026#34;) } private fun initializeBusiness() { require(::databaseService.isInitialized) { \u0026#34;Database service must be initialized first\u0026#34; } require(::cacheService.isInitialized) { \u0026#34;Cache service must be initialized first\u0026#34; } businessService = BusinessService(databaseService, cacheService) logger.info(\u0026#34;Business service initialized\u0026#34;) } private fun validateInitialization() { val errors = mutableListOf\u0026lt;String\u0026gt;() if (!::configService.isInitialized) errors.add(\u0026#34;ConfigService\u0026#34;) if (!::databaseService.isInitialized) errors.add(\u0026#34;DatabaseService\u0026#34;) if (!::cacheService.isInitialized) errors.add(\u0026#34;CacheService\u0026#34;) if (!::businessService.isInitialized) errors.add(\u0026#34;BusinessService\u0026#34;) if (errors.isNotEmpty()) { throw InitializationException(\u0026#34;æœªåˆå§‹åŒ–çš„æœå‹™: ${errors.joinToString(\u0026#34;, \u0026#34;)}\u0026#34;) } logger.info(\u0026#34;æ‰€æœ‰æœå‹™åˆå§‹åŒ–å®Œæˆ\u0026#34;) } companion object { private val logger = LoggerFactory.getLogger(InitializationChain::class.java) } } 3. è³‡æºç®¡ç†æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 class ResourceManager : AutoCloseable { lateinit var connectionPool: ConnectionPool lateinit var cacheManager: CacheManager lateinit var fileManager: FileManager private val initializedResources = mutableSetOf\u0026lt;String\u0026gt;() fun initializeConnectionPool(config: ConnectionConfig) { connectionPool = ConnectionPool.create(config) initializedResources.add(\u0026#34;connectionPool\u0026#34;) logger.info(\u0026#34;Connection pool initialized with ${config.maxConnections} connections\u0026#34;) } fun initializeCacheManager(config: CacheConfig) { cacheManager = CacheManager.create(config) initializedResources.add(\u0026#34;cacheManager\u0026#34;) logger.info(\u0026#34;Cache manager initialized with ${config.maxSize} max size\u0026#34;) } fun initializeFileManager(config: FileConfig) { fileManager = FileManager.create(config) initializedResources.add(\u0026#34;fileManager\u0026#34;) logger.info(\u0026#34;File manager initialized with root: ${config.rootPath}\u0026#34;) } fun getResourceStatus(): Map\u0026lt;String, Boolean\u0026gt; { return mapOf( \u0026#34;connectionPool\u0026#34; to ::connectionPool.isInitialized, \u0026#34;cacheManager\u0026#34; to ::cacheManager.isInitialized, \u0026#34;fileManager\u0026#34; to ::fileManager.isInitialized ) } override fun close() { logger.info(\u0026#34;é–‹å§‹é—œé–‰è³‡æºç®¡ç†å™¨\u0026#34;) // æŒ‰ç›¸åé †åºé—œé–‰è³‡æº if (::fileManager.isInitialized) { try { fileManager.close() logger.info(\u0026#34;File manager closed\u0026#34;) } catch (e: Exception) { logger.error(\u0026#34;Error closing file manager\u0026#34;, e) } } if (::cacheManager.isInitialized) { try { cacheManager.close() logger.info(\u0026#34;Cache manager closed\u0026#34;) } catch (e: Exception) { logger.error(\u0026#34;Error closing cache manager\u0026#34;, e) } } if (::connectionPool.isInitialized) { try { connectionPool.close() logger.info(\u0026#34;Connection pool closed\u0026#34;) } catch (e: Exception) { logger.error(\u0026#34;Error closing connection pool\u0026#34;, e) } } initializedResources.clear() logger.info(\u0026#34;è³‡æºç®¡ç†å™¨é—œé–‰å®Œæˆ\u0026#34;) } companion object { private val logger = LoggerFactory.getLogger(ResourceManager::class.java) } } æ¸¬è©¦ç­–ç•¥ 1. å–®å…ƒæ¸¬è©¦æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 class UserServiceTest { @Mock lateinit var userRepository: UserRepository @Mock lateinit var emailService: EmailService @InjectMocks lateinit var userService: UserService @BeforeEach fun setup() { MockitoAnnotations.openMocks(this) // é©—è­‰ä¾è³´æ³¨å…¥æ˜¯å¦æˆåŠŸ assertTrue(::userRepository.isInitialized, \u0026#34;UserRepository should be initialized\u0026#34;) assertTrue(::emailService.isInitialized, \u0026#34;EmailService should be initialized\u0026#34;) assertTrue(::userService.isInitialized, \u0026#34;UserService should be initialized\u0026#34;) } @Test fun `should create user successfully`() { // Given val userData = UserCreateRequest( email = \u0026#34;test@example.com\u0026#34;, username = \u0026#34;testuser\u0026#34; ) val expectedUser = User(1L, \u0026#34;test@example.com\u0026#34;, \u0026#34;testuser\u0026#34;) `when`(userRepository.save(any())).thenReturn(expectedUser) doNothing().`when`(emailService).sendWelcomeEmail(any()) // When val result = userService.createUser(userData) // Then assertEquals(expectedUser, result) verify(userRepository).save(any()) verify(emailService).sendWelcomeEmail(expectedUser) } @Test fun `should handle uninitialized dependencies gracefully`() { // æ¸¬è©¦æœªåˆå§‹åŒ–çš„æƒ…æ³ val service = UserService() assertFalse(service::userRepository.isInitialized) assertFalse(service::emailService.isInitialized) assertThrows\u0026lt;UninitializedPropertyAccessException\u0026gt; { service.createUser(UserCreateRequest(\u0026#34;test@example.com\u0026#34;, \u0026#34;test\u0026#34;)) } } } 2. æ•´åˆæ¸¬è©¦æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 @SpringBootTest @TestPropertySource(properties = [ \u0026#34;spring.datasource.url=jdbc:h2:mem:testdb\u0026#34;, \u0026#34;spring.jpa.hibernate.ddl-auto=create-drop\u0026#34; ]) class UserServiceIntegrationTest { @Autowired lateinit var userService: UserService @Autowired lateinit var userRepository: UserRepository @TestConfiguration class TestConfig { @Bean @Primary fun mockEmailService(): EmailService = mockk(relaxed = true) } @Test fun `should initialize all dependencies in Spring context`() { // é©—è­‰ Spring ä¸Šä¸‹æ–‡ä¸­çš„ä¾è³´æ³¨å…¥ assertTrue(userService::userRepository.isInitialized) assertTrue(userService::emailService.isInitialized) // åŸ·è¡Œå¯¦éš›çš„æ¥­å‹™é‚è¼¯æ¸¬è©¦ val userData = UserCreateRequest(\u0026#34;integration@test.com\u0026#34;, \u0026#34;integrationuser\u0026#34;) val result = userService.createUser(userData) assertNotNull(result.id) assertEquals(\u0026#34;integration@test.com\u0026#34;, result.email) assertEquals(\u0026#34;integrationuser\u0026#34;, result.username) // é©—è­‰è³‡æ–™å¯¦éš›å„²å­˜ val savedUser = userRepository.findById(result.id!!) assertTrue(savedUser.isPresent) assertEquals(result.email, savedUser.get().email) } } æ•ˆèƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. è¨˜æ†¶é«”ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 class MemoryOptimizedService { // å¤§å‹ç‰©ä»¶ä½¿ç”¨ lateinit å»¶é²åˆå§‹åŒ– lateinit var largeDataSet: LargeDataSet lateinit var heavyProcessor: HeavyProcessor // å°å‹é…ç½®ç‰©ä»¶å¯ä»¥ç›´æ¥åˆå§‹åŒ– private val config = ServiceConfig() fun initializeHeavyResources() { if (!::largeDataSet.isInitialized) { largeDataSet = LargeDataSet.loadFromDatabase() logger.info(\u0026#34;Large dataset loaded: ${largeDataSet.size} records\u0026#34;) } if (!::heavyProcessor.isInitialized) { heavyProcessor = HeavyProcessor(largeDataSet) logger.info(\u0026#34;Heavy processor initialized\u0026#34;) } } fun processDataIfReady(input: String): String? { return if (::heavyProcessor.isInitialized) { heavyProcessor.process(input) } else { logger.warn(\u0026#34;Heavy processor not initialized, skipping processing\u0026#34;) null } } // æ¸…ç†è³‡æº fun cleanup() { if (::heavyProcessor.isInitialized) { heavyProcessor.cleanup() } if (::largeDataSet.isInitialized) { largeDataSet.cleanup() } } companion object { private val logger = LoggerFactory.getLogger(MemoryOptimizedService::class.java) } } 2. ç·šç¨‹å®‰å…¨è€ƒé‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 class ThreadSafeService { @Volatile lateinit var sharedResource: SharedResource private val initializationLock = ReentrantLock() private val condition = initializationLock.newCondition() fun initializeSharedResource(config: ResourceConfig) { initializationLock.withLock { if (!::sharedResource.isInitialized) { sharedResource = SharedResource.create(config) condition.signalAll() // é€šçŸ¥ç­‰å¾…çš„ç·šç¨‹ logger.info(\u0026#34;Shared resource initialized\u0026#34;) } } } fun accessSharedResource(): String { // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ initializationLock.withLock { while (!::sharedResource.isInitialized) { condition.await(5, TimeUnit.SECONDS) if (!::sharedResource.isInitialized) { throw TimeoutException(\u0026#34;Shared resource initialization timeout\u0026#34;) } } } return sharedResource.getData() } fun isResourceReady(): Boolean { return ::sharedResource.isInitialized } companion object { private val logger = LoggerFactory.getLogger(ThreadSafeService::class.java) } } å¸¸è¦‹é™·é˜±èˆ‡éŒ¯èª¤è™•ç† 1. å¸¸è¦‹éŒ¯èª¤æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 class CommonMistakes { lateinit var service: SomeService // âŒ éŒ¯èª¤ï¼šåœ¨åˆå§‹åŒ–å‰è¨ªå• fun badExample1() { service.doSomething() // UninitializedPropertyAccessException } // âŒ éŒ¯èª¤ï¼šå¿˜è¨˜æª¢æŸ¥åˆå§‹åŒ–ç‹€æ…‹ fun badExample2() { val result = service.getData() // å¯èƒ½æœªåˆå§‹åŒ– return result } // âœ… æ­£ç¢ºï¼šæª¢æŸ¥å¾Œè¨ªå• fun goodExample1() { if (::service.isInitialized) { service.doSomething() } else { logger.warn(\u0026#34;Service not initialized\u0026#34;) } } // âœ… æ­£ç¢ºï¼šé˜²ç¦¦æ€§åˆå§‹åŒ– fun goodExample2(): String { if (!::service.isInitialized) { service = SomeService.createDefault() } return service.getData() } } 2. éŒ¯èª¤è™•ç†ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 class ErrorHandlingService { lateinit var primaryService: PrimaryService lateinit var backupService: BackupService fun processRequest(request: Request): Response { return try { // å˜—è©¦ä½¿ç”¨ä¸»è¦æœå‹™ if (::primaryService.isInitialized) { primaryService.process(request) } else { throw ServiceNotInitializedException(\u0026#34;Primary service not available\u0026#34;) } } catch (e: ServiceNotInitializedException) { logger.warn(\u0026#34;Primary service unavailable, falling back to backup\u0026#34;, e) // å‚™æ´æœå‹™è™•ç† if (::backupService.isInitialized) { backupService.process(request) } else { throw ServiceUnavailableException(\u0026#34;No services available\u0026#34;) } } catch (e: Exception) { logger.error(\u0026#34;Unexpected error processing request\u0026#34;, e) throw ProcessingException(\u0026#34;Failed to process request\u0026#34;, e) } } fun healthCheck(): HealthStatus { val status = HealthStatus() status.primaryServiceAvailable = ::primaryService.isInitialized status.backupServiceAvailable = ::backupService.isInitialized status.overallStatus = when { status.primaryServiceAvailable -\u0026gt; HealthStatus.Status.HEALTHY status.backupServiceAvailable -\u0026gt; HealthStatus.Status.DEGRADED else -\u0026gt; HealthStatus.Status.UNHEALTHY } return status } companion object { private val logger = LoggerFactory.getLogger(ErrorHandlingService::class.java) } } ä¼æ¥­ç´šæœ€ä½³å¯¦è¸ 1. åˆå§‹åŒ–é©—è­‰æ¡†æ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 @Component class InitializationValidator { fun validateObject(obj: Any): ValidationResult { val result = ValidationResult() val clazz = obj::class // ä½¿ç”¨åå°„æª¢æŸ¥æ‰€æœ‰ lateinit å±¬æ€§ clazz.memberProperties .filterIsInstance\u0026lt;KMutableProperty1\u0026lt;Any, Any\u0026gt;\u0026gt;() .filter { it.isLateinit } .forEach { property -\u0026gt; try { if (!property.isInitialized(obj)) { result.addError(\u0026#34;Property \u0026#39;${property.name}\u0026#39; is not initialized\u0026#34;) } else { result.addSuccess(\u0026#34;Property \u0026#39;${property.name}\u0026#39; is initialized\u0026#34;) } } catch (e: Exception) { result.addError(\u0026#34;Error checking property \u0026#39;${property.name}\u0026#39;: ${e.message}\u0026#34;) } } return result } @EventListener fun onApplicationReady(event: ApplicationReadyEvent) { logger.info(\u0026#34;é–‹å§‹é©—è­‰æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–ç‹€æ…‹\u0026#34;) val context = event.applicationContext val beanNames = context.beanDefinitionNames var totalBeans = 0 var validatedBeans = 0 var errorCount = 0 beanNames.forEach { beanName -\u0026gt; try { val bean = context.getBean(beanName) totalBeans++ val result = validateObject(bean) if (result.hasErrors()) { logger.warn(\u0026#34;Bean \u0026#39;$beanName\u0026#39; has initialization issues: ${result.getErrors()}\u0026#34;) errorCount += result.getErrorCount() } else { validatedBeans++ } } catch (e: Exception) { logger.debug(\u0026#34;Skipped validation for bean \u0026#39;$beanName\u0026#39;: ${e.message}\u0026#34;) } } logger.info(\u0026#34;åˆå§‹åŒ–é©—è­‰å®Œæˆ: $validatedBeans/$totalBeans beans validated, $errorCount errors found\u0026#34;) } companion object { private val logger = LoggerFactory.getLogger(InitializationValidator::class.java) } } data class ValidationResult( private val errors: MutableList\u0026lt;String\u0026gt; = mutableListOf(), private val successes: MutableList\u0026lt;String\u0026gt; = mutableListOf() ) { fun addError(error: String) = errors.add(error) fun addSuccess(success: String) = successes.add(success) fun hasErrors() = errors.isNotEmpty() fun getErrors() = errors.toList() fun getSuccesses() = successes.toList() fun getErrorCount() = errors.size } 2. ç›£æ§èˆ‡è¨ºæ–· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 @Component class LateinitMonitor { private val meterRegistry: MeterRegistry = Metrics.globalRegistry private val initializationTimer = Timer.builder(\u0026#34;lateinit.initialization.time\u0026#34;) .description(\u0026#34;Time taken to initialize lateinit properties\u0026#34;) .register(meterRegistry) fun \u0026lt;T\u0026gt; monitorInitialization( propertyName: String, initializer: () -\u0026gt; T ): T { return Timer.Sample.start(meterRegistry).use { sample -\u0026gt; try { val result = initializer() // è¨˜éŒ„æˆåŠŸçš„åˆå§‹åŒ– Counter.builder(\u0026#34;lateinit.initialization.success\u0026#34;) .tag(\u0026#34;property\u0026#34;, propertyName) .register(meterRegistry) .increment() sample.stop(initializationTimer.withTag(\u0026#34;property\u0026#34;, propertyName)) logger.info(\u0026#34;Successfully initialized property: $propertyName\u0026#34;) result } catch (e: Exception) { // è¨˜éŒ„å¤±æ•—çš„åˆå§‹åŒ– Counter.builder(\u0026#34;lateinit.initialization.failure\u0026#34;) .tag(\u0026#34;property\u0026#34;, propertyName) .tag(\u0026#34;error\u0026#34;, e.javaClass.simpleName) .register(meterRegistry) .increment() logger.error(\u0026#34;Failed to initialize property: $propertyName\u0026#34;, e) throw e } } } @Scheduled(fixedRate = 60000) // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ fun reportInitializationStatus() { val successCount = meterRegistry.counter(\u0026#34;lateinit.initialization.success\u0026#34;).count() val failureCount = meterRegistry.counter(\u0026#34;lateinit.initialization.failure\u0026#34;).count() val totalCount = successCount + failureCount if (totalCount \u0026gt; 0) { val successRate = (successCount / totalCount) * 100 logger.info(\u0026#34;Lateinit initialization statistics - Success rate: ${\u0026#34;%.2f\u0026#34;.format(successRate)}% ($successCount/$totalCount)\u0026#34;) } } companion object { private val logger = LoggerFactory.getLogger(LateinitMonitor::class.java) } } æ•ˆèƒ½åŸºæº–æ¸¬è©¦ åˆå§‹åŒ–æ•ˆèƒ½æ¯”è¼ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 @BenchmarkMode(Mode.AverageTime) @OutputTimeUnit(TimeUnit.NANOSECONDS) @State(Scope.Benchmark) class LateinitPerformanceBenchmark { // æ¸¬è©¦é¡åˆ¥ class LateinitExample { lateinit var service: ExpensiveService fun initializeService() { service = ExpensiveService() } } class LazyExample { private val service: ExpensiveService by lazy { ExpensiveService() } fun getService(): ExpensiveService = service } class EagerExample { private val service: ExpensiveService = ExpensiveService() fun getService(): ExpensiveService = service } @Benchmark fun lateinitInitialization(): ExpensiveService { val example = LateinitExample() example.initializeService() return example.service } @Benchmark fun lazyInitialization(): ExpensiveService { val example = LazyExample() return example.getService() } @Benchmark fun eagerInitialization(): ExpensiveService { val example = EagerExample() return example.getService() } @Benchmark fun lateinitAccessAfterInit(): String { val example = LateinitExample() example.initializeService() return example.service.getData() // è¨ªå•å·²åˆå§‹åŒ–çš„å±¬æ€§ } @Benchmark fun lazyAccess(): String { val example = LazyExample() example.getService() // é¦–æ¬¡è¨ªå•ï¼Œè§¸ç™¼åˆå§‹åŒ– return example.getService().getData() // å†æ¬¡è¨ªå•ï¼Œä½¿ç”¨å¿«å–å€¼ } } ç¸½çµ lateinit æ˜¯ Kotlin ä¸­å¼·å¤§çš„å»¶é²åˆå§‹åŒ–æ©Ÿåˆ¶ï¼Œç‰¹åˆ¥é©ç”¨æ–¼ï¼š\nä¾è³´æ³¨å…¥å ´æ™¯ï¼šSpring Bootã€Android ç­‰æ¡†æ¶çš„ä¾è³´æ³¨å…¥ å¤–éƒ¨åˆå§‹åŒ–ï¼šéœ€è¦åœ¨ç‰©ä»¶å‰µå»ºå¾Œç”±å¤–éƒ¨ä»£ç¢¼åˆå§‹åŒ–çš„å±¬æ€§ æ¸¬è©¦å ´æ™¯ï¼šMock ç‰©ä»¶å’Œæ¸¬è©¦è¨­ç½® æ¢ä»¶åˆå§‹åŒ–ï¼šæ ¹æ“šé‹è¡Œæ™‚æ¢ä»¶æ±ºå®šæ˜¯å¦åˆå§‹åŒ–çš„å±¬æ€§ é—œéµæœ€ä½³å¯¦è¸ ç¸½æ˜¯æª¢æŸ¥åˆå§‹åŒ–ç‹€æ…‹ï¼šä½¿ç”¨ ::property.isInitialized é€²è¡Œå®‰å…¨æª¢æŸ¥ æä¾›éŒ¯èª¤è™•ç†ï¼šå¦¥å–„è™•ç† UninitializedPropertyAccessException æ–‡æª”åŒ–åˆå§‹åŒ–éœ€æ±‚ï¼šæ¸…æ¥šèªªæ˜ä½•æ™‚å’Œå¦‚ä½•åˆå§‹åŒ–å±¬æ€§ è€ƒæ…®ç·šç¨‹å®‰å…¨ï¼šåœ¨å¤šç·šç¨‹ç’°å¢ƒä¸­ä½¿ç”¨é©ç•¶çš„åŒæ­¥æ©Ÿåˆ¶ ç›£æ§å’Œè¨ºæ–·ï¼šåœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ç›£æ§åˆå§‹åŒ–ç‹€æ…‹å’Œæ•ˆèƒ½ é¸æ“‡ lateinit é‚„æ˜¯ lazy å–æ±ºæ–¼å…·é«”éœ€æ±‚ï¼šä½¿ç”¨ lateinit é€²è¡Œæ‰‹å‹•æ§åˆ¶çš„å»¶é²åˆå§‹åŒ–ï¼Œä½¿ç”¨ lazy é€²è¡Œè‡ªå‹•çš„æ‡¶åŠ è¼‰ã€‚æ­£ç¢ºä½¿ç”¨é€™äº›æ©Ÿåˆ¶å¯ä»¥é¡¯è‘—æ”¹å–„æ‡‰ç”¨ç¨‹å¼çš„æ•ˆèƒ½å’Œè¨˜æ†¶é«”ä½¿ç”¨æ•ˆç‡ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/lateinit/","tags":["Kotlin","lateinit","lazy","Property Initialization","Android","Spring Boot","Dependency Injection","Performance","Memory Management","Best Practices","Enterprise","Thread Safety","Reflection","Testing"],"title":"Kotlin lateinit å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šå»¶é²åˆå§‹åŒ–èˆ‡ä¼æ¥­ç´šé–‹ç™¼æœ€ä½³å¯¦è¸"},{"content":"æ¦‚è¿° cURLï¼ˆClient URLï¼‰æ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§çš„å‘½ä»¤è¡Œå·¥å…·å’Œå‡½å¼åº«ï¼Œç”¨æ–¼å‚³è¼¸å„ç¨®ç¶²è·¯å”å®šçš„è³‡æ–™ã€‚å®ƒæ”¯æ´ HTTPã€HTTPSã€FTPã€SFTPã€TELNET ç­‰å¤šç¨®å”å®šï¼Œæ˜¯é–‹ç™¼è€…é€²è¡Œ API æ¸¬è©¦ã€ç¶²è·¯é™¤éŒ¯å’Œè‡ªå‹•åŒ–è…³æœ¬çš„å¿…å‚™å·¥å…·ã€‚\næ ¸å¿ƒç‰¹å¾µ å¤šå”å®šæ”¯æ´ï¼šHTTP/HTTPSã€FTPã€SFTPã€SMTPã€POP3 ç­‰ è±å¯Œçš„é¸é …ï¼šæ”¯æ´å„ç¨® HTTP æ–¹æ³•ã€æ¨™é ­ã€èªè­‰æ–¹å¼ è·¨å¹³å°ï¼šé©ç”¨æ–¼ Linuxã€macOSã€Windows ç­‰ç³»çµ± è…³æœ¬å‹å¥½ï¼šè¼¸å‡ºæ ¼å¼åŒ–ï¼Œé©åˆè‡ªå‹•åŒ–è™•ç† å®‰å…¨æ€§ï¼šæ”¯æ´ SSL/TLSã€å„ç¨®èªè­‰æ©Ÿåˆ¶ åŸºæœ¬èªæ³• 1 curl [é¸é …] [URL] ç°¡å–®ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 # åŸºæœ¬ GET è«‹æ±‚ curl https://httpbin.org/get # æŸ¥çœ‹ HTTP éŸ¿æ‡‰æ¨™é ­ curl -I https://google.com # ä¸‹è¼‰æª”æ¡ˆ curl -o filename.html https://example.com # éœé»˜æ¨¡å¼ curl -s https://api.github.com/users/octocat æ ¸å¿ƒé¸é …è©³è§£ åŸºæœ¬æ“ä½œé¸é … 1 2 3 4 5 6 7 8 9 10 11 12 13 # è¼¸å‡ºæ§åˆ¶ -o, --output \u0026lt;file\u0026gt; # å°‡è¼¸å‡ºå¯«å…¥æª”æ¡ˆ -O, --remote-name # ä½¿ç”¨é ç¨‹æª”æ¡ˆåç¨±å„²å­˜ -s, --silent # éœé»˜æ¨¡å¼ï¼Œä¸é¡¯ç¤ºé€²åº¦ -S, --show-error # é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ -v, --verbose # è©³ç´°è¼¸å‡ºæ¨¡å¼ -w, --write-out \u0026lt;format\u0026gt; # è‡ªè¨‚è¼¸å‡ºæ ¼å¼ # åŸºæœ¬ç¯„ä¾‹ curl -o index.html https://example.com curl -O https://example.com/file.zip curl -s https://api.example.com/data curl -v https://httpbin.org/get HTTP æ–¹æ³•é¸é … 1 2 3 4 5 6 7 8 9 10 11 # è«‹æ±‚æ–¹æ³• -X, --request \u0026lt;method\u0026gt; # æŒ‡å®š HTTP æ–¹æ³• -G, --get # å¼·åˆ¶ä½¿ç”¨ GET æ–¹æ³• -I, --head # åªç²å– HTTP æ¨™é ­ (HEAD æ–¹æ³•) # ç¯„ä¾‹ curl -X POST https://httpbin.org/post curl -X PUT https://httpbin.org/put curl -X DELETE https://httpbin.org/delete curl -X PATCH https://httpbin.org/patch curl -I https://httpbin.org/headers è³‡æ–™å‚³é€é¸é … 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # è³‡æ–™å‚³é€ -d, --data \u0026lt;data\u0026gt; # ç™¼é€ POST è³‡æ–™ -d @filename # å¾æª”æ¡ˆè®€å–è³‡æ–™ -F, --form \u0026lt;name=content\u0026gt; # è¡¨å–®è³‡æ–™ (multipart/form-data) -T, --upload-file \u0026lt;file\u0026gt; # ä¸Šå‚³æª”æ¡ˆ # JSON è³‡æ–™ç¯„ä¾‹ curl -X POST https://httpbin.org/post \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{\u0026#34;name\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;age\u0026#34;: 30}\u0026#39; # è¡¨å–®è³‡æ–™ç¯„ä¾‹ curl -X POST https://httpbin.org/post \\ -F \u0026#34;name=John\u0026#34; \\ -F \u0026#34;file=@upload.txt\u0026#34; # å¾æª”æ¡ˆè®€å–è³‡æ–™ curl -X POST https://httpbin.org/post \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d @data.json HTTP æ¨™é ­é¸é … 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æ¨™é ­è¨­å®š -H, --header \u0026lt;header\u0026gt; # æ·»åŠ è‡ªè¨‚æ¨™é ­ -A, --user-agent \u0026lt;agent\u0026gt; # è¨­å®š User-Agent -e, --referer \u0026lt;URL\u0026gt; # è¨­å®š Referer -i, --include # åœ¨è¼¸å‡ºä¸­åŒ…å«éŸ¿æ‡‰æ¨™é ­ # ç¯„ä¾‹ curl -H \u0026#34;Authorization: Bearer token123\u0026#34; https://api.example.com curl -H \u0026#34;Content-Type: application/json\u0026#34; \\ -H \u0026#34;Accept: application/json\u0026#34; \\ https://api.example.com curl -A \u0026#34;MyApp/1.0\u0026#34; https://httpbin.org/user-agent curl -e \u0026#34;https://google.com\u0026#34; https://httpbin.org/headers curl -i https://httpbin.org/get HTTP æ–¹æ³•æ‡‰ç”¨ GET è«‹æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åŸºæœ¬ GET è«‹æ±‚ curl https://jsonplaceholder.typicode.com/posts # å¸¶æŸ¥è©¢åƒæ•¸çš„ GET curl \u0026#34;https://jsonplaceholder.typicode.com/posts?userId=1\u0026#34; # ä½¿ç”¨ -G å’Œ -d æ§‹å»ºæŸ¥è©¢å­—ä¸² curl -G -d \u0026#34;userId=1\u0026#34; -d \u0026#34;id=1\u0026#34; https://jsonplaceholder.typicode.com/posts # å¸¶èªè­‰çš„ GET curl -H \u0026#34;Authorization: Bearer your-token\u0026#34; https://api.example.com/user # è‡ªè¨‚ User-Agent curl -A \u0026#34;Mozilla/5.0 (Custom Agent)\u0026#34; https://httpbin.org/user-agent POST è«‹æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # JSON è³‡æ–™ POST curl -X POST https://jsonplaceholder.typicode.com/posts \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;title\u0026#34;: \u0026#34;New Post\u0026#34;, \u0026#34;body\u0026#34;: \u0026#34;This is the content\u0026#34;, \u0026#34;userId\u0026#34;: 1 }\u0026#39; # è¡¨å–®è³‡æ–™ POST curl -X POST https://httpbin.org/post \\ -d \u0026#34;username=john\u0026#34; \\ -d \u0026#34;password=secret\u0026#34; # æª”æ¡ˆä¸Šå‚³ POST curl -X POST https://httpbin.org/post \\ -F \u0026#34;file=@document.pdf\u0026#34; \\ -F \u0026#34;description=Important document\u0026#34; # URL ç·¨ç¢¼è³‡æ–™ curl -X POST https://httpbin.org/post \\ -H \u0026#34;Content-Type: application/x-www-form-urlencoded\u0026#34; \\ -d \u0026#34;name=John%20Doe\u0026amp;email=john%40example.com\u0026#34; PUT å’Œ PATCH è«‹æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # PUT æ›´æ–°è³‡æº curl -X PUT https://jsonplaceholder.typicode.com/posts/1 \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;id\u0026#34;: 1, \u0026#34;title\u0026#34;: \u0026#34;Updated Title\u0026#34;, \u0026#34;body\u0026#34;: \u0026#34;Updated content\u0026#34;, \u0026#34;userId\u0026#34;: 1 }\u0026#39; # PATCH éƒ¨åˆ†æ›´æ–° curl -X PATCH https://jsonplaceholder.typicode.com/posts/1 \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{\u0026#34;title\u0026#34;: \u0026#34;Partially Updated Title\u0026#34;}\u0026#39; # æª”æ¡ˆæ›¿æ›ä¸Šå‚³ curl -X PUT https://api.example.com/files/document.pdf \\ -T document.pdf \\ -H \u0026#34;Authorization: Bearer token\u0026#34; DELETE è«‹æ±‚ 1 2 3 4 5 6 7 8 9 10 11 # åŸºæœ¬ DELETE curl -X DELETE https://jsonplaceholder.typicode.com/posts/1 # å¸¶èªè­‰çš„ DELETE curl -X DELETE https://api.example.com/users/123 \\ -H \u0026#34;Authorization: Bearer your-token\u0026#34; # å¸¶ç¢ºèªè³‡æ–™çš„ DELETE curl -X DELETE https://api.example.com/dangerous-action \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{\u0026#34;confirm\u0026#34;: true, \u0026#34;reason\u0026#34;: \u0026#34;No longer needed\u0026#34;}\u0026#39; èªè­‰èˆ‡å®‰å…¨ åŸºæœ¬èªè­‰ 1 2 3 4 5 6 7 8 9 # HTTP Basic Authentication curl -u username:password https://httpbin.org/basic-auth/username/password # å¾æç¤ºè¼¸å…¥å¯†ç¢¼ curl -u username https://httpbin.org/basic-auth/username/password # ä½¿ç”¨ Base64 ç·¨ç¢¼ curl -H \u0026#34;Authorization: Basic $(echo -n username:password | base64)\u0026#34; \\ https://httpbin.org/basic-auth/username/password Bearer Token èªè­‰ 1 2 3 4 5 6 7 8 9 # JWT Token curl -H \u0026#34;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\u0026#34; \\ https://api.example.com/protected # API Key in Header curl -H \u0026#34;X-API-Key: your-api-key\u0026#34; https://api.example.com/data # API Key in Query curl \u0026#34;https://api.example.com/data?api_key=your-api-key\u0026#34; OAuth 2.0 1 2 3 4 5 6 7 8 9 10 # ç²å–å­˜å–ä»¤ç‰Œ curl -X POST https://oauth.example.com/token \\ -H \u0026#34;Content-Type: application/x-www-form-urlencoded\u0026#34; \\ -d \u0026#34;grant_type=client_credentials\u0026#34; \\ -d \u0026#34;client_id=your-client-id\u0026#34; \\ -d \u0026#34;client_secret=your-client-secret\u0026#34; # ä½¿ç”¨å­˜å–ä»¤ç‰Œ curl -H \u0026#34;Authorization: Bearer access-token\u0026#34; \\ https://api.example.com/protected-resource SSL/TLS é¸é … 1 2 3 4 5 6 7 8 9 10 # SSL ç›¸é—œé¸é … -k, --insecure # å…è¨±ä¸å®‰å…¨çš„ SSL é€£æ¥ --cert \u0026lt;certificate\u0026gt; # å®¢æˆ¶ç«¯è­‰æ›¸ --key \u0026lt;private-key\u0026gt; # ç§é‘°æª”æ¡ˆ --cacert \u0026lt;CA-certificate\u0026gt; # CA è­‰æ›¸æª”æ¡ˆ # ç¯„ä¾‹ curl -k https://self-signed.example.com curl --cert client.crt --key client.key https://secure.example.com curl --cacert ca-bundle.crt https://secure.example.com Cookie è™•ç† Cookie åŸºæœ¬æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # ç™¼é€ Cookie curl -b \u0026#34;session=abc123; user=john\u0026#34; https://httpbin.org/cookies # å¾æª”æ¡ˆè®€å– Cookie curl -b cookies.txt https://httpbin.org/cookies # å„²å­˜ Cookie åˆ°æª”æ¡ˆ curl -c cookies.txt https://httpbin.org/cookies/set/session/abc123 # åŒæ™‚è®€å–å’Œå„²å­˜ Cookie curl -b cookies.txt -c cookies.txt https://example.com/login # Cookie Jar æ ¼å¼ curl -b cookie-jar.txt -c cookie-jar.txt https://example.com æœƒè©±ç®¡ç† 1 2 3 4 5 6 7 8 9 # ç™»å…¥ä¸¦ä¿æŒæœƒè©± curl -c session.txt -d \u0026#34;username=john\u0026amp;password=secret\u0026#34; \\ https://example.com/login # ä½¿ç”¨æœƒè©±è¨ªå•å—ä¿è­·é é¢ curl -b session.txt https://example.com/dashboard # ç™»å‡ºä¸¦æ¸…é™¤æœƒè©± curl -b session.txt -c /dev/null https://example.com/logout æª”æ¡ˆå‚³è¼¸ æª”æ¡ˆä¸‹è¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # åŸºæœ¬ä¸‹è¼‰ curl -O https://example.com/file.zip # è‡ªè¨‚æª”æ¡ˆå curl -o myfile.zip https://example.com/file.zip # æ–·é»çºŒå‚³ curl -C - -O https://example.com/largefile.zip # é™åˆ¶ä¸‹è¼‰é€Ÿåº¦ curl --limit-rate 100k -O https://example.com/file.zip # ä¸‹è¼‰å¤šå€‹æª”æ¡ˆ curl -O https://example.com/file1.zip -O https://example.com/file2.zip # ä½¿ç”¨ç¯„åœä¸‹è¼‰ curl -r 0-1023 https://example.com/file.txt # ä¸‹è¼‰å‰ 1024 ä½å…ƒçµ„ æª”æ¡ˆä¸Šå‚³ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # FTP ä¸Šå‚³ curl -T localfile.txt ftp://ftp.example.com/remote/ # HTTP PUT ä¸Šå‚³ curl -T document.pdf https://api.example.com/upload # è¡¨å–®æª”æ¡ˆä¸Šå‚³ curl -F \u0026#34;file=@document.pdf\u0026#34; -F \u0026#34;title=My Document\u0026#34; \\ https://example.com/upload # å¤šæª”æ¡ˆä¸Šå‚³ curl -F \u0026#34;file1=@doc1.pdf\u0026#34; -F \u0026#34;file2=@doc2.pdf\u0026#34; \\ https://example.com/upload # å¸¶é€²åº¦æ¢çš„ä¸Šå‚³ curl -# -T largefile.zip https://api.example.com/upload é€²éšåŠŸèƒ½ è¼¸å‡ºæ ¼å¼åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # è‡ªè¨‚è¼¸å‡ºæ ¼å¼ curl -w \u0026#34;Status: %{http_code}\\nTime: %{time_total}s\\nSize: %{size_download} bytes\\n\u0026#34; \\ -o /dev/null -s https://example.com # å¸¸ç”¨æ ¼å¼è®Šæ•¸ %{http_code} # HTTP ç‹€æ…‹ç¢¼ %{time_total} # ç¸½è€—æ™‚ %{time_connect} # é€£æ¥æ™‚é–“ %{time_starttransfer} # é–‹å§‹å‚³è¼¸æ™‚é–“ %{size_download} # ä¸‹è¼‰å¤§å° %{size_upload} # ä¸Šå‚³å¤§å° %{speed_download} # ä¸‹è¼‰é€Ÿåº¦ %{speed_upload} # ä¸Šå‚³é€Ÿåº¦ # æ•ˆèƒ½æ¸¬è©¦ç¯„ä¾‹ curl -w \u0026#34;@curl-format.txt\u0026#34; -o /dev/null -s https://example.com å»ºç«‹ curl-format.txt æª”æ¡ˆï¼š\n1 2 3 4 5 6 7 8 time_namelookup: %{time_namelookup}s\\n time_connect: %{time_connect}s\\n time_appconnect: %{time_appconnect}s\\n time_pretransfer: %{time_pretransfer}s\\n time_redirect: %{time_redirect}s\\n time_starttransfer: %{time_starttransfer}s\\n ----------\\n time_total: %{time_total}s\\n é‡å®šå‘è™•ç† 1 2 3 4 5 6 7 8 9 10 11 # è·Ÿéš¨é‡å®šå‘ curl -L https://bit.ly/shortened-url # é™åˆ¶é‡å®šå‘æ¬¡æ•¸ curl -L --max-redirs 5 https://example.com # é¡¯ç¤ºé‡å®šå‘éç¨‹ curl -L -v https://bit.ly/shortened-url # ä¸è·Ÿéš¨é‡å®šå‘ï¼ˆé è¨­ï¼‰ curl https://bit.ly/shortened-url ä»£ç†è¨­å®š 1 2 3 4 5 6 7 8 9 10 11 12 13 # HTTP ä»£ç† curl --proxy http://proxy.example.com:8080 https://httpbin.org/ip # SOCKS ä»£ç† curl --socks5 localhost:1080 https://httpbin.org/ip # ä»£ç†èªè­‰ curl --proxy-user username:password \\ --proxy http://proxy.example.com:8080 \\ https://httpbin.org/ip # æ’é™¤ä»£ç† curl --noproxy localhost,127.0.0.1 https://localhost:8080/api ä¸¦è¡Œè«‹æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # èƒŒæ™¯åŸ·è¡Œ curl https://api1.example.com \u0026amp; curl https://api2.example.com \u0026amp; curl https://api3.example.com \u0026amp; wait # ä½¿ç”¨ xargs ä¸¦è¡Œ echo -e \u0026#34;https://api1.example.com\\nhttps://api2.example.com\u0026#34; | \\ xargs -n 1 -P 2 curl -s # å¾ªç’°è«‹æ±‚ for i in {1..5}; do curl -s \u0026#34;https://api.example.com/data/$i\u0026#34; \u0026amp; done wait API æ¸¬è©¦å¯¦æˆ° REST API æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # ä½¿ç”¨è€…ç®¡ç† API æ¸¬è©¦ BASE_URL=\u0026#34;https://jsonplaceholder.typicode.com\u0026#34; # 1. ç²å–æ‰€æœ‰ä½¿ç”¨è€… curl -s \u0026#34;$BASE_URL/users\u0026#34; | jq \u0026#39;.[0:3]\u0026#39; # 2. ç²å–ç‰¹å®šä½¿ç”¨è€… curl -s \u0026#34;$BASE_URL/users/1\u0026#34; | jq \u0026#39;.\u0026#39; # 3. å‰µå»ºæ–°ä½¿ç”¨è€… curl -X POST \u0026#34;$BASE_URL/users\u0026#34; \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;name\u0026#34;: \u0026#34;John Doe\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;johndoe\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;john@example.com\u0026#34; }\u0026#39; | jq \u0026#39;.\u0026#39; # 4. æ›´æ–°ä½¿ç”¨è€… curl -X PUT \u0026#34;$BASE_URL/users/1\u0026#34; \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;Jane Doe\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;janedoe\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;jane@example.com\u0026#34; }\u0026#39; | jq \u0026#39;.\u0026#39; # 5. åˆªé™¤ä½¿ç”¨è€… curl -X DELETE \u0026#34;$BASE_URL/users/1\u0026#34; -w \u0026#34;Status: %{http_code}\\n\u0026#34; API æ•ˆèƒ½æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # éŸ¿æ‡‰æ™‚é–“æ¸¬è©¦ test_api_performance() { local url=\u0026#34;$1\u0026#34; local requests=\u0026#34;$2\u0026#34; echo \u0026#34;Testing $url with $requests requests...\u0026#34; for i in $(seq 1 $requests); do curl -w \u0026#34;%{time_total}\\n\u0026#34; -o /dev/null -s \u0026#34;$url\u0026#34; done | awk \u0026#39;{sum+=$1; count++} END {print \u0026#34;Average:\u0026#34;, sum/count \u0026#34;s\u0026#34;}\u0026#39; } test_api_performance \u0026#34;https://httpbin.org/delay/1\u0026#34; 5 # ä¸¦ç™¼æ¸¬è©¦ concurrent_test() { local url=\u0026#34;$1\u0026#34; local concurrent=\u0026#34;$2\u0026#34; local total=\u0026#34;$3\u0026#34; echo \u0026#34;Concurrent test: $concurrent parallel requests, $total total\u0026#34; seq 1 $total | xargs -n 1 -P $concurrent -I {} \\ curl -w \u0026#34;Request {}: %{time_total}s\\n\u0026#34; -o /dev/null -s \u0026#34;$url\u0026#34; } concurrent_test \u0026#34;https://httpbin.org/delay/1\u0026#34; 3 10 API å¥åº·æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 #!/bin/bash # api_health_check.sh check_api_health() { local name=\u0026#34;$1\u0026#34; local url=\u0026#34;$2\u0026#34; local expected_status=\u0026#34;$3\u0026#34; echo -n \u0026#34;Checking $name... \u0026#34; response=$(curl -s -w \u0026#34;HTTPSTATUS:%{http_code}\u0026#34; \u0026#34;$url\u0026#34;) http_code=$(echo \u0026#34;$response\u0026#34; | tr -d \u0026#39;\\n\u0026#39; | sed -E \u0026#39;s/.*HTTPSTATUS:([0-9]{3})$/\\1/\u0026#39;) body=$(echo \u0026#34;$response\u0026#34; | sed -E \u0026#39;s/HTTPSTATUS:[0-9]{3}$//\u0026#39;) if [ \u0026#34;$http_code\u0026#34; -eq \u0026#34;$expected_status\u0026#34; ]; then echo \u0026#34;âœ“ OK (HTTP $http_code)\u0026#34; return 0 else echo \u0026#34;âœ— FAIL (HTTP $http_code)\u0026#34; echo \u0026#34;Response: $body\u0026#34; return 1 fi } # å¥åº·æª¢æŸ¥ check_api_health \u0026#34;Main API\u0026#34; \u0026#34;https://api.example.com/health\u0026#34; 200 check_api_health \u0026#34;User Service\u0026#34; \u0026#34;https://api.example.com/users/1\u0026#34; 200 check_api_health \u0026#34;Auth Service\u0026#34; \u0026#34;https://api.example.com/auth/status\u0026#34; 200 é™¤éŒ¯èˆ‡ç›£æ§ è©³ç´°é™¤éŒ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # è©³ç´°æ¨¡å¼ curl -v https://httpbin.org/get # è¿½è¹¤ ASCII æ ¼å¼ curl --trace-ascii debug.txt https://httpbin.org/get # è¿½è¹¤äºŒé€²ä½æ ¼å¼ curl --trace debug.bin https://httpbin.org/get # åªé¡¯ç¤ºæ¨™é ­ curl -I https://httpbin.org/get # é¡¯ç¤ºè«‹æ±‚å’ŒéŸ¿æ‡‰æ¨™é ­ curl -D headers.txt https://httpbin.org/get ç¶²è·¯è¨ºæ–· 1 2 3 4 5 6 7 8 9 10 11 12 13 # DNS è§£ææ™‚é–“ curl -w \u0026#34;DNS lookup: %{time_namelookup}s\\n\u0026#34; -o /dev/null -s https://example.com # é€£æ¥æ™‚é–“åˆ†æ curl -w \u0026#34;Connect: %{time_connect}s, Start transfer: %{time_starttransfer}s, Total: %{time_total}s\\n\u0026#34; \\ -o /dev/null -s https://example.com # æª¢æŸ¥ SSL è­‰æ›¸ curl -vI https://example.com 2\u0026gt;\u0026amp;1 | grep -E \u0026#34;(SSL|TLS|certificate)\u0026#34; # æ¸¬è©¦ä¸åŒ HTTP ç‰ˆæœ¬ curl --http1.1 -I https://example.com curl --http2 -I https://example.com éŒ¯èª¤è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 # åŸºæœ¬éŒ¯èª¤è™•ç† if curl -s --fail https://api.example.com/data; then echo \u0026#34;Request successful\u0026#34; else echo \u0026#34;Request failed with exit code $?\u0026#34; fi # è©³ç´°éŒ¯èª¤è³‡è¨Š curl -s -w \u0026#34;Status: %{http_code}, Exit: %{exitcode}\\n\u0026#34; \\ https://httpbin.org/status/404 # é‡è©¦æ©Ÿåˆ¶ retry_curl() { local url=\u0026#34;$1\u0026#34; local max_attempts=3 local attempt=1 while [ $attempt -le $max_attempts ]; do echo \u0026#34;Attempt $attempt of $max_attempts...\u0026#34; if curl -s --fail \u0026#34;$url\u0026#34;; then echo \u0026#34;Success on attempt $attempt\u0026#34; return 0 fi echo \u0026#34;Failed attempt $attempt\u0026#34; ((attempt++)) sleep 2 done echo \u0026#34;All attempts failed\u0026#34; return 1 } retry_curl \u0026#34;https://unstable-api.example.com\u0026#34; å¯¦ç”¨è…³æœ¬ç¯„ä¾‹ 1. API æ‰¹æ¬¡æ¸¬è©¦è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 #!/bin/bash # api_batch_test.sh API_BASE=\u0026#34;https://jsonplaceholder.typicode.com\u0026#34; AUTH_TOKEN=\u0026#34;your-auth-token\u0026#34; # æ¸¬è©¦é…ç½® declare -A TESTS=( [\u0026#34;GET /users\u0026#34;]=\u0026#34;$API_BASE/users\u0026#34; [\u0026#34;GET /posts\u0026#34;]=\u0026#34;$API_BASE/posts\u0026#34; [\u0026#34;GET /user/1\u0026#34;]=\u0026#34;$API_BASE/users/1\u0026#34; [\u0026#34;POST /posts\u0026#34;]=\u0026#34;$API_BASE/posts\u0026#34; ) # åŸ·è¡Œæ¸¬è©¦ run_tests() { echo \u0026#34;Starting API batch tests...\u0026#34; echo \u0026#34;==========================\u0026#34; local passed=0 local failed=0 for test_name in \u0026#34;${!TESTS[@]}\u0026#34;; do local url=\u0026#34;${TESTS[$test_name]}\u0026#34; echo -n \u0026#34;Testing $test_name... \u0026#34; if [[ \u0026#34;$test_name\u0026#34; == \u0026#34;POST\u0026#34;* ]]; then # POST æ¸¬è©¦ response=$(curl -s -w \u0026#34;HTTPSTATUS:%{http_code}\u0026#34; \\ -X POST \u0026#34;$url\u0026#34; \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -H \u0026#34;Authorization: Bearer $AUTH_TOKEN\u0026#34; \\ -d \u0026#39;{\u0026#34;title\u0026#34;:\u0026#34;Test\u0026#34;,\u0026#34;body\u0026#34;:\u0026#34;Test content\u0026#34;,\u0026#34;userId\u0026#34;:1}\u0026#39;) else # GET æ¸¬è©¦ response=$(curl -s -w \u0026#34;HTTPSTATUS:%{http_code}\u0026#34; \\ -H \u0026#34;Authorization: Bearer $AUTH_TOKEN\u0026#34; \\ \u0026#34;$url\u0026#34;) fi http_code=$(echo \u0026#34;$response\u0026#34; | tr -d \u0026#39;\\n\u0026#39; | sed -E \u0026#39;s/.*HTTPSTATUS:([0-9]{3})$/\\1/\u0026#39;) if [[ \u0026#34;$http_code\u0026#34; -ge 200 \u0026amp;\u0026amp; \u0026#34;$http_code\u0026#34; -lt 300 ]]; then echo \u0026#34;âœ“ PASS (HTTP $http_code)\u0026#34; ((passed++)) else echo \u0026#34;âœ— FAIL (HTTP $http_code)\u0026#34; ((failed++)) fi done echo \u0026#34;==========================\u0026#34; echo \u0026#34;Results: $passed passed, $failed failed\u0026#34; } run_tests 2. æª”æ¡ˆåŒæ­¥è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 #!/bin/bash # file_sync.sh LOCAL_DIR=\u0026#34;./local_files\u0026#34; REMOTE_BASE=\u0026#34;https://api.example.com/files\u0026#34; AUTH_TOKEN=\u0026#34;your-token\u0026#34; sync_files() { echo \u0026#34;Starting file synchronization...\u0026#34; # ç²å–é ç¨‹æª”æ¡ˆåˆ—è¡¨ remote_files=$(curl -s -H \u0026#34;Authorization: Bearer $AUTH_TOKEN\u0026#34; \\ \u0026#34;$REMOTE_BASE\u0026#34; | jq -r \u0026#39;.[].filename\u0026#39;) for file in $remote_files; do local_file=\u0026#34;$LOCAL_DIR/$file\u0026#34; remote_url=\u0026#34;$REMOTE_BASE/$file\u0026#34; echo -n \u0026#34;Checking $file... \u0026#34; if [ -f \u0026#34;$local_file\u0026#34; ]; then # æ¯”è¼ƒæª”æ¡ˆé›œæ¹Š local_hash=$(sha256sum \u0026#34;$local_file\u0026#34; | cut -d\u0026#39; \u0026#39; -f1) remote_hash=$(curl -s -I -H \u0026#34;Authorization: Bearer $AUTH_TOKEN\u0026#34; \\ \u0026#34;$remote_url\u0026#34; | grep -i \u0026#34;x-file-hash\u0026#34; | cut -d\u0026#39; \u0026#39; -f2 | tr -d \u0026#39;\\r\u0026#39;) if [ \u0026#34;$local_hash\u0026#34; = \u0026#34;$remote_hash\u0026#34; ]; then echo \u0026#34;âœ“ Up to date\u0026#34; continue fi fi # ä¸‹è¼‰æª”æ¡ˆ echo \u0026#34;â¬‡ Downloading...\u0026#34; curl -s -H \u0026#34;Authorization: Bearer $AUTH_TOKEN\u0026#34; \\ -o \u0026#34;$local_file\u0026#34; \u0026#34;$remote_url\u0026#34; if [ $? -eq 0 ]; then echo \u0026#34;âœ“ Downloaded successfully\u0026#34; else echo \u0026#34;âœ— Download failed\u0026#34; fi done } mkdir -p \u0026#34;$LOCAL_DIR\u0026#34; sync_files 3. ç¶²ç«™ç›£æ§è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 #!/bin/bash # website_monitor.sh SITES=( \u0026#34;https://example.com\u0026#34; \u0026#34;https://api.example.com/health\u0026#34; \u0026#34;https://cdn.example.com\u0026#34; ) TIMEOUT=10 LOG_FILE=\u0026#34;/var/log/website_monitor.log\u0026#34; log_message() { echo \u0026#34;$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) - $1\u0026#34; | tee -a \u0026#34;$LOG_FILE\u0026#34; } check_site() { local url=\u0026#34;$1\u0026#34; local name=$(echo \u0026#34;$url\u0026#34; | sed \u0026#39;s|https\\?://||\u0026#39; | sed \u0026#39;s|/.*||\u0026#39;) response=$(curl -s -w \u0026#34;HTTPSTATUS:%{http_code};TIME:%{time_total}\u0026#34; \\ --max-time \u0026#34;$TIMEOUT\u0026#34; \u0026#34;$url\u0026#34;) if [ $? -eq 0 ]; then http_code=$(echo \u0026#34;$response\u0026#34; | grep -o \u0026#34;HTTPSTATUS:[0-9]*\u0026#34; | cut -d: -f2) time_total=$(echo \u0026#34;$response\u0026#34; | grep -o \u0026#34;TIME:[0-9.]*\u0026#34; | cut -d: -f2) if [ \u0026#34;$http_code\u0026#34; = \u0026#34;200\u0026#34; ]; then log_message \u0026#34;âœ“ $name - OK (${time_total}s)\u0026#34; else log_message \u0026#34;âš  $name - HTTP $http_code (${time_total}s)\u0026#34; fi else log_message \u0026#34;âœ— $name - TIMEOUT or ERROR\u0026#34; fi } log_message \u0026#34;Starting website monitoring...\u0026#34; for site in \u0026#34;${SITES[@]}\u0026#34;; do check_site \u0026#34;$site\u0026#34; done log_message \u0026#34;Monitoring completed\u0026#34; æ•ˆèƒ½æœ€ä½³åŒ– é€£æ¥é‡ç”¨ 1 2 3 4 5 6 7 8 9 10 # HTTP/1.1 Keep-Alive curl --keepalive-time 30 https://api.example.com/endpoint1 curl --keepalive-time 30 https://api.example.com/endpoint2 # HTTP/2 å¤šè·¯å¾©ç”¨ curl --http2 https://example.com/resource1 curl --http2 https://example.com/resource2 # é€£æ¥æ± é…ç½® curl --max-time 30 --connect-timeout 10 https://api.example.com å¿«å–èˆ‡å£“ç¸® 1 2 3 4 5 6 7 8 9 10 # å•Ÿç”¨å£“ç¸® curl -H \u0026#34;Accept-Encoding: gzip, deflate\u0026#34; https://example.com # æ¢ä»¶è«‹æ±‚ curl -H \u0026#34;If-Modified-Since: Wed, 21 Oct 2015 07:28:00 GMT\u0026#34; \\ https://example.com/data # ETag æ”¯æ´ curl -H \u0026#34;If-None-Match: \\\u0026#34;33a64df551425fcc55e4d42a148795d9f25f89d4\\\u0026#34;\u0026#34; \\ https://example.com/resource æ‰¹æ¬¡å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # ä¸¦è¡Œä¸‹è¼‰ urls=( \u0026#34;https://api.example.com/data1\u0026#34; \u0026#34;https://api.example.com/data2\u0026#34; \u0026#34;https://api.example.com/data3\u0026#34; ) for url in \u0026#34;${urls[@]}\u0026#34;; do curl -s \u0026#34;$url\u0026#34; \u0026gt; \u0026#34;$(basename \u0026#34;$url\u0026#34;).json\u0026#34; \u0026amp; done wait # é™åˆ¶ä¸¦è¡Œæ•¸ printf \u0026#34;%s\\n\u0026#34; \u0026#34;${urls[@]}\u0026#34; | xargs -n 1 -P 3 -I {} \\ sh -c \u0026#39;curl -s \u0026#34;{}\u0026#34; \u0026gt; \u0026#34;$(basename \u0026#34;{}\u0026#34;).json\u0026#34;\u0026#39; å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ SSL/TLS å•é¡Œ 1 2 3 4 5 6 7 8 9 # è­‰æ›¸é©—è­‰å•é¡Œ curl -k https://self-signed.example.com # è·³éé©—è­‰ï¼ˆä¸æ¨è–¦ï¼‰ curl --cacert /path/to/ca-bundle.crt https://example.com # æŒ‡å®š CA # æª¢æŸ¥è­‰æ›¸è³‡è¨Š curl -vI https://example.com 2\u0026gt;\u0026amp;1 | grep -A 10 \u0026#34;Server certificate\u0026#34; # æ¸¬è©¦ SSL é…ç½® curl --tlsv1.2 --ciphers HIGH https://example.com ç·¨ç¢¼å•é¡Œ 1 2 3 4 5 6 7 8 # UTF-8 ç·¨ç¢¼ curl -H \u0026#34;Accept-Charset: utf-8\u0026#34; https://example.com # URL ç·¨ç¢¼ curl \u0026#34;https://example.com/search?q=$(echo \u0026#39;ä¸­æ–‡æŸ¥è©¢\u0026#39; | curl -Gso /dev/null -w %{url_effective} --data-urlencode @- | cut -c3-)\u0026#34; # è™•ç†ç‰¹æ®Šå­—å…ƒ curl -G -d \u0026#34;query=hello world\u0026#34; https://example.com/search è¶…æ™‚èˆ‡é‡è©¦ 1 2 3 4 5 6 7 8 9 # è¶…æ™‚è¨­å®š curl --connect-timeout 10 --max-time 30 https://slow-api.example.com # è‡ªå‹•é‡è©¦ curl --retry 3 --retry-delay 5 https://unstable-api.example.com # æŒ‡æ•¸é€€é¿ curl --retry 3 --retry-delay 1 --retry-max-time 60 \\ https://api.example.com ç¸½çµ æ ¸å¿ƒå„ªå‹¢ å¤šåŠŸèƒ½æ€§ï¼šæ”¯æ´å¤šç¨®å”å®šå’Œæ“ä½œæ–¹å¼ éˆæ´»æ€§ï¼šè±å¯Œçš„é¸é …å’Œé…ç½®èƒ½åŠ› å¯ç¨‹å¼æ€§ï¼šé©åˆè‡ªå‹•åŒ–å’Œè…³æœ¬è™•ç† è·¨å¹³å°ï¼šåœ¨å„ç¨®ç³»çµ±ä¸Šè¡¨ç¾ä¸€è‡´ æ•ˆèƒ½ï¼šé«˜æ•ˆçš„ç¶²è·¯é€šè¨Šå’Œå‚³è¼¸ æœ€ä½³å¯¦è¸ å®‰å…¨ç¬¬ä¸€ï¼šæ­£ç¢ºè™•ç†èªè­‰å’Œ SSL é©—è­‰ éŒ¯èª¤è™•ç†ï¼šå¯¦ä½œé©ç•¶çš„é‡è©¦å’ŒéŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶ æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨é€£æ¥é‡ç”¨å’Œä¸¦è¡Œè™•ç† æ—¥èªŒè¨˜éŒ„ï¼šä¿ç•™è©³ç´°çš„è«‹æ±‚å’ŒéŸ¿æ‡‰æ—¥èªŒ æ¸¬è©¦è‡ªå‹•åŒ–ï¼šå°‡ API æ¸¬è©¦æ•´åˆåˆ° CI/CD æµç¨‹ å¸¸ç”¨æ¨¡å¼è¨˜æ†¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # API æ¸¬è©¦åŸºæœ¬æ¨¡å¼ curl -X POST https://api.example.com/resource \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -H \u0026#34;Authorization: Bearer token\u0026#34; \\ -d \u0026#39;{\u0026#34;key\u0026#34;: \u0026#34;value\u0026#34;}\u0026#39; # æª”æ¡ˆæ“ä½œæ¨¡å¼ curl -O https://example.com/file.zip # ä¸‹è¼‰ curl -T file.txt https://api.example.com/upload # ä¸Šå‚³ # é™¤éŒ¯æ¨¡å¼ curl -v -I https://example.com # è©³ç´°æ¨™é ­ curl -w \u0026#34;%{http_code}\\n\u0026#34; https://example.com # ç‹€æ…‹ç¢¼ # æ•ˆèƒ½æ¸¬è©¦æ¨¡å¼ curl -w \u0026#34;@curl-format.txt\u0026#34; -o /dev/null -s https://example.com cURL æ˜¯ç¾ä»£é–‹ç™¼è€…å·¥å…·ç®±ä¸­ä¸å¯æˆ–ç¼ºçš„åˆ©å™¨ï¼ŒæŒæ¡å…¶æ ¸å¿ƒåŠŸèƒ½å’Œé€²éšæŠ€å·§ï¼Œèƒ½å¤ å¤§å¹…æå‡ API é–‹ç™¼ã€æ¸¬è©¦å’Œç¶­è­·çš„æ•ˆç‡ã€‚è¨˜ä½ï¼šå¯¦å‹™ä¸­æœ€é‡è¦çš„æ˜¯ç†è§£ HTTP å”å®šåŸºç¤ï¼Œä¸¦å–„ç”¨ cURL çš„è±å¯Œé¸é …ä¾†è§£æ±ºå¯¦éš›å•é¡Œã€‚\nåƒè€ƒè³‡æ–™ cURL å®˜æ–¹æ–‡æª” cURL Tutorial HTTP/1.1 è¦ç¯„ REST API è¨­è¨ˆæŒ‡å— JSON API è¦ç¯„ ","permalink":"https://xinqilin.github.io/post/tools/curl/","tags":["cURL","HTTP","API","REST","Web Development","Command Line","Network"],"title":"cURL å®Œæ•´æŒ‡å—ï¼šHTTP å®¢æˆ¶ç«¯å·¥å…·èˆ‡ API æ¸¬è©¦åˆ©å™¨"},{"content":"æ¦‚è¿° åœ¨ç¾ä»£æ‡‰ç”¨ç¨‹å¼é–‹ç™¼ä¸­ï¼Œä¸€å€‹å°ˆæ¡ˆå¾€å¾€ç”±å¤šå€‹æœå‹™çµ„æˆï¼Œä¾‹å¦‚å‰ç«¯ã€å¾Œç«¯ APIã€è³‡æ–™åº«ã€å¿«å–ç­‰ã€‚é€™äº›æœå‹™å„è‡ªé‹è¡Œåœ¨ä¸åŒçš„å®¹å™¨ä¸­ï¼Œè€Œ Docker Compose æ­£æ˜¯ç‚ºäº†è§£æ±ºé€™ç¨®å¤šå®¹å™¨æ‡‰ç”¨ç¨‹å¼çš„å®šç¾©èˆ‡ç®¡ç†è€Œç”Ÿã€‚\nDocker Compose å…è¨±æ‚¨ä½¿ç”¨ä¸€å€‹ YAML æª”æ¡ˆ (docker-compose.yml) ä¾†å®šç¾©æ‡‰ç”¨ç¨‹å¼çš„æ‰€æœ‰æœå‹™ã€ç¶²è·¯å’Œå„²å­˜å·ï¼Œç„¶å¾Œé€éå–®ä¸€æŒ‡ä»¤å•Ÿå‹•ã€åœæ­¢æˆ–ç®¡ç†æ•´å€‹æ‡‰ç”¨ç¨‹å¼å †ç–Šã€‚é€™æ¥µå¤§åœ°ç°¡åŒ–äº†é–‹ç™¼ã€æ¸¬è©¦å’Œéƒ¨ç½²çš„æµç¨‹ã€‚\nå¸¸ç”¨ Docker Compose æŒ‡ä»¤ ä»¥ä¸‹æ˜¯ Docker Compose çš„ä¸€äº›å¸¸ç”¨æŒ‡ä»¤ï¼Œç”¨æ–¼ç®¡ç†æ‚¨çš„å¤šå®¹å™¨æ‡‰ç”¨ç¨‹å¼ï¼š\næŒ‡ä»¤ èªªæ˜ ç¯„ä¾‹ docker-compose --version é¡¯ç¤º Docker Compose çš„ç‰ˆæœ¬è³‡è¨Šã€‚ docker-compose --version docker-compose -h é¡¯ç¤º Docker Compose çš„å¹«åŠ©è¨Šæ¯ã€‚ docker-compose -h docker-compose up å•Ÿå‹•ä¸¦å»ºç«‹æ‰€æœ‰æœå‹™çš„å®¹å™¨ã€‚å¦‚æœå®¹å™¨å·²å­˜åœ¨ï¼Œå‰‡æœƒé‡æ–°å»ºç«‹ã€‚ docker-compose up docker-compose up -d åœ¨èƒŒæ™¯æ¨¡å¼ (detached mode) å•Ÿå‹•ä¸¦å»ºç«‹æ‰€æœ‰æœå‹™çš„å®¹å™¨ã€‚ docker-compose up -d docker-compose down åœæ­¢ä¸¦ç§»é™¤æ‰€æœ‰æœå‹™çš„å®¹å™¨ã€ç¶²è·¯å’Œé è¨­å„²å­˜å·ã€‚ docker-compose down docker-compose exec \u0026lt;service_name\u0026gt; \u0026lt;command\u0026gt; åœ¨æŒ‡å®šæœå‹™çš„å®¹å™¨ä¸­åŸ·è¡ŒæŒ‡ä»¤ã€‚ docker-compose exec microService /bin/bash docker-compose ps åˆ—å‡ºæ‰€æœ‰æœå‹™çš„å®¹å™¨ç‹€æ…‹ã€‚ docker-compose ps docker-compose top é¡¯ç¤ºæœå‹™å®¹å™¨çš„é‹è¡Œé€²ç¨‹ã€‚ docker-compose top docker-compose logs \u0026lt;service_name\u0026gt; é¡¯ç¤ºæŒ‡å®šæœå‹™å®¹å™¨çš„æ—¥èªŒè¼¸å‡ºã€‚ docker-compose logs microService docker-compose config é©—è­‰ docker-compose.yml æª”æ¡ˆçš„èªæ³•æ˜¯å¦æ­£ç¢ºï¼Œä¸¦é¡¯ç¤ºè§£æå¾Œçš„é…ç½®ã€‚ docker-compose config docker-compose config -q éœé»˜æ¨¡å¼é©—è­‰é…ç½®ï¼Œåªåœ¨æœ‰éŒ¯èª¤æ™‚è¼¸å‡ºè¨Šæ¯ã€‚ docker-compose config -q docker-compose restart \u0026lt;service_name\u0026gt; é‡æ–°å•Ÿå‹•æŒ‡å®šæœå‹™çš„å®¹å™¨ã€‚è‹¥æœªæŒ‡å®šæœå‹™ï¼Œå‰‡é‡æ–°å•Ÿå‹•æ‰€æœ‰æœå‹™ã€‚ docker-compose restart microService docker-compose start \u0026lt;service_name\u0026gt; å•Ÿå‹•æŒ‡å®šæœå‹™çš„å®¹å™¨ã€‚è‹¥æœªæŒ‡å®šæœå‹™ï¼Œå‰‡å•Ÿå‹•æ‰€æœ‰å·²åœæ­¢çš„æœå‹™ã€‚ docker-compose start microService docker-compose stop \u0026lt;service_name\u0026gt; åœæ­¢æŒ‡å®šæœå‹™çš„å®¹å™¨ã€‚è‹¥æœªæŒ‡å®šæœå‹™ï¼Œå‰‡åœæ­¢æ‰€æœ‰é‹è¡Œä¸­çš„æœå‹™ã€‚ docker-compose stop microService å¸¸ç”¨çµ„åˆæŒ‡ä»¤ 1 2 # é©—è­‰é…ç½®å¾Œï¼Œåœæ­¢ä¸¦é‡æ–°å•Ÿå‹•æ‰€æœ‰æœå‹™ docker-compose config -q \u0026amp;\u0026amp; docker-compose down \u0026amp;\u0026amp; docker-compose up -d docker-compose.yml æª”æ¡ˆçµæ§‹è©³è§£ docker-compose.yml æ˜¯ Docker Compose çš„æ ¸å¿ƒé…ç½®æª”æ¡ˆï¼Œå®ƒä½¿ç”¨ YAML èªæ³•ä¾†å®šç¾©æ‡‰ç”¨ç¨‹å¼çš„æœå‹™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 # æŒ‡å®š Docker Compose æª”æ¡ˆæ ¼å¼çš„ç‰ˆæœ¬ï¼Œå»ºè­°ä½¿ç”¨æœ€æ–°ç©©å®šç‰ˆ (ç›®å‰ç‚º \u0026#39;3.x\u0026#39;) version: \u0026#34;3.8\u0026#34; # å»ºè­°ä½¿ç”¨ 3.8 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä»¥æ”¯æ´æ›´å¤šåŠŸèƒ½ # å®šç¾©æ‡‰ç”¨ç¨‹å¼ä¸­çš„æ‰€æœ‰æœå‹™ (å³å®¹å™¨) services: # è‡ªè¨‚æœå‹™åç¨±ï¼Œä¾‹å¦‚ \u0026#39;microService\u0026#39;ã€\u0026#39;web\u0026#39;ã€\u0026#39;db\u0026#39; ç­‰ microService: # æŒ‡å®šæœå‹™æ‰€ä½¿ç”¨çš„ Docker æ˜ åƒæª” image: my_image:1.0 # å®šç¾©å®¹å™¨çš„åç¨±ï¼Œæ–¹ä¾¿è­˜åˆ¥å’Œç®¡ç† container_name: ms_01 # åŸ æ˜ å°„ï¼šå°‡ä¸»æ©ŸåŸ æ˜ å°„åˆ°å®¹å™¨åŸ  (HOST_PORT:CONTAINER_PORT) ports: - \u0026#34;8081:8080\u0026#34; # å°‡ä¸»æ©Ÿçš„ 8081 åŸ æ˜ å°„åˆ°å®¹å™¨çš„ 8080 åŸ  # å„²å­˜å·æ˜ å°„ï¼šå°‡ä¸»æ©Ÿè·¯å¾‘æ˜ å°„åˆ°å®¹å™¨è·¯å¾‘ (HOST_PATH:CONTAINER_PATH) volumes: - /Users/bill/microService:/app # å°‡ä¸»æ©Ÿçš„ /Users/bill/microService ç›®éŒ„æ˜ å°„åˆ°å®¹å™¨çš„ /app ç›®éŒ„ # æŒ‡å®šæœå‹™æ‰€é€£æ¥çš„ç¶²è·¯ networks: - my_network # é€£æ¥åˆ°åç‚º \u0026#39;my_network\u0026#39; çš„ç¶²è·¯ # å®šç¾©æœå‹™çš„å•Ÿå‹•é †åºä¾è³´é—œä¿‚ # æ³¨æ„ï¼šdepends_on åªä¿è­‰æœå‹™å•Ÿå‹•é †åºï¼Œä¸ä¿è­‰æœå‹™å…§éƒ¨æ‡‰ç”¨ç¨‹å¼å®Œå…¨å°±ç·’ # å¯æ­é… https://github.com/vishnubob/wait-for-it æˆ–å…¶ä»–å¥åº·æª¢æŸ¥æ©Ÿåˆ¶ç¢ºä¿æœå‹™å¯ç”¨ depends_on: - redis # microService æœå‹™æœƒåœ¨ redis æœå‹™å•Ÿå‹•å¾Œæ‰å•Ÿå‹• - mysql # microService æœå‹™æœƒåœ¨ mysql æœå‹™å•Ÿå‹•å¾Œæ‰å•Ÿå‹• # ç¯„ä¾‹ï¼šç­‰åŒæ–¼ `docker run -d -p 8081:8080 -v /Users/bill/microService:/app --network my_network` redis: image: redis:6.0.8 # ä½¿ç”¨ Redis 6.0.8 æ˜ åƒæª” ports: - \u0026#34;6379:6379\u0026#34; # æ˜ å°„ Redis é è¨­åŸ  volumes: # æ˜ å°„ Redis é…ç½®æª”ï¼Œè®“å®¹å™¨ä½¿ç”¨è‡ªè¨‚é…ç½® - /app/redis/redis.conf:/etc/redis/redis.conf # æ˜ å°„ Redis è³‡æ–™ç›®éŒ„ï¼Œå¯¦ç¾è³‡æ–™æŒä¹…åŒ– - /app/redis/data:/data networks: - my_network # è¦†å¯«å®¹å™¨çš„é è¨­å•Ÿå‹•æŒ‡ä»¤ï¼Œè®“ Redis ä½¿ç”¨æŒ‡å®šçš„é…ç½®æª”å•Ÿå‹• command: redis-server /etc/redis/redis.conf mysql: image: mysql:5.7 # ä½¿ç”¨ MySQL 5.7 æ˜ åƒæª” # è¨­å®š MySQL å®¹å™¨çš„ç’°å¢ƒè®Šæ•¸ environment: MYSQL_ROOT_PASSWORD: \u0026#39;123456\u0026#39; # è¨­å®š root ä½¿ç”¨è€…çš„å¯†ç¢¼ MYSQL_ALLOW_EMPTY_PASSWORD: \u0026#39;no\u0026#39; # ä¸å…è¨± root å¯†ç¢¼ç‚ºç©º MYSQL_DATABASE: \u0026#39;my_test_db\u0026#39; # å»ºç«‹ä¸€å€‹åç‚º \u0026#39;my_test_db\u0026#39; çš„è³‡æ–™åº« MYSQL_USER: \u0026#39;bill\u0026#39; # å»ºç«‹ä¸€å€‹åç‚º \u0026#39;bill\u0026#39; çš„ä½¿ç”¨è€… MYSQL_PASSWORD: \u0026#39;user_pwd\u0026#39; # è¨­å®š \u0026#39;bill\u0026#39; ä½¿ç”¨è€…çš„å¯†ç¢¼ ports: - \u0026#34;3306:3306\u0026#34; # æ˜ å°„ MySQL é è¨­åŸ  volumes: # æ˜ å°„ MySQL è³‡æ–™ç›®éŒ„ï¼Œå¯¦ç¾è³‡æ–™æŒä¹…åŒ– - /app/mysql/db:/var/lib/mysql # æ˜ å°„ MySQL é…ç½®æª” - /app/mysql/conf/my.cnf:/etc/my.cnf # æ˜ å°„åˆå§‹åŒ–è…³æœ¬ç›®éŒ„ï¼Œå®¹å™¨å•Ÿå‹•æ™‚æœƒåŸ·è¡Œæ­¤ç›®éŒ„ä¸‹çš„ .sh æˆ– .sql è…³æœ¬ - /app/mysql/init:/docker-entrypoint-initdb.d networks: - my_network # è§£æ±º MySQL 8.0 ä¹‹å¾Œé è¨­èªè­‰æ’ä»¶å°è‡´å¤–éƒ¨å®¢æˆ¶ç«¯ç„¡æ³•é€£æ¥çš„å•é¡Œ command: --default-authentication-plugin=mysql_native_password # å®šç¾©æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨çš„ç¶²è·¯ networks: my_network: # è‡ªè¨‚ç¶²è·¯åç¨±ï¼Œæ‰€æœ‰æœå‹™å°‡åœ¨æ­¤ç¶²è·¯ä¸­äº’ç›¸é€šè¨Š # å®šç¾©æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨çš„å„²å­˜å· (å¯é¸ï¼Œå¦‚æœæœå‹™ä¸­ç›´æ¥ä½¿ç”¨åŒ¿åå·æˆ–ç¶å®šæ›è¼‰å‰‡ä¸éœ€è¦åœ¨æ­¤å®šç¾©) # volumes: # my_data: # è‡ªè¨‚å„²å­˜å·åç¨± ","permalink":"https://xinqilin.github.io/post/devops/docker-compose/","tags":["Docker","Docker Compose","DevOps","Containerization","Microservices","YAML"],"title":"Docker Compose å®Œæ•´æŒ‡å—ï¼šå¤šå®¹å™¨æ‡‰ç”¨ç¨‹å¼çš„å®šç¾©èˆ‡åŸ·è¡Œ"},{"content":"æ¦‚è¿° Docker ç¶²è·¯æ˜¯å®¹å™¨åŒ–æ‡‰ç”¨ç¨‹å¼çš„åŸºçŸ³ï¼Œå®ƒæ±ºå®šäº†å®¹å™¨å¦‚ä½•èˆ‡å¤–éƒ¨ä¸–ç•Œé€šè¨Šï¼Œä»¥åŠå®¹å™¨ä¹‹é–“å¦‚ä½•äº’ç›¸é€£æ¥ã€‚ç†è§£ Docker çš„ç¶²è·¯æ¨¡å¼å°æ–¼å»ºæ§‹ç©©å¥ã€å¯æ“´å±•çš„å®¹å™¨åŒ–æ‡‰ç”¨ç¨‹å¼è‡³é—œé‡è¦ã€‚æœ¬æ–‡å°‡è©³ç´°ä»‹ç´¹ Docker æä¾›çš„å¹¾ç¨®ä¸»è¦ç¶²è·¯æ¨¡å¼åŠå…¶æ‡‰ç”¨å ´æ™¯ã€‚\nDocker ç¶²è·¯æ¨¡å¼ Docker æä¾›äº†å¤šç¨®ç¶²è·¯é©…å‹•ç¨‹å¼ï¼Œæ¯ç¨®é©…å‹•ç¨‹å¼éƒ½æä¾›ä¸åŒçš„ç¶²è·¯åŠŸèƒ½ã€‚æœ€å¸¸ç”¨çš„åŒ…æ‹¬ bridgeã€hostã€none å’Œ containerã€‚\n1. Bridge (æ©‹æ¥æ¨¡å¼) èªªæ˜ï¼šé€™æ˜¯ Docker çš„é è¨­ç¶²è·¯æ¨¡å¼ã€‚ç•¶æ‚¨ä¸æŒ‡å®šç¶²è·¯æ¨¡å¼æ™‚ï¼ŒDocker æœƒè‡ªå‹•ç‚ºå®¹å™¨åˆ†é…ä¸€å€‹ IP ä½å€ï¼Œä¸¦å°‡å…¶é€£æ¥åˆ°ä¸€å€‹åç‚º docker0 çš„è™›æ“¬æ©‹æ¥å™¨ä¸Šã€‚æ¯å€‹å®¹å™¨éƒ½æœƒç²å¾—ä¸€å€‹ç¨ç«‹çš„ç¶²è·¯å †ç–Šã€‚ å·¥ä½œåŸç†ï¼š Docker æœƒåœ¨ä¸»æ©Ÿä¸Šå»ºç«‹ä¸€å€‹åç‚º docker0 çš„è™›æ“¬æ©‹æ¥å™¨ã€‚ æ¯å€‹å®¹å™¨éƒ½æœƒå»ºç«‹ä¸€å°è™›æ“¬ä¹™å¤ªç¶²å¡ (veth pair)ï¼Œå…¶ä¸­ä¸€ç«¯é€£æ¥åˆ°å®¹å™¨å…§çš„ eth0ï¼Œå¦ä¸€ç«¯é€£æ¥åˆ° docker0 æ©‹æ¥å™¨ã€‚ å®¹å™¨å¯ä»¥é€é docker0 æ©‹æ¥å™¨èˆ‡åŒä¸€æ©‹æ¥å™¨ä¸Šçš„å…¶ä»–å®¹å™¨é€šè¨Šï¼Œä¹Ÿå¯ä»¥é€éä¸»æ©Ÿçš„ç¶²è·¯ä»‹é¢èˆ‡å¤–éƒ¨ç¶²è·¯é€šè¨Šã€‚ å„ªé»ï¼šæä¾›è‰¯å¥½çš„éš”é›¢æ€§ï¼Œå®¹å™¨é–“é è¨­ä¸ç›´æ¥æš´éœ²åŸ ã€‚ ç¼ºé»ï¼šå®¹å™¨éœ€è¦é€éåŸ æ˜ å°„æ‰èƒ½å¾å¤–éƒ¨è¨ªå•ã€‚ 2. Host (ä¸»æ©Ÿæ¨¡å¼) èªªæ˜ï¼šåœ¨ä¸»æ©Ÿæ¨¡å¼ä¸‹ï¼Œå®¹å™¨ä¸æœƒæœ‰è‡ªå·±çš„ç¨ç«‹ç¶²è·¯å †ç–Šï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ä¸»æ©Ÿçš„ç¶²è·¯å †ç–Šã€‚é€™æ„å‘³è‘—å®¹å™¨æœƒç›´æ¥ä½¿ç”¨ä¸»æ©Ÿçš„ IP ä½å€å’ŒåŸ ã€‚ å·¥ä½œåŸç†ï¼šå®¹å™¨å…§çš„æ‡‰ç”¨ç¨‹å¼æœƒç›´æ¥ç¶å®šåˆ°ä¸»æ©Ÿçš„ç¶²è·¯ä»‹é¢å’ŒåŸ ä¸Šã€‚ å„ªé»ï¼šç¶²è·¯æ•ˆèƒ½æœ€ä½³ï¼Œå› ç‚ºæ²’æœ‰é¡å¤–çš„ç¶²è·¯å±¤ã€‚ ç¼ºé»ï¼š å®¹å™¨ä¸å†èˆ‡ä¸»æ©Ÿéš”é›¢ï¼Œå®¹å™¨å…§æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨çš„åŸ ä¸èƒ½èˆ‡ä¸»æ©Ÿä¸Šå·²ä½”ç”¨çš„åŸ è¡çªã€‚ å®‰å…¨æ€§è¼ƒä½ï¼Œå› ç‚ºå®¹å™¨ç›´æ¥æš´éœ²åœ¨ä¸»æ©Ÿç¶²è·¯ä¸­ã€‚ ä½¿ç”¨æ–¹å¼ï¼š--network host 3. None (ç„¡ç¶²è·¯æ¨¡å¼) èªªæ˜ï¼šåœ¨ç„¡ç¶²è·¯æ¨¡å¼ä¸‹ï¼Œå®¹å™¨æœƒå»ºç«‹ä¸€å€‹ç¨ç«‹çš„ç¶²è·¯å †ç–Šï¼Œä½†ä¸æœƒå°å…¶é€²è¡Œä»»ä½•ç¶²è·¯é…ç½®ã€‚å®¹å™¨å°‡æ²’æœ‰ç¶²è·¯ä»‹é¢ï¼Œç„¡æ³•èˆ‡å¤–éƒ¨é€šè¨Šã€‚ å·¥ä½œåŸç†ï¼šå®¹å™¨åªåŒ…å«ä¸€å€‹ lo (loopback) ä»‹é¢ã€‚ å„ªé»ï¼šé©ç”¨æ–¼åªéœ€è¦è¨ˆç®—è³‡æºè€Œä¸éœ€è¦ç¶²è·¯é€£æ¥çš„ç‰¹æ®Šå ´æ™¯ï¼Œæˆ–è€…éœ€è¦æ‰‹å‹•é…ç½®ç¶²è·¯çš„é€²éšæƒ…æ³ã€‚ ç¼ºé»ï¼šå®¹å™¨ç„¡æ³•é€²è¡Œä»»ä½•ç¶²è·¯é€šè¨Šï¼Œé™¤éæ‰‹å‹•é…ç½®ã€‚ ä½¿ç”¨æ–¹å¼ï¼š--network none 4. Container (å®¹å™¨æ¨¡å¼) èªªæ˜ï¼šåœ¨å®¹å™¨æ¨¡å¼ä¸‹ï¼Œæ–°å»ºç«‹çš„å®¹å™¨ä¸æœƒæœ‰è‡ªå·±çš„ç¶²è·¯å †ç–Šï¼Œè€Œæ˜¯èˆ‡å¦ä¸€å€‹å·²å­˜åœ¨çš„å®¹å™¨å…±äº«å…¶ç¶²è·¯å †ç–Šã€‚é€™æ„å‘³è‘—å…©å€‹å®¹å™¨æœƒå…±äº«åŒä¸€å€‹ IP ä½å€å’ŒåŸ ç©ºé–“ã€‚ å·¥ä½œåŸç†ï¼šå…©å€‹å®¹å™¨å…±äº«åŒä¸€å€‹ç¶²è·¯å‘½åç©ºé–“ã€‚ å„ªé»ï¼šé©ç”¨æ–¼éœ€è¦ç·Šå¯†å”åŒå·¥ä½œçš„æ‡‰ç”¨ç¨‹å¼ï¼Œä¾‹å¦‚ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨å’Œä¸€å€‹ä»£ç†æˆ–æ—¥èªŒæ”¶é›†å®¹å™¨ã€‚ ç¼ºé»ï¼šå…©å€‹å®¹å™¨æœƒå…±äº«åŸ ï¼Œå¯èƒ½å°è‡´åŸ è¡çªã€‚ ä½¿ç”¨æ–¹å¼ï¼š--network container:\u0026lt;name_or_id\u0026gt; å¸¸ç”¨ Docker ç¶²è·¯æŒ‡ä»¤ æŒ‡ä»¤ èªªæ˜ ç¯„ä¾‹ docker network ls åˆ—å‡ºæ‰€æœ‰ Docker ç¶²è·¯ã€‚ docker network ls docker network prune åˆªé™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç¶²è·¯ã€‚ docker network prune docker network inspect \u0026lt;network_name_or_id\u0026gt; é¡¯ç¤ºæŒ‡å®šç¶²è·¯çš„è©³ç´°è³‡è¨Šï¼ŒåŒ…æ‹¬é€£æ¥åˆ°è©²ç¶²è·¯çš„å®¹å™¨ã€‚ docker network inspect bridge docker inspect \u0026lt;container_id\u0026gt; é¡¯ç¤ºæŒ‡å®šå®¹å™¨çš„è©³ç´°è³‡è¨Šï¼ŒåŒ…æ‹¬å…¶ç¶²è·¯é…ç½®ã€‚ docker inspect \u0026lt;container_id\u0026gt; è‡ªè¨‚ç¶²è·¯ (User-defined Bridge Networks) é›–ç„¶ Docker é è¨­çš„ bridge ç¶²è·¯ (docker0) å·²ç¶“è¶³å¤ æ‡‰ä»˜è¨±å¤šæƒ…æ³ï¼Œä½†å¼·çƒˆå»ºè­°æ‚¨å»ºç«‹è‡ªè¨‚æ©‹æ¥ç¶²è·¯ (User-defined Bridge Networks)ã€‚è‡ªè¨‚ç¶²è·¯æä¾›äº†æ›´å¥½çš„éš”é›¢æ€§ã€å…§å»ºçš„ DNS è§£æå’Œæ›´éˆæ´»çš„é…ç½®ã€‚\nå„ªé» å…§å»º DNS è§£æï¼šåœ¨è‡ªè¨‚ç¶²è·¯ä¸­ï¼Œå®¹å™¨å¯ä»¥é€éæœå‹™åç¨±ï¼ˆè€Œä¸æ˜¯ IP ä½å€ï¼‰äº’ç›¸é€šè¨Šï¼Œå› ç‚º Docker æœƒç‚ºè‡ªè¨‚ç¶²è·¯æä¾›å…§å»ºçš„ DNS è§£ææœå‹™ã€‚é€™ä½¿å¾—å®¹å™¨çš„ IP ä½å€è®ŠåŒ–ä¸å†æ˜¯å•é¡Œã€‚ æ›´å¥½çš„éš”é›¢æ€§ï¼šè‡ªè¨‚ç¶²è·¯ä¸­çš„å®¹å™¨é è¨­åªèƒ½èˆ‡åŒä¸€ç¶²è·¯ä¸­çš„å…¶ä»–å®¹å™¨é€šè¨Šï¼Œæä¾›äº†æ›´å¥½çš„å®‰å…¨æ€§ã€‚ å¯ç§»æ¤æ€§ï¼šåœ¨ Docker Compose ä¸­ï¼Œè‡ªè¨‚ç¶²è·¯æ˜¯é è¨­è¡Œç‚ºï¼Œé€™ä½¿å¾—å¤šå®¹å™¨æ‡‰ç”¨ç¨‹å¼çš„å®šç¾©æ›´åŠ ç°¡æ½”å’Œå¯ç§»æ¤ã€‚ å»ºç«‹è‡ªè¨‚ç¶²è·¯ 1 2 # å»ºç«‹ä¸€å€‹åç‚º \u0026#39;my_network\u0026#39; çš„è‡ªè¨‚æ©‹æ¥ç¶²è·¯ docker network create my_network å°‡å®¹å™¨é€£æ¥åˆ°è‡ªè¨‚ç¶²è·¯ åœ¨å•Ÿå‹•å®¹å™¨æ™‚ï¼Œä½¿ç”¨ --network åƒæ•¸æŒ‡å®šè‡ªè¨‚ç¶²è·¯åç¨±ï¼š\n1 2 3 4 5 # å•Ÿå‹•ç¬¬ä¸€å€‹ Tomcat å®¹å™¨ï¼Œé€£æ¥åˆ° \u0026#39;my_network\u0026#39; docker run -d -p 8080:8080 --network my_network --name tomcat_1 tomcat # å•Ÿå‹•ç¬¬äºŒå€‹ Tomcat å®¹å™¨ï¼Œé€£æ¥åˆ° \u0026#39;my_network\u0026#39; docker run -d -p 8081:8080 --network my_network --name tomcat_2 tomcat ç¾åœ¨ï¼Œtomcat_1 å’Œ tomcat_2 å®¹å™¨éƒ½åœ¨ my_network ä¸­ï¼Œå®ƒå€‘å¯ä»¥é€éå½¼æ­¤çš„å®¹å™¨åç¨±ï¼ˆtomcat_1 å’Œ tomcat_2ï¼‰äº’ç›¸é€šè¨Šï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 # é€²å…¥ tomcat_1 å®¹å™¨å…§éƒ¨ docker exec -it tomcat_1 bash # åœ¨ tomcat_1 å®¹å™¨å…§éƒ¨ ping tomcat_2 ping tomcat_2 å®¹å™¨æ¨¡å¼çš„é™åˆ¶èˆ‡è‡ªè¨‚ç¶²è·¯çš„å„ªå‹¢ æ‚¨åŸå…ˆçš„ç¯„ä¾‹ä¸­ï¼Œå˜—è©¦è®“å…©å€‹ Tomcat å®¹å™¨å…±äº«ç¶²è·¯ï¼Œä½†ç”±æ–¼åŸ è¡çªè€Œå¤±æ•—ï¼š\n1 2 3 4 # å‘ ï¼ˆä¸‹é¢èµ·ä¸èµ·ä¾†å› å…©å° tomcat éƒ½ç”¨ 8080 æ˜ å°„å‡ºå»ï¼‰ # å€Ÿç”¨ tomcat_1 ç¶²è·¯ docker run -d -p 8080:8080 --name tomcat_1 tomcat docker run -d -p 8081:8080 --network container:tomcat_1 --name tomcat_2 tomcat # æœƒå¤±æ•—ï¼Œå› ç‚º tomcat_2 è©¦åœ–ä½¿ç”¨ tomcat_1 çš„ 8080 åŸ  é€™æ˜¯å› ç‚ºåœ¨ container æ¨¡å¼ä¸‹ï¼Œå…©å€‹å®¹å™¨å…±äº«åŒä¸€å€‹ç¶²è·¯å‘½åç©ºé–“ï¼ŒåŒ…æ‹¬åŸ ç©ºé–“ã€‚å¦‚æœ tomcat_1 å·²ç¶“ä½”ç”¨äº† 8080 åŸ ï¼Œé‚£éº¼ tomcat_2 å°±ç„¡æ³•å†ä½¿ç”¨é€™å€‹åŸ ã€‚\nç›¸æ¯”ä¹‹ä¸‹ï¼Œä½¿ç”¨è‡ªè¨‚ç¶²è·¯å‰‡æ²’æœ‰é€™å€‹å•é¡Œã€‚æ¯å€‹å®¹å™¨åœ¨è‡ªè¨‚ç¶²è·¯ä¸­ä»ç„¶æ“æœ‰è‡ªå·±çš„ç¨ç«‹ç¶²è·¯å †ç–Šå’ŒåŸ ç©ºé–“ï¼Œåªæ˜¯å®ƒå€‘å¯ä»¥é€éç¶²è·¯åç¨±äº’ç›¸ç™¼ç¾å’Œé€šè¨Šã€‚é€™ä½¿å¾—è‡ªè¨‚ç¶²è·¯æˆç‚ºå¤šå®¹å™¨æ‡‰ç”¨ç¨‹å¼ä¹‹é–“é€šè¨Šçš„æ›´å„ªé›…å’Œå¥å£¯çš„è§£æ±ºæ–¹æ¡ˆã€‚\né€éç†è§£å’Œå–„ç”¨ Docker ç¶²è·¯æ¨¡å¼ï¼Œæ‚¨å¯ä»¥æ›´æœ‰æ•ˆåœ°è¨­è¨ˆå’Œç®¡ç†æ‚¨çš„å®¹å™¨åŒ–æ‡‰ç”¨ç¨‹å¼ã€‚\n","permalink":"https://xinqilin.github.io/post/devops/docker-network/","tags":["Docker","Network","DevOps","Containerization","Bridge","Host"],"title":"Docker ç¶²è·¯æ¨¡å¼è©³è§£ï¼šå®¹å™¨é–“é€šè¨Šèˆ‡å¤–éƒ¨é€£æ¥"},{"content":"æ¦‚è¿° åœ¨è‡ªå‹•åŒ–æ¸¬è©¦å’Œç¶²è·¯çˆ¬èŸ²ç­‰å ´æ™¯ä¸­ï¼Œç¶“å¸¸éœ€è¦å°‡æ‡‰ç”¨ç¨‹å¼èˆ‡ç€è¦½å™¨è‡ªå‹•åŒ–å·¥å…· (å¦‚ Selenium) æ‰“åŒ…åˆ°åŒä¸€å€‹ Docker å®¹å™¨ä¸­ã€‚æ­¤å¤–ï¼Œç‚ºäº†æ”¯æ´ä¸åŒçš„é‹è¡Œç’°å¢ƒï¼ˆä¾‹å¦‚ ARM64 æˆ– x86_64 æ¶æ§‹ï¼Œä»¥åŠ Firefox æˆ– Chrome ç€è¦½å™¨ï¼‰ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹éˆæ´»çš„å»ºæ§‹æµç¨‹ã€‚\næœ¬æ–‡å°‡æ·±å…¥è§£æä¸€å€‹å¤šéšæ®µ Dockerfileï¼Œå®ƒå±•ç¤ºäº†å¦‚ä½•ï¼š\nå»ºæ§‹ä¸€å€‹åŒ…å« Node.js æ‡‰ç”¨ç¨‹å¼çš„åŸºç¤æ˜ åƒæª”ã€‚ åˆ©ç”¨é€™å€‹åŸºç¤æ˜ åƒæª”ï¼Œç‚ºä¸åŒçš„ CPU æ¶æ§‹å’Œç€è¦½å™¨ç’°å¢ƒå»ºç«‹å¤šå€‹æœ€çµ‚çš„ Selenium æ‡‰ç”¨ç¨‹å¼æ˜ åƒæª”ã€‚ é€éä¸€å€‹é€šç”¨çš„ entrypoint.sh è…³æœ¬ï¼Œåœ¨å®¹å™¨å•Ÿå‹•æ™‚è‡ªå‹•åˆ¤æ–·ç’°å¢ƒä¸¦åŸ·è¡Œå°æ‡‰çš„æ¸¬è©¦ã€‚ Dockerfile è©³è§£ é€™å€‹ Dockerfile æ¡ç”¨äº†å¤šéšæ®µå»ºæ§‹ (Multi-stage Builds) çš„æ–¹å¼ï¼Œä»¥ç¢ºä¿æœ€çµ‚æ˜ åƒæª”çš„è¼•é‡åŒ–å’Œæ¨¡çµ„åŒ–ã€‚\nç¬¬ä¸€éšæ®µï¼šæ‡‰ç”¨ç¨‹å¼å»ºæ§‹ (build éšæ®µ) é€™å€‹éšæ®µè² è²¬æº–å‚™ Node.js ç’°å¢ƒä¸¦æ‰“åŒ…æ‡‰ç”¨ç¨‹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 FROM ubuntu:22.04 AS build # è¨­å®šç’°å¢ƒè®Šæ•¸ ENV NVM_DIR /opt/nvm # NVM (Node Version Manager) çš„å®‰è£ç›®éŒ„ ENV NODE_VERSION v16.13.2 # æŒ‡å®šè¦å®‰è£çš„ Node.js ç‰ˆæœ¬ ENV APP_DIR /app # æ‡‰ç”¨ç¨‹å¼çš„å·¥ä½œç›®éŒ„ # å»ºç«‹å¿…è¦çš„ç›®éŒ„ RUN [ -d $APP_DIR ] || mkdir -p $APP_DIR RUN [ -d $NVM_DIR ] || mkdir -p $NVM_DIR # æ›´æ–°å¥—ä»¶åˆ—è¡¨ä¸¦å®‰è£ curl (ç”¨æ–¼ä¸‹è¼‰ NVM) RUN apt-get update \u0026amp;\u0026amp; apt-get install curl -y # å®‰è£ NVM å’ŒæŒ‡å®šç‰ˆæœ¬çš„ Node.js # å¾ GitHub ä¸‹è¼‰ NVM å®‰è£è…³æœ¬ RUN curl -o $NVM_DIR/install.sh https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh # åŸ·è¡Œ NVM å®‰è£è…³æœ¬ RUN /bin/bash $NVM_DIR/install.sh # è¨­å®š PATH ç’°å¢ƒè®Šæ•¸ï¼Œå°‡ Node.js å¯åŸ·è¡Œæª”åŠ å…¥è·¯å¾‘ ENV PATH $NVM_DIR/versions/node/$NODE_VERSION/bin:$PATH # è¤‡è£½æ‡‰ç”¨ç¨‹å¼æª”æ¡ˆ COPY test /app/test # è¤‡è£½ \u0026#39;test\u0026#39; ç›®éŒ„ COPY *.js /app/ # è¤‡è£½æ‰€æœ‰ .js æª”æ¡ˆ COPY *.json /app/ # è¤‡è£½æ‰€æœ‰ .json æª”æ¡ˆ COPY *.sh /app/ # è¤‡è£½æ‰€æœ‰ .sh è…³æœ¬ RUN chmod 0755 /app/*.sh # ç‚ºè…³æœ¬æ·»åŠ åŸ·è¡Œæ¬Šé™ # è¨­å®šå·¥ä½œç›®éŒ„ä¸¦å®‰è£ Node.js ä¾è³´ WORKDIR $APP_DIR RUN npm install ç¬¬äºŒéšæ®µï¼šSelenium ç€è¦½å™¨æ˜ åƒæª”å»ºæ§‹ (å¤šå€‹ FROM éšæ®µ) é€™å€‹ Dockerfile ç‚ºä¸åŒçš„ CPU æ¶æ§‹ (ARM64, x86_64) å’Œç€è¦½å™¨ (Firefox, Chrome) å®šç¾©äº†å¤šå€‹æœ€çµ‚æ˜ åƒæª”ã€‚æ¯å€‹éšæ®µéƒ½å¾ä¸€å€‹é å…ˆå»ºæ§‹å¥½çš„ Selenium æ˜ åƒæª”é–‹å§‹ï¼Œä¸¦å°‡ç¬¬ä¸€éšæ®µå»ºæ§‹å¥½çš„æ‡‰ç”¨ç¨‹å¼è¤‡è£½é€²ä¾†ã€‚\nARM64 æ¶æ§‹ - Firefox ç€è¦½å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 FROM seleniarm/standalone-firefox:latest AS arm64-firefox # è¨­å®šçµ‚ç«¯æ©Ÿå’Œèªè¨€ç’°å¢ƒè®Šæ•¸ ENV TERM=\u0026#34;xterm-color\u0026#34; ENV LANG=\u0026#39;en_US.UTF-8\u0026#39; ENV LANGUAGE=\u0026#39;en_US.UTF-8\u0026#39; # é‡æ–°è¨­å®š NVM å’Œæ‡‰ç”¨ç¨‹å¼ç›®éŒ„ (å› ç‚ºæ˜¯æ–°çš„ FROM éšæ®µ) ENV NVM_DIR /opt/nvm ENV NODE_VERSION v16.13.2 ENV APP_DIR /app # å»ºç«‹ç›®éŒ„ä¸¦èª¿æ•´æ¬Šé™ (ä½¿ç”¨ sudo å’Œ chown æ˜¯å› ç‚ºåŸºç¤æ˜ åƒæª”å¯èƒ½ä»¥é root ç”¨æˆ¶é‹è¡Œ) RUN [ -d $APP_DIR ] || (sudo mkdir -p $APP_DIR \u0026amp;\u0026amp; sudo chown `whoami`:`id -g -n` $APP_DIR) RUN [ -d $NVM_DIR ] || (sudo mkdir -p $NVM_DIR \u0026amp;\u0026amp; sudo chown `whoami`:`id -g -n` $NVM_DIR) # å¾ \u0026#39;build\u0026#39; éšæ®µè¤‡è£½ NVM å®‰è£è…³æœ¬ä¸¦åŸ·è¡Œ COPY --from=build $NVM_DIR/install.sh $NVM_DIR RUN /bin/bash $NVM_DIR/install.sh # è¨­å®š PATH ç’°å¢ƒè®Šæ•¸ ENV PATH $NVM_DIR/versions/node/$NODE_VERSION/bin:$PATH # å¾ \u0026#39;build\u0026#39; éšæ®µè¤‡è£½æ‡‰ç”¨ç¨‹å¼æª”æ¡ˆ COPY --from=build $APP_DIR $APP_DIR # èª¿æ•´æ‡‰ç”¨ç¨‹å¼ç›®éŒ„çš„æ“æœ‰è€…ç‚º \u0026#39;seluser\u0026#39; (Selenium æ˜ åƒæª”çš„é è¨­ç”¨æˆ¶) RUN chown seluser:seluser $APP_DIR # è¨­å®šå·¥ä½œç›®éŒ„ WORKDIR $APP_DIR # å®šç¾©å®¹å™¨å•Ÿå‹•æ™‚åŸ·è¡Œçš„å‘½ä»¤ (å°‡ç”± entrypoint.sh è…³æœ¬è™•ç†) CMD [ \u0026#34;/app/entrypoint.sh\u0026#34; ] ARM64 æ¶æ§‹ - Chrome ç€è¦½å™¨ 1 2 3 FROM seleniarm/standalone-chromium:latest AS arm64-chrome # ... (èˆ‡ arm64-firefox éšæ®µé¡ä¼¼çš„ç’°å¢ƒè®Šæ•¸ã€ç›®éŒ„å»ºç«‹ã€NVM å®‰è£ã€æ‡‰ç”¨ç¨‹å¼è¤‡è£½å’Œæ¬Šé™èª¿æ•´) ... CMD [ \u0026#34;/app/entrypoint.sh\u0026#34; ] x86_64 æ¶æ§‹ - Firefox ç€è¦½å™¨ 1 2 3 FROM selenium/standalone-firefox:latest AS x86_64-firefox # ... (èˆ‡ arm64-firefox éšæ®µé¡ä¼¼çš„ç’°å¢ƒè®Šæ•¸ã€ç›®éŒ„å»ºç«‹ã€NVM å®‰è£ã€æ‡‰ç”¨ç¨‹å¼è¤‡è£½å’Œæ¬Šé™èª¿æ•´) ... CMD [ \u0026#34;/app/entrypoint.sh\u0026#34; ] x86_64 æ¶æ§‹ - Chrome ç€è¦½å™¨ 1 2 3 FROM selenium/standalone-chrome:latest AS x86_64-chrome # ... (èˆ‡ arm64-firefox éšæ®µé¡ä¼¼çš„ç’°å¢ƒè®Šæ•¸ã€ç›®éŒ„å»ºç«‹ã€NVM å®‰è£ã€æ‡‰ç”¨ç¨‹å¼è¤‡è£½å’Œæ¬Šé™èª¿æ•´) ... CMD [ \u0026#34;/app/entrypoint.sh\u0026#34; ] entrypoint.sh è…³æœ¬è©³è§£ é€™å€‹è…³æœ¬æ˜¯å®¹å™¨å•Ÿå‹•æ™‚åŸ·è¡Œçš„å…¥å£é»ï¼Œå®ƒè² è²¬æ ¹æ“šé‹è¡Œç’°å¢ƒå‹•æ…‹åˆ¤æ–·è¦åŸ·è¡Œçš„ npm è…³æœ¬ï¼Œä¸¦ç¢ºä¿ Selenium æœå‹™å·²å•Ÿå‹•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #!/bin/bash # æ ¹æ“šå®¹å™¨ä¸­å­˜åœ¨çš„ç€è¦½å™¨å¯åŸ·è¡Œæª”ä¾†è¨­å®š SCRIPTS è®Šæ•¸ # å¦‚æœæ‰¾åˆ° firefoxï¼Œå‰‡ SCRIPTS ç‚º \u0026#34;docker-firefox\u0026#34; [ -f /usr/bin/firefox ] \u0026amp;\u0026amp; export SCRIPTS=\u0026#34;docker-firefox\u0026#34; # å¦‚æœæ‰¾åˆ° chromium-browser æˆ– google-chromeï¼Œå‰‡ SCRIPTS ç‚º \u0026#34;docker-chrome\u0026#34; [ -f /usr/bin/chromium-browser ] \u0026amp;\u0026amp; export SCRIPTS=\u0026#34;docker-chrome\u0026#34; [ -f /usr/bin/google-chrome ] \u0026amp;\u0026amp; export SCRIPTS=\u0026#34;docker-chrome\u0026#34; # åˆ¤æ–· CPU æ¶æ§‹ (uname -m æœƒå›å‚³æ©Ÿå™¨ç¡¬é«”åç¨±) uu=`uname -m` echo \u0026#39;uname -m:\u0026#39; $uu if [ \u0026#34;$uu\u0026#34; = \u0026#34;arm64\u0026#34; ] || [ \u0026#34;$uu\u0026#34; = \u0026#34;aarch64\u0026#34; ];then # å¦‚æœæ˜¯ ARM64 æ¶æ§‹ï¼Œå‰‡åœ¨ SCRIPTS å¾Œé¢åŠ ä¸Š \u0026#34;-arm64\u0026#34; export SCRIPTS=\u0026#34;$SCRIPTS-arm64\u0026#34; fi # å•Ÿå‹• Selenium æœå‹™çš„å…¥å£é»è…³æœ¬ (é€šå¸¸ç”±åŸºç¤æ˜ åƒæª”æä¾›) # å°‡æ¨™æº–è¼¸å‡ºå’Œæ¨™æº–éŒ¯èª¤é‡å®šå‘åˆ° /dev/nullï¼Œä½¿å…¶åœ¨èƒŒæ™¯éœé»˜é‹è¡Œ /opt/bin/entry_point.sh \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 \u0026amp; # ç­‰å¾… Selenium æœå‹™å•Ÿå‹• (æª¢æŸ¥ localhost:4444 æ˜¯å¦å¯è¨ªå•) for number in {1..120} # æœ€å¤šç­‰å¾… 120 ç§’ do if curl -s http://localhost:4444; then # -s éœé»˜æ¨¡å¼ï¼Œä¸é¡¯ç¤ºé€²åº¦æˆ–éŒ¯èª¤ break # å¦‚æœæˆåŠŸè¨ªå•ï¼Œå‰‡è·³å‡ºè¿´åœˆ fi echo \u0026#34;Waiting selenium service,\u0026#34; $number # é¡¯ç¤ºç­‰å¾…è¨Šæ¯ sleep 1 # æ¯ç§’æª¢æŸ¥ä¸€æ¬¡ done # å†æ¬¡æª¢æŸ¥ Selenium æœå‹™æ˜¯å¦æˆåŠŸå•Ÿå‹•ï¼Œå¦‚æœæ²’æœ‰å‰‡é€€å‡ºä¸¦å ±éŒ¯ if ! curl -s http://localhost:4444; then echo \u0026#34;Selenium service failed to start.\u0026#34; exit 1 fi # é€²å…¥æ‡‰ç”¨ç¨‹å¼ç›®éŒ„ cd /app # åŸ·è¡Œå°æ‡‰çš„ npm è…³æœ¬ echo \u0026#34;npm run $SCRIPTS\u0026#34; npm run $SCRIPTS æœ€ä½³å¯¦è¸èˆ‡è€ƒé‡ å¤šéšæ®µå»ºæ§‹ï¼šæ­¤ Dockerfile å……åˆ†åˆ©ç”¨äº†å¤šéšæ®µå»ºæ§‹çš„å„ªå‹¢ï¼Œå°‡å»ºæ§‹ç’°å¢ƒèˆ‡é‹è¡Œç’°å¢ƒåˆ†é›¢ï¼Œé¡¯è‘—æ¸›å°äº†æœ€çµ‚æ˜ åƒæª”çš„å¤§å°ï¼Œä¸¦æé«˜äº†å®‰å…¨æ€§ã€‚ è·¨å¹³å°æ”¯æ´ï¼šé€éç‚ºä¸åŒ CPU æ¶æ§‹å’Œç€è¦½å™¨å»ºç«‹ç¨ç«‹çš„éšæ®µï¼Œå¯¦ç¾äº†å–®ä¸€ Dockerfile æ”¯æ´å¤šç¨®é‹è¡Œç’°å¢ƒçš„èƒ½åŠ›ã€‚ æ¬Šé™ç®¡ç†ï¼šåœ¨è¤‡è£½æ‡‰ç”¨ç¨‹å¼æª”æ¡ˆå¾Œï¼Œä½¿ç”¨ chown èª¿æ•´æª”æ¡ˆæ“æœ‰è€…ï¼Œç¢ºä¿æ‡‰ç”¨ç¨‹å¼ä»¥é root ç”¨æˆ¶é‹è¡Œï¼Œé€™æ˜¯ä¸€å€‹é‡è¦çš„å®‰å…¨å¯¦è¸ã€‚ å¥å£¯çš„å•Ÿå‹•è…³æœ¬ï¼šentrypoint.sh è…³æœ¬åŒ…å«äº†ç­‰å¾…å¤–éƒ¨æœå‹™ (Selenium) å•Ÿå‹•çš„é‚è¼¯ï¼Œé€™ä½¿å¾—å®¹å™¨çš„å•Ÿå‹•æ›´åŠ å¥å£¯å’Œå¯é ã€‚ ç’°å¢ƒè®Šæ•¸ï¼šåˆç†ä½¿ç”¨ ENV æŒ‡ä»¤ä¾†ç®¡ç†ç‰ˆæœ¬è™Ÿå’Œè·¯å¾‘ï¼Œæé«˜äº† Dockerfile çš„å¯ç¶­è­·æ€§ã€‚ é€éé€™å€‹è©³ç´°çš„ Dockerfile å’Œå•Ÿå‹•è…³æœ¬ï¼Œæ‚¨å¯ä»¥é«˜æ•ˆåœ°å»ºæ§‹å’Œéƒ¨ç½²è·¨å¹³å°çš„ Selenium è‡ªå‹•åŒ–æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼ã€‚\n","permalink":"https://xinqilin.github.io/post/devops/dockerfile-docker_in_docker/","tags":["Docker","Dockerfile","Multi-stage Build","Selenium","Node.js","DevOps","Cross-platform"],"title":"å¤šéšæ®µ Dockerfileï¼šå»ºæ§‹è·¨å¹³å° Selenium æ‡‰ç”¨ç¨‹å¼æ˜ åƒæª”"},{"content":"æ¦‚è¿° Dockerfile æ˜¯ä¸€å€‹åŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤çš„æ–‡å­—æª”æ¡ˆï¼ŒDocker å¼•æ“æœƒè®€å–é€™äº›æŒ‡ä»¤ï¼Œä¸¦è‡ªå‹•å»ºæ§‹å‡º Docker æ˜ åƒæª” (Image)ã€‚å®ƒå®šç¾©äº†æ˜ åƒæª”çš„å…§å®¹ã€é‹è¡Œç’°å¢ƒä»¥åŠå•Ÿå‹•æ™‚åŸ·è¡Œçš„æŒ‡ä»¤ã€‚ç†è§£ Dockerfile æ˜¯æŒæ¡ Docker å®¹å™¨åŒ–æŠ€è¡“çš„é—œéµä¸€æ­¥ã€‚\nDockerfile æ ¸å¿ƒæŒ‡ä»¤è©³è§£ 1. åŸºç¤æŒ‡ä»¤ FROMï¼šæŒ‡å®šåŸºç¤æ˜ åƒæª”ã€‚Dockerfile çš„ç¬¬ä¸€æ¢æŒ‡ä»¤å¿…é ˆæ˜¯ FROMã€‚\nèªæ³•ï¼šFROM \u0026lt;image\u0026gt;[:\u0026lt;tag\u0026gt;] ç¯„ä¾‹ï¼šFROM ubuntu:18.04 (ä½¿ç”¨ Ubuntu 18.04 ä½œç‚ºåŸºç¤æ˜ åƒæª”) æ³¨æ„ï¼šå¦‚æœæœªæŒ‡å®š tagï¼Œé è¨­ç‚º latestã€‚å»ºè­°æ˜ç¢ºæŒ‡å®šç‰ˆæœ¬ï¼Œä»¥ç¢ºä¿å»ºæ§‹çš„å¯é‡è¤‡æ€§ã€‚ MAINTAINERï¼šæŒ‡å®šæ˜ åƒæª”çš„ç¶­è­·è€…è³‡è¨Šã€‚\nèªæ³•ï¼šMAINTAINER \u0026lt;name\u0026gt; [email] ç¯„ä¾‹ï¼šMAINTAINER Bill.Lin \u0026lt;zzx123bill@gmail.com\u0026gt; æ³¨æ„ï¼šæ­¤æŒ‡ä»¤å·²éæ™‚ï¼Œå»ºè­°ä½¿ç”¨ LABEL æŒ‡ä»¤ä¾†æ›¿ä»£ï¼Œä¾‹å¦‚ LABEL maintainer=\u0026quot;Bill.Lin \u0026lt;zzx123bill@gmail.com\u0026gt;\u0026quot;ã€‚ 2. åŸ·è¡ŒæŒ‡ä»¤ RUNï¼šåœ¨å»ºæ§‹æ˜ åƒæª”æ™‚åŸ·è¡Œå‘½ä»¤ã€‚æ¯å€‹ RUN æŒ‡ä»¤éƒ½æœƒåœ¨æ˜ åƒæª”ä¸­å»ºç«‹ä¸€å€‹æ–°çš„å±¤ (layer)ã€‚\nèªæ³•ï¼š RUN \u0026lt;command\u0026gt; (shell æ¨¡å¼ï¼Œé è¨­ä½¿ç”¨ /bin/sh -c åŸ·è¡Œ) RUN [\u0026quot;executable\u0026quot;, \u0026quot;param1\u0026quot;, \u0026quot;param2\u0026quot;] (exec æ¨¡å¼ï¼Œç›´æ¥åŸ·è¡Œå¯åŸ·è¡Œæª”) ç¯„ä¾‹ (shell æ¨¡å¼)ï¼š 1 2 RUN apt-get update -y \\ \u0026amp;\u0026amp; apt-get install nginx -y æ³¨æ„ï¼šä½¿ç”¨ \u0026amp;\u0026amp; å°‡å¤šå€‹å‘½ä»¤ä¸²è¯èµ·ä¾†ï¼Œå¯ä»¥æ¸›å°‘æ˜ åƒæª”å±¤æ•¸ï¼Œå„ªåŒ–æ˜ åƒæª”å¤§å°ã€‚ ç¯„ä¾‹ (exec æ¨¡å¼)ï¼š 1 2 RUN [\u0026#34;./test.php\u0026#34;, \u0026#34;dev\u0026#34;, \u0026#34;offline\u0026#34;] # ç­‰åŒæ–¼åœ¨å®¹å™¨å…§åŸ·è¡Œ `./test.php dev offline` CMDï¼šè¨­å®šå®¹å™¨å•Ÿå‹•æ™‚é è¨­åŸ·è¡Œçš„å‘½ä»¤ã€‚å¦‚æœ docker run å‘½ä»¤å¾Œå¸¶æœ‰åƒæ•¸ï¼ŒCMD çš„å‘½ä»¤æœƒè¢«è¦†è“‹ã€‚ä¸€å€‹ Dockerfile ä¸­åªèƒ½æœ‰ä¸€å€‹ CMDï¼Œå¤šå€‹ CMD åªæœ‰æœ€å¾Œä¸€å€‹ç”Ÿæ•ˆã€‚\nèªæ³•ï¼š CMD [\u0026quot;executable\u0026quot;, \u0026quot;param1\u0026quot;, \u0026quot;param2\u0026quot;] (exec æ¨¡å¼ï¼Œæ¨è–¦) CMD [\u0026quot;param1\u0026quot;, \u0026quot;param2\u0026quot;] (ä½œç‚º ENTRYPOINT çš„é è¨­åƒæ•¸) CMD command param1 param2 (shell æ¨¡å¼) ç¯„ä¾‹ï¼šCMD [\u0026quot;nginx\u0026quot;, \u0026quot;-g\u0026quot;, \u0026quot;daemon off;\u0026quot;] (å•Ÿå‹• Nginx ä¸¦ä¿æŒåœ¨å‰å°é‹è¡Œ) æ³¨æ„ï¼šCMD æœƒè¢« docker run \u0026lt;image\u0026gt; \u0026lt;command\u0026gt; ä¸­çš„ \u0026lt;command\u0026gt; è¦†è“‹ã€‚ ENTRYPOINTï¼šè¨­å®šå®¹å™¨å•Ÿå‹•æ™‚åŸ·è¡Œçš„å‘½ä»¤ã€‚ENTRYPOINT ä¸æœƒè¢« docker run å¾Œçš„åƒæ•¸è¦†è“‹ï¼Œè€Œæ˜¯å°‡é€™äº›åƒæ•¸ä½œç‚º ENTRYPOINT å‘½ä»¤çš„åƒæ•¸ã€‚\nèªæ³•ï¼šENTRYPOINT [\u0026quot;executable\u0026quot;, \u0026quot;param1\u0026quot;, \u0026quot;param2\u0026quot;] (exec æ¨¡å¼ï¼Œæ¨è–¦) ç¯„ä¾‹ï¼šENTRYPOINT [\u0026quot;docker-entrypoint.sh\u0026quot;] CMD èˆ‡ ENTRYPOINT çµ„åˆä½¿ç”¨ï¼š ç•¶ ENTRYPOINT å’Œ CMD éƒ½ä½¿ç”¨ exec æ¨¡å¼æ™‚ï¼ŒCMD çš„å…§å®¹æœƒä½œç‚º ENTRYPOINT çš„åƒæ•¸ã€‚ 1 2 3 4 FROM nginx ENTRYPOINT [\u0026#34;nginx\u0026#34;, \u0026#34;-c\u0026#34;] CMD [\u0026#34;/etc/nginx/nginx.conf\u0026#34;] # å®¹å™¨å•Ÿå‹•æ™‚å¯¦éš›åŸ·è¡Œï¼šnginx -c /etc/nginx/nginx.conf é€™ç¨®çµ„åˆå¸¸ç”¨æ–¼è¨­å®šå›ºå®šçš„å•Ÿå‹•å‘½ä»¤ï¼ŒåŒæ™‚å…è¨±ä½¿ç”¨è€…é€é CMD æˆ– docker run åƒæ•¸ä¾†æä¾›é è¨­æˆ–è‡ªè¨‚çš„åƒæ•¸ã€‚ 3. ç’°å¢ƒè¨­å®š WORKDIRï¼šè¨­å®šå·¥ä½œç›®éŒ„ã€‚å¾ŒçºŒçš„ RUN, CMD, ENTRYPOINT, COPY, ADD æŒ‡ä»¤éƒ½æœƒåœ¨é€™å€‹ç›®éŒ„ä¸‹åŸ·è¡Œã€‚\nèªæ³•ï¼šWORKDIR /path/to/workdir ç¯„ä¾‹ï¼š 1 2 WORKDIR /app COPY . /app # å°‡å»ºæ§‹ä¸Šä¸‹æ–‡ä¸­çš„æª”æ¡ˆè¤‡è£½åˆ°å®¹å™¨çš„ /app ç›®éŒ„ USERï¼šæŒ‡å®šé‹è¡Œå®¹å™¨æ™‚çš„ç”¨æˆ¶æˆ–ç”¨æˆ¶çµ„ã€‚\nèªæ³•ï¼šUSER \u0026lt;user\u0026gt;[:\u0026lt;group\u0026gt;] ç¯„ä¾‹ï¼šUSER nobody (ä»¥é root ç”¨æˆ¶é‹è¡Œï¼Œæé«˜å®‰å…¨æ€§) æ³¨æ„ï¼šé è¨­ç‚º rootã€‚åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œå»ºè­°ä½¿ç”¨é root ç”¨æˆ¶é‹è¡Œæ‡‰ç”¨ç¨‹å¼ã€‚ VOLUMEï¼šå»ºç«‹ä¸€å€‹æ›è¼‰é»ï¼Œå°‡å®¹å™¨å…§çš„è·¯å¾‘æ¨™è¨˜ç‚ºå¤–éƒ¨æ›è¼‰é»ï¼Œç”¨æ–¼æŒä¹…åŒ–è³‡æ–™æˆ–å…±äº«è³‡æ–™ã€‚\nèªæ³•ï¼šVOLUME [\u0026quot;/data\u0026quot;] ç¯„ä¾‹ï¼šVOLUME /var/lib/mysql (å°‡ MySQL è³‡æ–™ç›®éŒ„æ¨™è¨˜ç‚ºå„²å­˜å·) ARGï¼šå®šç¾©å»ºæ§‹æ™‚çš„è®Šæ•¸ã€‚é€™äº›è®Šæ•¸åªåœ¨ docker build éç¨‹ä¸­æœ‰æ•ˆï¼Œä¸æœƒä¿ç•™åœ¨æœ€çµ‚çš„æ˜ åƒæª”ä¸­ã€‚\nèªæ³•ï¼šARG \u0026lt;name\u0026gt;[=\u0026lt;default value\u0026gt;] ç¯„ä¾‹ï¼š 1 2 ARG VERSION=1.0 FROM myapp:${VERSION} ä½¿ç”¨ï¼šdocker build --build-arg VERSION=2.0 . ENVï¼šè¨­å®šç’°å¢ƒè®Šæ•¸ã€‚é€™äº›è®Šæ•¸æœƒä¿ç•™åœ¨æœ€çµ‚çš„æ˜ åƒæª”ä¸­ï¼Œä¸¦åœ¨å®¹å™¨é‹è¡Œæ™‚å¯ç”¨ã€‚\nèªæ³•ï¼šENV \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; ... ç¯„ä¾‹ï¼š 1 2 ENV MY_PATH /usr/local WORKDIR $MY_PATH # WORKDIR å¯ä»¥ä½¿ç”¨ ENV å®šç¾©çš„è®Šæ•¸ EXPOSEï¼šè²æ˜å®¹å™¨é‹è¡Œæ™‚ç›£è½çš„åŸ ã€‚é€™åªæ˜¯ä¸€å€‹æ–‡ä»¶èªªæ˜ï¼Œä¸¦ä¸æœƒå¯¦éš›ç™¼å¸ƒåŸ ã€‚è¦ç™¼å¸ƒåŸ ï¼Œéœ€è¦åœ¨ docker run æˆ– docker-compose.yml ä¸­ä½¿ç”¨ -p æˆ– portsã€‚\nèªæ³•ï¼šEXPOSE \u0026lt;port\u0026gt; [\u0026lt;port\u0026gt;...] ç¯„ä¾‹ï¼šEXPOSE 8080 (è²æ˜å®¹å™¨æœƒç›£è½ 8080 åŸ ) 4. æª”æ¡ˆæ“ä½œ COPYï¼šå°‡å»ºæ§‹ä¸Šä¸‹æ–‡ä¸­çš„æª”æ¡ˆæˆ–ç›®éŒ„è¤‡è£½åˆ°æ˜ åƒæª”ä¸­ã€‚\nèªæ³•ï¼šCOPY \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt; ç¯„ä¾‹ï¼šCOPY ./target/mms.war /app/mms.war (å°‡ä¸»æ©Ÿ target ç›®éŒ„ä¸‹çš„ mms.war è¤‡è£½åˆ°å®¹å™¨çš„ /app ç›®éŒ„) æ³¨æ„ï¼šCOPY åªèƒ½è¤‡è£½æœ¬åœ°å»ºæ§‹ä¸Šä¸‹æ–‡ä¸­çš„æª”æ¡ˆã€‚ ADDï¼šèˆ‡ COPY é¡ä¼¼ï¼Œä½† ADD å…·æœ‰é¡å¤–çš„åŠŸèƒ½ï¼š\nå¦‚æœ \u0026lt;src\u0026gt; æ˜¯ä¸€å€‹å£“ç¸®æª” (å¦‚ .tar, .gz, .zip)ï¼Œå®ƒæœƒè‡ªå‹•è§£å£“ç¸®åˆ° \u0026lt;dest\u0026gt;ã€‚ å¦‚æœ \u0026lt;src\u0026gt; æ˜¯ä¸€å€‹ URLï¼Œå®ƒæœƒå¾è©² URL ä¸‹è¼‰æª”æ¡ˆã€‚ èªæ³•ï¼šADD \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt; ç¯„ä¾‹ï¼šADD https://example.com/app.tar.gz /app/ æ³¨æ„ï¼šç”±æ–¼ ADD çš„è‡ªå‹•è§£å£“ç¸®å’Œ URL ä¸‹è¼‰åŠŸèƒ½å¯èƒ½å°è‡´ä¸ç¢ºå®šæ€§ï¼Œé€šå¸¸å»ºè­°å„ªå…ˆä½¿ç”¨ COPYï¼Œé™¤éæ‚¨æ˜ç¢ºéœ€è¦ ADD çš„ç‰¹æ®ŠåŠŸèƒ½ã€‚ Docker Build æµç¨‹ ä½¿ç”¨ docker build å‘½ä»¤ä¾†å»ºæ§‹ Docker æ˜ åƒæª”ã€‚\nèªæ³•ï¼šdocker build [OPTIONS] PATH | URL | - ç¯„ä¾‹ï¼šdocker build -t my-app:1.0 . -t my-app:1.0ï¼šç‚ºæ˜ åƒæª”æŒ‡å®šåç¨±å’Œæ¨™ç±¤ã€‚ .ï¼šæŒ‡å®šå»ºæ§‹ä¸Šä¸‹æ–‡çš„è·¯å¾‘ã€‚Docker æœƒå°‡æ­¤è·¯å¾‘ä¸‹çš„æ‰€æœ‰æª”æ¡ˆç™¼é€åˆ° Docker Daemonï¼Œä½œç‚ºå»ºæ§‹éç¨‹çš„ä¸Šä¸‹æ–‡ã€‚ ç¯„ä¾‹ï¼šJava Spring Boot æ‡‰ç”¨ç¨‹å¼çš„å¤šéšæ®µå»ºæ§‹ å¤šéšæ®µå»ºæ§‹ (Multi-stage Builds) å…è¨±æ‚¨åœ¨ä¸€å€‹ Dockerfile ä¸­ä½¿ç”¨å¤šå€‹ FROM æŒ‡ä»¤ã€‚æ¯å€‹ FROM æŒ‡ä»¤éƒ½å¯ä»¥ä½¿ç”¨ä¸åŒçš„åŸºç¤æ˜ åƒæª”ï¼Œä¸¦ä¸”æ¯å€‹éšæ®µéƒ½å¯ä»¥ç¨ç«‹åœ°å»ºæ§‹ã€‚æœ€çµ‚çš„æ˜ åƒæª”åªåŒ…å«æ‚¨éœ€è¦çš„æœ€çµ‚ç”¢ç‰©ï¼Œå¤§å¤§æ¸›å°‘äº†æ˜ åƒæª”çš„å¤§å°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 # --- ç¬¬ä¸€éšæ®µï¼šå»ºæ§‹æ‡‰ç”¨ç¨‹å¼ --- # ä½¿ç”¨ä¸€å€‹åŒ…å« Java é–‹ç™¼å·¥å…·åŒ… (JDK) çš„æ˜ åƒæª”ä¾†ç·¨è­¯å’Œæ‰“åŒ…æ‡‰ç”¨ç¨‹å¼ FROM openjdk:11-jdk-slim AS build # è¨­å®šå·¥ä½œç›®éŒ„ WORKDIR /app # å°‡ Maven çš„è¨­å®šæª”è¤‡è£½åˆ°å®¹å™¨ä¸­ (å¦‚æœæœ‰çš„è©±) # COPY settings.xml /root/.m2/ # å°‡å°ˆæ¡ˆçš„ pom.xml è¤‡è£½åˆ°å®¹å™¨ä¸­ï¼Œä¸¦ä¸‹è¼‰ä¾è³´ï¼Œåˆ©ç”¨ Docker å±¤å¿«å– COPY pom.xml . RUN mvn dependency:go-offline # å°‡æ‰€æœ‰åŸå§‹ç¢¼è¤‡è£½åˆ°å®¹å™¨ä¸­ COPY src ./src # ç·¨è­¯ä¸¦æ‰“åŒ…æ‡‰ç”¨ç¨‹å¼ï¼Œç”Ÿæˆ JAR æª”æ¡ˆ RUN mvn clean package -DskipTests # --- ç¬¬äºŒéšæ®µï¼šé‹è¡Œæ‡‰ç”¨ç¨‹å¼ --- # ä½¿ç”¨ä¸€å€‹è¼•é‡ç´šçš„ Java é‹è¡Œç’°å¢ƒ (JRE) æ˜ åƒæª”ä¾†é‹è¡Œæ‡‰ç”¨ç¨‹å¼ FROM openjdk:11-jre-slim # è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ŒæŒ‡å®šæ‡‰ç”¨ç¨‹å¼çš„ JAR æª”æ¡ˆè·¯å¾‘ ENV APP_HOME=/app # è¨­å®šå·¥ä½œç›®éŒ„ WORKDIR $APP_HOME # å¾ç¬¬ä¸€éšæ®µè¤‡è£½ç·¨è­¯å¥½çš„ JAR æª”æ¡ˆ COPY --from=build /app/target/*.jar app.jar # æš´éœ²æ‡‰ç”¨ç¨‹å¼ç›£è½çš„åŸ  EXPOSE 8080 # å®šç¾©å®¹å™¨å•Ÿå‹•æ™‚åŸ·è¡Œçš„å‘½ä»¤ ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] é€™å€‹ç¯„ä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨å¤šéšæ®µå»ºæ§‹ä¾†ï¼š\nåœ¨ç¬¬ä¸€å€‹éšæ®µ (build) ä¸­ç·¨è­¯ Java æ‡‰ç”¨ç¨‹å¼ï¼Œç”Ÿæˆä¸€å€‹ JAR æª”æ¡ˆã€‚ åœ¨ç¬¬äºŒå€‹éšæ®µä¸­ï¼Œåªè¤‡è£½æœ€çµ‚çš„ JAR æª”æ¡ˆåˆ°ä¸€å€‹æ›´å°çš„ JRE åŸºç¤æ˜ åƒæª”ä¸­ã€‚ é€™æ¨£å¯ä»¥é¿å…å°‡ç·¨è­¯å·¥å…·ã€åŸå§‹ç¢¼ç­‰ä¸å¿…è¦çš„å…§å®¹åŒ…å«åœ¨æœ€çµ‚çš„é‹è¡Œæ˜ åƒæª”ä¸­ï¼Œå¾è€Œé¡¯è‘—æ¸›å°æ˜ åƒæª”å¤§å°ï¼Œæé«˜å®‰å…¨æ€§å’Œéƒ¨ç½²æ•ˆç‡ã€‚\né€éç†Ÿç·´æŒæ¡ Dockerfile çš„å„é …æŒ‡ä»¤å’Œæœ€ä½³å¯¦è¸ï¼Œæ‚¨å¯ä»¥æ›´æœ‰æ•ˆåœ°å»ºæ§‹å’Œç®¡ç†æ‚¨çš„ Docker æ˜ åƒæª”ã€‚\n","permalink":"https://xinqilin.github.io/post/devops/dockerfile-basic/","tags":["Docker","Dockerfile","DevOps","Containerization","Image Build"],"title":"Dockerfile åŸºç¤ï¼šå»ºæ§‹ Docker æ˜ åƒæª”çš„æ ¸å¿ƒæŒ‡ä»¤"},{"content":"UML çµ±ä¸€å»ºæ¨¡èªè¨€å®Œæ•´æŒ‡å— æ¦‚è¿° UMLï¼ˆUnified Modeling Languageï¼Œçµ±ä¸€å»ºæ¨¡èªè¨€ï¼‰æ˜¯ä¸€ç¨®æ¨™æº–åŒ–çš„å»ºæ¨¡èªè¨€ï¼Œç”¨æ–¼è»Ÿé«”ç³»çµ±çš„è¦–è¦ºåŒ–ã€è¦ç¯„ã€å»ºæ§‹å’Œæ–‡æª”åŒ–ã€‚UML æä¾›äº†å¤šç¨®åœ–å½¢è¡¨ç¤ºæ³•ï¼Œå¹«åŠ©é–‹ç™¼äººå“¡ç†è§£ç³»çµ±çµæ§‹ã€è¡Œç‚ºå’Œäº’å‹•é—œä¿‚ã€‚\nUML åœ–å½¢åˆ†é¡ çµæ§‹åœ–ï¼ˆStructure Diagramsï¼‰ é¡åˆ¥åœ–ï¼ˆClass Diagramï¼‰ï¼šå±•ç¤ºé¡åˆ¥åŠå…¶é—œä¿‚ ç‰©ä»¶åœ–ï¼ˆObject Diagramï¼‰ï¼šå±•ç¤ºç‰¹å®šæ™‚åˆ»çš„ç‰©ä»¶å¯¦ä¾‹ å°è£åœ–ï¼ˆPackage Diagramï¼‰ï¼šå±•ç¤ºå¥—ä»¶åŠå…¶ä¾è³´é—œä¿‚ éƒ¨ç½²åœ–ï¼ˆDeployment Diagramï¼‰ï¼šå±•ç¤ºç³»çµ±éƒ¨ç½²çµæ§‹ è¡Œç‚ºåœ–ï¼ˆBehavior Diagramsï¼‰ ä½¿ç”¨æ¡ˆä¾‹åœ–ï¼ˆUse Case Diagramï¼‰ï¼šå±•ç¤ºç³»çµ±åŠŸèƒ½å’Œç”¨æˆ¶äº’å‹• æ´»å‹•åœ–ï¼ˆActivity Diagramï¼‰ï¼šå±•ç¤ºå·¥ä½œæµç¨‹å’Œæ¥­å‹™é‚è¼¯ ç‹€æ…‹åœ–ï¼ˆState Diagramï¼‰ï¼šå±•ç¤ºç‰©ä»¶ç‹€æ…‹è®ŠåŒ– äº’å‹•åœ–ï¼ˆInteraction Diagramsï¼‰ åºåˆ—åœ–ï¼ˆSequence Diagramï¼‰ï¼šå±•ç¤ºç‰©ä»¶é–“çš„æ™‚é–“é †åºäº’å‹• å”ä½œåœ–ï¼ˆCollaboration Diagramï¼‰ï¼šå±•ç¤ºç‰©ä»¶é–“çš„å”ä½œé—œä¿‚ æ™‚åºåœ–ï¼ˆTiming Diagramï¼‰ï¼šå±•ç¤ºç‰©ä»¶åœ¨æ™‚é–“è»¸ä¸Šçš„ç‹€æ…‹è®ŠåŒ– é¡åˆ¥åœ–é—œä¿‚è©³è§£ 1. ä¾è³´é—œä¿‚ï¼ˆDependencyï¼‰ ç¬¦è™Ÿï¼š è™›ç·šç®­é ­ A -----\u0026gt; B\næ„ç¾©ï¼š A é¡åˆ¥ä½¿ç”¨ B é¡åˆ¥ï¼Œé€šå¸¸æ˜¯è‡¨æ™‚æ€§çš„ä½¿ç”¨é—œä¿‚ï¼Œå¦‚æ–¹æ³•åƒæ•¸ã€å±€éƒ¨è®Šæ•¸æˆ–éœæ…‹æ–¹æ³•èª¿ç”¨ã€‚\nJava å¯¦ç¾ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // ä¾è³´é—œä¿‚ç¤ºä¾‹ public class OrderService { // æ–¹æ³•åƒæ•¸ä¾è³´ public void processOrder(Order order, PaymentProcessor processor) { // OrderService ä¾è³´ PaymentProcessor processor.processPayment(order.getAmount()); } // éœæ…‹æ–¹æ³•ä¾è³´ public void validateOrder(Order order) { // OrderService ä¾è³´ OrderValidator if (!OrderValidator.validate(order)) { throw new ValidationException(\u0026#34;ç„¡æ•ˆçš„è¨‚å–®\u0026#34;); } } // å±€éƒ¨è®Šæ•¸ä¾è³´ public void sendNotification(Order order) { // OrderService ä¾è³´ EmailService EmailService emailService = new EmailService(); emailService.sendOrderConfirmation(order); } } // è¢«ä¾è³´çš„é¡ public class PaymentProcessor { public void processPayment(BigDecimal amount) { // è™•ç†ä»˜æ¬¾é‚è¼¯ } } public class OrderValidator { public static boolean validate(Order order) { return order != null \u0026amp;\u0026amp; order.getAmount() != null; } } public class EmailService { public void sendOrderConfirmation(Order order) { // ç™¼é€ç¢ºèªéƒµä»¶ } } 2. é—œè¯é—œä¿‚ï¼ˆAssociationï¼‰ ç¬¦è™Ÿï¼š å¯¦ç·šç®­é ­ A -----\u0026gt; B\næ„ç¾©ï¼š é•·æœŸçš„çµæ§‹æ€§é—œä¿‚ï¼Œä¸€å€‹é¡åˆ¥çŸ¥é“å¦ä¸€å€‹é¡åˆ¥çš„å­˜åœ¨ã€‚\nJava å¯¦ç¾ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // å–®å‘é—œè¯ public class Customer { private String name; private String email; // Customer é—œè¯åˆ° Order private List\u0026lt;Order\u0026gt; orders = new ArrayList\u0026lt;\u0026gt;(); public void addOrder(Order order) { orders.add(order); } public List\u0026lt;Order\u0026gt; getOrders() { return new ArrayList\u0026lt;\u0026gt;(orders); } } // é›™å‘é—œè¯ public class Order { private String orderId; private BigDecimal amount; // Order é—œè¯åˆ° Customer private Customer customer; public Order(Customer customer) { this.customer = customer; customer.addOrder(this); } public Customer getCustomer() { return customer; } } // å¤šå°å¤šé—œè¯ public class Student { private String name; private List\u0026lt;Course\u0026gt; courses = new ArrayList\u0026lt;\u0026gt;(); public void enrollCourse(Course course) { courses.add(course); course.addStudent(this); } } public class Course { private String name; private List\u0026lt;Student\u0026gt; students = new ArrayList\u0026lt;\u0026gt;(); public void addStudent(Student student) { students.add(student); } } 3. èšåˆé—œä¿‚ï¼ˆAggregationï¼‰ ç¬¦è™Ÿï¼š ç©ºå¿ƒè±å½¢ A â—‡-----\u0026gt; B\næ„ç¾©ï¼š \u0026ldquo;has-a\u0026rdquo; é—œä¿‚ï¼Œæ•´é«”åŒ…å«éƒ¨åˆ†ï¼Œä½†éƒ¨åˆ†å¯ä»¥ç¨ç«‹å­˜åœ¨ã€‚\nJava å¯¦ç¾ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // èšåˆé—œä¿‚ç¤ºä¾‹ public class Department { private String name; private List\u0026lt;Employee\u0026gt; employees = new ArrayList\u0026lt;\u0026gt;(); public Department(String name) { this.name = name; } // èšåˆï¼šéƒ¨é–€åŒ…å«å“¡å·¥ï¼Œä½†å“¡å·¥å¯ä»¥ç¨ç«‹å­˜åœ¨ public void addEmployee(Employee employee) { employees.add(employee); } public void removeEmployee(Employee employee) { employees.remove(employee); } public List\u0026lt;Employee\u0026gt; getEmployees() { return new ArrayList\u0026lt;\u0026gt;(employees); } } public class Employee { private String name; private String position; public Employee(String name, String position) { this.name = name; this.position = position; } // å“¡å·¥å¯ä»¥ç¨ç«‹å­˜åœ¨ï¼Œä¸ä¾è³´æ–¼éƒ¨é–€ public void work() { System.out.println(name + \u0026#34; æ­£åœ¨å·¥ä½œ\u0026#34;); } } // ä½¿ç”¨ç¯„ä¾‹ public class CompanyExample { public static void main(String[] args) { Department itDepartment = new Department(\u0026#34;ITéƒ¨é–€\u0026#34;); Employee emp1 = new Employee(\u0026#34;å¼µä¸‰\u0026#34;, \u0026#34;è»Ÿé«”å·¥ç¨‹å¸«\u0026#34;); Employee emp2 = new Employee(\u0026#34;æå››\u0026#34;, \u0026#34;ç³»çµ±åˆ†æå¸«\u0026#34;); itDepartment.addEmployee(emp1); itDepartment.addEmployee(emp2); // å“¡å·¥å¯ä»¥é›¢é–‹éƒ¨é–€ï¼Œä½†ä»ç„¶å­˜åœ¨ itDepartment.removeEmployee(emp1); emp1.work(); // å“¡å·¥ä¾ç„¶å¯ä»¥å·¥ä½œ } } 4. çµ„åˆé—œä¿‚ï¼ˆCompositionï¼‰ ç¬¦è™Ÿï¼š å¯¦å¿ƒè±å½¢ A â—†-----\u0026gt; B\næ„ç¾©ï¼š å¼·èšåˆé—œä¿‚ï¼Œæ•´é«”å’Œéƒ¨åˆ†çš„ç”Ÿå‘½é€±æœŸç›¸åŒï¼Œéƒ¨åˆ†ä¸èƒ½ç¨ç«‹å­˜åœ¨ã€‚\nJava å¯¦ç¾ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 // çµ„åˆé—œä¿‚ç¤ºä¾‹ public class House { private String address; private List\u0026lt;Room\u0026gt; rooms = new ArrayList\u0026lt;\u0026gt;(); public House(String address) { this.address = address; // çµ„åˆï¼šæˆ¿å­å‰µå»ºæ™‚ï¼Œæˆ¿é–“ä¹Ÿè¢«å‰µå»º initializeRooms(); } private void initializeRooms() { rooms.add(new Room(\u0026#34;å®¢å»³\u0026#34;, 30)); rooms.add(new Room(\u0026#34;è‡¥å®¤\u0026#34;, 20)); rooms.add(new Room(\u0026#34;å»šæˆ¿\u0026#34;, 15)); } public void addRoom(String name, int area) { rooms.add(new Room(name, area)); } public List\u0026lt;Room\u0026gt; getRooms() { return new ArrayList\u0026lt;\u0026gt;(rooms); } // æˆ¿å­éŠ·æ¯€æ™‚ï¼Œæˆ¿é–“ä¹Ÿéš¨ä¹‹éŠ·æ¯€ public void demolish() { rooms.clear(); System.out.println(\u0026#34;æˆ¿å­è¢«æ‹†æ¯€ï¼Œæ‰€æœ‰æˆ¿é–“ä¹Ÿæ¶ˆå¤±äº†\u0026#34;); } // å…§éƒ¨é¡ï¼Œç”Ÿå‘½é€±æœŸèˆ‡å¤–éƒ¨é¡ç›¸åŒ private class Room { private String name; private int area; public Room(String name, int area) { this.name = name; this.area = area; } public String getName() { return name; } public int getArea() { return area; } } } // å¦ä¸€å€‹çµ„åˆé—œä¿‚ç¤ºä¾‹ public class Car { private String brand; private Engine engine; private List\u0026lt;Wheel\u0026gt; wheels = new ArrayList\u0026lt;\u0026gt;(); public Car(String brand) { this.brand = brand; // çµ„åˆï¼šæ±½è»Šå‰µå»ºæ™‚ï¼Œå¼•æ“å’Œè»Šè¼ªä¹Ÿè¢«å‰µå»º this.engine = new Engine(2000); initializeWheels(); } private void initializeWheels() { for (int i = 0; i \u0026lt; 4; i++) { wheels.add(new Wheel(16)); } } public void start() { engine.start(); System.out.println(brand + \u0026#34; æ±½è»Šå•Ÿå‹•\u0026#34;); } // æ±½è»ŠéŠ·æ¯€æ™‚ï¼Œå¼•æ“å’Œè»Šè¼ªä¹Ÿéš¨ä¹‹éŠ·æ¯€ public void destroy() { engine.stop(); wheels.clear(); System.out.println(brand + \u0026#34; æ±½è»Šè¢«éŠ·æ¯€\u0026#34;); } // å…§éƒ¨é¡ï¼Œé«”ç¾çµ„åˆé—œä¿‚ private class Engine { private int displacement; public Engine(int displacement) { this.displacement = displacement; } public void start() { System.out.println(\u0026#34;å¼•æ“å•Ÿå‹•ï¼š\u0026#34; + displacement + \u0026#34;cc\u0026#34;); } public void stop() { System.out.println(\u0026#34;å¼•æ“åœæ­¢\u0026#34;); } } private class Wheel { private int size; public Wheel(int size) { this.size = size; } public int getSize() { return size; } } } 5. å¯¦ç¾é—œä¿‚ï¼ˆImplementationï¼‰ ç¬¦è™Ÿï¼š è™›ç·šä¸‰è§’ç®­é ­ A ----â–· B\næ„ç¾©ï¼š é¡åˆ¥å¯¦ç¾ä»‹é¢æˆ–æŠ½è±¡é¡åˆ¥ã€‚\nJava å¯¦ç¾ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 // ä»‹é¢å®šç¾© public interface PaymentProcessor { void processPayment(BigDecimal amount); boolean validatePayment(PaymentRequest request); } // å…·é«”å¯¦ç¾é¡ public class CreditCardProcessor implements PaymentProcessor { @Override public void processPayment(BigDecimal amount) { System.out.println(\u0026#34;ä½¿ç”¨ä¿¡ç”¨å¡è™•ç†ä»˜æ¬¾: \u0026#34; + amount); } @Override public boolean validatePayment(PaymentRequest request) { return request.getCreditCardNumber() != null \u0026amp;\u0026amp; request.getExpiryDate() != null \u0026amp;\u0026amp; request.getCvv() != null; } } public class PayPalProcessor implements PaymentProcessor { @Override public void processPayment(BigDecimal amount) { System.out.println(\u0026#34;ä½¿ç”¨ PayPal è™•ç†ä»˜æ¬¾: \u0026#34; + amount); } @Override public boolean validatePayment(PaymentRequest request) { return request.getPaypalEmail() != null \u0026amp;\u0026amp; request.getPassword() != null; } } // æŠ½è±¡é¡åˆ¥å¯¦ç¾ public abstract class AbstractVehicle { protected String brand; protected String model; public AbstractVehicle(String brand, String model) { this.brand = brand; this.model = model; } public abstract void start(); public abstract void stop(); public void displayInfo() { System.out.println(\u0026#34;å“ç‰Œ: \u0026#34; + brand + \u0026#34;, å‹è™Ÿ: \u0026#34; + model); } } public class Motorcycle extends AbstractVehicle { public Motorcycle(String brand, String model) { super(brand, model); } @Override public void start() { System.out.println(\u0026#34;æ©Ÿè»Šå•Ÿå‹•\u0026#34;); } @Override public void stop() { System.out.println(\u0026#34;æ©Ÿè»Šåœæ­¢\u0026#34;); } } 6. ç¹¼æ‰¿é—œä¿‚ï¼ˆInheritanceï¼‰ ç¬¦è™Ÿï¼š å¯¦ç·šä¸‰è§’ç®­é ­ A ----â–· B\næ„ç¾©ï¼š \u0026ldquo;is-a\u0026rdquo; é—œä¿‚ï¼Œå­é¡åˆ¥ç¹¼æ‰¿çˆ¶é¡åˆ¥çš„å±¬æ€§å’Œæ–¹æ³•ã€‚\nJava å¯¦ç¾ç¯„ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 // çˆ¶é¡åˆ¥ public class Animal { protected String name; protected int age; public Animal(String name, int age) { this.name = name; this.age = age; } public void eat() { System.out.println(name + \u0026#34; æ­£åœ¨åƒé£Ÿç‰©\u0026#34;); } public void sleep() { System.out.println(name + \u0026#34; æ­£åœ¨ç¡è¦º\u0026#34;); } public void makeSound() { System.out.println(name + \u0026#34; ç™¼å‡ºè²éŸ³\u0026#34;); } } // å­é¡åˆ¥ - ç¹¼æ‰¿ Animal public class Dog extends Animal { private String breed; public Dog(String name, int age, String breed) { super(name, age); this.breed = breed; } @Override public void makeSound() { System.out.println(name + \u0026#34; æ±ªæ±ªå«\u0026#34;); } public void fetch() { System.out.println(name + \u0026#34; æ­£åœ¨æ’¿çƒ\u0026#34;); } } public class Cat extends Animal { private boolean isIndoor; public Cat(String name, int age, boolean isIndoor) { super(name, age); this.isIndoor = isIndoor; } @Override public void makeSound() { System.out.println(name + \u0026#34; å–µå–µå«\u0026#34;); } public void climb() { System.out.println(name + \u0026#34; æ­£åœ¨çˆ¬æ¨¹\u0026#34;); } } // å¤šå±¤ç¹¼æ‰¿ public class WorkingDog extends Dog { private String jobType; public WorkingDog(String name, int age, String breed, String jobType) { super(name, age, breed); this.jobType = jobType; } public void work() { System.out.println(name + \u0026#34; æ­£åœ¨åŸ·è¡Œ \u0026#34; + jobType + \u0026#34; å·¥ä½œ\u0026#34;); } } è¨­è¨ˆæ¨¡å¼çš„ UML è¡¨ç¤º 1. å–®ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /** * UML é¡åˆ¥åœ–: * * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ Singleton â”‚ * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ * â”‚ - instance: Singleton â”‚ * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ * â”‚ - Singleton() â”‚ * â”‚ + getInstance(): Singleton â”‚ * â”‚ + doSomething(): void â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */ public class Singleton { private static volatile Singleton instance; private Singleton() {} public static Singleton getInstance() { if (instance == null) { synchronized (Singleton.class) { if (instance == null) { instance = new Singleton(); } } } return instance; } public void doSomething() { System.out.println(\u0026#34;åŸ·è¡Œæ¥­å‹™é‚è¼¯\u0026#34;); } } 2. å·¥å» æ¨¡å¼ï¼ˆFactory Patternï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 /** * UML é¡åˆ¥åœ–: * * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ Product â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ ProductFactory â”‚ * â”‚ \u0026lt;\u0026lt;interface\u0026gt;\u0026gt; â”‚ â”‚ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â–³ â”‚ * â”‚ â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ * â”‚ ConcreteProduct â”‚ â”‚ * â”‚ â”‚ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ * â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ConcreteFactory â”‚ * â”‚ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */ public interface Product { void use(); } public class ConcreteProductA implements Product { @Override public void use() { System.out.println(\u0026#34;ä½¿ç”¨ç”¢å“ A\u0026#34;); } } public class ConcreteProductB implements Product { @Override public void use() { System.out.println(\u0026#34;ä½¿ç”¨ç”¢å“ B\u0026#34;); } } public class ProductFactory { public static Product createProduct(String type) { switch (type.toLowerCase()) { case \u0026#34;a\u0026#34;: return new ConcreteProductA(); case \u0026#34;b\u0026#34;: return new ConcreteProductB(); default: throw new IllegalArgumentException(\u0026#34;æœªçŸ¥çš„ç”¢å“é¡å‹: \u0026#34; + type); } } } 3. è§€å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 /** * UML é¡åˆ¥åœ–: * * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ Subject â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Observer â”‚ * â”‚ \u0026lt;\u0026lt;interface\u0026gt;\u0026gt; â”‚ â”‚ \u0026lt;\u0026lt;interface\u0026gt;\u0026gt; â”‚ * â”‚ â”‚ â”‚ â”‚ * â”‚+ attach(Observer)â”‚ â”‚+ update() â”‚ * â”‚+ detach(Observer)â”‚ â”‚ â”‚ * â”‚+ notifyObservers()â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â–³ * â–³ â”‚ * â”‚ â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ConcreteSubject â”‚ â”‚ConcreteObserver â”‚ * â”‚ â”‚ â”‚ â”‚ * â”‚- observers: Listâ”‚ â”‚- subject: Subjectâ”‚ * â”‚- state: String â”‚ â”‚ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */ public interface Subject { void attach(Observer observer); void detach(Observer observer); void notifyObservers(); } public interface Observer { void update(String message); } public class ConcreteSubject implements Subject { private List\u0026lt;Observer\u0026gt; observers = new ArrayList\u0026lt;\u0026gt;(); private String state; @Override public void attach(Observer observer) { observers.add(observer); } @Override public void detach(Observer observer) { observers.remove(observer); } @Override public void notifyObservers() { for (Observer observer : observers) { observer.update(state); } } public void setState(String state) { this.state = state; notifyObservers(); } } public class ConcreteObserver implements Observer { private String name; public ConcreteObserver(String name) { this.name = name; } @Override public void update(String message) { System.out.println(name + \u0026#34; æ”¶åˆ°æ›´æ–°: \u0026#34; + message); } } åºåˆ—åœ–ï¼ˆSequence Diagramï¼‰ åŸºæœ¬æ¦‚å¿µ åºåˆ—åœ–å±•ç¤ºç‰©ä»¶ä¹‹é–“çš„æ™‚é–“é †åºäº’å‹•ï¼ŒåŒ…å«ï¼š\nåƒèˆ‡è€…ï¼ˆActorï¼‰ï¼šå¤–éƒ¨ç”¨æˆ¶æˆ–ç³»çµ± ç‰©ä»¶ï¼ˆObjectï¼‰ï¼šç³»çµ±ä¸­çš„ç‰©ä»¶å¯¦ä¾‹ ç”Ÿå‘½ç·šï¼ˆLifelineï¼‰ï¼šå‚ç›´è™›ç·šï¼Œè¡¨ç¤ºç‰©ä»¶çš„ç”Ÿå‘½é€±æœŸ è¨Šæ¯ï¼ˆMessageï¼‰ï¼šç‰©ä»¶é–“çš„äº’å‹• åºåˆ—åœ–ç¯„ä¾‹ï¼šè¨‚å–®è™•ç†æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 /** * åºåˆ—åœ–è¡¨ç¤º: * * ç”¨æˆ¶ è¨‚å–®æœå‹™ åº«å­˜æœå‹™ ä»˜æ¬¾æœå‹™ éƒµä»¶æœå‹™ * â”‚ â”‚ â”‚ â”‚ â”‚ * â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ â”‚ â”‚ â”‚ 1. å‰µå»ºè¨‚å–® * â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ â”‚ â”‚ 2. æª¢æŸ¥åº«å­˜ * â”‚ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚ â”‚ 3. åº«å­˜ç¢ºèª * â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ â”‚ 4. è™•ç†ä»˜æ¬¾ * â”‚ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚ 5. ä»˜æ¬¾ç¢ºèª * â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ 6. ç™¼é€ç¢ºèªéƒµä»¶ * â”‚ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 7. éƒµä»¶ç™¼é€æˆåŠŸ * â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚ â”‚ â”‚ 8. è¿”å›è¨‚å–®ç¢ºèª * â”‚ â”‚ â”‚ â”‚ â”‚ */ // å°æ‡‰çš„ Java å¯¦ç¾ @Service public class OrderService { private final InventoryService inventoryService; private final PaymentService paymentService; private final EmailService emailService; public OrderService(InventoryService inventoryService, PaymentService paymentService, EmailService emailService) { this.inventoryService = inventoryService; this.paymentService = paymentService; this.emailService = emailService; } public OrderResult createOrder(OrderRequest request) { // 1. å‰µå»ºè¨‚å–® Order order = new Order(request); // 2-3. æª¢æŸ¥åº«å­˜ if (!inventoryService.checkStock(order.getItems())) { return OrderResult.failure(\u0026#34;åº«å­˜ä¸è¶³\u0026#34;); } // 4-5. è™•ç†ä»˜æ¬¾ PaymentResult paymentResult = paymentService.processPayment(order.getAmount()); if (!paymentResult.isSuccess()) { return OrderResult.failure(\u0026#34;ä»˜æ¬¾å¤±æ•—\u0026#34;); } // 6-7. ç™¼é€ç¢ºèªéƒµä»¶ emailService.sendOrderConfirmation(order); // 8. è¿”å›è¨‚å–®ç¢ºèª return OrderResult.success(order); } } ä½¿ç”¨æ¡ˆä¾‹åœ–ï¼ˆUse Case Diagramï¼‰ åŸºæœ¬æ¦‚å¿µ ä½¿ç”¨æ¡ˆä¾‹åœ–å±•ç¤ºç³»çµ±åŠŸèƒ½å’Œç”¨æˆ¶ä¹‹é–“çš„é—œä¿‚ï¼š\nåƒèˆ‡è€…ï¼ˆActorï¼‰ï¼šèˆ‡ç³»çµ±äº’å‹•çš„å¤–éƒ¨å¯¦é«” ä½¿ç”¨æ¡ˆä¾‹ï¼ˆUse Caseï¼‰ï¼šç³»çµ±æä¾›çš„åŠŸèƒ½ é—œä¿‚ï¼ˆRelationshipï¼‰ï¼šåƒèˆ‡è€…å’Œä½¿ç”¨æ¡ˆä¾‹ä¹‹é–“çš„é—œä¿‚ ä½¿ç”¨æ¡ˆä¾‹åœ–ç¯„ä¾‹ï¼šé›»å•†ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 /** * ä½¿ç”¨æ¡ˆä¾‹åœ–è¡¨ç¤º: * * é¡§å®¢ ç®¡ç†å“¡ * â”‚ â”‚ * â”‚ â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ ç€è¦½å•†å“ â”‚ â”‚ ç®¡ç†å•†å“ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ æ·»åŠ åˆ°è³¼ç‰©è»Š â”‚ â”‚ æŸ¥çœ‹è¨‚å–® â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ çµå¸³ä»˜æ¬¾ â”‚ â”‚ ç®¡ç†ç”¨æˆ¶ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ æŸ¥çœ‹è¨‚å–®ç‹€æ…‹ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */ // å°æ‡‰çš„ Java å¯¦ç¾ @RestController @RequestMapping(\u0026#34;/api\u0026#34;) public class ECommerceController { private final ProductService productService; private final CartService cartService; private final OrderService orderService; // é¡§å®¢åŠŸèƒ½ @GetMapping(\u0026#34;/products\u0026#34;) public List\u0026lt;Product\u0026gt; browseProducts() { return productService.getAllProducts(); } @PostMapping(\u0026#34;/cart/add\u0026#34;) public ResponseEntity\u0026lt;Void\u0026gt; addToCart(@RequestBody CartItem item) { cartService.addItem(item); return ResponseEntity.ok().build(); } @PostMapping(\u0026#34;/checkout\u0026#34;) public ResponseEntity\u0026lt;Order\u0026gt; checkout(@RequestBody CheckoutRequest request) { Order order = orderService.processOrder(request); return ResponseEntity.ok(order); } @GetMapping(\u0026#34;/orders/{id}\u0026#34;) public ResponseEntity\u0026lt;Order\u0026gt; getOrderStatus(@PathVariable Long id) { Order order = orderService.findById(id); return ResponseEntity.ok(order); } } @RestController @RequestMapping(\u0026#34;/api/admin\u0026#34;) public class AdminController { private final ProductService productService; private final OrderService orderService; private final UserService userService; // ç®¡ç†å“¡åŠŸèƒ½ @PostMapping(\u0026#34;/products\u0026#34;) public ResponseEntity\u0026lt;Product\u0026gt; createProduct(@RequestBody Product product) { Product created = productService.createProduct(product); return ResponseEntity.ok(created); } @GetMapping(\u0026#34;/orders\u0026#34;) public List\u0026lt;Order\u0026gt; getAllOrders() { return orderService.getAllOrders(); } @GetMapping(\u0026#34;/users\u0026#34;) public List\u0026lt;User\u0026gt; getAllUsers() { return userService.getAllUsers(); } } æ´»å‹•åœ–ï¼ˆActivity Diagramï¼‰ åŸºæœ¬æ¦‚å¿µ æ´»å‹•åœ–å±•ç¤ºå·¥ä½œæµç¨‹å’Œæ¥­å‹™é‚è¼¯ï¼š\né–‹å§‹ç¯€é»ï¼šæµç¨‹é–‹å§‹ çµæŸç¯€é»ï¼šæµç¨‹çµæŸ æ´»å‹•ï¼ˆActivityï¼‰ï¼šåŸ·è¡Œçš„å‹•ä½œ æ±ºç­–ç¯€é»ï¼šæ¢ä»¶åˆ¤æ–· åˆ†æ”¯å’Œåˆä½µï¼šä¸¦è¡Œè™•ç† æ´»å‹•åœ–ç¯„ä¾‹ï¼šç”¨æˆ¶è¨»å†Šæµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 /** * æ´»å‹•åœ–è¡¨ç¤º: * * â—ï¼ˆé–‹å§‹ï¼‰ * â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ è¼¸å…¥ç”¨æˆ¶ä¿¡æ¯ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ é©—è­‰è¼¸å…¥ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â—‡ï¼ˆæ±ºç­–ï¼‰ * â•± â•² * â•± â•² * â•±æœ‰æ•ˆï¼Ÿâ•² * â•² â•± * â•² â•± * â•² â•± * â”‚ * æ˜¯â”‚ å¦ * â”‚ â”‚ * â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ â”‚ é¡¯ç¤ºéŒ¯èª¤ â”‚ * â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ â”‚ * â”‚ â”‚ï¼ˆå›åˆ°è¼¸å…¥ï¼‰ * â”‚ â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ å‰µå»ºç”¨æˆ¶ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ ç™¼é€æ­¡è¿éƒµä»¶ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â—ï¼ˆçµæŸï¼‰ */ // å°æ‡‰çš„ Java å¯¦ç¾ @Service public class UserRegistrationService { private final UserRepository userRepository; private final EmailService emailService; private final UserValidator validator; public UserRegistrationService(UserRepository userRepository, EmailService emailService, UserValidator validator) { this.userRepository = userRepository; this.emailService = emailService; this.validator = validator; } public RegistrationResult registerUser(UserRegistrationRequest request) { // 1. è¼¸å…¥ç”¨æˆ¶ä¿¡æ¯ï¼ˆç”±å‰ç«¯æä¾›ï¼‰ // 2. é©—è­‰è¼¸å…¥ ValidationResult validationResult = validator.validate(request); // 3. æ±ºç­–ï¼šæ˜¯å¦æœ‰æ•ˆ if (!validationResult.isValid()) { // å¦ï¼šé¡¯ç¤ºéŒ¯èª¤ return RegistrationResult.failure(validationResult.getErrors()); } // æ˜¯ï¼šå‰µå»ºç”¨æˆ¶ User user = new User(request.getUsername(), request.getEmail()); User savedUser = userRepository.save(user); // ç™¼é€æ­¡è¿éƒµä»¶ emailService.sendWelcomeEmail(savedUser); return RegistrationResult.success(savedUser); } } ç‹€æ…‹åœ–ï¼ˆState Diagramï¼‰ åŸºæœ¬æ¦‚å¿µ ç‹€æ…‹åœ–å±•ç¤ºç‰©ä»¶åœ¨ä¸åŒç‹€æ…‹ä¹‹é–“çš„è½‰æ›ï¼š\nç‹€æ…‹ï¼ˆStateï¼‰ï¼šç‰©ä»¶çš„ç‰¹å®šæ¢ä»¶ è½‰æ›ï¼ˆTransitionï¼‰ï¼šå¾ä¸€å€‹ç‹€æ…‹åˆ°å¦ä¸€å€‹ç‹€æ…‹çš„è®ŠåŒ– äº‹ä»¶ï¼ˆEventï¼‰ï¼šè§¸ç™¼è½‰æ›çš„æ¢ä»¶ å‹•ä½œï¼ˆActionï¼‰ï¼šè½‰æ›æ™‚åŸ·è¡Œçš„æ“ä½œ ç‹€æ…‹åœ–ç¯„ä¾‹ï¼šè¨‚å–®ç‹€æ…‹ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 /** * ç‹€æ…‹åœ–è¡¨ç¤º: * * â—ï¼ˆåˆå§‹ï¼‰ * â”‚ * â”‚ å‰µå»ºè¨‚å–® * â–¼ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ PENDING â”‚ * â”‚ (å¾…è™•ç†) â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ â”‚ * â”‚ç¢ºèª â”‚å–æ¶ˆ * â–¼ â–¼ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ CONFIRMED â”‚ â”‚ CANCELLED â”‚ * â”‚ (å·²ç¢ºèª) â”‚ â”‚ (å·²å–æ¶ˆ) â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ â”‚ * â”‚ç™¼è²¨ â”‚ * â–¼ â–¼ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â—ï¼ˆçµæŸï¼‰ * â”‚ SHIPPED â”‚ * â”‚ (å·²ç™¼è²¨) â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â”‚å®Œæˆ * â–¼ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ DELIVERED â”‚ * â”‚ (å·²é€é”) â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â–¼ * â—ï¼ˆçµæŸï¼‰ */ // å°æ‡‰çš„ Java å¯¦ç¾ public enum OrderStatus { PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED } @Entity public class Order { @Id private String id; @Enumerated(EnumType.STRING) private OrderStatus status; private LocalDateTime createdAt; private LocalDateTime updatedAt; public Order() { this.status = OrderStatus.PENDING; this.createdAt = LocalDateTime.now(); this.updatedAt = LocalDateTime.now(); } // ç‹€æ…‹è½‰æ›æ–¹æ³• public void confirm() { if (status != OrderStatus.PENDING) { throw new IllegalStateException(\u0026#34;åªæœ‰å¾…è™•ç†çš„è¨‚å–®å¯ä»¥ç¢ºèª\u0026#34;); } this.status = OrderStatus.CONFIRMED; this.updatedAt = LocalDateTime.now(); } public void cancel() { if (status == OrderStatus.SHIPPED || status == OrderStatus.DELIVERED) { throw new IllegalStateException(\u0026#34;å·²ç™¼è²¨æˆ–å·²é€é”çš„è¨‚å–®ä¸èƒ½å–æ¶ˆ\u0026#34;); } this.status = OrderStatus.CANCELLED; this.updatedAt = LocalDateTime.now(); } public void ship() { if (status != OrderStatus.CONFIRMED) { throw new IllegalStateException(\u0026#34;åªæœ‰å·²ç¢ºèªçš„è¨‚å–®å¯ä»¥ç™¼è²¨\u0026#34;); } this.status = OrderStatus.SHIPPED; this.updatedAt = LocalDateTime.now(); } public void deliver() { if (status != OrderStatus.SHIPPED) { throw new IllegalStateException(\u0026#34;åªæœ‰å·²ç™¼è²¨çš„è¨‚å–®å¯ä»¥æ¨™è¨˜ç‚ºé€é”\u0026#34;); } this.status = OrderStatus.DELIVERED; this.updatedAt = LocalDateTime.now(); } // Getters and Setters public String getId() { return id; } public void setId(String id) { this.id = id; } public OrderStatus getStatus() { return status; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } } @Service public class OrderStateService { private final OrderRepository orderRepository; private final ApplicationEventPublisher eventPublisher; public OrderStateService(OrderRepository orderRepository, ApplicationEventPublisher eventPublisher) { this.orderRepository = orderRepository; this.eventPublisher = eventPublisher; } @Transactional public void confirmOrder(String orderId) { Order order = orderRepository.findById(orderId) .orElseThrow(() -\u0026gt; new OrderNotFoundException(\u0026#34;è¨‚å–®ä¸å­˜åœ¨: \u0026#34; + orderId)); order.confirm(); orderRepository.save(order); eventPublisher.publishEvent(new OrderConfirmedEvent(order)); } @Transactional public void cancelOrder(String orderId) { Order order = orderRepository.findById(orderId) .orElseThrow(() -\u0026gt; new OrderNotFoundException(\u0026#34;è¨‚å–®ä¸å­˜åœ¨: \u0026#34; + orderId)); order.cancel(); orderRepository.save(order); eventPublisher.publishEvent(new OrderCancelledEvent(order)); } @Transactional public void shipOrder(String orderId) { Order order = orderRepository.findById(orderId) .orElseThrow(() -\u0026gt; new OrderNotFoundException(\u0026#34;è¨‚å–®ä¸å­˜åœ¨: \u0026#34; + orderId)); order.ship(); orderRepository.save(order); eventPublisher.publishEvent(new OrderShippedEvent(order)); } @Transactional public void deliverOrder(String orderId) { Order order = orderRepository.findById(orderId) .orElseThrow(() -\u0026gt; new OrderNotFoundException(\u0026#34;è¨‚å–®ä¸å­˜åœ¨: \u0026#34; + orderId)); order.deliver(); orderRepository.save(order); eventPublisher.publishEvent(new OrderDeliveredEvent(order)); } } ä¼æ¥­ç´šæ‡‰ç”¨ï¼šå¾®æœå‹™æ¶æ§‹ UML è¨­è¨ˆ ç³»çµ±æ¶æ§‹åœ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 /** * å¾®æœå‹™æ¶æ§‹éƒ¨ç½²åœ–: * * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ ç”¨æˆ¶æœå‹™ â”‚ â”‚ è¨‚å–®æœå‹™ â”‚ â”‚ å•†å“æœå‹™ â”‚ * â”‚ User Service â”‚ â”‚Order Serviceâ”‚ â”‚Product Serviceâ”‚ * â”‚ :8081 â”‚ â”‚ :8082 â”‚ â”‚ :8083 â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ â”‚ â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ API Gateway â”‚ * â”‚ :8080 â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ * â”‚ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” * â”‚ å‰ç«¯æ‡‰ç”¨ â”‚ * â”‚ :3000 â”‚ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ */ // API Gateway é…ç½® @Configuration @EnableZuulProxy public class GatewayConfig { @Bean public RouteLocator customRouteLocator(RouteLocatorBuilder builder) { return builder.routes() .route(\u0026#34;user-service\u0026#34;, r -\u0026gt; r.path(\u0026#34;/api/users/**\u0026#34;) .uri(\u0026#34;lb://user-service\u0026#34;)) .route(\u0026#34;order-service\u0026#34;, r -\u0026gt; r.path(\u0026#34;/api/orders/**\u0026#34;) .uri(\u0026#34;lb://order-service\u0026#34;)) .route(\u0026#34;product-service\u0026#34;, r -\u0026gt; r.path(\u0026#34;/api/products/**\u0026#34;) .uri(\u0026#34;lb://product-service\u0026#34;)) .build(); } } // æœå‹™é–“é€šä¿¡æ¥å£ @FeignClient(name = \u0026#34;user-service\u0026#34;) public interface UserServiceClient { @GetMapping(\u0026#34;/api/users/{id}\u0026#34;) User getUserById(@PathVariable Long id); @PostMapping(\u0026#34;/api/users\u0026#34;) User createUser(@RequestBody CreateUserRequest request); } @FeignClient(name = \u0026#34;product-service\u0026#34;) public interface ProductServiceClient { @GetMapping(\u0026#34;/api/products/{id}\u0026#34;) Product getProductById(@PathVariable Long id); @PostMapping(\u0026#34;/api/products/reserve\u0026#34;) ReservationResult reserveProducts(@RequestBody List\u0026lt;ProductReservation\u0026gt; reservations); } // è¨‚å–®æœå‹™å¯¦ç¾ @Service public class OrderService { private final UserServiceClient userServiceClient; private final ProductServiceClient productServiceClient; private final OrderRepository orderRepository; public OrderService(UserServiceClient userServiceClient, ProductServiceClient productServiceClient, OrderRepository orderRepository) { this.userServiceClient = userServiceClient; this.productServiceClient = productServiceClient; this.orderRepository = orderRepository; } @Transactional public Order createOrder(CreateOrderRequest request) { // é©—è­‰ç”¨æˆ¶ User user = userServiceClient.getUserById(request.getUserId()); if (user == null) { throw new UserNotFoundException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨\u0026#34;); } // é ç•™å•†å“ List\u0026lt;ProductReservation\u0026gt; reservations = request.getItems().stream() .map(item -\u0026gt; new ProductReservation(item.getProductId(), item.getQuantity())) .collect(Collectors.toList()); ReservationResult result = productServiceClient.reserveProducts(reservations); if (!result.isSuccess()) { throw new ProductReservationException(\u0026#34;å•†å“é ç•™å¤±æ•—\u0026#34;); } // å‰µå»ºè¨‚å–® Order order = new Order(user.getId(), request.getItems()); return orderRepository.save(order); } } UML å»ºæ¨¡æœ€ä½³å¯¦è¸ 1. æ¨¡å‹ä¸€è‡´æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // ä¿æŒæ¨¡å‹èˆ‡ä»£ç¢¼çš„ä¸€è‡´æ€§ public class Customer { private String customerId; private String name; private String email; private List\u0026lt;Order\u0026gt; orders; // æ§‹é€ å‡½æ•¸ public Customer(String customerId, String name, String email) { this.customerId = customerId; this.name = name; this.email = email; this.orders = new ArrayList\u0026lt;\u0026gt;(); } // UML ä¸­å®šç¾©çš„æ–¹æ³• public void addOrder(Order order) { orders.add(order); order.setCustomer(this); } public List\u0026lt;Order\u0026gt; getOrders() { return Collections.unmodifiableList(orders); } } 2. é©ç•¶çš„æŠ½è±¡ç´šåˆ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // é«˜å±¤è¨­è¨ˆ - é¡¯ç¤ºä¸»è¦çµ„ä»¶ public interface PaymentService { PaymentResult processPayment(PaymentRequest request); } // è©³ç´°è¨­è¨ˆ - é¡¯ç¤ºå…·é«”å¯¦ç¾ @Service public class CreditCardPaymentService implements PaymentService { private final CreditCardValidator validator; private final PaymentGateway gateway; private final TransactionLogger logger; @Override public PaymentResult processPayment(PaymentRequest request) { // è©³ç´°å¯¦ç¾é‚è¼¯ if (!validator.validate(request)) { return PaymentResult.failure(\u0026#34;é©—è­‰å¤±æ•—\u0026#34;); } GatewayResponse response = gateway.charge(request); logger.log(request, response); return response.isSuccess() ? PaymentResult.success(response.getTransactionId()) : PaymentResult.failure(response.getErrorMessage()); } } 3. æ–‡æª”åŒ–æ¨™æº– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 /** * é¡åˆ¥æ–‡æª”æ¨¡æ¿ * * é¡åˆ¥åç¨±: OrderProcessor * è·è²¬: è™•ç†è¨‚å–®ç›¸é—œçš„æ¥­å‹™é‚è¼¯ * å”ä½œè€…: OrderRepository, PaymentService, InventoryService * * ç”Ÿå‘½é€±æœŸ: * - å‰µå»º: é€šé Spring å®¹å™¨è‡ªå‹•å‰µå»º * - éŠ·æ¯€: æ‡‰ç”¨ç¨‹å¼é—œé–‰æ™‚è‡ªå‹•éŠ·æ¯€ * * ç‹€æ…‹: ç„¡ç‹€æ…‹æœå‹™ * * ç•°å¸¸: * - OrderNotFoundException: è¨‚å–®ä¸å­˜åœ¨ * - PaymentException: ä»˜æ¬¾è™•ç†ç•°å¸¸ * - InventoryException: åº«å­˜ä¸è¶³ */ @Service public class OrderProcessor { private final OrderRepository orderRepository; private final PaymentService paymentService; private final InventoryService inventoryService; public OrderProcessor(OrderRepository orderRepository, PaymentService paymentService, InventoryService inventoryService) { this.orderRepository = orderRepository; this.paymentService = paymentService; this.inventoryService = inventoryService; } /** * è™•ç†è¨‚å–® * * å‰ç½®æ¢ä»¶: * - è¨‚å–®å¿…é ˆå­˜åœ¨ * - å•†å“åº«å­˜å……è¶³ * - ä»˜æ¬¾ä¿¡æ¯æœ‰æ•ˆ * * å¾Œç½®æ¢ä»¶: * - è¨‚å–®ç‹€æ…‹æ›´æ–° * - åº«å­˜æ•¸é‡æ¸›å°‘ * - ä»˜æ¬¾è¨˜éŒ„å‰µå»º * * @param orderId è¨‚å–®ID * @return è™•ç†çµæœ * @throws OrderNotFoundException è¨‚å–®ä¸å­˜åœ¨ * @throws PaymentException ä»˜æ¬¾å¤±æ•— * @throws InventoryException åº«å­˜ä¸è¶³ */ @Transactional public OrderResult processOrder(String orderId) { // å¯¦ç¾é‚è¼¯ Order order = orderRepository.findById(orderId) .orElseThrow(() -\u0026gt; new OrderNotFoundException(\u0026#34;è¨‚å–®ä¸å­˜åœ¨: \u0026#34; + orderId)); // æª¢æŸ¥åº«å­˜ if (!inventoryService.checkStock(order.getItems())) { throw new InventoryException(\u0026#34;åº«å­˜ä¸è¶³\u0026#34;); } // è™•ç†ä»˜æ¬¾ PaymentResult paymentResult = paymentService.processPayment(order.getPaymentInfo()); if (!paymentResult.isSuccess()) { throw new PaymentException(\u0026#34;ä»˜æ¬¾å¤±æ•—: \u0026#34; + paymentResult.getErrorMessage()); } // æ›´æ–°è¨‚å–®ç‹€æ…‹ order.setStatus(OrderStatus.CONFIRMED); orderRepository.save(order); return OrderResult.success(order); } } ç¸½çµ UML çµ±ä¸€å»ºæ¨¡èªè¨€æ˜¯è»Ÿé«”é–‹ç™¼ä¸­çš„é‡è¦å·¥å…·ï¼š\né—œéµå„ªå‹¢ è¦–è¦ºåŒ–æºé€šï¼šæä¾›æ¸…æ™°çš„è¦–è¦ºè¡¨ç¤ºï¼Œä¿ƒé€²åœ˜éšŠæºé€š è¨­è¨ˆé©—è­‰ï¼šåœ¨ç·¨ç¢¼å‰é©—è­‰è¨­è¨ˆçš„æ­£ç¢ºæ€§ æ–‡æª”åŒ–ï¼šç‚ºç³»çµ±æä¾›å®Œæ•´çš„æ–‡æª” æ¨™æº–åŒ–ï¼šçµ±ä¸€çš„ç¬¦è™Ÿå’Œèªç¾©ï¼Œä¾¿æ–¼ç†è§£ æœ€ä½³å¯¦è¸ é©ç•¶çš„ç´°ç¯€å±¤æ¬¡ï¼šæ ¹æ“šç›®æ¨™å—çœ¾é¸æ“‡åˆé©çš„æŠ½è±¡ç´šåˆ¥ æ¨¡å‹ä¸€è‡´æ€§ï¼šç¢ºä¿ UML æ¨¡å‹èˆ‡å¯¦éš›ä»£ç¢¼ä¿æŒä¸€è‡´ è¿­ä»£æ”¹é€²ï¼šéš¨è‘—ç³»çµ±æ¼”é€²ä¸æ–·æ›´æ–° UML æ¨¡å‹ å·¥å…·æ”¯æ´ï¼šä½¿ç”¨å°ˆæ¥­çš„ UML å»ºæ¨¡å·¥å…·æé«˜æ•ˆç‡ ç¾ä»£æ‡‰ç”¨ åœ¨ç¾ä»£è»Ÿé«”é–‹ç™¼ä¸­ï¼ŒUML ç‰¹åˆ¥é©ç”¨æ–¼ï¼š\nå¾®æœå‹™æ¶æ§‹è¨­è¨ˆ é ˜åŸŸé©…å‹•è¨­è¨ˆï¼ˆDDDï¼‰ ä¼æ¥­ç´šæ‡‰ç”¨æ¶æ§‹ ç³»çµ±æ•´åˆè¨­è¨ˆ é€šéæ­£ç¢ºä½¿ç”¨ UMLï¼Œå¯ä»¥å¤§å¹…æå‡è»Ÿé«”è¨­è¨ˆçš„å“è³ªå’Œåœ˜éšŠå”ä½œæ•ˆç‡ã€‚\nåƒè€ƒè³‡æ–™ UML 2.5 å®˜æ–¹è¦ç¯„ Martin Fowler - UML Distilled Object-Oriented Analysis and Design with Applications Spring Boot å®˜æ–¹æ–‡æª” ","permalink":"https://xinqilin.github.io/post/architecture/uml/","tags":["UML","Unified Modeling Language","Software Design","Architecture","Class Diagram","Sequence Diagram","Use Case Diagram","Design Patterns","Object-Oriented Design","Software Modeling","Enterprise Architecture","System Design"],"title":"UML çµ±ä¸€å»ºæ¨¡èªè¨€å®Œæ•´æŒ‡å—ï¼šè»Ÿé«”è¨­è¨ˆèˆ‡æ¶æ§‹å»ºæ¨¡æœ€ä½³å¯¦è¸"},{"content":"æ¦‚è¿° Spring Framework çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€æ˜¯ä¾è³´æ³¨å…¥ï¼ˆDependency Injection, DIï¼‰ï¼Œå®ƒå¯¦ç¾äº†æ§åˆ¶åè½‰ï¼ˆInversion of Control, IoCï¼‰çš„è¨­è¨ˆæ¨¡å¼ã€‚æ­£ç¢ºä½¿ç”¨ä¾è³´æ³¨å…¥ä¸åƒ…èƒ½æå‡ç¨‹å¼ç¢¼çš„å¯æ¸¬è©¦æ€§å’Œå¯ç¶­è­·æ€§ï¼Œé‚„èƒ½é™ä½çµ„ä»¶é–“çš„è€¦åˆåº¦ã€‚æœ¬æ–‡å°‡æ·±å…¥æ¢è¨ Spring ä¸­å„ç¨®ä¾è³´æ³¨å…¥æ–¹å¼ï¼Œä¸¦é‡é»èªªæ˜æœ€ä½³å¯¦è¸ã€‚\nç‚ºä»€éº¼ä¸å»ºè­°ä½¿ç”¨ @Autowired Field Injectionï¼Ÿ ç•¶ä½ åœ¨ IntelliJ IDEA ä¸­ä½¿ç”¨ @Autowired é€²è¡Œæ¬„ä½æ³¨å…¥æ™‚ï¼Œæœƒçœ‹åˆ°é€™æ¨£çš„è­¦å‘Šï¼š\n1 2 3 4 Field injection is not recommended Inspection info: Spring Team recommends: \u0026#34;Always use constructor based dependency injection in your beans. Always use assertions for mandatory dependencies\u0026#34;. é€™å€‹è­¦å‘ŠèƒŒå¾Œæœ‰æ·±åˆ»çš„æŠ€è¡“ç†ç”±ï¼Œè®“æˆ‘å€‘é€ä¸€åˆ†æã€‚\nSpring ä¾è³´æ³¨å…¥çš„ä¸‰ç¨®æ–¹å¼ 1. Field Injectionï¼ˆä¸å»ºè­°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Service public class OrderService { @Autowired private PaymentService paymentService; // âŒ ä¸å»ºè­° @Autowired private InventoryService inventoryService; // âŒ ä¸å»ºè­° @Autowired private EmailService emailService; // âŒ ä¸å»ºè­° public void processOrder(Order order) { paymentService.processPayment(order); inventoryService.updateStock(order); emailService.sendConfirmation(order); } } Field Injection çš„å•é¡Œï¼š\nå•é¡Œ 1ï¼šé•åå–®ä¸€è·è²¬åŸå‰‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Service public class UserService { @Autowired private UserRepository userRepository; @Autowired private EmailService emailService; @Autowired private SmsService smsService; @Autowired private AuditService auditService; @Autowired private CacheService cacheService; @Autowired private ValidationService validationService; @Autowired private SecurityService securityService; @Autowired private LoggingService loggingService; @Autowired private MetricsService metricsService; @Autowired private ConfigurationService configurationService; // ... é‚„æœ‰æ›´å¤šä¾è³´ // ç•¶ä½ çœ‹åˆ°é€™éº¼å¤šä¾è³´æ™‚ï¼Œæ‡‰è©²é‡æ–°æ€è€ƒé€™å€‹é¡åˆ¥çš„è·è²¬ } å•é¡Œ 2ï¼šç„¡æ³•é€²è¡Œå–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 public class OrderServiceTest { @Test public void testProcessOrder() { // âŒ ç„¡æ³•è¼•æ˜“å‰µå»º OrderService å¯¦ä¾‹é€²è¡Œæ¸¬è©¦ OrderService orderService = new OrderService(); // PaymentService ç‚º null! Order order = new Order(); orderService.processOrder(order); // NullPointerException! } } å•é¡Œ 3ï¼šéš±è—çš„ä¾è³´é—œä¿‚ 1 2 3 4 // å¾é€™å€‹å»ºæ§‹å­çœ‹ä¸å‡ºé€™å€‹é¡åˆ¥éœ€è¦ä»€éº¼ä¾è³´ public class OrderService { // ä¾è³´éš±è—åœ¨é¡åˆ¥å…§éƒ¨ï¼Œå¤–éƒ¨ç„¡æ³•å¾—çŸ¥ } å•é¡Œ 4ï¼šå¾ªç’°ä¾è³´ä¸æ˜“ç™¼ç¾ 1 2 3 4 5 6 7 8 9 10 11 @Service public class ServiceA { @Autowired private ServiceB serviceB; // å¾ªç’°ä¾è³´åœ¨é‹è¡Œæ™‚æ‰æœƒç™¼ç¾ } @Service public class ServiceB { @Autowired private ServiceA serviceA; // å¾ªç’°ä¾è³´åœ¨é‹è¡Œæ™‚æ‰æœƒç™¼ç¾ } 2. Setter Injectionï¼ˆæ¢ä»¶æ€§å»ºè­°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Service public class OrderService { private PaymentService paymentService; private EmailService emailService; @Autowired public void setPaymentService(PaymentService paymentService) { this.paymentService = paymentService; } @Autowired public void setEmailService(EmailService emailService) { this.emailService = emailService; } public void processOrder(Order order) { if (paymentService != null) { paymentService.processPayment(order); } if (emailService != null) { emailService.sendConfirmation(order); } } } Setter Injection é©ç”¨å ´æ™¯ï¼š\nå¯é¸ä¾è³´ï¼ˆOptional Dependenciesï¼‰ å¾ªç’°ä¾è³´çš„æš«æ™‚è§£æ±ºæ–¹æ¡ˆ éœ€è¦åœ¨é‹è¡Œæ™‚é‡æ–°é…ç½®ä¾è³´ 3. Constructor Injectionï¼ˆå¼·çƒˆå»ºè­°ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 @Service public class OrderService { private final PaymentService paymentService; private final InventoryService inventoryService; private final EmailService emailService; // âœ… æ¨è–¦ï¼šConstructor Injection public OrderService(PaymentService paymentService, InventoryService inventoryService, EmailService emailService) { this.paymentService = Objects.requireNonNull(paymentService, \u0026#34;PaymentService cannot be null\u0026#34;); this.inventoryService = Objects.requireNonNull(inventoryService, \u0026#34;InventoryService cannot be null\u0026#34;); this.emailService = Objects.requireNonNull(emailService, \u0026#34;EmailService cannot be null\u0026#34;); } public void processOrder(Order order) { paymentService.processPayment(order); inventoryService.updateStock(order); emailService.sendConfirmation(order); } } Constructor Injection çš„å„ªå‹¢ 1. ä¸å¯è®Šæ€§ï¼ˆImmutabilityï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Service public class OrderService { // âœ… final é—œéµå­—ç¢ºä¿ä¾è³´ä¸æœƒè¢«ä¿®æ”¹ private final PaymentService paymentService; private final InventoryService inventoryService; public OrderService(PaymentService paymentService, InventoryService inventoryService) { this.paymentService = paymentService; this.inventoryService = inventoryService; } // ç„¡æ³•æ„å¤–ä¿®æ”¹ä¾è³´é—œä¿‚ } 2. å¼·åˆ¶ä¾è³´æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Service public class OrderService { private final PaymentService paymentService; public OrderService(PaymentService paymentService) { // âœ… åœ¨ç‰©ä»¶å‰µå»ºæ™‚å°±ç¢ºä¿ä¾è³´å­˜åœ¨ this.paymentService = Objects.requireNonNull(paymentService, \u0026#34;PaymentService is required for OrderService\u0026#34;); } public void processOrder(Order order) { // âœ… ä¿è­‰ paymentService ä¸ç‚º null paymentService.processPayment(order); } } 3. æ˜“æ–¼å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @ExtendWith(MockitoExtension.class) class OrderServiceTest { @Mock private PaymentService paymentService; @Mock private InventoryService inventoryService; @Mock private EmailService emailService; private OrderService orderService; @BeforeEach void setUp() { // âœ… æ˜“æ–¼å‰µå»ºæ¸¬è©¦å¯¦ä¾‹ orderService = new OrderService(paymentService, inventoryService, emailService); } @Test void testProcessOrder() { // Given Order order = new Order(); when(paymentService.processPayment(order)).thenReturn(true); // When orderService.processOrder(order); // Then verify(paymentService).processPayment(order); verify(inventoryService).updateStock(order); verify(emailService).sendConfirmation(order); } } 4. æ˜ç¢ºçš„ä¾è³´é—œä¿‚ 1 2 3 4 5 6 7 8 9 10 11 // âœ… å¾å»ºæ§‹å­å°±èƒ½æ¸…æ¥šçœ‹åˆ°æ‰€æœ‰ä¾è³´ public class OrderService { public OrderService(PaymentService paymentService, InventoryService inventoryService, EmailService emailService, AuditService auditService) { // å¦‚æœå»ºæ§‹å­åƒæ•¸å¤ªå¤šï¼Œèªªæ˜é€™å€‹é¡åˆ¥æ‰¿æ“”äº†å¤ªå¤šè·è²¬ // é€™æ˜¯ä¸€å€‹ç¨‹å¼ç¢¼ç•°å‘³ï¼ˆCode Smellï¼‰ï¼Œæé†’æˆ‘å€‘é‡æ§‹ } } ä½¿ç”¨ Lombok ç°¡åŒ– Constructor Injection åŸºæœ¬ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Service @RequiredArgsConstructor // âœ… Lombok è‡ªå‹•ç”Ÿæˆå»ºæ§‹å­ public class OrderService { private final PaymentService paymentService; private final InventoryService inventoryService; private final EmailService emailService; // Lombok è‡ªå‹•ç”Ÿæˆï¼š // public OrderService(PaymentService paymentService, // InventoryService inventoryService, // EmailService emailService) { // this.paymentService = paymentService; // this.inventoryService = inventoryService; // this.emailService = emailService; // } public void processOrder(Order order) { paymentService.processPayment(order); inventoryService.updateStock(order); emailService.sendConfirmation(order); } } æ··åˆå¿…è¦å’Œå¯é¸ä¾è³´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 @Service @RequiredArgsConstructor public class NotificationService { // å¿…è¦ä¾è³´ï¼ˆfinalï¼‰ private final EmailService emailService; private final SmsService smsService; // å¯é¸ä¾è³´ï¼ˆnon-finalï¼‰ private PushNotificationService pushService; private SlackService slackService; @Autowired(required = false) public void setPushNotificationService(PushNotificationService pushService) { this.pushService = pushService; } @Autowired(required = false) public void setSlackService(SlackService slackService) { this.slackService = slackService; } public void sendNotification(String message, User user) { // å¿…è¦æœå‹™ emailService.send(message, user.getEmail()); smsService.send(message, user.getPhone()); // å¯é¸æœå‹™ if (pushService != null) { pushService.send(message, user.getDeviceToken()); } if (slackService != null) { slackService.send(message, user.getSlackChannel()); } } } é€²éšä¾è³´æ³¨å…¥æŠ€å·§ 1. æ¢ä»¶æ€§ä¾è³´æ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Configuration public class ServiceConfiguration { @Bean @ConditionalOnProperty(name = \u0026#34;payment.provider\u0026#34;, havingValue = \u0026#34;stripe\u0026#34;) public PaymentService stripePaymentService() { return new StripePaymentService(); } @Bean @ConditionalOnProperty(name = \u0026#34;payment.provider\u0026#34;, havingValue = \u0026#34;paypal\u0026#34;) public PaymentService paypalPaymentService() { return new PaypalPaymentService(); } @Bean @ConditionalOnMissingBean(PaymentService.class) public PaymentService defaultPaymentService() { return new DefaultPaymentService(); } } 2. é›†åˆæ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Service @RequiredArgsConstructor public class NotificationService { // âœ… æ³¨å…¥æ‰€æœ‰ NotificationProvider å¯¦ä½œ private final List\u0026lt;NotificationProvider\u0026gt; providers; public void sendNotification(String message, User user) { providers.forEach(provider -\u0026gt; { try { provider.send(message, user); } catch (Exception e) { log.warn(\u0026#34;Failed to send notification via {}: {}\u0026#34;, provider.getClass().getSimpleName(), e.getMessage()); } }); } } // ä¸åŒçš„é€šçŸ¥æä¾›è€… @Component public class EmailNotificationProvider implements NotificationProvider { public void send(String message, User user) { // ç™¼é€éƒµä»¶ } } @Component public class SmsNotificationProvider implements NotificationProvider { public void send(String message, User user) { // ç™¼é€ç°¡è¨Š } } 3. é™å®šç¬¦æ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // ä½¿ç”¨ @Qualifier å€åˆ†ç›¸åŒé¡å‹çš„ Bean @Service @RequiredArgsConstructor public class OrderService { @Qualifier(\u0026#34;primary\u0026#34;) private final PaymentService primaryPaymentService; @Qualifier(\u0026#34;backup\u0026#34;) private final PaymentService backupPaymentService; public void processPayment(Order order) { try { primaryPaymentService.processPayment(order); } catch (PaymentException e) { log.warn(\u0026#34;Primary payment failed, trying backup: {}\u0026#34;, e.getMessage()); backupPaymentService.processPayment(order); } } } @Configuration public class PaymentConfiguration { @Bean @Qualifier(\u0026#34;primary\u0026#34;) public PaymentService primaryPaymentService() { return new StripePaymentService(); } @Bean @Qualifier(\u0026#34;backup\u0026#34;) public PaymentService backupPaymentService() { return new PaypalPaymentService(); } } 4. Profile ç›¸é—œæ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Configuration public class DatabaseConfiguration { @Bean @Profile(\u0026#34;dev\u0026#34;) public DataSource devDataSource() { return new H2DataSource(); } @Bean @Profile(\u0026#34;prod\u0026#34;) public DataSource prodDataSource() { return new MySQLDataSource(); } @Bean @Profile(\u0026#34;test\u0026#34;) public DataSource testDataSource() { return new TestContainerDataSource(); } } å¸¸è¦‹é™·é˜±èˆ‡è§£æ±ºæ–¹æ¡ˆ 1. å¾ªç’°ä¾è³´å•é¡Œ å•é¡Œç¤ºä¾‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @Service public class OrderService { private final CustomerService customerService; public OrderService(CustomerService customerService) { this.customerService = customerService; } } @Service public class CustomerService { private final OrderService orderService; // âŒ å¾ªç’°ä¾è³´ public CustomerService(OrderService orderService) { this.orderService = orderService; } } è§£æ±ºæ–¹æ¡ˆ 1ï¼šé‡æ–°è¨­è¨ˆæ¶æ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // âœ… å¼•å…¥å…±äº«æœå‹™ï¼Œé¿å…å¾ªç’°ä¾è³´ @Service @RequiredArgsConstructor public class OrderService { private final CustomerRepository customerRepository; private final OrderRepository orderRepository; private final OrderValidationService validationService; } @Service @RequiredArgsConstructor public class CustomerService { private final CustomerRepository customerRepository; private final OrderRepository orderRepository; } @Service @RequiredArgsConstructor public class OrderValidationService { private final CustomerRepository customerRepository; private final PaymentService paymentService; } è§£æ±ºæ–¹æ¡ˆ 2ï¼šä½¿ç”¨äº‹ä»¶é©…å‹•æ¶æ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Service @RequiredArgsConstructor public class OrderService { private final ApplicationEventPublisher eventPublisher; private final OrderRepository orderRepository; public void createOrder(Order order) { order = orderRepository.save(order); // âœ… ç™¼å¸ƒäº‹ä»¶è€Œéç›´æ¥èª¿ç”¨ eventPublisher.publishEvent(new OrderCreatedEvent(order)); } } @Service @RequiredArgsConstructor @EventListener public class CustomerService { private final CustomerRepository customerRepository; @EventListener public void handleOrderCreated(OrderCreatedEvent event) { // è™•ç†è¨‚å–®å‰µå»ºäº‹ä»¶ updateCustomerOrderCount(event.getOrder().getCustomerId()); } } 2. å»ºæ§‹å­åƒæ•¸éå¤š å•é¡Œè­˜åˆ¥ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @Service public class UserService { // âŒ å»ºæ§‹å­åƒæ•¸éå¤šï¼Œé•å SRP åŸå‰‡ public UserService(UserRepository userRepository, EmailService emailService, SmsService smsService, AuditService auditService, CacheService cacheService, ValidationService validationService, SecurityService securityService, NotificationService notificationService, PaymentService paymentService, ReportService reportService) { // å¤ªå¤šä¾è³´ï¼ } } è§£æ±ºæ–¹æ¡ˆï¼šæ‹†åˆ†æœå‹™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // âœ… æ‹†åˆ†ç‚ºå¤šå€‹å°ˆé–€çš„æœå‹™ @Service @RequiredArgsConstructor public class UserService { private final UserRepository userRepository; private final UserValidationService validationService; private final UserSecurityService securityService; } @Service @RequiredArgsConstructor public class UserNotificationService { private final EmailService emailService; private final SmsService smsService; private final NotificationService notificationService; } @Service @RequiredArgsConstructor public class UserBillingService { private final PaymentService paymentService; private final BillingRepository billingRepository; } 3. å¯é¸ä¾è³´è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Service @RequiredArgsConstructor public class UserService { private final UserRepository userRepository; private final EmailService emailService; // âœ… å¯é¸ä¾è³´ä½¿ç”¨ Optional private final Optional\u0026lt;SmsService\u0026gt; smsService; public void createUser(User user) { user = userRepository.save(user); // å¿…è¦æœå‹™ emailService.sendWelcomeEmail(user); // å¯é¸æœå‹™ smsService.ifPresent(service -\u0026gt; service.sendWelcomeSms(user.getPhone()) ); } } @Configuration public class ServiceConfiguration { @Bean @ConditionalOnProperty(name = \u0026#34;sms.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public SmsService smsService() { return new TwilioSmsService(); } } æ•ˆèƒ½è€ƒé‡ 1. å»¶é²åˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 @Service @Lazy // âœ… å»¶é²åˆå§‹åŒ–ï¼Œæ¸›å°‘å•Ÿå‹•æ™‚é–“ @RequiredArgsConstructor public class ReportService { private final DataAnalysisService dataAnalysisService; private final ChartGenerationService chartService; public Report generateReport(String type) { // åªæœ‰åœ¨å¯¦éš›ä½¿ç”¨æ™‚æ‰æœƒåˆå§‹åŒ– return dataAnalysisService.analyze(type); } } 2. åŸå‹ Bean çš„æ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @Service @RequiredArgsConstructor public class OrderProcessorService { private final ApplicationContext applicationContext; public void processOrder(Order order) { // âœ… æ¯æ¬¡éƒ½å‰µå»ºæ–°çš„è™•ç†å™¨å¯¦ä¾‹ OrderProcessor processor = applicationContext.getBean(OrderProcessor.class); processor.process(order); } } @Component @Scope(\u0026#34;prototype\u0026#34;) // åŸå‹ç¯„åœ public class OrderProcessor { public void process(Order order) { // è™•ç†é‚è¼¯ } } 3. Provider æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @Service @RequiredArgsConstructor public class OrderService { // âœ… ä½¿ç”¨ Provider å»¶é²ç²å– Bean private final Provider\u0026lt;ExpensiveService\u0026gt; expensiveServiceProvider; public void processSpecialOrder(Order order) { if (order.isSpecial()) { // åªæœ‰åœ¨éœ€è¦æ™‚æ‰ç²å–æ˜‚è²´çš„æœå‹™ ExpensiveService service = expensiveServiceProvider.get(); service.processSpecialOrder(order); } } } æ¸¬è©¦æœ€ä½³å¯¦è¸ 1. ä½¿ç”¨ Constructor Injection çš„æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 @ExtendWith(MockitoExtension.class) class OrderServiceTest { @Mock private PaymentService paymentService; @Mock private InventoryService inventoryService; @Mock private EmailService emailService; private OrderService orderService; @BeforeEach void setUp() { // âœ… æ¸…æ™°çš„æ¸¬è©¦è¨­ç½® orderService = new OrderService(paymentService, inventoryService, emailService); } @Test void shouldProcessOrderSuccessfully() { // Given Order order = TestDataBuilder.createOrder(); when(paymentService.processPayment(order)).thenReturn(PaymentResult.success()); // When OrderResult result = orderService.processOrder(order); // Then assertThat(result.isSuccessful()).isTrue(); verify(paymentService).processPayment(order); verify(inventoryService).updateStock(order); verify(emailService).sendConfirmation(order); } @Test void shouldHandlePaymentFailure() { // Given Order order = TestDataBuilder.createOrder(); when(paymentService.processPayment(order)) .thenThrow(new PaymentException(\u0026#34;Payment failed\u0026#34;)); // When \u0026amp; Then assertThatThrownBy(() -\u0026gt; orderService.processOrder(order)) .isInstanceOf(OrderProcessingException.class) .hasMessageContaining(\u0026#34;Payment failed\u0026#34;); verify(inventoryService, never()).updateStock(order); verify(emailService, never()).sendConfirmation(order); } } 2. Integration Testing 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @SpringBootTest @TestPropertySource(properties = { \u0026#34;spring.datasource.url=jdbc:h2:mem:testdb\u0026#34;, \u0026#34;payment.provider=mock\u0026#34; }) class OrderServiceIntegrationTest { @Autowired private OrderService orderService; @MockBean // âœ… Spring Boot çš„ Mock æ”¯æ´ private EmailService emailService; @Test void shouldProcessOrderEndToEnd() { // Given Order order = TestDataBuilder.createOrder(); // When OrderResult result = orderService.processOrder(order); // Then assertThat(result.isSuccessful()).isTrue(); verify(emailService).sendConfirmation(order); } } Spring Boot ä¸­çš„ä¾è³´æ³¨å…¥ 1. è‡ªå‹•é…ç½®èˆ‡ä¾è³´æ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 @SpringBootApplication public class ECommerceApplication { public static void main(String[] args) { SpringApplication.run(ECommerceApplication.class, args); } } // âœ… Spring Boot è‡ªå‹•é…ç½® + Constructor Injection @RestController @RequiredArgsConstructor @RequestMapping(\u0026#34;/api/orders\u0026#34;) public class OrderController { private final OrderService orderService; private final OrderMapper orderMapper; @PostMapping public ResponseEntity\u0026lt;OrderDto\u0026gt; createOrder(@RequestBody CreateOrderRequest request) { Order order = orderMapper.toEntity(request); Order savedOrder = orderService.createOrder(order); OrderDto dto = orderMapper.toDto(savedOrder); return ResponseEntity.ok(dto); } } 2. Configuration Properties 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 @ConfigurationProperties(prefix = \u0026#34;app.order\u0026#34;) @ConstructorBinding // âœ… ä¸å¯è®Šé…ç½®é¡ @RequiredArgsConstructor @Getter public class OrderProperties { private final Duration timeout; private final int maxRetries; private final boolean enableNotifications; private final PaymentConfig payment; @RequiredArgsConstructor @Getter public static class PaymentConfig { private final String provider; private final Duration timeout; private final boolean enableRetry; } } // ä½¿ç”¨é…ç½® @Service @RequiredArgsConstructor public class OrderService { private final OrderProperties properties; private final PaymentService paymentService; public void processOrder(Order order) { try { paymentService.processPayment(order, properties.getPayment().getTimeout()); } catch (PaymentException e) { if (properties.getPayment().isEnableRetry()) { retryPayment(order); } } } } ç›£æ§èˆ‡åµéŒ¯ 1. Bean ä¾è³´é—œä¿‚æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component @RequiredArgsConstructor public class DependencyHealthIndicator implements HealthIndicator { private final List\u0026lt;HealthCheckable\u0026gt; healthCheckableServices; @Override public Health health() { Health.Builder builder = Health.up(); for (HealthCheckable service : healthCheckableServices) { try { service.checkHealth(); builder.withDetail(service.getClass().getSimpleName(), \u0026#34;UP\u0026#34;); } catch (Exception e) { builder.withDetail(service.getClass().getSimpleName(), \u0026#34;DOWN: \u0026#34; + e.getMessage()); builder.down(); } } return builder.build(); } } 2. ä¾è³´æ³¨å…¥é™¤éŒ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @EventListener @Component @Slf4j public class ApplicationStartupListener { @EventListener public void handleContextRefresh(ContextRefreshedEvent event) { ApplicationContext context = event.getApplicationContext(); log.info(\u0026#34;=== Spring Context Loaded ===\u0026#34;); log.info(\u0026#34;Total beans: {}\u0026#34;, context.getBeanDefinitionCount()); // åˆ—å‡ºæ‰€æœ‰ Bean String[] beanNames = context.getBeanDefinitionNames(); for (String beanName : beanNames) { Object bean = context.getBean(beanName); log.debug(\u0026#34;Bean: {} -\u0026gt; {}\u0026#34;, beanName, bean.getClass().getName()); } } } ç¸½çµ ä¾è³´æ³¨å…¥æ–¹å¼æ¯”è¼ƒ æ³¨å…¥æ–¹å¼ æ¨è–¦åº¦ å„ªé» ç¼ºé» é©ç”¨å ´æ™¯ Constructor â­â­â­â­â­ ä¸å¯è®Šã€å¼·åˆ¶æª¢æŸ¥ã€æ˜“æ¸¬è©¦ å»ºæ§‹å­å¯èƒ½è®Šé•· é è¨­é¸æ“‡ Setter â­â­â­ éˆæ´»ã€æ”¯æ´å¯é¸ä¾è³´ å¯è®Šã€æ™šæœŸæª¢æŸ¥ å¯é¸ä¾è³´ã€å¾ªç’°ä¾è³´ Field â­ ç°¡æ½” é›£æ¸¬è©¦ã€éš±è—ä¾è³´ã€å¯è®Š é¿å…ä½¿ç”¨ æœ€ä½³å¯¦è¸ç¸½çµ å„ªå…ˆä½¿ç”¨ Constructor Injectionï¼šç¢ºä¿ä¾è³´çš„ä¸å¯è®Šæ€§å’Œå¼·åˆ¶æª¢æŸ¥ ä½¿ç”¨ Lombok @RequiredArgsConstructorï¼šæ¸›å°‘æ¨¡æ¿ç¨‹å¼ç¢¼ é™åˆ¶å»ºæ§‹å­åƒæ•¸æ•¸é‡ï¼šè¶…é 5 å€‹åƒæ•¸è€ƒæ…®é‡æ§‹ ä½¿ç”¨ final é—œéµå­—ï¼šç¢ºä¿ä¾è³´ä¸æœƒè¢«æ„å¤–ä¿®æ”¹ é©ç•¶ä½¿ç”¨ @Qualifierï¼šå€åˆ†ç›¸åŒé¡å‹çš„ Bean è€ƒæ…®å¯é¸ä¾è³´ï¼šä½¿ç”¨ Optional æˆ– Setter Injection é¿å…å¾ªç’°ä¾è³´ï¼šé‡æ–°è¨­è¨ˆæ¶æ§‹æˆ–ä½¿ç”¨äº‹ä»¶é©…å‹• ç·¨å¯«å®Œæ•´çš„æ¸¬è©¦ï¼šåˆ©ç”¨ Constructor Injection çš„å¯æ¸¬è©¦æ€§ é·ç§»ç­–ç•¥ å¦‚æœä½ çš„å°ˆæ¡ˆç›®å‰å¤§é‡ä½¿ç”¨ Field Injectionï¼Œå¯ä»¥æ¡ç”¨æ¼¸é€²å¼é·ç§»ï¼š\næ–°ç¨‹å¼ç¢¼ï¼šç«‹å³æ¡ç”¨ Constructor Injection ç¾æœ‰ç¨‹å¼ç¢¼ï¼šåœ¨ä¿®æ”¹æ™‚é€æ­¥é‡æ§‹ é—œéµæœå‹™ï¼šå„ªå…ˆé‡æ§‹æ ¸å¿ƒæ¥­å‹™é‚è¼¯ å·¥å…·æ”¯æ´ï¼šä½¿ç”¨ IDE çš„è‡ªå‹•é‡æ§‹åŠŸèƒ½ æ­£ç¢ºçš„ä¾è³´æ³¨å…¥ä¸åƒ…æ˜¯æŠ€è¡“æœ€ä½³å¯¦è¸ï¼Œæ›´æ˜¯å»ºç«‹å¯ç¶­è­·ã€å¯æ¸¬è©¦ã€é«˜å“è³ªè»Ÿé«”çš„åŸºç¤ã€‚\nåƒè€ƒè³‡æ–™ Spring Framework Reference Documentation Spring Boot Reference Guide Effective Java by Joshua Bloch Clean Code by Robert Martin Spring in Action by Craig Walls ","permalink":"https://xinqilin.github.io/post/backend/@autowired/","tags":["Java","Spring","DI","IoC","Autowired","Constructor","Best-Practices"],"title":"Spring ä¾è³´æ³¨å…¥å®Œæ•´æŒ‡å—ï¼š@Autowired èˆ‡æœ€ä½³å¯¦è¸"},{"content":"æ¦‚è¿° SOLID æ˜¯ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆå’Œè»Ÿé«”æ¶æ§‹è¨­è¨ˆä¸­äº”å€‹æ ¸å¿ƒè¨­è¨ˆåŸå‰‡çš„ç¸®å¯«ï¼Œç”± Robert C. Martinï¼ˆUncle Bobï¼‰åœ¨ 21 ä¸–ç´€åˆæœŸæå‡ºã€‚é€™äº›åŸå‰‡æ—¨åœ¨è®“è»Ÿé«”è¨­è¨ˆæ›´åŠ å®¹æ˜“ç†è§£ã€éˆæ´»ä¸”å¯ç¶­è­·ã€‚\nSOLID åŸå‰‡ä¸åƒ…é©ç”¨æ–¼ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆï¼Œä¹Ÿæ˜¯ç¾ä»£è»Ÿé«”æ¶æ§‹çš„åŸºçŸ³ï¼Œå¾å¾®æœå‹™è¨­è¨ˆåˆ° Clean Architecture éƒ½æ·±å—å…¶å½±éŸ¿ã€‚\nSOLID åŸå‰‡æ¦‚è¦½ é¦–å­—æ¯ è‹±æ–‡åŸå‰‡åç¨± ä¸­æ–‡åç¨± æ ¸å¿ƒæ¦‚å¿µ S Single Responsibility Principle å–®ä¸€è·è²¬åŸå‰‡ ä¸€å€‹é¡åˆ¥æ‡‰è©²åªæœ‰ä¸€å€‹æ”¹è®Šçš„ç†ç”± O Open/Closed Principle é–‹é–‰åŸå‰‡ å°æ“´å±•é–‹æ”¾ï¼Œå°ä¿®æ”¹å°é–‰ L Liskov Substitution Principle é‡Œæ°æ›¿æ›åŸå‰‡ å­é¡åˆ¥æ‡‰è©²èƒ½å®Œå…¨æ›¿æ›çˆ¶é¡åˆ¥ I Interface Segregation Principle ä»‹é¢éš”é›¢åŸå‰‡ å®¢æˆ¶ç«¯ä¸æ‡‰è©²ä¾è³´å®ƒä¸éœ€è¦çš„ä»‹é¢ D Dependency Inversion Principle ä¾è³´åè½‰åŸå‰‡ ä¾è³´æ–¼æŠ½è±¡è€Œéå…·é«”å¯¦ä½œ 1. Single Responsibility Principle (SRP) - å–®ä¸€è·è²¬åŸå‰‡ å®šç¾© ä¸€å€‹é¡åˆ¥æ‡‰è©²åªæœ‰ä¸€å€‹å¼•èµ·å®ƒè®ŠåŒ–çš„åŸå› \næ ¸å¿ƒæ¦‚å¿µ é«˜å…§èšæ€§ï¼šé¡åˆ¥å…§éƒ¨çš„æ–¹æ³•å’Œå±¬æ€§æ‡‰è©²ç‚ºåŒä¸€å€‹ç›®æ¨™æœå‹™ ä½è€¦åˆæ€§ï¼šæ¸›å°‘é¡åˆ¥ä¹‹é–“çš„ä¾è³´é—œä¿‚ æ˜ç¢ºè²¬ä»»ï¼šæ¯å€‹é¡åˆ¥éƒ½æ‡‰è©²æœ‰æ˜ç¢ºä¸”å–®ä¸€çš„è·è²¬ é•å SRP çš„ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // âŒ é•å SRPï¼šä¸€å€‹é¡åˆ¥æ‰¿æ“”å¤šç¨®è·è²¬ public class User { private String name; private String email; // ç”¨æˆ¶è³‡æ–™é©—è­‰è·è²¬ public boolean validateEmail(String email) { return email.contains(\u0026#34;@\u0026#34;) \u0026amp;\u0026amp; email.contains(\u0026#34;.\u0026#34;); } // ç”¨æˆ¶æŒä¹…åŒ–è·è²¬ public void saveToDatabase() { // è³‡æ–™åº«å­˜å„²é‚è¼¯ System.out.println(\u0026#34;å„²å­˜ç”¨æˆ¶åˆ°è³‡æ–™åº«\u0026#34;); } // ç”¨æˆ¶é€šçŸ¥è·è²¬ public void sendWelcomeEmail() { // éƒµä»¶ç™¼é€é‚è¼¯ System.out.println(\u0026#34;ç™¼é€æ­¡è¿éƒµä»¶\u0026#34;); } // ç”¨æˆ¶å ±è¡¨è·è²¬ public String generateUserReport() { return \u0026#34;ç”¨æˆ¶å ±è¡¨: \u0026#34; + name + \u0026#34; - \u0026#34; + email; } } éµå¾ª SRP çš„é‡æ§‹ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 // âœ… éµå¾ª SRPï¼šè·è²¬åˆ†é›¢ // 1. ç”¨æˆ¶å¯¦é«”é¡åˆ¥ï¼ˆåƒ…è² è²¬ç”¨æˆ¶è³‡æ–™ï¼‰ public class User { private String name; private String email; public User(String name, String email) { this.name = name; this.email = email; } // Getter and Setter methods public String getName() { return name; } public String getEmail() { return email; } public void setName(String name) { this.name = name; } public void setEmail(String email) { this.email = email; } } // 2. ç”¨æˆ¶é©—è­‰æœå‹™ï¼ˆåƒ…è² è²¬é©—è­‰é‚è¼¯ï¼‰ @Service public class UserValidator { public boolean validateEmail(String email) { return email != null \u0026amp;\u0026amp; email.contains(\u0026#34;@\u0026#34;) \u0026amp;\u0026amp; email.contains(\u0026#34;.\u0026#34;) \u0026amp;\u0026amp; email.length() \u0026gt; 5; } public boolean validateName(String name) { return name != null \u0026amp;\u0026amp; name.trim().length() \u0026gt; 0 \u0026amp;\u0026amp; name.length() \u0026lt;= 50; } public ValidationResult validateUser(User user) { ValidationResult result = new ValidationResult(); if (!validateName(user.getName())) { result.addError(\u0026#34;ç”¨æˆ¶åæ ¼å¼ç„¡æ•ˆ\u0026#34;); } if (!validateEmail(user.getEmail())) { result.addError(\u0026#34;éƒµç®±æ ¼å¼ç„¡æ•ˆ\u0026#34;); } return result; } } // 3. ç”¨æˆ¶æŒä¹…åŒ–æœå‹™ï¼ˆåƒ…è² è²¬è³‡æ–™å­˜å–ï¼‰ @Repository public class UserRepository { public void save(User user) { // è³‡æ–™åº«å­˜å„²é‚è¼¯ System.out.println(\u0026#34;å„²å­˜ç”¨æˆ¶åˆ°è³‡æ–™åº«: \u0026#34; + user.getName()); } public User findByEmail(String email) { // æŸ¥è©¢é‚è¼¯ return new User(\u0026#34;æ‰¾åˆ°çš„ç”¨æˆ¶\u0026#34;, email); } public List\u0026lt;User\u0026gt; findAll() { // æŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶ return Arrays.asList(new User(\u0026#34;ç”¨æˆ¶1\u0026#34;, \u0026#34;user1@example.com\u0026#34;)); } } // 4. ç”¨æˆ¶é€šçŸ¥æœå‹™ï¼ˆåƒ…è² è²¬é€šçŸ¥é‚è¼¯ï¼‰ @Service public class UserNotificationService { public void sendWelcomeEmail(User user) { System.out.println(\u0026#34;ç™¼é€æ­¡è¿éƒµä»¶çµ¦: \u0026#34; + user.getEmail()); } public void sendPasswordResetEmail(User user) { System.out.println(\u0026#34;ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶çµ¦: \u0026#34; + user.getEmail()); } public void sendAccountActivationEmail(User user) { System.out.println(\u0026#34;ç™¼é€å¸³æˆ¶å•Ÿç”¨éƒµä»¶çµ¦: \u0026#34; + user.getEmail()); } } // 5. ç”¨æˆ¶å ±è¡¨æœå‹™ï¼ˆåƒ…è² è²¬å ±è¡¨ç”Ÿæˆï¼‰ @Service public class UserReportService { public String generateUserReport(User user) { return String.format(\u0026#34;ç”¨æˆ¶å ±è¡¨\\nå§“å: %s\\néƒµç®±: %s\\nç”Ÿæˆæ™‚é–“: %s\u0026#34;, user.getName(), user.getEmail(), LocalDateTime.now()); } public String generateUsersListReport(List\u0026lt;User\u0026gt; users) { StringBuilder report = new StringBuilder(\u0026#34;ç”¨æˆ¶åˆ—è¡¨å ±è¡¨\\n\u0026#34;); users.forEach(user -\u0026gt; report.append(String.format(\u0026#34;- %s (%s)\\n\u0026#34;, user.getName(), user.getEmail())) ); return report.toString(); } } // 6. ç”¨æˆ¶æœå‹™å”èª¿å™¨ï¼ˆçµ„åˆå„ç¨®æœå‹™ï¼‰ @Service public class UserService { private final UserValidator userValidator; private final UserRepository userRepository; private final UserNotificationService notificationService; public UserService(UserValidator userValidator, UserRepository userRepository, UserNotificationService notificationService) { this.userValidator = userValidator; this.userRepository = userRepository; this.notificationService = notificationService; } public Result\u0026lt;User\u0026gt; createUser(String name, String email) { User user = new User(name, email); // é©—è­‰ç”¨æˆ¶è³‡æ–™ ValidationResult validation = userValidator.validateUser(user); if (!validation.isValid()) { return Result.failure(\u0026#34;é©—è­‰å¤±æ•—: \u0026#34; + validation.getErrors()); } // å„²å­˜ç”¨æˆ¶ userRepository.save(user); // ç™¼é€æ­¡è¿éƒµä»¶ notificationService.sendWelcomeEmail(user); return Result.success(user); } } SRP çš„å¥½è™• é™ä½è¤‡é›œåº¦ï¼šæ¯å€‹é¡åˆ¥çš„è²¬ä»»æ˜ç¢ºï¼Œæ˜“æ–¼ç†è§£ æé«˜å¯è®€æ€§ï¼šç¨‹å¼ç¢¼çµæ§‹æ¸…æ™°ï¼ŒåŠŸèƒ½åŠƒåˆ†æ˜ç¢º å¢å¼·å¯ç¶­è­·æ€§ï¼šä¿®æ”¹æŸå€‹åŠŸèƒ½æ™‚ï¼Œåªéœ€è¦é—œæ³¨ç‰¹å®šçš„é¡åˆ¥ æå‡å¯æ¸¬è©¦æ€§ï¼šè·è²¬å–®ä¸€çš„é¡åˆ¥æ›´å®¹æ˜“é€²è¡Œå–®å…ƒæ¸¬è©¦ ä¿ƒé€²é‡ç”¨æ€§ï¼šåŠŸèƒ½ç¨ç«‹çš„é¡åˆ¥å¯ä»¥åœ¨ä¸åŒå ´æ™¯ä¸­é‡è¤‡ä½¿ç”¨ 2. Open/Closed Principle (OCP) - é–‹é–‰åŸå‰‡ å®šç¾© è»Ÿé«”å¯¦é«”ï¼ˆé¡åˆ¥ã€æ¨¡çµ„ã€å‡½æ•¸ç­‰ï¼‰æ‡‰è©²å°æ“´å±•é–‹æ”¾ï¼Œå°ä¿®æ”¹å°é–‰\næ ¸å¿ƒæ¦‚å¿µ å°æ“´å±•é–‹æ”¾ï¼šå¯ä»¥é€éæ–°å¢ç¨‹å¼ç¢¼ä¾†æ“´å±•åŠŸèƒ½ å°ä¿®æ”¹å°é–‰ï¼šä¸æ‡‰è©²ä¿®æ”¹ç¾æœ‰çš„ç¨‹å¼ç¢¼ ç­–ç•¥æ¨¡å¼ï¼šé€éæŠ½è±¡ä»‹é¢å¯¦ç¾ä¸åŒçš„å¯¦ä½œç­–ç•¥ é•å OCP çš„ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // âŒ é•å OCPï¼šæ¯æ¬¡æ–°å¢å½¢ç‹€éƒ½éœ€è¦ä¿®æ”¹è¨ˆç®—å™¨é¡åˆ¥ public class AreaCalculator { public double calculateArea(Object shape) { if (shape instanceof Rectangle) { Rectangle rectangle = (Rectangle) shape; return rectangle.getWidth() * rectangle.getHeight(); } else if (shape instanceof Circle) { Circle circle = (Circle) shape; return Math.PI * circle.getRadius() * circle.getRadius(); } else if (shape instanceof Triangle) { // æ–°å¢ä¸‰è§’å½¢éœ€è¦ä¿®æ”¹æ­¤æ–¹æ³• Triangle triangle = (Triangle) shape; return 0.5 * triangle.getBase() * triangle.getHeight(); } // æ¯æ¬¡æ–°å¢æ–°å½¢ç‹€éƒ½éœ€è¦ä¿®æ”¹é€™è£¡ throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„å½¢ç‹€é¡å‹\u0026#34;); } } éµå¾ª OCP çš„é‡æ§‹ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 // âœ… éµå¾ª OCPï¼šå®šç¾©æŠ½è±¡ä»‹é¢ public interface Shape { double calculateArea(); String getShapeType(); } // å…·é«”å¯¦ä½œ - çŸ©å½¢ public class Rectangle implements Shape { private double width; private double height; public Rectangle(double width, double height) { this.width = width; this.height = height; } @Override public double calculateArea() { return width * height; } @Override public String getShapeType() { return \u0026#34;çŸ©å½¢\u0026#34;; } // Getter methods public double getWidth() { return width; } public double getHeight() { return height; } } // å…·é«”å¯¦ä½œ - åœ“å½¢ public class Circle implements Shape { private double radius; public Circle(double radius) { this.radius = radius; } @Override public double calculateArea() { return Math.PI * radius * radius; } @Override public String getShapeType() { return \u0026#34;åœ“å½¢\u0026#34;; } public double getRadius() { return radius; } } // å…·é«”å¯¦ä½œ - ä¸‰è§’å½¢ï¼ˆæ–°å¢æ™‚ç„¡éœ€ä¿®æ”¹ç¾æœ‰ç¨‹å¼ç¢¼ï¼‰ public class Triangle implements Shape { private double base; private double height; public Triangle(double base, double height) { this.base = base; this.height = height; } @Override public double calculateArea() { return 0.5 * base * height; } @Override public String getShapeType() { return \u0026#34;ä¸‰è§’å½¢\u0026#34;; } public double getBase() { return base; } public double getHeight() { return height; } } // æ–°å¢å¤šé‚Šå½¢ï¼ˆç„¡éœ€ä¿®æ”¹ç¾æœ‰ç¨‹å¼ç¢¼ï¼‰ public class Polygon implements Shape { private List\u0026lt;Point\u0026gt; vertices; public Polygon(List\u0026lt;Point\u0026gt; vertices) { this.vertices = vertices; } @Override public double calculateArea() { // ä½¿ç”¨é‹å¸¶å…¬å¼è¨ˆç®—å¤šé‚Šå½¢é¢ç© double area = 0; int n = vertices.size(); for (int i = 0; i \u0026lt; n; i++) { int j = (i + 1) % n; area += vertices.get(i).getX() * vertices.get(j).getY(); area -= vertices.get(j).getX() * vertices.get(i).getY(); } return Math.abs(area) / 2.0; } @Override public String getShapeType() { return \u0026#34;å¤šé‚Šå½¢\u0026#34;; } } // é¢ç©è¨ˆç®—å™¨ï¼ˆç„¡éœ€ä¿®æ”¹ï¼Œæ”¯æ´æ‰€æœ‰ Shape å¯¦ä½œï¼‰ @Service public class AreaCalculator { public double calculateArea(Shape shape) { return shape.calculateArea(); } public List\u0026lt;AreaReport\u0026gt; calculateMultipleAreas(List\u0026lt;Shape\u0026gt; shapes) { return shapes.stream() .map(shape -\u0026gt; new AreaReport( shape.getShapeType(), shape.calculateArea() )) .collect(Collectors.toList()); } public double calculateTotalArea(List\u0026lt;Shape\u0026gt; shapes) { return shapes.stream() .mapToDouble(Shape::calculateArea) .sum(); } } // å½¢ç‹€å·¥å» ï¼ˆæ”¯æ´æ“´å±•æ–°å½¢ç‹€ï¼‰ @Component public class ShapeFactory { public Shape createRectangle(double width, double height) { return new Rectangle(width, height); } public Shape createCircle(double radius) { return new Circle(radius); } public Shape createTriangle(double base, double height) { return new Triangle(base, height); } public Shape createPolygon(List\u0026lt;Point\u0026gt; vertices) { return new Polygon(vertices); } } // ä½¿ç”¨ç¯„ä¾‹ @RestController @RequestMapping(\u0026#34;/shapes\u0026#34;) public class ShapeController { private final AreaCalculator areaCalculator; private final ShapeFactory shapeFactory; public ShapeController(AreaCalculator areaCalculator, ShapeFactory shapeFactory) { this.areaCalculator = areaCalculator; this.shapeFactory = shapeFactory; } @PostMapping(\u0026#34;/rectangle/area\u0026#34;) public AreaResponse calculateRectangleArea(@RequestBody RectangleRequest request) { Shape rectangle = shapeFactory.createRectangle(request.getWidth(), request.getHeight()); double area = areaCalculator.calculateArea(rectangle); return new AreaResponse(rectangle.getShapeType(), area); } @PostMapping(\u0026#34;/circle/area\u0026#34;) public AreaResponse calculateCircleArea(@RequestBody CircleRequest request) { Shape circle = shapeFactory.createCircle(request.getRadius()); double area = areaCalculator.calculateArea(circle); return new AreaResponse(circle.getShapeType(), area); } } é€²éšæ‡‰ç”¨ï¼šç­–ç•¥æ¨¡å¼èˆ‡å·¥å» æ¨¡å¼çµåˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 // æŠ˜æ‰£ç­–ç•¥ä»‹é¢ public interface DiscountStrategy { double calculateDiscount(double originalPrice); String getStrategyName(); } // å…·é«”æŠ˜æ‰£ç­–ç•¥ @Component(\u0026#34;regular\u0026#34;) public class RegularCustomerDiscount implements DiscountStrategy { @Override public double calculateDiscount(double originalPrice) { return originalPrice * 0.05; // 5% æŠ˜æ‰£ } @Override public String getStrategyName() { return \u0026#34;ä¸€èˆ¬å®¢æˆ¶æŠ˜æ‰£\u0026#34;; } } @Component(\u0026#34;vip\u0026#34;) public class VipCustomerDiscount implements DiscountStrategy { @Override public double calculateDiscount(double originalPrice) { return originalPrice * 0.15; // 15% æŠ˜æ‰£ } @Override public String getStrategyName() { return \u0026#34;VIP å®¢æˆ¶æŠ˜æ‰£\u0026#34;; } } @Component(\u0026#34;premium\u0026#34;) public class PremiumCustomerDiscount implements DiscountStrategy { @Override public double calculateDiscount(double originalPrice) { return originalPrice * 0.25; // 25% æŠ˜æ‰£ } @Override public String getStrategyName() { return \u0026#34;å°Šäº«å®¢æˆ¶æŠ˜æ‰£\u0026#34;; } } // æŠ˜æ‰£è¨ˆç®—å™¨ï¼ˆå°ä¿®æ”¹å°é–‰ï¼Œå°æ“´å±•é–‹æ”¾ï¼‰ @Service public class DiscountCalculator { private final Map\u0026lt;String, DiscountStrategy\u0026gt; strategies; public DiscountCalculator(Map\u0026lt;String, DiscountStrategy\u0026gt; strategies) { this.strategies = strategies; } public DiscountResult calculateDiscount(String customerType, double originalPrice) { DiscountStrategy strategy = strategies.get(customerType); if (strategy == null) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„å®¢æˆ¶é¡å‹: \u0026#34; + customerType); } double discountAmount = strategy.calculateDiscount(originalPrice); double finalPrice = originalPrice - discountAmount; return new DiscountResult( strategy.getStrategyName(), originalPrice, discountAmount, finalPrice ); } } 3. Liskov Substitution Principle (LSP) - é‡Œæ°æ›¿æ›åŸå‰‡ å®šç¾© å­é¡åˆ¥å¿…é ˆèƒ½å¤ æ›¿æ›å…¶çˆ¶é¡åˆ¥ï¼Œè€Œä¸æœƒæ”¹è®Šç¨‹å¼çš„æ­£ç¢ºæ€§\næ ¸å¿ƒæ¦‚å¿µ è¡Œç‚ºç›¸å®¹æ€§ï¼šå­é¡åˆ¥çš„è¡Œç‚ºæ‡‰è©²èˆ‡çˆ¶é¡åˆ¥ä¸€è‡´ å¥‘ç´„ä¿æŒï¼šå­é¡åˆ¥ä¸èƒ½é•åçˆ¶é¡åˆ¥å»ºç«‹çš„å¥‘ç´„ å¼·åŒ–å‰ç½®æ¢ä»¶ï¼šå­é¡åˆ¥ä¸èƒ½å¼·åŒ–å‰ç½®æ¢ä»¶ å¼±åŒ–å¾Œç½®æ¢ä»¶ï¼šå­é¡åˆ¥ä¸èƒ½å¼±åŒ–å¾Œç½®æ¢ä»¶ é•å LSP çš„ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 // âŒ é•å LSPï¼šæ­£æ–¹å½¢ä¿®æ”¹äº†çŸ©å½¢çš„è¡Œç‚ºå¥‘ç´„ public class Rectangle { protected double width; protected double height; public Rectangle(double width, double height) { this.width = width; this.height = height; } public void setWidth(double width) { this.width = width; } public void setHeight(double height) { this.height = height; } public double getWidth() { return width; } public double getHeight() { return height; } public double getArea() { return width * height; } } // âŒ æ­£æ–¹å½¢ç¹¼æ‰¿çŸ©å½¢ï¼Œä½†é•åäº†é‡Œæ°æ›¿æ›åŸå‰‡ public class Square extends Rectangle { public Square(double side) { super(side, side); } // é•åLSPï¼šæ”¹è®Šäº†çˆ¶é¡åˆ¥çš„è¡Œç‚ºå¥‘ç´„ @Override public void setWidth(double width) { this.width = width; this.height = width; // å¼·åˆ¶ä¿æŒæ­£æ–¹å½¢æ€§è³ª } @Override public void setHeight(double height) { this.width = height; // å¼·åˆ¶ä¿æŒæ­£æ–¹å½¢æ€§è³ª this.height = height; } } // æ¸¬è©¦ç¨‹å¼ç¢¼å±•ç¤ºå•é¡Œ public class GeometryTest { public static void testRectangle(Rectangle rectangle) { rectangle.setWidth(4); rectangle.setHeight(5); // æœŸæœ›é¢ç©æ˜¯ 20ï¼Œä½†å¦‚æœå‚³å…¥ Square ç‰©ä»¶ï¼Œé¢ç©æœƒæ˜¯ 25 double expectedArea = 20; double actualArea = rectangle.getArea(); System.out.println(\u0026#34;æœŸæœ›é¢ç©: \u0026#34; + expectedArea); System.out.println(\u0026#34;å¯¦éš›é¢ç©: \u0026#34; + actualArea); System.out.println(\u0026#34;æ¸¬è©¦çµæœ: \u0026#34; + (expectedArea == actualArea ? \u0026#34;é€šé\u0026#34; : \u0026#34;å¤±æ•—\u0026#34;)); } public static void main(String[] args) { Rectangle rectangle = new Rectangle(0, 0); testRectangle(rectangle); // é€šé Rectangle square = new Square(0); testRectangle(square); // å¤±æ•—ï¼é•åäº† LSP } } éµå¾ª LSP çš„é‡æ§‹ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 // âœ… éµå¾ª LSPï¼šé‡æ–°è¨­è¨ˆç¹¼æ‰¿éšå±¤ // æŠ½è±¡åŸºç¤é¡åˆ¥ public abstract class Shape { public abstract double getArea(); public abstract double getPerimeter(); public abstract String getShapeType(); // æ¨¡æ¿æ–¹æ³• public String getShapeInfo() { return String.format(\u0026#34;%s - é¢ç©: %.2f, å‘¨é•·: %.2f\u0026#34;, getShapeType(), getArea(), getPerimeter()); } } // çŸ©å½¢å¯¦ä½œ public class Rectangle extends Shape { private double width; private double height; public Rectangle(double width, double height) { if (width \u0026lt;= 0 || height \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;é•·åº¦å’Œå¯¬åº¦å¿…é ˆå¤§æ–¼ 0\u0026#34;); } this.width = width; this.height = height; } @Override public double getArea() { return width * height; } @Override public double getPerimeter() { return 2 * (width + height); } @Override public String getShapeType() { return \u0026#34;çŸ©å½¢\u0026#34;; } // åªæä¾›å®‰å…¨çš„ä¿®æ”¹æ–¹æ³• public Rectangle resize(double newWidth, double newHeight) { return new Rectangle(newWidth, newHeight); } public double getWidth() { return width; } public double getHeight() { return height; } } // æ­£æ–¹å½¢å¯¦ä½œï¼ˆä¸ç¹¼æ‰¿çŸ©å½¢ï¼‰ public class Square extends Shape { private double side; public Square(double side) { if (side \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;é‚Šé•·å¿…é ˆå¤§æ–¼ 0\u0026#34;); } this.side = side; } @Override public double getArea() { return side * side; } @Override public double getPerimeter() { return 4 * side; } @Override public String getShapeType() { return \u0026#34;æ­£æ–¹å½¢\u0026#34;; } public Square resize(double newSide) { return new Square(newSide); } public double getSide() { return side; } } // åœ“å½¢å¯¦ä½œ public class Circle extends Shape { private double radius; public Circle(double radius) { if (radius \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;åŠå¾‘å¿…é ˆå¤§æ–¼ 0\u0026#34;); } this.radius = radius; } @Override public double getArea() { return Math.PI * radius * radius; } @Override public double getPerimeter() { return 2 * Math.PI * radius; } @Override public String getShapeType() { return \u0026#34;åœ“å½¢\u0026#34;; } public Circle resize(double newRadius) { return new Circle(newRadius); } public double getRadius() { return radius; } } // å¹¾ä½•è¨ˆç®—å™¨ï¼ˆå¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ä»»ä½• Shape å­é¡åˆ¥ï¼‰ @Service public class GeometryCalculator { // å¯ä»¥å®‰å…¨åœ°æ¥å—ä»»ä½• Shape å­é¡åˆ¥ public double calculateArea(Shape shape) { return shape.getArea(); } public double calculatePerimeter(Shape shape) { return shape.getPerimeter(); } public List\u0026lt;ShapeReport\u0026gt; generateShapeReports(List\u0026lt;Shape\u0026gt; shapes) { return shapes.stream() .map(shape -\u0026gt; new ShapeReport( shape.getShapeType(), shape.getArea(), shape.getPerimeter() )) .collect(Collectors.toList()); } public Shape findLargestShape(List\u0026lt;Shape\u0026gt; shapes) { return shapes.stream() .max(Comparator.comparing(Shape::getArea)) .orElseThrow(() -\u0026gt; new IllegalArgumentException(\u0026#34;å½¢ç‹€åˆ—è¡¨ä¸èƒ½ç‚ºç©º\u0026#34;)); } } // æ¸¬è©¦è­‰æ˜ LSP åˆè¦æ€§ @Component public class GeometryTestService { private final GeometryCalculator calculator; public GeometryTestService(GeometryCalculator calculator) { this.calculator = calculator; } public void testShapePolymorphism() { List\u0026lt;Shape\u0026gt; shapes = Arrays.asList( new Rectangle(4, 5), // é¢ç©: 20 new Square(4), // é¢ç©: 16 new Circle(3) // é¢ç©: ~28.27 ); // æ‰€æœ‰å½¢ç‹€éƒ½å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ç›¸åŒçš„æ–¹æ³• shapes.forEach(shape -\u0026gt; { System.out.println(shape.getShapeInfo()); }); // æ‰¾å‡ºæœ€å¤§é¢ç©çš„å½¢ç‹€ Shape largest = calculator.findLargestShape(shapes); System.out.println(\u0026#34;æœ€å¤§å½¢ç‹€: \u0026#34; + largest.getShapeInfo()); } } LSP çš„é€²éšæ‡‰ç”¨ï¼šå¥‘ç´„è¨­è¨ˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 // å®šç¾©æ¸…æ¥šçš„å¥‘ç´„ public abstract class Bird { protected String name; protected double weight; public Bird(String name, double weight) { this.name = name; this.weight = weight; } // å¥‘ç´„ï¼šæ‰€æœ‰é³¥é¡éƒ½å¯ä»¥åƒ public abstract void eat(String food); // å¥‘ç´„ï¼šæ‰€æœ‰é³¥é¡éƒ½å¯ä»¥ç§»å‹• public abstract void move(); public String getName() { return name; } public double getWeight() { return weight; } } // å¯é£›è¡Œçš„é³¥é¡ä»‹é¢ public interface Flyable { void fly(); double getMaxFlightHeight(); } // å¯æ¸¸æ³³çš„é³¥é¡ä»‹é¢ public interface Swimmable { void swim(); double getMaxDivingDepth(); } // å…·é«”å¯¦ä½œ - è€é·¹ï¼ˆå¯é£›è¡Œï¼‰ public class Eagle extends Bird implements Flyable { public Eagle(String name, double weight) { super(name, weight); } @Override public void eat(String food) { System.out.println(name + \u0026#34; æ­£åœ¨åƒ \u0026#34; + food); } @Override public void move() { fly(); // è€é·¹ä¸»è¦é€éé£›è¡Œç§»å‹• } @Override public void fly() { System.out.println(name + \u0026#34; æ­£åœ¨é«˜ç©ºé£›ç¿”\u0026#34;); } @Override public double getMaxFlightHeight() { return 3000; // 3000å…¬å°º } } // å…·é«”å¯¦ä½œ - ä¼éµï¼ˆå¯æ¸¸æ³³ï¼Œä¸èƒ½é£›è¡Œï¼‰ public class Penguin extends Bird implements Swimmable { public Penguin(String name, double weight) { super(name, weight); } @Override public void eat(String food) { System.out.println(name + \u0026#34; æ­£åœ¨åƒ \u0026#34; + food); } @Override public void move() { swim(); // ä¼éµä¸»è¦é€éæ¸¸æ³³ç§»å‹• } @Override public void swim() { System.out.println(name + \u0026#34; æ­£åœ¨æ°´ä¸­æ¸¸æ³³\u0026#34;); } @Override public double getMaxDivingDepth() { return 200; // 200å…¬å°º } } // é³¥é¡ç®¡ç†æœå‹™ï¼ˆå®Œå…¨éµå¾ª LSPï¼‰ @Service public class BirdManagementService { // å¯ä»¥å®‰å…¨åœ°è™•ç†ä»»ä½• Bird å­é¡åˆ¥ public void feedBird(Bird bird, String food) { bird.eat(food); } public void moveBird(Bird bird) { bird.move(); } // å°ˆé–€è™•ç†å¯é£›è¡Œçš„é³¥é¡ public void makeFly(Flyable flyableBird) { flyableBird.fly(); System.out.println(\u0026#34;æœ€å¤§é£›è¡Œé«˜åº¦: \u0026#34; + flyableBird.getMaxFlightHeight() + \u0026#34; å…¬å°º\u0026#34;); } // å°ˆé–€è™•ç†å¯æ¸¸æ³³çš„é³¥é¡ public void makeSwim(Swimmable swimmableBird) { swimmableBird.swim(); System.out.println(\u0026#34;æœ€å¤§æ½›æ°´æ·±åº¦: \u0026#34; + swimmableBird.getMaxDivingDepth() + \u0026#34; å…¬å°º\u0026#34;); } } 4. Interface Segregation Principle (ISP) - ä»‹é¢éš”é›¢åŸå‰‡ å®šç¾© ä¸æ‡‰è©²å¼·è¿«å®¢æˆ¶ç«¯ä¾è³´å®ƒå€‘ä¸ä½¿ç”¨çš„ä»‹é¢æ–¹æ³•\næ ¸å¿ƒæ¦‚å¿µ ä»‹é¢æœ€å°åŒ–ï¼šä»‹é¢æ‡‰è©²åªåŒ…å«å®¢æˆ¶ç«¯éœ€è¦çš„æ–¹æ³• è·è²¬åˆ†é›¢ï¼šå¤§ä»‹é¢æ‡‰è©²æ‹†åˆ†æˆå¤šå€‹å°ä»‹é¢ ä¾è³´æœ€å°åŒ–ï¼šé™ä½ä»‹é¢ä¹‹é–“çš„è€¦åˆåº¦ é•å ISP çš„ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 // âŒ é•å ISPï¼šè¬èƒ½ä»‹é¢ï¼Œå¼·è¿«å¯¦ä½œä¸éœ€è¦çš„æ–¹æ³• public interface MediaPlayer { void playAudio(String audioFile); void playVideo(String videoFile); void displaySubtitles(String subtitleFile); void adjustVolume(int volume); void adjustBrightness(int brightness); void recordAudio(); void recordVideo(); void takeScreenshot(); void applyAudioFilter(String filter); void applyVideoFilter(String filter); } // âŒ éŸ³é »æ’­æ”¾å™¨è¢«è¿«å¯¦ä½œä¸éœ€è¦çš„è¦–é »ç›¸é—œæ–¹æ³• public class AudioPlayer implements MediaPlayer { @Override public void playAudio(String audioFile) { System.out.println(\u0026#34;æ’­æ”¾éŸ³é »: \u0026#34; + audioFile); } @Override public void adjustVolume(int volume) { System.out.println(\u0026#34;èª¿æ•´éŸ³é‡åˆ°: \u0026#34; + volume); } @Override public void applyAudioFilter(String filter) { System.out.println(\u0026#34;æ‡‰ç”¨éŸ³é »æ¿¾é¡: \u0026#34; + filter); } // è¢«è¿«å¯¦ä½œä¸éœ€è¦çš„æ–¹æ³• @Override public void playVideo(String videoFile) { throw new UnsupportedOperationException(\u0026#34;éŸ³é »æ’­æ”¾å™¨ä¸æ”¯æ´è¦–é »æ’­æ”¾\u0026#34;); } @Override public void displaySubtitles(String subtitleFile) { throw new UnsupportedOperationException(\u0026#34;éŸ³é »æ’­æ”¾å™¨ä¸æ”¯æ´å­—å¹•\u0026#34;); } @Override public void adjustBrightness(int brightness) { throw new UnsupportedOperationException(\u0026#34;éŸ³é »æ’­æ”¾å™¨ä¸æ”¯æ´äº®åº¦èª¿æ•´\u0026#34;); } @Override public void recordAudio() { throw new UnsupportedOperationException(\u0026#34;æ­¤éŸ³é »æ’­æ”¾å™¨ä¸æ”¯æ´éŒ„éŸ³\u0026#34;); } @Override public void recordVideo() { throw new UnsupportedOperationException(\u0026#34;éŸ³é »æ’­æ”¾å™¨ä¸æ”¯æ´è¦–é »éŒ„è£½\u0026#34;); } @Override public void takeScreenshot() { throw new UnsupportedOperationException(\u0026#34;éŸ³é »æ’­æ”¾å™¨ä¸æ”¯æ´æˆªåœ–\u0026#34;); } @Override public void applyVideoFilter(String filter) { throw new UnsupportedOperationException(\u0026#34;éŸ³é »æ’­æ”¾å™¨ä¸æ”¯æ´è¦–é »æ¿¾é¡\u0026#34;); } } éµå¾ª ISP çš„é‡æ§‹ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 // âœ… éµå¾ª ISPï¼šå°‡å¤§ä»‹é¢æ‹†åˆ†æˆå¤šå€‹è·è²¬æ˜ç¢ºçš„å°ä»‹é¢ // åŸºç¤æ’­æ”¾ä»‹é¢ public interface Playable { void play(String file); void pause(); void stop(); void seek(long position); } // éŸ³é »ç›¸é—œä»‹é¢ public interface AudioPlayable extends Playable { void adjustVolume(int volume); int getVolume(); } // è¦–é »ç›¸é—œä»‹é¢ public interface VideoPlayable extends Playable { void adjustBrightness(int brightness); void adjustContrast(int contrast); int getBrightness(); int getContrast(); } // å­—å¹•æ”¯æ´ä»‹é¢ public interface SubtitleSupport { void loadSubtitles(String subtitleFile); void showSubtitles(boolean show); void adjustSubtitleSize(int size); } // éŒ„éŸ³ä»‹é¢ public interface AudioRecordable { void startAudioRecording(String outputFile); void stopAudioRecording(); boolean isRecording(); } // éŒ„å½±ä»‹é¢ public interface VideoRecordable { void startVideoRecording(String outputFile); void stopVideoRecording(); void takeScreenshot(String outputFile); } // æ¿¾é¡æ”¯æ´ä»‹é¢ public interface AudioFilterSupport { void applyAudioFilter(AudioFilter filter); void removeAudioFilter(); List\u0026lt;AudioFilter\u0026gt; getAvailableAudioFilters(); } public interface VideoFilterSupport { void applyVideoFilter(VideoFilter filter); void removeVideoFilter(); List\u0026lt;VideoFilter\u0026gt; getAvailableVideoFilters(); } // éŸ³é »æ’­æ”¾å™¨å¯¦ä½œï¼ˆåªå¯¦ä½œéœ€è¦çš„ä»‹é¢ï¼‰ @Component public class SimpleAudioPlayer implements AudioPlayable, AudioFilterSupport { private int volume = 50; private boolean isPlaying = false; private AudioFilter currentFilter; @Override public void play(String file) { System.out.println(\u0026#34;æ’­æ”¾éŸ³é »æª”æ¡ˆ: \u0026#34; + file); isPlaying = true; } @Override public void pause() { System.out.println(\u0026#34;æš«åœæ’­æ”¾\u0026#34;); isPlaying = false; } @Override public void stop() { System.out.println(\u0026#34;åœæ­¢æ’­æ”¾\u0026#34;); isPlaying = false; } @Override public void seek(long position) { System.out.println(\u0026#34;è·³è½‰åˆ°ä½ç½®: \u0026#34; + position + \u0026#34; ç§’\u0026#34;); } @Override public void adjustVolume(int volume) { this.volume = Math.max(0, Math.min(100, volume)); System.out.println(\u0026#34;éŸ³é‡èª¿æ•´ç‚º: \u0026#34; + this.volume); } @Override public int getVolume() { return volume; } @Override public void applyAudioFilter(AudioFilter filter) { this.currentFilter = filter; System.out.println(\u0026#34;æ‡‰ç”¨éŸ³é »æ¿¾é¡: \u0026#34; + filter.getName()); } @Override public void removeAudioFilter() { this.currentFilter = null; System.out.println(\u0026#34;ç§»é™¤éŸ³é »æ¿¾é¡\u0026#34;); } @Override public List\u0026lt;AudioFilter\u0026gt; getAvailableAudioFilters() { return Arrays.asList( new AudioFilter(\u0026#34;å›éŸ³\u0026#34;, \u0026#34;echo\u0026#34;), new AudioFilter(\u0026#34;é™å™ª\u0026#34;, \u0026#34;noise_reduction\u0026#34;), new AudioFilter(\u0026#34;ç­‰åŒ–å™¨\u0026#34;, \u0026#34;equalizer\u0026#34;) ); } } // å°ˆæ¥­éŒ„éŸ³æ©Ÿå¯¦ä½œï¼ˆå¯¦ä½œéŒ„éŸ³ç›¸é—œä»‹é¢ï¼‰ @Component public class ProfessionalAudioRecorder implements AudioPlayable, AudioRecordable, AudioFilterSupport { private int volume = 50; private boolean isPlaying = false; private boolean isRecording = false; private String currentRecordingFile; // å¯¦ä½œæ’­æ”¾åŠŸèƒ½ @Override public void play(String file) { if (!isRecording) { System.out.println(\u0026#34;æ’­æ”¾éŸ³é »æª”æ¡ˆ: \u0026#34; + file); isPlaying = true; } else { System.out.println(\u0026#34;éŒ„éŸ³ä¸­ï¼Œç„¡æ³•æ’­æ”¾\u0026#34;); } } @Override public void pause() { System.out.println(\u0026#34;æš«åœæ’­æ”¾\u0026#34;); isPlaying = false; } @Override public void stop() { System.out.println(\u0026#34;åœæ­¢æ’­æ”¾\u0026#34;); isPlaying = false; } @Override public void seek(long position) { System.out.println(\u0026#34;è·³è½‰åˆ°ä½ç½®: \u0026#34; + position + \u0026#34; ç§’\u0026#34;); } @Override public void adjustVolume(int volume) { this.volume = Math.max(0, Math.min(100, volume)); System.out.println(\u0026#34;éŸ³é‡èª¿æ•´ç‚º: \u0026#34; + this.volume); } @Override public int getVolume() { return volume; } // å¯¦ä½œéŒ„éŸ³åŠŸèƒ½ @Override public void startAudioRecording(String outputFile) { if (!isPlaying) { this.currentRecordingFile = outputFile; this.isRecording = true; System.out.println(\u0026#34;é–‹å§‹éŒ„éŸ³åˆ°: \u0026#34; + outputFile); } else { System.out.println(\u0026#34;æ’­æ”¾ä¸­ï¼Œç„¡æ³•éŒ„éŸ³\u0026#34;); } } @Override public void stopAudioRecording() { if (isRecording) { this.isRecording = false; System.out.println(\u0026#34;éŒ„éŸ³å®Œæˆ: \u0026#34; + currentRecordingFile); this.currentRecordingFile = null; } } @Override public boolean isRecording() { return isRecording; } // å¯¦ä½œæ¿¾é¡åŠŸèƒ½ @Override public void applyAudioFilter(AudioFilter filter) { System.out.println(\u0026#34;æ‡‰ç”¨å°ˆæ¥­éŸ³é »æ¿¾é¡: \u0026#34; + filter.getName()); } @Override public void removeAudioFilter() { System.out.println(\u0026#34;ç§»é™¤éŸ³é »æ¿¾é¡\u0026#34;); } @Override public List\u0026lt;AudioFilter\u0026gt; getAvailableAudioFilters() { return Arrays.asList( new AudioFilter(\u0026#34;å›éŸ³\u0026#34;, \u0026#34;echo\u0026#34;), new AudioFilter(\u0026#34;é™å™ª\u0026#34;, \u0026#34;noise_reduction\u0026#34;), new AudioFilter(\u0026#34;ç­‰åŒ–å™¨\u0026#34;, \u0026#34;equalizer\u0026#34;), new AudioFilter(\u0026#34;å£“ç¸®å™¨\u0026#34;, \u0026#34;compressor\u0026#34;), new AudioFilter(\u0026#34;é™åˆ¶å™¨\u0026#34;, \u0026#34;limiter\u0026#34;) ); } } // è¦–é »æ’­æ”¾å™¨å¯¦ä½œï¼ˆå¯¦ä½œè¦–é »ç›¸é—œä»‹é¢ï¼‰ @Component public class VideoPlayer implements VideoPlayable, SubtitleSupport, VideoFilterSupport { private int brightness = 50; private int contrast = 50; private boolean subtitlesVisible = false; private String currentSubtitleFile; @Override public void play(String file) { System.out.println(\u0026#34;æ’­æ”¾è¦–é »æª”æ¡ˆ: \u0026#34; + file); } @Override public void pause() { System.out.println(\u0026#34;æš«åœè¦–é »\u0026#34;); } @Override public void stop() { System.out.println(\u0026#34;åœæ­¢è¦–é »\u0026#34;); } @Override public void seek(long position) { System.out.println(\u0026#34;è·³è½‰åˆ°è¦–é »ä½ç½®: \u0026#34; + position + \u0026#34; ç§’\u0026#34;); } @Override public void adjustBrightness(int brightness) { this.brightness = Math.max(0, Math.min(100, brightness)); System.out.println(\u0026#34;äº®åº¦èª¿æ•´ç‚º: \u0026#34; + this.brightness); } @Override public void adjustContrast(int contrast) { this.contrast = Math.max(0, Math.min(100, contrast)); System.out.println(\u0026#34;å°æ¯”åº¦èª¿æ•´ç‚º: \u0026#34; + this.contrast); } @Override public int getBrightness() { return brightness; } @Override public int getContrast() { return contrast; } // å­—å¹•æ”¯æ´ @Override public void loadSubtitles(String subtitleFile) { this.currentSubtitleFile = subtitleFile; System.out.println(\u0026#34;è¼‰å…¥å­—å¹•æª”æ¡ˆ: \u0026#34; + subtitleFile); } @Override public void showSubtitles(boolean show) { this.subtitlesVisible = show; System.out.println(\u0026#34;å­—å¹•é¡¯ç¤º: \u0026#34; + (show ? \u0026#34;é–‹å•Ÿ\u0026#34; : \u0026#34;é—œé–‰\u0026#34;)); } @Override public void adjustSubtitleSize(int size) { System.out.println(\u0026#34;å­—å¹•å¤§å°èª¿æ•´ç‚º: \u0026#34; + size); } // è¦–é »æ¿¾é¡æ”¯æ´ @Override public void applyVideoFilter(VideoFilter filter) { System.out.println(\u0026#34;æ‡‰ç”¨è¦–é »æ¿¾é¡: \u0026#34; + filter.getName()); } @Override public void removeVideoFilter() { System.out.println(\u0026#34;ç§»é™¤è¦–é »æ¿¾é¡\u0026#34;); } @Override public List\u0026lt;VideoFilter\u0026gt; getAvailableVideoFilters() { return Arrays.asList( new VideoFilter(\u0026#34;æ¨¡ç³Š\u0026#34;, \u0026#34;blur\u0026#34;), new VideoFilter(\u0026#34;éŠ³åŒ–\u0026#34;, \u0026#34;sharpen\u0026#34;), new VideoFilter(\u0026#34;è‰²å½©å¢å¼·\u0026#34;, \u0026#34;color_enhance\u0026#34;) ); } } // åª’é«”ç®¡ç†æœå‹™ï¼ˆä½¿ç”¨ä»‹é¢éš”é›¢çš„å¥½è™•ï¼‰ @Service public class MediaManagementService { // åªè™•ç†æ’­æ”¾åŠŸèƒ½ public void playMedia(Playable player, String file) { player.play(file); } // åªè™•ç†éŸ³é »æ’­æ”¾ public void playAudioWithVolume(AudioPlayable audioPlayer, String file, int volume) { audioPlayer.adjustVolume(volume); audioPlayer.play(file); } // åªè™•ç†éŒ„éŸ³åŠŸèƒ½ public void recordAudio(AudioRecordable recorder, String outputFile) { if (!recorder.isRecording()) { recorder.startAudioRecording(outputFile); } } // åªè™•ç†å­—å¹•åŠŸèƒ½ public void setupSubtitles(SubtitleSupport player, String subtitleFile) { player.loadSubtitles(subtitleFile); player.showSubtitles(true); } } 5. Dependency Inversion Principle (DIP) - ä¾è³´åè½‰åŸå‰‡ å®šç¾© é«˜å±¤æ¨¡çµ„ä¸æ‡‰è©²ä¾è³´ä½å±¤æ¨¡çµ„ï¼Œå…©è€…éƒ½æ‡‰è©²ä¾è³´æ–¼æŠ½è±¡ã€‚æŠ½è±¡ä¸æ‡‰è©²ä¾è³´æ–¼ç´°ç¯€ï¼Œç´°ç¯€æ‡‰è©²ä¾è³´æ–¼æŠ½è±¡ã€‚\næ ¸å¿ƒæ¦‚å¿µ ä¾è³´æ³¨å…¥ï¼šé€éå¤–éƒ¨æ³¨å…¥ä¾è³´è€Œéå…§éƒ¨å‰µå»º æ§åˆ¶åè½‰ï¼šå°‡ä¾è³´é—œä¿‚çš„æ§åˆ¶æ¬Šäº¤çµ¦å¤–éƒ¨å®¹å™¨ æŠ½è±¡ä¾è³´ï¼šä¾è³´æ–¼ä»‹é¢è€Œéå…·é«”å¯¦ä½œ é•å DIP çš„ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // âŒ é•å DIPï¼šé«˜å±¤æ¨¡çµ„ç›´æ¥ä¾è³´ä½å±¤æ¨¡çµ„çš„å…·é«”å¯¦ä½œ public class MySQLDatabase { public void save(String data) { System.out.println(\u0026#34;å„²å­˜è³‡æ–™åˆ° MySQL: \u0026#34; + data); } public String load(String id) { return \u0026#34;å¾ MySQL è¼‰å…¥è³‡æ–™: \u0026#34; + id; } } public class EmailService { public void sendEmail(String to, String subject, String body) { System.out.println(\u0026#34;ç™¼é€éƒµä»¶åˆ°: \u0026#34; + to); System.out.println(\u0026#34;ä¸»é¡Œ: \u0026#34; + subject); System.out.println(\u0026#34;å…§å®¹: \u0026#34; + body); } } // âŒ UserService ç›´æ¥ä¾è³´å…·é«”å¯¦ä½œï¼Œé›£ä»¥æ¸¬è©¦å’Œæ“´å±• public class UserService { private MySQLDatabase database; // ç›´æ¥ä¾è³´å…·é«”å¯¦ä½œ private EmailService emailService; // ç›´æ¥ä¾è³´å…·é«”å¯¦ä½œ public UserService() { this.database = new MySQLDatabase(); // åœ¨æ§‹é€ å‡½æ•¸ä¸­å‰µå»ºä¾è³´ this.emailService = new EmailService(); // ç¡¬ç·¨ç¢¼ä¾è³´ } public void createUser(String username, String email) { // é©—è­‰é‚è¼¯ if (username == null || username.trim().isEmpty()) { throw new IllegalArgumentException(\u0026#34;ç”¨æˆ¶åä¸èƒ½ç‚ºç©º\u0026#34;); } // å„²å­˜ç”¨æˆ¶ï¼ˆä¾è³´å…·é«”çš„ MySQL å¯¦ä½œï¼‰ String userData = \u0026#34;User: \u0026#34; + username + \u0026#34;, Email: \u0026#34; + email; database.save(userData); // ç™¼é€æ­¡è¿éƒµä»¶ï¼ˆä¾è³´å…·é«”çš„éƒµä»¶æœå‹™å¯¦ä½œï¼‰ emailService.sendEmail(email, \u0026#34;æ­¡è¿\u0026#34;, \u0026#34;æ­¡è¿åŠ å…¥æˆ‘å€‘çš„å¹³å°ï¼\u0026#34;); } public String getUser(String userId) { return database.load(userId); } } éµå¾ª DIP çš„é‡æ§‹ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 // âœ… éµå¾ª DIPï¼šå®šç¾©æŠ½è±¡ä»‹é¢ // è³‡æ–™åº«æŠ½è±¡ä»‹é¢ public interface UserRepository { void save(User user); Optional\u0026lt;User\u0026gt; findById(String id); Optional\u0026lt;User\u0026gt; findByEmail(String email); List\u0026lt;User\u0026gt; findAll(); void delete(String id); } // é€šçŸ¥æœå‹™æŠ½è±¡ä»‹é¢ public interface NotificationService { void sendWelcomeNotification(User user); void sendPasswordResetNotification(User user, String resetToken); void sendAccountActivationNotification(User user, String activationToken); } // ç”¨æˆ¶é©—è­‰æŠ½è±¡ä»‹é¢ public interface UserValidator { ValidationResult validate(User user); boolean isEmailUnique(String email); boolean isUsernameValid(String username); } // å…·é«”å¯¦ä½œ - MySQL è³‡æ–™åº« @Repository public class MySQLUserRepository implements UserRepository { @Override public void save(User user) { System.out.println(\u0026#34;å„²å­˜ç”¨æˆ¶åˆ° MySQL: \u0026#34; + user.getUsername()); // å¯¦éš›çš„è³‡æ–™åº«æ“ä½œé‚è¼¯ } @Override public Optional\u0026lt;User\u0026gt; findById(String id) { System.out.println(\u0026#34;å¾ MySQL æŸ¥æ‰¾ç”¨æˆ¶: \u0026#34; + id); // å¯¦éš›çš„æŸ¥è©¢é‚è¼¯ return Optional.of(new User(id, \u0026#34;user@example.com\u0026#34;)); } @Override public Optional\u0026lt;User\u0026gt; findByEmail(String email) { System.out.println(\u0026#34;å¾ MySQL æ ¹æ“šéƒµç®±æŸ¥æ‰¾ç”¨æˆ¶: \u0026#34; + email); return Optional.empty(); } @Override public List\u0026lt;User\u0026gt; findAll() { System.out.println(\u0026#34;å¾ MySQL æŸ¥æ‰¾æ‰€æœ‰ç”¨æˆ¶\u0026#34;); return Arrays.asList(new User(\u0026#34;1\u0026#34;, \u0026#34;user1@example.com\u0026#34;)); } @Override public void delete(String id) { System.out.println(\u0026#34;å¾ MySQL åˆªé™¤ç”¨æˆ¶: \u0026#34; + id); } } // å…·é«”å¯¦ä½œ - MongoDB è³‡æ–™åº«ï¼ˆå¯æ›¿æ›å¯¦ä½œï¼‰ @Repository @Profile(\u0026#34;mongodb\u0026#34;) public class MongoUserRepository implements UserRepository { @Override public void save(User user) { System.out.println(\u0026#34;å„²å­˜ç”¨æˆ¶åˆ° MongoDB: \u0026#34; + user.getUsername()); } @Override public Optional\u0026lt;User\u0026gt; findById(String id) { System.out.println(\u0026#34;å¾ MongoDB æŸ¥æ‰¾ç”¨æˆ¶: \u0026#34; + id); return Optional.of(new User(id, \u0026#34;user@example.com\u0026#34;)); } @Override public Optional\u0026lt;User\u0026gt; findByEmail(String email) { System.out.println(\u0026#34;å¾ MongoDB æ ¹æ“šéƒµç®±æŸ¥æ‰¾ç”¨æˆ¶: \u0026#34; + email); return Optional.empty(); } @Override public List\u0026lt;User\u0026gt; findAll() { System.out.println(\u0026#34;å¾ MongoDB æŸ¥æ‰¾æ‰€æœ‰ç”¨æˆ¶\u0026#34;); return Arrays.asList(new User(\u0026#34;1\u0026#34;, \u0026#34;user1@example.com\u0026#34;)); } @Override public void delete(String id) { System.out.println(\u0026#34;å¾ MongoDB åˆªé™¤ç”¨æˆ¶: \u0026#34; + id); } } // å…·é«”å¯¦ä½œ - éƒµä»¶é€šçŸ¥æœå‹™ @Service public class EmailNotificationService implements NotificationService { @Override public void sendWelcomeNotification(User user) { System.out.println(\u0026#34;ç™¼é€æ­¡è¿éƒµä»¶åˆ°: \u0026#34; + user.getEmail()); // å¯¦éš›çš„éƒµä»¶ç™¼é€é‚è¼¯ } @Override public void sendPasswordResetNotification(User user, String resetToken) { System.out.println(\u0026#34;ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶åˆ°: \u0026#34; + user.getEmail()); System.out.println(\u0026#34;é‡è¨­ä»¤ç‰Œ: \u0026#34; + resetToken); } @Override public void sendAccountActivationNotification(User user, String activationToken) { System.out.println(\u0026#34;ç™¼é€å¸³æˆ¶å•Ÿç”¨éƒµä»¶åˆ°: \u0026#34; + user.getEmail()); System.out.println(\u0026#34;å•Ÿç”¨ä»¤ç‰Œ: \u0026#34; + activationToken); } } // å…·é«”å¯¦ä½œ - SMS é€šçŸ¥æœå‹™ï¼ˆå¯æ›¿æ›å¯¦ä½œï¼‰ @Service @Profile(\u0026#34;sms\u0026#34;) public class SMSNotificationService implements NotificationService { @Override public void sendWelcomeNotification(User user) { System.out.println(\u0026#34;ç™¼é€æ­¡è¿ SMS åˆ°: \u0026#34; + user.getPhoneNumber()); } @Override public void sendPasswordResetNotification(User user, String resetToken) { System.out.println(\u0026#34;ç™¼é€å¯†ç¢¼é‡è¨­ SMS åˆ°: \u0026#34; + user.getPhoneNumber()); System.out.println(\u0026#34;é‡è¨­ä»£ç¢¼: \u0026#34; + resetToken); } @Override public void sendAccountActivationNotification(User user, String activationToken) { System.out.println(\u0026#34;ç™¼é€å¸³æˆ¶å•Ÿç”¨ SMS åˆ°: \u0026#34; + user.getPhoneNumber()); System.out.println(\u0026#34;å•Ÿç”¨ä»£ç¢¼: \u0026#34; + activationToken); } } // å…·é«”å¯¦ä½œ - ç”¨æˆ¶é©—è­‰å™¨ @Component public class DefaultUserValidator implements UserValidator { private final UserRepository userRepository; public DefaultUserValidator(UserRepository userRepository) { this.userRepository = userRepository; } @Override public ValidationResult validate(User user) { ValidationResult result = new ValidationResult(); if (!isUsernameValid(user.getUsername())) { result.addError(\u0026#34;ç”¨æˆ¶åæ ¼å¼ç„¡æ•ˆ\u0026#34;); } if (!isEmailValid(user.getEmail())) { result.addError(\u0026#34;éƒµç®±æ ¼å¼ç„¡æ•ˆ\u0026#34;); } if (!isEmailUnique(user.getEmail())) { result.addError(\u0026#34;éƒµç®±å·²è¢«ä½¿ç”¨\u0026#34;); } return result; } @Override public boolean isEmailUnique(String email) { return userRepository.findByEmail(email).isEmpty(); } @Override public boolean isUsernameValid(String username) { return username != null \u0026amp;\u0026amp; username.trim().length() \u0026gt;= 3 \u0026amp;\u0026amp; username.trim().length() \u0026lt;= 50 \u0026amp;\u0026amp; username.matches(\u0026#34;^[a-zA-Z0-9_]+$\u0026#34;); } private boolean isEmailValid(String email) { return email != null \u0026amp;\u0026amp; email.contains(\u0026#34;@\u0026#34;) \u0026amp;\u0026amp; email.contains(\u0026#34;.\u0026#34;) \u0026amp;\u0026amp; email.length() \u0026gt; 5; } } // é«˜å±¤æ¨¡çµ„ - ç”¨æˆ¶æœå‹™ï¼ˆä¾è³´æ–¼æŠ½è±¡ï¼‰ @Service public class UserService { private final UserRepository userRepository; private final NotificationService notificationService; private final UserValidator userValidator; // ä¾è³´æ³¨å…¥ï¼šé€éæ§‹é€ å‡½æ•¸æ³¨å…¥ä¾è³´ public UserService(UserRepository userRepository, NotificationService notificationService, UserValidator userValidator) { this.userRepository = userRepository; this.notificationService = notificationService; this.userValidator = userValidator; } public Result\u0026lt;User\u0026gt; createUser(String username, String email) { User user = new User(username, email); // é©—è­‰ç”¨æˆ¶è³‡æ–™ ValidationResult validation = userValidator.validate(user); if (!validation.isValid()) { return Result.failure(\u0026#34;é©—è­‰å¤±æ•—: \u0026#34; + validation.getErrors()); } try { // å„²å­˜ç”¨æˆ¶ userRepository.save(user); // ç™¼é€é€šçŸ¥ notificationService.sendWelcomeNotification(user); return Result.success(user); } catch (Exception e) { return Result.failure(\u0026#34;å‰µå»ºç”¨æˆ¶å¤±æ•—: \u0026#34; + e.getMessage()); } } public Result\u0026lt;User\u0026gt; getUserById(String id) { Optional\u0026lt;User\u0026gt; user = userRepository.findById(id); if (user.isPresent()) { return Result.success(user.get()); } else { return Result.failure(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨\u0026#34;); } } public Result\u0026lt;Void\u0026gt; resetPassword(String email) { Optional\u0026lt;User\u0026gt; userOpt = userRepository.findByEmail(email); if (userOpt.isEmpty()) { return Result.failure(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨\u0026#34;); } User user = userOpt.get(); String resetToken = generateResetToken(); // å„²å­˜é‡è¨­ä»¤ç‰Œï¼ˆå¯¦éš›æ‡‰è©²å„²å­˜åˆ°è³‡æ–™åº«ï¼‰ // userRepository.saveResetToken(user.getId(), resetToken); // ç™¼é€é‡è¨­é€šçŸ¥ notificationService.sendPasswordResetNotification(user, resetToken); return Result.success(null); } private String generateResetToken() { return \u0026#34;RESET-\u0026#34; + UUID.randomUUID().toString(); } } // é…ç½®é¡åˆ¥ï¼ˆæ§åˆ¶ä¾è³´æ³¨å…¥ï¼‰ @Configuration public class UserServiceConfiguration { @Bean @ConditionalOnProperty(name = \u0026#34;database.type\u0026#34;, havingValue = \u0026#34;mysql\u0026#34;, matchIfMissing = true) public UserRepository mysqlUserRepository() { return new MySQLUserRepository(); } @Bean @ConditionalOnProperty(name = \u0026#34;database.type\u0026#34;, havingValue = \u0026#34;mongodb\u0026#34;) public UserRepository mongoUserRepository() { return new MongoUserRepository(); } @Bean @ConditionalOnProperty(name = \u0026#34;notification.type\u0026#34;, havingValue = \u0026#34;email\u0026#34;, matchIfMissing = true) public NotificationService emailNotificationService() { return new EmailNotificationService(); } @Bean @ConditionalOnProperty(name = \u0026#34;notification.type\u0026#34;, havingValue = \u0026#34;sms\u0026#34;) public NotificationService smsNotificationService() { return new SMSNotificationService(); } } DIP çš„é€²éšæ‡‰ç”¨ï¼šå·¥å» æ¨¡å¼èˆ‡ç­–ç•¥æ¨¡å¼çµåˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 // å ±è¡¨ç”Ÿæˆç­–ç•¥ä»‹é¢ public interface ReportGenerator { String generateReport(List\u0026lt;User\u0026gt; users); String getReportFormat(); } // CSV å ±è¡¨ç”Ÿæˆå™¨ @Component(\u0026#34;csvReportGenerator\u0026#34;) public class CSVReportGenerator implements ReportGenerator { @Override public String generateReport(List\u0026lt;User\u0026gt; users) { StringBuilder csv = new StringBuilder(); csv.append(\u0026#34;ç”¨æˆ¶å,éƒµç®±,å‰µå»ºæ™‚é–“\\n\u0026#34;); users.forEach(user -\u0026gt; csv.append(String.format(\u0026#34;%s,%s,%s\\n\u0026#34;, user.getUsername(), user.getEmail(), user.getCreatedAt())) ); return csv.toString(); } @Override public String getReportFormat() { return \u0026#34;CSV\u0026#34;; } } // JSON å ±è¡¨ç”Ÿæˆå™¨ @Component(\u0026#34;jsonReportGenerator\u0026#34;) public class JSONReportGenerator implements ReportGenerator { private final ObjectMapper objectMapper; public JSONReportGenerator(ObjectMapper objectMapper) { this.objectMapper = objectMapper; } @Override public String generateReport(List\u0026lt;User\u0026gt; users) { try { Map\u0026lt;String, Object\u0026gt; report = new HashMap\u0026lt;\u0026gt;(); report.put(\u0026#34;totalUsers\u0026#34;, users.size()); report.put(\u0026#34;generatedAt\u0026#34;, LocalDateTime.now()); report.put(\u0026#34;users\u0026#34;, users); return objectMapper.writeValueAsString(report); } catch (Exception e) { throw new RuntimeException(\u0026#34;JSON å ±è¡¨ç”Ÿæˆå¤±æ•—\u0026#34;, e); } } @Override public String getReportFormat() { return \u0026#34;JSON\u0026#34;; } } // å ±è¡¨å·¥å»  @Service public class ReportGeneratorFactory { private final Map\u0026lt;String, ReportGenerator\u0026gt; generators; public ReportGeneratorFactory(Map\u0026lt;String, ReportGenerator\u0026gt; generators) { this.generators = generators; } public ReportGenerator getGenerator(String format) { ReportGenerator generator = generators.get(format.toLowerCase() + \u0026#34;ReportGenerator\u0026#34;); if (generator == null) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„å ±è¡¨æ ¼å¼: \u0026#34; + format); } return generator; } public List\u0026lt;String\u0026gt; getSupportedFormats() { return generators.values().stream() .map(ReportGenerator::getReportFormat) .collect(Collectors.toList()); } } // å ±è¡¨æœå‹™ï¼ˆé«˜å±¤æ¨¡çµ„ï¼Œä¾è³´æ–¼æŠ½è±¡ï¼‰ @Service public class UserReportService { private final UserRepository userRepository; private final ReportGeneratorFactory reportGeneratorFactory; public UserReportService(UserRepository userRepository, ReportGeneratorFactory reportGeneratorFactory) { this.userRepository = userRepository; this.reportGeneratorFactory = reportGeneratorFactory; } public String generateUserReport(String format) { List\u0026lt;User\u0026gt; users = userRepository.findAll(); ReportGenerator generator = reportGeneratorFactory.getGenerator(format); return generator.generateReport(users); } public List\u0026lt;String\u0026gt; getSupportedReportFormats() { return reportGeneratorFactory.getSupportedFormats(); } } ç¸½çµ SOLID åŸå‰‡æ˜¯è»Ÿé«”è¨­è¨ˆçš„åŸºçŸ³ï¼Œå®ƒå€‘ç›¸äº’è£œå……ï¼Œå…±åŒä¿ƒé€²ç¨‹å¼ç¢¼çš„å“è³ªï¼š\næ ¸å¿ƒåƒ¹å€¼ å¯ç¶­è­·æ€§ï¼šæ¯å€‹åŸå‰‡éƒ½æœ‰åŠ©æ–¼é™ä½ç¨‹å¼ç¢¼ä¿®æ”¹çš„è¤‡é›œåº¦ å¯æ“´å±•æ€§ï¼šæ”¯æ´æ–°åŠŸèƒ½çš„å¢åŠ è€Œä¸ç ´å£ç¾æœ‰åŠŸèƒ½ å¯æ¸¬è©¦æ€§ï¼šä¾è³´æ³¨å…¥å’Œä»‹é¢éš”é›¢ä½¿å–®å…ƒæ¸¬è©¦æ›´å®¹æ˜“ å¯é‡ç”¨æ€§ï¼šè·è²¬æ˜ç¢ºçš„é¡åˆ¥å¯ä»¥åœ¨ä¸åŒå ´æ™¯ä¸­é‡è¤‡ä½¿ç”¨ å¯¦è¸å»ºè­° å¾å°è™•é–‹å§‹ï¼šåœ¨æ–°å°ˆæ¡ˆä¸­é€æ­¥æ‡‰ç”¨ SOLID åŸå‰‡ é‡æ§‹ç¾æœ‰ç¨‹å¼ç¢¼ï¼šè­˜åˆ¥é•å SOLID åŸå‰‡çš„ç¨‹å¼ç¢¼ä¸¦é€æ­¥æ”¹é€² ä½¿ç”¨ç¾ä»£æ¡†æ¶ï¼šSpringã€ä¾è³´æ³¨å…¥å®¹å™¨ç­‰å·¥å…·æœ‰åŠ©æ–¼å¯¦è¸ SOLID åŸå‰‡ ç¨‹å¼ç¢¼å¯©æŸ¥ï¼šåœ¨åœ˜éšŠä¸­æ¨å»£ SOLID åŸå‰‡çš„ç†è§£å’Œæ‡‰ç”¨ æŒçºŒå­¸ç¿’ï¼šSOLID åŸå‰‡æ˜¯è»Ÿé«”æ¶æ§‹çš„åŸºç¤ï¼Œéœ€è¦åœ¨å¯¦è¸ä¸­ä¸æ–·æ·±åŒ–ç†è§£ å¸¸è¦‹é™·é˜± éåº¦è¨­è¨ˆï¼šä¸è¦ç‚ºäº†éµå¾ªåŸå‰‡è€Œå¢åŠ ä¸å¿…è¦çš„è¤‡é›œæ€§ æ•™æ¢ä¸»ç¾©ï¼šåŸå‰‡æ˜¯æŒ‡å°è€Œéçµ•å°è¦å‰‡ï¼Œéœ€è¦æ ¹æ“šå…·é«”æƒ…æ³éˆæ´»æ‡‰ç”¨ å¿½ç•¥æ€§èƒ½ï¼šåœ¨è¿½æ±‚è¨­è¨ˆåŸå‰‡çš„åŒæ™‚è¦è€ƒæ…®æ€§èƒ½å½±éŸ¿ ç¼ºä¹æ¼¸é€²æ€§ï¼šä¸è¦è©¦åœ–ä¸€æ¬¡æ€§é‡æ§‹æ•´å€‹ç³»çµ±ï¼Œè¦æ¡ç”¨æ¼¸é€²å¼æ”¹é€² SOLID åŸå‰‡ä¸åƒ…é©ç”¨æ–¼ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆï¼Œåœ¨å¾®æœå‹™æ¶æ§‹ã€å‡½æ•¸å¼ç¨‹å¼è¨­è¨ˆç­‰ç¾ä»£è»Ÿé«”æ¶æ§‹ä¸­åŒæ¨£å…·æœ‰æŒ‡å°æ„ç¾©ã€‚æŒæ¡é€™äº›åŸå‰‡å°‡é¡¯è‘—æå‡ä½ çš„è»Ÿé«”è¨­è¨ˆèƒ½åŠ›ã€‚\nåƒè€ƒè³‡æ–™ Clean Code by Robert C. Martin Agile Software Development, Principles, Patterns, and Practices SOLID Principles of Object Oriented Design Spring Framework Documentation ","permalink":"https://xinqilin.github.io/post/architecture/solid/","tags":["SOLID","Design Principles","OOP","Software Architecture","Clean Code","Best Practices"],"title":"SOLID è¨­è¨ˆåŸå‰‡å®Œæ•´æŒ‡å—ï¼šç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆçš„äº”å¤§æ ¸å¿ƒåŸå‰‡"},{"content":"ç­†è¨˜ Vue æœªæ•´ç† version å¥—ä»¶ vetur vue2 snippets webpack -\u0026gt; npm install webpack -g vue -\u0026gt; npm install -g @vue/cli-init chrome: vue plugin\nå¿«é€Ÿé–‹å§‹ vue init webpack \u0026lt;ä½ çš„appåå­—\u0026gt;\nnpm run dev\nmain.js -\u0026gt; è·¯ç”± index.js åœ¨ [router å…§]\n1 2 3 4 5 6 7 8 9 10 export default new Router({ routes:[ { path: \u0026#39;/\u0026#39;, name: \u0026#39;HelloWorld\u0026#39;, component: HelloWorld } ] }) HelloWorld.vue å…§å®¹ åœ¨ [componentså…§]\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; \u0026lt;script\u0026gt; export default { data(){ return name: \u0026#39;Bill\u0026#39; } } \u0026lt;/script\u0026gt; \u0026lt;style\u0026gt;\u0026lt;/style\u0026gt; è·³é \n1 2 3 4 5 6 \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;router-link to=\u0026#34;/HelloWorld\u0026#34;\u0026gt;go to hello world\u0026lt;/router-link\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; å–®å‘ç¶å®š 1 2 3 4 v-text v-html v-bind:href=\u0026#34;link\u0026#34; vue instance å…§çš„ method çš„ data:{link} (v-bind:href å¯ç¸®å¯«:href) é›™å‘ç¶å®š v-model\nç¶å®šäº‹ä»¶ 1 2 3 4 5 6 7 8 9 10 v-on:click=\u0026#34;num++\u0026#34; = @click v-on é˜²æ­¢äº‹ä»¶å†’æ³¡{ `.stop`: é˜»æ­¢äº‹ä»¶å†’æ³¡å€’çˆ¶å±¤ `.prevent`: é˜»æ­¢é»˜èª(é è¨­) äº‹ä»¶ç™¼ç”Ÿ `.capture`: é˜»æ­¢äº‹ä»¶æ•ç²æ¨¡å¼ `.self`: åªæœ‰è‡ªèº«è§¸ç™¼äº‹ä»¶æ‰åŸ·è¡Œ `.once`: åªåŸ·è¡Œä¸€æ¬¡ } æŒ‰éµä¿®é£¾ç¬¦ v-on:keyup.13 1 2 3 4 5 6 7 8 9 10 11 12 13 13 æ˜¯éµç¢¼ v-on æŒ‰éµä¿®é£¾ç¬¦ æ‡¶äººåŒ…{ `.enter` `.tab` `.delete` `.esc` `.space` `.up` `.down` `.left` `.right` } v-for 1 2 3 4 5 6 7 8 9 10 11 12 13 14 v-for = \u0026#34;user in users\u0026#34; æˆ– v-for=\u0026#34;(user, index) in users\u0026#34; v-for = \u0026#34;(value, key, index) in users\u0026#34; {{value}} {{key}} {{index}} v-for å¢åŠ  :key = \u0026#34;\u0026#34; å¯å¢åŠ æ•ˆç‡ æœ€ä¸»è¦æ˜¯æ˜¯åˆ¥æƒŸä¸€å€¼ :key æ˜¯ v-bindç¸®å¯« v-if è£¡é¢éƒ½å¡«boolean æ•´å€‹æ¨™ç±¤ä¸è¦‹ v-show è£¡é¢éƒ½å¡«boolean æ˜¯ç”¨ display:none å¸¸è·Ÿ v-if ä¸€èµ·ç”¨ v-else-if v-else 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // computed è¨ˆç®—å±¬æ€§ // watch ç›£æ§å±¬æ€§ // filter éæ¿¾å±¬æ€§ -\u0026gt; ä½¿ç”¨ {{user.gender | genderFilter}} new Vue({ el: \u0026#34;#app\u0026#34;, data:{ a:100, b:200 }, computed: { total: function(){ return this.a+this.b } }, watch:{ a: function(newValue, oldValue){ alert(\u0026#34;new: \u0026#34;+newValue+\u0026#34; , old: \u0026#34;+oldValue) if(a\u0026gt;3){ this.msg = \u0026#34;å¤ªå¤š\u0026#34; } } }, filters:{ genderFilter(val){ if(val == 1) return \u0026#34;male\u0026#34; else return \u0026#34;female\u0026#34; } } }) çµ„ä»¶:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 \u0026lt;script\u0026gt; Global çµ„ä»¶: Vue.component(\u0026#34;counter\u0026#34;,{ template: `\u0026lt;button v-on:click = \u0026#34;count++\u0026#34;\u0026gt; {{count}}\u0026lt;/button\u0026gt;` data(){ return { count: 0 } } }); å€åŸŸçµ„ä»¶: const buttonCounter = { template: `\u0026lt;button v-on:click = \u0026#34;count++\u0026#34;\u0026gt; {{count}}\u0026lt;/button\u0026gt;` data(){ return { count: 0 } } } å¾Œ æ”¾å…¥ vue instance components:{}ä¸­ components:{ \u0026#39;button-counter åå­—\u0026#39;: buttonCounter } ``` \u0026lt;button-counter\u0026gt;\u0026lt;/button-counter\u0026gt; ä½¿ç”¨ ``` \u0026lt;/script\u0026gt; lifeCycle 1 2 3 4 5 6 7 8 9 10 11 let app = new Vue(){ el: app, data: { }, beforeCreate: function(){ } // æ”¾ä¸€äº›ç”Ÿå‘½é€±æœŸçš„æ±è¥¿ }; ","permalink":"https://xinqilin.github.io/post/frontend/vue-intro/","tags":[],"title":"Vue Intro"},{"content":"æ¦‚è¿° JSON Web Token (JWT) æ˜¯ä¸€ç¨®é–‹æ”¾æ¨™æº– (RFC 7519)ï¼Œå®šç¾©äº†ä¸€ç¨®ç°¡æ½”ã€è‡ªåŒ…å«çš„æ–¹å¼ï¼Œç”¨æ–¼åœ¨å„æ–¹ä¹‹é–“å®‰å…¨åœ°å‚³è¼¸è³‡è¨Šã€‚JWT åœ¨ç¾ä»£ Web æ‡‰ç”¨ç¨‹å¼ä¸­å»£æ³›ç”¨æ–¼èº«ä»½é©—è­‰å’Œæˆæ¬Šï¼Œç‰¹åˆ¥é©åˆåˆ†æ•£å¼ç³»çµ±å’Œå¾®æœå‹™æ¶æ§‹ã€‚\nJWT æ ¸å¿ƒç‰¹å¾µ ç„¡ç‹€æ…‹æ€§ï¼šä¼ºæœå™¨ä¸éœ€è¦å„²å­˜ Session è³‡è¨Š å¯æ“´å±•æ€§ï¼šé©åˆåˆ†æ•£å¼å’Œå¾®æœå‹™ç’°å¢ƒ è·¨åŸŸæ”¯æ´ï¼šæ”¯æ´è·¨ç¶²åŸŸè«‹æ±‚ è‡ªåŒ…å«ï¼šToken åŒ…å«æ‰€æœ‰å¿…è¦çš„ä½¿ç”¨è€…è³‡è¨Š æ•¸ä½ç°½åï¼šç¢ºä¿ Token çš„å®Œæ•´æ€§å’ŒçœŸå¯¦æ€§ JWT çµæ§‹ JWT ç”±ä¸‰éƒ¨åˆ†çµ„æˆï¼Œä»¥é»è™Ÿï¼ˆ.ï¼‰åˆ†éš”ï¼š\n1 Header.Payload.Signature Headerï¼šåŒ…å« Token é¡å‹å’Œç°½åæ¼”ç®—æ³• Payloadï¼šåŒ…å«è²æ˜ï¼ˆClaimsï¼‰ï¼Œå³ä½¿ç”¨è€…è³‡è¨Šå’Œå…¶ä»–è³‡æ–™ Signatureï¼šç”¨æ–¼é©—è­‰ Token æ˜¯å¦è¢«ç¯¡æ”¹ Spring Boot æ•´åˆå¯¦ä½œ 1. ä¾è³´é…ç½® Maven ä¾è³´è¨­å®š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 \u0026lt;properties\u0026gt; \u0026lt;project.build.sourceEncoding\u0026gt;UTF-8\u0026lt;/project.build.sourceEncoding\u0026gt; \u0026lt;java.version\u0026gt;17\u0026lt;/java.version\u0026gt; \u0026lt;maven.compiler.source\u0026gt;17\u0026lt;/maven.compiler.source\u0026gt; \u0026lt;maven.compiler.target\u0026gt;17\u0026lt;/maven.compiler.target\u0026gt; \u0026lt;jjwt.version\u0026gt;0.12.3\u0026lt;/jjwt.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;!-- Spring Boot Starters --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-security\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-jpa\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-validation\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- JWT Library (æ¨è–¦ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬) --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.jsonwebtoken\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jjwt-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${jjwt.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.jsonwebtoken\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jjwt-impl\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${jjwt.version}\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.jsonwebtoken\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jjwt-jackson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${jjwt.version}\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; Gradle ä¾è³´è¨­å®š 1 2 3 4 5 6 7 8 9 10 dependencies { implementation \u0026#39;org.springframework.boot:spring-boot-starter-web\u0026#39; implementation \u0026#39;org.springframework.boot:spring-boot-starter-security\u0026#39; implementation \u0026#39;org.springframework.boot:spring-boot-starter-data-jpa\u0026#39; implementation \u0026#39;org.springframework.boot:spring-boot-starter-validation\u0026#39; implementation \u0026#39;io.jsonwebtoken:jjwt-api:0.12.3\u0026#39; runtimeOnly \u0026#39;io.jsonwebtoken:jjwt-impl:0.12.3\u0026#39; runtimeOnly \u0026#39;io.jsonwebtoken:jjwt-jackson:0.12.3\u0026#39; } 2. è³‡æ–™æ¨¡å‹ èªè­‰è«‹æ±‚ DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package com.example.jwt.dto; import jakarta.validation.constraints.NotBlank; import jakarta.validation.constraints.Size; public class AuthenticationRequest { @NotBlank(message = \u0026#34;ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º\u0026#34;) @Size(min = 3, max = 50, message = \u0026#34;ä½¿ç”¨è€…åç¨±é•·åº¦å¿…é ˆåœ¨3-50å­—ç¬¦ä¹‹é–“\u0026#34;) private String username; @NotBlank(message = \u0026#34;å¯†ç¢¼ä¸èƒ½ç‚ºç©º\u0026#34;) @Size(min = 6, max = 100, message = \u0026#34;å¯†ç¢¼é•·åº¦å¿…é ˆåœ¨6-100å­—ç¬¦ä¹‹é–“\u0026#34;) private String password; // å»ºæ§‹å­ public AuthenticationRequest() {} public AuthenticationRequest(String username, String password) { this.username = username; this.password = password; } // Getters and Setters public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getPassword() { return password; } public void setPassword(String password) { this.password = password; } } èªè­‰å›æ‡‰ DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package com.example.jwt.dto; import com.fasterxml.jackson.annotation.JsonProperty; public class AuthenticationResponse { @JsonProperty(\u0026#34;access_token\u0026#34;) private final String accessToken; @JsonProperty(\u0026#34;token_type\u0026#34;) private final String tokenType = \u0026#34;Bearer\u0026#34;; @JsonProperty(\u0026#34;expires_in\u0026#34;) private final long expiresIn; @JsonProperty(\u0026#34;refresh_token\u0026#34;) private String refreshToken; public AuthenticationResponse(String accessToken, long expiresIn) { this.accessToken = accessToken; this.expiresIn = expiresIn; } public AuthenticationResponse(String accessToken, long expiresIn, String refreshToken) { this.accessToken = accessToken; this.expiresIn = expiresIn; this.refreshToken = refreshToken; } // Getters public String getAccessToken() { return accessToken; } public String getTokenType() { return tokenType; } public long getExpiresIn() { return expiresIn; } public String getRefreshToken() { return refreshToken; } } ä½¿ç”¨è€…å¯¦é«” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 package com.example.jwt.entity; import jakarta.persistence.*; import jakarta.validation.constraints.Email; import jakarta.validation.constraints.NotBlank; import org.springframework.security.core.GrantedAuthority; import org.springframework.security.core.authority.SimpleGrantedAuthority; import org.springframework.security.core.userdetails.UserDetails; import java.time.LocalDateTime; import java.util.*; import java.util.stream.Collectors; @Entity @Table(name = \u0026#34;users\u0026#34;) public class User implements UserDetails { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @NotBlank @Column(unique = true, nullable = false) private String username; @NotBlank @Email @Column(unique = true, nullable = false) private String email; @NotBlank @Column(nullable = false) private String password; @Column(name = \u0026#34;first_name\u0026#34;) private String firstName; @Column(name = \u0026#34;last_name\u0026#34;) private String lastName; @Column(name = \u0026#34;enabled\u0026#34;) private boolean enabled = true; @Column(name = \u0026#34;account_non_expired\u0026#34;) private boolean accountNonExpired = true; @Column(name = \u0026#34;credentials_non_expired\u0026#34;) private boolean credentialsNonExpired = true; @Column(name = \u0026#34;account_non_locked\u0026#34;) private boolean accountNonLocked = true; @Column(name = \u0026#34;created_at\u0026#34;) private LocalDateTime createdAt = LocalDateTime.now(); @Column(name = \u0026#34;updated_at\u0026#34;) private LocalDateTime updatedAt = LocalDateTime.now(); @ElementCollection(targetClass = Role.class, fetch = FetchType.EAGER) @Enumerated(EnumType.STRING) @CollectionTable(name = \u0026#34;user_roles\u0026#34;) private Set\u0026lt;Role\u0026gt; roles = new HashSet\u0026lt;\u0026gt;(); // å»ºæ§‹å­ public User() {} public User(String username, String email, String password) { this.username = username; this.email = email; this.password = password; this.roles.add(Role.USER); } // UserDetails interface å¯¦ä½œ @Override public Collection\u0026lt;? extends GrantedAuthority\u0026gt; getAuthorities() { return roles.stream() .map(role -\u0026gt; new SimpleGrantedAuthority(\u0026#34;ROLE_\u0026#34; + role.name())) .collect(Collectors.toList()); } @Override public String getPassword() { return password; } @Override public String getUsername() { return username; } @Override public boolean isAccountNonExpired() { return accountNonExpired; } @Override public boolean isAccountNonLocked() { return accountNonLocked; } @Override public boolean isCredentialsNonExpired() { return credentialsNonExpired; } @Override public boolean isEnabled() { return enabled; } // Getters and Setters public Long getId() { return id; } public void setId(Long id) { this.id = id; } public void setUsername(String username) { this.username = username; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public void setPassword(String password) { this.password = password; } public String getFirstName() { return firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getLastName() { return lastName; } public void setLastName(String lastName) { this.lastName = lastName; } public Set\u0026lt;Role\u0026gt; getRoles() { return roles; } public void setRoles(Set\u0026lt;Role\u0026gt; roles) { this.roles = roles; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } @PreUpdate public void preUpdate() { this.updatedAt = LocalDateTime.now(); } } enum Role { USER, ADMIN, MODERATOR } 3. JWT å·¥å…·é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 package com.example.jwt.util; import io.jsonwebtoken.*; import io.jsonwebtoken.io.Decoders; import io.jsonwebtoken.security.Keys; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Value; import org.springframework.security.core.userdetails.UserDetails; import org.springframework.stereotype.Component; import javax.crypto.SecretKey; import java.util.Date; import java.util.HashMap; import java.util.Map; import java.util.function.Function; @Component public class JwtUtil { private static final Logger logger = LoggerFactory.getLogger(JwtUtil.class); @Value(\u0026#34;${jwt.secret}\u0026#34;) private String jwtSecret; @Value(\u0026#34;${jwt.expiration}\u0026#34;) private long jwtExpiration; @Value(\u0026#34;${jwt.refresh-expiration}\u0026#34;) private long refreshExpiration; /** * å¾ Token ä¸­æå–ä½¿ç”¨è€…åç¨± */ public String extractUsername(String token) { return extractClaim(token, Claims::getSubject); } /** * å¾ Token ä¸­æå–éæœŸæ™‚é–“ */ public Date extractExpiration(String token) { return extractClaim(token, Claims::getExpiration); } /** * å¾ Token ä¸­æå–ç‰¹å®šçš„è²æ˜ */ public \u0026lt;T\u0026gt; T extractClaim(String token, Function\u0026lt;Claims, T\u0026gt; claimsResolver) { final Claims claims = extractAllClaims(token); return claimsResolver.apply(claims); } /** * æå– Token ä¸­çš„æ‰€æœ‰è²æ˜ */ private Claims extractAllClaims(String token) { try { return Jwts.parser() .verifyWith(getSignInKey()) .build() .parseSignedClaims(token) .getPayload(); } catch (ExpiredJwtException e) { logger.warn(\u0026#34;JWT token å·²éæœŸ: {}\u0026#34;, e.getMessage()); throw e; } catch (UnsupportedJwtException e) { logger.warn(\u0026#34;ä¸æ”¯æ´çš„ JWT token: {}\u0026#34;, e.getMessage()); throw e; } catch (MalformedJwtException e) { logger.warn(\u0026#34;æ ¼å¼éŒ¯èª¤çš„ JWT token: {}\u0026#34;, e.getMessage()); throw e; } catch (IllegalArgumentException e) { logger.warn(\u0026#34;JWT claims string ç‚ºç©º: {}\u0026#34;, e.getMessage()); throw e; } } /** * æª¢æŸ¥ Token æ˜¯å¦éæœŸ */ public boolean isTokenExpired(String token) { try { return extractExpiration(token).before(new Date()); } catch (ExpiredJwtException e) { return true; } } /** * ç”Ÿæˆè¨ªå• Token */ public String generateAccessToken(UserDetails userDetails) { Map\u0026lt;String, Object\u0026gt; claims = new HashMap\u0026lt;\u0026gt;(); claims.put(\u0026#34;roles\u0026#34;, userDetails.getAuthorities()); return createToken(claims, userDetails.getUsername(), jwtExpiration); } /** * ç”Ÿæˆåˆ·æ–° Token */ public String generateRefreshToken(UserDetails userDetails) { return createToken(new HashMap\u0026lt;\u0026gt;(), userDetails.getUsername(), refreshExpiration); } /** * å‰µå»º Token */ private String createToken(Map\u0026lt;String, Object\u0026gt; claims, String subject, long expiration) { Date now = new Date(); Date expiryDate = new Date(now.getTime() + expiration); return Jwts.builder() .claims(claims) .subject(subject) .issuedAt(now) .expiration(expiryDate) .signWith(getSignInKey()) .compact(); } /** * é©—è­‰ Token */ public boolean validateToken(String token, UserDetails userDetails) { try { final String username = extractUsername(token); return (username.equals(userDetails.getUsername()) \u0026amp;\u0026amp; !isTokenExpired(token)); } catch (JwtException | IllegalArgumentException e) { logger.warn(\u0026#34;JWT token é©—è­‰å¤±æ•—: {}\u0026#34;, e.getMessage()); return false; } } /** * é©—è­‰ Token æ ¼å¼å’Œç°½å */ public boolean validateToken(String token) { try { Jwts.parser() .verifyWith(getSignInKey()) .build() .parseSignedClaims(token); return true; } catch (JwtException | IllegalArgumentException e) { logger.warn(\u0026#34;JWT token é©—è­‰å¤±æ•—: {}\u0026#34;, e.getMessage()); return false; } } /** * ç²å–ç°½åé‡‘é‘° */ private SecretKey getSignInKey() { byte[] keyBytes = Decoders.BASE64.decode(jwtSecret); return Keys.hmacShaKeyFor(keyBytes); } /** * ç²å– Token çš„å‰©é¤˜æœ‰æ•ˆæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ */ public long getExpirationTime() { return jwtExpiration; } /** * æª¢æŸ¥ Token æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆå‰©é¤˜æ™‚é–“å°‘æ–¼ 30 åˆ†é˜ï¼‰ */ public boolean shouldRefreshToken(String token) { try { Date expiration = extractExpiration(token); Date now = new Date(); long timeLeft = expiration.getTime() - now.getTime(); return timeLeft \u0026lt; (30 * 60 * 1000); // 30 åˆ†é˜ } catch (Exception e) { return false; } } } 4. JWT è«‹æ±‚éæ¿¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 package com.example.jwt.filter; import com.example.jwt.service.CustomUserDetailsService; import com.example.jwt.util.JwtUtil; import jakarta.servlet.FilterChain; import jakarta.servlet.ServletException; import jakarta.servlet.http.HttpServletRequest; import jakarta.servlet.http.HttpServletResponse; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.authentication.UsernamePasswordAuthenticationToken; import org.springframework.security.core.context.SecurityContextHolder; import org.springframework.security.core.userdetails.UserDetails; import org.springframework.security.web.authentication.WebAuthenticationDetailsSource; import org.springframework.stereotype.Component; import org.springframework.util.StringUtils; import org.springframework.web.filter.OncePerRequestFilter; import java.io.IOException; @Component public class JwtAuthenticationFilter extends OncePerRequestFilter { private static final Logger logger = LoggerFactory.getLogger(JwtAuthenticationFilter.class); private static final String BEARER_PREFIX = \u0026#34;Bearer \u0026#34;; private static final String AUTHORIZATION_HEADER = \u0026#34;Authorization\u0026#34;; @Autowired private JwtUtil jwtUtil; @Autowired private CustomUserDetailsService userDetailsService; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException { try { String jwt = getJwtFromRequest(request); if (StringUtils.hasText(jwt) \u0026amp;\u0026amp; jwtUtil.validateToken(jwt)) { String username = jwtUtil.extractUsername(jwt); // æª¢æŸ¥ SecurityContext ä¸­æ˜¯å¦å·²æœ‰èªè­‰è³‡è¨Š if (username != null \u0026amp;\u0026amp; SecurityContextHolder.getContext().getAuthentication() == null) { UserDetails userDetails = userDetailsService.loadUserByUsername(username); if (jwtUtil.validateToken(jwt, userDetails)) { UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken( userDetails, null, userDetails.getAuthorities()); authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request)); SecurityContextHolder.getContext().setAuthentication(authentication); logger.debug(\u0026#34;è¨­å®šä½¿ç”¨è€… \u0026#39;{}\u0026#39; çš„å®‰å…¨ä¸Šä¸‹æ–‡\u0026#34;, username); } } } } catch (Exception e) { logger.error(\u0026#34;ç„¡æ³•è¨­å®šä½¿ç”¨è€…èªè­‰: {}\u0026#34;, e.getMessage()); } filterChain.doFilter(request, response); } /** * å¾è«‹æ±‚ä¸­æå– JWT Token */ private String getJwtFromRequest(HttpServletRequest request) { String bearerToken = request.getHeader(AUTHORIZATION_HEADER); if (StringUtils.hasText(bearerToken) \u0026amp;\u0026amp; bearerToken.startsWith(BEARER_PREFIX)) { return bearerToken.substring(BEARER_PREFIX.length()); } return null; } @Override protected boolean shouldNotFilter(HttpServletRequest request) throws ServletException { String path = request.getRequestURI(); // æ’é™¤ä¸éœ€è¦ JWT é©—è­‰çš„è·¯å¾‘ return path.startsWith(\u0026#34;/api/auth/\u0026#34;) || path.startsWith(\u0026#34;/swagger-ui/\u0026#34;) || path.startsWith(\u0026#34;/v3/api-docs/\u0026#34;) || path.equals(\u0026#34;/health\u0026#34;) || path.equals(\u0026#34;/favicon.ico\u0026#34;); } } 5. Spring Security é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 package com.example.jwt.config; import com.example.jwt.filter.JwtAuthenticationFilter; import com.example.jwt.service.CustomUserDetailsService; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.security.authentication.AuthenticationManager; import org.springframework.security.authentication.AuthenticationProvider; import org.springframework.security.authentication.dao.DaoAuthenticationProvider; import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration; import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer; import org.springframework.security.config.http.SessionCreationPolicy; import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder; import org.springframework.security.crypto.password.PasswordEncoder; import org.springframework.security.web.SecurityFilterChain; import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter; import org.springframework.web.cors.CorsConfiguration; import org.springframework.web.cors.CorsConfigurationSource; import org.springframework.web.cors.UrlBasedCorsConfigurationSource; import java.util.Arrays; @Configuration @EnableWebSecurity @EnableMethodSecurity(prePostEnabled = true) public class SecurityConfig { @Autowired private CustomUserDetailsService userDetailsService; @Autowired private JwtAuthenticationFilter jwtAuthenticationFilter; @Autowired private JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint; @Bean public PasswordEncoder passwordEncoder() { return new BCryptPasswordEncoder(12); } @Bean public AuthenticationProvider authenticationProvider() { DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider(); authProvider.setUserDetailsService(userDetailsService); authProvider.setPasswordEncoder(passwordEncoder()); return authProvider; } @Bean public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception { return config.getAuthenticationManager(); } @Bean public SecurityFilterChain filterChain(HttpSecurity http) throws Exception { http .csrf(AbstractHttpConfigurer::disable) .cors(cors -\u0026gt; cors.configurationSource(corsConfigurationSource())) .sessionManagement(session -\u0026gt; session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)) .authorizeHttpRequests(authz -\u0026gt; authz // å…¬é–‹ç«¯é» .requestMatchers( \u0026#34;/api/auth/**\u0026#34;, \u0026#34;/swagger-ui/**\u0026#34;, \u0026#34;/v3/api-docs/**\u0026#34;, \u0026#34;/health\u0026#34;, \u0026#34;/favicon.ico\u0026#34; ).permitAll() // ç®¡ç†å“¡ç«¯é» .requestMatchers(\u0026#34;/api/admin/**\u0026#34;).hasRole(\u0026#34;ADMIN\u0026#34;) // å…¶ä»–ç«¯é»éœ€è¦èªè­‰ .anyRequest().authenticated() ) .exceptionHandling(ex -\u0026gt; ex.authenticationEntryPoint(jwtAuthenticationEntryPoint)) .authenticationProvider(authenticationProvider()) .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class); return http.build(); } @Bean public CorsConfigurationSource corsConfigurationSource() { CorsConfiguration configuration = new CorsConfiguration(); configuration.setAllowedOriginPatterns(Arrays.asList(\u0026#34;*\u0026#34;)); configuration.setAllowedMethods(Arrays.asList(\u0026#34;GET\u0026#34;, \u0026#34;POST\u0026#34;, \u0026#34;PUT\u0026#34;, \u0026#34;DELETE\u0026#34;, \u0026#34;OPTIONS\u0026#34;)); configuration.setAllowedHeaders(Arrays.asList(\u0026#34;*\u0026#34;)); configuration.setAllowCredentials(true); UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource(); source.registerCorsConfiguration(\u0026#34;/**\u0026#34;, configuration); return source; } } 6. èªè­‰æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 package com.example.jwt.controller; import com.example.jwt.dto.AuthenticationRequest; import com.example.jwt.dto.AuthenticationResponse; import com.example.jwt.service.AuthenticationService; import jakarta.validation.Valid; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.web.bind.annotation.*; @RestController @RequestMapping(\u0026#34;/api/auth\u0026#34;) @CrossOrigin(origins = \u0026#34;*\u0026#34;, maxAge = 3600) public class AuthController { @Autowired private AuthenticationService authenticationService; /** * ä½¿ç”¨è€…ç™»å…¥ */ @PostMapping(\u0026#34;/login\u0026#34;) public ResponseEntity\u0026lt;AuthenticationResponse\u0026gt; login( @Valid @RequestBody AuthenticationRequest request) { AuthenticationResponse response = authenticationService.authenticate(request); return ResponseEntity.ok(response); } /** * åˆ·æ–° Token */ @PostMapping(\u0026#34;/refresh\u0026#34;) public ResponseEntity\u0026lt;AuthenticationResponse\u0026gt; refreshToken( @RequestHeader(\u0026#34;Authorization\u0026#34;) String refreshToken) { AuthenticationResponse response = authenticationService.refreshToken(refreshToken); return ResponseEntity.ok(response); } /** * ç™»å‡ºï¼ˆå¯é¸ï¼šåŠ å…¥é»‘åå–®æ©Ÿåˆ¶ï¼‰ */ @PostMapping(\u0026#34;/logout\u0026#34;) public ResponseEntity\u0026lt;Void\u0026gt; logout(@RequestHeader(\u0026#34;Authorization\u0026#34;) String token) { authenticationService.logout(token); return ResponseEntity.ok().build(); } /** * é©—è­‰ Token æœ‰æ•ˆæ€§ */ @GetMapping(\u0026#34;/validate\u0026#34;) public ResponseEntity\u0026lt;Boolean\u0026gt; validateToken(@RequestHeader(\u0026#34;Authorization\u0026#34;) String token) { boolean isValid = authenticationService.validateToken(token); return ResponseEntity.ok(isValid); } } 7. èªè­‰æœå‹™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 package com.example.jwt.service; import com.example.jwt.dto.AuthenticationRequest; import com.example.jwt.dto.AuthenticationResponse; import com.example.jwt.util.JwtUtil; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.security.authentication.AuthenticationManager; import org.springframework.security.authentication.BadCredentialsException; import org.springframework.security.authentication.UsernamePasswordAuthenticationToken; import org.springframework.security.core.Authentication; import org.springframework.security.core.userdetails.UserDetails; import org.springframework.stereotype.Service; @Service public class AuthenticationService { @Autowired private AuthenticationManager authenticationManager; @Autowired private CustomUserDetailsService userDetailsService; @Autowired private JwtUtil jwtUtil; @Autowired private TokenBlacklistService tokenBlacklistService; /** * èªè­‰ä½¿ç”¨è€…ä¸¦ç”Ÿæˆ Token */ public AuthenticationResponse authenticate(AuthenticationRequest request) { try { // é©—è­‰ä½¿ç”¨è€…æ†‘è­‰ Authentication authentication = authenticationManager.authenticate( new UsernamePasswordAuthenticationToken( request.getUsername(), request.getPassword() ) ); // è¼‰å…¥ä½¿ç”¨è€…è©³ç´°è³‡è¨Š UserDetails userDetails = userDetailsService.loadUserByUsername(request.getUsername()); // ç”Ÿæˆ Token String accessToken = jwtUtil.generateAccessToken(userDetails); String refreshToken = jwtUtil.generateRefreshToken(userDetails); return new AuthenticationResponse( accessToken, jwtUtil.getExpirationTime(), refreshToken ); } catch (BadCredentialsException e) { throw new BadCredentialsException(\u0026#34;ä½¿ç”¨è€…åç¨±æˆ–å¯†ç¢¼éŒ¯èª¤\u0026#34;); } } /** * åˆ·æ–° Token */ public AuthenticationResponse refreshToken(String refreshToken) { // ç§»é™¤ Bearer å‰ç¶´ String token = refreshToken.startsWith(\u0026#34;Bearer \u0026#34;) ? refreshToken.substring(7) : refreshToken; if (!jwtUtil.validateToken(token)) { throw new RuntimeException(\u0026#34;ç„¡æ•ˆçš„åˆ·æ–° Token\u0026#34;); } String username = jwtUtil.extractUsername(token); UserDetails userDetails = userDetailsService.loadUserByUsername(username); String newAccessToken = jwtUtil.generateAccessToken(userDetails); return new AuthenticationResponse(newAccessToken, jwtUtil.getExpirationTime()); } /** * ç™»å‡ºä¸¦å°‡ Token åŠ å…¥é»‘åå–® */ public void logout(String token) { String jwtToken = token.startsWith(\u0026#34;Bearer \u0026#34;) ? token.substring(7) : token; tokenBlacklistService.blacklistToken(jwtToken); } /** * é©—è­‰ Token */ public boolean validateToken(String token) { String jwtToken = token.startsWith(\u0026#34;Bearer \u0026#34;) ? token.substring(7) : token; return jwtUtil.validateToken(jwtToken) \u0026amp;\u0026amp; !tokenBlacklistService.isTokenBlacklisted(jwtToken); } } é…ç½®æª”æ¡ˆ application.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # JWT é…ç½® jwt: # ä½¿ç”¨å¼·å¯†é‘°ï¼ˆè‡³å°‘256ä½ï¼‰ secret: ${JWT_SECRET:dGhpc2lzYXZlcnlzZWN1cmVzZWNyZXRrZXl0aGF0aXNhdGxlYXN0MjU2Yml0c2xvbmc=} # Access Token éæœŸæ™‚é–“ï¼ˆ15åˆ†é˜ï¼‰ expiration: 900000 # Refresh Token éæœŸæ™‚é–“ï¼ˆ7å¤©ï¼‰ refresh-expiration: 604800000 # Spring Security é…ç½® spring: security: # OAuth2 é…ç½®ï¼ˆå¯é¸ï¼‰ oauth2: client: registration: google: client-id: ${GOOGLE_CLIENT_ID:} client-secret: ${GOOGLE_CLIENT_SECRET:} scope: openid,profile,email # æ—¥èªŒé…ç½® logging: level: com.example.jwt: DEBUG org.springframework.security: DEBUG å®‰å…¨æ€§æœ€ä½³å¯¦è¸ 1. å¯†é‘°ç®¡ç† 1 2 3 4 5 6 7 8 // ç”Ÿæˆå®‰å…¨çš„å¯†é‘° public class KeyGenerator { public static void main(String[] args) { SecretKey key = Keys.secretKeyFor(SignatureAlgorithm.HS256); String encodedKey = Encoders.BASE64.encode(key.getEncoded()); System.out.println(\u0026#34;Generated key: \u0026#34; + encodedKey); } } 2. Token é»‘åå–®æœå‹™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package com.example.jwt.service; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.stereotype.Service; import java.util.concurrent.TimeUnit; @Service public class TokenBlacklistService { @Autowired private RedisTemplate\u0026lt;String, String\u0026gt; redisTemplate; private static final String BLACKLIST_PREFIX = \u0026#34;jwt:blacklist:\u0026#34;; /** * å°‡ Token åŠ å…¥é»‘åå–® */ public void blacklistToken(String token) { String key = BLACKLIST_PREFIX + token; // è¨­å®šéæœŸæ™‚é–“ç­‰æ–¼ Token çš„å‰©é¤˜æœ‰æ•ˆæ™‚é–“ redisTemplate.opsForValue().set(key, \u0026#34;blacklisted\u0026#34;, 24, TimeUnit.HOURS); } /** * æª¢æŸ¥ Token æ˜¯å¦åœ¨é»‘åå–®ä¸­ */ public boolean isTokenBlacklisted(String token) { String key = BLACKLIST_PREFIX + token; return Boolean.TRUE.equals(redisTemplate.hasKey(key)); } } 3. ç•°å¸¸è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package com.example.jwt.exception; import org.springframework.http.HttpStatus; import org.springframework.http.ResponseEntity; import org.springframework.security.authentication.BadCredentialsException; import org.springframework.web.bind.annotation.ExceptionHandler; import org.springframework.web.bind.annotation.RestControllerAdvice; @RestControllerAdvice public class GlobalExceptionHandler { @ExceptionHandler(BadCredentialsException.class) public ResponseEntity\u0026lt;ErrorResponse\u0026gt; handleBadCredentials(BadCredentialsException e) { ErrorResponse error = new ErrorResponse( HttpStatus.UNAUTHORIZED.value(), \u0026#34;èªè­‰å¤±æ•—\u0026#34;, e.getMessage() ); return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(error); } @ExceptionHandler(JwtException.class) public ResponseEntity\u0026lt;ErrorResponse\u0026gt; handleJwtException(JwtException e) { ErrorResponse error = new ErrorResponse( HttpStatus.UNAUTHORIZED.value(), \u0026#34;Token éŒ¯èª¤\u0026#34;, e.getMessage() ); return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(error); } } class ErrorResponse { private int status; private String error; private String message; private long timestamp; public ErrorResponse(int status, String error, String message) { this.status = status; this.error = error; this.message = message; this.timestamp = System.currentTimeMillis(); } // Getters and Setters // ... } ä½¿ç”¨ç¯„ä¾‹ 1. å‰ç«¯æ•´åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 // JavaScript å‰ç«¯ç¯„ä¾‹ class AuthService { constructor() { this.baseURL = \u0026#39;http://localhost:8080/api\u0026#39;; this.token = localStorage.getItem(\u0026#39;accessToken\u0026#39;); } async login(username, password) { try { const response = await fetch(`${this.baseURL}/auth/login`, { method: \u0026#39;POST\u0026#39;, headers: { \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;, }, body: JSON.stringify({ username, password }) }); if (response.ok) { const data = await response.json(); this.token = data.access_token; localStorage.setItem(\u0026#39;accessToken\u0026#39;, this.token); localStorage.setItem(\u0026#39;refreshToken\u0026#39;, data.refresh_token); return data; } else { throw new Error(\u0026#39;ç™»å…¥å¤±æ•—\u0026#39;); } } catch (error) { console.error(\u0026#39;ç™»å…¥éŒ¯èª¤:\u0026#39;, error); throw error; } } async apiCall(endpoint, options = {}) { const config = { ...options, headers: { \u0026#39;Authorization\u0026#39;: `Bearer ${this.token}`, \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39;, ...options.headers } }; let response = await fetch(`${this.baseURL}${endpoint}`, config); // å¦‚æœ Token éæœŸï¼Œå˜—è©¦åˆ·æ–° if (response.status === 401) { await this.refreshToken(); config.headers[\u0026#39;Authorization\u0026#39;] = `Bearer ${this.token}`; response = await fetch(`${this.baseURL}${endpoint}`, config); } return response; } async refreshToken() { const refreshToken = localStorage.getItem(\u0026#39;refreshToken\u0026#39;); if (!refreshToken) { this.logout(); return; } try { const response = await fetch(`${this.baseURL}/auth/refresh`, { method: \u0026#39;POST\u0026#39;, headers: { \u0026#39;Authorization\u0026#39;: `Bearer ${refreshToken}` } }); if (response.ok) { const data = await response.json(); this.token = data.access_token; localStorage.setItem(\u0026#39;accessToken\u0026#39;, this.token); } else { this.logout(); } } catch (error) { console.error(\u0026#39;Token åˆ·æ–°å¤±æ•—:\u0026#39;, error); this.logout(); } } logout() { localStorage.removeItem(\u0026#39;accessToken\u0026#39;); localStorage.removeItem(\u0026#39;refreshToken\u0026#39;); this.token = null; window.location.href = \u0026#39;/login\u0026#39;; } } 2. æ¸¬è©¦ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package com.example.jwt; import com.example.jwt.util.JwtUtil; import org.junit.jupiter.api.Test; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.security.core.userdetails.User; import org.springframework.security.core.userdetails.UserDetails; import java.util.ArrayList; import static org.junit.jupiter.api.Assertions.*; @SpringBootTest public class JwtUtilTest { @Autowired private JwtUtil jwtUtil; @Test public void testGenerateAndValidateToken() { // å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€… UserDetails userDetails = new User(\u0026#34;testuser\u0026#34;, \u0026#34;password\u0026#34;, new ArrayList\u0026lt;\u0026gt;()); // ç”Ÿæˆ Token String token = jwtUtil.generateAccessToken(userDetails); assertNotNull(token); // é©—è­‰ Token assertTrue(jwtUtil.validateToken(token, userDetails)); // æå–ä½¿ç”¨è€…åç¨± String extractedUsername = jwtUtil.extractUsername(token); assertEquals(\u0026#34;testuser\u0026#34;, extractedUsername); // æª¢æŸ¥ Token æ˜¯å¦æœªéæœŸ assertFalse(jwtUtil.isTokenExpired(token)); } } æ•ˆèƒ½æœ€ä½³åŒ– 1. Redis å¿«å– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @Configuration @EnableCaching public class CacheConfig { @Bean public CacheManager cacheManager(RedisConnectionFactory connectionFactory) { RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig() .entryTtl(Duration.ofMinutes(15)) .serializeKeysWith(RedisSerializationContext.SerializationPair .fromSerializer(new StringRedisSerializer())) .serializeValuesWith(RedisSerializationContext.SerializationPair .fromSerializer(new GenericJackson2JsonRedisSerializer())); return RedisCacheManager.builder(connectionFactory) .cacheDefaults(config) .build(); } } 2. éåŒæ­¥è™•ç† 1 2 3 4 5 6 7 8 9 10 11 @Service public class AsyncAuthService { @Async @EventListener public void handleUserLogin(UserLoginEvent event) { // è¨˜éŒ„ç™»å…¥æ—¥èªŒ // ç™¼é€é€šçŸ¥ // æ›´æ–°ä½¿ç”¨è€…çµ±è¨ˆ } } ç›£æ§å’Œæ—¥èªŒ 1. èªè­‰ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @Component public class AuthenticationEventListener { private static final Logger logger = LoggerFactory.getLogger(AuthenticationEventListener.class); @EventListener public void onAuthenticationSuccess(AuthenticationSuccessEvent event) { String username = event.getAuthentication().getName(); logger.info(\u0026#34;ä½¿ç”¨è€… {} ç™»å…¥æˆåŠŸ\u0026#34;, username); } @EventListener public void onAuthenticationFailure(AbstractAuthenticationFailureEvent event) { String username = event.getAuthentication().getName(); logger.warn(\u0026#34;ä½¿ç”¨è€… {} ç™»å…¥å¤±æ•—: {}\u0026#34;, username, event.getException().getMessage()); } } 2. æ•ˆèƒ½ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Aspect @Component public class JwtPerformanceAspect { private static final Logger logger = LoggerFactory.getLogger(JwtPerformanceAspect.class); @Around(\u0026#34;execution(* com.example.jwt.util.JwtUtil.*(..))\u0026#34;) public Object measureExecutionTime(ProceedingJoinPoint joinPoint) throws Throwable { long startTime = System.currentTimeMillis(); Object result = joinPoint.proceed(); long endTime = System.currentTimeMillis(); logger.debug(\u0026#34;æ–¹æ³• {} åŸ·è¡Œæ™‚é–“: {} ms\u0026#34;, joinPoint.getSignature().getName(), endTime - startTime); return result; } } å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ 1. Token éæœŸè™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // è‡ªå‹• Token åˆ·æ–°æ””æˆªå™¨ @Component public class TokenRefreshInterceptor implements HandlerInterceptor { @Autowired private JwtUtil jwtUtil; @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { String token = getTokenFromRequest(request); if (token != null \u0026amp;\u0026amp; jwtUtil.shouldRefreshToken(token)) { // è¨­å®šå›æ‡‰æ¨™é ­æç¤ºå‰ç«¯åˆ·æ–° Token response.setHeader(\u0026#34;X-Token-Refresh-Required\u0026#34;, \u0026#34;true\u0026#34;); } return true; } } 2. è·¨åŸŸè™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 @Configuration public class CorsConfig implements WebMvcConfigurer { @Override public void addCorsMappings(CorsRegistry registry) { registry.addMapping(\u0026#34;/api/**\u0026#34;) .allowedOriginPatterns(\u0026#34;*\u0026#34;) .allowedMethods(\u0026#34;GET\u0026#34;, \u0026#34;POST\u0026#34;, \u0026#34;PUT\u0026#34;, \u0026#34;DELETE\u0026#34;, \u0026#34;OPTIONS\u0026#34;) .allowedHeaders(\u0026#34;*\u0026#34;) .allowCredentials(true) .maxAge(3600); } } ç¸½çµ æ ¸å¿ƒå„ªå‹¢ ç„¡ç‹€æ…‹æ€§ï¼šä¼ºæœå™¨ç„¡éœ€å­˜å„² Sessionï¼Œé©åˆåˆ†æ•£å¼ç³»çµ± å¯æ“´å±•æ€§ï¼šæ”¯æ´å¾®æœå‹™æ¶æ§‹å’Œè² è¼‰å‡è¡¡ è·¨åŸŸæ”¯æ´ï¼šè§£æ±ºå‚³çµ± Session çš„è·¨åŸŸå•é¡Œ å®‰å…¨æ€§ï¼šæ•¸ä½ç°½åç¢ºä¿ Token å®Œæ•´æ€§ éˆæ´»æ€§ï¼šå¯æ”œå¸¶è‡ªè¨‚ä½¿ç”¨è€…è³‡è¨Š æœ€ä½³å¯¦è¸ ä½¿ç”¨å¼·å¯†é‘°ï¼šè‡³å°‘ 256 ä½çš„éš¨æ©Ÿå¯†é‘° é©ç•¶çš„éæœŸæ™‚é–“ï¼šçŸ­æœŸ Access Token + é•·æœŸ Refresh Token Token é»‘åå–®ï¼šæ”¯æ´ç™»å‡ºå’Œç·Šæ€¥æ’¤éŠ· HTTPS å‚³è¼¸ï¼šç¢ºä¿ Token å‚³è¼¸å®‰å…¨ è¼¸å…¥é©—è­‰ï¼šé©—è­‰æ‰€æœ‰ä½¿ç”¨è€…è¼¸å…¥ éŒ¯èª¤è™•ç†ï¼šå„ªé›…è™•ç†èªè­‰éŒ¯èª¤ ç›£æ§æ—¥èªŒï¼šè¨˜éŒ„èªè­‰äº‹ä»¶å’Œç•°å¸¸ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # ç”Ÿæˆå¯†é‘° openssl rand -base64 32 # è§£æ JWT Token echo \u0026#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...\u0026#34; | cut -d. -f2 | base64 -d # æ¸¬è©¦ API curl -X POST http://localhost:8080/api/auth/login \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;password\u0026#34;}\u0026#39; # ä½¿ç”¨ Token è¨ªå• API curl -X GET http://localhost:8080/api/users \\ -H \u0026#34;Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...\u0026#34; JWT æ˜¯ç¾ä»£ Web æ‡‰ç”¨ç¨‹å¼èªè­‰çš„æ¨™æº–è§£æ±ºæ–¹æ¡ˆï¼Œæ­£ç¢ºå¯¦ä½œèƒ½å¤ æä¾›å®‰å…¨ã€å¯æ“´å±•çš„èªè­‰æ©Ÿåˆ¶ã€‚è¨˜ä½ï¼šå®‰å…¨æ€§è¨­è¨ˆæ‡‰è©²å¾ä¸€é–‹å§‹å°±è€ƒæ…®ï¼Œè€Œä¸æ˜¯å¾ŒçºŒæ·»åŠ çš„åŠŸèƒ½ã€‚\nåƒè€ƒè³‡æ–™ JWT Official Website RFC 7519 - JSON Web Token Spring Security Documentation JJWT Library OWASP JWT Security Guide ","permalink":"https://xinqilin.github.io/post/backend/jwt/","tags":["JWT","Spring Security","Authentication","Java","Spring Boot","Security","REST API","Token"],"title":"JWT èªè­‰æ©Ÿåˆ¶å®Œæ•´å¯¦ä½œï¼šSpring Security æ•´åˆèˆ‡æœ€ä½³å¯¦è¸"},{"content":"æ¦‚è¿° Swaggerï¼ˆç¾ç¨±ç‚º OpenAPIï¼‰æ˜¯ç›®å‰æœ€æµè¡Œçš„ REST API æ–‡æª”åŒ–å·¥å…·ä¹‹ä¸€ã€‚å®ƒä¸åƒ…èƒ½è‡ªå‹•ç”Ÿæˆç¾è§€çš„ API æ–‡æª”ï¼Œé‚„æä¾›äº’å‹•å¼æ¸¬è©¦ä»‹é¢ï¼Œæ”¯æ´å¤šç¨®ç¨‹å¼èªè¨€çš„å®¢æˆ¶ç«¯ç¨‹å¼ç¢¼ç”Ÿæˆã€‚æœ¬æ–‡å°‡å…¨é¢ä»‹ç´¹å¦‚ä½•åœ¨ Spring Boot å°ˆæ¡ˆä¸­æ•´åˆå’Œä½¿ç”¨ Swaggerï¼Œå¾åŸºç¤é…ç½®åˆ°é€²éšåŠŸèƒ½çš„å®Œæ•´å¯¦æˆ°æŒ‡å—ã€‚\nç‰ˆæœ¬é¸æ“‡èˆ‡ä¾è³´é…ç½® OpenAPI 3.0 vs Swagger 2.0 ç‰¹æ€§ Swagger 2.0 OpenAPI 3.0 è¦ç¯„ç‰ˆæœ¬ è¼ƒèˆŠ æœ€æ–°æ¨™æº– Spring Boot æ”¯æ´ è‰¯å¥½ åŸç”Ÿæ”¯æ´ åŠŸèƒ½è±å¯Œåº¦ åŸºæœ¬åŠŸèƒ½ è±å¯Œç‰¹æ€§ ç¤¾ç¾¤æ´»èºåº¦ ç¶­è­·æ¨¡å¼ ç©æ¥µé–‹ç™¼ æ¨è–¦åº¦ åƒ…é™èˆŠå°ˆæ¡ˆ å¼·çƒˆæ¨è–¦ ç¾ä»£åŒ–ä¾è³´é…ç½®ï¼ˆOpenAPI 3.0ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;!-- æ¨è–¦ï¼šSpringDoc OpenAPI 3 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springdoc\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;springdoc-openapi-starter-webmvc-ui\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- å®‰å…¨æ•´åˆ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springdoc\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;springdoc-openapi-security\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- WebFlux æ”¯æ´ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springdoc\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;springdoc-openapi-starter-webflux-ui\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å‚³çµ± Swagger 2.0 é…ç½®ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 \u0026lt;!-- å‚³çµ±ï¼šSpringfox Swagger 2 --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.springfox\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;springfox-swagger2\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.springfox\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;springfox-swagger-ui\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.springfox\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;springfox-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; OpenAPI 3.0 åŸºç¤é…ç½® 1. æ‡‰ç”¨ç¨‹å¼é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # application.yml springdoc: api-docs: path: /api-docs enabled: true swagger-ui: path: /swagger-ui.html enabled: true operations-sorter: method tags-sorter: alpha try-it-out-enabled: true filter: true display-request-duration: true packages-to-scan: com.example.controller paths-to-match: /api/** default-consumes-media-type: application/json default-produces-media-type: application/json # è‡ªè¨‚é…ç½® app: api: title: E-Commerce API description: é›»å•†å¹³å°æ ¸å¿ƒ API æœå‹™ version: 1.0.0 contact: name: API Support Team email: api-support@example.com url: https://example.com/support license: name: Apache 2.0 url: https://www.apache.org/licenses/LICENSE-2.0.html terms-of-service: https://example.com/terms 2. é€²éš OpenAPI é…ç½®é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 @Configuration @EnableOpenApi public class OpenApiConfiguration { @Value(\u0026#34;${app.api.title}\u0026#34;) private String title; @Value(\u0026#34;${app.api.description}\u0026#34;) private String description; @Value(\u0026#34;${app.api.version}\u0026#34;) private String version; @Bean public OpenAPI customOpenAPI() { return new OpenAPI() .info(createApiInfo()) .servers(createServers()) .security(createSecurityRequirements()) .components(createComponents()); } private Info createApiInfo() { return new Info() .title(title) .description(description) .version(version) .contact(new Contact() .name(\u0026#34;API Support Team\u0026#34;) .email(\u0026#34;api-support@example.com\u0026#34;) .url(\u0026#34;https://example.com/support\u0026#34;)) .license(new License() .name(\u0026#34;Apache 2.0\u0026#34;) .url(\u0026#34;https://www.apache.org/licenses/LICENSE-2.0.html\u0026#34;)) .termsOfService(\u0026#34;https://example.com/terms\u0026#34;); } private List\u0026lt;Server\u0026gt; createServers() { return List.of( new Server() .url(\u0026#34;https://api.example.com\u0026#34;) .description(\u0026#34;Production Server\u0026#34;), new Server() .url(\u0026#34;https://staging-api.example.com\u0026#34;) .description(\u0026#34;Staging Server\u0026#34;), new Server() .url(\u0026#34;http://localhost:8080\u0026#34;) .description(\u0026#34;Development Server\u0026#34;) ); } private List\u0026lt;SecurityRequirement\u0026gt; createSecurityRequirements() { return List.of( new SecurityRequirement().addList(\u0026#34;bearerAuth\u0026#34;), new SecurityRequirement().addList(\u0026#34;apiKey\u0026#34;) ); } private Components createComponents() { return new Components() .addSecuritySchemes(\u0026#34;bearerAuth\u0026#34;, new SecurityScheme() .type(SecurityScheme.Type.HTTP) .scheme(\u0026#34;bearer\u0026#34;) .bearerFormat(\u0026#34;JWT\u0026#34;) .description(\u0026#34;JWT Bearer Token Authentication\u0026#34;)) .addSecuritySchemes(\u0026#34;apiKey\u0026#34;, new SecurityScheme() .type(SecurityScheme.Type.APIKEY) .in(SecurityScheme.In.HEADER) .name(\u0026#34;X-API-Key\u0026#34;) .description(\u0026#34;API Key Authentication\u0026#34;)) .addSchemas(\u0026#34;Error\u0026#34;, createErrorSchema()) .addSchemas(\u0026#34;PageInfo\u0026#34;, createPageInfoSchema()); } private Schema\u0026lt;?\u0026gt; createErrorSchema() { return new Schema\u0026lt;\u0026gt;() .type(\u0026#34;object\u0026#34;) .addProperties(\u0026#34;timestamp\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;string\u0026#34;).format(\u0026#34;date-time\u0026#34;)) .addProperties(\u0026#34;status\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;integer\u0026#34;)) .addProperties(\u0026#34;error\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;string\u0026#34;)) .addProperties(\u0026#34;message\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;string\u0026#34;)) .addProperties(\u0026#34;path\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;string\u0026#34;)); } private Schema\u0026lt;?\u0026gt; createPageInfoSchema() { return new Schema\u0026lt;\u0026gt;() .type(\u0026#34;object\u0026#34;) .addProperties(\u0026#34;page\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;integer\u0026#34;)) .addProperties(\u0026#34;size\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;integer\u0026#34;)) .addProperties(\u0026#34;totalElements\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;integer\u0026#34;)) .addProperties(\u0026#34;totalPages\u0026#34;, new Schema\u0026lt;\u0026gt;().type(\u0026#34;integer\u0026#34;)); } } æ§åˆ¶å™¨è¨»è§£è©³è§£ 1. å®Œæ•´çš„ REST Controller ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 @RestController @RequestMapping(\u0026#34;/api/v1/users\u0026#34;) @Tag(name = \u0026#34;User Management\u0026#34;, description = \u0026#34;ç”¨æˆ¶ç®¡ç†ç›¸é—œ API\u0026#34;) @SecurityRequirement(name = \u0026#34;bearerAuth\u0026#34;) public class UserController { private final UserService userService; public UserController(UserService userService) { this.userService = userService; } @GetMapping @Operation( summary = \u0026#34;ç²å–ç”¨æˆ¶åˆ—è¡¨\u0026#34;, description = \u0026#34;åˆ†é æŸ¥è©¢ç”¨æˆ¶è³‡è¨Šï¼Œæ”¯æ´å¤šç¨®éæ¿¾æ¢ä»¶\u0026#34;, tags = {\u0026#34;User Management\u0026#34;} ) @ApiResponses(value = { @ApiResponse( responseCode = \u0026#34;200\u0026#34;, description = \u0026#34;æˆåŠŸç²å–ç”¨æˆ¶åˆ—è¡¨\u0026#34;, content = @Content( mediaType = \u0026#34;application/json\u0026#34;, schema = @Schema(implementation = PagedUserResponse.class), examples = @ExampleObject( name = \u0026#34;ç”¨æˆ¶åˆ—è¡¨ç¯„ä¾‹\u0026#34;, value = \u0026#34;\u0026#34;\u0026#34; { \u0026#34;content\u0026#34;: [ { \u0026#34;id\u0026#34;: 1, \u0026#34;username\u0026#34;: \u0026#34;john_doe\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;john@example.com\u0026#34;, \u0026#34;firstName\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;lastName\u0026#34;: \u0026#34;Doe\u0026#34;, \u0026#34;createdAt\u0026#34;: \u0026#34;2023-01-15T10:30:00Z\u0026#34; } ], \u0026#34;pageable\u0026#34;: { \u0026#34;page\u0026#34;: 0, \u0026#34;size\u0026#34;: 20, \u0026#34;totalElements\u0026#34;: 1, \u0026#34;totalPages\u0026#34;: 1 } } \u0026#34;\u0026#34;\u0026#34; ) ) ), @ApiResponse( responseCode = \u0026#34;400\u0026#34;, description = \u0026#34;è«‹æ±‚åƒæ•¸éŒ¯èª¤\u0026#34;, content = @Content( mediaType = \u0026#34;application/json\u0026#34;, schema = @Schema(implementation = ErrorResponse.class) ) ), @ApiResponse( responseCode = \u0026#34;401\u0026#34;, description = \u0026#34;æœªæˆæ¬Šè¨ªå•\u0026#34;, content = @Content(schema = @Schema(implementation = ErrorResponse.class)) ), @ApiResponse( responseCode = \u0026#34;403\u0026#34;, description = \u0026#34;æ¬Šé™ä¸è¶³\u0026#34;, content = @Content(schema = @Schema(implementation = ErrorResponse.class)) ) }) public ResponseEntity\u0026lt;Page\u0026lt;UserResponse\u0026gt;\u0026gt; getUsers( @Parameter( description = \u0026#34;é ç¢¼ï¼ˆå¾ 0 é–‹å§‹ï¼‰\u0026#34;, example = \u0026#34;0\u0026#34;, schema = @Schema(minimum = \u0026#34;0\u0026#34;, defaultValue = \u0026#34;0\u0026#34;) ) @RequestParam(defaultValue = \u0026#34;0\u0026#34;) @Min(0) int page, @Parameter( description = \u0026#34;æ¯é å¤§å°\u0026#34;, example = \u0026#34;20\u0026#34;, schema = @Schema(minimum = \u0026#34;1\u0026#34;, maximum = \u0026#34;100\u0026#34;, defaultValue = \u0026#34;20\u0026#34;) ) @RequestParam(defaultValue = \u0026#34;20\u0026#34;) @Min(1) @Max(100) int size, @Parameter( description = \u0026#34;æ’åºæ¬„ä½ï¼Œæ ¼å¼ï¼šfield,direction\u0026#34;, example = \u0026#34;createdAt,desc\u0026#34;, array = @ArraySchema(schema = @Schema(type = \u0026#34;string\u0026#34;)) ) @RequestParam(defaultValue = \u0026#34;createdAt,desc\u0026#34;) String[] sort, @Parameter( description = \u0026#34;ç”¨æˆ¶åæœå°‹é—œéµå­—\u0026#34;, example = \u0026#34;john\u0026#34; ) @RequestParam(required = false) String username, @Parameter( description = \u0026#34;éƒµç®±æœå°‹é—œéµå­—\u0026#34;, example = \u0026#34;example.com\u0026#34; ) @RequestParam(required = false) String email, @Parameter( description = \u0026#34;ç”¨æˆ¶ç‹€æ…‹éæ¿¾\u0026#34;, schema = @Schema(allowableValues = {\u0026#34;ACTIVE\u0026#34;, \u0026#34;INACTIVE\u0026#34;, \u0026#34;SUSPENDED\u0026#34;}) ) @RequestParam(required = false) UserStatus status ) { UserSearchCriteria criteria = UserSearchCriteria.builder() .username(username) .email(email) .status(status) .build(); Pageable pageable = createPageable(page, size, sort); Page\u0026lt;UserResponse\u0026gt; users = userService.findUsers(criteria, pageable); return ResponseEntity.ok(users); } @GetMapping(\u0026#34;/{id}\u0026#34;) @Operation( summary = \u0026#34;æ ¹æ“š ID ç²å–ç”¨æˆ¶\u0026#34;, description = \u0026#34;æ ¹æ“šç”¨æˆ¶ ID ç²å–è©³ç´°è³‡è¨Š\u0026#34; ) @ApiResponses(value = { @ApiResponse( responseCode = \u0026#34;200\u0026#34;, description = \u0026#34;æˆåŠŸç²å–ç”¨æˆ¶è³‡è¨Š\u0026#34;, content = @Content( mediaType = \u0026#34;application/json\u0026#34;, schema = @Schema(implementation = UserDetailResponse.class) ) ), @ApiResponse(responseCode = \u0026#34;404\u0026#34;, description = \u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨\u0026#34;) }) public ResponseEntity\u0026lt;UserDetailResponse\u0026gt; getUserById( @Parameter( description = \u0026#34;ç”¨æˆ¶ ID\u0026#34;, required = true, example = \u0026#34;123\u0026#34; ) @PathVariable @Positive Long id ) { UserDetailResponse user = userService.findDetailById(id); return ResponseEntity.ok(user); } @PostMapping @Operation( summary = \u0026#34;å‰µå»ºæ–°ç”¨æˆ¶\u0026#34;, description = \u0026#34;å‰µå»ºæ–°çš„ç”¨æˆ¶å¸³æˆ¶ï¼Œéƒµç®±å¿…é ˆå”¯ä¸€\u0026#34; ) @ApiResponses(value = { @ApiResponse( responseCode = \u0026#34;201\u0026#34;, description = \u0026#34;ç”¨æˆ¶å‰µå»ºæˆåŠŸ\u0026#34;, content = @Content( mediaType = \u0026#34;application/json\u0026#34;, schema = @Schema(implementation = UserResponse.class) ) ), @ApiResponse( responseCode = \u0026#34;400\u0026#34;, description = \u0026#34;è«‹æ±‚è³‡æ–™é©—è­‰å¤±æ•—\u0026#34;, content = @Content( mediaType = \u0026#34;application/json\u0026#34;, schema = @Schema(implementation = ValidationErrorResponse.class) ) ), @ApiResponse( responseCode = \u0026#34;409\u0026#34;, description = \u0026#34;éƒµç®±å·²å­˜åœ¨\u0026#34; ) }) public ResponseEntity\u0026lt;UserResponse\u0026gt; createUser( @io.swagger.v3.oas.annotations.parameters.RequestBody( description = \u0026#34;ç”¨æˆ¶å‰µå»ºè«‹æ±‚\u0026#34;, required = true, content = @Content( mediaType = \u0026#34;application/json\u0026#34;, schema = @Schema(implementation = CreateUserRequest.class), examples = @ExampleObject( name = \u0026#34;ç”¨æˆ¶å‰µå»ºç¯„ä¾‹\u0026#34;, value = \u0026#34;\u0026#34;\u0026#34; { \u0026#34;username\u0026#34;: \u0026#34;john_doe\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;john@example.com\u0026#34;, \u0026#34;firstName\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;lastName\u0026#34;: \u0026#34;Doe\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;SecurePassword123!\u0026#34; } \u0026#34;\u0026#34;\u0026#34; ) ) ) @RequestBody @Valid CreateUserRequest request ) { UserResponse user = userService.createUser(request); URI location = URI.create(\u0026#34;/api/v1/users/\u0026#34; + user.getId()); return ResponseEntity.created(location).body(user); } @PutMapping(\u0026#34;/{id}\u0026#34;) @Operation( summary = \u0026#34;æ›´æ–°ç”¨æˆ¶è³‡è¨Š\u0026#34;, description = \u0026#34;æ›´æ–°æŒ‡å®šç”¨æˆ¶çš„åŸºæœ¬è³‡è¨Š\u0026#34; ) public ResponseEntity\u0026lt;UserResponse\u0026gt; updateUser( @PathVariable @Positive Long id, @RequestBody @Valid UpdateUserRequest request ) { UserResponse user = userService.updateUser(id, request); return ResponseEntity.ok(user); } @DeleteMapping(\u0026#34;/{id}\u0026#34;) @Operation( summary = \u0026#34;åˆªé™¤ç”¨æˆ¶\u0026#34;, description = \u0026#34;è»Ÿåˆªé™¤æŒ‡å®šç”¨æˆ¶ï¼ˆæ¨™è¨˜ç‚ºå·²åˆªé™¤ç‹€æ…‹ï¼‰\u0026#34; ) @ApiResponses(value = { @ApiResponse(responseCode = \u0026#34;204\u0026#34;, description = \u0026#34;åˆªé™¤æˆåŠŸ\u0026#34;), @ApiResponse(responseCode = \u0026#34;404\u0026#34;, description = \u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨\u0026#34;), @ApiResponse(responseCode = \u0026#34;409\u0026#34;, description = \u0026#34;ç”¨æˆ¶æœ‰é—œè¯è³‡æ–™ï¼Œç„¡æ³•åˆªé™¤\u0026#34;) }) public ResponseEntity\u0026lt;Void\u0026gt; deleteUser( @PathVariable @Positive Long id ) { userService.deleteUser(id); return ResponseEntity.noContent().build(); } @PostMapping(\u0026#34;/{id}/avatar\u0026#34;) @Operation( summary = \u0026#34;ä¸Šå‚³ç”¨æˆ¶é ­åƒ\u0026#34;, description = \u0026#34;ä¸Šå‚³ç”¨æˆ¶é ­åƒåœ–ç‰‡ï¼Œæ”¯æ´ JPGã€PNG æ ¼å¼\u0026#34; ) @ApiResponses(value = { @ApiResponse( responseCode = \u0026#34;200\u0026#34;, description = \u0026#34;é ­åƒä¸Šå‚³æˆåŠŸ\u0026#34;, content = @Content( mediaType = \u0026#34;application/json\u0026#34;, schema = @Schema(implementation = UploadResponse.class) ) ), @ApiResponse(responseCode = \u0026#34;400\u0026#34;, description = \u0026#34;æª”æ¡ˆæ ¼å¼ä¸æ”¯æ´\u0026#34;), @ApiResponse(responseCode = \u0026#34;413\u0026#34;, description = \u0026#34;æª”æ¡ˆå¤§å°è¶…å‡ºé™åˆ¶\u0026#34;) }) public ResponseEntity\u0026lt;UploadResponse\u0026gt; uploadAvatar( @PathVariable @Positive Long id, @Parameter( description = \u0026#34;é ­åƒåœ–ç‰‡æª”æ¡ˆ\u0026#34;, required = true, content = @Content(mediaType = \u0026#34;multipart/form-data\u0026#34;) ) @RequestParam(\u0026#34;file\u0026#34;) MultipartFile file ) { UploadResponse response = userService.uploadAvatar(id, file); return ResponseEntity.ok(response); } } 2. DTO é¡åˆ¥è¨»è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 @Schema(description = \u0026#34;ç”¨æˆ¶å‰µå»ºè«‹æ±‚\u0026#34;) public class CreateUserRequest { @Schema( description = \u0026#34;ç”¨æˆ¶å\u0026#34;, example = \u0026#34;john_doe\u0026#34;, minLength = 3, maxLength = 50, pattern = \u0026#34;^[a-zA-Z0-9_]+$\u0026#34; ) @NotBlank(message = \u0026#34;ç”¨æˆ¶åä¸èƒ½ç‚ºç©º\u0026#34;) @Size(min = 3, max = 50, message = \u0026#34;ç”¨æˆ¶åé•·åº¦å¿…é ˆåœ¨ 3-50 å­—å…ƒä¹‹é–“\u0026#34;) @Pattern(regexp = \u0026#34;^[a-zA-Z0-9_]+$\u0026#34;, message = \u0026#34;ç”¨æˆ¶ååªèƒ½åŒ…å«å­—æ¯ã€æ•¸å­—å’Œåº•ç·š\u0026#34;) private String username; @Schema( description = \u0026#34;éƒµç®±åœ°å€\u0026#34;, example = \u0026#34;john@example.com\u0026#34;, format = \u0026#34;email\u0026#34; ) @NotBlank(message = \u0026#34;éƒµç®±ä¸èƒ½ç‚ºç©º\u0026#34;) @Email(message = \u0026#34;éƒµç®±æ ¼å¼ä¸æ­£ç¢º\u0026#34;) private String email; @Schema( description = \u0026#34;åå­—\u0026#34;, example = \u0026#34;John\u0026#34;, maxLength = 30 ) @NotBlank(message = \u0026#34;åå­—ä¸èƒ½ç‚ºç©º\u0026#34;) @Size(max = 30, message = \u0026#34;åå­—é•·åº¦ä¸èƒ½è¶…é 30 å­—å…ƒ\u0026#34;) private String firstName; @Schema( description = \u0026#34;å§“æ°\u0026#34;, example = \u0026#34;Doe\u0026#34;, maxLength = 30 ) @NotBlank(message = \u0026#34;å§“æ°ä¸èƒ½ç‚ºç©º\u0026#34;) @Size(max = 30, message = \u0026#34;å§“æ°é•·åº¦ä¸èƒ½è¶…é 30 å­—å…ƒ\u0026#34;) private String lastName; @Schema( description = \u0026#34;å¯†ç¢¼\u0026#34;, example = \u0026#34;SecurePassword123!\u0026#34;, minLength = 8, maxLength = 100, format = \u0026#34;password\u0026#34; ) @NotBlank(message = \u0026#34;å¯†ç¢¼ä¸èƒ½ç‚ºç©º\u0026#34;) @Size(min = 8, max = 100, message = \u0026#34;å¯†ç¢¼é•·åº¦å¿…é ˆåœ¨ 8-100 å­—å…ƒä¹‹é–“\u0026#34;) @Pattern( regexp = \u0026#34;^(?=.*[a-z])(?=.*[A-Z])(?=.*\\\\d)(?=.*[@$!%*?\u0026amp;])[A-Za-z\\\\d@$!%*?\u0026amp;]+$\u0026#34;, message = \u0026#34;å¯†ç¢¼å¿…é ˆåŒ…å«å¤§å°å¯«å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šå­—å…ƒ\u0026#34; ) private String password; @Schema( description = \u0026#34;å‡ºç”Ÿæ—¥æœŸ\u0026#34;, example = \u0026#34;1990-01-15\u0026#34;, format = \u0026#34;date\u0026#34; ) @Past(message = \u0026#34;å‡ºç”Ÿæ—¥æœŸå¿…é ˆæ˜¯éå»çš„æ—¥æœŸ\u0026#34;) private LocalDate birthDate; @Schema( description = \u0026#34;ç”¨æˆ¶è§’è‰²\u0026#34;, allowableValues = {\u0026#34;USER\u0026#34;, \u0026#34;ADMIN\u0026#34;, \u0026#34;MODERATOR\u0026#34;}, defaultValue = \u0026#34;USER\u0026#34; ) private UserRole role = UserRole.USER; // Getters and Setters... } @Schema(description = \u0026#34;åˆ†é ç”¨æˆ¶å›æ‡‰\u0026#34;) public class PagedUserResponse { @Schema(description = \u0026#34;ç”¨æˆ¶åˆ—è¡¨\u0026#34;) private List\u0026lt;UserResponse\u0026gt; content; @Schema(description = \u0026#34;åˆ†é è³‡è¨Š\u0026#34;) private PageInfo pageable; // Getters and Setters... } @Schema(description = \u0026#34;ç”¨æˆ¶åŸºæœ¬è³‡è¨Šå›æ‡‰\u0026#34;) public class UserResponse { @Schema(description = \u0026#34;ç”¨æˆ¶ ID\u0026#34;, example = \u0026#34;123\u0026#34;) private Long id; @Schema(description = \u0026#34;ç”¨æˆ¶å\u0026#34;, example = \u0026#34;john_doe\u0026#34;) private String username; @Schema(description = \u0026#34;éƒµç®±\u0026#34;, example = \u0026#34;john@example.com\u0026#34;) private String email; @Schema(description = \u0026#34;å…¨å\u0026#34;, example = \u0026#34;John Doe\u0026#34;) private String fullName; @Schema(description = \u0026#34;é ­åƒ URL\u0026#34;, example = \u0026#34;https://example.com/avatars/123.jpg\u0026#34;) private String avatarUrl; @Schema(description = \u0026#34;ç”¨æˆ¶ç‹€æ…‹\u0026#34;, allowableValues = {\u0026#34;ACTIVE\u0026#34;, \u0026#34;INACTIVE\u0026#34;, \u0026#34;SUSPENDED\u0026#34;}) private UserStatus status; @Schema(description = \u0026#34;å‰µå»ºæ™‚é–“\u0026#34;, format = \u0026#34;date-time\u0026#34;) private LocalDateTime createdAt; @Schema(description = \u0026#34;æœ€å¾Œç™»å…¥æ™‚é–“\u0026#34;, format = \u0026#34;date-time\u0026#34;) private LocalDateTime lastLoginAt; // Getters and Setters... } å®‰å…¨é…ç½®æ•´åˆ 1. JWT Bearer Token æ•´åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 @Configuration @EnableWebSecurity public class SecurityConfiguration { @Bean public SecurityFilterChain filterChain(HttpSecurity http) throws Exception { return http .csrf(csrf -\u0026gt; csrf.disable()) .authorizeHttpRequests(auth -\u0026gt; auth // Swagger ç›¸é—œè·¯å¾‘å…¬é–‹ .requestMatchers( \u0026#34;/api-docs/**\u0026#34;, \u0026#34;/swagger-ui/**\u0026#34;, \u0026#34;/swagger-ui.html\u0026#34;, \u0026#34;/webjars/**\u0026#34; ).permitAll() // å…¬é–‹ API .requestMatchers(HttpMethod.POST, \u0026#34;/api/v1/auth/**\u0026#34;).permitAll() .requestMatchers(HttpMethod.GET, \u0026#34;/api/v1/public/**\u0026#34;).permitAll() // éœ€è¦èªè­‰çš„ API .anyRequest().authenticated() ) .oauth2ResourceServer(oauth2 -\u0026gt; oauth2 .jwt(jwt -\u0026gt; jwt.jwtDecoder(jwtDecoder())) ) .sessionManagement(session -\u0026gt; session .sessionCreationPolicy(SessionCreationPolicy.STATELESS) ) .build(); } @Bean public JwtDecoder jwtDecoder() { return NimbusJwtDecoder.withJwkSetUri(\u0026#34;https://your-auth-server/.well-known/jwks.json\u0026#34;) .build(); } } // åœ¨ Controller ä¸­æŒ‡å®šå®‰å…¨éœ€æ±‚ @RestController @RequestMapping(\u0026#34;/api/v1/admin\u0026#34;) @Tag(name = \u0026#34;Admin Management\u0026#34;, description = \u0026#34;ç®¡ç†å“¡å°ˆç”¨ API\u0026#34;) @SecurityRequirement(name = \u0026#34;bearerAuth\u0026#34;) @PreAuthorize(\u0026#34;hasRole(\u0026#39;ADMIN\u0026#39;)\u0026#34;) public class AdminController { @GetMapping(\u0026#34;/users\u0026#34;) @Operation( summary = \u0026#34;ç®¡ç†å“¡æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶\u0026#34;, description = \u0026#34;éœ€è¦ ADMIN è§’è‰²æ¬Šé™\u0026#34; ) @PreAuthorize(\u0026#34;hasAuthority(\u0026#39;USER_READ_ALL\u0026#39;)\u0026#34;) public ResponseEntity\u0026lt;Page\u0026lt;UserResponse\u0026gt;\u0026gt; getAllUsersForAdmin( @ParameterObject Pageable pageable ) { // Implementation... return ResponseEntity.ok().build(); } } 2. API Key èªè­‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 @Component public class ApiKeyAuthenticationFilter extends OncePerRequestFilter { private static final String API_KEY_HEADER = \u0026#34;X-API-Key\u0026#34;; private final ApiKeyService apiKeyService; public ApiKeyAuthenticationFilter(ApiKeyService apiKeyService) { this.apiKeyService = apiKeyService; } @Override protected void doFilterInternal( HttpServletRequest request, HttpServletResponse response, FilterChain filterChain ) throws ServletException, IOException { String apiKey = request.getHeader(API_KEY_HEADER); if (apiKey != null \u0026amp;\u0026amp; apiKeyService.isValidApiKey(apiKey)) { ApiKeyDetails details = apiKeyService.getApiKeyDetails(apiKey); ApiKeyAuthenticationToken authentication = new ApiKeyAuthenticationToken(details); SecurityContextHolder.getContext().setAuthentication(authentication); } filterChain.doFilter(request, response); } } // åœ¨ç‰¹å®š Controller ä¸­ä½¿ç”¨ API Key @RestController @RequestMapping(\u0026#34;/api/v1/webhook\u0026#34;) @Tag(name = \u0026#34;Webhook API\u0026#34;, description = \u0026#34;ç¬¬ä¸‰æ–¹ç³»çµ±å›èª¿ API\u0026#34;) @SecurityRequirement(name = \u0026#34;apiKey\u0026#34;) public class WebhookController { @PostMapping(\u0026#34;/payment\u0026#34;) @Operation( summary = \u0026#34;æ”¯ä»˜çµæœå›èª¿\u0026#34;, description = \u0026#34;ç¬¬ä¸‰æ–¹æ”¯ä»˜ç³»çµ±å›èª¿é€šçŸ¥\u0026#34; ) public ResponseEntity\u0026lt;Void\u0026gt; handlePaymentWebhook( @RequestBody PaymentWebhookRequest request ) { // Implementation... return ResponseEntity.ok().build(); } } é€²éšåŠŸèƒ½é…ç½® 1. è‡ªè¨‚æ–‡æª”åˆ†çµ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 @Configuration public class OpenApiGroupConfiguration { @Bean @Primary public GroupedOpenApi publicApi() { return GroupedOpenApi.builder() .group(\u0026#34;public\u0026#34;) .displayName(\u0026#34;Public API\u0026#34;) .pathsToMatch(\u0026#34;/api/v1/public/**\u0026#34;, \u0026#34;/api/v1/auth/**\u0026#34;) .build(); } @Bean public GroupedOpenApi userApi() { return GroupedOpenApi.builder() .group(\u0026#34;user\u0026#34;) .displayName(\u0026#34;User API\u0026#34;) .pathsToMatch(\u0026#34;/api/v1/users/**\u0026#34;, \u0026#34;/api/v1/profile/**\u0026#34;) .addOperationCustomizer((operation, handlerMethod) -\u0026gt; { operation.addSecurityItem(new SecurityRequirement().addList(\u0026#34;bearerAuth\u0026#34;)); return operation; }) .build(); } @Bean public GroupedOpenApi adminApi() { return GroupedOpenApi.builder() .group(\u0026#34;admin\u0026#34;) .displayName(\u0026#34;Admin API\u0026#34;) .pathsToMatch(\u0026#34;/api/v1/admin/**\u0026#34;) .addOperationCustomizer((operation, handlerMethod) -\u0026gt; { operation.addSecurityItem(new SecurityRequirement().addList(\u0026#34;bearerAuth\u0026#34;)); // æ·»åŠ ç®¡ç†å“¡ API çš„é¡å¤–æ¨™ç±¤ operation.addTagsItem(\u0026#34;Admin Only\u0026#34;); return operation; }) .build(); } @Bean public GroupedOpenApi internalApi() { return GroupedOpenApi.builder() .group(\u0026#34;internal\u0026#34;) .displayName(\u0026#34;Internal API\u0026#34;) .pathsToMatch(\u0026#34;/api/internal/**\u0026#34;) .addOperationCustomizer((operation, handlerMethod) -\u0026gt; { operation.addSecurityItem(new SecurityRequirement().addList(\u0026#34;apiKey\u0026#34;)); return operation; }) .build(); } } 2. è‡ªè¨‚æ“ä½œç¬¦è™•ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 @Component public class CustomOperationCustomizer implements OperationCustomizer { @Override public Operation customize(Operation operation, HandlerMethod handlerMethod) { // è‡ªå‹•æ·»åŠ é€šç”¨éŒ¯èª¤å›æ‡‰ addCommonErrorResponses(operation); // ç‚ºåˆ†é ç«¯é»æ·»åŠ é€šç”¨åƒæ•¸ if (isPaginationEndpoint(handlerMethod)) { addPaginationParameters(operation); } // æ·»åŠ è«‹æ±‚è¿½è¹¤è³‡è¨Š addRequestTrackingInfo(operation); return operation; } private void addCommonErrorResponses(Operation operation) { ApiResponses responses = operation.getResponses(); if (responses.get(\u0026#34;400\u0026#34;) == null) { responses.addApiResponse(\u0026#34;400\u0026#34;, new ApiResponse() .description(\u0026#34;è«‹æ±‚åƒæ•¸éŒ¯èª¤\u0026#34;) .content(new Content() .addMediaType(\u0026#34;application/json\u0026#34;, new MediaType() .schema(new Schema\u0026lt;\u0026gt;().$ref(\u0026#34;#/components/schemas/Error\u0026#34;))))); } if (responses.get(\u0026#34;500\u0026#34;) == null) { responses.addApiResponse(\u0026#34;500\u0026#34;, new ApiResponse() .description(\u0026#34;å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤\u0026#34;) .content(new Content() .addMediaType(\u0026#34;application/json\u0026#34;, new MediaType() .schema(new Schema\u0026lt;\u0026gt;().$ref(\u0026#34;#/components/schemas/Error\u0026#34;))))); } } private boolean isPaginationEndpoint(HandlerMethod handlerMethod) { return Arrays.stream(handlerMethod.getMethodParameters()) .anyMatch(param -\u0026gt; Pageable.class.isAssignableFrom(param.getParameterType())); } private void addPaginationParameters(Operation operation) { if (operation.getParameters() == null) { operation.setParameters(new ArrayList\u0026lt;\u0026gt;()); } // æ·»åŠ é€šç”¨åˆ†é åƒæ•¸ operation.getParameters().add(new Parameter() .name(\u0026#34;page\u0026#34;) .in(ParameterIn.QUERY) .description(\u0026#34;é ç¢¼ï¼ˆå¾ 0 é–‹å§‹ï¼‰\u0026#34;) .schema(new IntegerSchema().minimum(BigDecimal.ZERO)._default(0))); operation.getParameters().add(new Parameter() .name(\u0026#34;size\u0026#34;) .in(ParameterIn.QUERY) .description(\u0026#34;æ¯é å¤§å°\u0026#34;) .schema(new IntegerSchema().minimum(BigDecimal.ONE).maximum(BigDecimal.valueOf(100))._default(20))); } private void addRequestTrackingInfo(Operation operation) { operation.addExtension(\u0026#34;x-request-id\u0026#34;, \u0026#34;è‡ªå‹•ç”Ÿæˆçš„è«‹æ±‚è¿½è¹¤ ID\u0026#34;); operation.addExtension(\u0026#34;x-rate-limit\u0026#34;, \u0026#34;API å‘¼å«é »ç‡é™åˆ¶è³‡è¨Š\u0026#34;); } } 3. è‡ªè¨‚ Schema è™•ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 @Component public class CustomModelConverter implements ModelConverter { @Override public ModelConverterContext resolve( AnnotatedType annotatedType, ModelConverterContext context, Iterator\u0026lt;ModelConverter\u0026gt; chain ) { if (chain.hasNext()) { context = chain.next().resolve(annotatedType, context, chain); } // è‡ªè¨‚æšèˆ‰è™•ç† if (annotatedType.getType() instanceof Class\u0026lt;?\u0026gt; clazz \u0026amp;\u0026amp; clazz.isEnum()) { Schema\u0026lt;?\u0026gt; schema = context.getDefinedModels().get(annotatedType.getType().getTypeName()); if (schema != null) { enhanceEnumSchema(schema, clazz); } } return context; } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) private void enhanceEnumSchema(Schema\u0026lt;?\u0026gt; schema, Class\u0026lt;?\u0026gt; enumClass) { if (enumClass.isEnum()) { Enum\u0026lt;?\u0026gt;[] enumConstants = (Enum\u0026lt;?\u0026gt;[]) enumClass.getEnumConstants(); List\u0026lt;String\u0026gt; enumValues = Arrays.stream(enumConstants) .map(Enum::name) .collect(Collectors.toList()); schema.setEnum(enumValues); // æ·»åŠ æšèˆ‰æè¿° StringBuilder description = new StringBuilder(schema.getDescription() != null ? schema.getDescription() : \u0026#34;\u0026#34;); description.append(\u0026#34;\\n\\nå¯ç”¨å€¼ï¼š\\n\u0026#34;); for (Enum\u0026lt;?\u0026gt; enumConstant : enumConstants) { description.append(\u0026#34;- `\u0026#34;).append(enumConstant.name()).append(\u0026#34;`\u0026#34;); // å¦‚æœæšèˆ‰æœ‰æè¿°æ–¹æ³•ï¼Œæ·»åŠ æè¿° try { Method getDescription = enumClass.getMethod(\u0026#34;getDescription\u0026#34;); Object desc = getDescription.invoke(enumConstant); if (desc != null) { description.append(\u0026#34;: \u0026#34;).append(desc); } } catch (Exception ignored) { // å¿½ç•¥æ²’æœ‰ getDescription æ–¹æ³•çš„æƒ…æ³ } description.append(\u0026#34;\\n\u0026#34;); } schema.setDescription(description.toString()); } } } æ¸¬è©¦æ•´åˆ 1. API æ–‡æª”æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) @TestMethodOrder(OrderAnnotation.class) class OpenApiDocumentationTest { @Autowired private TestRestTemplate restTemplate; @LocalServerPort private int port; @Test @Order(1) void testOpenApiJsonGeneration() { String url = \u0026#34;http://localhost:\u0026#34; + port + \u0026#34;/api-docs\u0026#34;; ResponseEntity\u0026lt;String\u0026gt; response = restTemplate.getForEntity(url, String.class); assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK); assertThat(response.getBody()).isNotNull(); // é©—è­‰ JSON çµæ§‹ DocumentContext context = JsonPath.parse(response.getBody()); assertThat(context.read(\u0026#34;$.openapi\u0026#34;, String.class)).isEqualTo(\u0026#34;3.0.1\u0026#34;); assertThat(context.read(\u0026#34;$.info.title\u0026#34;, String.class)).isNotEmpty(); assertThat(context.read(\u0026#34;$.paths\u0026#34;, Map.class)).isNotEmpty(); } @Test @Order(2) void testSwaggerUiAccess() { String url = \u0026#34;http://localhost:\u0026#34; + port + \u0026#34;/swagger-ui.html\u0026#34;; ResponseEntity\u0026lt;String\u0026gt; response = restTemplate.getForEntity(url, String.class); assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK); assertThat(response.getBody()).contains(\u0026#34;Swagger UI\u0026#34;); } @Test @Order(3) void testApiGroupsGeneration() { String[] groups = {\u0026#34;public\u0026#34;, \u0026#34;user\u0026#34;, \u0026#34;admin\u0026#34;, \u0026#34;internal\u0026#34;}; for (String group : groups) { String url = \u0026#34;http://localhost:\u0026#34; + port + \u0026#34;/api-docs/\u0026#34; + group; ResponseEntity\u0026lt;String\u0026gt; response = restTemplate.getForEntity(url, String.class); assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK); DocumentContext context = JsonPath.parse(response.getBody()); assertThat(context.read(\u0026#34;$.paths\u0026#34;, Map.class)).isNotEmpty(); } } @Test @Order(4) void testSecuritySchemesDefinition() { String url = \u0026#34;http://localhost:\u0026#34; + port + \u0026#34;/api-docs\u0026#34;; ResponseEntity\u0026lt;String\u0026gt; response = restTemplate.getForEntity(url, String.class); DocumentContext context = JsonPath.parse(response.getBody()); // é©—è­‰å®‰å…¨æ–¹æ¡ˆå®šç¾© assertThat(context.read(\u0026#34;$.components.securitySchemes.bearerAuth.type\u0026#34;, String.class)) .isEqualTo(\u0026#34;http\u0026#34;); assertThat(context.read(\u0026#34;$.components.securitySchemes.apiKey.type\u0026#34;, String.class)) .isEqualTo(\u0026#34;apiKey\u0026#34;); } } 2. å¥‘ç´„æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) class ApiContractTest { @Autowired private TestRestTemplate restTemplate; @Autowired private ObjectMapper objectMapper; @LocalServerPort private int port; @Test void testUserApiContract() throws Exception { // ç²å– OpenAPI è¦ç¯„ String openApiJson = getOpenApiJson(); OpenAPIV3Parser parser = new OpenAPIV3Parser(); OpenAPI openAPI = parser.readContents(openApiJson).getOpenAPI(); // æ¸¬è©¦ç”¨æˆ¶å‰µå»ºç«¯é» PathItem userPath = openAPI.getPaths().get(\u0026#34;/api/v1/users\u0026#34;); assertThat(userPath).isNotNull(); Operation postOperation = userPath.getPost(); assertThat(postOperation).isNotNull(); assertThat(postOperation.getSummary()).isEqualTo(\u0026#34;å‰µå»ºæ–°ç”¨æˆ¶\u0026#34;); // é©—è­‰è«‹æ±‚ Schema RequestBody requestBody = postOperation.getRequestBody(); assertThat(requestBody).isNotNull(); Content content = requestBody.getContent(); MediaType mediaType = content.get(\u0026#34;application/json\u0026#34;); assertThat(mediaType).isNotNull(); // é©—è­‰å›æ‡‰ Schema ApiResponse response201 = postOperation.getResponses().get(\u0026#34;201\u0026#34;); assertThat(response201).isNotNull(); assertThat(response201.getDescription()).isEqualTo(\u0026#34;ç”¨æˆ¶å‰µå»ºæˆåŠŸ\u0026#34;); } @Test void testActualApiMatchesContract() throws Exception { // æ ¹æ“šæ–‡æª”æ¸¬è©¦å¯¦éš› API String requestJson = \u0026#34;\u0026#34;\u0026#34; { \u0026#34;username\u0026#34;: \u0026#34;test_user\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;test@example.com\u0026#34;, \u0026#34;firstName\u0026#34;: \u0026#34;Test\u0026#34;, \u0026#34;lastName\u0026#34;: \u0026#34;User\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;TestPassword123!\u0026#34; } \u0026#34;\u0026#34;\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); headers.setBearerAuth(\u0026#34;valid-jwt-token\u0026#34;); HttpEntity\u0026lt;String\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(requestJson, headers); // å‡è¨­é€™å€‹ç«¯é»åœ¨æ¸¬è©¦ç’°å¢ƒä¸­å¯ç”¨ String url = \u0026#34;http://localhost:\u0026#34; + port + \u0026#34;/api/v1/users\u0026#34;; ResponseEntity\u0026lt;String\u0026gt; response = restTemplate.postForEntity(url, request, String.class); // æ ¹æ“šæ–‡æª”ï¼Œæ‡‰è©²è¿”å› 201 æˆ– 401ï¼ˆå¦‚æœæ²’æœ‰æœ‰æ•ˆ tokenï¼‰ assertThat(response.getStatusCode()) .isIn(HttpStatus.CREATED, HttpStatus.UNAUTHORIZED); } private String getOpenApiJson() { String url = \u0026#34;http://localhost:\u0026#34; + port + \u0026#34;/api-docs\u0026#34;; return restTemplate.getForObject(url, String.class); } } éƒ¨ç½²èˆ‡ CI/CD æ•´åˆ 1. æ–‡æª”ç”Ÿæˆè…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 #!/bin/bash # scripts/generate-api-docs.sh set -e echo \u0026#34;ğŸš€ ç”Ÿæˆ API æ–‡æª”...\u0026#34; # å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ echo \u0026#34;å•Ÿå‹• Spring Boot æ‡‰ç”¨ç¨‹å¼...\u0026#34; java -jar target/api-service.jar --server.port=8080 \u0026amp; APP_PID=$! # ç­‰å¾…æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• echo \u0026#34;ç­‰å¾…æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•...\u0026#34; for i in {1..30}; do if curl -s http://localhost:8080/actuator/health \u0026gt; /dev/null; then echo \u0026#34;æ‡‰ç”¨ç¨‹å¼å·²å•Ÿå‹•\u0026#34; break fi sleep 2 done # ç”Ÿæˆ OpenAPI JSON echo \u0026#34;ä¸‹è¼‰ OpenAPI è¦ç¯„...\u0026#34; curl -o docs/openapi.json http://localhost:8080/api-docs # ç”Ÿæˆä¸åŒæ ¼å¼çš„æ–‡æª” echo \u0026#34;ç”Ÿæˆ HTML æ–‡æª”...\u0026#34; npx @redocly/openapi-cli build-docs docs/openapi.json --output docs/api.html echo \u0026#34;ç”Ÿæˆ Markdown æ–‡æª”...\u0026#34; npx widdershins docs/openapi.json -o docs/api.md # ç”Ÿæˆå®¢æˆ¶ç«¯ SDK echo \u0026#34;ç”Ÿæˆå®¢æˆ¶ç«¯ SDK...\u0026#34; mkdir -p generated/java-client npx @openapitools/openapi-generator-cli generate \\ -i docs/openapi.json \\ -g java \\ -o generated/java-client \\ --additional-properties=invokerPackage=com.example.client # åœæ­¢æ‡‰ç”¨ç¨‹å¼ echo \u0026#34;åœæ­¢æ‡‰ç”¨ç¨‹å¼...\u0026#34; kill $APP_PID echo \u0026#34;âœ… API æ–‡æª”ç”Ÿæˆå®Œæˆ\u0026#34; 2. GitHub Actions å·¥ä½œæµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 # .github/workflows/api-docs.yml name: Generate API Documentation on: push: branches: [ main, develop ] pull_request: branches: [ main ] jobs: generate-docs: runs-on: ubuntu-latest steps: - uses: actions/checkout@v3 - name: Set up JDK 17 uses: actions/setup-java@v3 with: java-version: \u0026#39;17\u0026#39; distribution: \u0026#39;temurin\u0026#39; - name: Cache Maven dependencies uses: actions/cache@v3 with: path: ~/.m2 key: ${{ runner.os }}-m2-${{ hashFiles(\u0026#39;**/pom.xml\u0026#39;) }} - name: Build application run: mvn clean package -DskipTests - name: Setup Node.js uses: actions/setup-node@v3 with: node-version: \u0026#39;18\u0026#39; - name: Install documentation tools run: | npm install -g @redocly/openapi-cli npm install -g widdershins npm install -g @openapitools/openapi-generator-cli - name: Generate API documentation run: | chmod +x scripts/generate-api-docs.sh ./scripts/generate-api-docs.sh - name: Upload documentation artifacts uses: actions/upload-artifact@v3 with: name: api-documentation path: | docs/ generated/ - name: Deploy to GitHub Pages if: github.ref == \u0026#39;refs/heads/main\u0026#39; uses: peaceiris/actions-gh-pages@v3 with: github_token: ${{ secrets.GITHUB_TOKEN }} publish_dir: ./docs 3. Docker æ•´åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # Dockerfile.docs FROM openjdk:17-jdk-slim as builder WORKDIR /app COPY . . RUN ./mvnw clean package -DskipTests FROM node:18-alpine as docs-generator WORKDIR /app # å®‰è£æ–‡æª”ç”Ÿæˆå·¥å…· RUN npm install -g @redocly/openapi-cli widdershins @openapitools/openapi-generator-cli # è¤‡è£½æ‡‰ç”¨ç¨‹å¼ COPY --from=builder /app/target/*.jar app.jar # ç”Ÿæˆæ–‡æª”çš„è…³æœ¬ COPY scripts/generate-docs-docker.sh . RUN chmod +x generate-docs-docker.sh EXPOSE 8080 CMD [\u0026#34;./generate-docs-docker.sh\u0026#34;] æ•ˆèƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. å¤§å‹ API çš„æ–‡æª”å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 @Configuration public class OpenApiPerformanceConfiguration { @Bean @ConditionalOnProperty(name = \u0026#34;springdoc.api-docs.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public OpenApiCustomiser openApiCustomiser() { return openApi -\u0026gt; { // ç§»é™¤ä¸å¿…è¦çš„ Schema removeUnusedSchemas(openApi); // ç°¡åŒ–è¤‡é›œçš„åµŒå¥—å°è±¡ simplifyNestedObjects(openApi); // æ·»åŠ å¿«å–é ­ addCacheHeaders(openApi); }; } private void removeUnusedSchemas(OpenAPI openApi) { if (openApi.getComponents() != null \u0026amp;\u0026amp; openApi.getComponents().getSchemas() != null) { Set\u0026lt;String\u0026gt; usedSchemas = findUsedSchemas(openApi); openApi.getComponents().getSchemas().entrySet() .removeIf(entry -\u0026gt; !usedSchemas.contains(entry.getKey())); } } private Set\u0026lt;String\u0026gt; findUsedSchemas(OpenAPI openApi) { Set\u0026lt;String\u0026gt; usedSchemas = new HashSet\u0026lt;\u0026gt;(); if (openApi.getPaths() != null) { openApi.getPaths().values().forEach(pathItem -\u0026gt; { Stream.of( pathItem.getGet(), pathItem.getPost(), pathItem.getPut(), pathItem.getDelete(), pathItem.getPatch() ).filter(Objects::nonNull) .forEach(operation -\u0026gt; collectUsedSchemas(operation, usedSchemas)); }); } return usedSchemas; } private void collectUsedSchemas(Operation operation, Set\u0026lt;String\u0026gt; usedSchemas) { // å¾è«‹æ±‚é«”æ”¶é›† if (operation.getRequestBody() != null \u0026amp;\u0026amp; operation.getRequestBody().getContent() != null) { operation.getRequestBody().getContent().values() .forEach(mediaType -\u0026gt; collectSchemaRefs(mediaType.getSchema(), usedSchemas)); } // å¾å›æ‡‰æ”¶é›† if (operation.getResponses() != null) { operation.getResponses().values().forEach(response -\u0026gt; { if (response.getContent() != null) { response.getContent().values() .forEach(mediaType -\u0026gt; collectSchemaRefs(mediaType.getSchema(), usedSchemas)); } }); } } private void collectSchemaRefs(Schema\u0026lt;?\u0026gt; schema, Set\u0026lt;String\u0026gt; usedSchemas) { if (schema != null) { if (schema.get$ref() != null) { String schemaName = schema.get$ref().substring(\u0026#34;#/components/schemas/\u0026#34;.length()); usedSchemas.add(schemaName); } // éè¿´è™•ç†åµŒå¥— Schema if (schema.getProperties() != null) { schema.getProperties().values().forEach(prop -\u0026gt; collectSchemaRefs((Schema\u0026lt;?\u0026gt;) prop, usedSchemas)); } } } } 2. å¿«å–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 @RestController @RequestMapping(\u0026#34;/api-docs\u0026#34;) public class CachedApiDocsController { private final SpringDocConfigProperties springDocConfigProperties; private final ObjectMapper objectMapper; private final Cache\u0026lt;String, String\u0026gt; apiDocsCache; public CachedApiDocsController( SpringDocConfigProperties springDocConfigProperties, ObjectMapper objectMapper ) { this.springDocConfigProperties = springDocConfigProperties; this.objectMapper = objectMapper; this.apiDocsCache = Caffeine.newBuilder() .maximumSize(10) .expireAfterWrite(Duration.ofMinutes(30)) .build(); } @GetMapping( value = \u0026#34;/{group}\u0026#34;, produces = MediaType.APPLICATION_JSON_VALUE ) public ResponseEntity\u0026lt;String\u0026gt; getCachedApiDocs( @PathVariable String group, HttpServletRequest request ) { String cacheKey = group + \u0026#34;_\u0026#34; + getVersionHash(); String cachedDocs = apiDocsCache.get(cacheKey, key -\u0026gt; { // ç”Ÿæˆæ–‡æª”çš„é‚è¼¯ return generateApiDocs(group); }); return ResponseEntity.ok() .cacheControl(CacheControl.maxAge(Duration.ofHours(1))) .eTag(calculateETag(cachedDocs)) .body(cachedDocs); } private String getVersionHash() { // åŸºæ–¼æ‡‰ç”¨ç¨‹å¼ç‰ˆæœ¬å’Œé…ç½®ç”Ÿæˆé›œæ¹Š String version = getClass().getPackage().getImplementationVersion(); return DigestUtils.md5Hex(version != null ? version : \u0026#34;dev\u0026#34;); } private String calculateETag(String content) { return \u0026#34;\\\u0026#34;\u0026#34; + DigestUtils.md5Hex(content) + \u0026#34;\\\u0026#34;\u0026#34;; } } 3. ç’°å¢ƒé…ç½®æœ€ä½³å¯¦è¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # application-dev.yml springdoc: api-docs: enabled: true swagger-ui: enabled: true try-it-out-enabled: true operations-sorter: method tags-sorter: alpha display-request-duration: true doc-expansion: list default-models-expand-depth: 2 # application-prod.yml springdoc: api-docs: enabled: false # ç”Ÿç”¢ç’°å¢ƒé—œé–‰ swagger-ui: enabled: false # ç”Ÿç”¢ç’°å¢ƒé—œé–‰ # application-staging.yml springdoc: api-docs: enabled: true swagger-ui: enabled: true try-it-out-enabled: false # æ¸¬è©¦ç’°å¢ƒç¦æ­¢ç›´æ¥æ¸¬è©¦ ç›£æ§èˆ‡åˆ†æ 1. API ä½¿ç”¨æƒ…æ³è¿½è¹¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 @Component public class ApiUsageTracker { private final MeterRegistry meterRegistry; private final Counter apiCallsCounter; private final Timer apiResponseTimer; public ApiUsageTracker(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.apiCallsCounter = Counter.builder(\u0026#34;api.calls\u0026#34;) .description(\u0026#34;API å‘¼å«æ¬¡æ•¸\u0026#34;) .register(meterRegistry); this.apiResponseTimer = Timer.builder(\u0026#34;api.response.time\u0026#34;) .description(\u0026#34;API å›æ‡‰æ™‚é–“\u0026#34;) .register(meterRegistry); } @EventListener public void trackApiCall(ApiCallEvent event) { apiCallsCounter .tag(\u0026#34;endpoint\u0026#34;, event.getEndpoint()) .tag(\u0026#34;method\u0026#34;, event.getMethod()) .tag(\u0026#34;status\u0026#34;, String.valueOf(event.getStatusCode())) .increment(); apiResponseTimer .tag(\u0026#34;endpoint\u0026#34;, event.getEndpoint()) .record(event.getResponseTime(), TimeUnit.MILLISECONDS); } } @RestController @RequestMapping(\u0026#34;/api/v1/analytics\u0026#34;) @Tag(name = \u0026#34;API Analytics\u0026#34;, description = \u0026#34;API ä½¿ç”¨æƒ…æ³åˆ†æ\u0026#34;) public class ApiAnalyticsController { private final MeterRegistry meterRegistry; public ApiAnalyticsController(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; } @GetMapping(\u0026#34;/metrics\u0026#34;) @Operation(summary = \u0026#34;ç²å– API ä½¿ç”¨çµ±è¨ˆ\u0026#34;) public ResponseEntity\u0026lt;ApiMetrics\u0026gt; getApiMetrics() { Map\u0026lt;String, Double\u0026gt; endpointCalls = new HashMap\u0026lt;\u0026gt;(); Map\u0026lt;String, Double\u0026gt; averageResponseTimes = new HashMap\u0026lt;\u0026gt;(); meterRegistry.getMeters().forEach(meter -\u0026gt; { if (meter instanceof Counter counter \u0026amp;\u0026amp; meter.getId().getName().equals(\u0026#34;api.calls\u0026#34;)) { String endpoint = meter.getId().getTag(\u0026#34;endpoint\u0026#34;); endpointCalls.put(endpoint, counter.count()); } if (meter instanceof Timer timer \u0026amp;\u0026amp; meter.getId().getName().equals(\u0026#34;api.response.time\u0026#34;)) { String endpoint = meter.getId().getTag(\u0026#34;endpoint\u0026#34;); averageResponseTimes.put(endpoint, timer.mean(TimeUnit.MILLISECONDS)); } }); ApiMetrics metrics = new ApiMetrics(endpointCalls, averageResponseTimes); return ResponseEntity.ok(metrics); } } ç¸½çµ Swagger/OpenAPI æ˜¯ç¾ä»£ API é–‹ç™¼çš„å¿…å‚™å·¥å…·ï¼Œæä¾›äº†å¾æ–‡æª”ç”Ÿæˆåˆ°æ¸¬è©¦ã€ç›£æ§çš„å®Œæ•´è§£æ±ºæ–¹æ¡ˆã€‚é€éæœ¬æ–‡çš„æ·±å…¥ä»‹ç´¹ï¼Œæˆ‘å€‘äº†è§£åˆ°ï¼š\næ ¸å¿ƒåƒ¹å€¼ è‡ªå‹•åŒ–æ–‡æª”ï¼šæ¸›å°‘æ‰‹å‹•ç¶­è­·æˆæœ¬ï¼Œç¢ºä¿æ–‡æª”èˆ‡ç¨‹å¼ç¢¼åŒæ­¥ äº’å‹•å¼æ¸¬è©¦ï¼šæä¾›å‹å–„çš„ API æ¸¬è©¦ä»‹é¢ åœ˜éšŠå”ä½œï¼šçµ±ä¸€çš„ API è¦ç¯„ä¿ƒé€²å‰å¾Œç«¯å”ä½œ ç¨‹å¼ç¢¼ç”Ÿæˆï¼šæ”¯æ´å¤šç¨®èªè¨€çš„å®¢æˆ¶ç«¯ SDK è‡ªå‹•ç”Ÿæˆ æœ€ä½³å¯¦è¸è¦é» é¸æ“‡ OpenAPI 3.0ï¼šä½¿ç”¨æœ€æ–°æ¨™æº–å’Œå·¥å…·éˆ å®Œæ•´çš„è¨»è§£ï¼šæä¾›è©³ç´°çš„æè¿°ã€ç¯„ä¾‹å’Œé©—è­‰è¦å‰‡ å®‰å…¨æ•´åˆï¼šæ­£ç¢ºé…ç½®èªè­‰å’Œæˆæ¬Šæ©Ÿåˆ¶ æ•ˆèƒ½å„ªåŒ–ï¼šé©ç•¶çš„å¿«å–å’Œæ–‡æª”åˆ†çµ„ç­–ç•¥ CI/CD æ•´åˆï¼šè‡ªå‹•åŒ–æ–‡æª”ç”Ÿæˆå’Œéƒ¨ç½²æµç¨‹ é€²éšæ‡‰ç”¨ å¥‘ç´„æ¸¬è©¦å’Œ API æ²»ç† å¤šç’°å¢ƒé…ç½®å’Œç‰ˆæœ¬ç®¡ç† ç›£æ§å’Œåˆ†æ API ä½¿ç”¨æƒ…æ³ èˆ‡å¾®æœå‹™æ¶æ§‹çš„æ•´åˆ æ­£ç¢ºå¯¦æ–½ Swagger/OpenAPI ä¸åƒ…èƒ½æå‡é–‹ç™¼æ•ˆç‡ï¼Œé‚„èƒ½å»ºç«‹æ¨™æº–åŒ–çš„ API é–‹ç™¼æµç¨‹ï¼Œç‚ºåœ˜éšŠå¸¶ä¾†é•·æœŸçš„æŠ€è¡“åƒ¹å€¼ã€‚\nåƒè€ƒè³‡æ–™ OpenAPI Specification SpringDoc OpenAPI Spring Boot OpenAPI Integration OpenAPI Generator Swagger UI Configuration ","permalink":"https://xinqilin.github.io/post/backend/swagger2/","tags":["Java","Spring","Swagger","OpenAPI","API","Documentation","SpringBoot","REST"],"title":"Swagger/OpenAPI å®Œæ•´æŒ‡å—ï¼šAPI æ–‡æª”åŒ–èˆ‡æ¸¬è©¦æœ€ä½³å¯¦è¸"},{"content":"æ¦‚è¿° RestTemplate æ˜¯ Spring Framework æä¾›çš„åŒæ­¥ HTTP å®¢æˆ¶ç«¯ï¼Œç”¨æ–¼ç°¡åŒ– RESTful Web æœå‹™çš„èª¿ç”¨ã€‚é›–ç„¶åœ¨ Spring 5.0 ä¹‹å¾Œè¢«æ¨™è¨˜ç‚ºç¶­è­·æ¨¡å¼ï¼ˆæ¨è–¦ä½¿ç”¨ WebClientï¼‰ï¼Œä½†åœ¨è¨±å¤šç¾æœ‰é …ç›®ä¸­ä»å»£æ³›ä½¿ç”¨ã€‚æœ¬æ–‡å°‡æ·±å…¥ä»‹ç´¹ RestTemplate çš„å®Œæ•´ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å¯¦è¸ã€‚\næ ¸å¿ƒç‰¹æ€§ ç°¡åŒ– HTTP æ“ä½œï¼šæä¾›ä¾¿æ·çš„ GETã€POSTã€PUTã€DELETE ç­‰æ–¹æ³• è‡ªå‹•åºåˆ—åŒ–ï¼šæ”¯æ´ JSONã€XML ç­‰æ ¼å¼çš„è‡ªå‹•è½‰æ› ç•°å¸¸è™•ç†ï¼šçµ±ä¸€çš„ç•°å¸¸è™•ç†æ©Ÿåˆ¶ æ””æˆªå™¨æ”¯æ´ï¼šè«‹æ±‚å’ŒéŸ¿æ‡‰æ””æˆªå™¨ éˆæ´»é…ç½®ï¼šé€£æ¥æ± ã€è¶…æ™‚ã€é‡è©¦ç­‰é…ç½® é©ç”¨å ´æ™¯ å¾®æœå‹™é€šä¿¡ï¼šæœå‹™é–“çš„ HTTP èª¿ç”¨ ç¬¬ä¸‰æ–¹ API æ•´åˆï¼šèª¿ç”¨å¤–éƒ¨ REST API è³‡æ–™åŒæ­¥ï¼šä¸åŒç³»çµ±é–“çš„è³‡æ–™äº¤æ› è¼•é‡ç´š HTTP å®¢æˆ¶ç«¯ï¼šç°¡å–®çš„ HTTP è«‹æ±‚éœ€æ±‚ åŸºç¤é…ç½®èˆ‡è¨­å®š 1. ä¾è³´é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 \u0026lt;dependencies\u0026gt; \u0026lt;!-- Spring Boot Starter Web --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Apache HttpClientï¼ˆå¯é¸ï¼Œæä¾›æ›´å¥½çš„é€£æ¥æ± æ”¯æ´ï¼‰ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.httpcomponents\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;httpclient\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- OkHttpï¼ˆå¯é¸ï¼Œç¾ä»£åŒ–çš„ HTTP å®¢æˆ¶ç«¯ï¼‰ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.squareup.okhttp3\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;okhttp\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Jacksonï¼ˆJSON è™•ç†ï¼‰ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-databind\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Testing --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; 2. åŸºç¤é…ç½®é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 package com.example.resttemplate.config; import org.apache.http.client.HttpClient; import org.apache.http.impl.client.HttpClients; import org.apache.http.impl.conn.PoolingHttpClientConnectionManager; import org.springframework.boot.web.client.RestTemplateBuilder; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.http.client.HttpComponentsClientHttpRequestFactory; import org.springframework.http.client.SimpleClientHttpRequestFactory; import org.springframework.http.converter.json.MappingJackson2HttpMessageConverter; import org.springframework.web.client.RestTemplate; import java.time.Duration; import java.util.Arrays; @Configuration public class RestTemplateConfig { /** * åŸºç¤ RestTemplate é…ç½® */ @Bean(\u0026#34;basicRestTemplate\u0026#34;) public RestTemplate basicRestTemplate() { SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory(); factory.setConnectTimeout(5000); // é€£æ¥è¶…æ™‚ 5 ç§’ factory.setReadTimeout(10000); // è®€å–è¶…æ™‚ 10 ç§’ RestTemplate restTemplate = new RestTemplate(factory); // æ·»åŠ  JSON æ¶ˆæ¯è½‰æ›å™¨ restTemplate.getMessageConverters().add(new MappingJackson2HttpMessageConverter()); return restTemplate; } /** * ä½¿ç”¨ RestTemplateBuilder æ§‹å»ºï¼ˆæ¨è–¦æ–¹å¼ï¼‰ */ @Bean(\u0026#34;standardRestTemplate\u0026#34;) public RestTemplate standardRestTemplate(RestTemplateBuilder builder) { return builder .setConnectTimeout(Duration.ofSeconds(5)) .setReadTimeout(Duration.ofSeconds(10)) .additionalMessageConverters(new MappingJackson2HttpMessageConverter()) .build(); } /** * é«˜æ€§èƒ½ RestTemplateï¼ˆä½¿ç”¨ Apache HttpClientï¼‰ */ @Bean(\u0026#34;highPerformanceRestTemplate\u0026#34;) public RestTemplate highPerformanceRestTemplate() { // é€£æ¥æ± ç®¡ç†å™¨ PoolingHttpClientConnectionManager connectionManager = new PoolingHttpClientConnectionManager(); connectionManager.setMaxTotal(200); // æœ€å¤§é€£æ¥æ•¸ connectionManager.setDefaultMaxPerRoute(50); // æ¯å€‹è·¯ç”±çš„æœ€å¤§é€£æ¥æ•¸ // HttpClient é…ç½® HttpClient httpClient = HttpClients.custom() .setConnectionManager(connectionManager) .setConnectionManagerShared(true) .build(); // è«‹æ±‚å·¥å»  HttpComponentsClientHttpRequestFactory factory = new HttpComponentsClientHttpRequestFactory(httpClient); factory.setConnectTimeout(5000); factory.setReadTimeout(10000); return new RestTemplate(factory); } /** * å¸¶æœ‰è‡ªè¨‚é…ç½®çš„ RestTemplate */ @Bean(\u0026#34;customRestTemplate\u0026#34;) public RestTemplate customRestTemplate() { RestTemplate restTemplate = new RestTemplate(); // æ·»åŠ æ””æˆªå™¨ restTemplate.setInterceptors(Arrays.asList( new LoggingInterceptor(), new AuthenticationInterceptor(), new RetryInterceptor() )); // è¨­ç½®éŒ¯èª¤è™•ç†å™¨ restTemplate.setErrorHandler(new CustomResponseErrorHandler()); return restTemplate; } } 3. å±¬æ€§é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # application.yml rest-client: connection: timeout: 5000 read-timeout: 10000 max-connections: 200 max-connections-per-route: 50 retry: max-attempts: 3 delay: 1000 base-urls: user-service: \u0026#34;http://localhost:8081\u0026#34; order-service: \u0026#34;http://localhost:8082\u0026#34; payment-service: \u0026#34;http://localhost:8083\u0026#34; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @ConfigurationProperties(prefix = \u0026#34;rest-client\u0026#34;) @Component public class RestClientProperties { private Connection connection = new Connection(); private Retry retry = new Retry(); private Map\u0026lt;String, String\u0026gt; baseUrls = new HashMap\u0026lt;\u0026gt;(); // getter å’Œ setter æ–¹æ³• public static class Connection { private int timeout = 5000; private int readTimeout = 10000; private int maxConnections = 200; private int maxConnectionsPerRoute = 50; // getter å’Œ setter æ–¹æ³• } public static class Retry { private int maxAttempts = 3; private long delay = 1000; // getter å’Œ setter æ–¹æ³• } } åŸºç¤ HTTP æ“ä½œ 1. GET è«‹æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 package com.example.resttemplate.service; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.core.ParameterizedTypeReference; import org.springframework.http.*; import org.springframework.stereotype.Service; import org.springframework.web.client.RestTemplate; import org.springframework.web.util.UriComponentsBuilder; import java.net.URI; import java.util.HashMap; import java.util.List; import java.util.Map; @Service public class RestClientService { private final RestTemplate restTemplate; public RestClientService(@Qualifier(\u0026#34;standardRestTemplate\u0026#34;) RestTemplate restTemplate) { this.restTemplate = restTemplate; } /** * åŸºç¤ GET è«‹æ±‚ */ public User getUserById(Long userId) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; return restTemplate.getForObject(url, User.class, userId); } /** * å¸¶æœ‰æŸ¥è©¢åƒæ•¸çš„ GET è«‹æ±‚ */ public List\u0026lt;User\u0026gt; getUsersByDepartment(String department, int page, int size) { String url = \u0026#34;https://api.example.com/users\u0026#34;; URI uri = UriComponentsBuilder.fromUriString(url) .queryParam(\u0026#34;department\u0026#34;, department) .queryParam(\u0026#34;page\u0026#34;, page) .queryParam(\u0026#34;size\u0026#34;, size) .build() .toUri(); ResponseEntity\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; response = restTemplate.exchange( uri, HttpMethod.GET, null, new ParameterizedTypeReference\u0026lt;List\u0026lt;User\u0026gt;\u0026gt;() {} ); return response.getBody(); } /** * ä½¿ç”¨ Map ä½œç‚º URI è®Šæ•¸ */ public User getUserWithMap(Long userId) { String url = \u0026#34;https://api.example.com/users/{id}/profile/{section}\u0026#34;; Map\u0026lt;String, Object\u0026gt; uriVariables = new HashMap\u0026lt;\u0026gt;(); uriVariables.put(\u0026#34;id\u0026#34;, userId); uriVariables.put(\u0026#34;section\u0026#34;, \u0026#34;basic\u0026#34;); return restTemplate.getForObject(url, User.class, uriVariables); } /** * å¸¶æœ‰è«‹æ±‚é ­çš„ GET è«‹æ±‚ */ public User getUserWithHeaders(Long userId, String authToken) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.set(\u0026#34;Authorization\u0026#34;, \u0026#34;Bearer \u0026#34; + authToken); headers.set(\u0026#34;Accept\u0026#34;, MediaType.APPLICATION_JSON_VALUE); HttpEntity\u0026lt;String\u0026gt; entity = new HttpEntity\u0026lt;\u0026gt;(headers); ResponseEntity\u0026lt;User\u0026gt; response = restTemplate.exchange( url, HttpMethod.GET, entity, User.class, userId ); return response.getBody(); } /** * ç²å–å®Œæ•´çš„éŸ¿æ‡‰è³‡è¨Š */ public ResponseEntity\u0026lt;User\u0026gt; getUserWithFullResponse(Long userId) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; ResponseEntity\u0026lt;User\u0026gt; response = restTemplate.getForEntity(url, User.class, userId); // å¯ä»¥ç²å–ç‹€æ…‹ç¢¼ã€é ­éƒ¨ã€ä¸»é«”ç­‰è³‡è¨Š HttpStatus statusCode = response.getStatusCode(); HttpHeaders responseHeaders = response.getHeaders(); User user = response.getBody(); return response; } } 2. POST è«‹æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 /** * POST è«‹æ±‚ç¯„ä¾‹ */ @Service public class PostRequestService { private final RestTemplate restTemplate; public PostRequestService(@Qualifier(\u0026#34;standardRestTemplate\u0026#34;) RestTemplate restTemplate) { this.restTemplate = restTemplate; } /** * åŸºç¤ POST è«‹æ±‚ */ public User createUser(User newUser) { String url = \u0026#34;https://api.example.com/users\u0026#34;; return restTemplate.postForObject(url, newUser, User.class); } /** * å¸¶æœ‰è«‹æ±‚é ­çš„ POST è«‹æ±‚ */ public ResponseEntity\u0026lt;User\u0026gt; createUserWithHeaders(User newUser, String authToken) { String url = \u0026#34;https://api.example.com/users\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); headers.set(\u0026#34;Authorization\u0026#34;, \u0026#34;Bearer \u0026#34; + authToken); HttpEntity\u0026lt;User\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(newUser, headers); return restTemplate.postForEntity(url, request, User.class); } /** * è¡¨å–®æ•¸æ“š POST è«‹æ±‚ */ public String submitForm(String email, String password) { String url = \u0026#34;https://api.example.com/login\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED); MultiValueMap\u0026lt;String, String\u0026gt; formData = new LinkedMultiValueMap\u0026lt;\u0026gt;(); formData.add(\u0026#34;email\u0026#34;, email); formData.add(\u0026#34;password\u0026#34;, password); HttpEntity\u0026lt;MultiValueMap\u0026lt;String, String\u0026gt;\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(formData, headers); return restTemplate.postForObject(url, request, String.class); } /** * JSON æ•¸æ“š POST è«‹æ±‚ */ public ApiResponse\u0026lt;User\u0026gt; createUserWithResponse(CreateUserRequest request) { String url = \u0026#34;https://api.example.com/users\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); headers.set(\u0026#34;X-Request-ID\u0026#34;, generateRequestId()); HttpEntity\u0026lt;CreateUserRequest\u0026gt; httpEntity = new HttpEntity\u0026lt;\u0026gt;(request, headers); ResponseEntity\u0026lt;ApiResponse\u0026lt;User\u0026gt;\u0026gt; response = restTemplate.exchange( url, HttpMethod.POST, httpEntity, new ParameterizedTypeReference\u0026lt;ApiResponse\u0026lt;User\u0026gt;\u0026gt;() {} ); return response.getBody(); } /** * æ–‡ä»¶ä¸Šå‚³ POST è«‹æ±‚ */ public String uploadFile(MultipartFile file, String description) { String url = \u0026#34;https://api.example.com/files/upload\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.MULTIPART_FORM_DATA); MultiValueMap\u0026lt;String, Object\u0026gt; formData = new LinkedMultiValueMap\u0026lt;\u0026gt;(); formData.add(\u0026#34;file\u0026#34;, file.getResource()); formData.add(\u0026#34;description\u0026#34;, description); HttpEntity\u0026lt;MultiValueMap\u0026lt;String, Object\u0026gt;\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(formData, headers); return restTemplate.postForObject(url, request, String.class); } private String generateRequestId() { return UUID.randomUUID().toString(); } } 3. PUT å’Œ DELETE è«‹æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 /** * PUT å’Œ DELETE è«‹æ±‚ç¯„ä¾‹ */ @Service public class UpdateDeleteService { private final RestTemplate restTemplate; public UpdateDeleteService(@Qualifier(\u0026#34;standardRestTemplate\u0026#34;) RestTemplate restTemplate) { this.restTemplate = restTemplate; } /** * PUT æ›´æ–°è«‹æ±‚ */ public User updateUser(Long userId, User updatedUser) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity\u0026lt;User\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(updatedUser, headers); ResponseEntity\u0026lt;User\u0026gt; response = restTemplate.exchange( url, HttpMethod.PUT, request, User.class, userId ); return response.getBody(); } /** * PATCH éƒ¨åˆ†æ›´æ–°è«‹æ±‚ */ public User partialUpdateUser(Long userId, Map\u0026lt;String, Object\u0026gt; updates) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(updates, headers); ResponseEntity\u0026lt;User\u0026gt; response = restTemplate.exchange( url, HttpMethod.PATCH, request, User.class, userId ); return response.getBody(); } /** * DELETE åˆªé™¤è«‹æ±‚ */ public void deleteUser(Long userId) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; restTemplate.delete(url, userId); } /** * å¸¶æœ‰éŸ¿æ‡‰çš„ DELETE è«‹æ±‚ */ public ApiResponse\u0026lt;Void\u0026gt; deleteUserWithResponse(Long userId, String authToken) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.set(\u0026#34;Authorization\u0026#34;, \u0026#34;Bearer \u0026#34; + authToken); HttpEntity\u0026lt;String\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(headers); ResponseEntity\u0026lt;ApiResponse\u0026lt;Void\u0026gt;\u0026gt; response = restTemplate.exchange( url, HttpMethod.DELETE, request, new ParameterizedTypeReference\u0026lt;ApiResponse\u0026lt;Void\u0026gt;\u0026gt;() {}, userId ); return response.getBody(); } /** * æ‰¹é‡åˆªé™¤è«‹æ±‚ */ public void deleteUsers(List\u0026lt;Long\u0026gt; userIds) { String url = \u0026#34;https://api.example.com/users/batch\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); DeleteBatchRequest request = new DeleteBatchRequest(userIds); HttpEntity\u0026lt;DeleteBatchRequest\u0026gt; httpEntity = new HttpEntity\u0026lt;\u0026gt;(request, headers); restTemplate.exchange( url, HttpMethod.DELETE, httpEntity, Void.class ); } } é«˜ç´šåŠŸèƒ½èˆ‡è‡ªè¨‚ 1. æ””æˆªå™¨å¯¦ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 /** * æ—¥èªŒæ””æˆªå™¨ */ @Component public class LoggingInterceptor implements ClientHttpRequestInterceptor { private static final Logger logger = LoggerFactory.getLogger(LoggingInterceptor.class); @Override public ClientHttpResponse intercept( HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException { logRequest(request, body); long startTime = System.currentTimeMillis(); ClientHttpResponse response = execution.execute(request, body); long duration = System.currentTimeMillis() - startTime; logResponse(response, duration); return response; } private void logRequest(HttpRequest request, byte[] body) { logger.info(\u0026#34;===========================request begin================================================\u0026#34;); logger.info(\u0026#34;URI : {}\u0026#34;, request.getURI()); logger.info(\u0026#34;Method : {}\u0026#34;, request.getMethod()); logger.info(\u0026#34;Headers : {}\u0026#34;, request.getHeaders()); logger.info(\u0026#34;Request body: {}\u0026#34;, new String(body, StandardCharsets.UTF_8)); logger.info(\u0026#34;==========================request end================================================\u0026#34;); } private void logResponse(ClientHttpResponse response, long duration) throws IOException { logger.info(\u0026#34;============================response begin==========================================\u0026#34;); logger.info(\u0026#34;Status code : {}\u0026#34;, response.getStatusCode()); logger.info(\u0026#34;Status text : {}\u0026#34;, response.getStatusText()); logger.info(\u0026#34;Headers : {}\u0026#34;, response.getHeaders()); logger.info(\u0026#34;Duration : {} ms\u0026#34;, duration); logger.info(\u0026#34;=======================response end=================================================\u0026#34;); } } /** * èªè­‰æ””æˆªå™¨ */ @Component public class AuthenticationInterceptor implements ClientHttpRequestInterceptor { private final TokenService tokenService; public AuthenticationInterceptor(TokenService tokenService) { this.tokenService = tokenService; } @Override public ClientHttpResponse intercept( HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException { // ç²å–ä¸¦è¨­ç½®èªè­‰ token String token = tokenService.getCurrentToken(); if (token != null) { request.getHeaders().set(\u0026#34;Authorization\u0026#34;, \u0026#34;Bearer \u0026#34; + token); } return execution.execute(request, body); } } /** * é‡è©¦æ””æˆªå™¨ */ @Component public class RetryInterceptor implements ClientHttpRequestInterceptor { private static final Logger logger = LoggerFactory.getLogger(RetryInterceptor.class); private final int maxRetries; private final long retryDelay; public RetryInterceptor(@Value(\u0026#34;${rest-client.retry.max-attempts:3}\u0026#34;) int maxRetries, @Value(\u0026#34;${rest-client.retry.delay:1000}\u0026#34;) long retryDelay) { this.maxRetries = maxRetries; this.retryDelay = retryDelay; } @Override public ClientHttpResponse intercept( HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException { IOException lastException = null; for (int attempt = 1; attempt \u0026lt;= maxRetries; attempt++) { try { ClientHttpResponse response = execution.execute(request, body); // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡è©¦ï¼ˆä¾‹å¦‚ï¼š5xx éŒ¯èª¤ï¼‰ if (shouldRetry(response) \u0026amp;\u0026amp; attempt \u0026lt; maxRetries) { logger.warn(\u0026#34;Request failed with status {}, retrying... (attempt {}/{})\u0026#34;, response.getStatusCode(), attempt, maxRetries); // ç­‰å¾…å¾Œé‡è©¦ try { Thread.sleep(retryDelay * attempt); // æŒ‡æ•¸é€€é¿ } catch (InterruptedException e) { Thread.currentThread().interrupt(); throw new IOException(\u0026#34;Interrupted during retry delay\u0026#34;, e); } continue; } return response; } catch (IOException e) { lastException = e; if (attempt \u0026lt; maxRetries) { logger.warn(\u0026#34;Request failed, retrying... (attempt {}/{}) - {}\u0026#34;, attempt, maxRetries, e.getMessage()); try { Thread.sleep(retryDelay * attempt); } catch (InterruptedException ie) { Thread.currentThread().interrupt(); throw new IOException(\u0026#34;Interrupted during retry delay\u0026#34;, ie); } } else { logger.error(\u0026#34;Request failed after {} attempts\u0026#34;, maxRetries, e); } } } throw lastException; } private boolean shouldRetry(ClientHttpResponse response) throws IOException { HttpStatus status = response.getStatusCode(); return status.is5xxServerError() || status == HttpStatus.REQUEST_TIMEOUT; } } 2. è‡ªè¨‚éŒ¯èª¤è™•ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 /** * è‡ªè¨‚éŸ¿æ‡‰éŒ¯èª¤è™•ç†å™¨ */ @Component public class CustomResponseErrorHandler implements ResponseErrorHandler { private static final Logger logger = LoggerFactory.getLogger(CustomResponseErrorHandler.class); @Override public boolean hasError(ClientHttpResponse response) throws IOException { HttpStatus status = response.getStatusCode(); return status.series() == HttpStatus.Series.CLIENT_ERROR || status.series() == HttpStatus.Series.SERVER_ERROR; } @Override public void handleError(ClientHttpResponse response) throws IOException { HttpStatus status = response.getStatusCode(); String responseBody = getResponseBody(response); logger.error(\u0026#34;HTTP Error: {} - {}, Response: {}\u0026#34;, status.value(), status.getReasonPhrase(), responseBody); switch (status.series()) { case CLIENT_ERROR: handleClientError(status, responseBody); break; case SERVER_ERROR: handleServerError(status, responseBody); break; default: throw new RestClientException(\u0026#34;Unknown HTTP error: \u0026#34; + status); } } private void handleClientError(HttpStatus status, String responseBody) { switch (status) { case BAD_REQUEST: throw new BadRequestException(\u0026#34;Invalid request: \u0026#34; + responseBody); case UNAUTHORIZED: throw new UnauthorizedException(\u0026#34;Authentication required\u0026#34;); case FORBIDDEN: throw new ForbiddenException(\u0026#34;Access denied\u0026#34;); case NOT_FOUND: throw new NotFoundException(\u0026#34;Resource not found\u0026#34;); case CONFLICT: throw new ConflictException(\u0026#34;Resource conflict: \u0026#34; + responseBody); case TOO_MANY_REQUESTS: throw new RateLimitException(\u0026#34;Rate limit exceeded\u0026#34;); default: throw new ClientErrorException(\u0026#34;Client error: \u0026#34; + status + \u0026#34; - \u0026#34; + responseBody); } } private void handleServerError(HttpStatus status, String responseBody) { switch (status) { case INTERNAL_SERVER_ERROR: throw new ServerErrorException(\u0026#34;Internal server error: \u0026#34; + responseBody); case BAD_GATEWAY: throw new BadGatewayException(\u0026#34;Bad gateway\u0026#34;); case SERVICE_UNAVAILABLE: throw new ServiceUnavailableException(\u0026#34;Service unavailable\u0026#34;); case GATEWAY_TIMEOUT: throw new GatewayTimeoutException(\u0026#34;Gateway timeout\u0026#34;); default: throw new ServerErrorException(\u0026#34;Server error: \u0026#34; + status + \u0026#34; - \u0026#34; + responseBody); } } private String getResponseBody(ClientHttpResponse response) { try (InputStream inputStream = response.getBody()) { return StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8); } catch (IOException e) { logger.warn(\u0026#34;Failed to read response body\u0026#34;, e); return \u0026#34;Unable to read response body\u0026#34;; } } } 3. è‡ªè¨‚ç•°å¸¸é¡åˆ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 // åŸºç¤ç•°å¸¸é¡åˆ¥ public abstract class RestClientException extends RuntimeException { public RestClientException(String message) { super(message); } public RestClientException(String message, Throwable cause) { super(message, cause); } } // å®¢æˆ¶ç«¯éŒ¯èª¤ç•°å¸¸ public class ClientErrorException extends RestClientException { public ClientErrorException(String message) { super(message); } } public class BadRequestException extends ClientErrorException { public BadRequestException(String message) { super(message); } } public class UnauthorizedException extends ClientErrorException { public UnauthorizedException(String message) { super(message); } } public class ForbiddenException extends ClientErrorException { public ForbiddenException(String message) { super(message); } } public class NotFoundException extends ClientErrorException { public NotFoundException(String message) { super(message); } } public class ConflictException extends ClientErrorException { public ConflictException(String message) { super(message); } } public class RateLimitException extends ClientErrorException { public RateLimitException(String message) { super(message); } } // æœå‹™å™¨éŒ¯èª¤ç•°å¸¸ public class ServerErrorException extends RestClientException { public ServerErrorException(String message) { super(message); } } public class BadGatewayException extends ServerErrorException { public BadGatewayException(String message) { super(message); } } public class ServiceUnavailableException extends ServerErrorException { public ServiceUnavailableException(String message) { super(message); } } public class GatewayTimeoutException extends ServerErrorException { public GatewayTimeoutException(String message) { super(message); } } å¯¦éš›æ‡‰ç”¨å ´æ™¯ 1. å¾®æœå‹™é€šä¿¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 /** * ç”¨æˆ¶æœå‹™å®¢æˆ¶ç«¯ */ @Service public class UserServiceClient { private final RestTemplate restTemplate; private final RestClientProperties properties; public UserServiceClient(@Qualifier(\u0026#34;highPerformanceRestTemplate\u0026#34;) RestTemplate restTemplate, RestClientProperties properties) { this.restTemplate = restTemplate; this.properties = properties; } /** * ç²å–ç”¨æˆ¶è³‡è¨Š */ public Optional\u0026lt;User\u0026gt; getUserById(Long userId) { String url = properties.getBaseUrls().get(\u0026#34;user-service\u0026#34;) + \u0026#34;/api/users/{id}\u0026#34;; try { User user = restTemplate.getForObject(url, User.class, userId); return Optional.ofNullable(user); } catch (NotFoundException e) { return Optional.empty(); } } /** * æ‰¹é‡ç²å–ç”¨æˆ¶è³‡è¨Š */ public List\u0026lt;User\u0026gt; getUsersByIds(List\u0026lt;Long\u0026gt; userIds) { String url = properties.getBaseUrls().get(\u0026#34;user-service\u0026#34;) + \u0026#34;/api/users/batch\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity\u0026lt;List\u0026lt;Long\u0026gt;\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(userIds, headers); ResponseEntity\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; response = restTemplate.exchange( url, HttpMethod.POST, request, new ParameterizedTypeReference\u0026lt;List\u0026lt;User\u0026gt;\u0026gt;() {} ); return response.getBody(); } /** * å‰µå»ºç”¨æˆ¶ */ public User createUser(CreateUserRequest request) { String url = properties.getBaseUrls().get(\u0026#34;user-service\u0026#34;) + \u0026#34;/api/users\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity\u0026lt;CreateUserRequest\u0026gt; httpEntity = new HttpEntity\u0026lt;\u0026gt;(request, headers); return restTemplate.postForObject(url, httpEntity, User.class); } /** * æ›´æ–°ç”¨æˆ¶ç‹€æ…‹ */ public void updateUserStatus(Long userId, UserStatus status) { String url = properties.getBaseUrls().get(\u0026#34;user-service\u0026#34;) + \u0026#34;/api/users/{id}/status\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); UpdateStatusRequest request = new UpdateStatusRequest(status); HttpEntity\u0026lt;UpdateStatusRequest\u0026gt; httpEntity = new HttpEntity\u0026lt;\u0026gt;(request, headers); restTemplate.exchange(url, HttpMethod.PUT, httpEntity, Void.class, userId); } } /** * è¨‚å–®æœå‹™å®¢æˆ¶ç«¯ */ @Service public class OrderServiceClient { private final RestTemplate restTemplate; private final RestClientProperties properties; public OrderServiceClient(@Qualifier(\u0026#34;highPerformanceRestTemplate\u0026#34;) RestTemplate restTemplate, RestClientProperties properties) { this.restTemplate = restTemplate; this.properties = properties; } /** * å‰µå»ºè¨‚å–® */ public Order createOrder(CreateOrderRequest request) { String url = properties.getBaseUrls().get(\u0026#34;order-service\u0026#34;) + \u0026#34;/api/orders\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); headers.set(\u0026#34;X-Request-ID\u0026#34;, UUID.randomUUID().toString()); HttpEntity\u0026lt;CreateOrderRequest\u0026gt; httpEntity = new HttpEntity\u0026lt;\u0026gt;(request, headers); ResponseEntity\u0026lt;Order\u0026gt; response = restTemplate.postForEntity(url, httpEntity, Order.class); if (response.getStatusCode() == HttpStatus.CREATED) { return response.getBody(); } else { throw new RuntimeException(\u0026#34;Failed to create order: \u0026#34; + response.getStatusCode()); } } /** * ç²å–ç”¨æˆ¶è¨‚å–®åˆ—è¡¨ */ public PagedResponse\u0026lt;Order\u0026gt; getUserOrders(Long userId, int page, int size) { String url = properties.getBaseUrls().get(\u0026#34;order-service\u0026#34;) + \u0026#34;/api/users/{userId}/orders\u0026#34;; URI uri = UriComponentsBuilder.fromUriString(url) .queryParam(\u0026#34;page\u0026#34;, page) .queryParam(\u0026#34;size\u0026#34;, size) .build(userId); ResponseEntity\u0026lt;PagedResponse\u0026lt;Order\u0026gt;\u0026gt; response = restTemplate.exchange( uri, HttpMethod.GET, null, new ParameterizedTypeReference\u0026lt;PagedResponse\u0026lt;Order\u0026gt;\u0026gt;() {} ); return response.getBody(); } /** * å–æ¶ˆè¨‚å–® */ public void cancelOrder(Long orderId, String reason) { String url = properties.getBaseUrls().get(\u0026#34;order-service\u0026#34;) + \u0026#34;/api/orders/{id}/cancel\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); CancelOrderRequest request = new CancelOrderRequest(reason); HttpEntity\u0026lt;CancelOrderRequest\u0026gt; httpEntity = new HttpEntity\u0026lt;\u0026gt;(request, headers); restTemplate.exchange(url, HttpMethod.POST, httpEntity, Void.class, orderId); } } 2. ç¬¬ä¸‰æ–¹ API æ•´åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 /** * ç¬¬ä¸‰æ–¹æ”¯ä»˜æœå‹™æ•´åˆ */ @Service public class PaymentGatewayClient { private final RestTemplate restTemplate; private final PaymentConfig paymentConfig; public PaymentGatewayClient(@Qualifier(\u0026#34;customRestTemplate\u0026#34;) RestTemplate restTemplate, PaymentConfig paymentConfig) { this.restTemplate = restTemplate; this.paymentConfig = paymentConfig; } /** * å‰µå»ºæ”¯ä»˜è¨‚å–® */ public PaymentResponse createPayment(PaymentRequest paymentRequest) { String url = paymentConfig.getBaseUrl() + \u0026#34;/api/v1/payments\u0026#34;; HttpHeaders headers = createAuthHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity\u0026lt;PaymentRequest\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(paymentRequest, headers); try { ResponseEntity\u0026lt;PaymentResponse\u0026gt; response = restTemplate.postForEntity( url, request, PaymentResponse.class); return response.getBody(); } catch (Exception e) { throw new PaymentException(\u0026#34;Failed to create payment\u0026#34;, e); } } /** * æŸ¥è©¢æ”¯ä»˜ç‹€æ…‹ */ public PaymentStatus queryPaymentStatus(String paymentId) { String url = paymentConfig.getBaseUrl() + \u0026#34;/api/v1/payments/{paymentId}/status\u0026#34;; HttpHeaders headers = createAuthHeaders(); HttpEntity\u0026lt;String\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(headers); try { ResponseEntity\u0026lt;PaymentStatusResponse\u0026gt; response = restTemplate.exchange( url, HttpMethod.GET, request, PaymentStatusResponse.class, paymentId); return response.getBody().getStatus(); } catch (NotFoundException e) { throw new PaymentNotFoundException(\u0026#34;Payment not found: \u0026#34; + paymentId); } } /** * é€€æ¬¾è«‹æ±‚ */ public RefundResponse processRefund(String paymentId, RefundRequest refundRequest) { String url = paymentConfig.getBaseUrl() + \u0026#34;/api/v1/payments/{paymentId}/refund\u0026#34;; HttpHeaders headers = createAuthHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity\u0026lt;RefundRequest\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(refundRequest, headers); try { ResponseEntity\u0026lt;RefundResponse\u0026gt; response = restTemplate.exchange( url, HttpMethod.POST, request, RefundResponse.class, paymentId); return response.getBody(); } catch (Exception e) { throw new RefundException(\u0026#34;Failed to process refund\u0026#34;, e); } } /** * å‰µå»ºèªè­‰é ­ */ private HttpHeaders createAuthHeaders() { HttpHeaders headers = new HttpHeaders(); String auth = paymentConfig.getApiKey() + \u0026#34;:\u0026#34; + paymentConfig.getApiSecret(); String encodedAuth = Base64.getEncoder().encodeToString(auth.getBytes()); headers.set(\u0026#34;Authorization\u0026#34;, \u0026#34;Basic \u0026#34; + encodedAuth); headers.set(\u0026#34;X-API-Version\u0026#34;, paymentConfig.getApiVersion()); return headers; } } /** * å¤–éƒ¨è³‡æ–™åŒæ­¥æœå‹™ */ @Service public class DataSyncService { private final RestTemplate restTemplate; private final DataSyncConfig config; public DataSyncService(@Qualifier(\u0026#34;standardRestTemplate\u0026#34;) RestTemplate restTemplate, DataSyncConfig config) { this.restTemplate = restTemplate; this.config = config; } /** * åŒæ­¥ç”¨æˆ¶è³‡æ–™ */ @Async public CompletableFuture\u0026lt;SyncResult\u0026gt; syncUserData() { String url = config.getExternalApiUrl() + \u0026#34;/users/export\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.set(\u0026#34;Authorization\u0026#34;, \u0026#34;Bearer \u0026#34; + config.getAccessToken()); headers.set(\u0026#34;Accept\u0026#34;, MediaType.APPLICATION_JSON_VALUE); HttpEntity\u0026lt;String\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(headers); try { ResponseEntity\u0026lt;List\u0026lt;ExternalUser\u0026gt;\u0026gt; response = restTemplate.exchange( url, HttpMethod.GET, request, new ParameterizedTypeReference\u0026lt;List\u0026lt;ExternalUser\u0026gt;\u0026gt;() {} ); List\u0026lt;ExternalUser\u0026gt; externalUsers = response.getBody(); // è™•ç†åŒæ­¥é‚è¼¯ int syncedCount = processSyncData(externalUsers); return CompletableFuture.completedFuture( new SyncResult(true, syncedCount, \u0026#34;Sync completed successfully\u0026#34;)); } catch (Exception e) { return CompletableFuture.completedFuture( new SyncResult(false, 0, \u0026#34;Sync failed: \u0026#34; + e.getMessage())); } } private int processSyncData(List\u0026lt;ExternalUser\u0026gt; externalUsers) { // åŒæ­¥è™•ç†é‚è¼¯ return externalUsers != null ? externalUsers.size() : 0; } } æ•ˆèƒ½å„ªåŒ–èˆ‡ç›£æ§ 1. é€£æ¥æ± å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 /** * é«˜æ•ˆèƒ½ RestTemplate é…ç½® */ @Configuration public class HighPerformanceRestTemplateConfig { @Bean(\u0026#34;pooledRestTemplate\u0026#34;) public RestTemplate pooledRestTemplate() { // é€£æ¥æ± ç®¡ç†å™¨é…ç½® PoolingHttpClientConnectionManager connectionManager = new PoolingHttpClientConnectionManager(); connectionManager.setMaxTotal(300); // æœ€å¤§é€£æ¥æ•¸ connectionManager.setDefaultMaxPerRoute(100); // æ¯å€‹è·¯ç”±çš„æœ€å¤§é€£æ¥æ•¸ connectionManager.setValidateAfterInactivity(2000); // é€£æ¥ç©ºé–’æª¢æŸ¥æ™‚é–“ // é€£æ¥æ± æ¸…ç†ç­–ç•¥ connectionManager.closeExpiredConnections(); connectionManager.closeIdleConnections(30, TimeUnit.SECONDS); // è«‹æ±‚é…ç½® RequestConfig requestConfig = RequestConfig.custom() .setConnectionRequestTimeout(5000) // å¾é€£æ¥æ± ç²å–é€£æ¥çš„è¶…æ™‚æ™‚é–“ .setConnectTimeout(5000) // é€£æ¥è¶…æ™‚æ™‚é–“ .setSocketTimeout(30000) // è®€å–è¶…æ™‚æ™‚é–“ .build(); // HttpClient é…ç½® CloseableHttpClient httpClient = HttpClients.custom() .setConnectionManager(connectionManager) .setDefaultRequestConfig(requestConfig) .setRetryHandler(new DefaultHttpRequestRetryHandler(3, true)) .setKeepAliveStrategy((response, context) -\u0026gt; 30 * 1000) // 30 ç§’ keep-alive .build(); // è«‹æ±‚å·¥å»  HttpComponentsClientHttpRequestFactory factory = new HttpComponentsClientHttpRequestFactory(httpClient); return new RestTemplate(factory); } /** * é€£æ¥æ± ç›£æ§ */ @Component public class ConnectionPoolMonitor { private final PoolingHttpClientConnectionManager connectionManager; private final MeterRegistry meterRegistry; public ConnectionPoolMonitor(PoolingHttpClientConnectionManager connectionManager, MeterRegistry meterRegistry) { this.connectionManager = connectionManager; this.meterRegistry = meterRegistry; // è¨»å†Šé€£æ¥æ± æŒ‡æ¨™ Gauge.builder(\u0026#34;http.connections.total\u0026#34;) .description(\u0026#34;Total connections in pool\u0026#34;) .register(meterRegistry, this, monitor -\u0026gt; monitor.connectionManager.getTotalStats().getMax()); Gauge.builder(\u0026#34;http.connections.available\u0026#34;) .description(\u0026#34;Available connections in pool\u0026#34;) .register(meterRegistry, this, monitor -\u0026gt; monitor.connectionManager.getTotalStats().getAvailable()); Gauge.builder(\u0026#34;http.connections.leased\u0026#34;) .description(\u0026#34;Leased connections in pool\u0026#34;) .register(meterRegistry, this, monitor -\u0026gt; monitor.connectionManager.getTotalStats().getLeased()); } @EventListener @Async public void logConnectionPoolStats(ApplicationReadyEvent event) { ScheduledExecutorService executor = Executors.newScheduledThreadPool(1); executor.scheduleAtFixedRate(this::logStats, 0, 30, TimeUnit.SECONDS); } private void logStats() { PoolStats totalStats = connectionManager.getTotalStats(); logger.info(\u0026#34;Connection Pool Stats - Total: {}, Available: {}, Leased: {}, Pending: {}\u0026#34;, totalStats.getMax(), totalStats.getAvailable(), totalStats.getLeased(), totalStats.getPending()); } } } 2. éŸ¿æ‡‰æ™‚é–“ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 /** * HTTP è«‹æ±‚ç›£æ§æ””æˆªå™¨ */ @Component public class MetricsInterceptor implements ClientHttpRequestInterceptor { private final MeterRegistry meterRegistry; private final Timer.Builder timerBuilder; public MetricsInterceptor(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.timerBuilder = Timer.builder(\u0026#34;http.client.requests\u0026#34;) .description(\u0026#34;HTTP client request duration\u0026#34;); } @Override public ClientHttpResponse intercept( HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException { Timer.Sample sample = Timer.start(meterRegistry); try { ClientHttpResponse response = execution.execute(request, body); // è¨˜éŒ„æˆåŠŸè«‹æ±‚æŒ‡æ¨™ sample.stop(timerBuilder .tag(\u0026#34;method\u0026#34;, request.getMethod().name()) .tag(\u0026#34;uri\u0026#34;, getUriTemplate(request.getURI())) .tag(\u0026#34;status\u0026#34;, String.valueOf(response.getStatusCode().value())) .tag(\u0026#34;outcome\u0026#34;, getOutcome(response)) .register(meterRegistry)); return response; } catch (IOException e) { // è¨˜éŒ„å¤±æ•—è«‹æ±‚æŒ‡æ¨™ sample.stop(timerBuilder .tag(\u0026#34;method\u0026#34;, request.getMethod().name()) .tag(\u0026#34;uri\u0026#34;, getUriTemplate(request.getURI())) .tag(\u0026#34;status\u0026#34;, \u0026#34;IO_ERROR\u0026#34;) .tag(\u0026#34;outcome\u0026#34;, \u0026#34;ERROR\u0026#34;) .register(meterRegistry)); throw e; } } private String getUriTemplate(URI uri) { String path = uri.getPath(); // ç°¡åŒ–è·¯å¾‘æ¨¡æ¿ï¼ˆç§»é™¤å…·é«” IDï¼‰ return path.replaceAll(\u0026#34;/\\\\d+\u0026#34;, \u0026#34;/{id}\u0026#34;); } private String getOutcome(ClientHttpResponse response) throws IOException { HttpStatus status = response.getStatusCode(); if (status.is2xxSuccessful()) { return \u0026#34;SUCCESS\u0026#34;; } else if (status.is4xxClientError()) { return \u0026#34;CLIENT_ERROR\u0026#34;; } else if (status.is5xxServerError()) { return \u0026#34;SERVER_ERROR\u0026#34;; } else { return \u0026#34;UNKNOWN\u0026#34;; } } } 3. å¿«å–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 /** * å¸¶å¿«å–çš„ REST å®¢æˆ¶ç«¯ */ @Service public class CachedRestClientService { private final RestTemplate restTemplate; private final CacheManager cacheManager; public CachedRestClientService(@Qualifier(\u0026#34;standardRestTemplate\u0026#34;) RestTemplate restTemplate, CacheManager cacheManager) { this.restTemplate = restTemplate; this.cacheManager = cacheManager; } /** * å¸¶å¿«å–çš„ç”¨æˆ¶æŸ¥è©¢ */ @Cacheable(value = \u0026#34;users\u0026#34;, key = \u0026#34;#userId\u0026#34;, unless = \u0026#34;#result == null\u0026#34;) public User getUserById(Long userId) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; return restTemplate.getForObject(url, User.class, userId); } /** * å¿«å–å¤±æ•ˆæ›´æ–° */ @CacheEvict(value = \u0026#34;users\u0026#34;, key = \u0026#34;#userId\u0026#34;) public User updateUser(Long userId, User updatedUser) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); HttpEntity\u0026lt;User\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(updatedUser, headers); ResponseEntity\u0026lt;User\u0026gt; response = restTemplate.exchange( url, HttpMethod.PUT, request, User.class, userId); return response.getBody(); } /** * æ¢ä»¶å¿«å–ï¼šåŸºæ–¼éŸ¿æ‡‰é ­çš„å¿«å–ç­–ç•¥ */ public User getUserWithConditionalCache(Long userId) { String url = \u0026#34;https://api.example.com/users/{id}\u0026#34;; // æª¢æŸ¥å¿«å– Cache cache = cacheManager.getCache(\u0026#34;users\u0026#34;); Cache.ValueWrapper cachedValue = cache.get(userId); HttpHeaders headers = new HttpHeaders(); if (cachedValue != null) { CachedUser cachedUser = (CachedUser) cachedValue.get(); // æ·»åŠ  If-None-Match é ­ headers.set(\u0026#34;If-None-Match\u0026#34;, cachedUser.getEtag()); } HttpEntity\u0026lt;String\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(headers); try { ResponseEntity\u0026lt;User\u0026gt; response = restTemplate.exchange( url, HttpMethod.GET, request, User.class, userId); // æ›´æ–°å¿«å– String etag = response.getHeaders().getETag(); if (etag != null) { CachedUser cachedUser = new CachedUser(response.getBody(), etag); cache.put(userId, cachedUser); } return response.getBody(); } catch (HttpClientErrorException e) { if (e.getStatusCode() == HttpStatus.NOT_MODIFIED \u0026amp;\u0026amp; cachedValue != null) { // è¿”å›å¿«å–çš„å€¼ return ((CachedUser) cachedValue.get()).getUser(); } throw e; } } private static class CachedUser { private final User user; private final String etag; public CachedUser(User user, String etag) { this.user = user; this.etag = etag; } public User getUser() { return user; } public String getEtag() { return etag; } } } æ¸¬è©¦ç­–ç•¥ 1. å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 /** * RestTemplate å–®å…ƒæ¸¬è©¦ */ @ExtendWith(MockitoExtension.class) class RestClientServiceTest { @Mock private RestTemplate restTemplate; @InjectMocks private RestClientService restClientService; private MockRestServiceServer mockServer; private ObjectMapper objectMapper; @BeforeEach void setUp() { mockServer = MockRestServiceServer.createServer(restTemplate); objectMapper = new ObjectMapper(); } @Test @DisplayName(\u0026#34;æˆåŠŸç²å–ç”¨æˆ¶è³‡è¨Š\u0026#34;) void testGetUserById_Success() throws JsonProcessingException { // Given Long userId = 1L; User expectedUser = new User(userId, \u0026#34;john@example.com\u0026#34;, \u0026#34;John\u0026#34;, \u0026#34;Doe\u0026#34;); String expectedJson = objectMapper.writeValueAsString(expectedUser); mockServer.expect(requestTo(\u0026#34;https://api.example.com/users/1\u0026#34;)) .andExpect(method(HttpMethod.GET)) .andRespond(withSuccess(expectedJson, MediaType.APPLICATION_JSON)); // When User actualUser = restClientService.getUserById(userId); // Then mockServer.verify(); assertThat(actualUser).isNotNull(); assertThat(actualUser.getId()).isEqualTo(userId); assertThat(actualUser.getEmail()).isEqualTo(\u0026#34;john@example.com\u0026#34;); } @Test @DisplayName(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨æ™‚æ‹‹å‡ºç•°å¸¸\u0026#34;) void testGetUserById_NotFound() { // Given Long userId = 999L; mockServer.expect(requestTo(\u0026#34;https://api.example.com/users/999\u0026#34;)) .andExpect(method(HttpMethod.GET)) .andRespond(withStatus(HttpStatus.NOT_FOUND)); // When \u0026amp; Then assertThatThrownBy(() -\u0026gt; restClientService.getUserById(userId)) .isInstanceOf(NotFoundException.class); mockServer.verify(); } @Test @DisplayName(\u0026#34;å¸¶æœ‰æŸ¥è©¢åƒæ•¸çš„ GET è«‹æ±‚\u0026#34;) void testGetUsersByDepartment() throws JsonProcessingException { // Given String department = \u0026#34;IT\u0026#34;; int page = 0; int size = 10; List\u0026lt;User\u0026gt; expectedUsers = Arrays.asList( new User(1L, \u0026#34;john@example.com\u0026#34;, \u0026#34;John\u0026#34;, \u0026#34;Doe\u0026#34;), new User(2L, \u0026#34;jane@example.com\u0026#34;, \u0026#34;Jane\u0026#34;, \u0026#34;Smith\u0026#34;) ); String expectedJson = objectMapper.writeValueAsString(expectedUsers); mockServer.expect(requestTo(containsString(\u0026#34;https://api.example.com/users\u0026#34;))) .andExpect(queryParam(\u0026#34;department\u0026#34;, \u0026#34;IT\u0026#34;)) .andExpect(queryParam(\u0026#34;page\u0026#34;, \u0026#34;0\u0026#34;)) .andExpect(queryParam(\u0026#34;size\u0026#34;, \u0026#34;10\u0026#34;)) .andExpect(method(HttpMethod.GET)) .andRespond(withSuccess(expectedJson, MediaType.APPLICATION_JSON)); // When List\u0026lt;User\u0026gt; actualUsers = restClientService.getUsersByDepartment(department, page, size); // Then mockServer.verify(); assertThat(actualUsers).hasSize(2); } @Test @DisplayName(\u0026#34;POST è«‹æ±‚å‰µå»ºç”¨æˆ¶\u0026#34;) void testCreateUser() throws JsonProcessingException { // Given User newUser = new User(null, \u0026#34;bob@example.com\u0026#34;, \u0026#34;Bob\u0026#34;, \u0026#34;Johnson\u0026#34;); User createdUser = new User(3L, \u0026#34;bob@example.com\u0026#34;, \u0026#34;Bob\u0026#34;, \u0026#34;Johnson\u0026#34;); String requestJson = objectMapper.writeValueAsString(newUser); String responseJson = objectMapper.writeValueAsString(createdUser); mockServer.expect(requestTo(\u0026#34;https://api.example.com/users\u0026#34;)) .andExpect(method(HttpMethod.POST)) .andExpect(content().json(requestJson)) .andExpected(header(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;)) .andRespond(withSuccess(responseJson, MediaType.APPLICATION_JSON)); // When User actualUser = restClientService.createUser(newUser); // Then mockServer.verify(); assertThat(actualUser.getId()).isEqualTo(3L); assertThat(actualUser.getEmail()).isEqualTo(\u0026#34;bob@example.com\u0026#34;); } @Test @DisplayName(\u0026#34;æœå‹™å™¨éŒ¯èª¤æ™‚çš„é‡è©¦æ©Ÿåˆ¶\u0026#34;) void testRetryOnServerError() { // Given Long userId = 1L; mockServer.expect(times(3), requestTo(\u0026#34;https://api.example.com/users/1\u0026#34;)) .andExpect(method(HttpMethod.GET)) .andRespond(withServerError()); // When \u0026amp; Then assertThatThrownBy(() -\u0026gt; restClientService.getUserById(userId)) .isInstanceOf(ServerErrorException.class); mockServer.verify(); } } 2. æ•´åˆæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 /** * RestTemplate æ•´åˆæ¸¬è©¦ */ @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) @TestPropertySource(locations = \u0026#34;classpath:application-integration-test.properties\u0026#34;) class RestClientIntegrationTest { @Autowired private RestClientService restClientService; @Autowired private TestRestTemplate testRestTemplate; @MockBean private RestTemplate restTemplate; private WireMockServer wireMockServer; @BeforeEach void setUp() { wireMockServer = new WireMockServer(wireMockConfig().port(8089)); wireMockServer.start(); configureFor(\u0026#34;localhost\u0026#34;, 8089); } @AfterEach void tearDown() { wireMockServer.stop(); } @Test @DisplayName(\u0026#34;å®Œæ•´çš„ç”¨æˆ¶ç®¡ç†æµç¨‹\u0026#34;) void testCompleteUserManagementFlow() throws JsonProcessingException { ObjectMapper objectMapper = new ObjectMapper(); // 1. æ¨¡æ“¬å‰µå»ºç”¨æˆ¶ API User newUser = new User(null, \u0026#34;integration@example.com\u0026#34;, \u0026#34;Integration\u0026#34;, \u0026#34;Test\u0026#34;); User createdUser = new User(1L, \u0026#34;integration@example.com\u0026#34;, \u0026#34;Integration\u0026#34;, \u0026#34;Test\u0026#34;); stubFor(post(urlEqualTo(\u0026#34;/api/users\u0026#34;)) .willReturn(aResponse() .withStatus(201) .withHeader(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;) .withBody(objectMapper.writeValueAsString(createdUser)))); // 2. æ¨¡æ“¬ç²å–ç”¨æˆ¶ API stubFor(get(urlEqualTo(\u0026#34;/api/users/1\u0026#34;)) .willReturn(aResponse() .withStatus(200) .withHeader(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;) .withBody(objectMapper.writeValueAsString(createdUser)))); // 3. æ¨¡æ“¬æ›´æ–°ç”¨æˆ¶ API User updatedUser = new User(1L, \u0026#34;updated@example.com\u0026#34;, \u0026#34;Updated\u0026#34;, \u0026#34;User\u0026#34;); stubFor(put(urlEqualTo(\u0026#34;/api/users/1\u0026#34;)) .willReturn(aResponse() .withStatus(200) .withHeader(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;) .withBody(objectMapper.writeValueAsString(updatedUser)))); // 4. æ¨¡æ“¬åˆªé™¤ç”¨æˆ¶ API stubFor(delete(urlEqualTo(\u0026#34;/api/users/1\u0026#34;)) .willReturn(aResponse().withStatus(204))); // åŸ·è¡Œæ¸¬è©¦æµç¨‹ // å‰µå»ºç”¨æˆ¶ User created = restClientService.createUser(newUser); assertThat(created.getId()).isEqualTo(1L); // ç²å–ç”¨æˆ¶ User retrieved = restClientService.getUserById(1L); assertThat(retrieved.getEmail()).isEqualTo(\u0026#34;integration@example.com\u0026#34;); // æ›´æ–°ç”¨æˆ¶ User updated = restClientService.updateUser(1L, updatedUser); assertThat(updated.getEmail()).isEqualTo(\u0026#34;updated@example.com\u0026#34;); // åˆªé™¤ç”¨æˆ¶ assertDoesNotThrow(() -\u0026gt; restClientService.deleteUser(1L)); // é©—è­‰æ‰€æœ‰è«‹æ±‚éƒ½è¢«èª¿ç”¨ verify(postRequestedFor(urlEqualTo(\u0026#34;/api/users\u0026#34;))); verify(getRequestedFor(urlEqualTo(\u0026#34;/api/users/1\u0026#34;))); verify(putRequestedFor(urlEqualTo(\u0026#34;/api/users/1\u0026#34;))); verify(deleteRequestedFor(urlEqualTo(\u0026#34;/api/users/1\u0026#34;))); } @Test @DisplayName(\u0026#34;éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶\u0026#34;) void testErrorHandlingAndRetry() { // æ¨¡æ“¬æœå‹™å™¨éŒ¯èª¤ï¼Œç„¶å¾ŒæˆåŠŸ stubFor(get(urlEqualTo(\u0026#34;/api/users/1\u0026#34;)) .inScenario(\u0026#34;Retry Scenario\u0026#34;) .whenScenarioStateIs(STARTED) .willSetStateTo(\u0026#34;First Attempt\u0026#34;) .willReturn(aResponse().withStatus(500))); stubFor(get(urlEqualTo(\u0026#34;/api/users/1\u0026#34;)) .inScenario(\u0026#34;Retry Scenario\u0026#34;) .whenScenarioStateIs(\u0026#34;First Attempt\u0026#34;) .willSetStateTo(\u0026#34;Second Attempt\u0026#34;) .willReturn(aResponse().withStatus(500))); stubFor(get(urlEqualTo(\u0026#34;/api/users/1\u0026#34;)) .inScenario(\u0026#34;Retry Scenario\u0026#34;) .whenScenarioStateIs(\u0026#34;Second Attempt\u0026#34;) .willReturn(aResponse() .withStatus(200) .withHeader(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/json\u0026#34;) .withBody(\u0026#34;{\\\u0026#34;id\\\u0026#34;:1,\\\u0026#34;email\\\u0026#34;:\\\u0026#34;test@example.com\\\u0026#34;}\u0026#34;))); // åŸ·è¡Œæ¸¬è©¦ User user = restClientService.getUserById(1L); assertThat(user.getId()).isEqualTo(1L); // é©—è­‰é‡è©¦äº† 3 æ¬¡ verify(3, getRequestedFor(urlEqualTo(\u0026#34;/api/users/1\u0026#34;))); } } ç¾ä»£åŒ–æ›¿ä»£æ–¹æ¡ˆ 1. WebClient é·ç§»æŒ‡å— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 /** * WebClient é·ç§»ç¯„ä¾‹ */ @Service public class ModernRestClientService { private final WebClient webClient; public ModernRestClientService(WebClient.Builder webClientBuilder) { this.webClient = webClientBuilder .baseUrl(\u0026#34;https://api.example.com\u0026#34;) .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE) .build(); } /** * ç•°æ­¥ GET è«‹æ±‚ */ public Mono\u0026lt;User\u0026gt; getUserByIdAsync(Long userId) { return webClient.get() .uri(\u0026#34;/users/{id}\u0026#34;, userId) .retrieve() .bodyToMono(User.class); } /** * éŸ¿æ‡‰å¼ POST è«‹æ±‚ */ public Mono\u0026lt;User\u0026gt; createUserAsync(User newUser) { return webClient.post() .uri(\u0026#34;/users\u0026#34;) .bodyValue(newUser) .retrieve() .bodyToMono(User.class); } /** * éŒ¯èª¤è™•ç† */ public Mono\u0026lt;User\u0026gt; getUserWithErrorHandling(Long userId) { return webClient.get() .uri(\u0026#34;/users/{id}\u0026#34;, userId) .retrieve() .onStatus(HttpStatus::is4xxClientError, response -\u0026gt; Mono.error(new NotFoundException(\u0026#34;User not found\u0026#34;))) .onStatus(HttpStatus::is5xxServerError, response -\u0026gt; Mono.error(new ServerErrorException(\u0026#34;Server error\u0026#34;))) .bodyToMono(User.class); } /** * æµå¼è™•ç† */ public Flux\u0026lt;User\u0026gt; getAllUsersStream() { return webClient.get() .uri(\u0026#34;/users/stream\u0026#34;) .retrieve() .bodyToFlux(User.class); } } 2. RestTemplate vs WebClient å°æ¯” ç‰¹æ€§ RestTemplate WebClient API é¢¨æ ¼ åŒæ­¥é˜»å¡ ç•°æ­¥éé˜»å¡ éŸ¿æ‡‰å¼æ”¯æ´ ä¸æ”¯æ´ å®Œæ•´æ”¯æ´ æ•ˆèƒ½ ä¸­ç­‰ é«˜ è¨˜æ†¶é«”ä½¿ç”¨ è¼ƒé«˜ è¼ƒä½ èƒŒå£“è™•ç† ä¸æ”¯æ´ æ”¯æ´ Spring 5+ æ”¯æ´ ç¶­è­·æ¨¡å¼ ä¸»æ¨æ–¹æ¡ˆ å­¸ç¿’æ›²ç·š è¼ƒä½ è¼ƒé«˜ æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. é…ç½®æœ€ä½³å¯¦è¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 /** * RestTemplate æœ€ä½³å¯¦è¸é…ç½® */ @Configuration public class RestTemplateBestPractices { /** * ç”Ÿç”¢ç’°å¢ƒæ¨è–¦é…ç½® */ @Bean @Primary public RestTemplate productionRestTemplate() { // 1. ä½¿ç”¨é€£æ¥æ±  PoolingHttpClientConnectionManager connectionManager = new PoolingHttpClientConnectionManager(); connectionManager.setMaxTotal(200); connectionManager.setDefaultMaxPerRoute(50); connectionManager.setValidateAfterInactivity(2000); // 2. é…ç½®è¶…æ™‚ RequestConfig requestConfig = RequestConfig.custom() .setConnectionRequestTimeout(5000) .setConnectTimeout(5000) .setSocketTimeout(30000) .build(); // 3. é…ç½®é‡è©¦ HttpRequestRetryHandler retryHandler = new DefaultHttpRequestRetryHandler(3, true); // 4. é…ç½® Keep-Alive ConnectionKeepAliveStrategy keepAliveStrategy = (response, context) -\u0026gt; 30 * 1000; CloseableHttpClient httpClient = HttpClients.custom() .setConnectionManager(connectionManager) .setDefaultRequestConfig(requestConfig) .setRetryHandler(retryHandler) .setKeepAliveStrategy(keepAliveStrategy) .build(); HttpComponentsClientHttpRequestFactory factory = new HttpComponentsClientHttpRequestFactory(httpClient); RestTemplate restTemplate = new RestTemplate(factory); // 5. æ·»åŠ æ””æˆªå™¨ restTemplate.setInterceptors(Arrays.asList( new LoggingInterceptor(), new MetricsInterceptor(meterRegistry), new AuthenticationInterceptor(tokenService) )); // 6. è¨­ç½®éŒ¯èª¤è™•ç†å™¨ restTemplate.setErrorHandler(new CustomResponseErrorHandler()); return restTemplate; } /** * å¸¸è¦‹éŒ¯èª¤å’Œè§£æ±ºæ–¹æ¡ˆ */ public void demonstrateCommonPitfalls() { // âŒ éŒ¯èª¤ï¼šæœªè¨­ç½®è¶…æ™‚ RestTemplate badTemplate = new RestTemplate(); // âœ… æ­£ç¢ºï¼šè¨­ç½®åˆç†çš„è¶…æ™‚ SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory(); factory.setConnectTimeout(5000); factory.setReadTimeout(30000); RestTemplate goodTemplate = new RestTemplate(factory); // âŒ éŒ¯èª¤ï¼šæœªä½¿ç”¨é€£æ¥æ±  // æ¯æ¬¡è«‹æ±‚éƒ½å‰µå»ºæ–°é€£æ¥ // âœ… æ­£ç¢ºï¼šä½¿ç”¨é€£æ¥æ± å¾©ç”¨é€£æ¥ // è¦‹ä¸Šé¢çš„ç”Ÿç”¢ç’°å¢ƒé…ç½® // âŒ éŒ¯èª¤ï¼šæœªè™•ç†ç•°å¸¸ try { String result = badTemplate.getForObject(\u0026#34;http://api.example.com/data\u0026#34;, String.class); } catch (Exception e) { // ç›´æ¥å¿½ç•¥ç•°å¸¸ } // âœ… æ­£ç¢ºï¼šé©ç•¶çš„ç•°å¸¸è™•ç† try { String result = goodTemplate.getForObject(\u0026#34;http://api.example.com/data\u0026#34;, String.class); } catch (ResourceAccessException e) { logger.error(\u0026#34;Network error\u0026#34;, e); throw new ServiceUnavailableException(\u0026#34;Service temporarily unavailable\u0026#34;); } catch (HttpClientErrorException e) { logger.error(\u0026#34;Client error: {}\u0026#34;, e.getStatusCode(), e); throw new BadRequestException(\u0026#34;Invalid request\u0026#34;); } } } 2. å®‰å…¨æ€§è€ƒé‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 /** * RestTemplate å®‰å…¨é…ç½® */ @Configuration public class SecureRestTemplateConfig { /** * HTTPS é…ç½® */ @Bean public RestTemplate secureRestTemplate() throws Exception { TrustStrategy acceptingTrustStrategy = (X509Certificate[] chain, String authType) -\u0026gt; true; SSLContext sslContext = org.apache.http.ssl.SSLContexts.custom() .loadTrustMaterial(null, acceptingTrustStrategy) .build(); SSLConnectionSocketFactory csf = new SSLConnectionSocketFactory(sslContext); CloseableHttpClient httpClient = HttpClients.custom() .setSSLSocketFactory(csf) .build(); HttpComponentsClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory(); requestFactory.setHttpClient(httpClient); return new RestTemplate(requestFactory); } /** * èªè­‰é…ç½® */ @Component public class SecureAuthInterceptor implements ClientHttpRequestInterceptor { @Override public ClientHttpResponse intercept( HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException { // 1. æ·»åŠ  API Key request.getHeaders().set(\u0026#34;X-API-Key\u0026#34;, getApiKey()); // 2. æ·»åŠ è«‹æ±‚ç°½å String signature = generateSignature(request, body); request.getHeaders().set(\u0026#34;X-Signature\u0026#34;, signature); // 3. æ·»åŠ æ™‚é–“æˆ³é˜²é‡æ”¾ request.getHeaders().set(\u0026#34;X-Timestamp\u0026#34;, String.valueOf(System.currentTimeMillis())); return execution.execute(request, body); } private String getApiKey() { // å¾å®‰å…¨é…ç½®ä¸­ç²å– API Key return securityConfig.getApiKey(); } private String generateSignature(HttpRequest request, byte[] body) { // å¯¦ä½œè«‹æ±‚ç°½åé‚è¼¯ return hmacSha256(request.getURI() + new String(body), getSecretKey()); } } } ç¸½çµ RestTemplate ä½œç‚º Spring ç”Ÿæ…‹ç³»çµ±ä¸­çš„ç¶“å…¸ HTTP å®¢æˆ¶ç«¯ï¼Œæä¾›äº†è±å¯Œçš„åŠŸèƒ½å’Œè‰¯å¥½çš„æ“´å±•æ€§ï¼š\nä¸»è¦å„ªå‹¢ ç°¡å–®æ˜“ç”¨ï¼šç›´è§€çš„ API è¨­è¨ˆï¼Œæ˜“æ–¼ä¸Šæ‰‹ åŠŸèƒ½å®Œæ•´ï¼šæ”¯æ´æ‰€æœ‰ HTTP æ–¹æ³•å’Œè±å¯Œçš„é…ç½®é¸é … Spring æ•´åˆï¼šèˆ‡ Spring æ¡†æ¶å®Œç¾æ•´åˆ æ“´å±•æ€§å¥½ï¼šæ”¯æ´æ””æˆªå™¨ã€éŒ¯èª¤è™•ç†å™¨ç­‰æ“´å±•æ©Ÿåˆ¶ ç©©å®šæˆç†Ÿï¼šç¶“éé•·æœŸé©—è­‰ï¼Œç©©å®šå¯é  é©ç”¨å ´æ™¯ å‚³çµ± Spring æ‡‰ç”¨ï¼šééŸ¿æ‡‰å¼æ‡‰ç”¨çš„ HTTP å®¢æˆ¶ç«¯éœ€æ±‚ å¾®æœå‹™é€šä¿¡ï¼šæœå‹™é–“çš„åŒæ­¥èª¿ç”¨ ç¬¬ä¸‰æ–¹ API æ•´åˆï¼šèª¿ç”¨å¤–éƒ¨ REST API éºç•™ç³»çµ±ç¶­è­·ï¼šç¾æœ‰ç³»çµ±çš„ç¶­è­·å’Œå‡ç´š é·ç§»å»ºè­° é›–ç„¶ RestTemplate åœ¨ç¶­è­·æ¨¡å¼ï¼Œä½†å°æ–¼ä»¥ä¸‹æƒ…æ³å»ºè­°é·ç§»åˆ° WebClientï¼š\næ–°é …ç›®é–‹ç™¼ï¼šä½¿ç”¨ WebClient ç²å¾—æ›´å¥½çš„æ•ˆèƒ½ é«˜ä¸¦ç™¼éœ€æ±‚ï¼šWebClient çš„éé˜»å¡ç‰¹æ€§æ›´é©åˆ éŸ¿æ‡‰å¼ç¨‹å¼è¨­è¨ˆï¼šéœ€è¦éŸ¿æ‡‰å¼æµçš„å ´æ™¯ æ•ˆèƒ½æ•æ„Ÿï¼šå°æ•ˆèƒ½æœ‰è¼ƒé«˜è¦æ±‚çš„æ‡‰ç”¨ é€šéåˆç†çš„é…ç½®å’Œæœ€ä½³å¯¦è¸ï¼ŒRestTemplate ä»ç„¶æ˜¯ä¸€å€‹å¯é çš„ HTTP å®¢æˆ¶ç«¯é¸æ“‡ï¼Œç‰¹åˆ¥æ˜¯åœ¨ç¾æœ‰é …ç›®çš„ç¶­è­·å’Œæ¼¸é€²å¼å‡ç´šå ´æ™¯ä¸­ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/resttemplate/","tags":["Spring","RestTemplate","HTTP Client","WebClient","REST API","Microservices","Error Handling","Testing","Performance"],"title":"Spring RestTemplate å®Œæ•´å¯¦æˆ°æŒ‡å—ï¼šHTTP å®¢æˆ¶ç«¯æœ€ä½³å¯¦è¸"},{"content":"å‰è¨€ åœ¨ç¾ä»£è»Ÿé«”é–‹ç™¼ä¸­ï¼Œè¨­å®šæª”æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€ç’°ã€‚å¾ Java çš„ Spring Boot æ¡†æ¶ (Spring MVC éå¾€ä½¿ç”¨å¤§é‡çš„ XML)ï¼Œåˆ°æˆ‘ç›®å‰ä½¿ç”¨çš„ Hugo éœæ…‹ç¶²ç«™ç”¢ç”Ÿå™¨ï¼Œéƒ½èƒ½çœ‹åˆ° .propertiesã€.yml æˆ– .toml ç­‰æ ¼å¼çš„èº«å½±ã€‚\né›–ç„¶é€™äº›æ ¼å¼å„æœ‰å„ªå‹¢ï¼Œä½†åœ¨é›²åŸç”Ÿé ˜åŸŸï¼Œç‰¹åˆ¥æ˜¯è¨­å®š Kubernetes (K8s) è³‡æºæ™‚ï¼ŒYAML (YAML Ain\u0026rsquo;t Markup Language) å·²æˆç‚ºäº‹å¯¦ä¸Šçš„æ¨™æº–ã€‚å› æ­¤ï¼ŒæŒæ¡ YAML çš„èªæ³•è‡³é—œé‡è¦ã€‚\næ ¸å¿ƒèªæ³• YAML çš„è¨­è¨ˆç›®æ¨™æ˜¯æ˜“æ–¼äººé¡é–±è®€å’Œæ’°å¯«ã€‚å®ƒçš„èªæ³•ä¸»è¦åŸºæ–¼ç¸®æ’å’Œå¹¾å€‹ç°¡å–®çš„ç¬¦è™Ÿã€‚\nè¨»è§£: ä½¿ç”¨ # è™Ÿæ¨™ç¤ºå–®è¡Œè¨»è§£ã€‚ æ–‡ä»¶é–‹é ­: ä½¿ç”¨ä¸‰å€‹é€£å­—è™Ÿ --- ä½œç‚ºæ–‡ä»¶çš„é–‹å§‹ç¬¦è™Ÿ (é¸ç”¨)ã€‚ éµå€¼å° (Key-Value Pair) YAML çš„åŸºæœ¬çµ„æˆå–®ä½æ˜¯éµå€¼å°ï¼Œæ ¼å¼ç‚º key: value (æ³¨æ„å†’è™Ÿå¾Œé¢éœ€è¦ä¸€å€‹ç©ºæ ¼)ã€‚\n1 apiVersion: v1 éšå±¤/ç‰©ä»¶ (Objects) é€éæ›è¡Œå’Œç¸®æ’ (å»ºè­°ä½¿ç”¨å…©å€‹ç©ºæ ¼) ä¾†è¡¨ç¤ºéšå±¤é—œä¿‚ã€‚é€™åœ¨ JSON ä¸­ç›¸ç•¶æ–¼ä¸€å€‹ç‰©ä»¶ã€‚\nä»¥ä¸‹ç¯„ä¾‹ç­‰åŒæ–¼ spring.datasource.username = \u0026quot;root\u0026quot;ã€‚\n1 2 3 spring: datasource: username: root é™£åˆ—/åˆ—è¡¨ (Arrays/Lists) é™£åˆ—æœ‰å…©ç¨®å¸¸è¦‹çš„è¡¨ç¤ºæ–¹å¼ï¼š\nå¡Šåºåˆ— (Block Sequence): é€éæ›è¡Œã€ç¸®æ’ï¼Œä¸¦åœ¨æ¯å€‹å…ƒç´ å‰åŠ ä¸Š - (é€£å­—è™Ÿ + ç©ºæ ¼) ä¾†è¡¨ç¤ºã€‚é€™ç¨®å½¢å¼æ›´æ˜“è®€ï¼Œä¸”å…ƒç´ å¯ä»¥æ˜¯è¤‡é›œçš„ç‰©ä»¶ã€‚\n1 2 3 args: - \u0026#34;parameter1\u0026#34; - \u0026#34;parameter2\u0026#34; æµåºåˆ— (Flow Sequence): å°‡æ‰€æœ‰å…ƒç´ æ”¾åœ¨æ–¹æ‹¬è™Ÿ [] ä¸­ï¼Œä¸¦ç”¨é€—è™Ÿåˆ†éš”ã€‚é©åˆè¡¨ç¤ºç°¡å–®çš„ä¸€ç¶­é™£åˆ—ã€‚\n1 2 items: [1, 2, 3, 4, 5] args: [\u0026#34;parameter1\u0026#34;, \u0026#34;parameter2\u0026#34;] ç¶œåˆç¯„ä¾‹ è®“æˆ‘å€‘ä¾†çœ‹ä¸€å€‹æ›´å®Œæ•´çš„ç¯„ä¾‹ï¼Œé€™å€‹ç¯„ä¾‹ä¾†è‡ª CloudBees YAML Tutorialã€‚\nYAML æ ¼å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 --- doe: \u0026#34;a deer, a female deer\u0026#34; ray: \u0026#34;a drop of golden sun\u0026#34; pi: 3.14159 xmas: true french-hens: 3 calling-birds: - huey - dewey - louie - fred xmas-fifth-day: calling-birds: four french-hens: 3 golden-rings: 5 partridges: count: 1 location: \u0026#34;a pear tree\u0026#34; turtle-doves: two ç­‰æ•ˆçš„ JSON æ ¼å¼ é€™å€‹ YAML çµæ§‹å¯ä»¥å®Œå…¨å°æ‡‰åˆ°ä»¥ä¸‹çš„ JSON ç‰©ä»¶ï¼Œå±•ç¤ºäº†å…¶æ¸…æ™°çš„è³‡æ–™è¡¨é”èƒ½åŠ›ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 { \u0026#34;doe\u0026#34;: \u0026#34;a deer, a female deer\u0026#34;, \u0026#34;ray\u0026#34;: \u0026#34;a drop of golden sun\u0026#34;, \u0026#34;pi\u0026#34;: 3.14159, \u0026#34;xmas\u0026#34;: true, \u0026#34;french-hens\u0026#34;: 3, \u0026#34;calling-birds\u0026#34;: [ \u0026#34;huey\u0026#34;, \u0026#34;dewey\u0026#34;, \u0026#34;louie\u0026#34;, \u0026#34;fred\u0026#34; ], \u0026#34;xmas-fifth-day\u0026#34;: { \u0026#34;calling-birds\u0026#34;: \u0026#34;four\u0026#34;, \u0026#34;french-hens\u0026#34;: 3, \u0026#34;golden-rings\u0026#34;: 5, \u0026#34;partridges\u0026#34;: { \u0026#34;count\u0026#34;: 1, \u0026#34;location\u0026#34;: \u0026#34;a pear tree\u0026#34; }, \u0026#34;turtle-doves\u0026#34;: \u0026#34;two\u0026#34; } } åƒè€ƒè³‡æ–™ CloudBees YAML Tutorial èœé³¥æ•™ç¨‹ - YAML ç°¡ä»‹ ","permalink":"https://xinqilin.github.io/post/tools/yaml/","tags":["YAML","Configuration","Kubernetes","Spring Boot","DevOps"],"title":"YAML èªæ³•å¾å…¥é–€åˆ°å¯¦è¸"},{"content":"MergeSort Time complexity = log n * O(n) = O(n logn)\nMergeSort å¥—ä¸€å¥æŸ¯P è¬›çš„è©±ï¼Œå°å•é¡Œè§£æ±ºäº†ï¼Œå°±æ²’æœ‰å¤§å•é¡Œäº†\nå°‡ n å€‹å€‹æ•¸çš„é™£åˆ—ï¼Œå…ˆå·¦å³å„åˆ‡ä¸€åŠï¼Œä¸€ç›´åˆ‡ï¼Œåˆ‡åˆ°æœ€å°å–®ä½å¾Œï¼Œé–‹å§‹æ‹¿å…©æ¢è¢«åˆ‡çš„å–®ä½åšæ’åºã€åˆä½µ ! åˆä¹…å¿…åˆ†ï¼Œåˆ†ä¹…å¿…åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 import java.util.*; public class MergeSort { public static void mergeSort(int[] array) { int[] workArray = new int[array.length]; Sort(array, workArray, 0, array.length - 1); } private static void Sort(int[] array, int[] workArray, int start, int end) { if (start \u0026gt;= end) return; //é¿å…æº¢ä½ start + end å¯èƒ½è¶…å‡ºå» int mid = start + (end - start)/2; Sort(array, workArray, start, mid); Sort(array, workArray, mid+1, end); Merge(array, workArray, start, mid, mid+1, end); } private static void Merge(int[] array, int[] workArray, int leftStart, int leftEnd, int rightStart, int rightEnd) { int leftPtr = leftStart, rightPtr = rightStart, index = leftStart; while (leftPtr \u0026lt;= leftEnd || rightPtr \u0026lt;= rightEnd) { if (leftPtr \u0026lt;= leftEnd \u0026amp;\u0026amp; rightPtr \u0026lt;= rightEnd) { //æœ€å¾Œä¸€æ’ if (array[rightPtr] \u0026lt; array[leftPtr]) workArray[index] = array[rightPtr++]; else workArray[index] = array[leftPtr++]; } else if (leftPtr \u0026lt;= leftEnd){ // å·¦é‚Šæ’åº workArray[index] = array[leftPtr++]; }else{ // å³é‚Šæ’åº workArray[index] = array[rightPtr++]; } ++index; } for (int i = leftStart; i \u0026lt; index; i++) array[i] = workArray[i]; } public static void main(String[] args) { int[] data = new int[10]; for (int i = 0; i \u0026lt; data.length; i++) { data[i] = (int) (Math.random() * 100); } System.out.println(\u0026#34;before: \u0026#34; + Arrays.toString(data)); mergeSort(data); System.out.println(\u0026#34;after: \u0026#34; + Arrays.toString(data)); } } ![MergeSortResult](images/Algorithm/mergeSort/mergeSortResult.png) æ¼”ç®—æ³•åºåˆ—ï¼Œæœƒç”¨ä¾†è¨˜éŒ„ç®—æ³•ï¼Œå†ç”¨è‡ªå·±æˆ–å…¶ä»–äººå¯«çš„ code æˆ‘èƒ½å¸æ”¶çš„åšç´€éŒ„ï¼Œç›®çš„æ˜¯è®“è‡ªå·±èƒ½å¤šçœ‹ï¼Œç„¶å¾ŒèƒŒèµ·ä¾†\n","permalink":"https://xinqilin.github.io/post/algorithm/mergesort/","tags":["Java","Algorithm"],"title":"MergeSort"},{"content":"CQRS (Command Query Responsibility Segregation) å®Œæ•´å¯¦ä½œæŒ‡å— æ¨¡å¼æ¦‚è¿° CQRS (Command Query Responsibility Segregationï¼Œå‘½ä»¤æŸ¥è©¢è·è²¬åˆ†é›¢) æ˜¯ä¸€ç¨®æ¶æ§‹æ¨¡å¼ï¼Œå°‡è®€å–æ“ä½œï¼ˆQueryï¼‰å’Œå¯«å…¥æ“ä½œï¼ˆCommandï¼‰åˆ†é›¢åˆ°ä¸åŒçš„æ¨¡å‹ä¸­ã€‚é€™ç¨®åˆ†é›¢å…è¨±æ¯å€‹æ¨¡å‹é‡å°å…¶ç‰¹å®šç”¨é€”é€²è¡Œå„ªåŒ–ï¼Œæé«˜ç³»çµ±çš„æ“´å±•æ€§å’Œæ€§èƒ½ã€‚\næ ¸å¿ƒæ¦‚å¿µ 1. CQS åŸå‰‡åŸºç¤ CQS (Command Query Separation) åŸå‰‡æ˜¯ CQRS çš„ç†è«–åŸºç¤ï¼š\nCommandï¼ˆå‘½ä»¤ï¼‰ï¼š\næœƒå°ç³»çµ±ç”¢ç”Ÿå½±éŸ¿çš„å‹•ä½œ æ”¹è®Šç³»çµ±ç‹€æ…‹ ä¸å›å‚³çµæœï¼ˆvoidï¼‰ å…·æœ‰å‰¯ä½œç”¨ Queryï¼ˆæŸ¥è©¢ï¼‰ï¼š\nä¸æœƒå°ç³»çµ±ç”¢ç”Ÿå½±éŸ¿çš„å‹•ä½œ ä¸æ”¹è®Šç³»çµ±ç‹€æ…‹ å›å‚³çµæœ ç„¡å‰¯ä½œç”¨ 2. CQRS æ“´å±• CQRS å°‡ CQS åŸå‰‡å¾æ–¹æ³•ç´šåˆ¥æ“´å±•åˆ°æ¶æ§‹ç´šåˆ¥ï¼š\nå¯«å…¥æ¨¡å‹ï¼ˆWrite Modelï¼‰ï¼šå°ˆæ³¨æ–¼æ¥­å‹™é‚è¼¯å’Œæ•¸æ“šä¸€è‡´æ€§ è®€å–æ¨¡å‹ï¼ˆRead Modelï¼‰ï¼šå°ˆæ³¨æ–¼æŸ¥è©¢æ€§èƒ½å’Œæ•¸æ“šå±•ç¤º åˆ†é›¢çš„æ•¸æ“šå­˜å„²ï¼šä¸åŒçš„å­˜å„²å¯ä»¥é‡å°è®€å¯«æ“ä½œé€²è¡Œå„ªåŒ– å‚³çµ± CQRS å¯¦ç¾ 1. åŸºæœ¬æ¶æ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 // å‘½ä»¤æ¥å£ public interface Command { // å‘½ä»¤æ¨™è¨˜æ¥å£ } // æŸ¥è©¢æ¥å£ public interface Query\u0026lt;T\u0026gt; { // æŸ¥è©¢æ¨™è¨˜æ¥å£ } // å‘½ä»¤è™•ç†å™¨æ¥å£ public interface CommandHandler\u0026lt;T extends Command\u0026gt; { void handle(T command); } // æŸ¥è©¢è™•ç†å™¨æ¥å£ public interface QueryHandler\u0026lt;T extends Query\u0026lt;R\u0026gt;, R\u0026gt; { R handle(T query); } // å‘½ä»¤ç¸½ç·š @Component public class CommandBus { private final Map\u0026lt;Class\u0026lt;? extends Command\u0026gt;, CommandHandler\u0026lt;? extends Command\u0026gt;\u0026gt; handlers; public CommandBus(List\u0026lt;CommandHandler\u0026lt;? extends Command\u0026gt;\u0026gt; handlerList) { this.handlers = handlerList.stream() .collect(Collectors.toMap( this::getCommandType, Function.identity() )); } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T extends Command\u0026gt; void send(T command) { CommandHandler\u0026lt;T\u0026gt; handler = (CommandHandler\u0026lt;T\u0026gt;) handlers.get(command.getClass()); if (handler == null) { throw new IllegalArgumentException(\u0026#34;æœªæ‰¾åˆ°å‘½ä»¤è™•ç†å™¨: \u0026#34; + command.getClass()); } handler.handle(command); } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) private Class\u0026lt;? extends Command\u0026gt; getCommandType(CommandHandler\u0026lt;? extends Command\u0026gt; handler) { return (Class\u0026lt;? extends Command\u0026gt;) ((ParameterizedType) handler.getClass() .getGenericInterfaces()[0]).getActualTypeArguments()[0]; } } // æŸ¥è©¢ç¸½ç·š @Component public class QueryBus { private final Map\u0026lt;Class\u0026lt;? extends Query\u0026lt;?\u0026gt;\u0026gt;, QueryHandler\u0026lt;? extends Query\u0026lt;?\u0026gt;, ?\u0026gt;\u0026gt; handlers; public QueryBus(List\u0026lt;QueryHandler\u0026lt;? extends Query\u0026lt;?\u0026gt;, ?\u0026gt;\u0026gt; handlerList) { this.handlers = handlerList.stream() .collect(Collectors.toMap( this::getQueryType, Function.identity() )); } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T extends Query\u0026lt;R\u0026gt;, R\u0026gt; R send(T query) { QueryHandler\u0026lt;T, R\u0026gt; handler = (QueryHandler\u0026lt;T, R\u0026gt;) handlers.get(query.getClass()); if (handler == null) { throw new IllegalArgumentException(\u0026#34;æœªæ‰¾åˆ°æŸ¥è©¢è™•ç†å™¨: \u0026#34; + query.getClass()); } return handler.handle(query); } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) private Class\u0026lt;? extends Query\u0026lt;?\u0026gt;\u0026gt; getQueryType(QueryHandler\u0026lt;? extends Query\u0026lt;?\u0026gt;, ?\u0026gt; handler) { return (Class\u0026lt;? extends Query\u0026lt;?\u0026gt;\u0026gt;) ((ParameterizedType) handler.getClass() .getGenericInterfaces()[0]).getActualTypeArguments()[0]; } } 2. ç”¨æˆ¶ç®¡ç†ç³»çµ±ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 // ç”¨æˆ¶å¯¦é«”ï¼ˆå¯«å…¥æ¨¡å‹ï¼‰ @Entity @Table(name = \u0026#34;users\u0026#34;) public class User { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @Column(nullable = false, unique = true) private String username; @Column(nullable = false) private String password; @Column(nullable = false) private String email; @Enumerated(EnumType.STRING) private UserStatus status; @CreationTimestamp private LocalDateTime createdAt; @UpdateTimestamp private LocalDateTime updatedAt; // æ¥­å‹™æ–¹æ³• public void activate() { this.status = UserStatus.ACTIVE; } public void deactivate() { this.status = UserStatus.INACTIVE; } public void updatePassword(String newPassword) { this.password = newPassword; } // æ§‹é€ å‡½æ•¸ã€getterã€setter ç•¥ } // ç”¨æˆ¶ç‹€æ…‹æšèˆ‰ public enum UserStatus { ACTIVE, INACTIVE, PENDING, BANNED } // ç”¨æˆ¶è®€å–æ¨¡å‹ @Document(collection = \u0026#34;user_views\u0026#34;) public class UserView { @Id private String id; private Long userId; private String username; private String email; private String status; private String createdAt; private String updatedAt; private int totalOrders; private BigDecimal totalSpent; private String lastLoginAt; // æ§‹é€ å‡½æ•¸ã€getterã€setter ç•¥ } // å‰µå»ºç”¨æˆ¶å‘½ä»¤ public class CreateUserCommand implements Command { private final String username; private final String password; private final String email; public CreateUserCommand(String username, String password, String email) { this.username = username; this.password = password; this.email = email; } // Getter æ–¹æ³• public String getUsername() { return username; } public String getPassword() { return password; } public String getEmail() { return email; } } // æ›´æ–°ç”¨æˆ¶å‘½ä»¤ public class UpdateUserCommand implements Command { private final Long userId; private final String email; private final UserStatus status; public UpdateUserCommand(Long userId, String email, UserStatus status) { this.userId = userId; this.email = email; this.status = status; } // Getter æ–¹æ³• public Long getUserId() { return userId; } public String getEmail() { return email; } public UserStatus getStatus() { return status; } } // ç”¨æˆ¶æŸ¥è©¢ public class GetUserQuery implements Query\u0026lt;UserView\u0026gt; { private final Long userId; public GetUserQuery(Long userId) { this.userId = userId; } public Long getUserId() { return userId; } } // ç”¨æˆ¶åˆ—è¡¨æŸ¥è©¢ public class GetUserListQuery implements Query\u0026lt;Page\u0026lt;UserView\u0026gt;\u0026gt; { private final String username; private final UserStatus status; private final Pageable pageable; public GetUserListQuery(String username, UserStatus status, Pageable pageable) { this.username = username; this.status = status; this.pageable = pageable; } // Getter æ–¹æ³• public String getUsername() { return username; } public UserStatus getStatus() { return status; } public Pageable getPageable() { return pageable; } } // å‰µå»ºç”¨æˆ¶å‘½ä»¤è™•ç†å™¨ @Component public class CreateUserCommandHandler implements CommandHandler\u0026lt;CreateUserCommand\u0026gt; { private final UserRepository userRepository; private final PasswordEncoder passwordEncoder; private final ApplicationEventPublisher eventPublisher; public CreateUserCommandHandler(UserRepository userRepository, PasswordEncoder passwordEncoder, ApplicationEventPublisher eventPublisher) { this.userRepository = userRepository; this.passwordEncoder = passwordEncoder; this.eventPublisher = eventPublisher; } @Override @Transactional public void handle(CreateUserCommand command) { // é©—è­‰ç”¨æˆ¶åæ˜¯å¦å·²å­˜åœ¨ if (userRepository.existsByUsername(command.getUsername())) { throw new IllegalArgumentException(\u0026#34;ç”¨æˆ¶åå·²å­˜åœ¨: \u0026#34; + command.getUsername()); } // å‰µå»ºç”¨æˆ¶ User user = new User(); user.setUsername(command.getUsername()); user.setPassword(passwordEncoder.encode(command.getPassword())); user.setEmail(command.getEmail()); user.setStatus(UserStatus.ACTIVE); User savedUser = userRepository.save(user); // ç™¼å¸ƒäº‹ä»¶ eventPublisher.publishEvent(new UserCreatedEvent(savedUser.getId(), savedUser.getUsername(), savedUser.getEmail())); } } // æ›´æ–°ç”¨æˆ¶å‘½ä»¤è™•ç†å™¨ @Component public class UpdateUserCommandHandler implements CommandHandler\u0026lt;UpdateUserCommand\u0026gt; { private final UserRepository userRepository; private final ApplicationEventPublisher eventPublisher; public UpdateUserCommandHandler(UserRepository userRepository, ApplicationEventPublisher eventPublisher) { this.userRepository = userRepository; this.eventPublisher = eventPublisher; } @Override @Transactional public void handle(UpdateUserCommand command) { User user = userRepository.findById(command.getUserId()) .orElseThrow(() -\u0026gt; new IllegalArgumentException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨: \u0026#34; + command.getUserId())); // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯ if (command.getEmail() != null) { user.setEmail(command.getEmail()); } if (command.getStatus() != null) { user.setStatus(command.getStatus()); } userRepository.save(user); // ç™¼å¸ƒäº‹ä»¶ eventPublisher.publishEvent(new UserUpdatedEvent(user.getId(), user.getUsername(), user.getEmail(), user.getStatus())); } } // ç”¨æˆ¶æŸ¥è©¢è™•ç†å™¨ @Component public class GetUserQueryHandler implements QueryHandler\u0026lt;GetUserQuery, UserView\u0026gt; { private final UserViewRepository userViewRepository; public GetUserQueryHandler(UserViewRepository userViewRepository) { this.userViewRepository = userViewRepository; } @Override public UserView handle(GetUserQuery query) { return userViewRepository.findByUserId(query.getUserId()) .orElseThrow(() -\u0026gt; new IllegalArgumentException(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨: \u0026#34; + query.getUserId())); } } // ç”¨æˆ¶åˆ—è¡¨æŸ¥è©¢è™•ç†å™¨ @Component public class GetUserListQueryHandler implements QueryHandler\u0026lt;GetUserListQuery, Page\u0026lt;UserView\u0026gt;\u0026gt; { private final UserViewRepository userViewRepository; public GetUserListQueryHandler(UserViewRepository userViewRepository) { this.userViewRepository = userViewRepository; } @Override public Page\u0026lt;UserView\u0026gt; handle(GetUserListQuery query) { return userViewRepository.findByFilters( query.getUsername(), query.getStatus(), query.getPageable() ); } } 3. äº‹ä»¶é©…å‹•æ¶æ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 // ç”¨æˆ¶å‰µå»ºäº‹ä»¶ public class UserCreatedEvent { private final Long userId; private final String username; private final String email; private final LocalDateTime occurredAt; public UserCreatedEvent(Long userId, String username, String email) { this.userId = userId; this.username = username; this.email = email; this.occurredAt = LocalDateTime.now(); } // Getter æ–¹æ³• public Long getUserId() { return userId; } public String getUsername() { return username; } public String getEmail() { return email; } public LocalDateTime getOccurredAt() { return occurredAt; } } // ç”¨æˆ¶æ›´æ–°äº‹ä»¶ public class UserUpdatedEvent { private final Long userId; private final String username; private final String email; private final UserStatus status; private final LocalDateTime occurredAt; public UserUpdatedEvent(Long userId, String username, String email, UserStatus status) { this.userId = userId; this.username = username; this.email = email; this.status = status; this.occurredAt = LocalDateTime.now(); } // Getter æ–¹æ³• public Long getUserId() { return userId; } public String getUsername() { return username; } public String getEmail() { return email; } public UserStatus getStatus() { return status; } public LocalDateTime getOccurredAt() { return occurredAt; } } // è®€å–æ¨¡å‹æŠ•å½±è™•ç†å™¨ @Component public class UserViewProjectionHandler { private final UserViewRepository userViewRepository; public UserViewProjectionHandler(UserViewRepository userViewRepository) { this.userViewRepository = userViewRepository; } @EventListener @Async public void handle(UserCreatedEvent event) { UserView userView = new UserView(); userView.setUserId(event.getUserId()); userView.setUsername(event.getUsername()); userView.setEmail(event.getEmail()); userView.setStatus(UserStatus.ACTIVE.name()); userView.setCreatedAt(event.getOccurredAt().toString()); userView.setUpdatedAt(event.getOccurredAt().toString()); userView.setTotalOrders(0); userView.setTotalSpent(BigDecimal.ZERO); userViewRepository.save(userView); } @EventListener @Async public void handle(UserUpdatedEvent event) { UserView userView = userViewRepository.findByUserId(event.getUserId()) .orElseThrow(() -\u0026gt; new IllegalStateException(\u0026#34;ç”¨æˆ¶è¦–åœ–ä¸å­˜åœ¨: \u0026#34; + event.getUserId())); userView.setUsername(event.getUsername()); userView.setEmail(event.getEmail()); userView.setStatus(event.getStatus().name()); userView.setUpdatedAt(event.getOccurredAt().toString()); userViewRepository.save(userView); } } äº‹ä»¶æº¯æº (Event Sourcing) æ•´åˆ 1. äº‹ä»¶å­˜å„² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 // äº‹ä»¶åŸºé¡ @MappedSuperclass public abstract class DomainEvent { private String eventId; private String aggregateId; private String eventType; private LocalDateTime occurredAt; private String userId; private long version; protected DomainEvent() { this.eventId = UUID.randomUUID().toString(); this.occurredAt = LocalDateTime.now(); } protected DomainEvent(String aggregateId, String eventType, String userId, long version) { this(); this.aggregateId = aggregateId; this.eventType = eventType; this.userId = userId; this.version = version; } // Getter å’Œ Setter æ–¹æ³• public String getEventId() { return eventId; } public void setEventId(String eventId) { this.eventId = eventId; } public String getAggregateId() { return aggregateId; } public void setAggregateId(String aggregateId) { this.aggregateId = aggregateId; } public String getEventType() { return eventType; } public void setEventType(String eventType) { this.eventType = eventType; } public LocalDateTime getOccurredAt() { return occurredAt; } public void setOccurredAt(LocalDateTime occurredAt) { this.occurredAt = occurredAt; } public String getUserId() { return userId; } public void setUserId(String userId) { this.userId = userId; } public long getVersion() { return version; } public void setVersion(long version) { this.version = version; } } // äº‹ä»¶å­˜å„²å¯¦é«” @Entity @Table(name = \u0026#34;event_store\u0026#34;) public class EventStore { @Id private String eventId; @Column(nullable = false) private String aggregateId; @Column(nullable = false) private String eventType; @Column(nullable = false, columnDefinition = \u0026#34;TEXT\u0026#34;) private String eventData; @Column(nullable = false) private LocalDateTime occurredAt; @Column private String userId; @Column(nullable = false) private long version; // æ§‹é€ å‡½æ•¸ã€getterã€setter ç•¥ } // äº‹ä»¶å­˜å„²å€‰åº« @Repository public interface EventStoreRepository extends JpaRepository\u0026lt;EventStore, String\u0026gt; { List\u0026lt;EventStore\u0026gt; findByAggregateIdOrderByVersionAsc(String aggregateId); List\u0026lt;EventStore\u0026gt; findByAggregateIdAndVersionGreaterThanOrderByVersionAsc(String aggregateId, long version); boolean existsByAggregateIdAndVersion(String aggregateId, long version); } // äº‹ä»¶å­˜å„²æœå‹™ @Service public class EventStoreService { private final EventStoreRepository eventStoreRepository; private final ObjectMapper objectMapper; public EventStoreService(EventStoreRepository eventStoreRepository, ObjectMapper objectMapper) { this.eventStoreRepository = eventStoreRepository; this.objectMapper = objectMapper; } public void saveEvent(DomainEvent event) { try { EventStore eventStore = new EventStore(); eventStore.setEventId(event.getEventId()); eventStore.setAggregateId(event.getAggregateId()); eventStore.setEventType(event.getEventType()); eventStore.setEventData(objectMapper.writeValueAsString(event)); eventStore.setOccurredAt(event.getOccurredAt()); eventStore.setUserId(event.getUserId()); eventStore.setVersion(event.getVersion()); eventStoreRepository.save(eventStore); } catch (JsonProcessingException e) { throw new RuntimeException(\u0026#34;äº‹ä»¶åºåˆ—åŒ–å¤±æ•—\u0026#34;, e); } } public List\u0026lt;DomainEvent\u0026gt; getEvents(String aggregateId) { return eventStoreRepository.findByAggregateIdOrderByVersionAsc(aggregateId) .stream() .map(this::deserializeEvent) .collect(Collectors.toList()); } public List\u0026lt;DomainEvent\u0026gt; getEventsFromVersion(String aggregateId, long version) { return eventStoreRepository.findByAggregateIdAndVersionGreaterThanOrderByVersionAsc(aggregateId, version) .stream() .map(this::deserializeEvent) .collect(Collectors.toList()); } private DomainEvent deserializeEvent(EventStore eventStore) { try { Class\u0026lt;?\u0026gt; eventClass = Class.forName(eventStore.getEventType()); return (DomainEvent) objectMapper.readValue(eventStore.getEventData(), eventClass); } catch (Exception e) { throw new RuntimeException(\u0026#34;äº‹ä»¶ååºåˆ—åŒ–å¤±æ•—\u0026#34;, e); } } } 2. èšåˆæ ¹èˆ‡äº‹ä»¶æº¯æº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 // èšåˆæ ¹åŸºé¡ public abstract class AggregateRoot { private String id; private long version; private final List\u0026lt;DomainEvent\u0026gt; uncommittedEvents = new ArrayList\u0026lt;\u0026gt;(); protected AggregateRoot() { this.id = UUID.randomUUID().toString(); this.version = 0; } protected AggregateRoot(String id) { this.id = id; this.version = 0; } protected void addEvent(DomainEvent event) { event.setAggregateId(this.id); event.setVersion(this.version + 1); this.uncommittedEvents.add(event); } public List\u0026lt;DomainEvent\u0026gt; getUncommittedEvents() { return new ArrayList\u0026lt;\u0026gt;(uncommittedEvents); } public void markEventsAsCommitted() { this.version += uncommittedEvents.size(); this.uncommittedEvents.clear(); } public void loadFromHistory(List\u0026lt;DomainEvent\u0026gt; events) { events.forEach(this::apply); this.version = events.size(); } protected abstract void apply(DomainEvent event); // Getter å’Œ Setter æ–¹æ³• public String getId() { return id; } public long getVersion() { return version; } } // ç”¨æˆ¶èšåˆæ ¹ public class UserAggregate extends AggregateRoot { private String username; private String email; private UserStatus status; private LocalDateTime createdAt; private LocalDateTime updatedAt; public UserAggregate() { super(); } public UserAggregate(String id) { super(id); } // å‰µå»ºç”¨æˆ¶ public static UserAggregate create(String username, String email, String userId) { UserAggregate user = new UserAggregate(); user.addEvent(new UserCreatedDomainEvent(user.getId(), username, email, userId)); return user; } // æ›´æ–°ç”¨æˆ¶ public void updateUser(String email, UserStatus status, String userId) { if (!Objects.equals(this.email, email) || !Objects.equals(this.status, status)) { this.addEvent(new UserUpdatedDomainEvent(this.getId(), this.username, email, status, userId)); } } // åˆªé™¤ç”¨æˆ¶ public void deleteUser(String userId) { this.addEvent(new UserDeletedDomainEvent(this.getId(), this.username, userId)); } @Override protected void apply(DomainEvent event) { if (event instanceof UserCreatedDomainEvent) { apply((UserCreatedDomainEvent) event); } else if (event instanceof UserUpdatedDomainEvent) { apply((UserUpdatedDomainEvent) event); } else if (event instanceof UserDeletedDomainEvent) { apply((UserDeletedDomainEvent) event); } } private void apply(UserCreatedDomainEvent event) { this.username = event.getUsername(); this.email = event.getEmail(); this.status = UserStatus.ACTIVE; this.createdAt = event.getOccurredAt(); this.updatedAt = event.getOccurredAt(); } private void apply(UserUpdatedDomainEvent event) { this.username = event.getUsername(); this.email = event.getEmail(); this.status = event.getStatus(); this.updatedAt = event.getOccurredAt(); } private void apply(UserDeletedDomainEvent event) { this.status = UserStatus.INACTIVE; this.updatedAt = event.getOccurredAt(); } // Getter æ–¹æ³• public String getUsername() { return username; } public String getEmail() { return email; } public UserStatus getStatus() { return status; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } } // ç”¨æˆ¶å‰µå»ºé ˜åŸŸäº‹ä»¶ public class UserCreatedDomainEvent extends DomainEvent { private String username; private String email; public UserCreatedDomainEvent() { super(); } public UserCreatedDomainEvent(String aggregateId, String username, String email, String userId) { super(aggregateId, \u0026#34;UserCreatedDomainEvent\u0026#34;, userId, 1); this.username = username; this.email = email; } // Getter å’Œ Setter æ–¹æ³• public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } } // ç”¨æˆ¶æ›´æ–°é ˜åŸŸäº‹ä»¶ public class UserUpdatedDomainEvent extends DomainEvent { private String username; private String email; private UserStatus status; public UserUpdatedDomainEvent() { super(); } public UserUpdatedDomainEvent(String aggregateId, String username, String email, UserStatus status, String userId) { super(aggregateId, \u0026#34;UserUpdatedDomainEvent\u0026#34;, userId, 1); this.username = username; this.email = email; this.status = status; } // Getter å’Œ Setter æ–¹æ³• public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public UserStatus getStatus() { return status; } public void setStatus(UserStatus status) { this.status = status; } } // ç”¨æˆ¶åˆªé™¤é ˜åŸŸäº‹ä»¶ public class UserDeletedDomainEvent extends DomainEvent { private String username; public UserDeletedDomainEvent() { super(); } public UserDeletedDomainEvent(String aggregateId, String username, String userId) { super(aggregateId, \u0026#34;UserDeletedDomainEvent\u0026#34;, userId, 1); this.username = username; } // Getter å’Œ Setter æ–¹æ³• public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } } ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯ 1. é›»å•†ç³»çµ±å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 // è¨‚å–®èšåˆæ ¹ public class OrderAggregate extends AggregateRoot { private String customerId; private List\u0026lt;OrderItem\u0026gt; items; private BigDecimal totalAmount; private OrderStatus status; private LocalDateTime createdAt; private LocalDateTime updatedAt; public OrderAggregate() { super(); this.items = new ArrayList\u0026lt;\u0026gt;(); this.totalAmount = BigDecimal.ZERO; this.status = OrderStatus.PENDING; } // å‰µå»ºè¨‚å–® public static OrderAggregate create(String customerId, List\u0026lt;OrderItem\u0026gt; items, String userId) { OrderAggregate order = new OrderAggregate(); order.addEvent(new OrderCreatedDomainEvent(order.getId(), customerId, items, userId)); return order; } // æ·»åŠ å•†å“ public void addItem(OrderItem item, String userId) { this.addEvent(new OrderItemAddedDomainEvent(this.getId(), item, userId)); } // ç¢ºèªè¨‚å–® public void confirm(String userId) { if (this.status != OrderStatus.PENDING) { throw new IllegalStateException(\u0026#34;åªæœ‰å¾…è™•ç†çš„è¨‚å–®å¯ä»¥ç¢ºèª\u0026#34;); } this.addEvent(new OrderConfirmedDomainEvent(this.getId(), userId)); } // å–æ¶ˆè¨‚å–® public void cancel(String reason, String userId) { if (this.status == OrderStatus.SHIPPED || this.status == OrderStatus.DELIVERED) { throw new IllegalStateException(\u0026#34;å·²ç™¼è²¨æˆ–å·²é€é”çš„è¨‚å–®ä¸èƒ½å–æ¶ˆ\u0026#34;); } this.addEvent(new OrderCancelledDomainEvent(this.getId(), reason, userId)); } @Override protected void apply(DomainEvent event) { if (event instanceof OrderCreatedDomainEvent) { apply((OrderCreatedDomainEvent) event); } else if (event instanceof OrderItemAddedDomainEvent) { apply((OrderItemAddedDomainEvent) event); } else if (event instanceof OrderConfirmedDomainEvent) { apply((OrderConfirmedDomainEvent) event); } else if (event instanceof OrderCancelledDomainEvent) { apply((OrderCancelledDomainEvent) event); } } private void apply(OrderCreatedDomainEvent event) { this.customerId = event.getCustomerId(); this.items = new ArrayList\u0026lt;\u0026gt;(event.getItems()); this.totalAmount = calculateTotalAmount(); this.status = OrderStatus.PENDING; this.createdAt = event.getOccurredAt(); this.updatedAt = event.getOccurredAt(); } private void apply(OrderItemAddedDomainEvent event) { this.items.add(event.getItem()); this.totalAmount = calculateTotalAmount(); this.updatedAt = event.getOccurredAt(); } private void apply(OrderConfirmedDomainEvent event) { this.status = OrderStatus.CONFIRMED; this.updatedAt = event.getOccurredAt(); } private void apply(OrderCancelledDomainEvent event) { this.status = OrderStatus.CANCELLED; this.updatedAt = event.getOccurredAt(); } private BigDecimal calculateTotalAmount() { return items.stream() .map(item -\u0026gt; item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity()))) .reduce(BigDecimal.ZERO, BigDecimal::add); } // Getter æ–¹æ³• public String getCustomerId() { return customerId; } public List\u0026lt;OrderItem\u0026gt; getItems() { return new ArrayList\u0026lt;\u0026gt;(items); } public BigDecimal getTotalAmount() { return totalAmount; } public OrderStatus getStatus() { return status; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } } // è¨‚å–®é …ç›® public class OrderItem { private String productId; private String productName; private int quantity; private BigDecimal price; public OrderItem(String productId, String productName, int quantity, BigDecimal price) { this.productId = productId; this.productName = productName; this.quantity = quantity; this.price = price; } // Getter å’Œ Setter æ–¹æ³• public String getProductId() { return productId; } public void setProductId(String productId) { this.productId = productId; } public String getProductName() { return productName; } public void setProductName(String productName) { this.productName = productName; } public int getQuantity() { return quantity; } public void setQuantity(int quantity) { this.quantity = quantity; } public BigDecimal getPrice() { return price; } public void setPrice(BigDecimal price) { this.price = price; } } // è¨‚å–®ç‹€æ…‹ public enum OrderStatus { PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED } // è¨‚å–®å‰µå»ºå‘½ä»¤ public class CreateOrderCommand implements Command { private final String customerId; private final List\u0026lt;OrderItem\u0026gt; items; public CreateOrderCommand(String customerId, List\u0026lt;OrderItem\u0026gt; items) { this.customerId = customerId; this.items = items; } // Getter æ–¹æ³• public String getCustomerId() { return customerId; } public List\u0026lt;OrderItem\u0026gt; getItems() { return items; } } // è¨‚å–®ç¢ºèªå‘½ä»¤ public class ConfirmOrderCommand implements Command { private final String orderId; public ConfirmOrderCommand(String orderId) { this.orderId = orderId; } public String getOrderId() { return orderId; } } // è¨‚å–®æŸ¥è©¢ public class GetOrderQuery implements Query\u0026lt;OrderView\u0026gt; { private final String orderId; public GetOrderQuery(String orderId) { this.orderId = orderId; } public String getOrderId() { return orderId; } } // è¨‚å–®è¦–åœ– @Document(collection = \u0026#34;order_views\u0026#34;) public class OrderView { @Id private String id; private String orderId; private String customerId; private String customerName; private List\u0026lt;OrderItemView\u0026gt; items; private BigDecimal totalAmount; private String status; private String createdAt; private String updatedAt; // æ§‹é€ å‡½æ•¸ã€getterã€setter ç•¥ } // è¨‚å–®é …ç›®è¦–åœ– public class OrderItemView { private String productId; private String productName; private int quantity; private BigDecimal price; private BigDecimal subtotal; // æ§‹é€ å‡½æ•¸ã€getterã€setter ç•¥ } 2. åº«å­˜ç®¡ç†ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 // åº«å­˜èšåˆæ ¹ public class InventoryAggregate extends AggregateRoot { private String productId; private int quantity; private int reservedQuantity; private LocalDateTime lastUpdated; public InventoryAggregate() { super(); } // åˆå§‹åŒ–åº«å­˜ public static InventoryAggregate initialize(String productId, int initialQuantity, String userId) { InventoryAggregate inventory = new InventoryAggregate(); inventory.addEvent(new InventoryInitializedDomainEvent(inventory.getId(), productId, initialQuantity, userId)); return inventory; } // å¢åŠ åº«å­˜ public void addStock(int quantity, String reason, String userId) { if (quantity \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;å¢åŠ çš„åº«å­˜æ•¸é‡å¿…é ˆå¤§æ–¼0\u0026#34;); } this.addEvent(new StockAddedDomainEvent(this.getId(), this.productId, quantity, reason, userId)); } // é ç•™åº«å­˜ public void reserveStock(int quantity, String orderId, String userId) { if (quantity \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;é ç•™çš„åº«å­˜æ•¸é‡å¿…é ˆå¤§æ–¼0\u0026#34;); } if (this.quantity - this.reservedQuantity \u0026lt; quantity) { throw new IllegalStateException(\u0026#34;å¯ç”¨åº«å­˜ä¸è¶³\u0026#34;); } this.addEvent(new StockReservedDomainEvent(this.getId(), this.productId, quantity, orderId, userId)); } // ç¢ºèªåº«å­˜æ¶ˆè€— public void confirmStock(int quantity, String orderId, String userId) { if (quantity \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;ç¢ºèªçš„åº«å­˜æ•¸é‡å¿…é ˆå¤§æ–¼0\u0026#34;); } if (this.reservedQuantity \u0026lt; quantity) { throw new IllegalStateException(\u0026#34;é ç•™åº«å­˜ä¸è¶³\u0026#34;); } this.addEvent(new StockConfirmedDomainEvent(this.getId(), this.productId, quantity, orderId, userId)); } // é‡‹æ”¾é ç•™åº«å­˜ public void releaseReservedStock(int quantity, String orderId, String userId) { if (quantity \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;é‡‹æ”¾çš„åº«å­˜æ•¸é‡å¿…é ˆå¤§æ–¼0\u0026#34;); } if (this.reservedQuantity \u0026lt; quantity) { throw new IllegalStateException(\u0026#34;é ç•™åº«å­˜ä¸è¶³\u0026#34;); } this.addEvent(new StockReleasedDomainEvent(this.getId(), this.productId, quantity, orderId, userId)); } @Override protected void apply(DomainEvent event) { if (event instanceof InventoryInitializedDomainEvent) { apply((InventoryInitializedDomainEvent) event); } else if (event instanceof StockAddedDomainEvent) { apply((StockAddedDomainEvent) event); } else if (event instanceof StockReservedDomainEvent) { apply((StockReservedDomainEvent) event); } else if (event instanceof StockConfirmedDomainEvent) { apply((StockConfirmedDomainEvent) event); } else if (event instanceof StockReleasedDomainEvent) { apply((StockReleasedDomainEvent) event); } } private void apply(InventoryInitializedDomainEvent event) { this.productId = event.getProductId(); this.quantity = event.getInitialQuantity(); this.reservedQuantity = 0; this.lastUpdated = event.getOccurredAt(); } private void apply(StockAddedDomainEvent event) { this.quantity += event.getQuantity(); this.lastUpdated = event.getOccurredAt(); } private void apply(StockReservedDomainEvent event) { this.reservedQuantity += event.getQuantity(); this.lastUpdated = event.getOccurredAt(); } private void apply(StockConfirmedDomainEvent event) { this.quantity -= event.getQuantity(); this.reservedQuantity -= event.getQuantity(); this.lastUpdated = event.getOccurredAt(); } private void apply(StockReleasedDomainEvent event) { this.reservedQuantity -= event.getQuantity(); this.lastUpdated = event.getOccurredAt(); } // è¨ˆç®—å¯ç”¨åº«å­˜ public int getAvailableQuantity() { return quantity - reservedQuantity; } // Getter æ–¹æ³• public String getProductId() { return productId; } public int getQuantity() { return quantity; } public int getReservedQuantity() { return reservedQuantity; } public LocalDateTime getLastUpdated() { return lastUpdated; } } // åº«å­˜ç›¸é—œé ˜åŸŸäº‹ä»¶ public class InventoryInitializedDomainEvent extends DomainEvent { private String productId; private int initialQuantity; public InventoryInitializedDomainEvent() { super(); } public InventoryInitializedDomainEvent(String aggregateId, String productId, int initialQuantity, String userId) { super(aggregateId, \u0026#34;InventoryInitializedDomainEvent\u0026#34;, userId, 1); this.productId = productId; this.initialQuantity = initialQuantity; } // Getter å’Œ Setter æ–¹æ³• public String getProductId() { return productId; } public void setProductId(String productId) { this.productId = productId; } public int getInitialQuantity() { return initialQuantity; } public void setInitialQuantity(int initialQuantity) { this.initialQuantity = initialQuantity; } } public class StockAddedDomainEvent extends DomainEvent { private String productId; private int quantity; private String reason; public StockAddedDomainEvent() { super(); } public StockAddedDomainEvent(String aggregateId, String productId, int quantity, String reason, String userId) { super(aggregateId, \u0026#34;StockAddedDomainEvent\u0026#34;, userId, 1); this.productId = productId; this.quantity = quantity; this.reason = reason; } // Getter å’Œ Setter æ–¹æ³• public String getProductId() { return productId; } public void setProductId(String productId) { this.productId = productId; } public int getQuantity() { return quantity; } public void setQuantity(int quantity) { this.quantity = quantity; } public String getReason() { return reason; } public void setReason(String reason) { this.reason = reason; } } public class StockReservedDomainEvent extends DomainEvent { private String productId; private int quantity; private String orderId; public StockReservedDomainEvent() { super(); } public StockReservedDomainEvent(String aggregateId, String productId, int quantity, String orderId, String userId) { super(aggregateId, \u0026#34;StockReservedDomainEvent\u0026#34;, userId, 1); this.productId = productId; this.quantity = quantity; this.orderId = orderId; } // Getter å’Œ Setter æ–¹æ³• public String getProductId() { return productId; } public void setProductId(String productId) { this.productId = productId; } public int getQuantity() { return quantity; } public void setQuantity(int quantity) { this.quantity = quantity; } public String getOrderId() { return orderId; } public void setOrderId(String orderId) { this.orderId = orderId; } } Spring Boot æ•´åˆ 1. é…ç½®é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 @Configuration @EnableAsync @EnableJpaRepositories(basePackages = \u0026#34;com.example.repository\u0026#34;) @EnableMongoRepositories(basePackages = \u0026#34;com.example.readmodel.repository\u0026#34;) public class CqrsConfiguration { @Bean public ObjectMapper objectMapper() { ObjectMapper mapper = new ObjectMapper(); mapper.registerModule(new JavaTimeModule()); mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS); return mapper; } @Bean public ApplicationEventPublisher applicationEventPublisher(ApplicationContext context) { return context; } @Bean public TaskExecutor taskExecutor() { ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(5); executor.setMaxPoolSize(10); executor.setQueueCapacity(25); executor.setThreadNamePrefix(\u0026#34;cqrs-async-\u0026#34;); executor.initialize(); return executor; } } // è³‡æ–™åº«é…ç½® @Configuration public class DatabaseConfiguration { @Primary @Bean @ConfigurationProperties(\u0026#34;spring.datasource\u0026#34;) public DataSource primaryDataSource() { return DataSourceBuilder.create().build(); } @Bean @ConfigurationProperties(\u0026#34;spring.datasource.readonly\u0026#34;) public DataSource readOnlyDataSource() { return DataSourceBuilder.create().build(); } @Primary @Bean public JdbcTemplate primaryJdbcTemplate(@Qualifier(\u0026#34;primaryDataSource\u0026#34;) DataSource dataSource) { return new JdbcTemplate(dataSource); } @Bean public JdbcTemplate readOnlyJdbcTemplate(@Qualifier(\u0026#34;readOnlyDataSource\u0026#34;) DataSource dataSource) { return new JdbcTemplate(dataSource); } } 2. æ§åˆ¶å™¨å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 @RestController @RequestMapping(\u0026#34;/api/users\u0026#34;) public class UserController { private final CommandBus commandBus; private final QueryBus queryBus; public UserController(CommandBus commandBus, QueryBus queryBus) { this.commandBus = commandBus; this.queryBus = queryBus; } @PostMapping public ResponseEntity\u0026lt;ApiResponse\u0026lt;Void\u0026gt;\u0026gt; createUser(@RequestBody @Valid CreateUserRequest request) { try { CreateUserCommand command = new CreateUserCommand( request.getUsername(), request.getPassword(), request.getEmail() ); commandBus.send(command); return ResponseEntity.ok(ApiResponse.\u0026lt;Void\u0026gt;success() .message(\u0026#34;ç”¨æˆ¶å‰µå»ºæˆåŠŸ\u0026#34;) .build()); } catch (Exception e) { return ResponseEntity.badRequest().body(ApiResponse.\u0026lt;Void\u0026gt;failure(\u0026#34;å‰µå»ºç”¨æˆ¶å¤±æ•—\u0026#34;) .error(e.getMessage()) .build()); } } @GetMapping(\u0026#34;/{id}\u0026#34;) public ResponseEntity\u0026lt;ApiResponse\u0026lt;UserView\u0026gt;\u0026gt; getUser(@PathVariable Long id) { try { GetUserQuery query = new GetUserQuery(id); UserView user = queryBus.send(query); return ResponseEntity.ok(ApiResponse.success(user) .message(\u0026#34;ç”¨æˆ¶æŸ¥è©¢æˆåŠŸ\u0026#34;) .build()); } catch (Exception e) { return ResponseEntity.notFound().build(); } } @GetMapping public ResponseEntity\u0026lt;ApiResponse\u0026lt;Page\u0026lt;UserView\u0026gt;\u0026gt;\u0026gt; getUsers( @RequestParam(required = false) String username, @RequestParam(required = false) UserStatus status, @PageableDefault(size = 20) Pageable pageable) { try { GetUserListQuery query = new GetUserListQuery(username, status, pageable); Page\u0026lt;UserView\u0026gt; users = queryBus.send(query); return ResponseEntity.ok(ApiResponse.success(users) .message(\u0026#34;ç”¨æˆ¶åˆ—è¡¨æŸ¥è©¢æˆåŠŸ\u0026#34;) .metadata(\u0026#34;total\u0026#34;, users.getTotalElements()) .metadata(\u0026#34;pages\u0026#34;, users.getTotalPages()) .build()); } catch (Exception e) { return ResponseEntity.badRequest().body(ApiResponse.\u0026lt;Page\u0026lt;UserView\u0026gt;\u0026gt;failure(\u0026#34;æŸ¥è©¢ç”¨æˆ¶åˆ—è¡¨å¤±æ•—\u0026#34;) .error(e.getMessage()) .build()); } } @PutMapping(\u0026#34;/{id}\u0026#34;) public ResponseEntity\u0026lt;ApiResponse\u0026lt;Void\u0026gt;\u0026gt; updateUser(@PathVariable Long id, @RequestBody @Valid UpdateUserRequest request) { try { UpdateUserCommand command = new UpdateUserCommand(id, request.getEmail(), request.getStatus()); commandBus.send(command); return ResponseEntity.ok(ApiResponse.\u0026lt;Void\u0026gt;success() .message(\u0026#34;ç”¨æˆ¶æ›´æ–°æˆåŠŸ\u0026#34;) .build()); } catch (Exception e) { return ResponseEntity.badRequest().body(ApiResponse.\u0026lt;Void\u0026gt;failure(\u0026#34;æ›´æ–°ç”¨æˆ¶å¤±æ•—\u0026#34;) .error(e.getMessage()) .build()); } } } // è«‹æ±‚ DTO public class CreateUserRequest { @NotBlank(message = \u0026#34;ç”¨æˆ¶åä¸èƒ½ç‚ºç©º\u0026#34;) private String username; @NotBlank(message = \u0026#34;å¯†ç¢¼ä¸èƒ½ç‚ºç©º\u0026#34;) @Size(min = 6, message = \u0026#34;å¯†ç¢¼é•·åº¦è‡³å°‘6ä½\u0026#34;) private String password; @NotBlank(message = \u0026#34;éƒµç®±ä¸èƒ½ç‚ºç©º\u0026#34;) @Email(message = \u0026#34;éƒµç®±æ ¼å¼ä¸æ­£ç¢º\u0026#34;) private String email; // æ§‹é€ å‡½æ•¸ã€getterã€setter ç•¥ } public class UpdateUserRequest { @Email(message = \u0026#34;éƒµç®±æ ¼å¼ä¸æ­£ç¢º\u0026#34;) private String email; private UserStatus status; // æ§‹é€ å‡½æ•¸ã€getterã€setter ç•¥ } 3. æ¸¬è©¦å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 @SpringBootTest @Transactional class CqrsIntegrationTest { @Autowired private CommandBus commandBus; @Autowired private QueryBus queryBus; @Autowired private UserRepository userRepository; @Autowired private UserViewRepository userViewRepository; @Test void testCreateAndQueryUser() { // Given CreateUserCommand command = new CreateUserCommand(\u0026#34;testuser\u0026#34;, \u0026#34;password123\u0026#34;, \u0026#34;test@example.com\u0026#34;); // When commandBus.send(command); // Then // é©—è­‰å¯«å…¥æ¨¡å‹ Optional\u0026lt;User\u0026gt; user = userRepository.findByUsername(\u0026#34;testuser\u0026#34;); assertThat(user).isPresent(); assertThat(user.get().getEmail()).isEqualTo(\u0026#34;test@example.com\u0026#34;); assertThat(user.get().getStatus()).isEqualTo(UserStatus.ACTIVE); // ç­‰å¾…ç•°æ­¥æŠ•å½±å®Œæˆ await().atMost(5, TimeUnit.SECONDS).until(() -\u0026gt; { return userViewRepository.findByUserId(user.get().getId()).isPresent(); }); // é©—è­‰è®€å–æ¨¡å‹ GetUserQuery query = new GetUserQuery(user.get().getId()); UserView userView = queryBus.send(query); assertThat(userView.getUsername()).isEqualTo(\u0026#34;testuser\u0026#34;); assertThat(userView.getEmail()).isEqualTo(\u0026#34;test@example.com\u0026#34;); assertThat(userView.getStatus()).isEqualTo(UserStatus.ACTIVE.name()); } @Test void testUpdateUser() { // Given User user = createTestUser(); // When UpdateUserCommand command = new UpdateUserCommand(user.getId(), \u0026#34;updated@example.com\u0026#34;, UserStatus.INACTIVE); commandBus.send(command); // Then User updatedUser = userRepository.findById(user.getId()).orElseThrow(); assertThat(updatedUser.getEmail()).isEqualTo(\u0026#34;updated@example.com\u0026#34;); assertThat(updatedUser.getStatus()).isEqualTo(UserStatus.INACTIVE); // é©—è­‰è®€å–æ¨¡å‹æœ€çµ‚ä¸€è‡´æ€§ await().atMost(5, TimeUnit.SECONDS).until(() -\u0026gt; { UserView userView = userViewRepository.findByUserId(user.getId()).orElse(null); return userView != null \u0026amp;\u0026amp; \u0026#34;updated@example.com\u0026#34;.equals(userView.getEmail()) \u0026amp;\u0026amp; UserStatus.INACTIVE.name().equals(userView.getStatus()); }); } @Test void testUserListQuery() { // Given createTestUser(\u0026#34;user1\u0026#34;, \u0026#34;user1@example.com\u0026#34;, UserStatus.ACTIVE); createTestUser(\u0026#34;user2\u0026#34;, \u0026#34;user2@example.com\u0026#34;, UserStatus.INACTIVE); // When GetUserListQuery query = new GetUserListQuery(null, UserStatus.ACTIVE, PageRequest.of(0, 10)); Page\u0026lt;UserView\u0026gt; result = queryBus.send(query); // Then assertThat(result.getContent()).hasSize(1); assertThat(result.getContent().get(0).getUsername()).isEqualTo(\u0026#34;user1\u0026#34;); assertThat(result.getContent().get(0).getStatus()).isEqualTo(UserStatus.ACTIVE.name()); } private User createTestUser() { return createTestUser(\u0026#34;testuser\u0026#34;, \u0026#34;test@example.com\u0026#34;, UserStatus.ACTIVE); } private User createTestUser(String username, String email, UserStatus status) { User user = new User(); user.setUsername(username); user.setPassword(\u0026#34;password123\u0026#34;); user.setEmail(email); user.setStatus(status); return userRepository.save(user); } } @WebMvcTest(UserController.class) class UserControllerTest { @Autowired private MockMvc mockMvc; @MockBean private CommandBus commandBus; @MockBean private QueryBus queryBus; @Test void testCreateUser() throws Exception { // Given CreateUserRequest request = new CreateUserRequest(\u0026#34;testuser\u0026#34;, \u0026#34;password123\u0026#34;, \u0026#34;test@example.com\u0026#34;); // When \u0026amp; Then mockMvc.perform(post(\u0026#34;/api/users\u0026#34;) .contentType(MediaType.APPLICATION_JSON) .content(objectMapper.writeValueAsString(request))) .andExpect(status().isOk()) .andExpect(jsonPath(\u0026#34;$.success\u0026#34;).value(true)) .andExpect(jsonPath(\u0026#34;$.message\u0026#34;).value(\u0026#34;ç”¨æˆ¶å‰µå»ºæˆåŠŸ\u0026#34;)); verify(commandBus).send(any(CreateUserCommand.class)); } @Test void testGetUser() throws Exception { // Given UserView userView = new UserView(); userView.setUserId(1L); userView.setUsername(\u0026#34;testuser\u0026#34;); userView.setEmail(\u0026#34;test@example.com\u0026#34;); userView.setStatus(UserStatus.ACTIVE.name()); when(queryBus.send(any(GetUserQuery.class))).thenReturn(userView); // When \u0026amp; Then mockMvc.perform(get(\u0026#34;/api/users/1\u0026#34;)) .andExpect(status().isOk()) .andExpect(jsonPath(\u0026#34;$.success\u0026#34;).value(true)) .andExpect(jsonPath(\u0026#34;$.data.username\u0026#34;).value(\u0026#34;testuser\u0026#34;)) .andExpect(jsonPath(\u0026#34;$.data.email\u0026#34;).value(\u0026#34;test@example.com\u0026#34;)); verify(queryBus).send(any(GetUserQuery.class)); } } æ€§èƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. äº‹ä»¶è™•ç†å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 // æ‰¹é‡äº‹ä»¶è™•ç† @Component public class BatchEventProcessor { private final List\u0026lt;DomainEvent\u0026gt; eventBatch = new ArrayList\u0026lt;\u0026gt;(); private final Object lock = new Object(); @Value(\u0026#34;${cqrs.event.batch.size:100}\u0026#34;) private int batchSize; @Value(\u0026#34;${cqrs.event.batch.timeout:5000}\u0026#34;) private long batchTimeout; @Autowired private EventStoreService eventStoreService; @Autowired private ApplicationEventPublisher eventPublisher; @PostConstruct public void initialize() { // å®šæœŸåˆ·æ–°æ‰¹æ¬¡ ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1); scheduler.scheduleAtFixedRate(this::flushBatch, batchTimeout, batchTimeout, TimeUnit.MILLISECONDS); } public void addEvent(DomainEvent event) { synchronized (lock) { eventBatch.add(event); if (eventBatch.size() \u0026gt;= batchSize) { flushBatch(); } } } private void flushBatch() { List\u0026lt;DomainEvent\u0026gt; toProcess; synchronized (lock) { if (eventBatch.isEmpty()) { return; } toProcess = new ArrayList\u0026lt;\u0026gt;(eventBatch); eventBatch.clear(); } // æ‰¹é‡ä¿å­˜äº‹ä»¶ toProcess.forEach(eventStoreService::saveEvent); // æ‰¹é‡ç™¼å¸ƒäº‹ä»¶ toProcess.forEach(eventPublisher::publishEvent); } } // ç•°æ­¥äº‹ä»¶è™•ç† @Component public class AsyncEventHandler { private final ThreadPoolTaskExecutor executor; public AsyncEventHandler() { this.executor = new ThreadPoolTaskExecutor(); this.executor.setCorePoolSize(5); this.executor.setMaxPoolSize(20); this.executor.setQueueCapacity(100); this.executor.setThreadNamePrefix(\u0026#34;async-event-\u0026#34;); this.executor.initialize(); } @EventListener public void handleUserCreated(UserCreatedEvent event) { executor.submit(() -\u0026gt; { try { // ç•°æ­¥è™•ç†ç”¨æˆ¶å‰µå»ºäº‹ä»¶ processUserCreatedEvent(event); } catch (Exception e) { // éŒ¯èª¤è™•ç†å’Œé‡è©¦é‚è¼¯ handleEventProcessingError(event, e); } }); } private void processUserCreatedEvent(UserCreatedEvent event) { // å…·é«”çš„äº‹ä»¶è™•ç†é‚è¼¯ updateUserView(event); sendWelcomeEmail(event); updateStatistics(event); } private void handleEventProcessingError(Object event, Exception e) { // å¯¦ç¾éŒ¯èª¤è™•ç†å’Œé‡è©¦é‚è¼¯ log.error(\u0026#34;äº‹ä»¶è™•ç†å¤±æ•—: \u0026#34; + event.getClass().getSimpleName(), e); } } 2. è®€å¯«åˆ†é›¢å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 // è®€å¯«åˆ†é›¢è·¯ç”± @Component public class DatabaseRouter { private final DataSource writeDataSource; private final DataSource readDataSource; public DatabaseRouter(@Qualifier(\u0026#34;writeDataSource\u0026#34;) DataSource writeDataSource, @Qualifier(\u0026#34;readDataSource\u0026#34;) DataSource readDataSource) { this.writeDataSource = writeDataSource; this.readDataSource = readDataSource; } public DataSource getDataSource(boolean isWrite) { return isWrite ? writeDataSource : readDataSource; } } // å‹•æ…‹æ•¸æ“šæºåˆ‡æ› @Component public class DynamicDataSourceContextHolder { private static final ThreadLocal\u0026lt;Boolean\u0026gt; contextHolder = new ThreadLocal\u0026lt;\u0026gt;(); public static void setWriteDataSource() { contextHolder.set(true); } public static void setReadDataSource() { contextHolder.set(false); } public static boolean isWriteDataSource() { return Boolean.TRUE.equals(contextHolder.get()); } public static void clearDataSourceType() { contextHolder.remove(); } } // è®€å¯«åˆ†é›¢æ””æˆªå™¨ @Component public class ReadWriteSplittingInterceptor implements HandlerInterceptor { @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) { String method = request.getMethod(); if (\u0026#34;GET\u0026#34;.equals(method)) { DynamicDataSourceContextHolder.setReadDataSource(); } else { DynamicDataSourceContextHolder.setWriteDataSource(); } return true; } @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) { DynamicDataSourceContextHolder.clearDataSourceType(); } } ç›£æ§èˆ‡è¨ºæ–· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 // CQRS ç›£æ§ @Component public class CqrsMonitor { private final MeterRegistry meterRegistry; private final Counter commandCounter; private final Counter queryCounter; private final Timer commandTimer; private final Timer queryTimer; public CqrsMonitor(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.commandCounter = Counter.builder(\u0026#34;cqrs.commands\u0026#34;) .description(\u0026#34;Total number of commands processed\u0026#34;) .register(meterRegistry); this.queryCounter = Counter.builder(\u0026#34;cqrs.queries\u0026#34;) .description(\u0026#34;Total number of queries processed\u0026#34;) .register(meterRegistry); this.commandTimer = Timer.builder(\u0026#34;cqrs.command.duration\u0026#34;) .description(\u0026#34;Command processing time\u0026#34;) .register(meterRegistry); this.queryTimer = Timer.builder(\u0026#34;cqrs.query.duration\u0026#34;) .description(\u0026#34;Query processing time\u0026#34;) .register(meterRegistry); } public \u0026lt;T extends Command\u0026gt; void recordCommand(T command, Runnable execution) { commandCounter.increment(Tags.of(\u0026#34;type\u0026#34;, command.getClass().getSimpleName())); commandTimer.recordCallable(() -\u0026gt; { execution.run(); return null; }); } public \u0026lt;T extends Query\u0026lt;R\u0026gt;, R\u0026gt; R recordQuery(T query, Supplier\u0026lt;R\u0026gt; execution) { queryCounter.increment(Tags.of(\u0026#34;type\u0026#34;, query.getClass().getSimpleName())); return queryTimer.recordCallable(execution::get); } } // äº‹ä»¶å­˜å„²ç›£æ§ @Component public class EventStoreMonitor { private final MeterRegistry meterRegistry; private final Counter eventsSaved; private final Counter eventsLoaded; private final Timer saveTimer; private final Timer loadTimer; public EventStoreMonitor(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.eventsSaved = Counter.builder(\u0026#34;eventstore.events.saved\u0026#34;) .description(\u0026#34;Number of events saved to event store\u0026#34;) .register(meterRegistry); this.eventsLoaded = Counter.builder(\u0026#34;eventstore.events.loaded\u0026#34;) .description(\u0026#34;Number of events loaded from event store\u0026#34;) .register(meterRegistry); this.saveTimer = Timer.builder(\u0026#34;eventstore.save.duration\u0026#34;) .description(\u0026#34;Time taken to save events\u0026#34;) .register(meterRegistry); this.loadTimer = Timer.builder(\u0026#34;eventstore.load.duration\u0026#34;) .description(\u0026#34;Time taken to load events\u0026#34;) .register(meterRegistry); } public void recordEventSaved(String eventType) { eventsSaved.increment(Tags.of(\u0026#34;type\u0026#34;, eventType)); } public void recordEventLoaded(String eventType) { eventsLoaded.increment(Tags.of(\u0026#34;type\u0026#34;, eventType)); } public \u0026lt;T\u0026gt; T recordSaveOperation(Supplier\u0026lt;T\u0026gt; operation) { return saveTimer.recordCallable(operation::get); } public \u0026lt;T\u0026gt; T recordLoadOperation(Supplier\u0026lt;T\u0026gt; operation) { return loadTimer.recordCallable(operation::get); } } ç¸½çµ CQRS æ˜¯ä¸€ç¨®å¼·å¤§çš„æ¶æ§‹æ¨¡å¼ï¼Œç‰¹åˆ¥é©ç”¨æ–¼ï¼š\né«˜ä½µç™¼ç³»çµ±ï¼šåˆ†é›¢è®€å¯«æ“ä½œï¼Œæé«˜ç³»çµ±ä¸¦ç™¼èƒ½åŠ› è¤‡é›œæ¥­å‹™é‚è¼¯ï¼šå°‡è¤‡é›œçš„æ¥­å‹™é‚è¼¯èˆ‡æŸ¥è©¢é‚è¼¯åˆ†é›¢ äº‹ä»¶é©…å‹•æ¶æ§‹ï¼šèˆ‡äº‹ä»¶æº¯æºçµåˆï¼Œæ§‹å»ºäº‹ä»¶é©…å‹•çš„ç³»çµ± å¯æ“´å±•ç³»çµ±ï¼šæ”¯æŒè®€å¯«æ¨¡å‹çš„ç¨ç«‹æ“´å±• é—œéµæœ€ä½³å¯¦è¸ äº‹ä»¶è¨­è¨ˆï¼šè¨­è¨ˆæ¸…æ™°çš„äº‹ä»¶çµæ§‹å’Œäº‹ä»¶ç‰ˆæœ¬æ§åˆ¶ æœ€çµ‚ä¸€è‡´æ€§ï¼šæ¥å—ä¸¦è™•ç†æœ€çµ‚ä¸€è‡´æ€§çš„æŒ‘æˆ° ç›£æ§å‘Šè­¦ï¼šå¯¦æ–½å®Œå–„çš„ç›£æ§å’Œå‘Šè­¦æ©Ÿåˆ¶ éŒ¯èª¤è™•ç†ï¼šè¨­è¨ˆå¥å£¯çš„éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶ æ€§èƒ½å„ªåŒ–ï¼šå¯¦æ–½è®€å¯«åˆ†é›¢ã€æ‰¹é‡è™•ç†ç­‰å„ªåŒ–ç­–ç•¥ æ¸¬è©¦ç­–ç•¥ï¼šå»ºç«‹å…¨é¢çš„æ¸¬è©¦ç­–ç•¥ï¼ŒåŒ…æ‹¬äº‹ä»¶é‡æ’­æ¸¬è©¦ CQRS çµåˆäº‹ä»¶æº¯æºç‚ºä¼æ¥­ç´šæ‡‰ç”¨æä¾›äº†å¼·å¤§çš„æ¶æ§‹åŸºç¤ï¼Œèƒ½å¤ æœ‰æ•ˆè™•ç†è¤‡é›œçš„æ¥­å‹™å ´æ™¯å’Œé«˜ä¸¦ç™¼éœ€æ±‚ã€‚æ­£ç¢ºå¯¦æ–½ CQRS å¯ä»¥å¤§å¹…æå‡ç³»çµ±çš„å¯ç¶­è­·æ€§ã€å¯æ“´å±•æ€§å’Œæ€§èƒ½ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/cqrs/","tags":["Architecture","CQRS","Command Query Responsibility Segregation","Event Sourcing","Microservices","Domain-Driven Design","Spring Boot","Enterprise Architecture","Scalability","Performance","Event-Driven Architecture","Eventual Consistency","Read Write Separation"],"title":"CQRS (Command Query Responsibility Segregation) å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šå‘½ä»¤èˆ‡æŸ¥è©¢è·è²¬åˆ†é›¢çš„ä¼æ¥­æ¶æ§‹æ¨¡å¼"},{"content":"æ¦‚è¿° åœ¨ Java ç¨‹å¼é–‹ç™¼ä¸­ï¼Œç¶“å¸¸éœ€è¦å° Map é›†åˆæŒ‰ç…§ Value å€¼é€²è¡Œæ’åºã€‚Map æœ¬èº«ä¸¦ä¸ä¿è­‰å…ƒç´ çš„é †åºï¼Œå› æ­¤éœ€è¦æ¡ç”¨ç‰¹å®šçš„æŠ€è¡“ä¾†å¯¦ç¾æŒ‰ Value æ’åºã€‚æœ¬æ–‡å°‡æ·±å…¥ä»‹ç´¹å¤šç¨®å¯¦ä½œæ–¹å¼ï¼Œä¸¦åˆ†æå…¶æ•ˆèƒ½ç‰¹å¾µå’Œé©ç”¨å ´æ™¯ã€‚\næ ¸å¿ƒæ¦‚å¿µ Map æ’åºç‰¹æ€§ï¼šMap æ¥å£æœ¬èº«ä¸æä¾›æ’åºåŠŸèƒ½ æ’åºç­–ç•¥ï¼šé€šéè½‰æ›ç‚º List æˆ–ä½¿ç”¨ Stream API å¯¦ç¾ æ’åºç©©å®šæ€§ï¼šä¿æŒç›¸ç­‰å…ƒç´ çš„ç›¸å°é †åº æ•ˆèƒ½è€ƒé‡ï¼šæ™‚é–“è¤‡é›œåº¦å’Œç©ºé–“è¤‡é›œåº¦çš„æ¬Šè¡¡ å¸¸è¦‹æ‡‰ç”¨å ´æ™¯ çµ±è¨ˆæ’åï¼šå­—é »çµ±è¨ˆã€ç”¨æˆ¶è©•åˆ†æ’åº è³‡æ–™åˆ†æï¼šéŠ·å”®æ•¸æ“šæ’åºã€æ•ˆèƒ½æŒ‡æ¨™æ’å å¿«å–ç®¡ç†ï¼šLRU å¿«å–çš„ç†±é»è³‡æ–™æ’åº æœå°‹çµæœï¼šç›¸é—œæ€§å¾—åˆ†æ’åº å¯¦ä½œæ–¹æ³•ä¸€ï¼šCollections.sort + Map.Entry 1. åŸºç¤å¯¦ä½œ é€™æ˜¯æœ€å‚³çµ±ä¸”ç›´è§€çš„æ–¹æ³•ï¼Œé€šéå°‡ Map çš„ entrySet è½‰æ›ç‚º List é€²è¡Œæ’åºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package com.example.sorting; import java.util.*; import java.util.stream.Collectors; public class MapSortingExample { public static void main(String[] args) { // å‰µå»ºæ¸¬è©¦è³‡æ–™ Map\u0026lt;String, Integer\u0026gt; wordFrequency = createSampleData(); // æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Collections.sort æ’åº Map\u0026lt;String, Integer\u0026gt; sortedByValue = sortByValueUsingCollections(wordFrequency); System.out.println(\u0026#34;æ’åºçµæœ: \u0026#34; + sortedByValue); } /** * ä½¿ç”¨ Collections.sort æŒ‰ Value æ’åºï¼ˆé™åºï¼‰ */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortByValueUsingCollections(Map\u0026lt;K, V\u0026gt; map) { // å°‡ Map çš„ entrySet è½‰æ›ç‚º List List\u0026lt;Map.Entry\u0026lt;K, V\u0026gt;\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(map.entrySet()); // ä½¿ç”¨ Collections.sort æ’åº Collections.sort(list, new Comparator\u0026lt;Map.Entry\u0026lt;K, V\u0026gt;\u0026gt;() { @Override public int compare(Map.Entry\u0026lt;K, V\u0026gt; entry1, Map.Entry\u0026lt;K, V\u0026gt; entry2) { // é™åºæ’åˆ—ï¼šentry2 - entry1 return entry2.getValue().compareTo(entry1.getValue()); } }); // å°‡æ’åºå¾Œçš„çµæœæ”¾å…¥ LinkedHashMap ä¿æŒé †åº Map\u0026lt;K, V\u0026gt; sortedMap = new LinkedHashMap\u0026lt;\u0026gt;(); for (Map.Entry\u0026lt;K, V\u0026gt; entry : list) { sortedMap.put(entry.getKey(), entry.getValue()); } return sortedMap; } /** * å‰µå»ºæ¸¬è©¦è³‡æ–™ */ private static Map\u0026lt;String, Integer\u0026gt; createSampleData() { Map\u0026lt;String, Integer\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;apple\u0026#34;, 10); map.put(\u0026#34;banana\u0026#34;, 25); map.put(\u0026#34;cherry\u0026#34;, 5); map.put(\u0026#34;date\u0026#34;, 15); map.put(\u0026#34;elderberry\u0026#34;, 30); return map; } } 2. Lambda è¡¨é”å¼ç°¡åŒ–ç‰ˆæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 /** * ä½¿ç”¨ Lambda è¡¨é”å¼ç°¡åŒ–æ¯”è¼ƒå™¨ */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortByValueWithLambda(Map\u0026lt;K, V\u0026gt; map) { List\u0026lt;Map.Entry\u0026lt;K, V\u0026gt;\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(map.entrySet()); // Lambda è¡¨é”å¼ç°¡åŒ–æ¯”è¼ƒå™¨ Collections.sort(list, (entry1, entry2) -\u0026gt; entry2.getValue().compareTo(entry1.getValue()) ); Map\u0026lt;K, V\u0026gt; sortedMap = new LinkedHashMap\u0026lt;\u0026gt;(); for (Map.Entry\u0026lt;K, V\u0026gt; entry : list) { sortedMap.put(entry.getKey(), entry.getValue()); } return sortedMap; } /** * æ›´ç°¡æ½”çš„ Lambda ç‰ˆæœ¬ï¼Œæ”¯æ´å‡åº/é™åº */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortByValue( Map\u0026lt;K, V\u0026gt; map, boolean ascending) { List\u0026lt;Map.Entry\u0026lt;K, V\u0026gt;\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(map.entrySet()); if (ascending) { Collections.sort(list, Map.Entry.comparingByValue()); } else { Collections.sort(list, Map.Entry.\u0026lt;K, V\u0026gt;comparingByValue().reversed()); } return list.stream() .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } å¯¦ä½œæ–¹æ³•äºŒï¼šStream API 1. åŸºç¤ Stream æ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 /** * ä½¿ç”¨ Stream API é€²è¡Œæ’åº */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortByValueUsingStream( Map\u0026lt;K, V\u0026gt; map, boolean ascending) { return map.entrySet() .stream() .sorted(ascending ? Map.Entry.comparingByValue() : Map.Entry.\u0026lt;K, V\u0026gt;comparingByValue().reversed()) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } /** * æ”¯æ´è‡ªè¨‚æ¯”è¼ƒå™¨çš„ Stream æ’åº */ public static \u0026lt;K, V\u0026gt; Map\u0026lt;K, V\u0026gt; sortByValueWithCustomComparator( Map\u0026lt;K, V\u0026gt; map, Comparator\u0026lt;V\u0026gt; valueComparator) { return map.entrySet() .stream() .sorted(Map.Entry.comparingByValue(valueComparator)) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } 2. ä¸¦è¡Œ Stream æ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 /** * ä½¿ç”¨ä¸¦è¡Œ Stream æå‡å¤§è³‡æ–™é›†çš„æ’åºæ•ˆèƒ½ */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortByValueParallel( Map\u0026lt;K, V\u0026gt; map, boolean ascending) { return map.entrySet() .parallelStream() .sorted(ascending ? Map.Entry.comparingByValue() : Map.Entry.\u0026lt;K, V\u0026gt;comparingByValue().reversed()) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } å¯¦ä½œæ–¹æ³•ä¸‰ï¼šä½¿ç”¨ TreeMap 1. Value-to-Key åè½‰ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 /** * ä½¿ç”¨ TreeMap å¯¦ç¾æŒ‰ Value æ’åº * æ³¨æ„ï¼šæ­¤æ–¹æ³•é©ç”¨æ–¼ Value å€¼å”¯ä¸€çš„æƒ…æ³ */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortByValueUsingTreeMap(Map\u0026lt;K, V\u0026gt; map) { // å‰µå»ºä¸€å€‹ä»¥ Value ç‚º Key çš„ TreeMap TreeMap\u0026lt;V, K\u0026gt; reversedMap = new TreeMap\u0026lt;\u0026gt;(Collections.reverseOrder()); for (Map.Entry\u0026lt;K, V\u0026gt; entry : map.entrySet()) { reversedMap.put(entry.getValue(), entry.getKey()); } // é‡æ–°æ§‹å»ºåŸå§‹æ ¼å¼çš„ Map Map\u0026lt;K, V\u0026gt; sortedMap = new LinkedHashMap\u0026lt;\u0026gt;(); for (Map.Entry\u0026lt;V, K\u0026gt; entry : reversedMap.entrySet()) { sortedMap.put(entry.getValue(), entry.getKey()); } return sortedMap; } /** * è™•ç†é‡è¤‡ Value çš„ TreeMap æ’åº */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortByValueWithDuplicates(Map\u0026lt;K, V\u0026gt; map) { // ä½¿ç”¨ TreeMapï¼ŒKey ç‚ºè¤‡åˆéµï¼šValue + åŸå§‹Key TreeMap\u0026lt;String, Map.Entry\u0026lt;K, V\u0026gt;\u0026gt; sortedTreeMap = new TreeMap\u0026lt;\u0026gt;((key1, key2) -\u0026gt; { String[] parts1 = key1.split(\u0026#34;###\u0026#34;); String[] parts2 = key2.split(\u0026#34;###\u0026#34;); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value1 = (V) parts1[0]; @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value2 = (V) parts2[0]; int valueComparison = value2.compareTo(value1); // é™åº if (valueComparison != 0) { return valueComparison; } return parts1[1].compareTo(parts2[1]); // æŒ‰åŸå§‹ Key æ’åº }); for (Map.Entry\u0026lt;K, V\u0026gt; entry : map.entrySet()) { String compositeKey = entry.getValue() + \u0026#34;###\u0026#34; + entry.getKey(); sortedTreeMap.put(compositeKey, entry); } Map\u0026lt;K, V\u0026gt; result = new LinkedHashMap\u0026lt;\u0026gt;(); for (Map.Entry\u0026lt;K, V\u0026gt; entry : sortedTreeMap.values()) { result.put(entry.getKey(), entry.getValue()); } return result; } å¯¦ä½œæ–¹æ³•å››ï¼šKey List æ’åº 1. åŸºæ–¼ Key çš„é–“æ¥æ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /** * é€šéæ’åº Key åˆ—è¡¨å¯¦ç¾é–“æ¥æ’åº * é©ç”¨æ–¼éœ€è¦ä¿ç•™åŸå§‹ Map çš„å ´æ™¯ */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; List\u0026lt;K\u0026gt; sortKeysByValue( Map\u0026lt;K, V\u0026gt; map, boolean ascending) { List\u0026lt;K\u0026gt; keys = new ArrayList\u0026lt;\u0026gt;(map.keySet()); Collections.sort(keys, (key1, key2) -\u0026gt; { V value1 = map.get(key1); V value2 = map.get(key2); if (ascending) { return value1.compareTo(value2); } else { return value2.compareTo(value1); } }); return keys; } /** * ä½¿ç”¨æ’åºå¾Œçš„ Key åˆ—è¡¨å‰µå»ºæ–°çš„æœ‰åº Map */ public static \u0026lt;K, V\u0026gt; Map\u0026lt;K, V\u0026gt; createSortedMapFromKeys(Map\u0026lt;K, V\u0026gt; originalMap, List\u0026lt;K\u0026gt; sortedKeys) { Map\u0026lt;K, V\u0026gt; sortedMap = new LinkedHashMap\u0026lt;\u0026gt;(); for (K key : sortedKeys) { sortedMap.put(key, originalMap.get(key)); } return sortedMap; } è¤‡é›œæ’åºå ´æ™¯ 1. å¤šç´šæ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** * å¤šç´šæ’åºï¼šå…ˆæŒ‰ Value æ’åºï¼ŒValue ç›¸åŒæ™‚æŒ‰ Key æ’åº */ public static \u0026lt;K extends Comparable\u0026lt;K\u0026gt;, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; multiLevelSort(Map\u0026lt;K, V\u0026gt; map) { return map.entrySet() .stream() .sorted(Map.Entry.\u0026lt;K, V\u0026gt;comparingByValue().reversed() .thenComparing(Map.Entry.comparingByKey())) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } 2. è‡ªè¨‚ç‰©ä»¶æ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 /** * è‡ªè¨‚ç‰©ä»¶ä½œç‚º Value çš„æ’åº */ public static class ScoreData implements Comparable\u0026lt;ScoreData\u0026gt; { private final int score; private final String level; public ScoreData(int score, String level) { this.score = score; this.level = level; } @Override public int compareTo(ScoreData other) { int scoreComparison = Integer.compare(other.score, this.score); // åˆ†æ•¸é™åº if (scoreComparison != 0) { return scoreComparison; } return this.level.compareTo(other.level); // ç­‰ç´šå‡åº } // getter, setter, toString æ–¹æ³• public int getScore() { return score; } public String getLevel() { return level; } @Override public String toString() { return String.format(\u0026#34;ScoreData{score=%d, level=\u0026#39;%s\u0026#39;}\u0026#34;, score, level); } } /** * æ’åºåŒ…å«è‡ªè¨‚ç‰©ä»¶çš„ Map */ public static Map\u0026lt;String, ScoreData\u0026gt; sortByScoreData(Map\u0026lt;String, ScoreData\u0026gt; map) { return map.entrySet() .stream() .sorted(Map.Entry.comparingByValue()) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } æ•ˆèƒ½åˆ†æèˆ‡æ¯”è¼ƒ 1. æ•ˆèƒ½æ¸¬è©¦æ¡†æ¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package com.example.performance; import java.util.*; import java.util.concurrent.TimeUnit; public class MapSortingPerformanceTest { private static final int[] DATA_SIZES = {1000, 10000, 100000, 1000000}; public static void main(String[] args) { System.out.println(\u0026#34;Map Sorting Performance Comparison\u0026#34;); System.out.println(\u0026#34;=====================================\u0026#34;); for (int size : DATA_SIZES) { System.out.printf(\u0026#34;\\nTesting with %d elements:\\n\u0026#34;, size); Map\u0026lt;String, Integer\u0026gt; testData = generateTestData(size); runPerformanceTest(\u0026#34;Collections.sort\u0026#34;, testData, MapSortingExample::sortByValueUsingCollections); runPerformanceTest(\u0026#34;Stream API\u0026#34;, testData, map -\u0026gt; sortByValueUsingStream(map, false)); runPerformanceTest(\u0026#34;Parallel Stream\u0026#34;, testData, map -\u0026gt; sortByValueParallel(map, false)); } } private static void runPerformanceTest(String method, Map\u0026lt;String, Integer\u0026gt; data, SortingFunction\u0026lt;String, Integer\u0026gt; sortFunction) { // é ç†± for (int i = 0; i \u0026lt; 3; i++) { sortFunction.sort(new HashMap\u0026lt;\u0026gt;(data)); } // æ­£å¼æ¸¬è©¦ long startTime = System.nanoTime(); Map\u0026lt;String, Integer\u0026gt; result = sortFunction.sort(new HashMap\u0026lt;\u0026gt;(data)); long endTime = System.nanoTime(); long duration = TimeUnit.NANOSECONDS.toMillis(endTime - startTime); System.out.printf(\u0026#34; %-15s: %4d ms (result size: %d)\\n\u0026#34;, method, duration, result.size()); } private static Map\u0026lt;String, Integer\u0026gt; generateTestData(int size) { Map\u0026lt;String, Integer\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); Random random = new Random(42); // å›ºå®šç¨®å­ç¢ºä¿å¯é‡ç¾æ€§ for (int i = 0; i \u0026lt; size; i++) { String key = \u0026#34;key\u0026#34; + i; Integer value = random.nextInt(1000); map.put(key, value); } return map; } @FunctionalInterface interface SortingFunction\u0026lt;K, V\u0026gt; { Map\u0026lt;K, V\u0026gt; sort(Map\u0026lt;K, V\u0026gt; map); } } 2. æ•ˆèƒ½åˆ†æçµæœ æ–¹æ³• æ™‚é–“è¤‡é›œåº¦ ç©ºé–“è¤‡é›œåº¦ é©ç”¨å ´æ™¯ Collections.sort O(n log n) O(n) å°åˆ°ä¸­å‹è³‡æ–™é›†ï¼Œéœ€è¦ç©©å®šæ’åº Stream API O(n log n) O(n) å‡½æ•¸å¼ç¨‹å¼è¨­è¨ˆé¢¨æ ¼ï¼Œç¨‹å¼ç¢¼ç°¡æ½” Parallel Stream O(n log n) O(n) å¤§å‹è³‡æ–™é›†ï¼Œå¤šæ ¸å¿ƒè™•ç†å™¨ TreeMap åè½‰ O(n log n) O(n) Value å€¼å”¯ä¸€ï¼Œéœ€è¦æŒçºŒæœ‰åº 3. è¨˜æ†¶é«”ä½¿ç”¨åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * è¨˜æ†¶é«”ä½¿ç”¨ç›£æ§å·¥å…· */ public class MemoryAnalyzer { public static void analyzeMemoryUsage(String testName, Runnable test) { System.gc(); // å»ºè­°åƒåœ¾å›æ”¶ Runtime runtime = Runtime.getRuntime(); long beforeMemory = runtime.totalMemory() - runtime.freeMemory(); test.run(); long afterMemory = runtime.totalMemory() - runtime.freeMemory(); long memoryUsed = afterMemory - beforeMemory; System.out.printf(\u0026#34;%s - Memory used: %.2f MB\\n\u0026#34;, testName, memoryUsed / (1024.0 * 1024.0)); } } å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹ 1. å­—é »çµ±è¨ˆå’Œæ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 /** * æ–‡æœ¬å­—é »çµ±è¨ˆèˆ‡æ’åºæ‡‰ç”¨ */ public class WordFrequencyAnalyzer { /** * çµ±è¨ˆæ–‡æœ¬ä¸­çš„å­—é »ä¸¦æ’åº */ public static Map\u0026lt;String, Integer\u0026gt; analyzeWordFrequency(String text, int topN) { // æ–‡æœ¬é è™•ç†å’Œå­—é »çµ±è¨ˆ Map\u0026lt;String, Integer\u0026gt; wordCount = Arrays.stream(text.toLowerCase() .replaceAll(\u0026#34;[^a-zA-Z\\\\s]\u0026#34;, \u0026#34;\u0026#34;) .split(\u0026#34;\\\\s+\u0026#34;)) .filter(word -\u0026gt; !word.isEmpty()) .collect(Collectors.toMap( word -\u0026gt; word, word -\u0026gt; 1, Integer::sum, HashMap::new )); // æŒ‰é »ç‡æ’åºä¸¦å–å‰ N å€‹ return wordCount.entrySet() .stream() .sorted(Map.Entry.\u0026lt;String, Integer\u0026gt;comparingByValue().reversed()) .limit(topN) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } public static void main(String[] args) { String sampleText = \u0026#34;The quick brown fox jumps over the lazy dog. \u0026#34; + \u0026#34;The dog was really lazy and the fox was very quick.\u0026#34;; Map\u0026lt;String, Integer\u0026gt; topWords = analyzeWordFrequency(sampleText, 5); System.out.println(\u0026#34;Top 5 most frequent words:\u0026#34;); topWords.forEach((word, count) -\u0026gt; System.out.printf(\u0026#34; %s: %d times\\n\u0026#34;, word, count)); } } 2. ä½¿ç”¨è€…è©•åˆ†æ’åºç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 /** * ä½¿ç”¨è€…è©•åˆ†æ’åºç³»çµ± */ public class UserRatingSystem { public static class UserRating { private final String userId; private final double averageRating; private final int totalReviews; public UserRating(String userId, double averageRating, int totalReviews) { this.userId = userId; this.averageRating = averageRating; this.totalReviews = totalReviews; } public double getWeightedScore() { // åŠ æ¬Šè©•åˆ†ï¼šè€ƒæ…®è©•è«–æ•¸é‡ return averageRating * Math.log(totalReviews + 1); } // getter æ–¹æ³• public String getUserId() { return userId; } public double getAverageRating() { return averageRating; } public int getTotalReviews() { return totalReviews; } @Override public String toString() { return String.format(\u0026#34;UserRating{userId=\u0026#39;%s\u0026#39;, avgRating=%.2f, reviews=%d, weighted=%.2f}\u0026#34;, userId, averageRating, totalReviews, getWeightedScore()); } } /** * æ ¹æ“šåŠ æ¬Šè©•åˆ†æ’åºç”¨æˆ¶ */ public static Map\u0026lt;String, UserRating\u0026gt; sortUsersByRating(Map\u0026lt;String, UserRating\u0026gt; users) { return users.entrySet() .stream() .sorted(Map.Entry.\u0026lt;String, UserRating\u0026gt;comparingByValue( (r1, r2) -\u0026gt; Double.compare(r2.getWeightedScore(), r1.getWeightedScore()))) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } public static void main(String[] args) { Map\u0026lt;String, UserRating\u0026gt; users = new HashMap\u0026lt;\u0026gt;(); users.put(\u0026#34;user1\u0026#34;, new UserRating(\u0026#34;user1\u0026#34;, 4.5, 100)); users.put(\u0026#34;user2\u0026#34;, new UserRating(\u0026#34;user2\u0026#34;, 4.8, 50)); users.put(\u0026#34;user3\u0026#34;, new UserRating(\u0026#34;user3\u0026#34;, 4.2, 200)); users.put(\u0026#34;user4\u0026#34;, new UserRating(\u0026#34;user4\u0026#34;, 4.9, 25)); Map\u0026lt;String, UserRating\u0026gt; sortedUsers = sortUsersByRating(users); System.out.println(\u0026#34;Users sorted by weighted rating:\u0026#34;); sortedUsers.values().forEach(System.out::println); } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. é¸æ“‡åˆé©çš„æ’åºæ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 /** * æ’åºæ–¹æ³•é¸æ“‡æŒ‡å— */ public class SortingMethodSelector { /** * æ ¹æ“šè³‡æ–™ç‰¹å¾µé¸æ“‡æœ€ä½³æ’åºæ–¹æ³• */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; smartSort( Map\u0026lt;K, V\u0026gt; map, SortingContext context) { int size = map.size(); // å°è³‡æ–™é›†ï¼šä½¿ç”¨ Collections.sort if (size \u0026lt; 1000) { return sortByValueUsingCollections(map); } // å¤§è³‡æ–™é›†ä¸”æœ‰å¤šæ ¸å¿ƒï¼šä½¿ç”¨ä¸¦è¡Œ Stream if (size \u0026gt; 100000 \u0026amp;\u0026amp; context.isParallelProcessingAvailable()) { return sortByValueParallel(map, context.isAscending()); } // ä¸­ç­‰è³‡æ–™é›†ï¼šä½¿ç”¨ Stream API return sortByValueUsingStream(map, context.isAscending()); } public static class SortingContext { private final boolean ascending; private final boolean parallelProcessingAvailable; public SortingContext(boolean ascending, boolean parallelProcessingAvailable) { this.ascending = ascending; this.parallelProcessingAvailable = parallelProcessingAvailable; } public boolean isAscending() { return ascending; } public boolean isParallelProcessingAvailable() { return parallelProcessingAvailable; } } } 2. é¿å…å¸¸è¦‹é™·é˜± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 /** * å¸¸è¦‹éŒ¯èª¤å’Œè§£æ±ºæ–¹æ¡ˆ */ public class CommonPitfalls { /** * éŒ¯èª¤ï¼šä½¿ç”¨ HashMap å„²å­˜æ’åºçµæœï¼ˆæœƒä¸Ÿå¤±é †åºï¼‰ */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; wrongApproach(Map\u0026lt;K, V\u0026gt; map) { // âŒ éŒ¯èª¤ï¼šHashMap ä¸ä¿è­‰é †åº return map.entrySet() .stream() .sorted(Map.Entry.comparingByValue()) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, HashMap::new // âŒ é€™è£¡æ‡‰è©²ä½¿ç”¨ LinkedHashMap )); } /** * æ­£ç¢ºï¼šä½¿ç”¨ LinkedHashMap ä¿æŒé †åº */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; correctApproach(Map\u0026lt;K, V\u0026gt; map) { // âœ… æ­£ç¢ºï¼šLinkedHashMap ä¿æŒæ’å…¥é †åº return map.entrySet() .stream() .sorted(Map.Entry.comparingByValue()) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new // âœ… æ­£ç¢º )); } /** * è™•ç† null å€¼çš„æ’åº */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortWithNulls(Map\u0026lt;K, V\u0026gt; map) { return map.entrySet() .stream() .sorted(Map.Entry.comparingByValue( Comparator.nullsLast(Comparator.naturalOrder()))) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } } 3. åŸ·è¡Œç·’å®‰å…¨è€ƒé‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /** * åŸ·è¡Œç·’å®‰å…¨çš„ Map æ’åº */ public class ThreadSafeSorting { /** * å° ConcurrentHashMap é€²è¡Œå®‰å…¨æ’åº */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortConcurrentMap( ConcurrentHashMap\u0026lt;K, V\u0026gt; concurrentMap) { // å‰µå»ºå¿«ç…§é¿å…ä½µç™¼ä¿®æ”¹ Map\u0026lt;K, V\u0026gt; snapshot = new HashMap\u0026lt;\u0026gt;(concurrentMap); return snapshot.entrySet() .stream() .sorted(Map.Entry.comparingByValue()) .collect(Collectors.toMap( Map.Entry::getKey, Map.Entry::getValue, (oldValue, newValue) -\u0026gt; oldValue, LinkedHashMap::new )); } /** * è¿”å›åŸ·è¡Œç·’å®‰å…¨çš„æ’åºçµæœ */ public static \u0026lt;K, V extends Comparable\u0026lt;V\u0026gt;\u0026gt; Map\u0026lt;K, V\u0026gt; sortAndMakeThreadSafe(Map\u0026lt;K, V\u0026gt; map) { Map\u0026lt;K, V\u0026gt; sortedMap = sortByValueUsingStream(map, false); return Collections.synchronizedMap(sortedMap); } } ç¸½çµ Map æŒ‰ Value æ’åºæ˜¯ Java é–‹ç™¼ä¸­çš„å¸¸è¦‹éœ€æ±‚ï¼Œæœ¬æ–‡ä»‹ç´¹äº†å››ç¨®ä¸»è¦å¯¦ä½œæ–¹æ³•ï¼š\nCollections.sortï¼šå‚³çµ±æ–¹æ³•ï¼Œé©åˆå°åˆ°ä¸­å‹è³‡æ–™é›† Stream APIï¼šç¾ä»£å‡½æ•¸å¼æ–¹æ³•ï¼Œç¨‹å¼ç¢¼ç°¡æ½”æ˜“è®€ Parallel Streamï¼šé©åˆå¤§å‹è³‡æ–™é›†çš„ä¸¦è¡Œè™•ç† TreeMap ç­–ç•¥ï¼šé©åˆç‰¹æ®Šå ´æ™¯ï¼Œå¦‚ Value å”¯ä¸€çš„æƒ…æ³ é¸æ“‡å»ºè­° å°è³‡æ–™é›†ï¼ˆ\u0026lt; 1000ï¼‰ï¼šä½¿ç”¨ Collections.sort ä¸­ç­‰è³‡æ–™é›†ï¼ˆ1000-100000ï¼‰ï¼šä½¿ç”¨ Stream API å¤§è³‡æ–™é›†ï¼ˆ\u0026gt; 100000ï¼‰ï¼šä½¿ç”¨ Parallel Stream éœ€è¦æŒçºŒæœ‰åºï¼šè€ƒæ…®ä½¿ç”¨ TreeMap æˆ– LinkedHashMap å‡½æ•¸å¼ç¨‹å¼è¨­è¨ˆï¼šå„ªå…ˆé¸æ“‡ Stream API é—œéµè¦é» ä¿æŒé †åºï¼šä½¿ç”¨ LinkedHashMap å„²å­˜æ’åºçµæœ æ•ˆèƒ½è€ƒé‡ï¼šæ ¹æ“šè³‡æ–™å¤§å°é¸æ“‡åˆé©çš„æ–¹æ³• åŸ·è¡Œç·’å®‰å…¨ï¼šä½µç™¼ç’°å¢ƒä¸‹æ³¨æ„åŒæ­¥å•é¡Œ null è™•ç†ï¼šä½¿ç”¨ Comparator.nullsLast() è™•ç† null å€¼ è¨˜æ†¶é«”ç®¡ç†ï¼šå¤§è³‡æ–™é›†æ™‚æ³¨æ„è¨˜æ†¶é«”ä½¿ç”¨ é€šéæŒæ¡é€™äº›æŠ€è¡“å’Œæœ€ä½³å¯¦è¸ï¼Œæ‚¨å¯ä»¥åœ¨å„ç¨®å ´æ™¯ä¸‹é«˜æ•ˆåœ°å¯¦ç¾ Map æŒ‰ Value æ’åºåŠŸèƒ½ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/map-sort-by-value/","tags":["Java","Map","Sorting","Collections","Stream API","Performance","Lambda","TreeMap","LinkedHashMap","Comparator"],"title":"Java Map æŒ‰ Value æ’åºï¼šå®Œæ•´å¯¦ä½œèˆ‡æ•ˆèƒ½å„ªåŒ–æŒ‡å—"},{"content":"Git tag\n1 2 3 4 5 6 7 8 9 git tag deploy/{env_name}/{feature_name} git push origin deploy/{env_name}/{feature_name} git tag -d/--delete deploy/{env_name}/{feature_name} git push origin --delete deploy/{env_name}/{feature_name} git push origin :{tagname} git describe --always HEAD remote info\n1 2 git remote show origin ","permalink":"https://xinqilin.github.io/post/tools/git/","tags":[],"title":"Git"},{"content":"æ¦‚è¿° digï¼ˆDomain Information Groperï¼‰æ˜¯ä¸€å€‹åŠŸèƒ½å¼·å¤§çš„å‘½ä»¤è¡Œ DNS æŸ¥è©¢å·¥å…·ï¼Œç”¨æ–¼åŸ·è¡Œ DNS æŸ¥è©¢ä¸¦é¡¯ç¤ºè©³ç´°çš„æŸ¥è©¢çµæœã€‚å®ƒæ˜¯ç¶²è·¯ç®¡ç†å“¡ã€ç³»çµ±ç®¡ç†å“¡å’Œé–‹ç™¼è€…é€²è¡Œ DNS è¨ºæ–·ã€ç¶²è·¯æ•…éšœæ’é™¤å’ŒåŸŸåè§£æåˆ†æçš„å¿…å‚™å·¥å…·ã€‚\næ ¸å¿ƒç‰¹å¾µ éˆæ´»çš„æŸ¥è©¢é¸é …ï¼šæ”¯æ´å„ç¨® DNS è¨˜éŒ„é¡å‹æŸ¥è©¢ è©³ç´°çš„è¼¸å‡ºè³‡è¨Šï¼šæä¾›å®Œæ•´çš„ DNS éŸ¿æ‡‰è©³æƒ… å¤šç¨®è¼¸å‡ºæ ¼å¼ï¼šæ”¯æ´ç°¡æ½”ã€è©³ç´°å’Œè‡ªè¨‚æ ¼å¼ å¼·å¤§çš„è¨ºæ–·åŠŸèƒ½ï¼šè¿½è¹¤æŸ¥è©¢è·¯å¾‘å’Œæ•ˆèƒ½åˆ†æ è…³æœ¬å‹å¥½ï¼šé©åˆè‡ªå‹•åŒ–å’Œæ‰¹æ¬¡è™•ç† å®‰è£èˆ‡ç’°å¢ƒæº–å‚™ å„ç³»çµ±å®‰è£æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 # Ubuntu/Debian sudo apt-get install dnsutils # CentOS/RHEL/Fedora sudo yum install bind-utils # CentOS 7 åŠä»¥ä¸‹ sudo dnf install bind-utils # Fedora/CentOS 8+ # macOS (é€šå¸¸å·²é è£) brew install bind # é©—è­‰å®‰è£ dig -v åŸºæœ¬èªæ³• 1 dig [@server] [domain] [type] [options] åŸºæœ¬ä½¿ç”¨ ç°¡å–® DNS æŸ¥è©¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # åŸºæœ¬æŸ¥è©¢ï¼ˆA è¨˜éŒ„ï¼‰ dig google.com # æŒ‡å®šè¨˜éŒ„é¡å‹ dig google.com A dig google.com AAAA dig google.com MX dig google.com NS dig google.com TXT # ç°¡æ½”è¼¸å‡º dig google.com +short # åªé¡¯ç¤ºç­”æ¡ˆéƒ¨åˆ† dig google.com +noall +answer æŸ¥è©¢çµæœè§£æ æ¨™æº– dig è¼¸å‡ºåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 dig www.google.com ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.16.1 \u0026lt;\u0026lt;\u0026gt;\u0026gt; www.google.com ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 12345 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: # æŸ¥è©¢å•é¡Œ ;www.google.com. IN A ;; ANSWER SECTION: # æŸ¥è©¢ç­”æ¡ˆ www.google.com. 299 IN A 142.250.191.68 ;; Query time: 15 msec # æŸ¥è©¢æ™‚é–“ ;; SERVER: 8.8.8.8#53(8.8.8.8) # DNS ä¼ºæœå™¨ ;; WHEN: Mon Jan 08 21:40:50 CST 2024 ;; MSG SIZE rcvd: 59 # éŸ¿æ‡‰å¤§å° DNS è¨˜éŒ„é¡å‹æŸ¥è©¢ A å’Œ AAAA è¨˜éŒ„ 1 2 3 4 5 6 7 8 9 10 # IPv4 åœ°å€è¨˜éŒ„ï¼ˆAï¼‰ dig example.com A dig example.com A +short # IPv6 åœ°å€è¨˜éŒ„ï¼ˆAAAAï¼‰ dig example.com AAAA dig example.com AAAA +short # åŒæ™‚æŸ¥è©¢ A å’Œ AAAA dig example.com A AAAA MX è¨˜éŒ„ï¼ˆéƒµä»¶äº¤æ›ï¼‰ 1 2 3 4 5 6 7 8 9 # æŸ¥è©¢éƒµä»¶ä¼ºæœå™¨ dig google.com MX dig google.com MX +short # æŸ¥è©¢ç‰¹å®šåŸŸåçš„éƒµä»¶é…ç½® dig gmail.com MX +noall +answer # é¡¯ç¤ºå„ªå…ˆç´šå’Œéƒµä»¶ä¼ºæœå™¨ dig yahoo.com MX | grep -E \u0026#34;^[^;].*MX\u0026#34; NS è¨˜éŒ„ï¼ˆåç¨±ä¼ºæœå™¨ï¼‰ 1 2 3 4 5 6 7 8 9 # æŸ¥è©¢åŸŸåä¼ºæœå™¨ dig google.com NS dig google.com NS +short # æŸ¥è©¢æ ¹åŸŸåä¼ºæœå™¨ dig . NS +short # æŸ¥è©¢ç‰¹å®š TLD çš„åç¨±ä¼ºæœå™¨ dig com NS +short TXT è¨˜éŒ„ï¼ˆæ–‡æœ¬è¨˜éŒ„ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 # æŸ¥è©¢ TXT è¨˜éŒ„ dig google.com TXT dig google.com TXT +short # æŸ¥è©¢ SPF è¨˜éŒ„ dig _spf.google.com TXT # æŸ¥è©¢ DKIM è¨˜éŒ„ dig selector1._domainkey.example.com TXT # æŸ¥è©¢ DMARC è¨˜éŒ„ dig _dmarc.example.com TXT SOA è¨˜éŒ„ï¼ˆæˆæ¬Šèµ·å§‹ï¼‰ 1 2 3 4 5 6 # æŸ¥è©¢ SOA è¨˜éŒ„ dig google.com SOA dig google.com SOA +short # è©³ç´° SOA ä¿¡æ¯ dig google.com SOA +noall +answer +multiline CNAME è¨˜éŒ„ï¼ˆåˆ¥åï¼‰ 1 2 3 4 5 6 # æŸ¥è©¢ CNAME è¨˜éŒ„ dig www.github.com CNAME dig www.github.com CNAME +short # è¿½è¹¤ CNAME éˆ dig www.example.com +trace PTR è¨˜éŒ„ï¼ˆåå‘æŸ¥è©¢ï¼‰ 1 2 3 4 5 6 7 8 9 # åå‘ DNS æŸ¥è©¢ dig -x 8.8.8.8 dig -x 8.8.8.8 +short # æ‰‹å‹• PTR æŸ¥è©¢ dig 8.8.8.8.in-addr.arpa PTR # IPv6 åå‘æŸ¥è©¢ dig -x 2001:4860:4860::8888 é€²éšæŸ¥è©¢é¸é … æŒ‡å®š DNS ä¼ºæœå™¨ 1 2 3 4 5 6 7 8 9 10 # ä½¿ç”¨ Google DNS dig @8.8.8.8 google.com # ä½¿ç”¨ Cloudflare DNS dig @1.1.1.1 google.com # ä½¿ç”¨å¤šå€‹ DNS ä¼ºæœå™¨æ¯”è¼ƒ dig @8.8.8.8 google.com +short dig @1.1.1.1 google.com +short dig @208.67.222.222 google.com +short # OpenDNS æŸ¥è©¢è¿½è¹¤ 1 2 3 4 5 6 7 8 9 10 11 # è¿½è¹¤ DNS è§£æè·¯å¾‘ dig google.com +trace # è¿½è¹¤ç‰¹å®šè¨˜éŒ„é¡å‹ dig google.com MX +trace # ç°¡åŒ–è¿½è¹¤è¼¸å‡º dig google.com +trace +short # è¿½è¹¤ä¸¦é¡¯ç¤ºæ‰€æœ‰æ­¥é©Ÿ dig google.com +trace +additional +all è¼¸å‡ºæ ¼å¼æ§åˆ¶ 1 2 3 4 5 6 7 8 9 10 11 12 # ç°¡æ½”è¼¸å‡º dig google.com +short dig google.com +noall +answer # å¤šè¡Œæ ¼å¼åŒ–è¼¸å‡º dig google.com SOA +multiline # éš±è—ç‰¹å®šéƒ¨åˆ† dig google.com +nocomments +noquestion +noauthority +noadditional +nostats # è‡ªè¨‚è¼¸å‡ºçµ„åˆ dig google.com +nocmd +noall +answer +multiline ç¶²è·¯è¨ºæ–·èˆ‡æ•…éšœæ’é™¤ DNS æ•ˆèƒ½æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æ¸¬é‡æŸ¥è©¢æ™‚é–“ dig google.com | grep \u0026#34;Query time\u0026#34; # æ‰¹æ¬¡æ•ˆèƒ½æ¸¬è©¦ for i in {1..10}; do dig google.com +stats | grep \u0026#34;Query time\u0026#34; done # æ¯”è¼ƒä¸åŒ DNS ä¼ºæœå™¨æ•ˆèƒ½ dns_servers=(\u0026#34;8.8.8.8\u0026#34; \u0026#34;1.1.1.1\u0026#34; \u0026#34;208.67.222.222\u0026#34;) for server in \u0026#34;${dns_servers[@]}\u0026#34;; do echo \u0026#34;Testing $server:\u0026#34; dig @$server google.com +stats | grep \u0026#34;Query time\u0026#34; done DNS å¿«å–åˆ†æ 1 2 3 4 5 6 7 8 # æª¢æŸ¥ TTL å€¼ dig google.com +noall +answer # ç›£æ§ TTL è®ŠåŒ– watch -n 5 \u0026#39;dig google.com +noall +answer\u0026#39; # æª¢æŸ¥å¿«å–ç‹€æ…‹ dig google.com +norecurse åŸŸåå¯ç”¨æ€§æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æª¢æŸ¥åŸŸåæ˜¯å¦å­˜åœ¨ dig example.com ANY +short # æª¢æŸ¥åŸŸåç‹€æ…‹ dig example.com +short \u0026gt; /dev/null \u0026amp;\u0026amp; echo \u0026#34;Domain exists\u0026#34; || echo \u0026#34;Domain not found\u0026#34; # æ‰¹æ¬¡åŸŸåæª¢æŸ¥ domains=(\u0026#34;google.com\u0026#34; \u0026#34;example.com\u0026#34; \u0026#34;nonexistent-domain-12345.com\u0026#34;) for domain in \u0026#34;${domains[@]}\u0026#34;; do if dig \u0026#34;$domain\u0026#34; +short \u0026gt; /dev/null 2\u0026gt;\u0026amp;1; then echo \u0026#34;$domain: EXISTS\u0026#34; else echo \u0026#34;$domain: NOT FOUND\u0026#34; fi done DNSSEC é©—è­‰ 1 2 3 4 5 6 7 8 9 10 11 # æª¢æŸ¥ DNSSEC æ”¯æ´ dig google.com +dnssec +multiline # é©—è­‰ DNSSEC ç°½å dig google.com DNSKEY +dnssec # æª¢æŸ¥ DS è¨˜éŒ„ dig google.com DS +dnssec # é©—è­‰éˆ dig +trace +dnssec google.com å¯¦æˆ°æ‡‰ç”¨å ´æ™¯ 1. éƒµä»¶ä¼ºæœå™¨è¨ºæ–· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #!/bin/bash # mail_server_check.sh - éƒµä»¶ä¼ºæœå™¨è¨ºæ–·è…³æœ¬ check_mail_server() { local domain=\u0026#34;$1\u0026#34; echo \u0026#34;=== Mail Server Diagnosis for $domain ===\u0026#34; # æª¢æŸ¥ MX è¨˜éŒ„ echo \u0026#34;MX Records:\u0026#34; dig \u0026#34;$domain\u0026#34; MX +noall +answer # æª¢æŸ¥ SPF è¨˜éŒ„ echo -e \u0026#34;\\nSPF Record:\u0026#34; dig \u0026#34;$domain\u0026#34; TXT +short | grep -i spf # æª¢æŸ¥ DMARC è¨˜éŒ„ echo -e \u0026#34;\\nDMARC Record:\u0026#34; dig \u0026#34;_dmarc.$domain\u0026#34; TXT +short # æª¢æŸ¥å¸¸è¦‹ DKIM é¸æ“‡å™¨ echo -e \u0026#34;\\nDKIM Records:\u0026#34; selectors=(\u0026#34;default\u0026#34; \u0026#34;selector1\u0026#34; \u0026#34;selector2\u0026#34; \u0026#34;google\u0026#34; \u0026#34;k1\u0026#34;) for selector in \u0026#34;${selectors[@]}\u0026#34;; do result=$(dig \u0026#34;${selector}._domainkey.$domain\u0026#34; TXT +short 2\u0026gt;/dev/null) if [ -n \u0026#34;$result\u0026#34; ]; then echo \u0026#34;$selector: $result\u0026#34; fi done } # ä½¿ç”¨ç¯„ä¾‹ check_mail_server \u0026#34;gmail.com\u0026#34; 2. ç¶²ç«™å¯ç”¨æ€§ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #!/bin/bash # website_dns_monitor.sh - ç¶²ç«™ DNS ç›£æ§è…³æœ¬ monitor_website() { local domain=\u0026#34;$1\u0026#34; local log_file=\u0026#34;${2:-dns_monitor.log}\u0026#34; timestamp=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) # æª¢æŸ¥ A è¨˜éŒ„ a_record=$(dig \u0026#34;$domain\u0026#34; A +short | head -1) # æª¢æŸ¥ AAAA è¨˜éŒ„ aaaa_record=$(dig \u0026#34;$domain\u0026#34; AAAA +short | head -1) # æ¸¬é‡æŸ¥è©¢æ™‚é–“ query_time=$(dig \u0026#34;$domain\u0026#34; | grep \u0026#34;Query time\u0026#34; | awk \u0026#39;{print $4}\u0026#39;) # æª¢æŸ¥ DNS ä¼ºæœå™¨éŸ¿æ‡‰ dns_server=$(dig \u0026#34;$domain\u0026#34; | grep \u0026#34;SERVER:\u0026#34; | awk \u0026#39;{print $2}\u0026#39;) # è¨˜éŒ„çµæœ log_entry=\u0026#34;$timestamp | $domain | A: $a_record | AAAA: $aaaa_record | Time: ${query_time}ms | Server: $dns_server\u0026#34; echo \u0026#34;$log_entry\u0026#34; | tee -a \u0026#34;$log_file\u0026#34; # æª¢æŸ¥ç•°å¸¸ if [ -z \u0026#34;$a_record\u0026#34; ]; then echo \u0026#34;WARNING: No A record found for $domain\u0026#34; | tee -a \u0026#34;$log_file\u0026#34; fi if [ \u0026#34;${query_time:-0}\u0026#34; -gt 1000 ]; then echo \u0026#34;WARNING: Slow DNS response (${query_time}ms) for $domain\u0026#34; | tee -a \u0026#34;$log_file\u0026#34; fi } # ç›£æ§å¤šå€‹ç¶²ç«™ websites=(\u0026#34;google.com\u0026#34; \u0026#34;github.com\u0026#34; \u0026#34;stackoverflow.com\u0026#34;) for site in \u0026#34;${websites[@]}\u0026#34;; do monitor_website \u0026#34;$site\u0026#34; done 3. DNS ä¼ºæœå™¨æ•ˆèƒ½æ¯”è¼ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 #!/bin/bash # dns_performance_test.sh - DNS æ•ˆèƒ½æ¸¬è©¦è…³æœ¬ dns_performance_test() { local domain=\u0026#34;${1:-google.com}\u0026#34; local test_count=\u0026#34;${2:-10}\u0026#34; # DNS ä¼ºæœå™¨åˆ—è¡¨ declare -A dns_servers=( [\u0026#34;Google\u0026#34;]=\u0026#34;8.8.8.8\u0026#34; [\u0026#34;Cloudflare\u0026#34;]=\u0026#34;1.1.1.1\u0026#34; [\u0026#34;OpenDNS\u0026#34;]=\u0026#34;208.67.222.222\u0026#34; [\u0026#34;Quad9\u0026#34;]=\u0026#34;9.9.9.9\u0026#34; ) echo \u0026#34;DNS Performance Test for $domain\u0026#34; echo \u0026#34;==================================\u0026#34; for name in \u0026#34;${!dns_servers[@]}\u0026#34;; do server=\u0026#34;${dns_servers[$name]}\u0026#34; echo -e \u0026#34;\\nTesting $name ($server):\u0026#34; total_time=0 successful_queries=0 for i in $(seq 1 $test_count); do query_time=$(dig @\u0026#34;$server\u0026#34; \u0026#34;$domain\u0026#34; +stats 2\u0026gt;/dev/null | grep \u0026#34;Query time\u0026#34; | awk \u0026#39;{print $4}\u0026#39;) if [ -n \u0026#34;$query_time\u0026#34; ]; then total_time=$((total_time + query_time)) successful_queries=$((successful_queries + 1)) echo -n \u0026#34;.\u0026#34; else echo -n \u0026#34;x\u0026#34; fi done if [ $successful_queries -gt 0 ]; then average_time=$((total_time / successful_queries)) echo -e \u0026#34;\\nAverage: ${average_time}ms (${successful_queries}/${test_count} successful)\u0026#34; else echo -e \u0026#34;\\nFailed: No successful queries\u0026#34; fi done } # åŸ·è¡Œæ¸¬è©¦ dns_performance_test \u0026#34;google.com\u0026#34; 5 4. åŸŸåè®Šæ›´è¿½è¹¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 #!/bin/bash # dns_change_tracker.sh - DNS è®Šæ›´è¿½è¹¤è…³æœ¬ track_dns_changes() { local domain=\u0026#34;$1\u0026#34; local record_type=\u0026#34;${2:-A}\u0026#34; local interval=\u0026#34;${3:-300}\u0026#34; # 5åˆ†é˜ local log_file=\u0026#34;dns_changes_${domain}_${record_type}.log\u0026#34; echo \u0026#34;Tracking DNS changes for $domain ($record_type record)\u0026#34; echo \u0026#34;Log file: $log_file\u0026#34; previous_result=\u0026#34;\u0026#34; while true; do timestamp=$(date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) current_result=$(dig \u0026#34;$domain\u0026#34; \u0026#34;$record_type\u0026#34; +short | sort | tr \u0026#39;\\n\u0026#39; \u0026#39; \u0026#39;) if [ \u0026#34;$current_result\u0026#34; != \u0026#34;$previous_result\u0026#34; ]; then if [ -n \u0026#34;$previous_result\u0026#34; ]; then echo \u0026#34;$timestamp | CHANGE DETECTED\u0026#34; | tee -a \u0026#34;$log_file\u0026#34; echo \u0026#34;$timestamp | Old: $previous_result\u0026#34; | tee -a \u0026#34;$log_file\u0026#34; echo \u0026#34;$timestamp | New: $current_result\u0026#34; | tee -a \u0026#34;$log_file\u0026#34; echo \u0026#34;$timestamp | ---\u0026#34; | tee -a \u0026#34;$log_file\u0026#34; else echo \u0026#34;$timestamp | Initial: $current_result\u0026#34; | tee -a \u0026#34;$log_file\u0026#34; fi previous_result=\u0026#34;$current_result\u0026#34; else echo \u0026#34;$timestamp | No change: $current_result\u0026#34; fi sleep \u0026#34;$interval\u0026#34; done } # ä½¿ç”¨ç¯„ä¾‹ # track_dns_changes \u0026#34;example.com\u0026#34; \u0026#34;A\u0026#34; 60 5. æ‰¹æ¬¡åŸŸååˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 #!/bin/bash # batch_domain_analysis.sh - æ‰¹æ¬¡åŸŸååˆ†æè…³æœ¬ analyze_domains() { local domain_file=\u0026#34;$1\u0026#34; local output_file=\u0026#34;${2:-domain_analysis_$(date +%Y%m%d_%H%M%S).csv}\u0026#34; # CSV æ¨™é¡Œ echo \u0026#34;Domain,A_Record,MX_Record,NS_Record,TXT_Count,Query_Time_ms,Status\u0026#34; \u0026gt; \u0026#34;$output_file\u0026#34; while IFS= read -r domain; do # è·³éç©ºè¡Œå’Œè¨»è§£ [[ -z \u0026#34;$domain\u0026#34; || \u0026#34;$domain\u0026#34; =~ ^[[:space:]]*# ]] \u0026amp;\u0026amp; continue echo \u0026#34;Analyzing: $domain\u0026#34; # æŸ¥è©¢å„ç¨®è¨˜éŒ„ a_record=$(dig \u0026#34;$domain\u0026#34; A +short | head -1) mx_record=$(dig \u0026#34;$domain\u0026#34; MX +short | head -1 | awk \u0026#39;{print $2}\u0026#39;) ns_record=$(dig \u0026#34;$domain\u0026#34; NS +short | head -1) txt_count=$(dig \u0026#34;$domain\u0026#34; TXT +short | wc -l) # æ¸¬é‡æŸ¥è©¢æ™‚é–“ query_time=$(dig \u0026#34;$domain\u0026#34; | grep \u0026#34;Query time\u0026#34; | awk \u0026#39;{print $4}\u0026#39;) # åˆ¤æ–·ç‹€æ…‹ if [ -n \u0026#34;$a_record\u0026#34; ]; then status=\u0026#34;Active\u0026#34; elif dig \u0026#34;$domain\u0026#34; +short \u0026gt; /dev/null 2\u0026gt;\u0026amp;1; then status=\u0026#34;Registered\u0026#34; else status=\u0026#34;Not Found\u0026#34; fi # å¯«å…¥ CSV echo \u0026#34;$domain,$a_record,$mx_record,$ns_record,$txt_count,$query_time,$status\u0026#34; \u0026gt;\u0026gt; \u0026#34;$output_file\u0026#34; done \u0026lt; \u0026#34;$domain_file\u0026#34; echo \u0026#34;Analysis complete. Results saved to: $output_file\u0026#34; } # å»ºç«‹ç¯„ä¾‹åŸŸååˆ—è¡¨ cat \u0026gt; domains.txt \u0026lt;\u0026lt; EOF google.com github.com stackoverflow.com example.com nonexistent-domain-12345.com EOF # åŸ·è¡Œåˆ†æ analyze_domains \u0026#34;domains.txt\u0026#34; é€²éšæŠ€å·§èˆ‡æœ€ä½³åŒ– 1. è‡ªè¨‚æŸ¥è©¢è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #!/bin/bash # dig_wrapper.sh - dig åŒ…è£å™¨è…³æœ¬ # å½©è‰²è¼¸å‡º RED=\u0026#39;\\033[0;31m\u0026#39; GREEN=\u0026#39;\\033[0;32m\u0026#39; YELLOW=\u0026#39;\\033[1;33m\u0026#39; BLUE=\u0026#39;\\033[0;34m\u0026#39; NC=\u0026#39;\\033[0m\u0026#39; # No Color enhanced_dig() { local domain=\u0026#34;$1\u0026#34; local record_type=\u0026#34;${2:-A}\u0026#34; echo -e \u0026#34;${BLUE}=== Enhanced DNS Query: $domain ($record_type) ===${NC}\u0026#34; # åŸºæœ¬æŸ¥è©¢ echo -e \u0026#34;\\n${GREEN}Basic Query:${NC}\u0026#34; dig \u0026#34;$domain\u0026#34; \u0026#34;$record_type\u0026#34; +noall +answer # æŸ¥è©¢æ™‚é–“å’Œä¼ºæœå™¨è³‡è¨Š echo -e \u0026#34;\\n${GREEN}Performance Info:${NC}\u0026#34; dig \u0026#34;$domain\u0026#34; \u0026#34;$record_type\u0026#34; | grep -E \u0026#34;(Query time|SERVER:)\u0026#34; # æ¬Šå¨ä¼ºæœå™¨æŸ¥è©¢ echo -e \u0026#34;\\n${GREEN}Authoritative Servers:${NC}\u0026#34; dig \u0026#34;$domain\u0026#34; NS +short # å¦‚æœæ˜¯ A è¨˜éŒ„ï¼Œä¹Ÿé¡¯ç¤ºåå‘æŸ¥è©¢ if [ \u0026#34;$record_type\u0026#34; = \u0026#34;A\u0026#34; ]; then echo -e \u0026#34;\\n${GREEN}Reverse DNS:${NC}\u0026#34; ip=$(dig \u0026#34;$domain\u0026#34; A +short | head -1) if [ -n \u0026#34;$ip\u0026#34; ]; then dig -x \u0026#34;$ip\u0026#34; +short fi fi } # ä½¿ç”¨ç¯„ä¾‹ enhanced_dig \u0026#34;google.com\u0026#34; \u0026#34;A\u0026#34; 2. DNS å¥åº·æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 #!/bin/bash # dns_health_check.sh - DNS å¥åº·æª¢æŸ¥è…³æœ¬ dns_health_check() { local domain=\u0026#34;$1\u0026#34; echo \u0026#34;DNS Health Check for: $domain\u0026#34; echo \u0026#34;=============================\u0026#34; # æª¢æŸ¥é …ç›®è¨ˆæ•¸ local total_checks=0 local passed_checks=0 # 1. æª¢æŸ¥ A è¨˜éŒ„ echo -n \u0026#34;Checking A record... \u0026#34; total_checks=$((total_checks + 1)) if dig \u0026#34;$domain\u0026#34; A +short \u0026gt; /dev/null 2\u0026gt;\u0026amp;1; then echo \u0026#34;âœ“ PASS\u0026#34; passed_checks=$((passed_checks + 1)) else echo \u0026#34;âœ— FAIL\u0026#34; fi # 2. æª¢æŸ¥ NS è¨˜éŒ„ echo -n \u0026#34;Checking NS records... \u0026#34; total_checks=$((total_checks + 1)) ns_count=$(dig \u0026#34;$domain\u0026#34; NS +short | wc -l) if [ \u0026#34;$ns_count\u0026#34; -ge 2 ]; then echo \u0026#34;âœ“ PASS ($ns_count nameservers)\u0026#34; passed_checks=$((passed_checks + 1)) else echo \u0026#34;âœ— FAIL (only $ns_count nameserver)\u0026#34; fi # 3. æª¢æŸ¥ SOA è¨˜éŒ„ echo -n \u0026#34;Checking SOA record... \u0026#34; total_checks=$((total_checks + 1)) if dig \u0026#34;$domain\u0026#34; SOA +short \u0026gt; /dev/null 2\u0026gt;\u0026amp;1; then echo \u0026#34;âœ“ PASS\u0026#34; passed_checks=$((passed_checks + 1)) else echo \u0026#34;âœ— FAIL\u0026#34; fi # 4. æª¢æŸ¥æŸ¥è©¢æ™‚é–“ echo -n \u0026#34;Checking query performance... \u0026#34; total_checks=$((total_checks + 1)) query_time=$(dig \u0026#34;$domain\u0026#34; | grep \u0026#34;Query time\u0026#34; | awk \u0026#39;{print $4}\u0026#39;) if [ \u0026#34;${query_time:-9999}\u0026#34; -lt 1000 ]; then echo \u0026#34;âœ“ PASS (${query_time}ms)\u0026#34; passed_checks=$((passed_checks + 1)) else echo \u0026#34;âœ— FAIL (${query_time}ms - too slow)\u0026#34; fi # 5. æª¢æŸ¥æ¬Šå¨ä¼ºæœå™¨ä¸€è‡´æ€§ echo -n \u0026#34;Checking authoritative server consistency... \u0026#34; total_checks=$((total_checks + 1)) ns_servers=$(dig \u0026#34;$domain\u0026#34; NS +short) consistent=true if [ -n \u0026#34;$ns_servers\u0026#34; ]; then first_result=$(dig @$(echo \u0026#34;$ns_servers\u0026#34; | head -1) \u0026#34;$domain\u0026#34; A +short | sort) while IFS= read -r server; do current_result=$(dig @\u0026#34;$server\u0026#34; \u0026#34;$domain\u0026#34; A +short | sort) if [ \u0026#34;$current_result\u0026#34; != \u0026#34;$first_result\u0026#34; ]; then consistent=false break fi done \u0026lt;\u0026lt;\u0026lt; \u0026#34;$ns_servers\u0026#34; if $consistent; then echo \u0026#34;âœ“ PASS\u0026#34; passed_checks=$((passed_checks + 1)) else echo \u0026#34;âœ— FAIL (inconsistent results)\u0026#34; fi else echo \u0026#34;âœ— FAIL (no nameservers found)\u0026#34; fi # ç¸½çµ echo echo \u0026#34;Health Check Summary: $passed_checks/$total_checks passed\u0026#34; if [ \u0026#34;$passed_checks\u0026#34; -eq \u0026#34;$total_checks\u0026#34; ]; then echo \u0026#34;Status: âœ“ HEALTHY\u0026#34; return 0 else echo \u0026#34;Status: âœ— ISSUES DETECTED\u0026#34; return 1 fi } # ä½¿ç”¨ç¯„ä¾‹ dns_health_check \u0026#34;google.com\u0026#34; 3. é…ç½®æª”æ¡ˆç®¡ç† å»ºç«‹ ~/.digrc é…ç½®æª”æ¡ˆï¼š\n1 2 3 4 # ~/.digrc - dig é è¨­é…ç½® +noall +answer +time=5 +tries=3 æˆ–ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼š\n1 2 3 4 5 6 7 # åœ¨ ~/.bashrc æˆ– ~/.zshrc ä¸­æ·»åŠ  export DIG_DEFAULT_OPTS=\u0026#34;+short +time=3\u0026#34; # ä½¿ç”¨åˆ¥å alias digs=\u0026#39;dig +short\u0026#39; alias digt=\u0026#39;dig +trace\u0026#39; alias digx=\u0026#39;dig +short +time=1\u0026#39; å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ 1. æŸ¥è©¢è¶…æ™‚å•é¡Œ 1 2 3 4 5 6 7 8 # èª¿æ•´è¶…æ™‚è¨­å®š dig google.com +time=10 +tries=3 # ä½¿ç”¨ TCP æŸ¥è©¢ dig google.com +tcp # æª¢æŸ¥ç¶²è·¯é€£æ¥ dig google.com +trace | grep -E \u0026#34;(SERVFAIL|TIMEOUT)\u0026#34; 2. DNS ä¼ºæœå™¨å•é¡Œ 1 2 3 4 5 6 7 8 # æ¸¬è©¦å¤šå€‹ DNS ä¼ºæœå™¨ dns_test() { local domain=\u0026#34;$1\u0026#34; for server in 8.8.8.8 1.1.1.1 208.67.222.222; do echo \u0026#34;Testing $server:\u0026#34; dig @$server \u0026#34;$domain\u0026#34; +short +time=3 || echo \u0026#34;Failed\u0026#34; done } 3. è¨˜éŒ„è§£æå•é¡Œ 1 2 3 4 5 6 7 8 # æª¢æŸ¥å®Œæ•´çš„è§£æè·¯å¾‘ dig google.com +trace +all # é©—è­‰ DNSSEC dig google.com +dnssec +multiline # æª¢æŸ¥å¿«å–æ±¡æŸ“ dig google.com @8.8.8.8 +norecurse èˆ‡å…¶ä»–å·¥å…·æ•´åˆ 1. èˆ‡ nslookup æ¯”è¼ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # dig æ ¼å¼ dig google.com A +short # nslookup æ ¼å¼ nslookup google.com | grep \u0026#34;Address:\u0026#34; | tail -1 | awk \u0026#39;{print $2}\u0026#39; # è½‰æ›è…³æœ¬ dig2nslookup() { local domain=\u0026#34;$1\u0026#34; echo \u0026#34;Server: $(dig google.com | grep SERVER | awk \u0026#39;{print $2}\u0026#39; | cut -d# -f1)\u0026#34; echo \u0026#34;Address: $(dig google.com | grep SERVER | awk \u0026#39;{print $2}\u0026#39;)\u0026#34; echo echo \u0026#34;Name: $domain\u0026#34; dig \u0026#34;$domain\u0026#34; A +short | while read ip; do echo \u0026#34;Address: $ip\u0026#34; done } 2. èˆ‡ç›£æ§ç³»çµ±æ•´åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # Nagios æª¢æŸ¥è…³æœ¬ check_dns_record() { local domain=\u0026#34;$1\u0026#34; local expected=\u0026#34;$2\u0026#34; local timeout=\u0026#34;${3:-5}\u0026#34; result=$(dig \u0026#34;$domain\u0026#34; A +short +time=\u0026#34;$timeout\u0026#34; 2\u0026gt;/dev/null | head -1) if [ \u0026#34;$result\u0026#34; = \u0026#34;$expected\u0026#34; ]; then echo \u0026#34;OK - DNS record matches: $result\u0026#34; exit 0 elif [ -z \u0026#34;$result\u0026#34; ]; then echo \u0026#34;CRITICAL - No DNS record found\u0026#34; exit 2 else echo \u0026#34;WARNING - DNS record mismatch. Expected: $expected, Got: $result\u0026#34; exit 1 fi } # Prometheus æŒ‡æ¨™ç”Ÿæˆ generate_dns_metrics() { local domain=\u0026#34;$1\u0026#34; query_time=$(dig \u0026#34;$domain\u0026#34; | grep \u0026#34;Query time\u0026#34; | awk \u0026#39;{print $4}\u0026#39;) record_count=$(dig \u0026#34;$domain\u0026#34; A +short | wc -l) echo \u0026#34;dns_query_duration_ms{domain=\\\u0026#34;$domain\\\u0026#34;} $query_time\u0026#34; echo \u0026#34;dns_record_count{domain=\\\u0026#34;$domain\\\u0026#34;,type=\\\u0026#34;A\\\u0026#34;} $record_count\u0026#34; } ç¸½çµ æ ¸å¿ƒå„ªå‹¢ åŠŸèƒ½å®Œæ•´ï¼šæ”¯æ´æ‰€æœ‰ DNS è¨˜éŒ„é¡å‹å’ŒæŸ¥è©¢é¸é … è¼¸å‡ºè©³ç´°ï¼šæä¾›å®Œæ•´çš„ DNS éŸ¿æ‡‰è³‡è¨Š è¨ºæ–·èƒ½åŠ›ï¼šå¼·å¤§çš„ç¶²è·¯æ•…éšœæ’é™¤åŠŸèƒ½ è…³æœ¬å‹å¥½ï¼šé©åˆè‡ªå‹•åŒ–å’Œæ‰¹æ¬¡è™•ç† æ¨™æº–å·¥å…·ï¼šå»£æ³›æ”¯æ´å’Œè‰¯å¥½çš„æ–‡æª” æœ€ä½³å¯¦è¸ é©ç•¶çš„è¶…æ™‚è¨­å®šï¼šé¿å…æŸ¥è©¢æ›èµ· ä½¿ç”¨è¿½è¹¤åŠŸèƒ½ï¼šè¨ºæ–·è¤‡é›œçš„ DNS å•é¡Œ é©—è­‰å¤šå€‹ä¾†æºï¼šæ¯”è¼ƒä¸åŒ DNS ä¼ºæœå™¨çš„çµæœ è¨˜éŒ„å’Œç›£æ§ï¼šå»ºç«‹ DNS è®Šæ›´çš„æ­·å²è¨˜éŒ„ å®‰å…¨è€ƒæ…®ï¼šé©—è­‰ DNSSEC å’Œæª¢æŸ¥ DNS åŠ«æŒ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # åŸºæœ¬æŸ¥è©¢ dig domain.com # æ¨™æº–æŸ¥è©¢ dig domain.com +short # ç°¡æ½”è¼¸å‡º dig domain.com +trace # è¿½è¹¤è§£æè·¯å¾‘ # è¨˜éŒ„é¡å‹ dig domain.com A # IPv4 åœ°å€ dig domain.com AAAA # IPv6 åœ°å€ dig domain.com MX # éƒµä»¶äº¤æ› dig domain.com NS # åç¨±ä¼ºæœå™¨ dig domain.com TXT # æ–‡æœ¬è¨˜éŒ„ # é€²éšé¸é … dig @8.8.8.8 domain.com # æŒ‡å®š DNS ä¼ºæœå™¨ dig -x 8.8.8.8 # åå‘æŸ¥è©¢ dig domain.com +dnssec # DNSSEC é©—è­‰ dig domain.com +norecurse # ééæ­¸æŸ¥è©¢ dig æ˜¯ç¶²è·¯ç®¡ç†å’Œ DNS è¨ºæ–·çš„æ ¸å¿ƒå·¥å…·ï¼ŒæŒæ¡å…¶ä½¿ç”¨æŠ€å·§èƒ½å¤ å¤§å¹…æå‡ç¶²è·¯å•é¡Œè¨ºæ–·å’ŒåŸŸåç®¡ç†çš„æ•ˆç‡ã€‚è¨˜ä½ï¼šç†è§£ DNS ç³»çµ±çš„å·¥ä½œåŸç†æ˜¯æœ‰æ•ˆä½¿ç”¨ dig çš„åŸºç¤ã€‚\nåƒè€ƒè³‡æ–™ BIND 9 Administrator Reference Manual RFC 1035 - Domain Names DNS and BIND on IPv6 DNSSEC Guide Linux dig Command Tutorial ","permalink":"https://xinqilin.github.io/post/tools/dig/","tags":["Linux","Dig","DNS","Network","Debugging","System Administration","Command Line"],"title":"Dig å‘½ä»¤å®Œæ•´æŒ‡å—ï¼šDNS æŸ¥è©¢èˆ‡ç¶²è·¯è¨ºæ–·çš„å¼·å¤§å·¥å…·"},{"content":"SFTP ä¼æ¥­ç´šå·¥å…·é¡å¯¦ä½œæŒ‡å— ç°¡ä»‹ åœ¨ç¾ä»£ä¼æ¥­æ‡‰ç”¨ä¸­ï¼Œå®‰å…¨çš„æ–‡ä»¶å‚³è¼¸æ˜¯ä¸å¯æˆ–ç¼ºçš„åŠŸèƒ½ã€‚SFTPï¼ˆSSH File Transfer Protocolï¼‰æä¾›äº†ä¸€ç¨®å®‰å…¨ã€å¯é çš„æ–‡ä»¶å‚³è¼¸æ–¹æ¡ˆã€‚æœ¬æ–‡å°‡è©³ç´°ä»‹ç´¹å¦‚ä½•åœ¨ Spring Boot ä¸­å¯¦ä½œä¼æ¥­ç´šçš„ SFTP å·¥å…·é¡ï¼ŒåŒ…å«é€£ç·šæ± ç®¡ç†ã€éŒ¯èª¤è™•ç†ã€æ•ˆèƒ½å„ªåŒ–ç­‰é—œéµåŠŸèƒ½ã€‚\næ ¸å¿ƒä¾è³´é…ç½® Maven ä¾è³´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 \u0026lt;dependencies\u0026gt; \u0026lt;!-- SFTP æ ¸å¿ƒä¾è³´ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.jcraft\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jsch\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.1.55\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Apache Commons Pool2 é€£ç·šæ±  --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.commons\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-pool2\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.11.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Spring Boot Starter --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Spring Boot Configuration Processor --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Micrometer ç›£æ§ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.micrometer\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;micrometer-core\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; Gradle ä¾è³´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 dependencies { // SFTP æ ¸å¿ƒä¾è³´ implementation \u0026#39;com.jcraft:jsch:0.1.55\u0026#39; // Apache Commons Pool2 é€£ç·šæ±  implementation \u0026#39;org.apache.commons:commons-pool2:2.11.1\u0026#39; // Spring Boot Starter implementation \u0026#39;org.springframework.boot:spring-boot-starter\u0026#39; // Spring Boot Configuration Processor annotationProcessor \u0026#39;org.springframework.boot:spring-boot-configuration-processor\u0026#39; // Micrometer ç›£æ§ implementation \u0026#39;io.micrometer:micrometer-core\u0026#39; } é…ç½®é¡åˆ¥ SFTP é…ç½®å±¬æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.context.annotation.Configuration; import lombok.Data; @Data @Configuration @ConfigurationProperties(prefix = \u0026#34;sftp\u0026#34;) public class SftpProperties { // é€£ç·šé…ç½® private String host; private int port = 22; private String username; private String password; private String privateKeyPath; private String passphrase; // é€£ç·šæ± é…ç½® private Pool pool = new Pool(); // è¶…æ™‚é…ç½® private int connectTimeout = 30000; private int sessionTimeout = 30000; private int channelTimeout = 30000; // é‡è©¦é…ç½® private int maxRetries = 3; private int retryDelay = 1000; // å®‰å…¨é…ç½® private boolean strictHostKeyChecking = false; private String knownHostsFile; private String hostKeyAlgorithms; @Data public static class Pool { private int maxActive = 10; private int maxIdle = 5; private int minIdle = 1; private long maxWait = 10000; private boolean testOnBorrow = true; private boolean testOnReturn = true; private boolean testWhileIdle = true; private long timeBetweenEvictionRuns = 60000; private long minEvictableIdleTime = 300000; } } application.yml é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 sftp: host: sftp.example.com port: 22 username: ${SFTP_USERNAME:sftpuser} password: ${SFTP_PASSWORD:} private-key-path: ${SFTP_PRIVATE_KEY_PATH:} passphrase: ${SFTP_PASSPHRASE:} # é€£ç·šæ± é…ç½® pool: max-active: 20 max-idle: 10 min-idle: 2 max-wait: 15000 test-on-borrow: true test-on-return: true test-while-idle: true time-between-eviction-runs: 60000 min-evictable-idle-time: 300000 # è¶…æ™‚é…ç½® connect-timeout: 30000 session-timeout: 30000 channel-timeout: 30000 # é‡è©¦é…ç½® max-retries: 3 retry-delay: 1000 # å®‰å…¨é…ç½® strict-host-key-checking: false known-hosts-file: ~/.ssh/known_hosts host-key-algorithms: ssh-rsa,ssh-dss # ç›£æ§é…ç½® management: endpoints: web: exposure: include: health,metrics,info,sftp metrics: tags: application: sftp-service æ ¸å¿ƒå¯¦ä½œé¡åˆ¥ SFTP é€£ç·šå·¥å»  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 import com.jcraft.jsch.*; import lombok.extern.slf4j.Slf4j; import org.apache.commons.pool2.BasePooledObjectFactory; import org.apache.commons.pool2.PooledObject; import org.apache.commons.pool2.impl.DefaultPooledObject; import org.springframework.stereotype.Component; import java.io.File; import java.util.Properties; @Slf4j @Component public class SftpConnectionFactory extends BasePooledObjectFactory\u0026lt;ChannelSftp\u0026gt; { private final SftpProperties sftpProperties; private final JSch jsch; public SftpConnectionFactory(SftpProperties sftpProperties) { this.sftpProperties = sftpProperties; this.jsch = new JSch(); initializeJSch(); } private void initializeJSch() { try { // è¨­å®šç§é‘° if (sftpProperties.getPrivateKeyPath() != null) { if (sftpProperties.getPassphrase() != null) { jsch.addIdentity(sftpProperties.getPrivateKeyPath(), sftpProperties.getPassphrase()); } else { jsch.addIdentity(sftpProperties.getPrivateKeyPath()); } } // è¨­å®š known_hosts if (sftpProperties.getKnownHostsFile() != null) { jsch.setKnownHosts(sftpProperties.getKnownHostsFile()); } log.info(\u0026#34;SFTP JSch åˆå§‹åŒ–å®Œæˆ\u0026#34;); } catch (JSchException e) { log.error(\u0026#34;SFTP JSch åˆå§‹åŒ–å¤±æ•—\u0026#34;, e); throw new RuntimeException(\u0026#34;SFTP JSch åˆå§‹åŒ–å¤±æ•—\u0026#34;, e); } } @Override public ChannelSftp create() throws Exception { log.debug(\u0026#34;å‰µå»ºæ–°çš„ SFTP é€£ç·šåˆ° {}:{}\u0026#34;, sftpProperties.getHost(), sftpProperties.getPort()); Session session = jsch.getSession( sftpProperties.getUsername(), sftpProperties.getHost(), sftpProperties.getPort() ); // è¨­å®šå¯†ç¢¼ï¼ˆå¦‚æœæœ‰ï¼‰ if (sftpProperties.getPassword() != null) { session.setPassword(sftpProperties.getPassword()); } // è¨­å®šé€£ç·šå±¬æ€§ Properties config = new Properties(); config.put(\u0026#34;StrictHostKeyChecking\u0026#34;, sftpProperties.isStrictHostKeyChecking() ? \u0026#34;yes\u0026#34; : \u0026#34;no\u0026#34;); if (sftpProperties.getHostKeyAlgorithms() != null) { config.put(\u0026#34;server_host_key\u0026#34;, sftpProperties.getHostKeyAlgorithms()); } session.setConfig(config); session.setTimeout(sftpProperties.getSessionTimeout()); // å»ºç«‹é€£ç·š session.connect(sftpProperties.getConnectTimeout()); Channel channel = session.openChannel(\u0026#34;sftp\u0026#34;); channel.connect(sftpProperties.getChannelTimeout()); ChannelSftp channelSftp = (ChannelSftp) channel; log.debug(\u0026#34;SFTP é€£ç·šå‰µå»ºæˆåŠŸ\u0026#34;); return channelSftp; } @Override public PooledObject\u0026lt;ChannelSftp\u0026gt; wrap(ChannelSftp channelSftp) { return new DefaultPooledObject\u0026lt;\u0026gt;(channelSftp); } @Override public boolean validateObject(PooledObject\u0026lt;ChannelSftp\u0026gt; pooledObject) { ChannelSftp channelSftp = pooledObject.getObject(); return channelSftp != null \u0026amp;\u0026amp; channelSftp.isConnected(); } @Override public void destroyObject(PooledObject\u0026lt;ChannelSftp\u0026gt; pooledObject) throws Exception { ChannelSftp channelSftp = pooledObject.getObject(); if (channelSftp != null) { Session session = channelSftp.getSession(); if (channelSftp.isConnected()) { channelSftp.disconnect(); } if (session != null \u0026amp;\u0026amp; session.isConnected()) { session.disconnect(); } } log.debug(\u0026#34;SFTP é€£ç·šå·²éŠ·æ¯€\u0026#34;); } } SFTP é€£ç·šæ± ç®¡ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 import org.apache.commons.pool2.ObjectPool; import org.apache.commons.pool2.impl.GenericObjectPool; import org.apache.commons.pool2.impl.GenericObjectPoolConfig; import org.springframework.stereotype.Component; import lombok.extern.slf4j.Slf4j; @Slf4j @Component public class SftpConnectionPoolManager { private final ObjectPool\u0026lt;ChannelSftp\u0026gt; sftpPool; private final SftpProperties sftpProperties; public SftpConnectionPoolManager(SftpConnectionFactory factory, SftpProperties sftpProperties) { this.sftpProperties = sftpProperties; this.sftpPool = createPool(factory); } private ObjectPool\u0026lt;ChannelSftp\u0026gt; createPool(SftpConnectionFactory factory) { GenericObjectPoolConfig\u0026lt;ChannelSftp\u0026gt; config = new GenericObjectPoolConfig\u0026lt;\u0026gt;(); config.setMaxTotal(sftpProperties.getPool().getMaxActive()); config.setMaxIdle(sftpProperties.getPool().getMaxIdle()); config.setMinIdle(sftpProperties.getPool().getMinIdle()); config.setMaxWaitMillis(sftpProperties.getPool().getMaxWait()); config.setTestOnBorrow(sftpProperties.getPool().isTestOnBorrow()); config.setTestOnReturn(sftpProperties.getPool().isTestOnReturn()); config.setTestWhileIdle(sftpProperties.getPool().isTestWhileIdle()); config.setTimeBetweenEvictionRunsMillis(sftpProperties.getPool().getTimeBetweenEvictionRuns()); config.setMinEvictableIdleTimeMillis(sftpProperties.getPool().getMinEvictableIdleTime()); return new GenericObjectPool\u0026lt;\u0026gt;(factory, config); } public ChannelSftp borrowConnection() throws Exception { return sftpPool.borrowObject(); } public void returnConnection(ChannelSftp channelSftp) { if (channelSftp != null) { try { sftpPool.returnObject(channelSftp); } catch (Exception e) { log.error(\u0026#34;æ­¸é‚„ SFTP é€£ç·šå¤±æ•—\u0026#34;, e); } } } public void invalidateConnection(ChannelSftp channelSftp) { if (channelSftp != null) { try { sftpPool.invalidateObject(channelSftp); } catch (Exception e) { log.error(\u0026#34;ç„¡æ•ˆåŒ– SFTP é€£ç·šå¤±æ•—\u0026#34;, e); } } } public int getActiveConnections() { return sftpPool.getNumActive(); } public int getIdleConnections() { return sftpPool.getNumIdle(); } } ä¼æ¥­ç´š SFTP å·¥å…·é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 import com.jcraft.jsch.ChannelSftp; import com.jcraft.jsch.SftpException; import io.micrometer.core.instrument.Counter; import io.micrometer.core.instrument.MeterRegistry; import io.micrometer.core.instrument.Timer; import lombok.extern.slf4j.Slf4j; import org.springframework.stereotype.Component; import java.io.*; import java.nio.file.Files; import java.nio.file.Path; import java.nio.file.Paths; import java.util.ArrayList; import java.util.List; import java.util.Vector; import java.util.concurrent.CompletableFuture; import java.util.concurrent.ExecutorService; import java.util.concurrent.Executors; import java.util.function.Function; @Slf4j @Component public class SftpUtil { private final SftpConnectionPoolManager connectionPoolManager; private final SftpProperties sftpProperties; private final ExecutorService executorService; // ç›£æ§æŒ‡æ¨™ private final Counter uploadCounter; private final Counter downloadCounter; private final Counter deleteCounter; private final Counter errorCounter; private final Timer uploadTimer; private final Timer downloadTimer; public SftpUtil(SftpConnectionPoolManager connectionPoolManager, SftpProperties sftpProperties, MeterRegistry meterRegistry) { this.connectionPoolManager = connectionPoolManager; this.sftpProperties = sftpProperties; this.executorService = Executors.newFixedThreadPool(10); // åˆå§‹åŒ–ç›£æ§æŒ‡æ¨™ this.uploadCounter = Counter.builder(\u0026#34;sftp.upload.total\u0026#34;) .description(\u0026#34;Total number of file uploads\u0026#34;) .register(meterRegistry); this.downloadCounter = Counter.builder(\u0026#34;sftp.download.total\u0026#34;) .description(\u0026#34;Total number of file downloads\u0026#34;) .register(meterRegistry); this.deleteCounter = Counter.builder(\u0026#34;sftp.delete.total\u0026#34;) .description(\u0026#34;Total number of file deletions\u0026#34;) .register(meterRegistry); this.errorCounter = Counter.builder(\u0026#34;sftp.error.total\u0026#34;) .description(\u0026#34;Total number of errors\u0026#34;) .register(meterRegistry); this.uploadTimer = Timer.builder(\u0026#34;sftp.upload.duration\u0026#34;) .description(\u0026#34;File upload duration\u0026#34;) .register(meterRegistry); this.downloadTimer = Timer.builder(\u0026#34;sftp.download.duration\u0026#34;) .description(\u0026#34;File download duration\u0026#34;) .register(meterRegistry); } /** * ä¸Šå‚³æ–‡ä»¶ */ public boolean uploadFile(String localFilePath, String remoteFilePath) { return uploadTimer.recordCallable(() -\u0026gt; { boolean success = executeWithRetry(channelSftp -\u0026gt; { try { createRemoteDirectoryIfNotExists(channelSftp, getParentPath(remoteFilePath)); try (FileInputStream fis = new FileInputStream(localFilePath)) { channelSftp.put(fis, remoteFilePath); log.info(\u0026#34;æ–‡ä»¶ä¸Šå‚³æˆåŠŸ: {} -\u0026gt; {}\u0026#34;, localFilePath, remoteFilePath); uploadCounter.increment(); return true; } } catch (Exception e) { log.error(\u0026#34;æ–‡ä»¶ä¸Šå‚³å¤±æ•—: {} -\u0026gt; {}\u0026#34;, localFilePath, remoteFilePath, e); errorCounter.increment(); throw new RuntimeException(\u0026#34;æ–‡ä»¶ä¸Šå‚³å¤±æ•—\u0026#34;, e); } }); return success; }); } /** * æ‰¹é‡ä¸Šå‚³æ–‡ä»¶ */ public List\u0026lt;CompletableFuture\u0026lt;Boolean\u0026gt;\u0026gt; uploadFilesAsync(List\u0026lt;FileTransferRequest\u0026gt; requests) { List\u0026lt;CompletableFuture\u0026lt;Boolean\u0026gt;\u0026gt; futures = new ArrayList\u0026lt;\u0026gt;(); for (FileTransferRequest request : requests) { CompletableFuture\u0026lt;Boolean\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; uploadFile(request.getLocalPath(), request.getRemotePath()), executorService); futures.add(future); } return futures; } /** * ä¸‹è¼‰æ–‡ä»¶ */ public boolean downloadFile(String remoteFilePath, String localFilePath) { return downloadTimer.recordCallable(() -\u0026gt; { boolean success = executeWithRetry(channelSftp -\u0026gt; { try { createLocalDirectoryIfNotExists(getParentPath(localFilePath)); try (FileOutputStream fos = new FileOutputStream(localFilePath)) { channelSftp.get(remoteFilePath, fos); log.info(\u0026#34;æ–‡ä»¶ä¸‹è¼‰æˆåŠŸ: {} -\u0026gt; {}\u0026#34;, remoteFilePath, localFilePath); downloadCounter.increment(); return true; } } catch (Exception e) { log.error(\u0026#34;æ–‡ä»¶ä¸‹è¼‰å¤±æ•—: {} -\u0026gt; {}\u0026#34;, remoteFilePath, localFilePath, e); errorCounter.increment(); throw new RuntimeException(\u0026#34;æ–‡ä»¶ä¸‹è¼‰å¤±æ•—\u0026#34;, e); } }); return success; }); } /** * ä¸‹è¼‰æ–‡ä»¶åˆ°è¼¸å‡ºæµ */ public void downloadFileToStream(String remoteFilePath, OutputStream outputStream) { executeWithRetry(channelSftp -\u0026gt; { try { channelSftp.get(remoteFilePath, outputStream); log.info(\u0026#34;æ–‡ä»¶ä¸‹è¼‰åˆ°æµæˆåŠŸ: {}\u0026#34;, remoteFilePath); downloadCounter.increment(); return true; } catch (Exception e) { log.error(\u0026#34;æ–‡ä»¶ä¸‹è¼‰åˆ°æµå¤±æ•—: {}\u0026#34;, remoteFilePath, e); errorCounter.increment(); throw new RuntimeException(\u0026#34;æ–‡ä»¶ä¸‹è¼‰åˆ°æµå¤±æ•—\u0026#34;, e); } }); } /** * ç²å–æ–‡ä»¶å…§å®¹ç‚ºå­—ç¬¦ä¸² */ public String getFileContent(String remoteFilePath) { return executeWithRetry(channelSftp -\u0026gt; { try (InputStream inputStream = channelSftp.get(remoteFilePath); BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))) { StringBuilder content = new StringBuilder(); String line; while ((line = reader.readLine()) != null) { content.append(line).append(\u0026#34;\\n\u0026#34;); } log.info(\u0026#34;ç²å–æ–‡ä»¶å…§å®¹æˆåŠŸ: {}\u0026#34;, remoteFilePath); return content.toString(); } catch (Exception e) { log.error(\u0026#34;ç²å–æ–‡ä»¶å…§å®¹å¤±æ•—: {}\u0026#34;, remoteFilePath, e); errorCounter.increment(); throw new RuntimeException(\u0026#34;ç²å–æ–‡ä»¶å…§å®¹å¤±æ•—\u0026#34;, e); } }); } /** * åˆªé™¤æ–‡ä»¶ */ public boolean deleteFile(String remoteFilePath) { return executeWithRetry(channelSftp -\u0026gt; { try { channelSftp.rm(remoteFilePath); log.info(\u0026#34;æ–‡ä»¶åˆªé™¤æˆåŠŸ: {}\u0026#34;, remoteFilePath); deleteCounter.increment(); return true; } catch (Exception e) { log.error(\u0026#34;æ–‡ä»¶åˆªé™¤å¤±æ•—: {}\u0026#34;, remoteFilePath, e); errorCounter.increment(); throw new RuntimeException(\u0026#34;æ–‡ä»¶åˆªé™¤å¤±æ•—\u0026#34;, e); } }); } /** * åˆ—å‡ºç›®éŒ„æ–‡ä»¶ */ public List\u0026lt;SftpFileInfo\u0026gt; listFiles(String remotePath) { return executeWithRetry(channelSftp -\u0026gt; { try { Vector\u0026lt;ChannelSftp.LsEntry\u0026gt; entries = channelSftp.ls(remotePath); List\u0026lt;SftpFileInfo\u0026gt; fileInfos = new ArrayList\u0026lt;\u0026gt;(); for (ChannelSftp.LsEntry entry : entries) { if (!entry.getFilename().equals(\u0026#34;.\u0026#34;) \u0026amp;\u0026amp; !entry.getFilename().equals(\u0026#34;..\u0026#34;)) { SftpFileInfo fileInfo = new SftpFileInfo(); fileInfo.setFilename(entry.getFilename()); fileInfo.setSize(entry.getAttrs().getSize()); fileInfo.setModifiedTime(entry.getAttrs().getMTime()); fileInfo.setDirectory(entry.getAttrs().isDir()); fileInfos.add(fileInfo); } } log.info(\u0026#34;åˆ—å‡ºç›®éŒ„æ–‡ä»¶æˆåŠŸ: {}, å…± {} å€‹æ–‡ä»¶\u0026#34;, remotePath, fileInfos.size()); return fileInfos; } catch (Exception e) { log.error(\u0026#34;åˆ—å‡ºç›®éŒ„æ–‡ä»¶å¤±æ•—: {}\u0026#34;, remotePath, e); errorCounter.increment(); throw new RuntimeException(\u0026#34;åˆ—å‡ºç›®éŒ„æ–‡ä»¶å¤±æ•—\u0026#34;, e); } }); } /** * æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ */ public boolean fileExists(String remoteFilePath) { return executeWithRetry(channelSftp -\u0026gt; { try { channelSftp.stat(remoteFilePath); return true; } catch (SftpException e) { if (e.id == ChannelSftp.SSH_FX_NO_SUCH_FILE) { return false; } throw new RuntimeException(\u0026#34;æª¢æŸ¥æ–‡ä»¶å­˜åœ¨æ€§å¤±æ•—\u0026#34;, e); } }); } /** * å‰µå»ºé ç«¯ç›®éŒ„ */ public void createRemoteDirectory(String remotePath) { executeWithRetry(channelSftp -\u0026gt; { try { createRemoteDirectoryIfNotExists(channelSftp, remotePath); log.info(\u0026#34;å‰µå»ºé ç«¯ç›®éŒ„æˆåŠŸ: {}\u0026#34;, remotePath); return true; } catch (Exception e) { log.error(\u0026#34;å‰µå»ºé ç«¯ç›®éŒ„å¤±æ•—: {}\u0026#34;, remotePath, e); errorCounter.increment(); throw new RuntimeException(\u0026#34;å‰µå»ºé ç«¯ç›®éŒ„å¤±æ•—\u0026#34;, e); } }); } /** * å¸¶é‡è©¦æ©Ÿåˆ¶çš„åŸ·è¡Œå™¨ */ private \u0026lt;T\u0026gt; T executeWithRetry(Function\u0026lt;ChannelSftp, T\u0026gt; operation) { int attempts = 0; Exception lastException = null; while (attempts \u0026lt; sftpProperties.getMaxRetries()) { ChannelSftp channelSftp = null; try { channelSftp = connectionPoolManager.borrowConnection(); return operation.apply(channelSftp); } catch (Exception e) { lastException = e; attempts++; if (channelSftp != null) { connectionPoolManager.invalidateConnection(channelSftp); channelSftp = null; } if (attempts \u0026lt; sftpProperties.getMaxRetries()) { log.warn(\u0026#34;SFTP æ“ä½œå¤±æ•—ï¼Œç¬¬ {} æ¬¡é‡è©¦\u0026#34;, attempts, e); try { Thread.sleep(sftpProperties.getRetryDelay()); } catch (InterruptedException ie) { Thread.currentThread().interrupt(); throw new RuntimeException(\u0026#34;æ“ä½œè¢«ä¸­æ–·\u0026#34;, ie); } } } finally { if (channelSftp != null) { connectionPoolManager.returnConnection(channelSftp); } } } throw new RuntimeException(\u0026#34;SFTP æ“ä½œå¤±æ•—ï¼Œå·²é‡è©¦ \u0026#34; + sftpProperties.getMaxRetries() + \u0026#34; æ¬¡\u0026#34;, lastException); } /** * å‰µå»ºé ç«¯ç›®éŒ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ */ private void createRemoteDirectoryIfNotExists(ChannelSftp channelSftp, String remotePath) throws SftpException { if (remotePath == null || remotePath.trim().isEmpty()) { return; } String[] dirs = remotePath.split(\u0026#34;/\u0026#34;); String currentPath = \u0026#34;\u0026#34;; for (String dir : dirs) { if (dir.isEmpty()) continue; currentPath += \u0026#34;/\u0026#34; + dir; try { channelSftp.stat(currentPath); } catch (SftpException e) { if (e.id == ChannelSftp.SSH_FX_NO_SUCH_FILE) { channelSftp.mkdir(currentPath); } else { throw e; } } } } /** * å‰µå»ºæœ¬åœ°ç›®éŒ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ */ private void createLocalDirectoryIfNotExists(String localPath) throws IOException { if (localPath != null \u0026amp;\u0026amp; !localPath.trim().isEmpty()) { Path path = Paths.get(localPath); if (!Files.exists(path)) { Files.createDirectories(path); } } } /** * ç²å–çˆ¶è·¯å¾‘ */ private String getParentPath(String filePath) { if (filePath == null) return null; int lastSlashIndex = filePath.lastIndexOf(\u0026#39;/\u0026#39;); if (lastSlashIndex \u0026gt; 0) { return filePath.substring(0, lastSlashIndex); } return null; } /** * ç²å–é€£ç·šæ± ç‹€æ…‹ */ public SftpConnectionPoolStatus getConnectionPoolStatus() { SftpConnectionPoolStatus status = new SftpConnectionPoolStatus(); status.setActiveConnections(connectionPoolManager.getActiveConnections()); status.setIdleConnections(connectionPoolManager.getIdleConnections()); return status; } } æ”¯æ´é¡åˆ¥ æ–‡ä»¶å‚³è¼¸è«‹æ±‚é¡ 1 2 3 4 5 6 7 8 9 10 11 import lombok.Data; import lombok.AllArgsConstructor; import lombok.NoArgsConstructor; @Data @NoArgsConstructor @AllArgsConstructor public class FileTransferRequest { private String localPath; private String remotePath; } SFTP æ–‡ä»¶ä¿¡æ¯é¡ 1 2 3 4 5 6 7 8 9 import lombok.Data; @Data public class SftpFileInfo { private String filename; private long size; private int modifiedTime; private boolean directory; } é€£ç·šæ± ç‹€æ…‹é¡ 1 2 3 4 5 6 7 import lombok.Data; @Data public class SftpConnectionPoolStatus { private int activeConnections; private int idleConnections; } æœå‹™å±¤æ•´åˆ SFTP æœå‹™é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 import org.springframework.stereotype.Service; import org.springframework.web.multipart.MultipartFile; import lombok.extern.slf4j.Slf4j; import java.io.IOException; import java.nio.file.Files; import java.nio.file.Path; import java.nio.file.Paths; import java.util.List; import java.util.UUID; @Slf4j @Service public class SftpService { private final SftpUtil sftpUtil; private static final String TEMP_DIR = System.getProperty(\u0026#34;java.io.tmpdir\u0026#34;); public SftpService(SftpUtil sftpUtil) { this.sftpUtil = sftpUtil; } /** * ä¸Šå‚³ MultipartFile åˆ° SFTP */ public boolean uploadMultipartFile(MultipartFile file, String remoteDirectory) { String tempFilePath = null; try { // å‰µå»ºè‡¨æ™‚æ–‡ä»¶ tempFilePath = createTempFile(file); // æ§‹å»ºé ç«¯è·¯å¾‘ String remoteFilePath = remoteDirectory + \u0026#34;/\u0026#34; + file.getOriginalFilename(); // ä¸Šå‚³æ–‡ä»¶ boolean success = sftpUtil.uploadFile(tempFilePath, remoteFilePath); if (success) { log.info(\u0026#34;MultipartFile ä¸Šå‚³æˆåŠŸ: {}\u0026#34;, file.getOriginalFilename()); } return success; } catch (Exception e) { log.error(\u0026#34;MultipartFile ä¸Šå‚³å¤±æ•—: {}\u0026#34;, file.getOriginalFilename(), e); return false; } finally { // æ¸…ç†è‡¨æ™‚æ–‡ä»¶ if (tempFilePath != null) { cleanupTempFile(tempFilePath); } } } /** * æ‰¹é‡ä¸Šå‚³æ–‡ä»¶ */ public void uploadFiles(List\u0026lt;MultipartFile\u0026gt; files, String remoteDirectory) { for (MultipartFile file : files) { uploadMultipartFile(file, remoteDirectory); } } /** * ä¸‹è¼‰æ–‡ä»¶ä¸¦è¿”å›å­—ç¯€æ•¸çµ„ */ public byte[] downloadFileAsBytes(String remoteFilePath) { String tempFilePath = null; try { // å‰µå»ºè‡¨æ™‚æ–‡ä»¶è·¯å¾‘ tempFilePath = TEMP_DIR + \u0026#34;/\u0026#34; + UUID.randomUUID() + \u0026#34;_download\u0026#34;; // ä¸‹è¼‰æ–‡ä»¶ boolean success = sftpUtil.downloadFile(remoteFilePath, tempFilePath); if (success) { Path path = Paths.get(tempFilePath); return Files.readAllBytes(path); } return null; } catch (Exception e) { log.error(\u0026#34;ä¸‹è¼‰æ–‡ä»¶å¤±æ•—: {}\u0026#34;, remoteFilePath, e); return null; } finally { // æ¸…ç†è‡¨æ™‚æ–‡ä»¶ if (tempFilePath != null) { cleanupTempFile(tempFilePath); } } } /** * ç²å–ç›®éŒ„æ–‡ä»¶åˆ—è¡¨ */ public List\u0026lt;SftpFileInfo\u0026gt; listDirectoryFiles(String remotePath) { return sftpUtil.listFiles(remotePath); } /** * åˆªé™¤æ–‡ä»¶ */ public boolean deleteFile(String remoteFilePath) { return sftpUtil.deleteFile(remoteFilePath); } /** * æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ */ public boolean checkFileExists(String remoteFilePath) { return sftpUtil.fileExists(remoteFilePath); } /** * å‰µå»ºè‡¨æ™‚æ–‡ä»¶ */ private String createTempFile(MultipartFile file) throws IOException { String tempFileName = UUID.randomUUID() + \u0026#34;_\u0026#34; + file.getOriginalFilename(); Path tempPath = Paths.get(TEMP_DIR, tempFileName); Files.write(tempPath, file.getBytes()); return tempPath.toString(); } /** * æ¸…ç†è‡¨æ™‚æ–‡ä»¶ */ private void cleanupTempFile(String tempFilePath) { try { Files.deleteIfExists(Paths.get(tempFilePath)); } catch (IOException e) { log.warn(\u0026#34;æ¸…ç†è‡¨æ™‚æ–‡ä»¶å¤±æ•—: {}\u0026#34;, tempFilePath, e); } } } æ§åˆ¶å™¨å±¤ SFTP æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 import org.springframework.http.HttpStatus; import org.springframework.http.ResponseEntity; import org.springframework.web.bind.annotation.*; import org.springframework.web.multipart.MultipartFile; import lombok.extern.slf4j.Slf4j; import java.util.List; @Slf4j @RestController @RequestMapping(\u0026#34;/api/sftp\u0026#34;) public class SftpController { private final SftpService sftpService; public SftpController(SftpService sftpService) { this.sftpService = sftpService; } /** * ä¸Šå‚³æ–‡ä»¶ */ @PostMapping(\u0026#34;/upload\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; uploadFile(@RequestParam(\u0026#34;file\u0026#34;) MultipartFile file, @RequestParam(\u0026#34;directory\u0026#34;) String directory) { try { boolean success = sftpService.uploadMultipartFile(file, directory); if (success) { return ResponseEntity.ok(\u0026#34;æ–‡ä»¶ä¸Šå‚³æˆåŠŸ\u0026#34;); } else { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(\u0026#34;æ–‡ä»¶ä¸Šå‚³å¤±æ•—\u0026#34;); } } catch (Exception e) { log.error(\u0026#34;ä¸Šå‚³æ–‡ä»¶ç•°å¸¸\u0026#34;, e); return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(\u0026#34;ä¸Šå‚³æ–‡ä»¶ç•°å¸¸: \u0026#34; + e.getMessage()); } } /** * æ‰¹é‡ä¸Šå‚³æ–‡ä»¶ */ @PostMapping(\u0026#34;/upload/batch\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; uploadFiles(@RequestParam(\u0026#34;files\u0026#34;) List\u0026lt;MultipartFile\u0026gt; files, @RequestParam(\u0026#34;directory\u0026#34;) String directory) { try { sftpService.uploadFiles(files, directory); return ResponseEntity.ok(\u0026#34;æ‰¹é‡ä¸Šå‚³æˆåŠŸ\u0026#34;); } catch (Exception e) { log.error(\u0026#34;æ‰¹é‡ä¸Šå‚³æ–‡ä»¶ç•°å¸¸\u0026#34;, e); return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(\u0026#34;æ‰¹é‡ä¸Šå‚³ç•°å¸¸: \u0026#34; + e.getMessage()); } } /** * ä¸‹è¼‰æ–‡ä»¶ */ @GetMapping(\u0026#34;/download\u0026#34;) public ResponseEntity\u0026lt;byte[]\u0026gt; downloadFile(@RequestParam(\u0026#34;filePath\u0026#34;) String filePath) { try { byte[] fileBytes = sftpService.downloadFileAsBytes(filePath); if (fileBytes != null) { return ResponseEntity.ok() .header(\u0026#34;Content-Disposition\u0026#34;, \u0026#34;attachment; filename=\\\u0026#34;\u0026#34; + filePath.substring(filePath.lastIndexOf(\u0026#34;/\u0026#34;) + 1) + \u0026#34;\\\u0026#34;\u0026#34;) .body(fileBytes); } else { return ResponseEntity.notFound().build(); } } catch (Exception e) { log.error(\u0026#34;ä¸‹è¼‰æ–‡ä»¶ç•°å¸¸\u0026#34;, e); return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build(); } } /** * åˆ—å‡ºç›®éŒ„æ–‡ä»¶ */ @GetMapping(\u0026#34;/list\u0026#34;) public ResponseEntity\u0026lt;List\u0026lt;SftpFileInfo\u0026gt;\u0026gt; listFiles(@RequestParam(\u0026#34;directory\u0026#34;) String directory) { try { List\u0026lt;SftpFileInfo\u0026gt; files = sftpService.listDirectoryFiles(directory); return ResponseEntity.ok(files); } catch (Exception e) { log.error(\u0026#34;åˆ—å‡ºç›®éŒ„æ–‡ä»¶ç•°å¸¸\u0026#34;, e); return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build(); } } /** * åˆªé™¤æ–‡ä»¶ */ @DeleteMapping(\u0026#34;/delete\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; deleteFile(@RequestParam(\u0026#34;filePath\u0026#34;) String filePath) { try { boolean success = sftpService.deleteFile(filePath); if (success) { return ResponseEntity.ok(\u0026#34;æ–‡ä»¶åˆªé™¤æˆåŠŸ\u0026#34;); } else { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(\u0026#34;æ–‡ä»¶åˆªé™¤å¤±æ•—\u0026#34;); } } catch (Exception e) { log.error(\u0026#34;åˆªé™¤æ–‡ä»¶ç•°å¸¸\u0026#34;, e); return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(\u0026#34;åˆªé™¤æ–‡ä»¶ç•°å¸¸: \u0026#34; + e.getMessage()); } } /** * æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ */ @GetMapping(\u0026#34;/exists\u0026#34;) public ResponseEntity\u0026lt;Boolean\u0026gt; checkFileExists(@RequestParam(\u0026#34;filePath\u0026#34;) String filePath) { try { boolean exists = sftpService.checkFileExists(filePath); return ResponseEntity.ok(exists); } catch (Exception e) { log.error(\u0026#34;æª¢æŸ¥æ–‡ä»¶å­˜åœ¨æ€§ç•°å¸¸\u0026#34;, e); return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build(); } } } ç›£æ§èˆ‡å¥åº·æª¢æŸ¥ SFTP å¥åº·æª¢æŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 import org.springframework.boot.actuator.health.Health; import org.springframework.boot.actuator.health.HealthIndicator; import org.springframework.stereotype.Component; import lombok.extern.slf4j.Slf4j; @Slf4j @Component public class SftpHealthIndicator implements HealthIndicator { private final SftpUtil sftpUtil; public SftpHealthIndicator(SftpUtil sftpUtil) { this.sftpUtil = sftpUtil; } @Override public Health health() { try { // æª¢æŸ¥é€£ç·šæ± ç‹€æ…‹ SftpConnectionPoolStatus poolStatus = sftpUtil.getConnectionPoolStatus(); Health.Builder builder = Health.up() .withDetail(\u0026#34;activeConnections\u0026#34;, poolStatus.getActiveConnections()) .withDetail(\u0026#34;idleConnections\u0026#34;, poolStatus.getIdleConnections()) .withDetail(\u0026#34;status\u0026#34;, \u0026#34;SFTP æœå‹™æ­£å¸¸é‹è¡Œ\u0026#34;); return builder.build(); } catch (Exception e) { log.error(\u0026#34;SFTP å¥åº·æª¢æŸ¥å¤±æ•—\u0026#34;, e); return Health.down() .withDetail(\u0026#34;error\u0026#34;, e.getMessage()) .withDetail(\u0026#34;status\u0026#34;, \u0026#34;SFTP æœå‹™ç•°å¸¸\u0026#34;) .build(); } } } è‡ªè¨‚ç›£æ§ç«¯é» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import org.springframework.boot.actuate.endpoint.annotation.Endpoint; import org.springframework.boot.actuator.endpoint.annotation.ReadOperation; import org.springframework.stereotype.Component; import java.util.HashMap; import java.util.Map; @Component @Endpoint(id = \u0026#34;sftp\u0026#34;) public class SftpEndpoint { private final SftpUtil sftpUtil; public SftpEndpoint(SftpUtil sftpUtil) { this.sftpUtil = sftpUtil; } @ReadOperation public Map\u0026lt;String, Object\u0026gt; sftpInfo() { Map\u0026lt;String, Object\u0026gt; info = new HashMap\u0026lt;\u0026gt;(); try { SftpConnectionPoolStatus poolStatus = sftpUtil.getConnectionPoolStatus(); info.put(\u0026#34;connectionPool\u0026#34;, poolStatus); info.put(\u0026#34;status\u0026#34;, \u0026#34;healthy\u0026#34;); } catch (Exception e) { info.put(\u0026#34;status\u0026#34;, \u0026#34;unhealthy\u0026#34;); info.put(\u0026#34;error\u0026#34;, e.getMessage()); } return info; } } æ¸¬è©¦ å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 import org.junit.jupiter.api.Test; import org.junit.jupiter.api.BeforeEach; import org.junit.jupiter.api.extension.ExtendWith; import org.mockito.Mock; import org.mockito.junit.jupiter.MockitoExtension; import org.springframework.test.context.junit.jupiter.SpringJUnitConfig; import java.io.ByteArrayInputStream; import java.io.InputStream; import static org.junit.jupiter.api.Assertions.*; import static org.mockito.Mockito.*; @ExtendWith(MockitoExtension.class) @SpringJUnitConfig class SftpUtilTest { @Mock private SftpConnectionPoolManager mockConnectionPoolManager; @Mock private ChannelSftp mockChannelSftp; @Mock private SftpProperties mockSftpProperties; private SftpUtil sftpUtil; @BeforeEach void setUp() { when(mockSftpProperties.getMaxRetries()).thenReturn(3); when(mockSftpProperties.getRetryDelay()).thenReturn(1000); sftpUtil = new SftpUtil(mockConnectionPoolManager, mockSftpProperties, null); } @Test void testUploadFile_Success() throws Exception { // Given String localPath = \u0026#34;test.txt\u0026#34;; String remotePath = \u0026#34;/remote/test.txt\u0026#34;; when(mockConnectionPoolManager.borrowConnection()).thenReturn(mockChannelSftp); // When boolean result = sftpUtil.uploadFile(localPath, remotePath); // Then assertTrue(result); verify(mockChannelSftp, times(1)).put(any(InputStream.class), eq(remotePath)); verify(mockConnectionPoolManager, times(1)).returnConnection(mockChannelSftp); } @Test void testDownloadFile_Success() throws Exception { // Given String remotePath = \u0026#34;/remote/test.txt\u0026#34;; String localPath = \u0026#34;test.txt\u0026#34;; InputStream mockInputStream = new ByteArrayInputStream(\u0026#34;test content\u0026#34;.getBytes()); when(mockConnectionPoolManager.borrowConnection()).thenReturn(mockChannelSftp); when(mockChannelSftp.get(remotePath)).thenReturn(mockInputStream); // When boolean result = sftpUtil.downloadFile(remotePath, localPath); // Then assertTrue(result); verify(mockChannelSftp, times(1)).get(eq(remotePath), any()); verify(mockConnectionPoolManager, times(1)).returnConnection(mockChannelSftp); } @Test void testFileExists_FileExists() throws Exception { // Given String remotePath = \u0026#34;/remote/test.txt\u0026#34;; when(mockConnectionPoolManager.borrowConnection()).thenReturn(mockChannelSftp); when(mockChannelSftp.stat(remotePath)).thenReturn(null); // ä¸æ‹‹å‡ºç•°å¸¸è¡¨ç¤ºæ–‡ä»¶å­˜åœ¨ // When boolean result = sftpUtil.fileExists(remotePath); // Then assertTrue(result); verify(mockChannelSftp, times(1)).stat(remotePath); verify(mockConnectionPoolManager, times(1)).returnConnection(mockChannelSftp); } } æ•´åˆæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 import org.junit.jupiter.api.Test; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.test.context.ActiveProfiles; import org.springframework.test.context.junit.jupiter.SpringJUnitConfig; import org.springframework.beans.factory.annotation.Autowired; @SpringBootTest @ActiveProfiles(\u0026#34;test\u0026#34;) @SpringJUnitConfig class SftpIntegrationTest { @Autowired private SftpService sftpService; @Test void testSftpServiceIntegration() { // æ•´åˆæ¸¬è©¦æ‡‰è©²ä½¿ç”¨æ¸¬è©¦ SFTP æœå‹™å™¨ // é€™è£¡åªæ˜¯å±•ç¤ºæ¸¬è©¦çµæ§‹ // Given String testDirectory = \u0026#34;/test\u0026#34;; // When \u0026amp; Then // åŸ·è¡Œå¯¦éš›çš„ SFTP æ“ä½œæ¸¬è©¦ assertDoesNotThrow(() -\u0026gt; { sftpService.listDirectoryFiles(testDirectory); }); } } æœ€ä½³å¯¦è¸ 1. å®‰å…¨æ€§è€ƒæ…® 1 2 3 4 5 6 7 8 9 10 11 12 13 # ç”Ÿç”¢ç’°å¢ƒé…ç½® sftp: # ä½¿ç”¨ç’°å¢ƒè®Šæ•¸æˆ– Vault ç®¡ç†æ•æ„Ÿä¿¡æ¯ username: ${SFTP_USERNAME} password: ${SFTP_PASSWORD} private-key-path: ${SFTP_PRIVATE_KEY_PATH} # å•Ÿç”¨åš´æ ¼çš„ä¸»æ©Ÿå¯†é‘°æª¢æŸ¥ strict-host-key-checking: true known-hosts-file: /etc/ssh/ssh_known_hosts # ä½¿ç”¨å®‰å…¨çš„ä¸»æ©Ÿå¯†é‘°ç®—æ³• host-key-algorithms: rsa-sha2-512,rsa-sha2-256 2. æ•ˆèƒ½å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // ä½¿ç”¨æ‰¹é‡æ“ä½œ @Component public class SftpBatchProcessor { public void processBatchUpload(List\u0026lt;FileTransferRequest\u0026gt; requests) { // åˆ†æ‰¹è™•ç†å¤§é‡æ–‡ä»¶ int batchSize = 10; for (int i = 0; i \u0026lt; requests.size(); i += batchSize) { List\u0026lt;FileTransferRequest\u0026gt; batch = requests.subList(i, Math.min(i + batchSize, requests.size())); processBatch(batch); } } private void processBatch(List\u0026lt;FileTransferRequest\u0026gt; batch) { // ä¸¦è¡Œè™•ç†æ‰¹æ¬¡ List\u0026lt;CompletableFuture\u0026lt;Boolean\u0026gt;\u0026gt; futures = sftpUtil.uploadFilesAsync(batch); // ç­‰å¾…æ‰€æœ‰ä»»å‹™å®Œæˆ CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join(); } } 3. éŒ¯èª¤è™•ç†ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Component public class SftpErrorHandler { public void handleSftpError(Exception e, String operation, String filePath) { if (e instanceof SftpException) { SftpException sftpException = (SftpException) e; switch (sftpException.id) { case ChannelSftp.SSH_FX_NO_SUCH_FILE: log.warn(\u0026#34;æ–‡ä»¶ä¸å­˜åœ¨: {}\u0026#34;, filePath); break; case ChannelSftp.SSH_FX_PERMISSION_DENIED: log.error(\u0026#34;æ¬Šé™ä¸è¶³: {}\u0026#34;, filePath); break; case ChannelSftp.SSH_FX_CONNECTION_LOST: log.error(\u0026#34;é€£ç·šä¸­æ–·: {}\u0026#34;, filePath); // è§¸ç™¼é‡é€£ break; default: log.error(\u0026#34;SFTP æ“ä½œå¤±æ•—: {} - {}\u0026#34;, operation, filePath, e); } } else { log.error(\u0026#34;ä¸€èˆ¬éŒ¯èª¤: {} - {}\u0026#34;, operation, filePath, e); } } } ç¸½çµ æœ¬æ–‡è©³ç´°ä»‹ç´¹äº†ä¼æ¥­ç´š SFTP å·¥å…·é¡çš„å®Œæ•´å¯¦ä½œï¼ŒåŒ…å«ä»¥ä¸‹é—œéµç‰¹æ€§ï¼š\né€£ç·šæ± ç®¡ç†ï¼šæä¾›é«˜æ•ˆçš„é€£ç·šå¾©ç”¨æ©Ÿåˆ¶ éŒ¯èª¤è™•ç†ï¼šå®Œå–„çš„é‡è©¦æ©Ÿåˆ¶å’ŒéŒ¯èª¤è™•ç†ç­–ç•¥ ç›£æ§æ©Ÿåˆ¶ï¼šæ•´åˆ Micrometer æä¾›å®Œæ•´çš„ç›£æ§æŒ‡æ¨™ å®‰å…¨é…ç½®ï¼šæ”¯æ´å¤šç¨®èªè­‰æ–¹å¼å’Œå®‰å…¨é…ç½®é¸é … æ‰¹é‡æ“ä½œï¼šæ”¯æ´å¤§é‡æ–‡ä»¶çš„ä¸¦è¡Œè™•ç† å¥åº·æª¢æŸ¥ï¼šæ•´åˆ Spring Boot Actuator æä¾›å¥åº·æª¢æŸ¥ æ¸¬è©¦è¦†è“‹ï¼šæä¾›å®Œæ•´çš„å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦ é€™å€‹ SFTP å·¥å…·é¡é©ç”¨æ–¼å„ç¨®ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯ï¼Œèƒ½å¤ ç©©å®šã€é«˜æ•ˆåœ°è™•ç†æ–‡ä»¶å‚³è¼¸ä»»å‹™ï¼ŒåŒæ™‚æä¾›è‰¯å¥½çš„å¯è§€æ¸¬æ€§å’Œç¶­è­·æ€§ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/sftputil/","tags":["SFTP","Spring Boot","File Transfer","JSch","Security","Java","Connection Pool","Enterprise","File Management","SSH","Secure Transfer","Best Practices","Error Handling","Performance","Monitoring","Configuration"],"title":"Spring Boot SFTP å·¥å…·é¡ï¼šä¼æ¥­ç´šå®‰å…¨æ–‡ä»¶å‚³è¼¸ç³»çµ±å¯¦ä½œæŒ‡å—"},{"content":"æ¦‚è¿° åœ¨è™•ç†å¤§é‡è³‡æ–™æ™‚ï¼Œåˆ†é æŸ¥è©¢æ˜¯å¿…ä¸å¯å°‘çš„åŠŸèƒ½ã€‚Spring Data JPA æä¾›äº†å¼·å¤§çš„ Pageable æ¥å£ï¼Œé…åˆ Specification å¯ä»¥è¼•é¬†å¯¦ç¾éˆæ´»çš„åˆ†é æŸ¥è©¢åŠŸèƒ½ã€‚æœ¬æ–‡å°‡æ·±å…¥ä»‹ç´¹å¦‚ä½•ä½¿ç”¨é€™äº›åŠŸèƒ½ä¾†æ§‹å»ºé«˜æ•ˆçš„åˆ†é ç³»çµ±ã€‚\næ ¸å¿ƒæ¦‚å¿µ Pageableï¼šåˆ†é åƒæ•¸æ¥å£ï¼Œå®šç¾©é é¢å¤§å°ã€é ç¢¼å’Œæ’åºè¦å‰‡ Pageï¼šåˆ†é çµæœæ¥å£ï¼ŒåŒ…å«è³‡æ–™å’Œåˆ†é è³‡è¨Š Specificationï¼šæŸ¥è©¢è¦æ ¼æ¥å£ï¼Œç”¨æ–¼å‹•æ…‹æ§‹å»ºæŸ¥è©¢æ¢ä»¶ Criteria APIï¼šJPA æ¨™æº–çš„é¡å‹å®‰å…¨æŸ¥è©¢ API æ¶æ§‹å„ªå‹¢ é¡å‹å®‰å…¨ï¼šCriteria API æä¾›ç·¨è­¯æ™‚æª¢æŸ¥ å‹•æ…‹æŸ¥è©¢ï¼šæ ¹æ“šæ¢ä»¶å‹•æ…‹æ§‹å»º SQL è‡ªå‹•è¨ˆæ•¸ï¼šè‡ªå‹•åŸ·è¡Œ COUNT æŸ¥è©¢è¨ˆç®—ç¸½æ•¸ éˆæ´»æ’åºï¼šæ”¯æ´å¤šæ¬„ä½æ’åº æ•ˆèƒ½å„ªåŒ–ï¼šæ”¯æ´å„ç¨®å„ªåŒ–ç­–ç•¥ åŸºç¤é…ç½® 1. ä¾è³´è¨­å®š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;!-- Spring Boot Starter Data JPA --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-jpa\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Spring Boot Starter Web --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Database Driver (ä»¥ MySQL ç‚ºä¾‹) --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Spring Boot Starter Validation --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-validation\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; 2. å¯¦é«”é¡å®šç¾© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 package com.example.pagination.entity; import jakarta.persistence.*; import jakarta.validation.constraints.NotBlank; import jakarta.validation.constraints.Email; import org.hibernate.annotations.CreationTimestamp; import org.hibernate.annotations.UpdateTimestamp; import java.time.LocalDateTime; @Entity @Table(name = \u0026#34;users\u0026#34;, indexes = { @Index(name = \u0026#34;idx_username\u0026#34;, columnList = \u0026#34;username\u0026#34;), @Index(name = \u0026#34;idx_email\u0026#34;, columnList = \u0026#34;email\u0026#34;), @Index(name = \u0026#34;idx_status\u0026#34;, columnList = \u0026#34;status\u0026#34;), @Index(name = \u0026#34;idx_created_at\u0026#34;, columnList = \u0026#34;created_at\u0026#34;) }) public class User { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @NotBlank @Column(unique = true, nullable = false, length = 50) private String username; @NotBlank @Email @Column(unique = true, nullable = false, length = 100) private String email; @Column(name = \u0026#34;first_name\u0026#34;, length = 50) private String firstName; @Column(name = \u0026#34;last_name\u0026#34;, length = 50) private String lastName; @Enumerated(EnumType.STRING) @Column(nullable = false) private UserStatus status = UserStatus.ACTIVE; @Column(name = \u0026#34;age\u0026#34;) private Integer age; @Column(name = \u0026#34;city\u0026#34;, length = 100) private String city; @CreationTimestamp @Column(name = \u0026#34;created_at\u0026#34;, nullable = false, updatable = false) private LocalDateTime createdAt; @UpdateTimestamp @Column(name = \u0026#34;updated_at\u0026#34;, nullable = false) private LocalDateTime updatedAt; // å»ºæ§‹å­ public User() {} public User(String username, String email, String firstName, String lastName) { this.username = username; this.email = email; this.firstName = firstName; this.lastName = lastName; } // Getters and Setters public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public String getFirstName() { return firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getLastName() { return lastName; } public void setLastName(String lastName) { this.lastName = lastName; } public UserStatus getStatus() { return status; } public void setStatus(UserStatus status) { this.status = status; } public Integer getAge() { return age; } public void setAge(Integer age) { this.age = age; } public String getCity() { return city; } public void setCity(String city) { this.city = city; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } } enum UserStatus { ACTIVE, INACTIVE, SUSPENDED, DELETED } 3. Repository æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package com.example.pagination.repository; import com.example.pagination.entity.User; import org.springframework.data.domain.Page; import org.springframework.data.domain.Pageable; import org.springframework.data.jpa.domain.Specification; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.jpa.repository.JpaSpecificationExecutor; import org.springframework.data.jpa.repository.Query; import org.springframework.data.repository.query.Param; import org.springframework.stereotype.Repository; import java.time.LocalDateTime; import java.util.List; @Repository public interface UserRepository extends JpaRepository\u0026lt;User, Long\u0026gt;, JpaSpecificationExecutor\u0026lt;User\u0026gt; { // åŸºæœ¬åˆ†é æŸ¥è©¢ Page\u0026lt;User\u0026gt; findByStatus(UserStatus status, Pageable pageable); // è¤‡åˆæ¢ä»¶åˆ†é æŸ¥è©¢ Page\u0026lt;User\u0026gt; findByStatusAndAgeGreaterThan(UserStatus status, Integer age, Pageable pageable); // æ¨¡ç³ŠæŸ¥è©¢åˆ†é  Page\u0026lt;User\u0026gt; findByUsernameContainingIgnoreCase(String username, Pageable pageable); // æ™‚é–“ç¯„åœæŸ¥è©¢ Page\u0026lt;User\u0026gt; findByCreatedAtBetween(LocalDateTime start, LocalDateTime end, Pageable pageable); // è‡ªè¨‚æŸ¥è©¢åˆ†é  @Query(\u0026#34;SELECT u FROM User u WHERE u.city = :city AND u.age BETWEEN :minAge AND :maxAge\u0026#34;) Page\u0026lt;User\u0026gt; findByCityAndAgeBetween(@Param(\u0026#34;city\u0026#34;) String city, @Param(\u0026#34;minAge\u0026#34;) Integer minAge, @Param(\u0026#34;maxAge\u0026#34;) Integer maxAge, Pageable pageable); // åŸç”Ÿ SQL åˆ†é æŸ¥è©¢ @Query(value = \u0026#34;SELECT * FROM users u WHERE u.email LIKE %:emailDomain%\u0026#34;, countQuery = \u0026#34;SELECT COUNT(*) FROM users u WHERE u.email LIKE %:emailDomain%\u0026#34;, nativeQuery = true) Page\u0026lt;User\u0026gt; findByEmailDomain(@Param(\u0026#34;emailDomain\u0026#34;) String emailDomain, Pageable pageable); // æŠ•å½±æŸ¥è©¢ï¼ˆåªæŸ¥è©¢éƒ¨åˆ†æ¬„ä½ï¼‰ @Query(\u0026#34;SELECT new com.example.pagination.dto.UserSummaryDto(u.id, u.username, u.email, u.status) \u0026#34; + \u0026#34;FROM User u WHERE u.status = :status\u0026#34;) Page\u0026lt;UserSummaryDto\u0026gt; findUserSummariesByStatus(@Param(\u0026#34;status\u0026#34;) UserStatus status, Pageable pageable); } Specification å‹•æ…‹æŸ¥è©¢ 1. åŸºç¤ Specification 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 package com.example.pagination.specification; import com.example.pagination.entity.User; import com.example.pagination.entity.UserStatus; import org.springframework.data.jpa.domain.Specification; import jakarta.persistence.criteria.*; import java.time.LocalDateTime; import java.util.ArrayList; import java.util.List; public class UserSpecification { /** * æ ¹æ“šä½¿ç”¨è€…åç¨±æ¨¡ç³ŠæŸ¥è©¢ */ public static Specification\u0026lt;User\u0026gt; usernameContains(String username) { return (root, query, criteriaBuilder) -\u0026gt; { if (username == null || username.trim().isEmpty()) { return criteriaBuilder.conjunction(); } return criteriaBuilder.like( criteriaBuilder.lower(root.get(\u0026#34;username\u0026#34;)), \u0026#34;%\u0026#34; + username.toLowerCase() + \u0026#34;%\u0026#34; ); }; } /** * æ ¹æ“šéƒµç®±æ¨¡ç³ŠæŸ¥è©¢ */ public static Specification\u0026lt;User\u0026gt; emailContains(String email) { return (root, query, criteriaBuilder) -\u0026gt; { if (email == null || email.trim().isEmpty()) { return criteriaBuilder.conjunction(); } return criteriaBuilder.like( criteriaBuilder.lower(root.get(\u0026#34;email\u0026#34;)), \u0026#34;%\u0026#34; + email.toLowerCase() + \u0026#34;%\u0026#34; ); }; } /** * æ ¹æ“šç‹€æ…‹æŸ¥è©¢ */ public static Specification\u0026lt;User\u0026gt; statusEquals(UserStatus status) { return (root, query, criteriaBuilder) -\u0026gt; { if (status == null) { return criteriaBuilder.conjunction(); } return criteriaBuilder.equal(root.get(\u0026#34;status\u0026#34;), status); }; } /** * æ ¹æ“šå¹´é½¡ç¯„åœæŸ¥è©¢ */ public static Specification\u0026lt;User\u0026gt; ageBetween(Integer minAge, Integer maxAge) { return (root, query, criteriaBuilder) -\u0026gt; { List\u0026lt;Predicate\u0026gt; predicates = new ArrayList\u0026lt;\u0026gt;(); if (minAge != null) { predicates.add(criteriaBuilder.greaterThanOrEqualTo(root.get(\u0026#34;age\u0026#34;), minAge)); } if (maxAge != null) { predicates.add(criteriaBuilder.lessThanOrEqualTo(root.get(\u0026#34;age\u0026#34;), maxAge)); } return criteriaBuilder.and(predicates.toArray(new Predicate[0])); }; } /** * æ ¹æ“šåŸå¸‚æŸ¥è©¢ */ public static Specification\u0026lt;User\u0026gt; cityEquals(String city) { return (root, query, criteriaBuilder) -\u0026gt; { if (city == null || city.trim().isEmpty()) { return criteriaBuilder.conjunction(); } return criteriaBuilder.equal(root.get(\u0026#34;city\u0026#34;), city); }; } /** * æ ¹æ“šå‰µå»ºæ™‚é–“ç¯„åœæŸ¥è©¢ */ public static Specification\u0026lt;User\u0026gt; createdAtBetween(LocalDateTime startDate, LocalDateTime endDate) { return (root, query, criteriaBuilder) -\u0026gt; { List\u0026lt;Predicate\u0026gt; predicates = new ArrayList\u0026lt;\u0026gt;(); if (startDate != null) { predicates.add(criteriaBuilder.greaterThanOrEqualTo(root.get(\u0026#34;createdAt\u0026#34;), startDate)); } if (endDate != null) { predicates.add(criteriaBuilder.lessThanOrEqualTo(root.get(\u0026#34;createdAt\u0026#34;), endDate)); } return criteriaBuilder.and(predicates.toArray(new Predicate[0])); }; } /** * è¤‡åˆæŸ¥è©¢ - æ ¹æ“šå¤šå€‹æ¢ä»¶ */ public static Specification\u0026lt;User\u0026gt; withFilters(String username, String email, UserStatus status, Integer minAge, Integer maxAge, String city) { return Specification.where(usernameContains(username)) .and(emailContains(email)) .and(statusEquals(status)) .and(ageBetween(minAge, maxAge)) .and(cityEquals(city)); } /** * é€²éšæŸ¥è©¢ - æ”¯æ´ OR æ¢ä»¶ */ public static Specification\u0026lt;User\u0026gt; searchByKeyword(String keyword) { return (root, query, criteriaBuilder) -\u0026gt; { if (keyword == null || keyword.trim().isEmpty()) { return criteriaBuilder.conjunction(); } String likePattern = \u0026#34;%\u0026#34; + keyword.toLowerCase() + \u0026#34;%\u0026#34;; return criteriaBuilder.or( criteriaBuilder.like(criteriaBuilder.lower(root.get(\u0026#34;username\u0026#34;)), likePattern), criteriaBuilder.like(criteriaBuilder.lower(root.get(\u0026#34;email\u0026#34;)), likePattern), criteriaBuilder.like(criteriaBuilder.lower(root.get(\u0026#34;firstName\u0026#34;)), likePattern), criteriaBuilder.like(criteriaBuilder.lower(root.get(\u0026#34;lastName\u0026#34;)), likePattern), criteriaBuilder.like(criteriaBuilder.lower(root.get(\u0026#34;city\u0026#34;)), likePattern) ); }; } } 2. å‹•æ…‹ Specification å»ºæ§‹å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 package com.example.pagination.specification; import org.springframework.data.jpa.domain.Specification; import jakarta.persistence.criteria.CriteriaBuilder; import jakarta.persistence.criteria.Predicate; import jakarta.persistence.criteria.Root; import java.util.ArrayList; import java.util.List; public class DynamicSpecificationBuilder\u0026lt;T\u0026gt; { private List\u0026lt;Specification\u0026lt;T\u0026gt;\u0026gt; specifications = new ArrayList\u0026lt;\u0026gt;(); public DynamicSpecificationBuilder\u0026lt;T\u0026gt; with(String field, String operation, Object value) { if (value != null) { specifications.add(createSpecification(field, operation, value)); } return this; } public DynamicSpecificationBuilder\u0026lt;T\u0026gt; with(Specification\u0026lt;T\u0026gt; specification) { if (specification != null) { specifications.add(specification); } return this; } public Specification\u0026lt;T\u0026gt; build() { if (specifications.isEmpty()) { return null; } Specification\u0026lt;T\u0026gt; result = specifications.get(0); for (int i = 1; i \u0026lt; specifications.size(); i++) { result = Specification.where(result).and(specifications.get(i)); } return result; } private Specification\u0026lt;T\u0026gt; createSpecification(String field, String operation, Object value) { return (root, query, criteriaBuilder) -\u0026gt; { switch (operation.toLowerCase()) { case \u0026#34;eq\u0026#34;: case \u0026#34;equals\u0026#34;: return criteriaBuilder.equal(root.get(field), value); case \u0026#34;ne\u0026#34;: case \u0026#34;not_equals\u0026#34;: return criteriaBuilder.notEqual(root.get(field), value); case \u0026#34;gt\u0026#34;: case \u0026#34;greater_than\u0026#34;: return criteriaBuilder.greaterThan(root.get(field), (Comparable) value); case \u0026#34;gte\u0026#34;: case \u0026#34;greater_than_or_equal\u0026#34;: return criteriaBuilder.greaterThanOrEqualTo(root.get(field), (Comparable) value); case \u0026#34;lt\u0026#34;: case \u0026#34;less_than\u0026#34;: return criteriaBuilder.lessThan(root.get(field), (Comparable) value); case \u0026#34;lte\u0026#34;: case \u0026#34;less_than_or_equal\u0026#34;: return criteriaBuilder.lessThanOrEqualTo(root.get(field), (Comparable) value); case \u0026#34;like\u0026#34;: case \u0026#34;contains\u0026#34;: return criteriaBuilder.like( criteriaBuilder.lower(root.get(field)), \u0026#34;%\u0026#34; + value.toString().toLowerCase() + \u0026#34;%\u0026#34; ); case \u0026#34;starts_with\u0026#34;: return criteriaBuilder.like( criteriaBuilder.lower(root.get(field)), value.toString().toLowerCase() + \u0026#34;%\u0026#34; ); case \u0026#34;ends_with\u0026#34;: return criteriaBuilder.like( criteriaBuilder.lower(root.get(field)), \u0026#34;%\u0026#34; + value.toString().toLowerCase() ); case \u0026#34;in\u0026#34;: if (value instanceof List) { return root.get(field).in((List\u0026lt;?\u0026gt;) value); } return criteriaBuilder.equal(root.get(field), value); case \u0026#34;is_null\u0026#34;: return criteriaBuilder.isNull(root.get(field)); case \u0026#34;is_not_null\u0026#34;: return criteriaBuilder.isNotNull(root.get(field)); default: throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„æ“ä½œ: \u0026#34; + operation); } }; } } DTO å’Œåˆ†é è«‹æ±‚è™•ç† 1. åˆ†é è«‹æ±‚ DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 package com.example.pagination.dto; import com.example.pagination.entity.UserStatus; import jakarta.validation.constraints.Min; import jakarta.validation.constraints.Max; import org.springframework.data.domain.PageRequest; import org.springframework.data.domain.Pageable; import org.springframework.data.domain.Sort; import java.time.LocalDateTime; public class UserPageRequest { @Min(value = 0, message = \u0026#34;é ç¢¼ä¸èƒ½å°æ–¼ 0\u0026#34;) private int page = 0; @Min(value = 1, message = \u0026#34;æ¯é å¤§å°ä¸èƒ½å°æ–¼ 1\u0026#34;) @Max(value = 100, message = \u0026#34;æ¯é å¤§å°ä¸èƒ½è¶…é 100\u0026#34;) private int size = 20; private String sortBy = \u0026#34;id\u0026#34;; private String sortDirection = \u0026#34;DESC\u0026#34;; // æŸ¥è©¢æ¢ä»¶ private String username; private String email; private UserStatus status; private Integer minAge; private Integer maxAge; private String city; private String keyword; // é—œéµå­—æœç´¢ private LocalDateTime startDate; private LocalDateTime endDate; // å»ºæ§‹å­ public UserPageRequest() {} public UserPageRequest(int page, int size) { this.page = page; this.size = size; } /** * è½‰æ›ç‚º Pageable ç‰©ä»¶ */ public Pageable toPageable() { Sort.Direction direction = Sort.Direction.fromString(sortDirection); Sort sort = Sort.by(direction, sortBy); return PageRequest.of(page, size, sort); } /** * æª¢æŸ¥æ˜¯å¦æœ‰æŸ¥è©¢æ¢ä»¶ */ public boolean hasFilters() { return username != null || email != null || status != null || minAge != null || maxAge != null || city != null || keyword != null || startDate != null || endDate != null; } // Getters and Setters public int getPage() { return page; } public void setPage(int page) { this.page = page; } public int getSize() { return size; } public void setSize(int size) { this.size = size; } public String getSortBy() { return sortBy; } public void setSortBy(String sortBy) { this.sortBy = sortBy; } public String getSortDirection() { return sortDirection; } public void setSortDirection(String sortDirection) { this.sortDirection = sortDirection; } public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public UserStatus getStatus() { return status; } public void setStatus(UserStatus status) { this.status = status; } public Integer getMinAge() { return minAge; } public void setMinAge(Integer minAge) { this.minAge = minAge; } public Integer getMaxAge() { return maxAge; } public void setMaxAge(Integer maxAge) { this.maxAge = maxAge; } public String getCity() { return city; } public void setCity(String city) { this.city = city; } public String getKeyword() { return keyword; } public void setKeyword(String keyword) { this.keyword = keyword; } public LocalDateTime getStartDate() { return startDate; } public void setStartDate(LocalDateTime startDate) { this.startDate = startDate; } public LocalDateTime getEndDate() { return endDate; } public void setEndDate(LocalDateTime endDate) { this.endDate = endDate; } } 2. åˆ†é å›æ‡‰ DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 package com.example.pagination.dto; import org.springframework.data.domain.Page; import java.util.List; public class PageResponse\u0026lt;T\u0026gt; { private List\u0026lt;T\u0026gt; content; private int page; private int size; private long totalElements; private int totalPages; private boolean first; private boolean last; private boolean hasNext; private boolean hasPrevious; private int numberOfElements; // å»ºæ§‹å­ public PageResponse() {} public PageResponse(Page\u0026lt;T\u0026gt; page) { this.content = page.getContent(); this.page = page.getNumber(); this.size = page.getSize(); this.totalElements = page.getTotalElements(); this.totalPages = page.getTotalPages(); this.first = page.isFirst(); this.last = page.isLast(); this.hasNext = page.hasNext(); this.hasPrevious = page.hasPrevious(); this.numberOfElements = page.getNumberOfElements(); } public static \u0026lt;T\u0026gt; PageResponse\u0026lt;T\u0026gt; of(Page\u0026lt;T\u0026gt; page) { return new PageResponse\u0026lt;\u0026gt;(page); } // Getters and Setters public List\u0026lt;T\u0026gt; getContent() { return content; } public void setContent(List\u0026lt;T\u0026gt; content) { this.content = content; } public int getPage() { return page; } public void setPage(int page) { this.page = page; } public int getSize() { return size; } public void setSize(int size) { this.size = size; } public long getTotalElements() { return totalElements; } public void setTotalElements(long totalElements) { this.totalElements = totalElements; } public int getTotalPages() { return totalPages; } public void setTotalPages(int totalPages) { this.totalPages = totalPages; } public boolean isFirst() { return first; } public void setFirst(boolean first) { this.first = first; } public boolean isLast() { return last; } public void setLast(boolean last) { this.last = last; } public boolean isHasNext() { return hasNext; } public void setHasNext(boolean hasNext) { this.hasNext = hasNext; } public boolean isHasPrevious() { return hasPrevious; } public void setHasPrevious(boolean hasPrevious) { this.hasPrevious = hasPrevious; } public int getNumberOfElements() { return numberOfElements; } public void setNumberOfElements(int numberOfElements) { this.numberOfElements = numberOfElements; } } 3. ä½¿ç”¨è€…æ‘˜è¦ DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package com.example.pagination.dto; import com.example.pagination.entity.UserStatus; public class UserSummaryDto { private Long id; private String username; private String email; private UserStatus status; // å»ºæ§‹å­ public UserSummaryDto() {} public UserSummaryDto(Long id, String username, String email, UserStatus status) { this.id = id; this.username = username; this.email = email; this.status = status; } // Getters and Setters public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public UserStatus getStatus() { return status; } public void setStatus(UserStatus status) { this.status = status; } } Service å±¤å¯¦ä½œ 1. ä½¿ç”¨è€…æœå‹™ä»‹é¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 package com.example.pagination.service; import com.example.pagination.dto.PageResponse; import com.example.pagination.dto.UserPageRequest; import com.example.pagination.dto.UserSummaryDto; import com.example.pagination.entity.User; import com.example.pagination.entity.UserStatus; import org.springframework.data.domain.Page; public interface UserService { /** * åˆ†é æŸ¥è©¢ä½¿ç”¨è€… */ PageResponse\u0026lt;User\u0026gt; findUsers(UserPageRequest request); /** * é—œéµå­—æœç´¢ä½¿ç”¨è€… */ PageResponse\u0026lt;User\u0026gt; searchUsers(String keyword, UserPageRequest request); /** * æ ¹æ“šç‹€æ…‹åˆ†é æŸ¥è©¢ä½¿ç”¨è€…æ‘˜è¦ */ PageResponse\u0026lt;UserSummaryDto\u0026gt; findUserSummariesByStatus(UserStatus status, UserPageRequest request); /** * é«˜ç´šæœç´¢ */ PageResponse\u0026lt;User\u0026gt; advancedSearch(UserPageRequest request); } 2. ä½¿ç”¨è€…æœå‹™å¯¦ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 package com.example.pagination.service.impl; import com.example.pagination.dto.PageResponse; import com.example.pagination.dto.UserPageRequest; import com.example.pagination.dto.UserSummaryDto; import com.example.pagination.entity.User; import com.example.pagination.entity.UserStatus; import com.example.pagination.repository.UserRepository; import com.example.pagination.service.UserService; import com.example.pagination.specification.DynamicSpecificationBuilder; import com.example.pagination.specification.UserSpecification; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.domain.Page; import org.springframework.data.domain.Pageable; import org.springframework.data.jpa.domain.Specification; import org.springframework.stereotype.Service; import org.springframework.transaction.annotation.Transactional; @Service @Transactional(readOnly = true) public class UserServiceImpl implements UserService { @Autowired private UserRepository userRepository; @Override public PageResponse\u0026lt;User\u0026gt; findUsers(UserPageRequest request) { Pageable pageable = request.toPageable(); if (!request.hasFilters()) { // æ²’æœ‰éæ¿¾æ¢ä»¶ï¼Œç›´æ¥åˆ†é æŸ¥è©¢ Page\u0026lt;User\u0026gt; page = userRepository.findAll(pageable); return PageResponse.of(page); } // æœ‰éæ¿¾æ¢ä»¶ï¼Œä½¿ç”¨ Specification Specification\u0026lt;User\u0026gt; spec = UserSpecification.withFilters( request.getUsername(), request.getEmail(), request.getStatus(), request.getMinAge(), request.getMaxAge(), request.getCity() ); Page\u0026lt;User\u0026gt; page = userRepository.findAll(spec, pageable); return PageResponse.of(page); } @Override public PageResponse\u0026lt;User\u0026gt; searchUsers(String keyword, UserPageRequest request) { Pageable pageable = request.toPageable(); Specification\u0026lt;User\u0026gt; spec = UserSpecification.searchByKeyword(keyword); Page\u0026lt;User\u0026gt; page = userRepository.findAll(spec, pageable); return PageResponse.of(page); } @Override public PageResponse\u0026lt;UserSummaryDto\u0026gt; findUserSummariesByStatus(UserStatus status, UserPageRequest request) { Pageable pageable = request.toPageable(); Page\u0026lt;UserSummaryDto\u0026gt; page = userRepository.findUserSummariesByStatus(status, pageable); return PageResponse.of(page); } @Override public PageResponse\u0026lt;User\u0026gt; advancedSearch(UserPageRequest request) { Pageable pageable = request.toPageable(); // ä½¿ç”¨å‹•æ…‹ Specification å»ºæ§‹å™¨ DynamicSpecificationBuilder\u0026lt;User\u0026gt; builder = new DynamicSpecificationBuilder\u0026lt;\u0026gt;(); builder.with(\u0026#34;username\u0026#34;, \u0026#34;contains\u0026#34;, request.getUsername()) .with(\u0026#34;email\u0026#34;, \u0026#34;contains\u0026#34;, request.getEmail()) .with(\u0026#34;status\u0026#34;, \u0026#34;equals\u0026#34;, request.getStatus()) .with(\u0026#34;age\u0026#34;, \u0026#34;gte\u0026#34;, request.getMinAge()) .with(\u0026#34;age\u0026#34;, \u0026#34;lte\u0026#34;, request.getMaxAge()) .with(\u0026#34;city\u0026#34;, \u0026#34;equals\u0026#34;, request.getCity()) .with(\u0026#34;createdAt\u0026#34;, \u0026#34;gte\u0026#34;, request.getStartDate()) .with(\u0026#34;createdAt\u0026#34;, \u0026#34;lte\u0026#34;, request.getEndDate()); // å¦‚æœæœ‰é—œéµå­—ï¼Œæ·»åŠ é—œéµå­—æœç´¢ if (request.getKeyword() != null \u0026amp;\u0026amp; !request.getKeyword().trim().isEmpty()) { builder.with(UserSpecification.searchByKeyword(request.getKeyword())); } Specification\u0026lt;User\u0026gt; spec = builder.build(); Page\u0026lt;User\u0026gt; page = userRepository.findAll(spec, pageable); return PageResponse.of(page); } } Controller å±¤å¯¦ä½œ 1. ä½¿ç”¨è€…æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 package com.example.pagination.controller; import com.example.pagination.dto.PageResponse; import com.example.pagination.dto.UserPageRequest; import com.example.pagination.dto.UserSummaryDto; import com.example.pagination.entity.User; import com.example.pagination.entity.UserStatus; import com.example.pagination.service.UserService; import jakarta.validation.Valid; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.web.bind.annotation.*; @RestController @RequestMapping(\u0026#34;/api/users\u0026#34;) @CrossOrigin(origins = \u0026#34;*\u0026#34;, maxAge = 3600) public class UserController { @Autowired private UserService userService; /** * åˆ†é æŸ¥è©¢ä½¿ç”¨è€… */ @GetMapping public ResponseEntity\u0026lt;PageResponse\u0026lt;User\u0026gt;\u0026gt; getUsers(@Valid UserPageRequest request) { PageResponse\u0026lt;User\u0026gt; response = userService.findUsers(request); return ResponseEntity.ok(response); } /** * é—œéµå­—æœç´¢ä½¿ç”¨è€… */ @GetMapping(\u0026#34;/search\u0026#34;) public ResponseEntity\u0026lt;PageResponse\u0026lt;User\u0026gt;\u0026gt; searchUsers( @RequestParam String keyword, @Valid UserPageRequest request) { PageResponse\u0026lt;User\u0026gt; response = userService.searchUsers(keyword, request); return ResponseEntity.ok(response); } /** * é«˜ç´šæœç´¢ */ @PostMapping(\u0026#34;/advanced-search\u0026#34;) public ResponseEntity\u0026lt;PageResponse\u0026lt;User\u0026gt;\u0026gt; advancedSearch(@Valid @RequestBody UserPageRequest request) { PageResponse\u0026lt;User\u0026gt; response = userService.advancedSearch(request); return ResponseEntity.ok(response); } /** * æ ¹æ“šç‹€æ…‹æŸ¥è©¢ä½¿ç”¨è€…æ‘˜è¦ */ @GetMapping(\u0026#34;/summaries\u0026#34;) public ResponseEntity\u0026lt;PageResponse\u0026lt;UserSummaryDto\u0026gt;\u0026gt; getUserSummaries( @RequestParam UserStatus status, @Valid UserPageRequest request) { PageResponse\u0026lt;UserSummaryDto\u0026gt; response = userService.findUserSummariesByStatus(status, request); return ResponseEntity.ok(response); } /** * ä½¿ç”¨è·¯å¾‘åƒæ•¸çš„åˆ†é æŸ¥è©¢ */ @GetMapping(\u0026#34;/page/{page}/size/{size}\u0026#34;) public ResponseEntity\u0026lt;PageResponse\u0026lt;User\u0026gt;\u0026gt; getUsersWithPathParams( @PathVariable int page, @PathVariable int size, @RequestParam(required = false) String sortBy, @RequestParam(required = false) String sortDirection) { UserPageRequest request = new UserPageRequest(page, size); if (sortBy != null) request.setSortBy(sortBy); if (sortDirection != null) request.setSortDirection(sortDirection); PageResponse\u0026lt;User\u0026gt; response = userService.findUsers(request); return ResponseEntity.ok(response); } } 2. åˆ†é é…ç½®æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 package com.example.pagination.controller; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.domain.PageRequest; import org.springframework.data.domain.Pageable; import org.springframework.data.domain.Sort; import org.springframework.data.web.PageableDefault; import org.springframework.data.web.SortDefault; import org.springframework.http.ResponseEntity; import org.springframework.web.bind.annotation.*; import java.util.HashMap; import java.util.Map; @RestController @RequestMapping(\u0026#34;/api/config\u0026#34;) public class PageConfigController { /** * ä½¿ç”¨ Spring è‡ªå‹•è§£æçš„ Pageable åƒæ•¸ */ @GetMapping(\u0026#34;/users\u0026#34;) public ResponseEntity\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; getUsersWithSpringPageable( @PageableDefault(page = 0, size = 20) @SortDefault(sort = \u0026#34;id\u0026#34;, direction = Sort.Direction.DESC) Pageable pageable) { Map\u0026lt;String, Object\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); result.put(\u0026#34;page\u0026#34;, pageable.getPageNumber()); result.put(\u0026#34;size\u0026#34;, pageable.getPageSize()); result.put(\u0026#34;sort\u0026#34;, pageable.getSort().toString()); return ResponseEntity.ok(result); } /** * å‹•æ…‹æ’åºæ¬„ä½é©—è­‰ */ @GetMapping(\u0026#34;/users/validated\u0026#34;) public ResponseEntity\u0026lt;Pageable\u0026gt; getValidatedPageable( @RequestParam(defaultValue = \u0026#34;0\u0026#34;) int page, @RequestParam(defaultValue = \u0026#34;20\u0026#34;) int size, @RequestParam(defaultValue = \u0026#34;id\u0026#34;) String sortBy, @RequestParam(defaultValue = \u0026#34;DESC\u0026#34;) String sortDirection) { // é©—è­‰æ’åºæ¬„ä½ String[] allowedSortFields = {\u0026#34;id\u0026#34;, \u0026#34;username\u0026#34;, \u0026#34;email\u0026#34;, \u0026#34;createdAt\u0026#34;, \u0026#34;updatedAt\u0026#34;}; boolean isValidSortField = false; for (String field : allowedSortFields) { if (field.equals(sortBy)) { isValidSortField = true; break; } } if (!isValidSortField) { sortBy = \u0026#34;id\u0026#34;; // é è¨­æ’åºæ¬„ä½ } Sort.Direction direction = Sort.Direction.fromString(sortDirection); Sort sort = Sort.by(direction, sortBy); Pageable pageable = PageRequest.of(page, size, sort); return ResponseEntity.ok(pageable); } } æ•ˆèƒ½å„ªåŒ–æŠ€å·§ 1. è³‡æ–™åº«ç´¢å¼•å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 -- ç‚ºå¸¸ç”¨æŸ¥è©¢æ¬„ä½å»ºç«‹ç´¢å¼• CREATE INDEX idx_users_username ON users(username); CREATE INDEX idx_users_email ON users(email); CREATE INDEX idx_users_status ON users(status); CREATE INDEX idx_users_created_at ON users(created_at); CREATE INDEX idx_users_city_status ON users(city, status); -- è¤‡åˆç´¢å¼•å„ªåŒ–å¤šæ¢ä»¶æŸ¥è©¢ CREATE INDEX idx_users_status_age ON users(status, age); CREATE INDEX idx_users_city_age_status ON users(city, age, status); -- åˆ†ææŸ¥è©¢åŸ·è¡Œè¨ˆç•« EXPLAIN SELECT * FROM users WHERE status = \u0026#39;ACTIVE\u0026#39; AND age \u0026gt; 25 ORDER BY created_at DESC LIMIT 20; 2. JPA æŸ¥è©¢å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 package com.example.pagination.config; import org.springframework.context.annotation.Configuration; import org.springframework.data.domain.PageRequest; import org.springframework.data.domain.Pageable; import org.springframework.data.web.PageableHandlerMethodArgumentResolver; import org.springframework.data.web.config.EnableSpringDataWebSupport; import org.springframework.web.method.support.HandlerMethodArgumentResolver; import org.springframework.web.servlet.config.annotation.WebMvcConfigurer; import java.util.List; @Configuration @EnableSpringDataWebSupport public class PaginationConfig implements WebMvcConfigurer { @Override public void addArgumentResolvers(List\u0026lt;HandlerMethodArgumentResolver\u0026gt; resolvers) { PageableHandlerMethodArgumentResolver resolver = new PageableHandlerMethodArgumentResolver(); // è¨­å®šé è¨­åˆ†é åƒæ•¸ resolver.setFallbackPageable(PageRequest.of(0, 20)); // è¨­å®šæœ€å¤§åˆ†é å¤§å° resolver.setMaxPageSize(100); // è¨­å®šä¸€é ç‚º 1 çš„åƒæ•¸ï¼ˆè€Œä¸æ˜¯ 0ï¼‰ resolver.setOneIndexedParameters(false); resolvers.add(resolver); } } 3. å¿«å–å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package com.example.pagination.service.impl; import org.springframework.cache.annotation.Cacheable; import org.springframework.stereotype.Service; @Service public class CachedUserService { @Autowired private UserRepository userRepository; /** * å¿«å–ç†±é–€æŸ¥è©¢çµæœ */ @Cacheable(value = \u0026#34;userPages\u0026#34;, key = \u0026#34;#status + \u0026#39;_\u0026#39; + #pageable.pageNumber + \u0026#39;_\u0026#39; + #pageable.pageSize\u0026#34;) public Page\u0026lt;User\u0026gt; findUsersByStatusCached(UserStatus status, Pageable pageable) { return userRepository.findByStatus(status, pageable); } /** * å¿«å–ç¸½æ•¸æŸ¥è©¢ */ @Cacheable(value = \u0026#34;userCounts\u0026#34;, key = \u0026#34;#status\u0026#34;) public long countUsersByStatus(UserStatus status) { return userRepository.countByStatus(status); } } 4. æ‰¹æ¬¡æŸ¥è©¢å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package com.example.pagination.service.impl; import org.springframework.data.domain.Page; import org.springframework.data.domain.PageImpl; import org.springframework.data.domain.Pageable; import org.springframework.stereotype.Service; import java.util.List; @Service public class OptimizedUserService { @Autowired private UserRepository userRepository; /** * é¿å… N+1 æŸ¥è©¢å•é¡Œ */ public Page\u0026lt;User\u0026gt; findUsersWithOptimization(Pageable pageable) { // åªæŸ¥è©¢ç•¶å‰é çš„è³‡æ–™ List\u0026lt;User\u0026gt; users = userRepository.findUsersWithPagination( pageable.getOffset(), pageable.getPageSize() ); // å–®ç¨æŸ¥è©¢ç¸½æ•¸ï¼ˆå¯ä»¥å¿«å–ï¼‰ long total = userRepository.countAllUsers(); return new PageImpl\u0026lt;\u0026gt;(users, pageable, total); } /** * ä½¿ç”¨åŸç”Ÿ SQL å„ªåŒ–å¤§è³‡æ–™æŸ¥è©¢ */ @Query(value = \u0026#34;\u0026#34;\u0026#34; SELECT u.* FROM users u WHERE u.status = :status ORDER BY u.id DESC LIMIT :limit OFFSET :offset \u0026#34;\u0026#34;\u0026#34;, nativeQuery = true) public List\u0026lt;User\u0026gt; findUsersWithNativeQuery( @Param(\u0026#34;status\u0026#34;) String status, @Param(\u0026#34;limit\u0026#34;) int limit, @Param(\u0026#34;offset\u0026#34;) long offset ); } å¯¦æˆ°ç¯„ä¾‹ 1. é›»å•†è¨‚å–®åˆ†é æŸ¥è©¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 package com.example.pagination.example; import com.example.pagination.entity.Order; import com.example.pagination.entity.OrderStatus; import org.springframework.data.domain.Page; import org.springframework.data.domain.Pageable; import org.springframework.data.jpa.domain.Specification; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.jpa.repository.JpaSpecificationExecutor; import org.springframework.web.bind.annotation.*; import java.math.BigDecimal; import java.time.LocalDateTime; import java.util.List; // è¨‚å–®å¯¦é«” @Entity @Table(name = \u0026#34;orders\u0026#34;) public class Order { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long orderId; @Column(name = \u0026#34;customer_id\u0026#34;) private String customerId; @Column(name = \u0026#34;total_amount\u0026#34;) private BigDecimal totalAmount; @Enumerated(EnumType.STRING) private OrderStatus status; @CreationTimestamp @Column(name = \u0026#34;created_at\u0026#34;) private LocalDateTime createdAt; // Getters and Setters... } // Repository ä»‹é¢ public interface OrderRepository extends JpaRepository\u0026lt;Order, Long\u0026gt;, JpaSpecificationExecutor\u0026lt;Order\u0026gt; { Page\u0026lt;Order\u0026gt; findByCustomerId(String customerId, Pageable pageable); Page\u0026lt;Order\u0026gt; findByStatusAndCreatedAtBetween( OrderStatus status, LocalDateTime startDate, LocalDateTime endDate, Pageable pageable ); } // è¨‚å–® Specification public class OrderSpecification { public static Specification\u0026lt;Order\u0026gt; hasCustomerId(String customerId) { return (root, query, cb) -\u0026gt; customerId == null ? cb.conjunction() : cb.equal(root.get(\u0026#34;customerId\u0026#34;), customerId); } public static Specification\u0026lt;Order\u0026gt; hasStatus(OrderStatus status) { return (root, query, cb) -\u0026gt; status == null ? cb.conjunction() : cb.equal(root.get(\u0026#34;status\u0026#34;), status); } public static Specification\u0026lt;Order\u0026gt; amountBetween(BigDecimal minAmount, BigDecimal maxAmount) { return (root, query, cb) -\u0026gt; { if (minAmount == null \u0026amp;\u0026amp; maxAmount == null) return cb.conjunction(); if (minAmount != null \u0026amp;\u0026amp; maxAmount != null) { return cb.between(root.get(\u0026#34;totalAmount\u0026#34;), minAmount, maxAmount); } else if (minAmount != null) { return cb.greaterThanOrEqualTo(root.get(\u0026#34;totalAmount\u0026#34;), minAmount); } else { return cb.lessThanOrEqualTo(root.get(\u0026#34;totalAmount\u0026#34;), maxAmount); } }; } public static Specification\u0026lt;Order\u0026gt; createdBetween(LocalDateTime start, LocalDateTime end) { return (root, query, cb) -\u0026gt; { if (start == null \u0026amp;\u0026amp; end == null) return cb.conjunction(); if (start != null \u0026amp;\u0026amp; end != null) { return cb.between(root.get(\u0026#34;createdAt\u0026#34;), start, end); } else if (start != null) { return cb.greaterThanOrEqualTo(root.get(\u0026#34;createdAt\u0026#34;), start); } else { return cb.lessThanOrEqualTo(root.get(\u0026#34;createdAt\u0026#34;), end); } }; } } // æ§åˆ¶å™¨å¯¦ä½œ @RestController @RequestMapping(\u0026#34;/api/orders\u0026#34;) public class OrderController { @Autowired private OrderRepository orderRepository; /** * åˆ†é æŸ¥è©¢è¨‚å–® */ @GetMapping public ResponseEntity\u0026lt;Page\u0026lt;Order\u0026gt;\u0026gt; getOrders( @RequestParam(required = false) String customerId, @RequestParam(required = false) OrderStatus status, @RequestParam(required = false) BigDecimal minAmount, @RequestParam(required = false) BigDecimal maxAmount, @RequestParam(required = false) LocalDateTime startDate, @RequestParam(required = false) LocalDateTime endDate, Pageable pageable) { Specification\u0026lt;Order\u0026gt; spec = Specification .where(OrderSpecification.hasCustomerId(customerId)) .and(OrderSpecification.hasStatus(status)) .and(OrderSpecification.amountBetween(minAmount, maxAmount)) .and(OrderSpecification.createdBetween(startDate, endDate)); Page\u0026lt;Order\u0026gt; orders = orderRepository.findAll(spec, pageable); return ResponseEntity.ok(orders); } /** * å®¢æˆ¶è¨‚å–®æŸ¥è©¢ */ @GetMapping(\u0026#34;/customer/{customerId}\u0026#34;) public ResponseEntity\u0026lt;Page\u0026lt;Order\u0026gt;\u0026gt; getCustomerOrders( @PathVariable String customerId, @PageableDefault(size = 10, sort = \u0026#34;createdAt\u0026#34;, direction = Sort.Direction.DESC) Pageable pageable) { Page\u0026lt;Order\u0026gt; orders = orderRepository.findByCustomerId(customerId, pageable); return ResponseEntity.ok(orders); } } 2. çµ±è¨ˆå ±è¡¨åˆ†é æŸ¥è©¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 package com.example.pagination.example; import org.springframework.data.domain.Page; import org.springframework.data.domain.Pageable; import org.springframework.data.jpa.repository.Query; import org.springframework.data.repository.query.Param; import org.springframework.web.bind.annotation.*; import java.time.LocalDate; // çµ±è¨ˆ DTO public class OrderStatistics { private String customerId; private String customerName; private Long orderCount; private BigDecimal totalAmount; private LocalDate lastOrderDate; public OrderStatistics(String customerId, String customerName, Long orderCount, BigDecimal totalAmount, LocalDate lastOrderDate) { this.customerId = customerId; this.customerName = customerName; this.orderCount = orderCount; this.totalAmount = totalAmount; this.lastOrderDate = lastOrderDate; } // Getters and Setters... } // Repository çµ±è¨ˆæŸ¥è©¢ public interface OrderStatisticsRepository extends JpaRepository\u0026lt;Order, Long\u0026gt; { @Query(\u0026#34;\u0026#34;\u0026#34; SELECT new com.example.pagination.example.OrderStatistics( o.customerId, c.name, COUNT(o.orderId), SUM(o.totalAmount), MAX(CAST(o.createdAt AS LocalDate)) ) FROM Order o JOIN Customer c ON o.customerId = c.customerId WHERE o.createdAt BETWEEN :startDate AND :endDate GROUP BY o.customerId, c.name HAVING COUNT(o.orderId) \u0026gt;= :minOrderCount \u0026#34;\u0026#34;\u0026#34;) Page\u0026lt;OrderStatistics\u0026gt; findOrderStatistics( @Param(\u0026#34;startDate\u0026#34;) LocalDateTime startDate, @Param(\u0026#34;endDate\u0026#34;) LocalDateTime endDate, @Param(\u0026#34;minOrderCount\u0026#34;) Long minOrderCount, Pageable pageable ); } // çµ±è¨ˆå ±è¡¨æ§åˆ¶å™¨ @RestController @RequestMapping(\u0026#34;/api/reports\u0026#34;) public class ReportController { @Autowired private OrderStatisticsRepository statisticsRepository; @GetMapping(\u0026#34;/customer-statistics\u0026#34;) public ResponseEntity\u0026lt;Page\u0026lt;OrderStatistics\u0026gt;\u0026gt; getCustomerStatistics( @RequestParam LocalDate startDate, @RequestParam LocalDate endDate, @RequestParam(defaultValue = \u0026#34;1\u0026#34;) Long minOrderCount, @PageableDefault(size = 20, sort = \u0026#34;totalAmount\u0026#34;, direction = Sort.Direction.DESC) Pageable pageable) { LocalDateTime startDateTime = startDate.atStartOfDay(); LocalDateTime endDateTime = endDate.atTime(23, 59, 59); Page\u0026lt;OrderStatistics\u0026gt; statistics = statisticsRepository.findOrderStatistics( startDateTime, endDateTime, minOrderCount, pageable ); return ResponseEntity.ok(statistics); } } æ¸¬è©¦å¯¦ä½œ 1. å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 package com.example.pagination.service; import com.example.pagination.dto.PageResponse; import com.example.pagination.dto.UserPageRequest; import com.example.pagination.entity.User; import com.example.pagination.entity.UserStatus; import com.example.pagination.repository.UserRepository; import com.example.pagination.service.impl.UserServiceImpl; import org.junit.jupiter.api.BeforeEach; import org.junit.jupiter.api.Test; import org.junit.jupiter.api.extension.ExtendWith; import org.mockito.InjectMocks; import org.mockito.Mock; import org.mockito.junit.jupiter.MockitoExtension; import org.springframework.data.domain.Page; import org.springframework.data.domain.PageImpl; import org.springframework.data.domain.PageRequest; import org.springframework.data.domain.Pageable; import java.util.Arrays; import java.util.List; import static org.junit.jupiter.api.Assertions.*; import static org.mockito.ArgumentMatchers.any; import static org.mockito.Mockito.*; @ExtendWith(MockitoExtension.class) public class UserServiceTest { @Mock private UserRepository userRepository; @InjectMocks private UserServiceImpl userService; private List\u0026lt;User\u0026gt; testUsers; @BeforeEach public void setUp() { User user1 = new User(\u0026#34;john\u0026#34;, \u0026#34;john@example.com\u0026#34;, \u0026#34;John\u0026#34;, \u0026#34;Doe\u0026#34;); User user2 = new User(\u0026#34;jane\u0026#34;, \u0026#34;jane@example.com\u0026#34;, \u0026#34;Jane\u0026#34;, \u0026#34;Smith\u0026#34;); testUsers = Arrays.asList(user1, user2); } @Test public void testFindUsersWithoutFilters() { // Given UserPageRequest request = new UserPageRequest(0, 10); Pageable pageable = PageRequest.of(0, 10); Page\u0026lt;User\u0026gt; page = new PageImpl\u0026lt;\u0026gt;(testUsers, pageable, testUsers.size()); when(userRepository.findAll(pageable)).thenReturn(page); // When PageResponse\u0026lt;User\u0026gt; result = userService.findUsers(request); // Then assertEquals(2, result.getContent().size()); assertEquals(0, result.getPage()); assertEquals(10, result.getSize()); assertEquals(2, result.getTotalElements()); verify(userRepository).findAll(pageable); verify(userRepository, never()).findAll(any(Specification.class), any(Pageable.class)); } @Test public void testFindUsersWithFilters() { // Given UserPageRequest request = new UserPageRequest(0, 10); request.setUsername(\u0026#34;john\u0026#34;); request.setStatus(UserStatus.ACTIVE); Pageable pageable = PageRequest.of(0, 10); Page\u0026lt;User\u0026gt; page = new PageImpl\u0026lt;\u0026gt;(Arrays.asList(testUsers.get(0)), pageable, 1); when(userRepository.findAll(any(Specification.class), eq(pageable))).thenReturn(page); // When PageResponse\u0026lt;User\u0026gt; result = userService.findUsers(request); // Then assertEquals(1, result.getContent().size()); assertEquals(\u0026#34;john\u0026#34;, result.getContent().get(0).getUsername()); verify(userRepository).findAll(any(Specification.class), eq(pageable)); verify(userRepository, never()).findAll(pageable); } @Test public void testSearchUsers() { // Given String keyword = \u0026#34;john\u0026#34;; UserPageRequest request = new UserPageRequest(0, 10); Pageable pageable = PageRequest.of(0, 10); Page\u0026lt;User\u0026gt; page = new PageImpl\u0026lt;\u0026gt;(Arrays.asList(testUsers.get(0)), pageable, 1); when(userRepository.findAll(any(Specification.class), eq(pageable))).thenReturn(page); // When PageResponse\u0026lt;User\u0026gt; result = userService.searchUsers(keyword, request); // Then assertEquals(1, result.getContent().size()); verify(userRepository).findAll(any(Specification.class), eq(pageable)); } } 2. æ•´åˆæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 package com.example.pagination.integration; import com.example.pagination.entity.User; import com.example.pagination.entity.UserStatus; import com.example.pagination.repository.UserRepository; import com.fasterxml.jackson.databind.ObjectMapper; import org.junit.jupiter.api.BeforeEach; import org.junit.jupiter.api.Test; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureWebMvc; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.http.MediaType; import org.springframework.test.context.ActiveProfiles; import org.springframework.test.web.servlet.MockMvc; import org.springframework.test.web.servlet.setup.MockMvcBuilders; import org.springframework.transaction.annotation.Transactional; import org.springframework.web.context.WebApplicationContext; import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get; import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*; @SpringBootTest @AutoConfigureWebMvc @ActiveProfiles(\u0026#34;test\u0026#34;) @Transactional public class UserControllerIntegrationTest { @Autowired private WebApplicationContext webApplicationContext; @Autowired private UserRepository userRepository; @Autowired private ObjectMapper objectMapper; private MockMvc mockMvc; @BeforeEach public void setUp() { mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext).build(); // å»ºç«‹æ¸¬è©¦è³‡æ–™ for (int i = 1; i \u0026lt;= 50; i++) { User user = new User(\u0026#34;user\u0026#34; + i, \u0026#34;user\u0026#34; + i + \u0026#34;@example.com\u0026#34;, \u0026#34;User\u0026#34;, String.valueOf(i)); user.setAge(20 + (i % 40)); user.setCity(i % 2 == 0 ? \u0026#34;Taipei\u0026#34; : \u0026#34;Kaohsiung\u0026#34;); user.setStatus(i % 3 == 0 ? UserStatus.INACTIVE : UserStatus.ACTIVE); userRepository.save(user); } } @Test public void testGetUsersWithDefaultPagination() throws Exception { mockMvc.perform(get(\u0026#34;/api/users\u0026#34;)) .andExpect(status().isOk()) .andExpect(jsonPath(\u0026#34;$.content\u0026#34;).isArray()) .andExpect(jsonPath(\u0026#34;$.page\u0026#34;).value(0)) .andExpect(jsonPath(\u0026#34;$.size\u0026#34;).value(20)) .andExpect(jsonPath(\u0026#34;$.totalElements\u0026#34;).value(50)) .andExpected(jsonPath(\u0026#34;$.totalPages\u0026#34;).value(3)); } @Test public void testGetUsersWithCustomPagination() throws Exception { mockMvc.perform(get(\u0026#34;/api/users\u0026#34;) .param(\u0026#34;page\u0026#34;, \u0026#34;1\u0026#34;) .param(\u0026#34;size\u0026#34;, \u0026#34;10\u0026#34;) .param(\u0026#34;sortBy\u0026#34;, \u0026#34;username\u0026#34;) .param(\u0026#34;sortDirection\u0026#34;, \u0026#34;ASC\u0026#34;)) .andExpect(status().isOk()) .andExpect(jsonPath(\u0026#34;$.content\u0026#34;).isArray()) .andExpect(jsonPath(\u0026#34;$.page\u0026#34;).value(1)) .andExpect(jsonPath(\u0026#34;$.size\u0026#34;).value(10)) .andExpect(jsonPath(\u0026#34;$.content.length()\u0026#34;).value(10)); } @Test public void testGetUsersWithFilters() throws Exception { mockMvc.perform(get(\u0026#34;/api/users\u0026#34;) .param(\u0026#34;status\u0026#34;, \u0026#34;ACTIVE\u0026#34;) .param(\u0026#34;city\u0026#34;, \u0026#34;Taipei\u0026#34;) .param(\u0026#34;minAge\u0026#34;, \u0026#34;25\u0026#34;) .param(\u0026#34;maxAge\u0026#34;, \u0026#34;35\u0026#34;)) .andExpect(status().isOk()) .andExpect(jsonPath(\u0026#34;$.content\u0026#34;).isArray()); } @Test public void testSearchUsers() throws Exception { mockMvc.perform(get(\u0026#34;/api/users/search\u0026#34;) .param(\u0026#34;keyword\u0026#34;, \u0026#34;user1\u0026#34;)) .andExpect(status().isOk()) .andExpect(jsonPath(\u0026#34;$.content\u0026#34;).isArray()); } } å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ 1. æ•ˆèƒ½å•é¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // å•é¡Œï¼šå¤§è³‡æ–™é‡åˆ†é æŸ¥è©¢ç·©æ…¢ // è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨è¦†è“‹ç´¢å¼•å’ŒéŠæ¨™åˆ†é  @Repository public class OptimizedRepository { @PersistenceContext private EntityManager entityManager; /** * ä½¿ç”¨éŠæ¨™åˆ†é é¿å… OFFSET æ•ˆèƒ½å•é¡Œ */ public List\u0026lt;User\u0026gt; findUsersWithCursor(Long lastId, int limit) { return entityManager.createQuery( \u0026#34;SELECT u FROM User u WHERE u.id \u0026gt; :lastId ORDER BY u.id ASC\u0026#34;, User.class) .setParameter(\u0026#34;lastId\u0026#34;, lastId) .setMaxResults(limit) .getResultList(); } /** * åˆ†é›¢è¨ˆæ•¸æŸ¥è©¢å’Œè³‡æ–™æŸ¥è©¢ */ public Page\u0026lt;User\u0026gt; findUsersOptimized(Specification\u0026lt;User\u0026gt; spec, Pageable pageable) { // å…ˆæŸ¥è©¢è³‡æ–™ List\u0026lt;User\u0026gt; content = entityManager.createQuery(buildQuery(spec, pageable)) .setFirstResult((int) pageable.getOffset()) .setMaxResults(pageable.getPageSize()) .getResultList(); // å†æŸ¥è©¢ç¸½æ•¸ï¼ˆå¯ä»¥å¿«å–ï¼‰ Long total = getCountFromCache(spec); return new PageImpl\u0026lt;\u0026gt;(content, pageable, total); } } 2. è¨˜æ†¶é«”å•é¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // å•é¡Œï¼šå¤§çµæœé›†å°è‡´è¨˜æ†¶é«”æº¢å‡º // è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨æµå¼æŸ¥è©¢å’ŒæŠ•å½± @Service public class StreamingService { /** * æµå¼è™•ç†å¤§è³‡æ–™é›† */ @Transactional(readOnly = true) public void processLargeDataset(Specification\u0026lt;User\u0026gt; spec) { try (Stream\u0026lt;User\u0026gt; stream = userRepository.streamBySpec(spec)) { stream.forEach(this::processUser); } } /** * åªæŸ¥è©¢å¿…è¦æ¬„ä½ */ @Query(\u0026#34;SELECT new com.example.dto.UserProjection(u.id, u.username, u.email) FROM User u\u0026#34;) Page\u0026lt;UserProjection\u0026gt; findUserProjections(Pageable pageable); } 3. ä¸¦ç™¼å•é¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // å•é¡Œï¼šåˆ†é éç¨‹ä¸­è³‡æ–™è®ŠåŒ–å°è‡´é‡è¤‡æˆ–éºæ¼ // è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨å¿«ç…§éš”é›¢æˆ–ç‰ˆæœ¬æ§åˆ¶ @Service public class ConsistentPaginationService { /** * ä½¿ç”¨æ™‚é–“æˆ³ç¢ºä¿ä¸€è‡´æ€§ */ public Page\u0026lt;User\u0026gt; findUsersConsistently(UserPageRequest request, LocalDateTime snapshot) { Specification\u0026lt;User\u0026gt; spec = UserSpecification.withFilters( request.getUsername(), request.getEmail(), request.getStatus(), request.getMinAge(), request.getMaxAge(), request.getCity() ).and((root, query, cb) -\u0026gt; cb.lessThanOrEqualTo(root.get(\u0026#34;createdAt\u0026#34;), snapshot) ); return userRepository.findAll(spec, request.toPageable()); } } ç¸½çµ æ ¸å¿ƒå„ªå‹¢ é¡å‹å®‰å…¨ï¼šCriteria API æä¾›ç·¨è­¯æ™‚æª¢æŸ¥ å‹•æ…‹æŸ¥è©¢ï¼šæ ¹æ“šæ¢ä»¶éˆæ´»æ§‹å»ºæŸ¥è©¢ è‡ªå‹•åˆ†é ï¼šè‡ªå‹•è™•ç†åˆ†é é‚è¼¯å’Œè¨ˆæ•¸ æ•ˆèƒ½å„ªåŒ–ï¼šæ”¯æ´ç´¢å¼•ã€å¿«å–å’ŒæŸ¥è©¢å„ªåŒ– æ˜“æ–¼ç¶­è­·ï¼šçµæ§‹åŒ–çš„æŸ¥è©¢æ§‹å»ºæ–¹å¼ æœ€ä½³å¯¦è¸ åˆç†è¨­å®šåˆ†é å¤§å°ï¼šé¿å…éå¤§çš„é é¢å¤§å° å»ºç«‹é©ç•¶ç´¢å¼•ï¼šç‚ºæŸ¥è©¢æ¢ä»¶å’Œæ’åºæ¬„ä½å»ºç«‹ç´¢å¼• ä½¿ç”¨æŠ•å½±æŸ¥è©¢ï¼šåªæŸ¥è©¢éœ€è¦çš„æ¬„ä½ å¿«å–ç†±é–€æŸ¥è©¢ï¼šå¿«å–é »ç¹æŸ¥è©¢çš„çµæœ é©—è­‰è¼¸å…¥åƒæ•¸ï¼šé˜²æ­¢ SQL æ³¨å…¥å’Œç„¡æ•ˆæŸ¥è©¢ ç›£æ§æŸ¥è©¢æ•ˆèƒ½ï¼šå®šæœŸæª¢æŸ¥æ…¢æŸ¥è©¢ ä½¿ç”¨é€£æ¥æ± ï¼šåˆç†é…ç½®è³‡æ–™åº«é€£æ¥æ±  å¸¸ç”¨æ¨¡å¼é€ŸæŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // åŸºæœ¬åˆ†é  PageRequest.of(page, size, Sort.by(\u0026#34;fieldName\u0026#34;).descending()) // Specification çµ„åˆ Specification.where(spec1).and(spec2).or(spec3) // å‹•æ…‹æ¢ä»¶ if (condition != null) { spec = spec.and(customSpec(condition)); } // è‡ªè¨‚æ’åº Sort.by(Sort.Order.desc(\u0026#34;field1\u0026#34;), Sort.Order.asc(\u0026#34;field2\u0026#34;)) // æŠ•å½±æŸ¥è©¢ @Query(\u0026#34;SELECT new dto.UserDto(u.id, u.name) FROM User u\u0026#34;) Page\u0026lt;UserDto\u0026gt; findUserDtos(Pageable pageable); Spring Data JPA çš„ Pageable å’Œ Specification æä¾›äº†å¼·å¤§è€Œéˆæ´»çš„åˆ†é æŸ¥è©¢åŠŸèƒ½ï¼Œæ­£ç¢ºä½¿ç”¨èƒ½å¤ å¤§å¹…æå‡æ‡‰ç”¨ç¨‹å¼çš„æŸ¥è©¢æ•ˆèƒ½å’Œä½¿ç”¨è€…é«”é©—ã€‚è¨˜ä½ï¼šç†è§£åº•å±¤çš„ SQL ç”Ÿæˆæ©Ÿåˆ¶æœ‰åŠ©æ–¼å¯«å‡ºæ›´é«˜æ•ˆçš„æŸ¥è©¢ä»£ç¢¼ã€‚\nåƒè€ƒè³‡æ–™ Spring Data JPA å®˜æ–¹æ–‡æª” JPA Criteria API è¦ç¯„ Spring Data Web Support Hibernate Performance Guide Database Indexing Best Practices ","permalink":"https://xinqilin.github.io/post/backend/jpapageable/","tags":["Spring Data JPA","Pageable","Pagination","Spring Boot","Database","Performance","Specification","Criteria API"],"title":"Spring Data JPA Pageable åˆ†é æŸ¥è©¢ï¼šå®Œæ•´å¯¦ä½œèˆ‡æ•ˆèƒ½å„ªåŒ–æŒ‡å—"},{"content":"Side Project ä¼æ¥­ç´šå°ˆæ¡ˆé…ç½®æŒ‡å— ç°¡ä»‹ åœ¨ç¾ä»£è»Ÿé«”é–‹ç™¼ä¸­ï¼Œä¸€å€‹è‰¯å¥½çš„å°ˆæ¡ˆé…ç½®æ˜¯æˆåŠŸçš„é—œéµã€‚æœ¬æ–‡å°‡æ·±å…¥ä»‹ç´¹å¦‚ä½•å¾é›¶é–‹å§‹å»ºç«‹ä¸€å€‹ä¼æ¥­ç´šçš„ Side Projectï¼ŒåŒ…å«å®Œæ•´çš„é–‹ç™¼ç’°å¢ƒè¨­å®šã€å°ˆæ¡ˆçµæ§‹è¦åŠƒã€ä¾è³´ç®¡ç†ã€å®¹å™¨åŒ–éƒ¨ç½²ã€ç›£æ§ç³»çµ±èˆ‡ CI/CD æµç¨‹ã€‚\nå°ˆæ¡ˆçµæ§‹è¦åŠƒ æ¨™æº– Maven å°ˆæ¡ˆçµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 project-root/ â”œâ”€â”€ src/ â”‚ â”œâ”€â”€ main/ â”‚ â”‚ â”œâ”€â”€ java/ â”‚ â”‚ â”‚ â””â”€â”€ com/ â”‚ â”‚ â”‚ â””â”€â”€ company/ â”‚ â”‚ â”‚ â””â”€â”€ project/ â”‚ â”‚ â”‚ â”œâ”€â”€ Application.java â”‚ â”‚ â”‚ â”œâ”€â”€ config/ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ AppConfig.java â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ SecurityConfig.java â”‚ â”‚ â”‚ â”‚ â””â”€â”€ DatabaseConfig.java â”‚ â”‚ â”‚ â”œâ”€â”€ controller/ â”‚ â”‚ â”‚ â”œâ”€â”€ service/ â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ impl/ â”‚ â”‚ â”‚ â”‚ â””â”€â”€ dto/ â”‚ â”‚ â”‚ â”œâ”€â”€ repository/ â”‚ â”‚ â”‚ â”œâ”€â”€ entity/ â”‚ â”‚ â”‚ â”œâ”€â”€ exception/ â”‚ â”‚ â”‚ â””â”€â”€ util/ â”‚ â”‚ â””â”€â”€ resources/ â”‚ â”‚ â”œâ”€â”€ application.yml â”‚ â”‚ â”œâ”€â”€ application-dev.yml â”‚ â”‚ â”œâ”€â”€ application-prod.yml â”‚ â”‚ â”œâ”€â”€ logback-spring.xml â”‚ â”‚ â”œâ”€â”€ banner.txt â”‚ â”‚ â””â”€â”€ db/ â”‚ â”‚ â””â”€â”€ migration/ â”‚ â””â”€â”€ test/ â”‚ â”œâ”€â”€ java/ â”‚ â”‚ â””â”€â”€ com/ â”‚ â”‚ â””â”€â”€ company/ â”‚ â”‚ â””â”€â”€ project/ â”‚ â”‚ â”œâ”€â”€ integration/ â”‚ â”‚ â”œâ”€â”€ unit/ â”‚ â”‚ â””â”€â”€ TestApplication.java â”‚ â””â”€â”€ resources/ â”‚ â””â”€â”€ application-test.yml â”œâ”€â”€ docker/ â”‚ â”œâ”€â”€ Dockerfile â”‚ â”œâ”€â”€ docker-compose.yml â”‚ â””â”€â”€ docker-compose.prod.yml â”œâ”€â”€ .github/ â”‚ â””â”€â”€ workflows/ â”‚ â”œâ”€â”€ ci.yml â”‚ â””â”€â”€ cd.yml â”œâ”€â”€ docs/ â”‚ â”œâ”€â”€ api/ â”‚ â””â”€â”€ setup/ â”œâ”€â”€ scripts/ â”‚ â”œâ”€â”€ build.sh â”‚ â”œâ”€â”€ deploy.sh â”‚ â””â”€â”€ setup.sh â”œâ”€â”€ pom.xml â”œâ”€â”€ README.md â””â”€â”€ .gitignore æ ¸å¿ƒä¾è³´ç®¡ç† å®Œæ•´çš„ Maven ä¾è³´é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.1.5\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;groupId\u0026gt;com.company\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;side-project\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.0.0\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;Side Project\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;Enterprise Side Project Configuration\u0026lt;/description\u0026gt; \u0026lt;packaging\u0026gt;jar\u0026lt;/packaging\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;17\u0026lt;/java.version\u0026gt; \u0026lt;maven.compiler.source\u0026gt;17\u0026lt;/maven.compiler.source\u0026gt; \u0026lt;maven.compiler.target\u0026gt;17\u0026lt;/maven.compiler.target\u0026gt; \u0026lt;spring-cloud.version\u0026gt;2022.0.4\u0026lt;/spring-cloud.version\u0026gt; \u0026lt;springdoc.version\u0026gt;2.2.0\u0026lt;/springdoc.version\u0026gt; \u0026lt;mapstruct.version\u0026gt;1.5.5.Final\u0026lt;/mapstruct.version\u0026gt; \u0026lt;testcontainers.version\u0026gt;1.19.0\u0026lt;/testcontainers.version\u0026gt; \u0026lt;jackson.version\u0026gt;2.15.2\u0026lt;/jackson.version\u0026gt; \u0026lt;guava.version\u0026gt;32.1.2-jre\u0026lt;/guava.version\u0026gt; \u0026lt;commons-lang3.version\u0026gt;3.13.0\u0026lt;/commons-lang3.version\u0026gt; \u0026lt;liquibase.version\u0026gt;4.23.2\u0026lt;/liquibase.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;!-- Spring Boot Starters --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-jpa\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-security\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-validation\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-cache\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-redis\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-actuator\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-aop\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Database --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;8.0.33\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.h2database\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;h2\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Database Migration --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.liquibase\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;liquibase-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${liquibase.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Documentation --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springdoc\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;springdoc-openapi-starter-webmvc-ui\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${springdoc.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- JSON Processing --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${jackson.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-databind\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${jackson.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.datatype\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-datatype-jsr310\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${jackson.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Utilities --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.commons\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-lang3\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${commons-lang3.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.google.guava\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;guava\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${guava.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Mapping --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mapstruct\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mapstruct\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${mapstruct.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Lombok --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok\u0026lt;/artifactId\u0026gt; \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Monitoring --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.micrometer\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;micrometer-registry-prometheus\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;net.logstash.logback\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;logstash-logback-encoder\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;7.4\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- JWT --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.jsonwebtoken\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jjwt-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.11.5\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.jsonwebtoken\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jjwt-impl\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.11.5\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.jsonwebtoken\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jjwt-jackson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.11.5\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- Test Dependencies --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.security\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-security-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.testcontainers\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;junit-jupiter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${testcontainers.version}\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.testcontainers\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${testcontainers.version}\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.testcontainers\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;redis\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${testcontainers.version}\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;excludes\u0026gt; \u0026lt;exclude\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok\u0026lt;/artifactId\u0026gt; \u0026lt;/exclude\u0026gt; \u0026lt;/excludes\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-compiler-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.11.0\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;source\u0026gt;17\u0026lt;/source\u0026gt; \u0026lt;target\u0026gt;17\u0026lt;/target\u0026gt; \u0026lt;annotationProcessorPaths\u0026gt; \u0026lt;path\u0026gt; \u0026lt;groupId\u0026gt;org.mapstruct\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mapstruct-processor\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${mapstruct.version}\u0026lt;/version\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;path\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${lombok.version}\u0026lt;/version\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;path\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok-mapstruct-binding\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.2.0\u0026lt;/version\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;/annotationProcessorPaths\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.liquibase\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;liquibase-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${liquibase.version}\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;propertyFile\u0026gt;src/main/resources/liquibase.properties\u0026lt;/propertyFile\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.jacoco\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jacoco-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.8.10\u0026lt;/version\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;prepare-agent\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;id\u0026gt;report\u0026lt;/id\u0026gt; \u0026lt;phase\u0026gt;test\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;report\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;com.google.cloud.tools\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jib-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.3.2\u0026lt;/version\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;from\u0026gt; \u0026lt;image\u0026gt;eclipse-temurin:17-jre-alpine\u0026lt;/image\u0026gt; \u0026lt;/from\u0026gt; \u0026lt;to\u0026gt; \u0026lt;image\u0026gt;your-registry/side-project:${project.version}\u0026lt;/image\u0026gt; \u0026lt;/to\u0026gt; \u0026lt;container\u0026gt; \u0026lt;jvmFlags\u0026gt; \u0026lt;jvmFlag\u0026gt;-Xms512m\u0026lt;/jvmFlag\u0026gt; \u0026lt;jvmFlag\u0026gt;-Xmx2g\u0026lt;/jvmFlag\u0026gt; \u0026lt;/jvmFlags\u0026gt; \u0026lt;mainClass\u0026gt;com.company.project.Application\u0026lt;/mainClass\u0026gt; \u0026lt;ports\u0026gt; \u0026lt;port\u0026gt;8080\u0026lt;/port\u0026gt; \u0026lt;/ports\u0026gt; \u0026lt;/container\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt; æ‡‰ç”¨ç¨‹å¼é…ç½® ä¸»è¦é…ç½®æª”æ¡ˆ - application.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 # æ‡‰ç”¨ç¨‹å¼é…ç½® spring: application: name: side-project profiles: active: ${SPRING_PROFILES_ACTIVE:dev} # è³‡æ–™åº«é…ç½® datasource: url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:side_project}?useSSL=false\u0026amp;serverTimezone=Asia/Taipei\u0026amp;allowPublicKeyRetrieval=true username: ${DB_USERNAME:root} password: ${DB_PASSWORD:password} driver-class-name: com.mysql.cj.jdbc.Driver hikari: minimum-idle: 5 maximum-pool-size: 20 idle-timeout: 30000 connection-timeout: 30000 max-lifetime: 1800000 pool-name: HikariCP # JPA é…ç½® jpa: hibernate: ddl-auto: validate show-sql: false properties: hibernate: dialect: org.hibernate.dialect.MySQL8Dialect format_sql: true use_sql_comments: true jdbc: batch_size: 25 order_inserts: true order_updates: true connection: provider_disables_autocommit: true query: in_clause_parameter_padding: true cache: use_second_level_cache: true use_query_cache: true region: factory_class: org.hibernate.cache.jcache.JCacheRegionFactory # Redis é…ç½® redis: host: ${REDIS_HOST:localhost} port: ${REDIS_PORT:6379} password: ${REDIS_PASSWORD:} database: 0 timeout: 10000ms lettuce: pool: max-active: 200 max-idle: 20 min-idle: 5 max-wait: 10000ms # Cache é…ç½® cache: type: redis redis: time-to-live: 600000 cache-null-values: false # Security é…ç½® security: oauth2: client: registration: google: client-id: ${GOOGLE_CLIENT_ID:your-google-client-id} client-secret: ${GOOGLE_CLIENT_SECRET:your-google-client-secret} scope: openid,profile,email # Liquibase é…ç½® liquibase: change-log: classpath:db/changelog/db.changelog-master.xml enabled: true # Jackson é…ç½® jackson: serialization: write-dates-as-timestamps: false indent-output: true deserialization: fail-on-unknown-properties: false time-zone: Asia/Taipei default-property-inclusion: non_null # æœå‹™å™¨é…ç½® server: port: ${SERVER_PORT:8080} servlet: context-path: /api compression: enabled: true mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json min-response-size: 1024 error: include-stacktrace: never include-message: always # æ—¥èªŒé…ç½® logging: level: root: INFO com.company.project: DEBUG org.springframework.security: DEBUG org.hibernate.SQL: DEBUG org.hibernate.type.descriptor.sql.BasicBinder: TRACE pattern: console: \u0026#34;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n\u0026#34; file: \u0026#34;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n\u0026#34; file: name: logs/application.log logback: rollingpolicy: max-file-size: 10MB max-history: 30 # ç®¡ç†ç«¯é»é…ç½® management: endpoints: web: exposure: include: health,info,metrics,prometheus,liquibase,caches endpoint: health: show-details: always health: redis: enabled: true db: enabled: true metrics: export: prometheus: enabled: true tags: application: ${spring.application.name} environment: ${spring.profiles.active} # SpringDoc é…ç½® springdoc: api-docs: path: /api-docs swagger-ui: path: /swagger-ui.html operations-sorter: method tags-sorter: alpha packages-to-scan: com.company.project.controller # æ‡‰ç”¨ç¨‹å¼è‡ªè¨‚é…ç½® app: jwt: secret: ${JWT_SECRET:your-secret-key-must-be-at-least-256-bits} expiration: ${JWT_EXPIRATION:86400000} # 24 hours refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800000} # 7 days cors: allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:8080} allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS} allowed-headers: ${CORS_ALLOWED_HEADERS:*} allow-credentials: true rate-limit: enabled: true requests-per-minute: 60 burst-capacity: 100 file-storage: upload-dir: ${FILE_UPLOAD_DIR:uploads/} max-file-size: ${MAX_FILE_SIZE:10MB} allowed-extensions: ${ALLOWED_EXTENSIONS:jpg,jpeg,png,gif,pdf,docx,xlsx} é–‹ç™¼ç’°å¢ƒé…ç½® - application-dev.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 spring: datasource: url: jdbc:mysql://localhost:3306/side_project_dev?useSSL=false\u0026amp;serverTimezone=Asia/Taipei username: root password: mysql jpa: hibernate: ddl-auto: update show-sql: true redis: host: localhost port: 6379 liquibase: enabled: false logging: level: root: DEBUG com.company.project: DEBUG org.springframework.web: DEBUG org.springframework.security: DEBUG management: endpoints: web: exposure: include: \u0026#34;*\u0026#34; app: jwt: secret: dev-secret-key-for-development-only-not-for-production expiration: 86400000 cors: allowed-origins: \u0026#34;http://localhost:3000,http://localhost:8080\u0026#34; ç”Ÿç”¢ç’°å¢ƒé…ç½® - application-prod.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 spring: datasource: url: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?useSSL=true\u0026amp;serverTimezone=Asia/Taipei username: ${DB_USERNAME} password: ${DB_PASSWORD} hikari: minimum-idle: 10 maximum-pool-size: 50 idle-timeout: 60000 connection-timeout: 30000 max-lifetime: 1800000 jpa: hibernate: ddl-auto: validate show-sql: false redis: host: ${REDIS_HOST} port: ${REDIS_PORT} password: ${REDIS_PASSWORD} ssl: true liquibase: enabled: true logging: level: root: WARN com.company.project: INFO file: name: /var/log/side-project/application.log management: endpoints: web: exposure: include: health,info,metrics,prometheus endpoint: health: show-details: when-authorized app: jwt: secret: ${JWT_SECRET} expiration: ${JWT_EXPIRATION:3600000} cors: allowed-origins: ${CORS_ALLOWED_ORIGINS} æ ¸å¿ƒé…ç½®é¡åˆ¥ ä¸»è¦æ‡‰ç”¨ç¨‹å¼é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 package com.company.project.config; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.context.annotation.Configuration; import lombok.Data; @Data @Configuration @ConfigurationProperties(prefix = \u0026#34;app\u0026#34;) public class AppProperties { private Jwt jwt = new Jwt(); private Cors cors = new Cors(); private RateLimit rateLimit = new RateLimit(); private FileStorage fileStorage = new FileStorage(); @Data public static class Jwt { private String secret; private long expiration; private long refreshExpiration; } @Data public static class Cors { private String allowedOrigins; private String allowedMethods; private String allowedHeaders; private boolean allowCredentials; } @Data public static class RateLimit { private boolean enabled; private int requestsPerMinute; private int burstCapacity; } @Data public static class FileStorage { private String uploadDir; private String maxFileSize; private String allowedExtensions; } } è³‡æ–™åº«é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package com.company.project.config; import com.zaxxer.hikari.HikariConfig; import com.zaxxer.hikari.HikariDataSource; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.Primary; import org.springframework.data.jpa.repository.config.EnableJpaAuditing; import org.springframework.data.jpa.repository.config.EnableJpaRepositories; import org.springframework.transaction.annotation.EnableTransactionManagement; import javax.sql.DataSource; @Configuration @EnableJpaRepositories(basePackages = \u0026#34;com.company.project.repository\u0026#34;) @EnableJpaAuditing @EnableTransactionManagement public class DatabaseConfig { @Bean @Primary @ConfigurationProperties(\u0026#34;spring.datasource.hikari\u0026#34;) public HikariConfig hikariConfig() { return new HikariConfig(); } @Bean @Primary public DataSource dataSource() { return new HikariDataSource(hikariConfig()); } } Redis é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package com.company.project.config; import org.springframework.boot.autoconfigure.data.redis.RedisProperties; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.data.redis.connection.RedisConnectionFactory; import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory; import org.springframework.data.redis.core.RedisTemplate; import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer; import org.springframework.data.redis.serializer.StringRedisSerializer; import org.springframework.cache.annotation.EnableCaching; import org.springframework.cache.CacheManager; import org.springframework.data.redis.cache.RedisCacheManager; import org.springframework.data.redis.cache.RedisCacheConfiguration; import java.time.Duration; @Configuration @EnableCaching public class RedisConfig { @Bean public RedisConnectionFactory redisConnectionFactory(RedisProperties redisProperties) { return new LettuceConnectionFactory(redisProperties.getHost(), redisProperties.getPort()); } @Bean public RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate(RedisConnectionFactory connectionFactory) { RedisTemplate\u0026lt;String, Object\u0026gt; template = new RedisTemplate\u0026lt;\u0026gt;(); template.setConnectionFactory(connectionFactory); // è¨­å®šåºåˆ—åŒ–å™¨ template.setKeySerializer(new StringRedisSerializer()); template.setValueSerializer(new GenericJackson2JsonRedisSerializer()); template.setHashKeySerializer(new StringRedisSerializer()); template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer()); template.afterPropertiesSet(); return template; } @Bean public CacheManager cacheManager(RedisConnectionFactory connectionFactory) { RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig() .entryTtl(Duration.ofMinutes(10)) .serializeKeysWith(org.springframework.data.redis.serializer.RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer())) .serializeValuesWith(org.springframework.data.redis.serializer.RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer())); return RedisCacheManager.builder(connectionFactory) .cacheDefaults(config) .build(); } } å®‰å…¨é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package com.company.project.config; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.security.config.annotation.web.builders.HttpSecurity; import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity; import org.springframework.security.config.http.SessionCreationPolicy; import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder; import org.springframework.security.crypto.password.PasswordEncoder; import org.springframework.security.web.SecurityFilterChain; import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter; import org.springframework.web.cors.CorsConfiguration; import org.springframework.web.cors.CorsConfigurationSource; import org.springframework.web.cors.UrlBasedCorsConfigurationSource; import java.util.Arrays; @Configuration @EnableWebSecurity public class SecurityConfig { private final AppProperties appProperties; private final JwtAuthenticationFilter jwtAuthenticationFilter; public SecurityConfig(AppProperties appProperties, JwtAuthenticationFilter jwtAuthenticationFilter) { this.appProperties = appProperties; this.jwtAuthenticationFilter = jwtAuthenticationFilter; } @Bean public SecurityFilterChain filterChain(HttpSecurity http) throws Exception { http.csrf(csrf -\u0026gt; csrf.disable()) .cors(cors -\u0026gt; cors.configurationSource(corsConfigurationSource())) .sessionManagement(session -\u0026gt; session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)) .authorizeHttpRequests(authz -\u0026gt; authz .requestMatchers(\u0026#34;/api/auth/**\u0026#34;, \u0026#34;/api/public/**\u0026#34;).permitAll() .requestMatchers(\u0026#34;/api-docs/**\u0026#34;, \u0026#34;/swagger-ui/**\u0026#34;, \u0026#34;/swagger-ui.html\u0026#34;).permitAll() .requestMatchers(\u0026#34;/actuator/health\u0026#34;, \u0026#34;/actuator/info\u0026#34;).permitAll() .anyRequest().authenticated() ) .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class); return http.build(); } @Bean public PasswordEncoder passwordEncoder() { return new BCryptPasswordEncoder(); } @Bean public CorsConfigurationSource corsConfigurationSource() { CorsConfiguration configuration = new CorsConfiguration(); configuration.setAllowedOrigins(Arrays.asList(appProperties.getCors().getAllowedOrigins().split(\u0026#34;,\u0026#34;))); configuration.setAllowedMethods(Arrays.asList(appProperties.getCors().getAllowedMethods().split(\u0026#34;,\u0026#34;))); configuration.setAllowedHeaders(Arrays.asList(appProperties.getCors().getAllowedHeaders().split(\u0026#34;,\u0026#34;))); configuration.setAllowCredentials(appProperties.getCors().isAllowCredentials()); UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource(); source.registerCorsConfiguration(\u0026#34;/**\u0026#34;, configuration); return source; } } OpenAPI é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package com.company.project.config; import io.swagger.v3.oas.models.OpenAPI; import io.swagger.v3.oas.models.info.Info; import io.swagger.v3.oas.models.info.Contact; import io.swagger.v3.oas.models.info.License; import io.swagger.v3.oas.models.security.SecurityRequirement; import io.swagger.v3.oas.models.security.SecurityScheme; import io.swagger.v3.oas.models.Components; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; @Configuration public class OpenApiConfig { @Bean public OpenAPI customOpenAPI() { return new OpenAPI() .info(new Info() .title(\u0026#34;Side Project API\u0026#34;) .version(\u0026#34;1.0.0\u0026#34;) .description(\u0026#34;Enterprise Side Project API Documentation\u0026#34;) .contact(new Contact() .name(\u0026#34;Bill Lin\u0026#34;) .email(\u0026#34;bill@example.com\u0026#34;) .url(\u0026#34;https://github.com/yourhandle\u0026#34;)) .license(new License() .name(\u0026#34;MIT License\u0026#34;) .url(\u0026#34;https://opensource.org/licenses/MIT\u0026#34;))) .addSecurityItem(new SecurityRequirement().addList(\u0026#34;Bearer Authentication\u0026#34;)) .components(new Components() .addSecuritySchemes(\u0026#34;Bearer Authentication\u0026#34;, new SecurityScheme() .type(SecurityScheme.Type.HTTP) .scheme(\u0026#34;bearer\u0026#34;) .bearerFormat(\u0026#34;JWT\u0026#34;))); } } å®¹å™¨åŒ–é…ç½® Dockerfile 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # Multi-stage build FROM eclipse-temurin:17-jdk-alpine AS builder WORKDIR /app COPY pom.xml . COPY src ./src RUN ./mvnw clean package -DskipTests FROM eclipse-temurin:17-jre-alpine # å»ºç«‹é root ä½¿ç”¨è€… RUN addgroup -g 1001 -S appgroup \u0026amp;\u0026amp; \\ adduser -u 1001 -S appuser -G appgroup WORKDIR /app # è¤‡è£½ JAR æª”æ¡ˆ COPY --from=builder /app/target/*.jar app.jar # å»ºç«‹å¿…è¦ç›®éŒ„ RUN mkdir -p /app/logs /app/uploads \u0026amp;\u0026amp; \\ chown -R appuser:appgroup /app # åˆ‡æ›åˆ°é root ä½¿ç”¨è€… USER appuser # å¥åº·æª¢æŸ¥ HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \\ CMD curl -f http://localhost:8080/actuator/health || exit 1 # æš´éœ²åŸ è™Ÿ EXPOSE 8080 # JVM èª¿å„ªåƒæ•¸ ENV JAVA_OPTS=\u0026#34;-Xms512m -Xmx2g -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/logs/\u0026#34; # å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ ENTRYPOINT [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;java $JAVA_OPTS -jar app.jar\u0026#34;] docker-compose.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 version: \u0026#39;3.8\u0026#39; services: app: build: . ports: - \u0026#34;8080:8080\u0026#34; environment: - SPRING_PROFILES_ACTIVE=docker - DB_HOST=mysql - DB_PORT=3306 - DB_NAME=side_project - DB_USERNAME=root - DB_PASSWORD=mysql - REDIS_HOST=redis - REDIS_PORT=6379 depends_on: - mysql - redis volumes: - ./logs:/app/logs - ./uploads:/app/uploads networks: - app-network restart: unless-stopped mysql: image: mysql:8.0 environment: - MYSQL_ROOT_PASSWORD=mysql - MYSQL_DATABASE=side_project - MYSQL_USER=app - MYSQL_PASSWORD=app ports: - \u0026#34;3306:3306\u0026#34; volumes: - mysql_data:/var/lib/mysql - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql networks: - app-network restart: unless-stopped redis: image: redis:7-alpine ports: - \u0026#34;6379:6379\u0026#34; volumes: - redis_data:/data networks: - app-network restart: unless-stopped prometheus: image: prom/prometheus:latest ports: - \u0026#34;9090:9090\u0026#34; volumes: - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml networks: - app-network restart: unless-stopped grafana: image: grafana/grafana:latest ports: - \u0026#34;3000:3000\u0026#34; environment: - GF_SECURITY_ADMIN_PASSWORD=admin volumes: - grafana_data:/var/lib/grafana - ./docker/grafana/dashboards:/etc/grafana/provisioning/dashboards - ./docker/grafana/datasources:/etc/grafana/provisioning/datasources networks: - app-network restart: unless-stopped nginx: image: nginx:alpine ports: - \u0026#34;80:80\u0026#34; - \u0026#34;443:443\u0026#34; volumes: - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf - ./docker/nginx/ssl:/etc/nginx/ssl depends_on: - app networks: - app-network restart: unless-stopped volumes: mysql_data: redis_data: grafana_data: networks: app-network: driver: bridge ç”Ÿç”¢ç’°å¢ƒ docker-compose.prod.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 version: \u0026#39;3.8\u0026#39; services: app: image: your-registry/side-project:latest deploy: replicas: 3 resources: limits: memory: 2G cpus: \u0026#39;1\u0026#39; reservations: memory: 1G cpus: \u0026#39;0.5\u0026#39; restart_policy: condition: on-failure delay: 10s max_attempts: 3 environment: - SPRING_PROFILES_ACTIVE=prod - DB_HOST=mysql-prod - DB_PORT=3306 - DB_NAME=side_project_prod - DB_USERNAME=${DB_USERNAME} - DB_PASSWORD=${DB_PASSWORD} - REDIS_HOST=redis-prod - REDIS_PORT=6379 - REDIS_PASSWORD=${REDIS_PASSWORD} - JWT_SECRET=${JWT_SECRET} secrets: - db_password - jwt_secret networks: - app-network logging: driver: \u0026#34;json-file\u0026#34; options: max-size: \u0026#34;10m\u0026#34; max-file: \u0026#34;3\u0026#34; mysql-prod: image: mysql:8.0 environment: - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/db_password - MYSQL_DATABASE=side_project_prod volumes: - mysql_prod_data:/var/lib/mysql secrets: - db_password networks: - app-network deploy: resources: limits: memory: 2G cpus: \u0026#39;1\u0026#39; redis-prod: image: redis:7-alpine command: redis-server --requirepass ${REDIS_PASSWORD} volumes: - redis_prod_data:/data networks: - app-network deploy: resources: limits: memory: 512M cpus: \u0026#39;0.5\u0026#39; secrets: db_password: external: true jwt_secret: external: true volumes: mysql_prod_data: redis_prod_data: networks: app-network: driver: overlay ç›£æ§é…ç½® logback-spring.xml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;include resource=\u0026#34;org/springframework/boot/logging/logback/defaults.xml\u0026#34;/\u0026gt; \u0026lt;springProfile name=\u0026#34;!prod\u0026#34;\u0026gt; \u0026lt;include resource=\u0026#34;org/springframework/boot/logging/logback/console-appender.xml\u0026#34;/\u0026gt; \u0026lt;root level=\u0026#34;INFO\u0026#34;\u0026gt; \u0026lt;appender-ref ref=\u0026#34;CONSOLE\u0026#34;/\u0026gt; \u0026lt;/root\u0026gt; \u0026lt;/springProfile\u0026gt; \u0026lt;springProfile name=\u0026#34;prod\u0026#34;\u0026gt; \u0026lt;appender name=\u0026#34;FILE\u0026#34; class=\u0026#34;ch.qos.logback.core.rolling.RollingFileAppender\u0026#34;\u0026gt; \u0026lt;file\u0026gt;/var/log/side-project/application.log\u0026lt;/file\u0026gt; \u0026lt;encoder class=\u0026#34;net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder\u0026#34;\u0026gt; \u0026lt;providers\u0026gt; \u0026lt;timestamp/\u0026gt; \u0026lt;logLevel/\u0026gt; \u0026lt;loggerName/\u0026gt; \u0026lt;mdc/\u0026gt; \u0026lt;message/\u0026gt; \u0026lt;stackTrace/\u0026gt; \u0026lt;/providers\u0026gt; \u0026lt;/encoder\u0026gt; \u0026lt;rollingPolicy class=\u0026#34;ch.qos.logback.core.rolling.TimeBasedRollingPolicy\u0026#34;\u0026gt; \u0026lt;fileNamePattern\u0026gt;/var/log/side-project/application.%d{yyyy-MM-dd}.%i.log\u0026lt;/fileNamePattern\u0026gt; \u0026lt;timeBasedFileNamingAndTriggeringPolicy class=\u0026#34;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP\u0026#34;\u0026gt; \u0026lt;maxFileSize\u0026gt;100MB\u0026lt;/maxFileSize\u0026gt; \u0026lt;/timeBasedFileNamingAndTriggeringPolicy\u0026gt; \u0026lt;maxHistory\u0026gt;30\u0026lt;/maxHistory\u0026gt; \u0026lt;totalSizeCap\u0026gt;3GB\u0026lt;/totalSizeCap\u0026gt; \u0026lt;/rollingPolicy\u0026gt; \u0026lt;/appender\u0026gt; \u0026lt;appender name=\u0026#34;METRICS\u0026#34; class=\u0026#34;ch.qos.logback.core.rolling.RollingFileAppender\u0026#34;\u0026gt; \u0026lt;file\u0026gt;/var/log/side-project/metrics.log\u0026lt;/file\u0026gt; \u0026lt;encoder class=\u0026#34;net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder\u0026#34;\u0026gt; \u0026lt;providers\u0026gt; \u0026lt;timestamp/\u0026gt; \u0026lt;logLevel/\u0026gt; \u0026lt;loggerName/\u0026gt; \u0026lt;mdc/\u0026gt; \u0026lt;message/\u0026gt; \u0026lt;/providers\u0026gt; \u0026lt;/encoder\u0026gt; \u0026lt;rollingPolicy class=\u0026#34;ch.qos.logback.core.rolling.TimeBasedRollingPolicy\u0026#34;\u0026gt; \u0026lt;fileNamePattern\u0026gt;/var/log/side-project/metrics.%d{yyyy-MM-dd}.log\u0026lt;/fileNamePattern\u0026gt; \u0026lt;maxHistory\u0026gt;7\u0026lt;/maxHistory\u0026gt; \u0026lt;/rollingPolicy\u0026gt; \u0026lt;/appender\u0026gt; \u0026lt;logger name=\u0026#34;metrics\u0026#34; level=\u0026#34;INFO\u0026#34; additivity=\u0026#34;false\u0026#34;\u0026gt; \u0026lt;appender-ref ref=\u0026#34;METRICS\u0026#34;/\u0026gt; \u0026lt;/logger\u0026gt; \u0026lt;root level=\u0026#34;INFO\u0026#34;\u0026gt; \u0026lt;appender-ref ref=\u0026#34;FILE\u0026#34;/\u0026gt; \u0026lt;/root\u0026gt; \u0026lt;/springProfile\u0026gt; \u0026lt;/configuration\u0026gt; Prometheus é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # docker/prometheus/prometheus.yml global: scrape_interval: 15s evaluation_interval: 15s scrape_configs: - job_name: \u0026#39;side-project\u0026#39; static_configs: - targets: [\u0026#39;app:8080\u0026#39;] metrics_path: \u0026#39;/actuator/prometheus\u0026#39; scrape_interval: 10s - job_name: \u0026#39;mysql\u0026#39; static_configs: - targets: [\u0026#39;mysql:3306\u0026#39;] - job_name: \u0026#39;redis\u0026#39; static_configs: - targets: [\u0026#39;redis:6379\u0026#39;] CI/CD é…ç½® GitHub Actions - CI 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 # .github/workflows/ci.yml name: CI on: push: branches: [ main, develop ] pull_request: branches: [ main ] jobs: test: runs-on: ubuntu-latest services: mysql: image: mysql:8.0 env: MYSQL_ROOT_PASSWORD: mysql MYSQL_DATABASE: side_project_test ports: - 3306:3306 options: \u0026gt;- --health-cmd=\u0026#34;mysqladmin ping\u0026#34; --health-interval=10s --health-timeout=5s --health-retries=3 redis: image: redis:7-alpine ports: - 6379:6379 options: \u0026gt;- --health-cmd=\u0026#34;redis-cli ping\u0026#34; --health-interval=10s --health-timeout=5s --health-retries=3 steps: - uses: actions/checkout@v3 - name: Set up JDK 17 uses: actions/setup-java@v3 with: java-version: \u0026#39;17\u0026#39; distribution: \u0026#39;temurin\u0026#39; - name: Cache Maven dependencies uses: actions/cache@v3 with: path: ~/.m2 key: ${{ runner.os }}-m2-${{ hashFiles(\u0026#39;**/pom.xml\u0026#39;) }} restore-keys: ${{ runner.os }}-m2 - name: Run tests run: mvn clean test env: SPRING_PROFILES_ACTIVE: test DB_HOST: localhost DB_PORT: 3306 DB_NAME: side_project_test DB_USERNAME: root DB_PASSWORD: mysql REDIS_HOST: localhost REDIS_PORT: 6379 - name: Generate test report uses: dorny/test-reporter@v1 if: success() || failure() with: name: Maven Tests path: target/surefire-reports/*.xml reporter: java-junit - name: Upload coverage to Codecov uses: codecov/codecov-action@v3 with: file: ./target/site/jacoco/jacoco.xml - name: SonarCloud Scan uses: SonarSource/sonarcloud-github-action@master env: GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} GitHub Actions - CD 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 # .github/workflows/cd.yml name: CD on: push: branches: [ main ] tags: [ \u0026#39;v*\u0026#39; ] jobs: deploy: runs-on: ubuntu-latest if: github.ref == \u0026#39;refs/heads/main\u0026#39; steps: - uses: actions/checkout@v3 - name: Set up JDK 17 uses: actions/setup-java@v3 with: java-version: \u0026#39;17\u0026#39; distribution: \u0026#39;temurin\u0026#39; - name: Build with Maven run: mvn clean package -DskipTests - name: Build Docker image run: | docker build -t ${{ secrets.REGISTRY_URL }}/side-project:${{ github.sha }} . docker tag ${{ secrets.REGISTRY_URL }}/side-project:${{ github.sha }} ${{ secrets.REGISTRY_URL }}/side-project:latest - name: Login to Container Registry uses: docker/login-action@v2 with: registry: ${{ secrets.REGISTRY_URL }} username: ${{ secrets.REGISTRY_USERNAME }} password: ${{ secrets.REGISTRY_PASSWORD }} - name: Push Docker image run: | docker push ${{ secrets.REGISTRY_URL }}/side-project:${{ github.sha }} docker push ${{ secrets.REGISTRY_URL }}/side-project:latest - name: Deploy to production uses: appleboy/ssh-action@v0.1.5 with: host: ${{ secrets.HOST }} username: ${{ secrets.USERNAME }} key: ${{ secrets.SSH_KEY }} script: | cd /opt/side-project docker-compose pull docker-compose up -d docker system prune -f éƒ¨ç½²è…³æœ¬ å»ºæ§‹è…³æœ¬ - scripts/build.sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #!/bin/bash # å»ºæ§‹è…³æœ¬ set -e echo \u0026#34;é–‹å§‹å»ºæ§‹ Side Project...\u0026#34; # æ¸…ç†èˆŠçš„å»ºæ§‹æª”æ¡ˆ echo \u0026#34;æ¸…ç†èˆŠçš„å»ºæ§‹æª”æ¡ˆ...\u0026#34; mvn clean # åŸ·è¡Œæ¸¬è©¦ echo \u0026#34;åŸ·è¡Œæ¸¬è©¦...\u0026#34; mvn test # å»ºæ§‹æ‡‰ç”¨ç¨‹å¼ echo \u0026#34;å»ºæ§‹æ‡‰ç”¨ç¨‹å¼...\u0026#34; mvn package -DskipTests # å»ºæ§‹ Docker æ˜ åƒ echo \u0026#34;å»ºæ§‹ Docker æ˜ åƒ...\u0026#34; docker build -t side-project:latest . echo \u0026#34;å»ºæ§‹å®Œæˆï¼\u0026#34; éƒ¨ç½²è…³æœ¬ - scripts/deploy.sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 #!/bin/bash # éƒ¨ç½²è…³æœ¬ set -e ENVIRONMENT=${1:-dev} VERSION=${2:-latest} echo \u0026#34;éƒ¨ç½² Side Project åˆ° $ENVIRONMENT ç’°å¢ƒ...\u0026#34; case $ENVIRONMENT in \u0026#34;dev\u0026#34;) echo \u0026#34;éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ...\u0026#34; docker-compose -f docker-compose.yml up -d ;; \u0026#34;staging\u0026#34;) echo \u0026#34;éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ...\u0026#34; docker-compose -f docker-compose.staging.yml up -d ;; \u0026#34;prod\u0026#34;) echo \u0026#34;éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ...\u0026#34; docker-compose -f docker-compose.prod.yml up -d ;; *) echo \u0026#34;æœªçŸ¥ç’°å¢ƒ: $ENVIRONMENT\u0026#34; exit 1 ;; esac echo \u0026#34;éƒ¨ç½²å®Œæˆï¼\u0026#34; echo \u0026#34;å¥åº·æª¢æŸ¥ä¸­...\u0026#34; sleep 30 # å¥åº·æª¢æŸ¥ for i in {1..5}; do if curl -f http://localhost:8080/actuator/health \u0026gt; /dev/null 2\u0026gt;\u0026amp;1; then echo \u0026#34;æ‡‰ç”¨ç¨‹å¼å¥åº·ç‹€æ…‹æ­£å¸¸\u0026#34; break else echo \u0026#34;å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œé‡è©¦ä¸­... ($i/5)\u0026#34; sleep 10 fi done è‡ªè¨‚ Banner resources/banner.txt 1 2 3 4 5 6 7 8 9 10 11 12 13 _____ _ _ _____ _ _ / ____(_) | | | __ \\ (_) | | | (___ _ __| | ___ | |__) |____ ___ _ ___ ___| |_ \\___ \\| |/ _` |/ _ \\ | ___/ \u0026#39;__/ _ \\ |/ _ \\/ __| __| ____) | | (_| | __/ | | | | | (_) | | __/ (__| |_ |_____/|_|\\__,_|\\___| |_| |_| \\___/| |\\___|\\___|\\__| _/ | |__/ :: Spring Boot :: (v3.1.5) :: Application Version :: 1.0.0 :: Environment :: ${spring.profiles.active} :: Port :: ${server.port} æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. å®‰å…¨æ€§æœ€ä½³å¯¦è¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 # ç”Ÿç”¢ç’°å¢ƒå®‰å…¨é…ç½® security: headers: frame-options: DENY content-type-options: nosniff xss-protection: 1; mode=block referrer-policy: strict-origin-when-cross-origin ssl: enabled: true key-store: /etc/ssl/keystore.p12 key-store-password: ${SSL_KEYSTORE_PASSWORD} key-store-type: PKCS12 2. æ•ˆèƒ½å„ªåŒ–é…ç½® 1 2 3 4 5 6 7 8 9 10 11 # JVM èª¿å„ª JAVA_OPTS: \u0026gt; -server -Xms1g -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/side-project/ -Dspring.profiles.active=prod 3. ç›£æ§èˆ‡å‘Šè­¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # è‡ªè¨‚ç›£æ§æŒ‡æ¨™ management: metrics: export: prometheus: enabled: true cloudwatch: enabled: true namespace: SideProject step: 1m distribution: percentiles: http.server.requests: 0.5, 0.95, 0.99 spring.data.repository.invocations: 0.5, 0.95, 0.99 4. è³‡æ–™åº«å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 # è³‡æ–™åº«é€£ç·šæ± å„ªåŒ– spring: datasource: hikari: minimum-idle: 10 maximum-pool-size: 50 idle-timeout: 600000 connection-timeout: 30000 max-lifetime: 1800000 leak-detection-threshold: 60000 connection-test-query: SELECT 1 ç¸½çµ æœ¬æ–‡æä¾›äº†ä¸€å€‹å®Œæ•´çš„ Side Project ä¼æ¥­ç´šé…ç½®æŒ‡å—ï¼ŒåŒ…å«ï¼š\nå®Œæ•´çš„å°ˆæ¡ˆçµæ§‹ï¼šæ¨™æº–åŒ–çš„ Maven å°ˆæ¡ˆçµæ§‹ ç¾ä»£åŒ–ä¾è³´ç®¡ç†ï¼šä½¿ç”¨æœ€æ–°çš„ Spring Boot 3.x å’Œ Java 17 å¤šç’°å¢ƒé…ç½®ï¼šé–‹ç™¼ã€æ¸¬è©¦ã€ç”Ÿç”¢ç’°å¢ƒçš„å®Œæ•´é…ç½® å®‰å…¨æ€§é…ç½®ï¼šJWTã€CORSã€OAuth2 ç­‰å®‰å…¨æ©Ÿåˆ¶ å®¹å™¨åŒ–éƒ¨ç½²ï¼šDocker å’Œ docker-compose é…ç½® ç›£æ§ç³»çµ±ï¼šPrometheusã€Grafana ç›£æ§é…ç½® CI/CD æµç¨‹ï¼šGitHub Actions è‡ªå‹•åŒ–éƒ¨ç½² æœ€ä½³å¯¦è¸ï¼šå®‰å…¨æ€§ã€æ•ˆèƒ½ã€ç›£æ§ç­‰æ–¹é¢çš„å»ºè­° é€™å€‹é…ç½®å¯ä»¥ä½œç‚ºä»»ä½• Side Project çš„èµ·é»ï¼Œæä¾›äº†ä¼æ¥­ç´šçš„å¯æ“´å±•æ€§å’Œå¯ç¶­è­·æ€§ã€‚é€šééµå¾ªé€™äº›æœ€ä½³å¯¦è¸ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿå»ºç«‹ä¸€å€‹ç©©å®šã€å®‰å…¨ã€é«˜æ•ˆçš„æ‡‰ç”¨ç¨‹å¼ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/sideprojectconfig/","tags":["Project Setup","Configuration","Development","Best Practices","Spring Boot","Docker","DevOps","Microservices","CI/CD","Production","Architecture","Infrastructure","Environment","Deployment"],"title":"Side Project ä¼æ¥­ç´šå°ˆæ¡ˆé…ç½®æŒ‡å—ï¼šå®Œæ•´é–‹ç™¼ç’°å¢ƒè¨­å®šèˆ‡æœ€ä½³å¯¦è¸"},{"content":"æ¦‚è¿° Spring Framework å»£æ³›ä½¿ç”¨è¨»è§£ï¼ˆAnnotationsï¼‰ä¾†ç°¡åŒ–é…ç½®å’Œæå‡é–‹ç™¼æ•ˆç‡ã€‚å¾ Spring 2.5 é–‹å§‹å¼•å…¥è¨»è§£é©…å‹•é…ç½®ï¼Œåˆ° Spring Boot çš„è‡ªå‹•é…ç½®ï¼Œè¨»è§£å·²æˆç‚ºç¾ä»£ Spring æ‡‰ç”¨ç¨‹å¼é–‹ç™¼çš„æ ¸å¿ƒã€‚æœ¬æ–‡å°‡ç³»çµ±æ€§åœ°æ•´ç† Spring ç”Ÿæ…‹ç³»çµ±ä¸­çš„é‡è¦è¨»è§£ï¼Œä¸¦æä¾›å¯¦ç”¨çš„ç¨‹å¼ç¢¼ç¯„ä¾‹ã€‚\næ ¸å¿ƒå®¹å™¨è¨»è§£ 1. Bean å®šç¾©èˆ‡ç®¡ç† @Component ç³»åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 // é€šç”¨çµ„ä»¶ @Component public class UserValidator { public boolean validate(User user) { return user != null \u0026amp;\u0026amp; user.getEmail() != null; } } // æœå‹™å±¤çµ„ä»¶ @Service public class UserService { @Autowired private UserRepository userRepository; public User findById(Long id) { return userRepository.findById(id).orElse(null); } } // è³‡æ–™å­˜å–å±¤çµ„ä»¶ @Repository public class UserRepositoryImpl implements UserRepository { @PersistenceContext private EntityManager entityManager; @Override public Optional\u0026lt;User\u0026gt; findById(Long id) { User user = entityManager.find(User.class, id); return Optional.ofNullable(user); } } // Web å±¤çµ„ä»¶ @Controller public class UserController { @Autowired private UserService userService; @GetMapping(\u0026#34;/users/{id}\u0026#34;) @ResponseBody public User getUser(@PathVariable Long id) { return userService.findById(id); } } // RESTful API æ§åˆ¶å™¨ @RestController // ç­‰åŒæ–¼ @Controller + @ResponseBody @RequestMapping(\u0026#34;/api/users\u0026#34;) public class UserRestController { @Autowired private UserService userService; @GetMapping(\u0026#34;/{id}\u0026#34;) public User getUser(@PathVariable Long id) { return userService.findById(id); } } @Configuration å’Œ @Bean 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 @Configuration @EnableTransactionManagement @ComponentScan(basePackages = \u0026#34;com.example\u0026#34;) public class AppConfiguration { @Bean @Primary // ç•¶æœ‰å¤šå€‹ç›¸åŒé¡å‹çš„ Bean æ™‚ï¼Œå„ªå…ˆä½¿ç”¨é€™å€‹ public DataSource primaryDataSource() { HikariDataSource dataSource = new HikariDataSource(); dataSource.setJdbcUrl(\u0026#34;jdbc:mysql://localhost:3306/primary\u0026#34;); dataSource.setUsername(\u0026#34;user\u0026#34;); dataSource.setPassword(\u0026#34;password\u0026#34;); return dataSource; } @Bean @Qualifier(\u0026#34;secondary\u0026#34;) // ä½¿ç”¨é™å®šç¬¦å€åˆ† public DataSource secondaryDataSource() { HikariDataSource dataSource = new HikariDataSource(); dataSource.setJdbcUrl(\u0026#34;jdbc:mysql://localhost:3306/secondary\u0026#34;); dataSource.setUsername(\u0026#34;user\u0026#34;); dataSource.setPassword(\u0026#34;password\u0026#34;); return dataSource; } @Bean @Scope(\u0026#34;prototype\u0026#34;) // æ¯æ¬¡æ³¨å…¥éƒ½å‰µå»ºæ–°å¯¦ä¾‹ public OrderProcessor orderProcessor() { return new OrderProcessor(); } @Bean @Lazy // å»¶é²åˆå§‹åŒ– public ExpensiveService expensiveService() { return new ExpensiveService(); } } 2. ä¾è³´æ³¨å…¥è¨»è§£ @Autowired å’Œç›¸é—œè¨»è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Service public class OrderService { // å»ºæ§‹å­æ³¨å…¥ï¼ˆæ¨è–¦ï¼‰ private final PaymentService paymentService; private final EmailService emailService; @Autowired public OrderService(PaymentService paymentService, EmailService emailService) { this.paymentService = paymentService; this.emailService = emailService; } // å¯é¸ä¾è³´ @Autowired(required = false) private Optional\u0026lt;SmsService\u0026gt; smsService; // é›†åˆæ³¨å…¥ @Autowired private List\u0026lt;NotificationProvider\u0026gt; notificationProviders; // ä½¿ç”¨é™å®šç¬¦ @Autowired @Qualifier(\u0026#34;primary\u0026#34;) private DataSource primaryDataSource; // JSR-330 æ¨™æº–è¨»è§£ @Inject // ç­‰åŒæ–¼ @Autowired private AuditService auditService; @Named(\u0026#34;cache\u0026#34;) // ç­‰åŒæ–¼ @Qualifier private CacheManager cacheManager; } @Value å±¬æ€§æ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 @Component public class ConfigurationService { // åŸºæœ¬å±¬æ€§æ³¨å…¥ @Value(\u0026#34;${app.name}\u0026#34;) private String appName; // é è¨­å€¼ @Value(\u0026#34;${app.timeout:30}\u0026#34;) private int timeout; // ç³»çµ±å±¬æ€§ @Value(\u0026#34;#{systemProperties[\u0026#39;user.home\u0026#39;]}\u0026#34;) private String userHome; // SpEL è¡¨é”å¼ @Value(\u0026#34;#{T(java.lang.Math).random() * 100}\u0026#34;) private double randomNumber; // é™£åˆ—æ³¨å…¥ @Value(\u0026#34;${app.allowed-origins}\u0026#34;) private String[] allowedOrigins; // List æ³¨å…¥ @Value(\u0026#34;#{\u0026#39;${app.features}\u0026#39;.split(\u0026#39;,\u0026#39;)}\u0026#34;) private List\u0026lt;String\u0026gt; features; // Map æ³¨å…¥ @Value(\u0026#34;#{${app.database-config}}\u0026#34;) private Map\u0026lt;String, String\u0026gt; databaseConfig; // å»ºæ§‹å­åƒæ•¸æ³¨å…¥ public ConfigurationService(@Value(\u0026#34;${app.version}\u0026#34;) String version) { this.version = version; } } Web ç›¸é—œè¨»è§£ 1. MVC æ§åˆ¶å™¨è¨»è§£ @RequestMapping ç³»åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 @RestController @RequestMapping(\u0026#34;/api/v1/orders\u0026#34;) @CrossOrigin(origins = \u0026#34;http://localhost:3000\u0026#34;) // CORS è¨­å®š public class OrderController { @Autowired private OrderService orderService; // GET è«‹æ±‚ @GetMapping public Page\u0026lt;Order\u0026gt; getOrders( @RequestParam(defaultValue = \u0026#34;0\u0026#34;) int page, @RequestParam(defaultValue = \u0026#34;20\u0026#34;) int size, @RequestParam(required = false) String status, Pageable pageable) { return orderService.findOrders(status, pageable); } // è·¯å¾‘è®Šæ•¸ @GetMapping(\u0026#34;/{id}\u0026#34;) public ResponseEntity\u0026lt;Order\u0026gt; getOrder(@PathVariable Long id) { return orderService.findById(id) .map(order -\u0026gt; ResponseEntity.ok(order)) .orElse(ResponseEntity.notFound().build()); } // POST è«‹æ±‚ @PostMapping @ResponseStatus(HttpStatus.CREATED) public Order createOrder(@RequestBody @Valid CreateOrderRequest request) { return orderService.createOrder(request); } // PUT è«‹æ±‚ @PutMapping(\u0026#34;/{id}\u0026#34;) public ResponseEntity\u0026lt;Order\u0026gt; updateOrder( @PathVariable Long id, @RequestBody @Valid UpdateOrderRequest request) { return orderService.updateOrder(id, request) .map(order -\u0026gt; ResponseEntity.ok(order)) .orElse(ResponseEntity.notFound().build()); } // DELETE è«‹æ±‚ @DeleteMapping(\u0026#34;/{id}\u0026#34;) @ResponseStatus(HttpStatus.NO_CONTENT) public void deleteOrder(@PathVariable Long id) { orderService.deleteOrder(id); } // æª”æ¡ˆä¸Šå‚³ @PostMapping(\u0026#34;/{id}/attachments\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; uploadAttachment( @PathVariable Long id, @RequestParam(\u0026#34;file\u0026#34;) MultipartFile file) { String fileUrl = orderService.uploadAttachment(id, file); return ResponseEntity.ok(fileUrl); } // è‡ªè¨‚ HTTP æ–¹æ³• @RequestMapping(value = \u0026#34;/{id}/status\u0026#34;, method = RequestMethod.PATCH) public Order updateOrderStatus( @PathVariable Long id, @RequestBody OrderStatusUpdate statusUpdate) { return orderService.updateStatus(id, statusUpdate); } } åƒæ•¸è™•ç†è¨»è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 @RestController public class UserController { // è«‹æ±‚é ­è™•ç† @GetMapping(\u0026#34;/profile\u0026#34;) public UserProfile getProfile( @RequestHeader(\u0026#34;Authorization\u0026#34;) String authToken, @RequestHeader(value = \u0026#34;User-Agent\u0026#34;, required = false) String userAgent) { return userService.getProfile(authToken); } // Cookie è™•ç† @GetMapping(\u0026#34;/preferences\u0026#34;) public UserPreferences getPreferences( @CookieValue(name = \u0026#34;sessionId\u0026#34;, required = false) String sessionId) { return userService.getPreferences(sessionId); } // Session å±¬æ€§ @PostMapping(\u0026#34;/login\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; login( @RequestBody LoginRequest request, @SessionAttribute(required = false) String captcha, HttpSession session) { if (userService.validateLogin(request, captcha)) { session.setAttribute(\u0026#34;userId\u0026#34;, request.getUsername()); return ResponseEntity.ok(\u0026#34;Login successful\u0026#34;); } return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(\u0026#34;Login failed\u0026#34;); } // Model å±¬æ€§ @ModelAttribute(\u0026#34;commonData\u0026#34;) public CommonData getCommonData() { return new CommonData(); } @GetMapping(\u0026#34;/dashboard\u0026#34;) public String dashboard(@ModelAttribute(\u0026#34;commonData\u0026#34;) CommonData commonData) { return \u0026#34;dashboard\u0026#34;; } } 2. é©—è­‰è¨»è§£ Bean Validation 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 @RestController @Validated // é–‹å•Ÿé©—è­‰ public class UserController { @PostMapping(\u0026#34;/users\u0026#34;) public ResponseEntity\u0026lt;User\u0026gt; createUser(@RequestBody @Valid CreateUserRequest request) { User user = userService.createUser(request); return ResponseEntity.ok(user); } @GetMapping(\u0026#34;/users/{id}\u0026#34;) public User getUser(@PathVariable @Min(1) Long id) { return userService.findById(id); } } // è«‹æ±‚ DTO èˆ‡é©—è­‰ public class CreateUserRequest { @NotBlank(message = \u0026#34;å§“åä¸èƒ½ç‚ºç©º\u0026#34;) @Size(min = 2, max = 50, message = \u0026#34;å§“åé•·åº¦å¿…é ˆåœ¨ 2-50 å­—å…ƒä¹‹é–“\u0026#34;) private String name; @NotBlank(message = \u0026#34;ä¿¡ç®±ä¸èƒ½ç‚ºç©º\u0026#34;) @Email(message = \u0026#34;ä¿¡ç®±æ ¼å¼ä¸æ­£ç¢º\u0026#34;) private String email; @NotNull(message = \u0026#34;å¹´é½¡ä¸èƒ½ç‚ºç©º\u0026#34;) @Min(value = 18, message = \u0026#34;å¹´é½¡å¿…é ˆå¤§æ–¼ç­‰æ–¼ 18\u0026#34;) @Max(value = 120, message = \u0026#34;å¹´é½¡å¿…é ˆå°æ–¼ç­‰æ–¼ 120\u0026#34;) private Integer age; @Pattern(regexp = \u0026#34;^\\\\+?[1-9]\\\\d{1,14}$\u0026#34;, message = \u0026#34;é›»è©±è™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢º\u0026#34;) private String phone; @Valid // å·¢ç‹€ç‰©ä»¶é©—è­‰ private Address address; @NotEmpty(message = \u0026#34;è‡³å°‘è¦æœ‰ä¸€å€‹èˆˆè¶£\u0026#34;) private List\u0026lt;@NotBlank String\u0026gt; interests; // getters and setters... } // è‡ªè¨‚é©—è­‰è¨»è§£ @Target({ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @Constraint(validatedBy = UniqueEmailValidator.class) public @interface UniqueEmail { String message() default \u0026#34;ä¿¡ç®±å·²è¢«ä½¿ç”¨\u0026#34;; Class\u0026lt;?\u0026gt;[] groups() default {}; Class\u0026lt;? extends Payload\u0026gt;[] payload() default {}; } @Component public class UniqueEmailValidator implements ConstraintValidator\u0026lt;UniqueEmail, String\u0026gt; { @Autowired private UserRepository userRepository; @Override public boolean isValid(String email, ConstraintValidatorContext context) { return email == null || !userRepository.existsByEmail(email); } } è³‡æ–™å­˜å–è¨»è§£ 1. JPA å’Œ Hibernate è¨»è§£ å¯¦é«”å®šç¾© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 @Entity @Table(name = \u0026#34;users\u0026#34;, indexes = { @Index(name = \u0026#34;idx_email\u0026#34;, columnList = \u0026#34;email\u0026#34;), @Index(name = \u0026#34;idx_created_at\u0026#34;, columnList = \u0026#34;created_at\u0026#34;) }) @EntityListeners(AuditingEntityListener.class) public class User { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @Column(name = \u0026#34;full_name\u0026#34;, nullable = false, length = 100) private String name; @Column(unique = true, nullable = false) private String email; @Enumerated(EnumType.STRING) @Column(name = \u0026#34;user_status\u0026#34;) private UserStatus status = UserStatus.ACTIVE; @CreatedDate @Column(name = \u0026#34;created_at\u0026#34;, updatable = false) private LocalDateTime createdAt; @LastModifiedDate @Column(name = \u0026#34;updated_at\u0026#34;) private LocalDateTime updatedAt; @CreatedBy @Column(name = \u0026#34;created_by\u0026#34;, updatable = false) private String createdBy; @LastModifiedBy @Column(name = \u0026#34;updated_by\u0026#34;) private String updatedBy; // ä¸€å°å¤šé—œä¿‚ @OneToMany(mappedBy = \u0026#34;user\u0026#34;, cascade = CascadeType.ALL, orphanRemoval = true) @JsonIgnore private List\u0026lt;Order\u0026gt; orders = new ArrayList\u0026lt;\u0026gt;(); // å¤šå°ä¸€é—œä¿‚ @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \u0026#34;department_id\u0026#34;) private Department department; // å¤šå°å¤šé—œä¿‚ @ManyToMany @JoinTable( name = \u0026#34;user_roles\u0026#34;, joinColumns = @JoinColumn(name = \u0026#34;user_id\u0026#34;), inverseJoinColumns = @JoinColumn(name = \u0026#34;role_id\u0026#34;) ) private Set\u0026lt;Role\u0026gt; roles = new HashSet\u0026lt;\u0026gt;(); // ç‰ˆæœ¬æ§åˆ¶ï¼ˆæ¨‚è§€é–å®šï¼‰ @Version private Long version; // getters and setters... } Repository ä»‹é¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @Repository public interface UserRepository extends JpaRepository\u0026lt;User, Long\u0026gt;, JpaSpecificationExecutor\u0026lt;User\u0026gt; { // æŸ¥è©¢æ–¹æ³•åç¨±è¦å‰‡ Optional\u0026lt;User\u0026gt; findByEmail(String email); List\u0026lt;User\u0026gt; findByStatusAndCreatedAtAfter(UserStatus status, LocalDateTime date); Page\u0026lt;User\u0026gt; findByNameContainingIgnoreCase(String name, Pageable pageable); // è‡ªè¨‚æŸ¥è©¢ @Query(\u0026#34;SELECT u FROM User u WHERE u.email = ?1 AND u.status = ?2\u0026#34;) Optional\u0026lt;User\u0026gt; findByEmailAndStatus(String email, UserStatus status); // å‘½ååƒæ•¸ @Query(\u0026#34;SELECT u FROM User u WHERE u.name LIKE %:name% ORDER BY u.createdAt DESC\u0026#34;) List\u0026lt;User\u0026gt; findByNameContaining(@Param(\u0026#34;name\u0026#34;) String name); // åŸç”Ÿ SQL @Query(value = \u0026#34;SELECT * FROM users WHERE email = ?1\u0026#34;, nativeQuery = true) User findByEmailNative(String email); // æ›´æ–°æŸ¥è©¢ @Modifying @Query(\u0026#34;UPDATE User u SET u.status = :status WHERE u.id = :id\u0026#34;) int updateUserStatus(@Param(\u0026#34;id\u0026#34;) Long id, @Param(\u0026#34;status\u0026#34;) UserStatus status); // åˆªé™¤æŸ¥è©¢ @Modifying @Query(\u0026#34;DELETE FROM User u WHERE u.status = :status\u0026#34;) void deleteByStatus(@Param(\u0026#34;status\u0026#34;) UserStatus status); // æŠ•å½±æŸ¥è©¢ @Query(\u0026#34;SELECT new com.example.dto.UserSummary(u.id, u.name, u.email) FROM User u\u0026#34;) List\u0026lt;UserSummary\u0026gt; findUserSummaries(); // è¨ˆæ•¸æŸ¥è©¢ long countByStatus(UserStatus status); boolean existsByEmail(String email); } 2. äº¤æ˜“ç®¡ç† @Transactional è¨»è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 @Service @Transactional // é¡åˆ¥å±¤ç´šçš„äº¤æ˜“è¨­å®š public class OrderService { @Autowired private OrderRepository orderRepository; @Autowired private PaymentService paymentService; @Autowired private InventoryService inventoryService; // é è¨­äº¤æ˜“è¨­å®š public Order createOrder(CreateOrderRequest request) { Order order = new Order(request); order = orderRepository.save(order); // é€™äº›æ“ä½œéƒ½åœ¨åŒä¸€å€‹äº¤æ˜“ä¸­ paymentService.processPayment(order); inventoryService.updateStock(order.getItems()); return order; } // å”¯è®€äº¤æ˜“ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼‰ @Transactional(readOnly = true) public List\u0026lt;Order\u0026gt; findOrdersByUser(Long userId) { return orderRepository.findByUserId(userId); } // æŒ‡å®šå‚³æ’­è¡Œç‚º @Transactional(propagation = Propagation.REQUIRES_NEW) public void logOrderEvent(Long orderId, String event) { // é€™å€‹æ–¹æ³•ç¸½æ˜¯åœ¨æ–°çš„äº¤æ˜“ä¸­åŸ·è¡Œ OrderEvent orderEvent = new OrderEvent(orderId, event); orderEventRepository.save(orderEvent); } // æŒ‡å®šéš”é›¢ç´šåˆ¥ @Transactional(isolation = Isolation.SERIALIZABLE) public void processHighValueOrder(Order order) { // åºåˆ—åŒ–éš”é›¢ç´šåˆ¥ï¼Œé¿å…ä½µç™¼å•é¡Œ processOrder(order); } // ç•°å¸¸å›æ»¾è¨­å®š @Transactional(rollbackFor = {Exception.class}, noRollbackFor = {ValidationException.class}) public void complexOperation() { // é‡åˆ°ä»»ä½• Exception éƒ½å›æ»¾ï¼Œé™¤äº† ValidationException } // è¶…æ™‚è¨­å®š @Transactional(timeout = 30) // 30 ç§’è¶…æ™‚ public void longRunningOperation() { // é•·æ™‚é–“é‹è¡Œçš„æ“ä½œ } // æŒ‡å®šäº¤æ˜“ç®¡ç†å™¨ @Transactional(transactionManager = \u0026#34;secondaryTransactionManager\u0026#34;) public void operationOnSecondaryDatabase() { // ä½¿ç”¨æŒ‡å®šçš„äº¤æ˜“ç®¡ç†å™¨ } } æ’ç¨‹å’ŒéåŒæ­¥è™•ç† 1. æ’ç¨‹ä»»å‹™è¨»è§£ @Scheduled å’Œ @EnableScheduling 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 @Configuration @EnableScheduling public class SchedulingConfig { @Bean public TaskScheduler taskScheduler() { ThreadPoolTaskScheduler scheduler = new ThreadPoolTaskScheduler(); scheduler.setPoolSize(10); scheduler.setThreadNamePrefix(\u0026#34;scheduled-task-\u0026#34;); scheduler.initialize(); return scheduler; } } @Component @Slf4j public class ScheduledTasks { @Autowired private OrderService orderService; @Autowired private EmailService emailService; // å›ºå®šå»¶é²åŸ·è¡Œï¼ˆä¸Šæ¬¡åŸ·è¡Œå®Œæˆå¾Œå¤šä¹…å†åŸ·è¡Œï¼‰ @Scheduled(fixedDelay = 5000) // 5 ç§’ public void processOrders() { log.info(\u0026#34;è™•ç†å¾…è™•ç†è¨‚å–®\u0026#34;); orderService.processePendingOrders(); } // å›ºå®šé »ç‡åŸ·è¡Œï¼ˆå›ºå®šé–“éš”åŸ·è¡Œï¼‰ @Scheduled(fixedRate = 10000) // 10 ç§’ public void heartbeat() { log.info(\u0026#34;ç³»çµ±å¿ƒè·³æª¢æŸ¥\u0026#34;); // ç³»çµ±å¥åº·æª¢æŸ¥é‚è¼¯ } // åˆå§‹å»¶é² @Scheduled(fixedDelay = 30000, initialDelay = 60000) // 1 åˆ†é˜å¾Œé–‹å§‹ï¼Œç„¶å¾Œæ¯ 30 ç§’åŸ·è¡Œ public void cleanupTempFiles() { log.info(\u0026#34;æ¸…ç†æš«å­˜æª”æ¡ˆ\u0026#34;); // æ¸…ç†é‚è¼¯ } // Cron è¡¨é”å¼ - æ¯åˆ†é˜åŸ·è¡Œ @Scheduled(cron = \u0026#34;0 * * * * *\u0026#34;) public void everyMinute() { log.info(\u0026#34;æ¯åˆ†é˜åŸ·è¡Œçš„ä»»å‹™\u0026#34;); } // Cron è¡¨é”å¼ - æ¯å¤©å‡Œæ™¨ 2 é»åŸ·è¡Œ @Scheduled(cron = \u0026#34;0 0 2 * * *\u0026#34;) public void dailyReport() { log.info(\u0026#34;ç”¢ç”Ÿæ¯æ—¥å ±å‘Š\u0026#34;); emailService.sendDailyReport(); } // Cron è¡¨é”å¼ - å·¥ä½œæ—¥ä¸Šåˆ 9 é»åŸ·è¡Œ @Scheduled(cron = \u0026#34;0 0 9 * * MON-FRI\u0026#34;) public void workdayMorningTask() { log.info(\u0026#34;å·¥ä½œæ—¥æ—©æ™¨ä»»å‹™\u0026#34;); } // Cron è¡¨é”å¼ - æ¯æœˆæœ€å¾Œä¸€å¤©åŸ·è¡Œ @Scheduled(cron = \u0026#34;0 0 0 L * *\u0026#34;) public void monthlyTask() { log.info(\u0026#34;æœˆæœ«ä»»å‹™\u0026#34;); } // ä½¿ç”¨é…ç½®å±¬æ€§ @Scheduled(cron = \u0026#34;${app.cleanup.cron:0 0 3 * * *}\u0026#34;) // é è¨­æ¯å¤©å‡Œæ™¨ 3 é» public void configuredTask() { log.info(\u0026#34;å¯é…ç½®çš„æ’ç¨‹ä»»å‹™\u0026#34;); } // æ¢ä»¶æ€§æ’ç¨‹ @Scheduled(fixedDelay = 60000) @ConditionalOnProperty(name = \u0026#34;app.monitoring.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public void monitoringTask() { log.info(\u0026#34;ç›£æ§ä»»å‹™\u0026#34;); } } Cron è¡¨é”å¼è©³è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 /** * Cron è¡¨é”å¼æ ¼å¼ï¼šç§’ åˆ† æ™‚ æ—¥ æœˆ é€± * * æ¬„ä½èªªæ˜ï¼š * - ç§’ï¼š0-59 * - åˆ†ï¼š0-59 * - æ™‚ï¼š0-23 * - æ—¥ï¼š1-31 * - æœˆï¼š1-12 æˆ– JAN-DEC * - é€±ï¼š0-7 æˆ– SUN-SAT (0 å’Œ 7 éƒ½ä»£è¡¨é€±æ—¥) * * ç‰¹æ®Šå­—ç¬¦ï¼š * * : åŒ¹é…ä»»æ„å€¼ * ? : åªèƒ½ç”¨åœ¨æ—¥å’Œé€±ï¼Œè¡¨ç¤ºä¸æŒ‡å®šå€¼ * - : è¡¨ç¤ºç¯„åœ (ä¾‹å¦‚ï¼š1-5) * , : è¡¨ç¤ºåˆ—èˆ‰ (ä¾‹å¦‚ï¼š1,3,5) * / : è¡¨ç¤ºå¢é‡ (ä¾‹å¦‚ï¼š0/15 è¡¨ç¤ºå¾ 0 é–‹å§‹æ¯ 15 åˆ†é˜) * L : è¡¨ç¤ºæœ€å¾Œ (ä¾‹å¦‚ï¼šL åœ¨æ—¥æ¬„ä½è¡¨ç¤ºè©²æœˆæœ€å¾Œä¸€å¤©) * W : è¡¨ç¤ºå·¥ä½œæ—¥ (ä¾‹å¦‚ï¼š15W è¡¨ç¤ºè·é›¢ 15 è™Ÿæœ€è¿‘çš„å·¥ä½œæ—¥) * # : è¡¨ç¤ºç¬¬å¹¾å€‹é€±å¹¾ (ä¾‹å¦‚ï¼š6#3 è¡¨ç¤ºç¬¬ä¸‰å€‹é€±äº”) */ @Component public class CronExamples { @Scheduled(cron = \u0026#34;0 0 * * * *\u0026#34;) // æ¯å°æ™‚æ•´é»åŸ·è¡Œ public void hourly() {} @Scheduled(cron = \u0026#34;*/10 * * * * *\u0026#34;) // æ¯ 10 ç§’åŸ·è¡Œ public void every10Seconds() {} @Scheduled(cron = \u0026#34;0 0 8-18 * * *\u0026#34;) // æ¯å¤© 8-18 é»æ•´é»åŸ·è¡Œ public void businessHours() {} @Scheduled(cron = \u0026#34;0 0/30 8-18 * * *\u0026#34;) // æ¯å¤© 8-18 é»æ¯åŠå°æ™‚åŸ·è¡Œ public void businessHalfHour() {} @Scheduled(cron = \u0026#34;0 0 9-17 * * MON-FRI\u0026#34;) // å·¥ä½œæ—¥ 9-17 é»æ•´é»åŸ·è¡Œ public void workingHours() {} @Scheduled(cron = \u0026#34;0 0 0 25 12 ?\u0026#34;) // æ¯å¹´è–èª•ç¯€ 00:00 åŸ·è¡Œ public void christmas() {} @Scheduled(cron = \u0026#34;0 0 0 L * *\u0026#34;) // æ¯æœˆæœ€å¾Œä¸€å¤© 00:00 åŸ·è¡Œ public void lastDayOfMonth() {} @Scheduled(cron = \u0026#34;0 0 0 LW * *\u0026#34;) // æ¯æœˆæœ€å¾Œä¸€å€‹å·¥ä½œæ—¥ 00:00 åŸ·è¡Œ public void lastWorkdayOfMonth() {} @Scheduled(cron = \u0026#34;0 0 0 * * 1#1\u0026#34;) // æ¯æœˆç¬¬ä¸€å€‹é€±ä¸€ 00:00 åŸ·è¡Œ public void firstMondayOfMonth() {} } 2. éåŒæ­¥è™•ç†è¨»è§£ @Async å’Œ @EnableAsync 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 @Configuration @EnableAsync public class AsyncConfig implements AsyncConfigurer { @Override @Bean(name = \u0026#34;taskExecutor\u0026#34;) public Executor getAsyncExecutor() { ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(5); executor.setMaxPoolSize(20); executor.setQueueCapacity(100); executor.setThreadNamePrefix(\u0026#34;async-task-\u0026#34;); executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy()); executor.initialize(); return executor; } @Override public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() { return (ex, method, params) -\u0026gt; { log.error(\u0026#34;éåŒæ­¥æ–¹æ³• {} åŸ·è¡Œç•°å¸¸\u0026#34;, method.getName(), ex); }; } } @Service @Slf4j public class NotificationService { // ç°¡å–®éåŒæ­¥æ–¹æ³• @Async public void sendEmail(String to, String subject, String content) { log.info(\u0026#34;ç™¼é€éƒµä»¶åˆ° {}\u0026#34;, to); // æ¨¡æ“¬éƒµä»¶ç™¼é€ try { Thread.sleep(2000); log.info(\u0026#34;éƒµä»¶ç™¼é€å®Œæˆ\u0026#34;); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } } // è¿”å› CompletableFuture @Async public CompletableFuture\u0026lt;String\u0026gt; sendSms(String phone, String message) { log.info(\u0026#34;ç™¼é€ç°¡è¨Šåˆ° {}\u0026#34;, phone); try { Thread.sleep(1000); return CompletableFuture.completedFuture(\u0026#34;ç°¡è¨Šç™¼é€æˆåŠŸ\u0026#34;); } catch (InterruptedException e) { Thread.currentThread().interrupt(); return CompletableFuture.failedFuture(e); } } // æŒ‡å®šåŸ·è¡Œå™¨ @Async(\u0026#34;taskExecutor\u0026#34;) public CompletableFuture\u0026lt;Boolean\u0026gt; processLargeFile(String filePath) { log.info(\u0026#34;é–‹å§‹è™•ç†å¤§æª”æ¡ˆï¼š{}\u0026#34;, filePath); try { // æ¨¡æ“¬æª”æ¡ˆè™•ç† Thread.sleep(5000); log.info(\u0026#34;æª”æ¡ˆè™•ç†å®Œæˆï¼š{}\u0026#34;, filePath); return CompletableFuture.completedFuture(true); } catch (InterruptedException e) { Thread.currentThread().interrupt(); return CompletableFuture.failedFuture(e); } } // æ‰¹é‡éåŒæ­¥è™•ç† public CompletableFuture\u0026lt;Void\u0026gt; sendBulkNotifications(List\u0026lt;User\u0026gt; users, String message) { List\u0026lt;CompletableFuture\u0026lt;Void\u0026gt;\u0026gt; futures = users.stream() .map(user -\u0026gt; sendNotificationAsync(user, message)) .collect(Collectors.toList()); return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])); } @Async private CompletableFuture\u0026lt;Void\u0026gt; sendNotificationAsync(User user, String message) { // ç™¼é€é€šçŸ¥é‚è¼¯ return CompletableFuture.completedFuture(null); } } Spring Boot ç‰¹å®šè¨»è§£ 1. è‡ªå‹•é…ç½®è¨»è§£ @SpringBootApplication åˆ†è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // @SpringBootApplication ç­‰åŒæ–¼ä»¥ä¸‹ä¸‰å€‹è¨»è§£çš„çµ„åˆï¼š // @Configuration + @EnableAutoConfiguration + @ComponentScan @SpringBootApplication // ç­‰åŒæ–¼ï¼š // @Configuration // @EnableAutoConfiguration // @ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class), // @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) }) public class Application { public static void main(String[] args) { SpringApplication.run(Application.class, args); } } // è‡ªè¨‚æƒæé…ç½® @SpringBootApplication( scanBasePackages = {\u0026#34;com.example.app\u0026#34;, \u0026#34;com.example.shared\u0026#34;}, exclude = {DataSourceAutoConfiguration.class} // æ’é™¤ç‰¹å®šè‡ªå‹•é…ç½® ) public class CustomApplication { public static void main(String[] args) { SpringApplication.run(CustomApplication.class, args); } } æ¢ä»¶è¨»è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 @Configuration public class ConditionalConfiguration { // ç•¶é¡åˆ¥å­˜åœ¨æ™‚ @Bean @ConditionalOnClass(RedisTemplate.class) public RedisService redisService() { return new RedisService(); } // ç•¶é¡åˆ¥ä¸å­˜åœ¨æ™‚ @Bean @ConditionalOnMissingClass(\u0026#34;com.example.CustomService\u0026#34;) public DefaultService defaultService() { return new DefaultService(); } // ç•¶ Bean å­˜åœ¨æ™‚ @Bean @ConditionalOnBean(DataSource.class) public JdbcTemplate jdbcTemplate(DataSource dataSource) { return new JdbcTemplate(dataSource); } // ç•¶ Bean ä¸å­˜åœ¨æ™‚ @Bean @ConditionalOnMissingBean(EmailService.class) public EmailService mockEmailService() { return new MockEmailService(); } // ç•¶å±¬æ€§å­˜åœ¨ä¸”ç¬¦åˆæ¢ä»¶æ™‚ @Bean @ConditionalOnProperty(name = \u0026#34;app.cache.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;, matchIfMissing = false) public CacheManager cacheManager() { return new ConcurrentMapCacheManager(); } // ç•¶ Web æ‡‰ç”¨ç¨‹å¼æ™‚ @Bean @ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET) public WebMvcConfigurer webMvcConfigurer() { return new CustomWebMvcConfigurer(); } // ç•¶é Web æ‡‰ç”¨ç¨‹å¼æ™‚ @Bean @ConditionalOnNotWebApplication public CommandLineRunner commandLineRunner() { return args -\u0026gt; System.out.println(\u0026#34;Non-web application started\u0026#34;); } // ç•¶ç‰¹å®š Profile å•Ÿç”¨æ™‚ @Bean @Profile(\u0026#34;development\u0026#34;) public DataSource devDataSource() { return new H2DataSource(); } @Bean @Profile(\u0026#34;production\u0026#34;) public DataSource prodDataSource() { return new MySQLDataSource(); } // è‡ªè¨‚æ¢ä»¶ @Bean @ConditionalOnCustomCondition public CustomService customService() { return new CustomService(); } } // è‡ªè¨‚æ¢ä»¶å¯¦ä½œ public class CustomCondition implements Condition { @Override public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) { // è‡ªè¨‚æ¢ä»¶é‚è¼¯ String osName = context.getEnvironment().getProperty(\u0026#34;os.name\u0026#34;); return osName != null \u0026amp;\u0026amp; osName.toLowerCase().contains(\u0026#34;windows\u0026#34;); } } @Target({ElementType.TYPE, ElementType.METHOD}) @Retention(RetentionPolicy.RUNTIME) @Conditional(CustomCondition.class) public @interface ConditionalOnCustomCondition { } 2. é…ç½®å±¬æ€§è¨»è§£ @ConfigurationProperties 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 @ConfigurationProperties(prefix = \u0026#34;app\u0026#34;) @Component @Validated @Data public class AppProperties { @NotBlank private String name; @NotBlank private String version; @Valid private Database database = new Database(); @Valid private Cache cache = new Cache(); private List\u0026lt;String\u0026gt; allowedOrigins = new ArrayList\u0026lt;\u0026gt;(); private Map\u0026lt;String, String\u0026gt; headers = new HashMap\u0026lt;\u0026gt;(); @Data public static class Database { @NotBlank private String url; @NotBlank private String username; @NotBlank private String password; @Min(1) @Max(100) private int maxConnections = 10; @DurationMin(seconds = 1) @DurationMax(minutes = 5) private Duration timeout = Duration.ofSeconds(30); } @Data public static class Cache { private boolean enabled = true; @Positive private int maxSize = 1000; @DurationMin(minutes = 1) private Duration ttl = Duration.ofMinutes(10); private CacheType type = CacheType.MEMORY; } public enum CacheType { MEMORY, REDIS, HAZELCAST } } // ä½¿ç”¨é…ç½® @Service @RequiredArgsConstructor public class AppService { private final AppProperties appProperties; public void printConfig() { System.out.println(\u0026#34;App Name: \u0026#34; + appProperties.getName()); System.out.println(\u0026#34;Database URL: \u0026#34; + appProperties.getDatabase().getUrl()); System.out.println(\u0026#34;Cache Enabled: \u0026#34; + appProperties.getCache().isEnabled()); } } å¿«å–è¨»è§£ @EnableCaching å’Œå¿«å–æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 @Configuration @EnableCaching public class CacheConfig { @Bean public CacheManager cacheManager() { ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager(); cacheManager.setAllowNullValues(false); return cacheManager; } } @Service @Slf4j public class UserService { @Autowired private UserRepository userRepository; // å¿«å–çµæœ @Cacheable(value = \u0026#34;users\u0026#34;, key = \u0026#34;#id\u0026#34;) public User findById(Long id) { log.info(\u0026#34;å¾è³‡æ–™åº«è¼‰å…¥ä½¿ç”¨è€…ï¼š{}\u0026#34;, id); return userRepository.findById(id).orElse(null); } // æ¢ä»¶å¿«å– @Cacheable(value = \u0026#34;users\u0026#34;, key = \u0026#34;#email\u0026#34;, condition = \u0026#34;#email.length() \u0026gt; 5\u0026#34;) public User findByEmail(String email) { return userRepository.findByEmail(email).orElse(null); } // å¿«å–å¤šå€‹å€¼ @Cacheable(value = \u0026#34;userProfiles\u0026#34;, key = \u0026#34;#user.id\u0026#34;, unless = \u0026#34;#result.isEmpty()\u0026#34;) public List\u0026lt;UserProfile\u0026gt; getUserProfiles(User user) { return userProfileRepository.findByUserId(user.getId()); } // æ›´æ–°å¿«å– @CachePut(value = \u0026#34;users\u0026#34;, key = \u0026#34;#user.id\u0026#34;) public User updateUser(User user) { log.info(\u0026#34;æ›´æ–°ä½¿ç”¨è€…ä¸¦åˆ·æ–°å¿«å–ï¼š{}\u0026#34;, user.getId()); return userRepository.save(user); } // æ¸…é™¤å¿«å– @CacheEvict(value = \u0026#34;users\u0026#34;, key = \u0026#34;#id\u0026#34;) public void deleteUser(Long id) { log.info(\u0026#34;åˆªé™¤ä½¿ç”¨è€…ä¸¦æ¸…é™¤å¿«å–ï¼š{}\u0026#34;, id); userRepository.deleteById(id); } // æ¸…é™¤æ‰€æœ‰å¿«å– @CacheEvict(value = \u0026#34;users\u0026#34;, allEntries = true) public void clearUserCache() { log.info(\u0026#34;æ¸…é™¤æ‰€æœ‰ä½¿ç”¨è€…å¿«å–\u0026#34;); } // çµ„åˆå¿«å–æ“ä½œ @Caching( cacheable = @Cacheable(value = \u0026#34;users\u0026#34;, key = \u0026#34;#id\u0026#34;), evict = @CacheEvict(value = \u0026#34;userStats\u0026#34;, key = \u0026#34;#id\u0026#34;) ) public User findAndUpdateStats(Long id) { User user = userRepository.findById(id).orElse(null); if (user != null) { updateUserStats(user); } return user; } // è‡ªè¨‚å¿«å–éµç”Ÿæˆå™¨ @Cacheable(value = \u0026#34;userSearch\u0026#34;, keyGenerator = \u0026#34;customKeyGenerator\u0026#34;) public List\u0026lt;User\u0026gt; searchUsers(UserSearchCriteria criteria) { return userRepository.findByCriteria(criteria); } } @Component(\u0026#34;customKeyGenerator\u0026#34;) public class CustomKeyGenerator implements KeyGenerator { @Override public Object generate(Object target, Method method, Object... params) { return method.getName() + \u0026#34;_\u0026#34; + Arrays.toString(params); } } æ¸¬è©¦è¨»è§£ Spring Boot æ¸¬è©¦è¨»è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 // å®Œæ•´çš„ Spring Boot æ¸¬è©¦ @SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) @TestPropertySource(properties = { \u0026#34;spring.datasource.url=jdbc:h2:mem:testdb\u0026#34;, \u0026#34;spring.jpa.hibernate.ddl-auto=create-drop\u0026#34; }) class IntegrationTest { @Autowired private TestRestTemplate restTemplate; @Autowired private UserService userService; @Test void testCreateUser() { CreateUserRequest request = new CreateUserRequest(\u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;); ResponseEntity\u0026lt;User\u0026gt; response = restTemplate.postForEntity(\u0026#34;/api/users\u0026#34;, request, User.class); assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CREATED); assertThat(response.getBody().getName()).isEqualTo(\u0026#34;John\u0026#34;); } } // Web å±¤æ¸¬è©¦ @WebMvcTest(UserController.class) class UserControllerTest { @Autowired private MockMvc mockMvc; @MockBean private UserService userService; @Test void testGetUser() throws Exception { User user = new User(1L, \u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;); when(userService.findById(1L)).thenReturn(user); mockMvc.perform(get(\u0026#34;/api/users/1\u0026#34;)) .andExpect(status().isOk()) .andExpect(jsonPath(\u0026#34;$.name\u0026#34;).value(\u0026#34;John\u0026#34;)) .andExpect(jsonPath(\u0026#34;$.email\u0026#34;).value(\u0026#34;john@example.com\u0026#34;)); } } // è³‡æ–™å±¤æ¸¬è©¦ @DataJpaTest class UserRepositoryTest { @Autowired private TestEntityManager entityManager; @Autowired private UserRepository userRepository; @Test void testFindByEmail() { // Given User user = new User(\u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;); entityManager.persistAndFlush(user); // When Optional\u0026lt;User\u0026gt; found = userRepository.findByEmail(\u0026#34;john@example.com\u0026#34;); // Then assertThat(found).isPresent(); assertThat(found.get().getName()).isEqualTo(\u0026#34;John\u0026#34;); } } // JSON åºåˆ—åŒ–æ¸¬è©¦ @JsonTest class UserJsonTest { @Autowired private JacksonTester\u0026lt;User\u0026gt; json; @Test void testSerialize() throws Exception { User user = new User(1L, \u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;); assertThat(json.write(user)).isEqualToJson(\u0026#34;user.json\u0026#34;); assertThat(json.write(user)).hasJsonPathStringValue(\u0026#34;@.name\u0026#34;); assertThat(json.write(user)).extractingJsonPathStringValue(\u0026#34;@.name\u0026#34;).isEqualTo(\u0026#34;John\u0026#34;); } @Test void testDeserialize() throws Exception { String content = \u0026#34;\u0026#34;\u0026#34; { \u0026#34;id\u0026#34;: 1, \u0026#34;name\u0026#34;: \u0026#34;John\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;john@example.com\u0026#34; } \u0026#34;\u0026#34;\u0026#34;; assertThat(json.parse(content)).usingRecursiveComparison() .isEqualTo(new User(1L, \u0026#34;John\u0026#34;, \u0026#34;john@example.com\u0026#34;)); } } äº‹ä»¶è™•ç†è¨»è§£ @EventListener å’Œ @TransactionalEventListener 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 // äº‹ä»¶å®šç¾© public class OrderCreatedEvent { private final Order order; private final LocalDateTime timestamp; public OrderCreatedEvent(Order order) { this.order = order; this.timestamp = LocalDateTime.now(); } // getters... } // äº‹ä»¶ç™¼å¸ƒ @Service @RequiredArgsConstructor public class OrderService { private final OrderRepository orderRepository; private final ApplicationEventPublisher eventPublisher; @Transactional public Order createOrder(CreateOrderRequest request) { Order order = new Order(request); order = orderRepository.save(order); // ç™¼å¸ƒäº‹ä»¶ eventPublisher.publishEvent(new OrderCreatedEvent(order)); return order; } } // äº‹ä»¶ç›£è½ @Component @Slf4j public class OrderEventListener { @Autowired private EmailService emailService; @Autowired private InventoryService inventoryService; // åŸºæœ¬äº‹ä»¶ç›£è½ @EventListener public void handleOrderCreated(OrderCreatedEvent event) { log.info(\u0026#34;è¨‚å–®å‰µå»ºäº‹ä»¶ï¼š{}\u0026#34;, event.getOrder().getId()); } // æ¢ä»¶äº‹ä»¶ç›£è½ @EventListener(condition = \u0026#34;#event.order.amount \u0026gt; 1000\u0026#34;) public void handleHighValueOrder(OrderCreatedEvent event) { log.info(\u0026#34;é«˜åƒ¹å€¼è¨‚å–®å‰µå»ºï¼š{}\u0026#34;, event.getOrder().getId()); // ç‰¹æ®Šè™•ç†é‚è¼¯ } // éåŒæ­¥äº‹ä»¶è™•ç† @EventListener @Async public void sendOrderConfirmationEmail(OrderCreatedEvent event) { log.info(\u0026#34;ç™¼é€è¨‚å–®ç¢ºèªéƒµä»¶ï¼š{}\u0026#34;, event.getOrder().getId()); emailService.sendOrderConfirmation(event.getOrder()); } // äº¤æ˜“äº‹ä»¶ç›£è½ï¼ˆåœ¨äº¤æ˜“æäº¤å¾ŒåŸ·è¡Œï¼‰ @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT) public void updateInventoryAfterOrderCreated(OrderCreatedEvent event) { log.info(\u0026#34;äº¤æ˜“æäº¤å¾Œæ›´æ–°åº«å­˜ï¼š{}\u0026#34;, event.getOrder().getId()); inventoryService.updateStock(event.getOrder().getItems()); } // äº¤æ˜“å›æ»¾æ™‚åŸ·è¡Œ @TransactionalEventListener(phase = TransactionPhase.AFTER_ROLLBACK) public void handleOrderCreationRollback(OrderCreatedEvent event) { log.warn(\u0026#34;è¨‚å–®å‰µå»ºå›æ»¾ï¼š{}\u0026#34;, event.getOrder().getId()); // å›æ»¾è™•ç†é‚è¼¯ } // ç›£è½å¤šç¨®äº‹ä»¶é¡å‹ @EventListener({OrderCreatedEvent.class, OrderUpdatedEvent.class}) public void handleOrderEvents(Object event) { log.info(\u0026#34;è™•ç†è¨‚å–®äº‹ä»¶ï¼š{}\u0026#34;, event.getClass().getSimpleName()); } } ç¸½çµ Spring Framework çš„è¨»è§£ç³»çµ±ç‚ºé–‹ç™¼è€…æä¾›äº†å¼·å¤§ä¸”éˆæ´»çš„é…ç½®æ–¹å¼ã€‚é€éåˆç†ä½¿ç”¨é€™äº›è¨»è§£ï¼Œå¯ä»¥å¤§å¹…ç°¡åŒ–é…ç½®å·¥ä½œä¸¦æå‡é–‹ç™¼æ•ˆç‡ã€‚\næœ€ä½³å¯¦è¸å»ºè­° å„ªå…ˆä½¿ç”¨è¨»è§£é…ç½®ï¼šç›¸æ¯” XML é…ç½®ï¼Œè¨»è§£æ›´ç›´è§€ä¸”æ˜“æ–¼ç¶­è­· çµ„åˆä½¿ç”¨è¨»è§£ï¼šå–„ç”¨ @SpringBootApplication ç­‰çµ„åˆè¨»è§£ é©ç•¶ä½¿ç”¨æ¢ä»¶è¨»è§£ï¼šæ ¹æ“šç’°å¢ƒå‹•æ…‹é…ç½® Bean é©—è­‰é…ç½®å±¬æ€§ï¼šä½¿ç”¨ @Validated ç¢ºä¿é…ç½®æ­£ç¢ºæ€§ åˆç†ä½¿ç”¨å¿«å–ï¼šåœ¨é©ç•¶çš„åœ°æ–¹ä½¿ç”¨å¿«å–æå‡æ•ˆèƒ½ æ¸¬è©¦è¦†è“‹ï¼šä½¿ç”¨å°ˆé–€çš„æ¸¬è©¦è¨»è§£é€²è¡Œå„å±¤æ¸¬è©¦ äº‹ä»¶é©…å‹•è¨­è¨ˆï¼šä½¿ç”¨äº‹ä»¶æ©Ÿåˆ¶é™ä½çµ„ä»¶è€¦åˆåº¦ æ³¨æ„äº‹é … è¨»è§£éè¼‰ï¼šé¿å…åœ¨å–®ä¸€é¡åˆ¥æˆ–æ–¹æ³•ä¸Šä½¿ç”¨éå¤šè¨»è§£ é…ç½®å¤–éƒ¨åŒ–ï¼šæ•æ„Ÿé…ç½®æ‡‰ä½¿ç”¨å¤–éƒ¨å±¬æ€§æª”æ¡ˆ æ•ˆèƒ½è€ƒé‡ï¼šæ³¨æ„ä»£ç†æ¨¡å¼å¯èƒ½å¸¶ä¾†çš„æ•ˆèƒ½å½±éŸ¿ æ¸¬è©¦å‹å–„ï¼šè¨­è¨ˆæ™‚è€ƒæ…®æ¸¬è©¦çš„ä¾¿åˆ©æ€§ æŒæ¡é€™äº›è¨»è§£çš„æ­£ç¢ºä½¿ç”¨æ–¹å¼ï¼Œå°‡èƒ½å¤§å¹…æå‡ Spring æ‡‰ç”¨ç¨‹å¼çš„é–‹ç™¼æ•ˆç‡å’Œç¨‹å¼ç¢¼å“è³ªã€‚\nåƒè€ƒè³‡æ–™ Spring Framework Reference Documentation Spring Boot Reference Guide Spring Data JPA Reference Bean Validation Specification Cron Expression Generator ","permalink":"https://xinqilin.github.io/post/backend/springannotation/","tags":["Java","Spring","Annotation","Spring-Boot","Configuration","Web","Data","Security"],"title":"Spring Framework è¨»è§£å®Œæ•´æŒ‡å—ï¼šå¾åŸºç¤åˆ°é€²éšæ‡‰ç”¨"},{"content":"æ¦‚è¿° AWK æ˜¯ä¸€ç¨®å¼·å¤§çš„æ¨¡å¼æƒæå’Œè™•ç†èªè¨€ï¼Œç”± Alfred Ahoã€Peter Weinberger å’Œ Brian Kernighan æ–¼ 1977 å¹´åœ¨è²çˆ¾å¯¦é©—å®¤é–‹ç™¼ã€‚AWK ç‰¹åˆ¥é©åˆè™•ç†çµæ§‹åŒ–æ–‡æœ¬è³‡æ–™ï¼Œèƒ½å¤ é€²è¡Œè¤‡é›œçš„æ–‡æœ¬åˆ†æã€å ±è¡¨ç”Ÿæˆå’Œè³‡æ–™æå–ã€‚\næ ¸å¿ƒç‰¹å¾µ æ¨¡å¼-å‹•ä½œç¨‹å¼è¨­è¨ˆï¼šåŸºæ–¼æ¨¡å¼åŒ¹é…åŸ·è¡Œç›¸æ‡‰å‹•ä½œ è‡ªå‹•æ¬„ä½åˆ†å‰²ï¼šè‡ªå‹•å°‡è¼¸å…¥è¡Œåˆ†å‰²ç‚ºæ¬„ä½ å¼·å¤§çš„å…§å»ºè®Šæ•¸ï¼šæä¾›è±å¯Œçš„ç’°å¢ƒè³‡è¨Š æ•¸å­¸é‹ç®—èƒ½åŠ›ï¼šæ”¯æ´å®Œæ•´çš„ç®—è¡“å’Œå­—ä¸²æ“ä½œ æ­£è¦è¡¨é”å¼æ”¯æ´ï¼šå¼·å¤§çš„æ¨¡å¼åŒ¹é…åŠŸèƒ½ åŸºæœ¬èªæ³• 1 2 3 awk \u0026#39;pattern { action }\u0026#39; file(s) awk -f script.awk file(s) command | awk \u0026#39;pattern { action }\u0026#39; AWK ç¨‹å¼çµæ§‹ 1 2 3 awk \u0026#39;BEGIN { åˆå§‹åŒ–å‹•ä½œ } pattern { ä¸»è¦è™•ç†å‹•ä½œ } END { çµæŸå‹•ä½œ }\u0026#39; file åŸºæœ¬ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 # åˆ—å°æ•´å€‹æª”æ¡ˆ awk \u0026#39;{print}\u0026#39; file.txt # ç­‰åŒæ–¼ awk \u0026#39;{print $0}\u0026#39; file.txt # åˆ—å°ç‰¹å®šæ¬„ä½ awk \u0026#39;{print $1, $3}\u0026#39; file.txt # åˆ—å°ç¬¬1å’Œç¬¬3æ¬„ä½ # ç°¡å–®éæ¿¾ awk \u0026#39;/pattern/ {print}\u0026#39; file.txt # åˆ—å°åŒ…å« pattern çš„è¡Œ # è¨ˆç®—çµ±è¨ˆ awk \u0026#39;{sum += $1} END {print sum}\u0026#39; file.txt # è¨ˆç®—ç¬¬1æ¬„ä½ç¸½å’Œ æ¬„ä½å’Œè¨˜éŒ„ æ¬„ä½è™•ç† AWK è‡ªå‹•å°‡æ¯è¡Œè¼¸å…¥åˆ†å‰²ç‚ºæ¬„ä½ï¼Œé è¨­åˆ†éš”ç¬¦ç‚ºç©ºç™½å­—å…ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 # æ¬„ä½è®Šæ•¸ $0 # æ•´è¡Œå…§å®¹ $1 # ç¬¬1å€‹æ¬„ä½ $2 # ç¬¬2å€‹æ¬„ä½ $NF # æœ€å¾Œä¸€å€‹æ¬„ä½ $(NF-1) # å€’æ•¸ç¬¬2å€‹æ¬„ä½ # å¯¦éš›ç¯„ä¾‹ echo \u0026#34;apple banana cherry\u0026#34; | awk \u0026#39;{print $2}\u0026#39; # banana echo \u0026#34;1 2 3 4 5\u0026#34; | awk \u0026#39;{print $NF}\u0026#39; # 5 echo \u0026#34;a:b:c:d\u0026#34; | awk -F: \u0026#39;{print $3}\u0026#39; # c è‡ªè¨‚åˆ†éš”ç¬¦ 1 2 3 4 5 6 7 8 # ä½¿ç”¨ -F é¸é … awk -F: \u0026#39;{print $1, $3}\u0026#39; /etc/passwd # ä½¿ç”¨å†’è™Ÿä½œåˆ†éš”ç¬¦ awk -F\u0026#39;,\u0026#39; \u0026#39;{print $2}\u0026#39; data.csv # CSV æª”æ¡ˆè™•ç† awk -F\u0026#39;[,:]\u0026#39; \u0026#39;{print $1, $3}\u0026#39; file.txt # å¤šå€‹åˆ†éš”ç¬¦ # åœ¨ç¨‹å¼ä¸­è¨­å®š awk \u0026#39;BEGIN {FS=\u0026#34;,\u0026#34;} {print $1, $2}\u0026#39; data.csv # åœ¨ BEGIN ä¸­è¨­å®š awk \u0026#39;{FS=\u0026#34;,\u0026#34;} NR\u0026gt;1 {print $1, $2}\u0026#39; data.csv # å‹•æ…‹æ”¹è®Šåˆ†éš”ç¬¦ è¼¸å‡ºæ¬„ä½åˆ†éš”ç¬¦ 1 2 3 4 5 6 7 # è¨­å®šè¼¸å‡ºåˆ†éš”ç¬¦ awk \u0026#39;BEGIN {OFS=\u0026#34;\\t\u0026#34;} {print $1, $2, $3}\u0026#39; file.txt # ä½¿ç”¨ tab åˆ†éš”è¼¸å‡º awk \u0026#39;BEGIN {OFS=\u0026#34; | \u0026#34;} {print $1, $2}\u0026#39; file.txt # ä½¿ç”¨ \u0026#34; | \u0026#34; åˆ†éš” # é‡å»ºè¡Œ awk \u0026#39;{$1=$1; print}\u0026#39; file.txt # é‡æ–°æ ¼å¼åŒ–ç©ºç™½ awk \u0026#39;BEGIN {OFS=\u0026#34;,\u0026#34;} {$1=$1; print}\u0026#39; file.txt # è½‰æ›ç‚º CSV æ ¼å¼ å…§å»ºè®Šæ•¸ æ ¸å¿ƒå…§å»ºè®Šæ•¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # è¨˜éŒ„ç›¸é—œ NR # ç¸½è¨˜éŒ„æ•¸ï¼ˆè¡Œè™Ÿï¼‰ FNR # ç•¶å‰æª”æ¡ˆçš„è¨˜éŒ„æ•¸ NF # ç•¶å‰è¨˜éŒ„çš„æ¬„ä½æ•¸ # åˆ†éš”ç¬¦ç›¸é—œ FS # è¼¸å…¥æ¬„ä½åˆ†éš”ç¬¦ OFS # è¼¸å‡ºæ¬„ä½åˆ†éš”ç¬¦ RS # è¼¸å…¥è¨˜éŒ„åˆ†éš”ç¬¦ ORS # è¼¸å‡ºè¨˜éŒ„åˆ†éš”ç¬¦ # æª”æ¡ˆç›¸é—œ FILENAME # ç•¶å‰è™•ç†çš„æª”æ¡ˆå ARGC # å‘½ä»¤è¡Œåƒæ•¸å€‹æ•¸ ARGV # å‘½ä»¤è¡Œåƒæ•¸é™£åˆ— å¯¦ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # ä½¿ç”¨ NR æ·»åŠ è¡Œè™Ÿ awk \u0026#39;{print NR, $0}\u0026#39; file.txt # ä½¿ç”¨ NF æª¢æŸ¥æ¬„ä½æ•¸ awk \u0026#39;NF != 3 {print \u0026#34;Line \u0026#34; NR \u0026#34; has \u0026#34; NF \u0026#34; fields\u0026#34;}\u0026#39; file.txt # è™•ç†å¤šå€‹æª”æ¡ˆæ™‚ä½¿ç”¨ FNR awk \u0026#39;{print FILENAME, FNR, $0}\u0026#39; file1.txt file2.txt # ä½¿ç”¨ ARGC å’Œ ARGV awk \u0026#39;BEGIN { print \u0026#34;Total arguments:\u0026#34;, ARGC for (i=0; i\u0026lt;ARGC; i++) print \u0026#34;ARGV[\u0026#34; i \u0026#34;]:\u0026#34;, ARGV[i] }\u0026#39; file1 file2 ç‰¹æ®Šè®Šæ•¸ 1 2 3 4 5 6 7 8 9 10 11 # æ•¸å­—æ ¼å¼ OFMT # æ•¸å­—è¼¸å‡ºæ ¼å¼ï¼ˆé è¨­ \u0026#34;%.6g\u0026#34;ï¼‰ CONVFMT # å­—ä¸²è½‰æ›æ ¼å¼ # æ¨¡å¼åŒ¹é… RSTART # match() å‡½æ•¸åŒ¹é…çš„èµ·å§‹ä½ç½® RLENGTH # match() å‡½æ•¸åŒ¹é…çš„é•·åº¦ # å…¶ä»– SUBSEP # ä¸‹æ¨™åˆ†éš”ç¬¦ï¼ˆç”¨æ–¼å¤šç¶­é™£åˆ—ï¼‰ ENVIRON # ç’°å¢ƒè®Šæ•¸é™£åˆ— æ¨¡å¼åŒ¹é… åŸºæœ¬æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 # æ­£è¦è¡¨é”å¼æ¨¡å¼ awk \u0026#39;/pattern/ {print}\u0026#39; file.txt # åŒ¹é…åŒ…å« pattern çš„è¡Œ awk \u0026#39;/^[0-9]/ {print}\u0026#39; file.txt # åŒ¹é…ä»¥æ•¸å­—é–‹é ­çš„è¡Œ awk \u0026#39;/\\.txt$/ {print}\u0026#39; file.txt # åŒ¹é…ä»¥ .txt çµå°¾çš„è¡Œ # é—œä¿‚è¡¨é”å¼æ¨¡å¼ awk \u0026#39;$1 \u0026gt; 100 {print}\u0026#39; file.txt # ç¬¬1æ¬„ä½ \u0026gt; 100 awk \u0026#39;NF == 5 {print}\u0026#39; file.txt # æœ‰5å€‹æ¬„ä½çš„è¡Œ awk \u0026#39;length($0) \u0026gt; 80 {print}\u0026#39; file.txt # è¡Œé•·åº¦ \u0026gt; 80 # ç¯„åœæ¨¡å¼ awk \u0026#39;/start/,/end/ {print}\u0026#39; file.txt # å¾ start åˆ° end çš„è¡Œ awk \u0026#39;NR==5,NR==10 {print}\u0026#39; file.txt # ç¬¬5åˆ°10è¡Œ é€²éšæ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 # çµ„åˆæ¨¡å¼ awk \u0026#39;/error/ \u0026amp;\u0026amp; $3 \u0026gt; 100 {print}\u0026#39; file.txt # AND æ¢ä»¶ awk \u0026#39;/warn/ || /error/ {print}\u0026#39; file.txt # OR æ¢ä»¶ awk \u0026#39;!/debug/ {print}\u0026#39; file.txt # NOT æ¢ä»¶ # æ¬„ä½æ¨¡å¼åŒ¹é… awk \u0026#39;$2 ~ /pattern/ {print}\u0026#39; file.txt # ç¬¬2æ¬„ä½åŒ¹é… pattern awk \u0026#39;$1 !~ /^[0-9]/ {print}\u0026#39; file.txt # ç¬¬1æ¬„ä½ä¸ä»¥æ•¸å­—é–‹é ­ # è¤‡é›œæ¢ä»¶ awk \u0026#39;$1==\u0026#34;ERROR\u0026#34; \u0026amp;\u0026amp; $3\u0026gt;threshold {count++} END {print count}\u0026#39; file.txt å‹•ä½œå’Œæ§åˆ¶çµæ§‹ åŸºæœ¬å‹•ä½œ 1 2 3 4 5 6 7 8 # åˆ—å°å‹•ä½œ awk \u0026#39;{print}\u0026#39; file.txt # åˆ—å°æ•´è¡Œ awk \u0026#39;{print $1, $2}\u0026#39; file.txt # åˆ—å°ç‰¹å®šæ¬„ä½ awk \u0026#39;{printf \u0026#34;%s: %d\\n\u0026#34;, $1, $2}\u0026#39; file.txt # æ ¼å¼åŒ–åˆ—å° # è³¦å€¼å‹•ä½œ awk \u0026#39;{$1=\u0026#34;NEW\u0026#34;; print}\u0026#39; file.txt # ä¿®æ”¹æ¬„ä½å€¼ awk \u0026#39;{sum += $1} END {print sum}\u0026#39; file.txt # ç´¯åŠ è¨ˆç®— æ§åˆ¶çµæ§‹ if-else èªå¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # åŸºæœ¬ if èªå¥ awk \u0026#39;{ if ($1 \u0026gt; 100) print \u0026#34;Large:\u0026#34;, $0 else print \u0026#34;Small:\u0026#34;, $0 }\u0026#39; file.txt # å¤šé‡æ¢ä»¶ awk \u0026#39;{ if ($1 \u0026gt;= 90) grade = \u0026#34;A\u0026#34; else if ($1 \u0026gt;= 80) grade = \u0026#34;B\u0026#34; else if ($1 \u0026gt;= 70) grade = \u0026#34;C\u0026#34; else grade = \u0026#34;F\u0026#34; print $0, grade }\u0026#39; scores.txt è¿´åœˆçµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # for è¿´åœˆ awk \u0026#39;{ for (i=1; i\u0026lt;=NF; i++) { print \u0026#34;Field \u0026#34; i \u0026#34;:\u0026#34;, $i } }\u0026#39; file.txt # while è¿´åœˆ awk \u0026#39;{ i = 1 while (i \u0026lt;= NF) { print $i i++ } }\u0026#39; file.txt # for-in è¿´åœˆï¼ˆé™£åˆ—ï¼‰ awk \u0026#39;{ for (i in array) { print i, array[i] } }\u0026#39; file.txt å‡½æ•¸æ‡‰ç”¨ å­—ä¸²å‡½æ•¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # length() - å­—ä¸²é•·åº¦ awk \u0026#39;{print length($0)}\u0026#39; file.txt # æ¯è¡Œé•·åº¦ awk \u0026#39;length($0) \u0026gt; 80\u0026#39; file.txt # é•·åº¦è¶…é80çš„è¡Œ # substr() - å­å­—ä¸² awk \u0026#39;{print substr($1, 1, 3)}\u0026#39; file.txt # ç¬¬1æ¬„ä½å‰3å€‹å­—å…ƒ awk \u0026#39;{print substr($0, 5)}\u0026#39; file.txt # å¾ç¬¬5å€‹å­—å…ƒé–‹å§‹ # index() - æŸ¥æ‰¾ä½ç½® awk \u0026#39;{print index($0, \u0026#34;pattern\u0026#34;)}\u0026#39; file.txt # pattern çš„ä½ç½® # split() - åˆ†å‰²å­—ä¸² awk \u0026#39;{n=split($0, array, \u0026#34;,\u0026#34;); print n}\u0026#39; file.txt # ç”¨é€—è™Ÿåˆ†å‰² # gsub() å’Œ sub() - æ›¿æ› awk \u0026#39;{gsub(/old/, \u0026#34;new\u0026#34;); print}\u0026#39; file.txt # å…¨åŸŸæ›¿æ› awk \u0026#39;{sub(/old/, \u0026#34;new\u0026#34;); print}\u0026#39; file.txt # åªæ›¿æ›ç¬¬ä¸€å€‹ # tolower() å’Œ toupper() - å¤§å°å¯«è½‰æ› awk \u0026#39;{print tolower($0)}\u0026#39; file.txt # è½‰å°å¯« awk \u0026#39;{print toupper($1)}\u0026#39; file.txt # ç¬¬1æ¬„ä½è½‰å¤§å¯« æ•¸å­¸å‡½æ•¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # åŸºæœ¬æ•¸å­¸å‡½æ•¸ awk \u0026#39;{print sqrt($1)}\u0026#39; file.txt # å¹³æ–¹æ ¹ awk \u0026#39;{print int($1)}\u0026#39; file.txt # å–æ•´æ•¸ awk \u0026#39;{print sin($1), cos($1)}\u0026#39; file.txt # ä¸‰è§’å‡½æ•¸ # çµ±è¨ˆå‡½æ•¸ awk \u0026#39;{ sum += $1 count++ } END { print \u0026#34;Average:\u0026#34;, sum/count print \u0026#34;Total:\u0026#34;, sum }\u0026#39; file.txt # æœ€å¤§å€¼å’Œæœ€å°å€¼ awk \u0026#39;{ if (NR==1 || $1 \u0026gt; max) max = $1 if (NR==1 || $1 \u0026lt; min) min = $1 } END { print \u0026#34;Max:\u0026#34;, max, \u0026#34;Min:\u0026#34;, min }\u0026#39; file.txt è‡ªè¨‚å‡½æ•¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # å®šç¾©å‡½æ•¸ awk \u0026#39; function factorial(n) { if (n \u0026lt;= 1) return 1 return n * factorial(n-1) } { print $1, factorial($1) }\u0026#39; file.txt # å­—ä¸²è™•ç†å‡½æ•¸ awk \u0026#39; function trim(str) { gsub(/^[ \\t]+|[ \\t]+$/, \u0026#34;\u0026#34;, str) return str } { print trim($0) }\u0026#39; file.txt é™£åˆ—æ‡‰ç”¨ ä¸€ç¶­é™£åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # åŸºæœ¬é™£åˆ—æ“ä½œ awk \u0026#39;{ arr[NR] = $0 } END { for (i=1; i\u0026lt;=NR; i++) { print i, arr[i] } }\u0026#39; file.txt # é—œè¯é™£åˆ— awk \u0026#39;{ count[$1]++ } END { for (item in count) { print item, count[item] } }\u0026#39; file.txt # é™£åˆ—æ’åº awk \u0026#39;{ arr[NR] = $1 } END { n = asort(arr) # æ’åºå€¼ for (i=1; i\u0026lt;=n; i++) { print arr[i] } }\u0026#39; file.txt å¤šç¶­é™£åˆ— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # ä½¿ç”¨ SUBSEP åˆ†éš”å¤šç¶­ç´¢å¼• awk \u0026#39;BEGIN {SUBSEP = \u0026#34;:\u0026#34;} { matrix[$1,$2] = $3 } END { for (key in matrix) { print key, matrix[key] } }\u0026#39; file.txt # äºŒç¶­çµ±è¨ˆ awk \u0026#39;{ sales[$1][$2] += $3 } END { for (region in sales) { for (product in sales[region]) { print region, product, sales[region][product] } } }\u0026#39; sales_data.txt å¯¦æˆ°æ‡‰ç”¨å ´æ™¯ 1. æ—¥èªŒåˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 # å­˜å–æ—¥èªŒåˆ†æ awk \u0026#39;{ # çµ±è¨ˆç‹€æ…‹ç¢¼ status[$9]++ # çµ±è¨ˆ IP åœ°å€ ip[$1]++ # è¨ˆç®—ç¸½æµé‡ if ($10 != \u0026#34;-\u0026#34;) bytes += $10 } END { print \u0026#34;=== Status Code Statistics ===\u0026#34; for (code in status) { print code, status[code] } print \u0026#34;\\n=== Top 10 IP Addresses ===\u0026#34; PROCINFO[\u0026#34;sorted_in\u0026#34;] = \u0026#34;@val_num_desc\u0026#34; n = 0 for (addr in ip) { if (++n \u0026lt;= 10) print addr, ip[addr] } print \u0026#34;\\nTotal Bytes:\u0026#34;, bytes }\u0026#39; access.log # éŒ¯èª¤æ—¥èªŒç›£æ§ awk \u0026#39; BEGIN { print \u0026#34;Error Analysis Report\u0026#34; } /ERROR|FATAL/ { split($1, date, \u0026#34;-\u0026#34;) errors[date[1] \u0026#34;-\u0026#34; date[2]]++ error_details[NR] = $0 } END { print \u0026#34;Errors by Month:\u0026#34; for (month in errors) { print month, errors[month] } }\u0026#39; error.log 2. è³‡æ–™è™•ç†å’Œçµ±è¨ˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 # CSV è³‡æ–™åˆ†æ awk -F, \u0026#39; NR==1 { # è·³éæ¨™é¡Œè¡Œ next } { # éŠ·å”®è³‡æ–™çµ±è¨ˆ total_sales += $3 sales_by_region[$2] += $3 if ($3 \u0026gt; max_sale) { max_sale = $3 max_sale_record = $0 } } END { print \u0026#34;Total Sales: $\u0026#34; total_sales print \u0026#34;Average Sale: $\u0026#34; total_sales/(NR-1) print \u0026#34;Largest Sale: $\u0026#34; max_sale print \u0026#34;Record:\u0026#34;, max_sale_record print \u0026#34;\\nSales by Region:\u0026#34; for (region in sales_by_region) { print region \u0026#34;: $\u0026#34; sales_by_region[region] } }\u0026#39; sales.csv # æˆç¸¾çµ±è¨ˆ awk \u0026#39;{ # è¨ˆç®—æ¯å€‹å­¸ç”Ÿçš„å¹³å‡åˆ† sum = 0 for (i=2; i\u0026lt;=NF; i++) { sum += $i subject_total[i-1] += $i } avg = sum / (NF-1) print $1, avg if (avg \u0026gt;= 90) grade_count[\u0026#34;A\u0026#34;]++ else if (avg \u0026gt;= 80) grade_count[\u0026#34;B\u0026#34;]++ else if (avg \u0026gt;= 70) grade_count[\u0026#34;C\u0026#34;]++ else grade_count[\u0026#34;F\u0026#34;]++ student_count++ } END { print \u0026#34;\\nGrade Distribution:\u0026#34; for (grade in grade_count) { printf \u0026#34;%s: %d (%.1f%%)\\n\u0026#34;, grade, grade_count[grade], grade_count[grade]/student_count*100 } }\u0026#39; grades.txt 3. ç³»çµ±ç›£æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 # ç¨‹åºç›£æ§ ps aux | awk \u0026#39; NR\u0026gt;1 { # è·³éæ¨™é¡Œè¡Œ cpu[$11] += $3 # ä¾ç¨‹å¼åç¨±ç´¯åŠ  CPU ä½¿ç”¨ç‡ mem[$11] += $4 # ä¾ç¨‹å¼åç¨±ç´¯åŠ è¨˜æ†¶é«”ä½¿ç”¨ç‡ proc_count[$11]++ } END { print \u0026#34;Process Resource Usage:\u0026#34; printf \u0026#34;%-20s %s %s %s\\n\u0026#34;, \u0026#34;PROCESS\u0026#34;, \u0026#34;COUNT\u0026#34;, \u0026#34;CPU%\u0026#34;, \u0026#34;MEM%\u0026#34; for (proc in cpu) { printf \u0026#34;%-20s %5d %6.1f %6.1f\\n\u0026#34;, proc, proc_count[proc], cpu[proc], mem[proc] } }\u0026#39; # ç£ç¢Ÿä½¿ç”¨åˆ†æ df -h | awk \u0026#39; NR\u0026gt;1 { # è§£æä½¿ç”¨ç™¾åˆ†æ¯” gsub(/%/, \u0026#34;\u0026#34;, $5) usage = $5 if (usage \u0026gt;= 90) { critical[++crit_count] = $6 \u0026#34; (\u0026#34; usage \u0026#34;%)\u0026#34; } else if (usage \u0026gt;= 80) { warning[++warn_count] = $6 \u0026#34; (\u0026#34; usage \u0026#34;%)\u0026#34; } } END { if (crit_count \u0026gt; 0) { print \u0026#34;CRITICAL: High disk usage detected!\u0026#34; for (i=1; i\u0026lt;=crit_count; i++) { print \u0026#34; \u0026#34; critical[i] } } if (warn_count \u0026gt; 0) { print \u0026#34;WARNING: Moderate disk usage:\u0026#34; for (i=1; i\u0026lt;=warn_count; i++) { print \u0026#34; \u0026#34; warning[i] } } }\u0026#39; 4. æ–‡ä»¶æ ¼å¼è½‰æ› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 # JSON ç°¡å–®ç”Ÿæˆ awk -F, \u0026#39; BEGIN { print \u0026#34;{\u0026#34; } NR\u0026gt;1 { printf \u0026#34; \\\u0026#34;%s\\\u0026#34;: {\\n\u0026#34;, $1 printf \u0026#34; \\\u0026#34;name\\\u0026#34;: \\\u0026#34;%s\\\u0026#34;,\\n\u0026#34;, $2 printf \u0026#34; \\\u0026#34;age\\\u0026#34;: %d,\\n\u0026#34;, $3 printf \u0026#34; \\\u0026#34;city\\\u0026#34;: \\\u0026#34;%s\\\u0026#34;\\n\u0026#34;, $4 printf \u0026#34; }%s\\n\u0026#34;, (NR\u0026lt;total_lines ? \u0026#34;,\u0026#34; : \u0026#34;\u0026#34;) } END { print \u0026#34;}\u0026#34; }\u0026#39; data.csv # HTML è¡¨æ ¼ç”Ÿæˆ awk -F, \u0026#39; BEGIN { print \u0026#34;\u0026lt;table border=\\\u0026#34;1\\\u0026#34;\u0026gt;\u0026#34; } NR==1 { print \u0026#34;\u0026lt;tr\u0026gt;\u0026#34; for (i=1; i\u0026lt;=NF; i++) { print \u0026#34;\u0026lt;th\u0026gt;\u0026#34; $i \u0026#34;\u0026lt;/th\u0026gt;\u0026#34; } print \u0026#34;\u0026lt;/tr\u0026gt;\u0026#34; } NR\u0026gt;1 { print \u0026#34;\u0026lt;tr\u0026gt;\u0026#34; for (i=1; i\u0026lt;=NF; i++) { print \u0026#34;\u0026lt;td\u0026gt;\u0026#34; $i \u0026#34;\u0026lt;/td\u0026gt;\u0026#34; } print \u0026#34;\u0026lt;/tr\u0026gt;\u0026#34; } END { print \u0026#34;\u0026lt;/table\u0026gt;\u0026#34; }\u0026#39; data.csv # é…ç½®æª”è½‰æ› awk \u0026#39; /^[^#]/ \u0026amp;\u0026amp; /=/ { split($0, pair, \u0026#34;=\u0026#34;) key = pair[1] value = pair[2] gsub(/^[ \\t]+|[ \\t]+$/, \u0026#34;\u0026#34;, key) # trim gsub(/^[ \\t]+|[ \\t]+$/, \u0026#34;\u0026#34;, value) print key \u0026#34;: \\\u0026#34;\u0026#34; value \u0026#34;\\\u0026#34;\u0026#34; }\u0026#39; config.ini 5. å ±è¡¨ç”Ÿæˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 # éŠ·å”®å ±è¡¨ awk -F, \u0026#39; BEGIN { print \u0026#34;Sales Report\u0026#34; print \u0026#34;============\u0026#34; total = 0 } NR\u0026gt;1 { date = $1 product = $2 amount = $3 # æŒ‰æ—¥æœŸçµ±è¨ˆ daily_sales[date] += amount # æŒ‰ç”¢å“çµ±è¨ˆ product_sales[product] += amount total += amount } END { print \u0026#34;\\nDaily Sales:\u0026#34; PROCINFO[\u0026#34;sorted_in\u0026#34;] = \u0026#34;@ind_str_asc\u0026#34; for (date in daily_sales) { printf \u0026#34;%-12s: $%8.2f\\n\u0026#34;, date, daily_sales[date] } print \u0026#34;\\nProduct Sales:\u0026#34; PROCINFO[\u0026#34;sorted_in\u0026#34;] = \u0026#34;@val_num_desc\u0026#34; for (product in product_sales) { printf \u0026#34;%-15s: $%8.2f (%4.1f%%)\\n\u0026#34;, product, product_sales[product], product_sales[product]/total*100 } printf \u0026#34;\\nTotal Sales: $%.2f\\n\u0026#34;, total }\u0026#39; sales.csv # ç¶²ç«™æµé‡å ±è¡¨ awk \u0026#39;{ # è§£ææ—¥æœŸæ™‚é–“ gsub(/\\[|\\]/, \u0026#34;\u0026#34;, $4) split($4, datetime, \u0026#34;:\u0026#34;) date = datetime[1] hour = datetime[2] # çµ±è¨ˆ daily_hits[date]++ hourly_hits[hour]++ if ($9 == \u0026#34;404\u0026#34;) not_found++ if ($9 ~ /^[45]/) errors++ total_hits++ } END { print \u0026#34;Website Traffic Report\u0026#34; print \u0026#34;=====================\u0026#34; print \u0026#34;\\nDaily Traffic:\u0026#34; for (date in daily_hits) { printf \u0026#34;%s: %d hits\\n\u0026#34;, date, daily_hits[date] } print \u0026#34;\\nHourly Distribution:\u0026#34; for (h=0; h\u0026lt;24; h++) { printf \u0026#34;%02d:00: %d hits\\n\u0026#34;, h, hourly_hits[h] } printf \u0026#34;\\nError Summary:\\n\u0026#34; printf \u0026#34;404 Errors: %d (%.1f%%)\\n\u0026#34;, not_found, not_found/total_hits*100 printf \u0026#34;5xx Errors: %d (%.1f%%)\\n\u0026#34;, errors, errors/total_hits*100 }\u0026#39; access.log é€²éšæŠ€å·§ 1. å¤šæª”æ¡ˆè™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # æ¯”è¼ƒå…©å€‹æª”æ¡ˆ awk \u0026#39; FNR==NR { # è™•ç†ç¬¬ä¸€å€‹æª”æ¡ˆ file1[FNR] = $0 next } { # è™•ç†ç¬¬äºŒå€‹æª”æ¡ˆ if (file1[FNR] != $0) { print \u0026#34;Line \u0026#34; FNR \u0026#34; differs:\u0026#34; print \u0026#34;File1: \u0026#34; file1[FNR] print \u0026#34;File2: \u0026#34; $0 } }\u0026#39; file1.txt file2.txt # åˆä½µæª”æ¡ˆè³‡æ–™ awk \u0026#39; FNR==NR { # ç¬¬ä¸€å€‹æª”æ¡ˆï¼šå»ºç«‹ç´¢å¼• lookup[$1] = $2 next } { # ç¬¬äºŒå€‹æª”æ¡ˆï¼šæŸ¥æ‰¾ä¸¦åˆä½µ if ($1 in lookup) { print $0, lookup[$1] } }\u0026#39; lookup.txt data.txt 2. è¤‡é›œæ–‡æœ¬è§£æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # XML ç°¡å–®è§£æ awk \u0026#39; /\u0026lt;([^\u0026gt;]+)\u0026gt;([^\u0026lt;]*)\u0026lt;\\/\\1\u0026gt;/ { match($0, /\u0026lt;([^\u0026gt;]+)\u0026gt;([^\u0026lt;]*)\u0026lt;\\/\\1\u0026gt;/, arr) print \u0026#34;Tag:\u0026#34;, arr[1], \u0026#34;Content:\u0026#34;, arr[2] }\u0026#39; simple.xml # é…ç½®æª”è§£æ awk \u0026#39; /^\\[.*\\]$/ { # å€æ®µæ¨™é¡Œ gsub(/\\[|\\]/, \u0026#34;\u0026#34;) section = $0 next } /^[^#].*=/ { # éµå€¼å° split($0, kv, \u0026#34;=\u0026#34;) key = kv[1] value = kv[2] gsub(/^[ \\t]+|[ \\t]+$/, \u0026#34;\u0026#34;, key) gsub(/^[ \\t]+|[ \\t]+$/, \u0026#34;\u0026#34;, value) config[section][key] = value } END { for (sect in config) { print \u0026#34;[\u0026#34; sect \u0026#34;]\u0026#34; for (k in config[sect]) { print k \u0026#34; = \u0026#34; config[sect][k] } print \u0026#34;\u0026#34; } }\u0026#39; config.ini 3. æ•ˆèƒ½å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # é¿å…é‡è¤‡è¨ˆç®— awk \u0026#39;{ # å¥½çš„åšæ³•ï¼šå„²å­˜è¨ˆç®—çµæœ len = length($0) if (len \u0026gt; max_len) { max_len = len longest_line = $0 } }\u0026#39; file.txt # ä½¿ç”¨é™£åˆ—è€Œéå­—ä¸²é€£æ¥ awk \u0026#39;{ # å¥½çš„åšæ³•ï¼šä½¿ç”¨é™£åˆ— lines[NR] = $0 } END { for (i=NR; i\u0026gt;=1; i--) { print lines[i] } }\u0026#39; file.txt # ææ—©é€€å‡º awk \u0026#39;{ if (found_count \u0026gt;= 10) exit if (/pattern/) { print found_count++ } }\u0026#39; large_file.txt è…³æœ¬æª”æ¡ˆ å»ºç«‹ script.awk æª”æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 #!/usr/bin/awk -f BEGIN { FS = \u0026#34;,\u0026#34; OFS = \u0026#34;\\t\u0026#34; print \u0026#34;Processing CSV file...\u0026#34; } # è·³éç©ºè¡Œ /^$/ { next } # è™•ç†æ¨™é¡Œè¡Œ NR == 1 { print \u0026#34;Headers:\u0026#34;, $0 next } # ä¸»è¦è™•ç†é‚è¼¯ { # è³‡æ–™é©—è­‰ if (NF != 4) { print \u0026#34;Warning: Line \u0026#34; NR \u0026#34; has \u0026#34; NF \u0026#34; fields\u0026#34; \u0026gt; \u0026#34;/dev/stderr\u0026#34; next } # è™•ç†è³‡æ–™ name = $1 age = $2 salary = $3 department = $4 # çµ±è¨ˆ total_salary += salary dept_count[department]++ employee_count++ # è¼¸å‡ºè™•ç†çµæœ print name, age, salary, department } END { print \u0026#34;\\n=== Summary ===\u0026#34; print \u0026#34;Total employees:\u0026#34;, employee_count print \u0026#34;Average salary:\u0026#34;, total_salary/employee_count print \u0026#34;\\nDepartment distribution:\u0026#34; for (dept in dept_count) { printf \u0026#34;%-15s: %d\\n\u0026#34;, dept, dept_count[dept] } } ä½¿ç”¨è…³æœ¬ï¼š\n1 2 3 4 chmod +x script.awk ./script.awk data.csv # æˆ– awk -f script.awk data.csv å¸¸è¦‹éŒ¯èª¤èˆ‡é™¤éŒ¯ 1. å¸¸è¦‹éŒ¯èª¤ 1 2 3 4 5 6 7 8 9 10 # éŒ¯èª¤ï¼šå­—ä¸²æ¯”è¼ƒä½¿ç”¨æ•¸å€¼é‹ç®—å­ awk \u0026#39;$1 \u0026gt; \u0026#34;50\u0026#34;\u0026#39; file.txt # éŒ¯èª¤ï¼šå­—ä¸²æ¯”è¼ƒ awk \u0026#39;$1 + 0 \u0026gt; 50\u0026#39; file.txt # æ­£ç¢ºï¼šå¼·åˆ¶æ•¸å€¼æ¯”è¼ƒ # éŒ¯èª¤ï¼šé™£åˆ—ç´¢å¼•å•é¡Œ awk \u0026#39;{arr[0] = $1}\u0026#39; file.txt # æ³¨æ„ï¼šAWK é™£åˆ—å¾1é–‹å§‹ç¿’æ…£ä½¿ç”¨ # éŒ¯èª¤ï¼šæœªåˆå§‹åŒ–è®Šæ•¸ awk \u0026#39;{sum += $1} END {print sum/count}\u0026#39; file.txt # count æœªåˆå§‹åŒ– awk \u0026#39;{sum += $1; count++} END {print sum/count}\u0026#39; file.txt # æ­£ç¢º 2. é™¤éŒ¯æŠ€å·§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # æ·»åŠ é™¤éŒ¯è¼¸å‡º awk \u0026#39;{ print \u0026#34;Debug: NR=\u0026#34; NR \u0026#34;, NF=\u0026#34; NF \u0026#34;, $0=\u0026#34; $0 \u0026gt; \u0026#34;/dev/stderr\u0026#34; # ä¸»è¦é‚è¼¯ }\u0026#39; file.txt # ä½¿ç”¨æ¢ä»¶é™¤éŒ¯ awk \u0026#39;{ if (debug) print \u0026#34;Processing:\u0026#34;, $0 # ä¸»è¦é‚è¼¯ }\u0026#39; debug=1 file.txt # åˆ†æ­¥é©—è­‰ awk \u0026#39;{print \u0026#34;Line \u0026#34; NR \u0026#34;: \u0026#34; $1}\u0026#39; file.txt | head -5 èˆ‡å…¶ä»–å·¥å…·æ•´åˆ 1. èˆ‡ grep å’Œ sed çµ„åˆ 1 2 3 4 5 # éæ¿¾å¾Œè™•ç† grep \u0026#34;ERROR\u0026#34; log.txt | awk \u0026#39;{print $1, $3}\u0026#39; # å¤šæ­¥è™•ç† cat data.txt | grep -v \u0026#34;^#\u0026#34; | sed \u0026#39;s/,/ /g\u0026#39; | awk \u0026#39;{print $1, $2}\u0026#39; 2. èˆ‡ sort çµ„åˆ 1 2 3 4 5 # æ’åºå¾Œçµ±è¨ˆ awk \u0026#39;{print $1}\u0026#39; file.txt | sort | uniq -c | awk \u0026#39;{print $2, $1}\u0026#39; # ç®¡é“è™•ç† awk \u0026#39;{print $3, $0}\u0026#39; file.txt | sort -nr | awk \u0026#39;{$1=\u0026#34;\u0026#34;; print}\u0026#39; 3. èˆ‡è³‡æ–™åº«æ•´åˆ 1 2 3 4 5 6 7 8 9 10 11 # ç”Ÿæˆ SQL æ’å…¥èªå¥ awk -F, \u0026#39; NR\u0026gt;1 { printf \u0026#34;INSERT INTO users (name, age, city) VALUES (\\\u0026#34;%s\\\u0026#34;, %d, \\\u0026#34;%s\\\u0026#34;);\\n\u0026#34;, $1, $2, $3 }\u0026#39; data.csv # ç”Ÿæˆæ‰¹æ¬¡æ›´æ–°è…³æœ¬ awk \u0026#39;{ print \u0026#34;UPDATE table SET status=1 WHERE id=\u0026#34; $1 \u0026#34;;\u0026#34; }\u0026#39; ids.txt ç¸½çµ æ ¸å¿ƒå„ªå‹¢ å¼·å¤§çš„æ¨¡å¼åŒ¹é…ï¼šæ”¯æ´è¤‡é›œçš„æ­£è¦è¡¨é”å¼ è±å¯Œçš„å…§å»ºåŠŸèƒ½ï¼šå­—ä¸²è™•ç†ã€æ•¸å­¸é‹ç®—ã€é™£åˆ—æ“ä½œ é«˜æ•ˆçš„æ–‡æœ¬è™•ç†ï¼šé©åˆå¤§é‡è³‡æ–™è™•ç† éˆæ´»çš„ç¨‹å¼çµæ§‹ï¼šæ”¯æ´å®Œæ•´çš„ç¨‹å¼è¨­è¨ˆæ¦‚å¿µ æœ€ä½³å¯¦è¸ å–„ç”¨ BEGIN å’Œ ENDï¼šåˆå§‹åŒ–å’Œæ¸…ç†å·¥ä½œ åˆç†ä½¿ç”¨é™£åˆ—ï¼šé¿å…è¨˜æ†¶é«”éåº¦ä½¿ç”¨ æ¨¡å¼åŒ–ç¨‹å¼è¨­è¨ˆï¼šå°‡å¸¸ç”¨é‚è¼¯å°è£ç‚ºå‡½æ•¸ è¼¸å…¥é©—è­‰ï¼šæª¢æŸ¥è³‡æ–™æ ¼å¼å’Œæ¬„ä½æ•¸é‡ éŒ¯èª¤è™•ç†ï¼šé©ç•¶çš„éŒ¯èª¤æª¢æŸ¥å’Œæ¢å¾©æ©Ÿåˆ¶ å­¸ç¿’è·¯å¾‘ 1 2 3 4 5 6 7 8 9 10 11 12 # åŸºç¤éšæ®µ awk \u0026#39;{print $1}\u0026#39; file.txt # æ¬„ä½è™•ç† awk \u0026#39;/pattern/ {print}\u0026#39; file.txt # æ¨¡å¼åŒ¹é… awk \u0026#39;{sum += $1} END {print sum}\u0026#39; file.txt # åŸºæœ¬çµ±è¨ˆ # é€²éšéšæ®µ awk -F, \u0026#39;{arr[$1] += $2} END {for(i in arr) print i, arr[i]}\u0026#39; file.csv # é™£åˆ—æ‡‰ç”¨ awk \u0026#39;function f(x) {return x*x} {print f($1)}\u0026#39; file.txt # è‡ªè¨‚å‡½æ•¸ # å°ˆå®¶éšæ®µ awk \u0026#39;/start/,/end/ {if(/important/) print}\u0026#39; file.txt # è¤‡é›œæ¨¡å¼ awk \u0026#39;BEGIN{PROCINFO[\u0026#34;sorted_in\u0026#34;]=\u0026#34;@val_num_desc\u0026#34;} ...\u0026#39; # é«˜ç´šç‰¹æ€§ AWK æ˜¯æ–‡æœ¬è™•ç†å’Œè³‡æ–™åˆ†æçš„å¼·å¤§å·¥å…·ï¼ŒæŒæ¡å…¶æ ¸å¿ƒæ¦‚å¿µå’Œå¸¸ç”¨æŠ€å·§ï¼Œèƒ½å¤ å¤§å¹…æå‡è³‡æ–™è™•ç†çš„æ•ˆç‡å’Œæº–ç¢ºæ€§ã€‚è¨˜ä½ï¼šAWK çš„æ ¸å¿ƒåœ¨æ–¼æ¨¡å¼-å‹•ä½œç¨‹å¼è¨­è¨ˆæ€ç¶­ï¼Œå–„ç”¨é€™å€‹ç‰¹æ€§èƒ½å¤ è§£æ±ºè¤‡é›œçš„æ–‡æœ¬è™•ç†å•é¡Œã€‚\nåƒè€ƒè³‡æ–™ GAWK Manual The AWK Programming Language Advanced Bash-Scripting Guide POSIX AWK Specification ","permalink":"https://xinqilin.github.io/post/tools/awk/","tags":["Linux","AWK","Text Processing","Data Analysis","Pattern Scanning","Shell","Unix"],"title":"AWK ç¨‹å¼è¨­è¨ˆå®Œæ•´æŒ‡å—ï¼šLinux æ–‡æœ¬è™•ç†èˆ‡è³‡æ–™åˆ†æåˆ©å™¨"},{"content":"æ¦‚è¿° Java 8 å¼•å…¥äº†å¤šå€‹å¼·å¤§çš„ Map è¨ˆç®—æ–¹æ³•ï¼Œé€™äº›æ–¹æ³•æä¾›äº†åŸå­æ€§çš„è®€å–-è¨ˆç®—-å¯«å…¥æ“ä½œï¼Œä¸åƒ…ç°¡åŒ–äº†ç¨‹å¼ç¢¼ï¼Œä¹Ÿæé«˜äº†åŸ·è¡Œæ•ˆç‡å’ŒåŸ·è¡Œç·’å®‰å…¨æ€§ã€‚æœ¬æ–‡å°‡æ·±å…¥æ¢è¨é€™äº›æ–¹æ³•çš„ä½¿ç”¨å ´æ™¯ã€æ•ˆèƒ½ç‰¹æ€§å’Œæœ€ä½³å¯¦è¸ã€‚\næ ¸å¿ƒè¨ˆç®—æ–¹æ³• putIfAbsentï¼šæ¢ä»¶å¼æ’å…¥ï¼Œåƒ…åœ¨ Key ä¸å­˜åœ¨æ™‚æ’å…¥å€¼ computeï¼šåŸºæ–¼ Key å’Œç¾æœ‰ Value è¨ˆç®—æ–°å€¼ computeIfAbsentï¼šKey ä¸å­˜åœ¨æ™‚åŸ·è¡Œè¨ˆç®—ä¸¦æ’å…¥ computeIfPresentï¼šKey å­˜åœ¨æ™‚åŸ·è¡Œè¨ˆç®—ä¸¦æ›´æ–° mergeï¼šåˆä½µç¾æœ‰å€¼èˆ‡æ–°å€¼ å„ªå‹¢èˆ‡ç‰¹é» åŸå­æ€§æ“ä½œï¼šé¿å… Check-Then-Act ç«¶æ…‹æ¢ä»¶ æ•ˆèƒ½å„ªåŒ–ï¼šæ¸›å°‘é‡è¤‡çš„æŸ¥æ‰¾æ“ä½œ ç°¡æ½”èªæ³•ï¼šä½¿ç”¨ Lambda è¡¨é”å¼ç°¡åŒ–ç¨‹å¼ç¢¼ åŸ·è¡Œç·’å®‰å…¨ï¼šèˆ‡ ConcurrentHashMap çµåˆæä¾›åŸ·è¡Œç·’å®‰å…¨ åŸºç¤ä½¿ç”¨ç¯„ä¾‹ 1. ç’°å¢ƒè¨­å®šèˆ‡åˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package com.example.mapcompute; import java.util.*; import java.util.concurrent.ConcurrentHashMap; import java.util.concurrent.ThreadLocalRandom; import java.util.function.Function; import java.util.stream.Collectors; import java.util.stream.IntStream; public class MapComputeExample { public static void main(String[] args) { // åˆå§‹åŒ–æ¸¬è©¦è³‡æ–™ Map\u0026lt;String, Integer\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;apple\u0026#34;, 5); map.put(\u0026#34;banana\u0026#34;, 10); map.put(\u0026#34;cherry\u0026#34;, 3); System.out.println(\u0026#34;åˆå§‹ Map: \u0026#34; + map); demonstratePutIfAbsent(new HashMap\u0026lt;\u0026gt;(map)); demonstrateCompute(new HashMap\u0026lt;\u0026gt;(map)); demonstrateComputeIfAbsent(new HashMap\u0026lt;\u0026gt;(map)); demonstrateComputeIfPresent(new HashMap\u0026lt;\u0026gt;(map)); demonstrateMerge(new HashMap\u0026lt;\u0026gt;(map)); } } æ–¹æ³•ä¸€ï¼šputIfAbsent 1. åŸºç¤ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 /** * putIfAbsent: åƒ…åœ¨ Key ä¸å­˜åœ¨æ™‚æ’å…¥å€¼ * è¿”å›å€¼ï¼šKey å­˜åœ¨æ™‚è¿”å›ç¾æœ‰å€¼ï¼Œä¸å­˜åœ¨æ™‚è¿”å› nullï¼ˆæ’å…¥å¾Œï¼‰ */ public static void demonstratePutIfAbsent(Map\u0026lt;String, Integer\u0026gt; map) { System.out.println(\u0026#34;\\n=== putIfAbsent ç¤ºç¯„ ===\u0026#34;); // Case 1: Key å·²å­˜åœ¨ - ä¸æ’å…¥ï¼Œè¿”å›ç¾æœ‰å€¼ Integer result1 = map.putIfAbsent(\u0026#34;apple\u0026#34;, 99); System.out.println(\u0026#34;putIfAbsent(\u0026#39;apple\u0026#39;, 99) è¿”å›: \u0026#34; + result1); // 5 System.out.println(\u0026#34;map å…§å®¹: \u0026#34; + map); // apple ä»ç‚º 5 // Case 2: Key ä¸å­˜åœ¨ - æ’å…¥æ–°å€¼ï¼Œè¿”å› null Integer result2 = map.putIfAbsent(\u0026#34;orange\u0026#34;, 8); System.out.println(\u0026#34;putIfAbsent(\u0026#39;orange\u0026#39;, 8) è¿”å›: \u0026#34; + result2); // null System.out.println(\u0026#34;map å…§å®¹: \u0026#34; + map); // æ–°å¢äº† orange=8 // Case 3: Value ç‚º null çš„æƒ…æ³ map.put(\u0026#34;grape\u0026#34;, null); Integer result3 = map.putIfAbsent(\u0026#34;grape\u0026#34;, 15); System.out.println(\u0026#34;putIfAbsent(\u0026#39;grape\u0026#39;, 15) è¿”å›: \u0026#34; + result3); // null System.out.println(\u0026#34;map å…§å®¹: \u0026#34; + map); // grape è¢«è¨­ç‚º 15 } 2. å¯¦éš›æ‡‰ç”¨ï¼šå¿«å–åˆå§‹åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 /** * å¿«å–åˆå§‹åŒ–æ¨¡å¼ï¼šç¢ºä¿æ¯å€‹ Key åªåˆå§‹åŒ–ä¸€æ¬¡ */ public class CacheInitializationExample { private final Map\u0026lt;String, ExpensiveObject\u0026gt; cache = new ConcurrentHashMap\u0026lt;\u0026gt;(); /** * ä½¿ç”¨ putIfAbsent å¯¦ç¾åŸ·è¡Œç·’å®‰å…¨çš„å¿«å–åˆå§‹åŒ– */ public ExpensiveObject getOrCreateObject(String key) { ExpensiveObject existing = cache.get(key); if (existing != null) { return existing; } // å‰µå»ºæ˜‚è²´å°è±¡ ExpensiveObject newObject = new ExpensiveObject(key); // åŸå­æ€§æ’å…¥ï¼Œé¿å…é‡è¤‡å‰µå»º ExpensiveObject result = cache.putIfAbsent(key, newObject); return result != null ? result : newObject; } /** * æ›´ç°¡æ½”çš„å¯«æ³•ï¼ˆä½†å¯èƒ½å‰µå»ºå¤šé¤˜ç‰©ä»¶ï¼‰ */ public ExpensiveObject getOrCreateObjectSimple(String key) { return cache.putIfAbsent(key, new ExpensiveObject(key)); } public static class ExpensiveObject { private final String id; private final long creationTime; public ExpensiveObject(String id) { this.id = id; this.creationTime = System.currentTimeMillis(); // æ¨¡æ“¬æ˜‚è²´çš„åˆå§‹åŒ–éç¨‹ try { Thread.sleep(10); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } } @Override public String toString() { return String.format(\u0026#34;ExpensiveObject{id=\u0026#39;%s\u0026#39;, created=%d}\u0026#34;, id, creationTime); } } } æ–¹æ³•äºŒï¼šcompute 1. åŸºç¤ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 /** * compute: ç„¡æ¢ä»¶åŸ·è¡Œè¨ˆç®—ï¼Œå¯è™•ç† Key å­˜åœ¨æˆ–ä¸å­˜åœ¨çš„æƒ…æ³ * è¨ˆç®—å‡½æ•¸æ¥æ”¶ (key, value) åƒæ•¸ï¼Œvalue å¯èƒ½ç‚º null */ public static void demonstrateCompute(Map\u0026lt;String, Integer\u0026gt; map) { System.out.println(\u0026#34;\\n=== compute ç¤ºç¯„ ===\u0026#34;); // Case 1: Key å­˜åœ¨ - åŸºæ–¼ç¾æœ‰å€¼è¨ˆç®— Integer result1 = map.compute(\u0026#34;apple\u0026#34;, (key, value) -\u0026gt; value + 10); System.out.println(\u0026#34;compute(\u0026#39;apple\u0026#39;, v -\u0026gt; v + 10) è¿”å›: \u0026#34; + result1); // 15 System.out.println(\u0026#34;map å…§å®¹: \u0026#34; + map); // Case 2: Key ä¸å­˜åœ¨ - value ç‚º null Integer result2 = map.compute(\u0026#34;orange\u0026#34;, (key, value) -\u0026gt; { System.out.println(\u0026#34;è¨ˆç®— \u0026#34; + key + \u0026#34;, ç•¶å‰å€¼: \u0026#34; + value); return value == null ? 1 : value + 1; }); System.out.println(\u0026#34;compute(\u0026#39;orange\u0026#39;, ...) è¿”å›: \u0026#34; + result2); // 1 // Case 3: è¨ˆç®—çµæœç‚º null - ç§»é™¤è©² Key Integer result3 = map.compute(\u0026#34;cherry\u0026#34;, (key, value) -\u0026gt; { return value \u0026lt; 5 ? null : value; // cherry=3 \u0026lt; 5ï¼Œè¿”å› null }); System.out.println(\u0026#34;compute(\u0026#39;cherry\u0026#39;, ...) è¿”å›: \u0026#34; + result3); // null System.out.println(\u0026#34;map å…§å®¹: \u0026#34; + map); // cherry è¢«ç§»é™¤ } 2. è¤‡é›œè¨ˆç®—ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 /** * è¤‡é›œè¨ˆç®—æ‡‰ç”¨ï¼šçµ±è¨ˆå’Œèšåˆæ“ä½œ */ public class ComputeAdvancedExample { /** * å¯¦ç¾è¨ˆæ•¸å™¨åŠŸèƒ½ */ public static Map\u0026lt;String, Integer\u0026gt; updateCounters(Map\u0026lt;String, Integer\u0026gt; counters, List\u0026lt;String\u0026gt; events) { for (String event : events) { counters.compute(event, (key, count) -\u0026gt; count == null ? 1 : count + 1); } return counters; } /** * å¯¦ç¾ç´¯åŠ å™¨åŠŸèƒ½ */ public static Map\u0026lt;String, Double\u0026gt; updateAccumulators(Map\u0026lt;String, Double\u0026gt; accumulators, Map\u0026lt;String, Double\u0026gt; newValues) { for (Map.Entry\u0026lt;String, Double\u0026gt; entry : newValues.entrySet()) { accumulators.compute(entry.getKey(), (key, current) -\u0026gt; { double newValue = entry.getValue(); return current == null ? newValue : current + newValue; }); } return accumulators; } /** * æ¢ä»¶å¼æ›´æ–°ï¼šåŸºæ–¼è¤‡é›œé‚è¼¯çš„å€¼è¨ˆç®— */ public static Map\u0026lt;String, String\u0026gt; updateStatus(Map\u0026lt;String, String\u0026gt; statusMap, String key, String newStatus) { return Map.of(key, statusMap.compute(key, (k, currentStatus) -\u0026gt; { if (currentStatus == null) { return newStatus; } // ç‹€æ…‹è½‰æ›é‚è¼¯ switch (currentStatus) { case \u0026#34;PENDING\u0026#34;: return List.of(\u0026#34;PROCESSING\u0026#34;, \u0026#34;CANCELLED\u0026#34;).contains(newStatus) ? newStatus : currentStatus; case \u0026#34;PROCESSING\u0026#34;: return List.of(\u0026#34;COMPLETED\u0026#34;, \u0026#34;FAILED\u0026#34;).contains(newStatus) ? newStatus : currentStatus; default: return currentStatus; // ä¸å…è¨±å¾çµ‚æ…‹è½‰æ› } })); } public static void main(String[] args) { // æ¸¬è©¦è¨ˆæ•¸å™¨ Map\u0026lt;String, Integer\u0026gt; counters = new HashMap\u0026lt;\u0026gt;(); List\u0026lt;String\u0026gt; events = Arrays.asList(\u0026#34;login\u0026#34;, \u0026#34;logout\u0026#34;, \u0026#34;login\u0026#34;, \u0026#34;error\u0026#34;, \u0026#34;login\u0026#34;); updateCounters(counters, events); System.out.println(\u0026#34;äº‹ä»¶è¨ˆæ•¸: \u0026#34; + counters); // æ¸¬è©¦ç´¯åŠ å™¨ Map\u0026lt;String, Double\u0026gt; accumulators = new HashMap\u0026lt;\u0026gt;(); Map\u0026lt;String, Double\u0026gt; newValues = Map.of(\u0026#34;sales\u0026#34;, 100.5, \u0026#34;costs\u0026#34;, 75.2); updateAccumulators(accumulators, newValues); System.out.println(\u0026#34;ç´¯åŠ çµæœ: \u0026#34; + accumulators); } } æ–¹æ³•ä¸‰ï¼šcomputeIfAbsent 1. åŸºç¤ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 /** * computeIfAbsent: åƒ…åœ¨ Key ä¸å­˜åœ¨æ™‚åŸ·è¡Œè¨ˆç®— * æ˜¯ putIfAbsent çš„è¨ˆç®—ç‰ˆæœ¬ï¼Œæ”¯æ´ Lambda è¡¨é”å¼ */ public static void demonstrateComputeIfAbsent(Map\u0026lt;String, Integer\u0026gt; map) { System.out.println(\u0026#34;\\n=== computeIfAbsent ç¤ºç¯„ ===\u0026#34;); // Case 1: Key å­˜åœ¨ - ä¸åŸ·è¡Œè¨ˆç®—ï¼Œè¿”å›ç¾æœ‰å€¼ Integer result1 = map.computeIfAbsent(\u0026#34;apple\u0026#34;, key -\u0026gt; { System.out.println(\u0026#34;ç‚º \u0026#34; + key + \u0026#34; åŸ·è¡Œè¨ˆç®—\u0026#34;); // ä¸æœƒåˆ—å° return 999; }); System.out.println(\u0026#34;computeIfAbsent(\u0026#39;apple\u0026#39;, ...) è¿”å›: \u0026#34; + result1); // 5 // Case 2: Key ä¸å­˜åœ¨ - åŸ·è¡Œè¨ˆç®—ä¸¦æ’å…¥ Integer result2 = map.computeIfAbsent(\u0026#34;orange\u0026#34;, key -\u0026gt; { System.out.println(\u0026#34;ç‚º \u0026#34; + key + \u0026#34; åŸ·è¡Œè¨ˆç®—\u0026#34;); // æœƒåˆ—å° return key.length() * 10; // åŸºæ–¼ key è¨ˆç®—å€¼ }); System.out.println(\u0026#34;computeIfAbsent(\u0026#39;orange\u0026#39;, ...) è¿”å›: \u0026#34; + result2); // 60 // Case 3: è¨ˆç®—çµæœç‚º null - ä¸æ’å…¥ Integer result3 = map.computeIfAbsent(\u0026#34;grape\u0026#34;, key -\u0026gt; null); System.out.println(\u0026#34;computeIfAbsent(\u0026#39;grape\u0026#39;, -\u0026gt; null) è¿”å›: \u0026#34; + result3); // null System.out.println(\u0026#34;map å…§å®¹: \u0026#34; + map); // grape ä¸æœƒè¢«æ’å…¥ } 2. å¯¦éš›æ‡‰ç”¨ï¼šå»¶é²åˆå§‹åŒ–é›†åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 /** * å»¶é²åˆå§‹åŒ–æ‡‰ç”¨ï¼šå‹•æ…‹å‰µå»ºé›†åˆå’Œè¤‡é›œå°è±¡ */ public class LazyInitializationExample { private final Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; groupMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final Map\u0026lt;String, Set\u0026lt;Integer\u0026gt;\u0026gt; categoryMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final Map\u0026lt;String, Map\u0026lt;String, Object\u0026gt;\u0026gt; configMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); /** * å»¶é²åˆå§‹åŒ– List é›†åˆ */ public void addToGroup(String groupName, String item) { groupMap.computeIfAbsent(groupName, k -\u0026gt; new ArrayList\u0026lt;\u0026gt;()).add(item); } /** * å»¶é²åˆå§‹åŒ– Set é›†åˆ */ public void addToCategory(String category, Integer value) { categoryMap.computeIfAbsent(category, k -\u0026gt; new HashSet\u0026lt;\u0026gt;()).add(value); } /** * å»¶é²åˆå§‹åŒ–å·¢ç‹€ Map */ public void setConfig(String module, String key, Object value) { configMap.computeIfAbsent(module, k -\u0026gt; new ConcurrentHashMap\u0026lt;\u0026gt;()).put(key, value); } /** * è¤‡é›œå°è±¡çš„å»¶é²åˆå§‹åŒ– */ private final Map\u0026lt;String, DatabaseConnection\u0026gt; connectionPool = new ConcurrentHashMap\u0026lt;\u0026gt;(); public DatabaseConnection getConnection(String database) { return connectionPool.computeIfAbsent(database, dbName -\u0026gt; { System.out.println(\u0026#34;å‰µå»ºæ–°çš„è³‡æ–™åº«é€£æ¥: \u0026#34; + dbName); return new DatabaseConnection(dbName); }); } /** * åŸºæ–¼å¤–éƒ¨è³‡æºçš„å»¶é²è¼‰å…¥ */ private final Map\u0026lt;String, UserProfile\u0026gt; userCache = new ConcurrentHashMap\u0026lt;\u0026gt;(); public UserProfile getUserProfile(String userId) { return userCache.computeIfAbsent(userId, id -\u0026gt; { // æ¨¡æ“¬å¾è³‡æ–™åº«è¼‰å…¥ç”¨æˆ¶è³‡æ–™ System.out.println(\u0026#34;å¾è³‡æ–™åº«è¼‰å…¥ç”¨æˆ¶: \u0026#34; + id); return loadUserFromDatabase(id); }); } // è¼”åŠ©é¡åˆ¥å’Œæ–¹æ³• public static class DatabaseConnection { private final String database; private final long createdAt; public DatabaseConnection(String database) { this.database = database; this.createdAt = System.currentTimeMillis(); } @Override public String toString() { return String.format(\u0026#34;Connection{db=\u0026#39;%s\u0026#39;, created=%d}\u0026#34;, database, createdAt); } } public static class UserProfile { private final String userId; private final String name; public UserProfile(String userId, String name) { this.userId = userId; this.name = name; } @Override public String toString() { return String.format(\u0026#34;UserProfile{id=\u0026#39;%s\u0026#39;, name=\u0026#39;%s\u0026#39;}\u0026#34;, userId, name); } } private UserProfile loadUserFromDatabase(String userId) { // æ¨¡æ“¬è³‡æ–™åº«æŸ¥è©¢å»¶é² try { Thread.sleep(50); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } return new UserProfile(userId, \u0026#34;User-\u0026#34; + userId); } public static void main(String[] args) { LazyInitializationExample example = new LazyInitializationExample(); // æ¸¬è©¦ç¾¤çµ„ç®¡ç† example.addToGroup(\u0026#34;admins\u0026#34;, \u0026#34;alice\u0026#34;); example.addToGroup(\u0026#34;admins\u0026#34;, \u0026#34;bob\u0026#34;); example.addToGroup(\u0026#34;users\u0026#34;, \u0026#34;charlie\u0026#34;); System.out.println(\u0026#34;ç¾¤çµ„: \u0026#34; + example.groupMap); // æ¸¬è©¦é€£æ¥æ±  DatabaseConnection conn1 = example.getConnection(\u0026#34;user_db\u0026#34;); DatabaseConnection conn2 = example.getConnection(\u0026#34;user_db\u0026#34;); // åŒä¸€å€‹å¯¦ä¾‹ System.out.println(\u0026#34;é€£æ¥1: \u0026#34; + conn1); System.out.println(\u0026#34;é€£æ¥2: \u0026#34; + conn2); System.out.println(\u0026#34;æ˜¯å¦ç‚ºåŒä¸€å€‹é€£æ¥: \u0026#34; + (conn1 == conn2)); } } æ–¹æ³•å››ï¼šcomputeIfPresent 1. åŸºç¤ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 /** * computeIfPresent: åƒ…åœ¨ Key å­˜åœ¨ä¸”å€¼ä¸ç‚º null æ™‚åŸ·è¡Œè¨ˆç®— */ public static void demonstrateComputeIfPresent(Map\u0026lt;String, Integer\u0026gt; map) { System.out.println(\u0026#34;\\n=== computeIfPresent ç¤ºç¯„ ===\u0026#34;); // Case 1: Key å­˜åœ¨ä¸”å€¼ä¸ç‚º null - åŸ·è¡Œè¨ˆç®— Integer result1 = map.computeIfPresent(\u0026#34;apple\u0026#34;, (key, value) -\u0026gt; { System.out.println(\u0026#34;ç‚º \u0026#34; + key + \u0026#34; åŸ·è¡Œè¨ˆç®—ï¼Œç•¶å‰å€¼: \u0026#34; + value); return value * 2; }); System.out.println(\u0026#34;computeIfPresent(\u0026#39;apple\u0026#39;, v -\u0026gt; v * 2) è¿”å›: \u0026#34; + result1); // 10 // Case 2: Key ä¸å­˜åœ¨ - ä¸åŸ·è¡Œè¨ˆç®— Integer result2 = map.computeIfPresent(\u0026#34;orange\u0026#34;, (key, value) -\u0026gt; { System.out.println(\u0026#34;é€™è¡Œä¸æœƒåŸ·è¡Œ\u0026#34;); return 999; }); System.out.println(\u0026#34;computeIfPresent(\u0026#39;orange\u0026#39;, ...) è¿”å›: \u0026#34; + result2); // null // Case 3: Key å­˜åœ¨ä½†å€¼ç‚º null - ä¸åŸ·è¡Œè¨ˆç®— map.put(\u0026#34;grape\u0026#34;, null); Integer result3 = map.computeIfPresent(\u0026#34;grape\u0026#34;, (key, value) -\u0026gt; { System.out.println(\u0026#34;é€™è¡Œä¹Ÿä¸æœƒåŸ·è¡Œ\u0026#34;); return 123; }); System.out.println(\u0026#34;computeIfPresent(\u0026#39;grape\u0026#39;, ...) è¿”å›: \u0026#34; + result3); // null // Case 4: è¨ˆç®—çµæœç‚º null - ç§»é™¤è©² Key Integer result4 = map.computeIfPresent(\u0026#34;banana\u0026#34;, (key, value) -\u0026gt; { return value \u0026gt; 15 ? null : value + 5; // banana=10 \u0026lt;= 15ï¼Œè¿”å› 15 }); System.out.println(\u0026#34;computeIfPresent(\u0026#39;banana\u0026#39;, ...) è¿”å›: \u0026#34; + result4); // 15 System.out.println(\u0026#34;map å…§å®¹: \u0026#34; + map); } 2. å¯¦éš›æ‡‰ç”¨ï¼šæ¢ä»¶å¼æ›´æ–° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 /** * æ¢ä»¶å¼æ›´æ–°æ‡‰ç”¨ï¼šåŸºæ–¼ç¾æœ‰å€¼çš„æ™ºèƒ½æ›´æ–° */ public class ConditionalUpdateExample { /** * åˆ†æ•¸ç³»çµ±ï¼šåªæ›´æ–°æœ‰æ•ˆåˆ†æ•¸ */ public static Map\u0026lt;String, Integer\u0026gt; updateScores(Map\u0026lt;String, Integer\u0026gt; scores, Map\u0026lt;String, Integer\u0026gt; scoreChanges) { for (Map.Entry\u0026lt;String, Integer\u0026gt; change : scoreChanges.entrySet()) { scores.computeIfPresent(change.getKey(), (player, currentScore) -\u0026gt; { int newScore = currentScore + change.getValue(); // åˆ†æ•¸ä¸èƒ½ä½æ–¼ 0 return Math.max(0, newScore); }); } return scores; } /** * åº«å­˜ç®¡ç†ï¼šåªæ¸›å°‘ç¾æœ‰åº«å­˜ */ public static Map\u0026lt;String, Integer\u0026gt; reduceInventory(Map\u0026lt;String, Integer\u0026gt; inventory, Map\u0026lt;String, Integer\u0026gt; orders) { Map\u0026lt;String, Integer\u0026gt; processed = new HashMap\u0026lt;\u0026gt;(); for (Map.Entry\u0026lt;String, Integer\u0026gt; order : orders.entrySet()) { Integer newStock = inventory.computeIfPresent(order.getKey(), (item, stock) -\u0026gt; { int orderQuantity = order.getValue(); if (stock \u0026gt;= orderQuantity) { return stock - orderQuantity; } else { // åº«å­˜ä¸è¶³ï¼Œä¸è™•ç†è¨‚å–® return stock; } }); if (newStock != null) { int originalStock = newStock + order.getValue(); if (originalStock \u0026gt;= order.getValue()) { processed.put(order.getKey(), order.getValue()); } } } return processed; } /** * éæœŸè³‡æ–™æ¸…ç†ï¼šåŸºæ–¼æ™‚é–“æˆ³çš„æ¢ä»¶æ›´æ–° */ public static class TimestampCache { private final Map\u0026lt;String, Long\u0026gt; timestampMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final long TTL_MILLIS = 300_000; // 5 åˆ†é˜ public void touch(String key) { timestampMap.put(key, System.currentTimeMillis()); } public boolean isValid(String key) { return timestampMap.computeIfPresent(key, (k, timestamp) -\u0026gt; { long now = System.currentTimeMillis(); if (now - timestamp \u0026gt; TTL_MILLIS) { return null; // éæœŸï¼Œç§»é™¤ } return timestamp; // ä»æœ‰æ•ˆ }) != null; } public int cleanupExpired() { int removed = 0; long now = System.currentTimeMillis(); Iterator\u0026lt;Map.Entry\u0026lt;String, Long\u0026gt;\u0026gt; iterator = timestampMap.entrySet().iterator(); while (iterator.hasNext()) { Map.Entry\u0026lt;String, Long\u0026gt; entry = iterator.next(); if (now - entry.getValue() \u0026gt; TTL_MILLIS) { iterator.remove(); removed++; } } return removed; } } public static void main(String[] args) { // æ¸¬è©¦åˆ†æ•¸æ›´æ–° Map\u0026lt;String, Integer\u0026gt; scores = new HashMap\u0026lt;\u0026gt;(); scores.put(\u0026#34;Alice\u0026#34;, 100); scores.put(\u0026#34;Bob\u0026#34;, 150); Map\u0026lt;String, Integer\u0026gt; changes = new HashMap\u0026lt;\u0026gt;(); changes.put(\u0026#34;Alice\u0026#34;, 50); // æœ‰æ•ˆç©å®¶ changes.put(\u0026#34;Charlie\u0026#34;, 25); // ä¸å­˜åœ¨çš„ç©å®¶ changes.put(\u0026#34;Bob\u0026#34;, -200); // æœƒè§¸ç™¼æœ€å°å€¼é™åˆ¶ updateScores(scores, changes); System.out.println(\u0026#34;æ›´æ–°å¾Œåˆ†æ•¸: \u0026#34; + scores); // æ¸¬è©¦æ™‚é–“æˆ³å¿«å– TimestampCache cache = new TimestampCache(); cache.touch(\u0026#34;session1\u0026#34;); System.out.println(\u0026#34;session1 æ˜¯å¦æœ‰æ•ˆ: \u0026#34; + cache.isValid(\u0026#34;session1\u0026#34;)); try { Thread.sleep(100); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } System.out.println(\u0026#34;session1 æ˜¯å¦ä»æœ‰æ•ˆ: \u0026#34; + cache.isValid(\u0026#34;session1\u0026#34;)); } } æ–¹æ³•äº”ï¼šmerge 1. åŸºç¤ç”¨æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /** * merge: åˆä½µç¾æœ‰å€¼èˆ‡æ–°å€¼ * å¦‚æœ Key ä¸å­˜åœ¨æˆ–å€¼ç‚º nullï¼Œç›´æ¥ä½¿ç”¨æ–°å€¼ * å¦‚æœ Key å­˜åœ¨ä¸”å€¼ä¸ç‚º nullï¼Œä½¿ç”¨åˆä½µå‡½æ•¸è¨ˆç®—çµæœ */ public static void demonstrateMerge(Map\u0026lt;String, Integer\u0026gt; map) { System.out.println(\u0026#34;\\n=== merge ç¤ºç¯„ ===\u0026#34;); // Case 1: Key å­˜åœ¨ - åŸ·è¡Œåˆä½µæ“ä½œ Integer result1 = map.merge(\u0026#34;apple\u0026#34;, 20, (oldValue, newValue) -\u0026gt; { System.out.println(\u0026#34;åˆä½µ apple: \u0026#34; + oldValue + \u0026#34; + \u0026#34; + newValue); return oldValue + newValue; }); System.out.println(\u0026#34;merge(\u0026#39;apple\u0026#39;, 20, sum) è¿”å›: \u0026#34; + result1); // 25 // Case 2: Key ä¸å­˜åœ¨ - ç›´æ¥ä½¿ç”¨æ–°å€¼ Integer result2 = map.merge(\u0026#34;orange\u0026#34;, 15, (oldValue, newValue) -\u0026gt; { System.out.println(\u0026#34;é€™è¡Œä¸æœƒåŸ·è¡Œï¼Œå› ç‚º orange ä¸å­˜åœ¨\u0026#34;); return oldValue + newValue; }); System.out.println(\u0026#34;merge(\u0026#39;orange\u0026#39;, 15, sum) è¿”å›: \u0026#34; + result2); // 15 // Case 3: åˆä½µçµæœç‚º null - ç§»é™¤è©² Key Integer result3 = map.merge(\u0026#34;banana\u0026#34;, 5, (oldValue, newValue) -\u0026gt; { return oldValue == newValue ? null : oldValue + newValue; }); System.out.println(\u0026#34;merge(\u0026#39;banana\u0026#39;, 5, ...) è¿”å›: \u0026#34; + result3); // nullï¼ˆbanana=10 != 5ï¼‰ System.out.println(\u0026#34;map å…§å®¹: \u0026#34; + map); // Case 4: å€¼ç‚º null çš„æƒ…æ³ map.put(\u0026#34;grape\u0026#34;, null); Integer result4 = map.merge(\u0026#34;grape\u0026#34;, 30, Integer::sum); System.out.println(\u0026#34;merge(\u0026#39;grape\u0026#39;, 30, sum) è¿”å›: \u0026#34; + result4); // 30 } 2. é«˜ç´šåˆä½µæ‡‰ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 /** * é«˜ç´šåˆä½µæ‡‰ç”¨ï¼šè³‡æ–™èšåˆå’Œçµ±è¨ˆåˆ†æ */ public class AdvancedMergeExample { /** * çµ±è¨ˆè³‡æ–™åˆä½µï¼šç´¯åŠ è¨ˆæ•¸å™¨ */ public static Map\u0026lt;String, Integer\u0026gt; mergeCounters(List\u0026lt;Map\u0026lt;String, Integer\u0026gt;\u0026gt; counterMaps) { Map\u0026lt;String, Integer\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); for (Map\u0026lt;String, Integer\u0026gt; counterMap : counterMaps) { for (Map.Entry\u0026lt;String, Integer\u0026gt; entry : counterMap.entrySet()) { result.merge(entry.getKey(), entry.getValue(), Integer::sum); } } return result; } /** * å­—ä¸²åˆä½µï¼šæ‹¼æ¥æ–‡å­— */ public static Map\u0026lt;String, String\u0026gt; mergeMessages(Map\u0026lt;String, String\u0026gt; base, Map\u0026lt;String, String\u0026gt; additional) { Map\u0026lt;String, String\u0026gt; result = new HashMap\u0026lt;\u0026gt;(base); for (Map.Entry\u0026lt;String, String\u0026gt; entry : additional.entrySet()) { result.merge(entry.getKey(), entry.getValue(), (old, new_) -\u0026gt; old + \u0026#34;; \u0026#34; + new_); } return result; } /** * è¤‡é›œå°è±¡åˆä½µï¼šéŠ·å”®è³‡æ–™èšåˆ */ public static class SalesData { private double revenue; private int quantity; public SalesData(double revenue, int quantity) { this.revenue = revenue; this.quantity = quantity; } public SalesData merge(SalesData other) { return new SalesData(this.revenue + other.revenue, this.quantity + other.quantity); } public double getAveragePrice() { return quantity \u0026gt; 0 ? revenue / quantity : 0; } @Override public String toString() { return String.format(\u0026#34;SalesData{revenue=%.2f, quantity=%d, avgPrice=%.2f}\u0026#34;, revenue, quantity, getAveragePrice()); } // getter å’Œ setter public double getRevenue() { return revenue; } public int getQuantity() { return quantity; } } public static Map\u0026lt;String, SalesData\u0026gt; mergeSalesData(List\u0026lt;Map\u0026lt;String, SalesData\u0026gt;\u0026gt; salesMaps) { Map\u0026lt;String, SalesData\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); for (Map\u0026lt;String, SalesData\u0026gt; salesMap : salesMaps) { for (Map.Entry\u0026lt;String, SalesData\u0026gt; entry : salesMap.entrySet()) { result.merge(entry.getKey(), entry.getValue(), SalesData::merge); } } return result; } /** * é›†åˆåˆä½µï¼šSet å’Œ List çš„åˆä½µæ“ä½œ */ public static Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; mergeSets(Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; map1, Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; map2) { Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); // è¤‡è£½ç¬¬ä¸€å€‹ map for (Map.Entry\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; entry : map1.entrySet()) { result.put(entry.getKey(), new HashSet\u0026lt;\u0026gt;(entry.getValue())); } // åˆä½µç¬¬äºŒå€‹ map for (Map.Entry\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; entry : map2.entrySet()) { result.merge(entry.getKey(), entry.getValue(), (set1, set2) -\u0026gt; { Set\u0026lt;String\u0026gt; merged = new HashSet\u0026lt;\u0026gt;(set1); merged.addAll(set2); return merged; }); } return result; } public static void main(String[] args) { // æ¸¬è©¦è¨ˆæ•¸å™¨åˆä½µ List\u0026lt;Map\u0026lt;String, Integer\u0026gt;\u0026gt; counters = Arrays.asList( Map.of(\u0026#34;A\u0026#34;, 10, \u0026#34;B\u0026#34;, 20), Map.of(\u0026#34;A\u0026#34;, 5, \u0026#34;C\u0026#34;, 15), Map.of(\u0026#34;B\u0026#34;, 8, \u0026#34;C\u0026#34;, 12) ); Map\u0026lt;String, Integer\u0026gt; mergedCounters = mergeCounters(counters); System.out.println(\u0026#34;åˆä½µå¾Œè¨ˆæ•¸å™¨: \u0026#34; + mergedCounters); // æ¸¬è©¦éŠ·å”®è³‡æ–™åˆä½µ List\u0026lt;Map\u0026lt;String, SalesData\u0026gt;\u0026gt; salesList = Arrays.asList( Map.of(\u0026#34;Product1\u0026#34;, new SalesData(1000.0, 10)), Map.of(\u0026#34;Product1\u0026#34;, new SalesData(500.0, 5), \u0026#34;Product2\u0026#34;, new SalesData(800.0, 8)) ); Map\u0026lt;String, SalesData\u0026gt; mergedSales = mergeSalesData(salesList); System.out.println(\u0026#34;åˆä½µå¾ŒéŠ·å”®è³‡æ–™:\u0026#34;); mergedSales.forEach((product, data) -\u0026gt; System.out.println(\u0026#34; \u0026#34; + product + \u0026#34;: \u0026#34; + data)); } } åŸ·è¡Œç·’å®‰å…¨èˆ‡ ConcurrentHashMap 1. åŸå­æ“ä½œçš„é‡è¦æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 /** * åŸ·è¡Œç·’å®‰å…¨çš„è¨ˆç®—æ“ä½œ */ public class ThreadSafeComputeExample { private final ConcurrentHashMap\u0026lt;String, Integer\u0026gt; concurrentCounters = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final Map\u0026lt;String, Integer\u0026gt; unsafeCounters = new HashMap\u0026lt;\u0026gt;(); /** * åŸ·è¡Œç·’å®‰å…¨çš„è¨ˆæ•¸å™¨å¢é‡ */ public void incrementCounterSafe(String key) { concurrentCounters.compute(key, (k, v) -\u0026gt; v == null ? 1 : v + 1); } /** * éåŸ·è¡Œç·’å®‰å…¨çš„è¨ˆæ•¸å™¨å¢é‡ï¼ˆå¯èƒ½å°è‡´è³‡æ–™ç«¶çˆ­ï¼‰ */ public synchronized void incrementCounterUnsafe(String key) { Integer current = unsafeCounters.get(key); unsafeCounters.put(key, current == null ? 1 : current + 1); } /** * ä¸¦ç™¼æ¸¬è©¦ */ public static void testConcurrency() throws InterruptedException { ThreadSafeComputeExample example = new ThreadSafeComputeExample(); int threadCount = 10; int incrementsPerThread = 1000; String testKey = \u0026#34;counter\u0026#34;; // æ¸¬è©¦åŸ·è¡Œç·’å®‰å…¨ç‰ˆæœ¬ Thread[] safeThreads = new Thread[threadCount]; for (int i = 0; i \u0026lt; threadCount; i++) { safeThreads[i] = new Thread(() -\u0026gt; { for (int j = 0; j \u0026lt; incrementsPerThread; j++) { example.incrementCounterSafe(testKey); } }); } long startTime = System.currentTimeMillis(); for (Thread thread : safeThreads) { thread.start(); } for (Thread thread : safeThreads) { thread.join(); } long safeTime = System.currentTimeMillis() - startTime; Integer safeResult = example.concurrentCounters.get(testKey); System.out.printf(\u0026#34;åŸ·è¡Œç·’å®‰å…¨ç‰ˆæœ¬: æœŸæœ›=%d, å¯¦éš›=%d, è€—æ™‚=%dms\\n\u0026#34;, threadCount * incrementsPerThread, safeResult, safeTime); // æ¸¬è©¦éåŸ·è¡Œç·’å®‰å…¨ç‰ˆæœ¬ Thread[] unsafeThreads = new Thread[threadCount]; for (int i = 0; i \u0026lt; threadCount; i++) { unsafeThreads[i] = new Thread(() -\u0026gt; { for (int j = 0; j \u0026lt; incrementsPerThread; j++) { example.incrementCounterUnsafe(testKey); } }); } startTime = System.currentTimeMillis(); for (Thread thread : unsafeThreads) { thread.start(); } for (Thread thread : unsafeThreads) { thread.join(); } long unsafeTime = System.currentTimeMillis() - startTime; Integer unsafeResult = example.unsafeCounters.get(testKey); System.out.printf(\u0026#34;éåŸ·è¡Œç·’å®‰å…¨ç‰ˆæœ¬: æœŸæœ›=%d, å¯¦éš›=%d, è€—æ™‚=%dms\\n\u0026#34;, threadCount * incrementsPerThread, unsafeResult, unsafeTime); } public static void main(String[] args) throws InterruptedException { testConcurrency(); } } 2. é«˜æ•ˆèƒ½ä¸¦ç™¼æ‡‰ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 /** * é«˜æ•ˆèƒ½ä¸¦ç™¼çµ±è¨ˆç³»çµ± */ public class HighPerformanceStats { private final ConcurrentHashMap\u0026lt;String, Long\u0026gt; metrics = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final ConcurrentHashMap\u0026lt;String, Double\u0026gt; averages = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final ConcurrentHashMap\u0026lt;String, Integer\u0026gt; counts = new ConcurrentHashMap\u0026lt;\u0026gt;(); /** * è¨˜éŒ„æŒ‡æ¨™å€¼ä¸¦æ›´æ–°å¹³å‡å€¼ */ public void recordMetric(String metricName, double value) { // åŸå­æ€§æ›´æ–°è¨ˆæ•¸ counts.compute(metricName, (k, v) -\u0026gt; v == null ? 1 : v + 1); // åŸå­æ€§æ›´æ–°å¹³å‡å€¼ averages.compute(metricName, (k, currentAvg) -\u0026gt; { if (currentAvg == null) { return value; } int count = counts.get(metricName); return ((currentAvg * (count - 1)) + value) / count; }); } /** * æ‰¹é‡æ›´æ–°æŒ‡æ¨™ */ public void recordBatch(Map\u0026lt;String, Double\u0026gt; batchMetrics) { batchMetrics.forEach(this::recordMetric); } /** * ç²å–çµ±è¨ˆæ‘˜è¦ */ public Map\u0026lt;String, String\u0026gt; getStatsSummary() { Map\u0026lt;String, String\u0026gt; summary = new HashMap\u0026lt;\u0026gt;(); averages.forEach((metric, avg) -\u0026gt; { int count = counts.getOrDefault(metric, 0); summary.put(metric, String.format(\u0026#34;avg=%.2f, count=%d\u0026#34;, avg, count)); }); return summary; } /** * é‡ç½®ç‰¹å®šæŒ‡æ¨™ */ public void resetMetric(String metricName) { averages.remove(metricName); counts.remove(metricName); } /** * æ¢ä»¶å¼é‡ç½®ï¼šåƒ…é‡ç½®ä½æ´»èºåº¦æŒ‡æ¨™ */ public int cleanupLowActivityMetrics(int minCount) { int removed = 0; for (String metric : new HashSet\u0026lt;\u0026gt;(counts.keySet())) { Integer count = counts.computeIfPresent(metric, (k, v) -\u0026gt; v \u0026gt;= minCount ? v : null); if (count == null) { averages.remove(metric); removed++; } } return removed; } } æ•ˆèƒ½åˆ†æèˆ‡å„ªåŒ– 1. æ•ˆèƒ½æ¯”è¼ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 /** * Map è¨ˆç®—æ–¹æ³•çš„æ•ˆèƒ½æ¯”è¼ƒ */ public class PerformanceComparison { private static final int OPERATIONS = 1_000_000; private static final String[] KEYS = IntStream.range(0, 1000) .mapToObj(i -\u0026gt; \u0026#34;key\u0026#34; + i) .toArray(String[]::new); /** * å‚³çµ±æ–¹å¼ï¼šæª¢æŸ¥-è¨ˆç®—-æ›´æ–° */ public static long testTraditionalApproach() { Map\u0026lt;String, Integer\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); Random random = new Random(42); long startTime = System.nanoTime(); for (int i = 0; i \u0026lt; OPERATIONS; i++) { String key = KEYS[random.nextInt(KEYS.length)]; Integer current = map.get(key); if (current == null) { map.put(key, 1); } else { map.put(key, current + 1); } } return System.nanoTime() - startTime; } /** * ä½¿ç”¨ compute æ–¹æ³• */ public static long testComputeApproach() { Map\u0026lt;String, Integer\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); Random random = new Random(42); long startTime = System.nanoTime(); for (int i = 0; i \u0026lt; OPERATIONS; i++) { String key = KEYS[random.nextInt(KEYS.length)]; map.compute(key, (k, v) -\u0026gt; v == null ? 1 : v + 1); } return System.nanoTime() - startTime; } /** * ä½¿ç”¨ merge æ–¹æ³• */ public static long testMergeApproach() { Map\u0026lt;String, Integer\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); Random random = new Random(42); long startTime = System.nanoTime(); for (int i = 0; i \u0026lt; OPERATIONS; i++) { String key = KEYS[random.nextInt(KEYS.length)]; map.merge(key, 1, Integer::sum); } return System.nanoTime() - startTime; } /** * ä½¿ç”¨ computeIfAbsent + computeIfPresent çµ„åˆ */ public static long testComputeIfApproach() { Map\u0026lt;String, Integer\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); Random random = new Random(42); long startTime = System.nanoTime(); for (int i = 0; i \u0026lt; OPERATIONS; i++) { String key = KEYS[random.nextInt(KEYS.length)]; if (map.computeIfAbsent(key, k -\u0026gt; 0) != null) { map.computeIfPresent(key, (k, v) -\u0026gt; v + 1); } } return System.nanoTime() - startTime; } public static void main(String[] args) { System.out.println(\u0026#34;Map è¨ˆç®—æ–¹æ³•æ•ˆèƒ½æ¯”è¼ƒ (\u0026#34; + OPERATIONS + \u0026#34; æ“ä½œ)\u0026#34;); System.out.println(\u0026#34;================================================\u0026#34;); // é ç†± JVM for (int i = 0; i \u0026lt; 5; i++) { testTraditionalApproach(); testComputeApproach(); testMergeApproach(); testComputeIfApproach(); } // æ­£å¼æ¸¬è©¦ long traditional = testTraditionalApproach(); long compute = testComputeApproach(); long merge = testMergeApproach(); long computeIf = testComputeIfApproach(); System.out.printf(\u0026#34;å‚³çµ±æ–¹å¼: %8.2f ms\\n\u0026#34;, traditional / 1_000_000.0); System.out.printf(\u0026#34;compute æ–¹æ³•: %8.2f ms\\n\u0026#34;, compute / 1_000_000.0); System.out.printf(\u0026#34;merge æ–¹æ³•: %8.2f ms\\n\u0026#34;, merge / 1_000_000.0); System.out.printf(\u0026#34;computeIf çµ„åˆ: %8.2f ms\\n\u0026#34;, computeIf / 1_000_000.0); System.out.println(\u0026#34;\\nç›¸å°æ•ˆèƒ½ (ä»¥å‚³çµ±æ–¹å¼ç‚ºåŸºæº–):\u0026#34;); System.out.printf(\u0026#34;compute æ–¹æ³•: %.2fx\\n\u0026#34;, (double) traditional / compute); System.out.printf(\u0026#34;merge æ–¹æ³•: %.2fx\\n\u0026#34;, (double) traditional / merge); System.out.printf(\u0026#34;computeIf çµ„åˆ: %.2fx\\n\u0026#34;, (double) traditional / computeIf); } } 2. è¨˜æ†¶é«”ä½¿ç”¨åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 /** * è¨˜æ†¶é«”ä½¿ç”¨åˆ†æå·¥å…· */ public class MemoryAnalysis { /** * åˆ†æä¸åŒå¯¦ä½œæ–¹å¼çš„è¨˜æ†¶é«”ä½¿ç”¨ */ public static void analyzeMemoryUsage() { Runtime runtime = Runtime.getRuntime(); // æ¸¬è©¦è³‡æ–™å¤§å° int dataSize = 100_000; System.out.println(\u0026#34;è¨˜æ†¶é«”ä½¿ç”¨åˆ†æ (è³‡æ–™å¤§å°: \u0026#34; + dataSize + \u0026#34;)\u0026#34;); System.out.println(\u0026#34;=========================================\u0026#34;); // æ¸¬è©¦ HashMap + compute System.gc(); long beforeHashMap = runtime.totalMemory() - runtime.freeMemory(); Map\u0026lt;String, Integer\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; dataSize; i++) { hashMap.compute(\u0026#34;key\u0026#34; + (i % 1000), (k, v) -\u0026gt; v == null ? 1 : v + 1); } long afterHashMap = runtime.totalMemory() - runtime.freeMemory(); long hashMapMemory = afterHashMap - beforeHashMap; // æ¸¬è©¦ ConcurrentHashMap + compute System.gc(); long beforeConcurrent = runtime.totalMemory() - runtime.freeMemory(); ConcurrentHashMap\u0026lt;String, Integer\u0026gt; concurrentMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; dataSize; i++) { concurrentMap.compute(\u0026#34;key\u0026#34; + (i % 1000), (k, v) -\u0026gt; v == null ? 1 : v + 1); } long afterConcurrent = runtime.totalMemory() - runtime.freeMemory(); long concurrentMemory = afterConcurrent - beforeConcurrent; System.out.printf(\u0026#34;HashMap è¨˜æ†¶é«”ä½¿ç”¨: %.2f MB\\n\u0026#34;, hashMapMemory / (1024.0 * 1024.0)); System.out.printf(\u0026#34;ConcurrentHashMap è¨˜æ†¶é«”ä½¿ç”¨: %.2f MB\\n\u0026#34;, concurrentMemory / (1024.0 * 1024.0)); System.out.printf(\u0026#34;è¨˜æ†¶é«”ä½¿ç”¨æ¯”ä¾‹: %.2fx\\n\u0026#34;, (double) concurrentMemory / hashMapMemory); // ä¿æŒå¼•ç”¨é¿å…è¢«åƒåœ¾å›æ”¶ System.out.println(\u0026#34;HashMap å¤§å°: \u0026#34; + hashMap.size()); System.out.println(\u0026#34;ConcurrentHashMap å¤§å°: \u0026#34; + concurrentMap.size()); } public static void main(String[] args) { analyzeMemoryUsage(); } } å¯¦éš›æ‡‰ç”¨æ¡ˆä¾‹ 1. ç¶²ç«™è¨ªå•çµ±è¨ˆç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 /** * ç¶²ç«™è¨ªå•çµ±è¨ˆç³»çµ± */ public class WebTrafficAnalyzer { private final ConcurrentHashMap\u0026lt;String, Long\u0026gt; pageViews = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final ConcurrentHashMap\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; uniqueVisitors = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final ConcurrentHashMap\u0026lt;String, Long\u0026gt; totalBandwidth = new ConcurrentHashMap\u0026lt;\u0026gt;(); /** * è¨˜éŒ„é é¢è¨ªå• */ public void recordPageView(String page, String visitorId, long bandwidthBytes) { // å¢åŠ é é¢ç€è¦½é‡ pageViews.merge(page, 1L, Long::sum); // è¨˜éŒ„å”¯ä¸€è¨ªå®¢ uniqueVisitors.computeIfAbsent(page, k -\u0026gt; ConcurrentHashMap.newKeySet()).add(visitorId); // ç´¯åŠ é »å¯¬ä½¿ç”¨ totalBandwidth.merge(page, bandwidthBytes, Long::sum); } /** * ç²å–é é¢çµ±è¨ˆå ±å‘Š */ public Map\u0026lt;String, PageStats\u0026gt; getPageStats() { Map\u0026lt;String, PageStats\u0026gt; stats = new HashMap\u0026lt;\u0026gt;(); for (String page : pageViews.keySet()) { long views = pageViews.getOrDefault(page, 0L); int uniqueCount = uniqueVisitors.getOrDefault(page, Collections.emptySet()).size(); long bandwidth = totalBandwidth.getOrDefault(page, 0L); stats.put(page, new PageStats(views, uniqueCount, bandwidth)); } return stats; } /** * æ¸…ç†ä½æ´»èºåº¦é é¢æ•¸æ“š */ public int cleanupLowActivityPages(long minViews) { int removed = 0; Iterator\u0026lt;Map.Entry\u0026lt;String, Long\u0026gt;\u0026gt; iterator = pageViews.entrySet().iterator(); while (iterator.hasNext()) { Map.Entry\u0026lt;String, Long\u0026gt; entry = iterator.next(); if (entry.getValue() \u0026lt; minViews) { String page = entry.getKey(); iterator.remove(); uniqueVisitors.remove(page); totalBandwidth.remove(page); removed++; } } return removed; } public static class PageStats { private final long pageViews; private final int uniqueVisitors; private final long totalBandwidth; public PageStats(long pageViews, int uniqueVisitors, long totalBandwidth) { this.pageViews = pageViews; this.uniqueVisitors = uniqueVisitors; this.totalBandwidth = totalBandwidth; } public double getAverageBandwidthPerView() { return pageViews \u0026gt; 0 ? (double) totalBandwidth / pageViews : 0; } @Override public String toString() { return String.format(\u0026#34;PageStats{views=%d, unique=%d, bandwidth=%d bytes, avg=%.2f bytes/view}\u0026#34;, pageViews, uniqueVisitors, totalBandwidth, getAverageBandwidthPerView()); } // getter æ–¹æ³• public long getPageViews() { return pageViews; } public int getUniqueVisitors() { return uniqueVisitors; } public long getTotalBandwidth() { return totalBandwidth; } } } 2. åˆ†æ•£å¼å¿«å–ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 /** * åˆ†æ•£å¼å¿«å–ç®¡ç†ç³»çµ± */ public class DistributedCacheManager { private final ConcurrentHashMap\u0026lt;String, CacheEntry\u0026gt; cache = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final long defaultTTL = 300_000; // 5 åˆ†é˜é è¨­ TTL /** * æ”¾å…¥å¿«å–é …ç›® */ public void put(String key, Object value, long ttlMillis) { long expireTime = System.currentTimeMillis() + ttlMillis; cache.put(key, new CacheEntry(value, expireTime)); } public void put(String key, Object value) { put(key, value, defaultTTL); } /** * ç²å–å¿«å–é …ç›®ï¼ˆè‡ªå‹•æ¸…ç†éæœŸé …ç›®ï¼‰ */ public Object get(String key) { return cache.computeIfPresent(key, (k, entry) -\u0026gt; { if (entry.isExpired()) { return null; // éæœŸï¼Œç§»é™¤ } entry.updateAccessTime(); return entry; })?.getValue(); } /** * æ¢ä»¶å¼æ›´æ–°ï¼šåƒ…åœ¨å€¼å­˜åœ¨ä¸”æœªéæœŸæ™‚æ›´æ–° */ public boolean updateIfPresent(String key, Function\u0026lt;Object, Object\u0026gt; updater) { CacheEntry updated = cache.computeIfPresent(key, (k, entry) -\u0026gt; { if (entry.isExpired()) { return null; // éæœŸï¼Œç§»é™¤ } Object newValue = updater.apply(entry.getValue()); return new CacheEntry(newValue, entry.getExpireTime()); }); return updated != null; } /** * ç²å–æˆ–è¨ˆç®—å€¼ï¼ˆå»¶é²è¼‰å…¥æ¨¡å¼ï¼‰ */ public Object getOrCompute(String key, Function\u0026lt;String, Object\u0026gt; valueComputer, long ttlMillis) { return cache.compute(key, (k, entry) -\u0026gt; { if (entry != null \u0026amp;\u0026amp; !entry.isExpired()) { entry.updateAccessTime(); return entry; } // å¿«å–æœªå‘½ä¸­æˆ–å·²éæœŸï¼Œé‡æ–°è¨ˆç®— Object newValue = valueComputer.apply(key); long expireTime = System.currentTimeMillis() + ttlMillis; return new CacheEntry(newValue, expireTime); }).getValue(); } /** * æ‰¹é‡æ¸…ç†éæœŸé …ç›® */ public int cleanupExpired() { int removed = 0; long now = System.currentTimeMillis(); Iterator\u0026lt;Map.Entry\u0026lt;String, CacheEntry\u0026gt;\u0026gt; iterator = cache.entrySet().iterator(); while (iterator.hasNext()) { Map.Entry\u0026lt;String, CacheEntry\u0026gt; entry = iterator.next(); if (entry.getValue().getExpireTime() \u0026lt;= now) { iterator.remove(); removed++; } } return removed; } /** * ç²å–å¿«å–çµ±è¨ˆè³‡è¨Š */ public CacheStats getStats() { long now = System.currentTimeMillis(); int totalEntries = cache.size(); int expiredEntries = 0; long totalSize = 0; for (CacheEntry entry : cache.values()) { if (entry.getExpireTime() \u0026lt;= now) { expiredEntries++; } totalSize += entry.getEstimatedSize(); } return new CacheStats(totalEntries, expiredEntries, totalSize); } /** * å¿«å–é …ç›®é¡åˆ¥ */ public static class CacheEntry { private final Object value; private final long expireTime; private volatile long lastAccessTime; public CacheEntry(Object value, long expireTime) { this.value = value; this.expireTime = expireTime; this.lastAccessTime = System.currentTimeMillis(); } public boolean isExpired() { return System.currentTimeMillis() \u0026gt; expireTime; } public void updateAccessTime() { this.lastAccessTime = System.currentTimeMillis(); } public long getEstimatedSize() { // ç°¡å–®çš„å¤§å°ä¼°ç®— if (value instanceof String) { return ((String) value).length() * 2L; // Unicode å­—å…ƒ } else if (value instanceof byte[]) { return ((byte[]) value).length; } else { return 100L; // é è¨­ä¼°ç®— } } // getter æ–¹æ³• public Object getValue() { return value; } public long getExpireTime() { return expireTime; } public long getLastAccessTime() { return lastAccessTime; } } /** * å¿«å–çµ±è¨ˆè³‡è¨Š */ public static class CacheStats { private final int totalEntries; private final int expiredEntries; private final long totalSize; public CacheStats(int totalEntries, int expiredEntries, long totalSize) { this.totalEntries = totalEntries; this.expiredEntries = expiredEntries; this.totalSize = totalSize; } public int getActiveEntries() { return totalEntries - expiredEntries; } public double getHitRatio() { return totalEntries \u0026gt; 0 ? (double) getActiveEntries() / totalEntries : 0; } @Override public String toString() { return String.format(\u0026#34;CacheStats{total=%d, active=%d, expired=%d, size=%d bytes, hitRatio=%.2f%%}\u0026#34;, totalEntries, getActiveEntries(), expiredEntries, totalSize, getHitRatio() * 100); } // getter æ–¹æ³• public int getTotalEntries() { return totalEntries; } public int getExpiredEntries() { return expiredEntries; } public long getTotalSize() { return totalSize; } } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. æ–¹æ³•é¸æ“‡æŒ‡å— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 /** * Map è¨ˆç®—æ–¹æ³•é¸æ“‡æŒ‡å— */ public class MethodSelectionGuide { /** * åŸºæ–¼ä½¿ç”¨å ´æ™¯é¸æ“‡æœ€é©åˆçš„æ–¹æ³• */ public static void demonstrateMethodSelection() { System.out.println(\u0026#34;Map è¨ˆç®—æ–¹æ³•é¸æ“‡æŒ‡å—\u0026#34;); System.out.println(\u0026#34;==================\u0026#34;); // å ´æ™¯ 1: ç°¡å–®çš„ Key å­˜åœ¨æ€§æª¢æŸ¥èˆ‡æ’å…¥ System.out.println(\u0026#34;å ´æ™¯ 1: åˆå§‹åŒ–é›†åˆå…ƒç´ \u0026#34;); System.out.println(\u0026#34;æ¨è–¦: putIfAbsent æˆ– computeIfAbsent\u0026#34;); Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; groups = new ConcurrentHashMap\u0026lt;\u0026gt;(); // ä½¿ç”¨ computeIfAbsentï¼ˆæ¨è–¦ï¼‰ groups.computeIfAbsent(\u0026#34;admins\u0026#34;, k -\u0026gt; new ArrayList\u0026lt;\u0026gt;()).add(\u0026#34;alice\u0026#34;); // å ´æ™¯ 2: ç´¯åŠ è¨ˆæ•¸å™¨ System.out.println(\u0026#34;å ´æ™¯ 2: è¨ˆæ•¸å™¨ç´¯åŠ \u0026#34;); System.out.println(\u0026#34;æ¨è–¦: merge æˆ– compute\u0026#34;); Map\u0026lt;String, Integer\u0026gt; counters = new ConcurrentHashMap\u0026lt;\u0026gt;(); // ä½¿ç”¨ mergeï¼ˆæ¨è–¦ï¼‰ counters.merge(\u0026#34;clicks\u0026#34;, 1, Integer::sum); // å ´æ™¯ 3: æ¢ä»¶å¼æ›´æ–°ç¾æœ‰å€¼ System.out.println(\u0026#34;å ´æ™¯ 3: æ¢ä»¶å¼æ›´æ–°\u0026#34;); System.out.println(\u0026#34;æ¨è–¦: computeIfPresent\u0026#34;); Map\u0026lt;String, Integer\u0026gt; scores = new ConcurrentHashMap\u0026lt;\u0026gt;(); scores.put(\u0026#34;player1\u0026#34;, 100); // ä½¿ç”¨ computeIfPresentï¼ˆæ¨è–¦ï¼‰ scores.computeIfPresent(\u0026#34;player1\u0026#34;, (k, v) -\u0026gt; v \u0026gt; 50 ? v + 10 : v); // å ´æ™¯ 4: è¤‡é›œçš„è¨ˆç®—é‚è¼¯ System.out.println(\u0026#34;å ´æ™¯ 4: è¤‡é›œè¨ˆç®—\u0026#34;); System.out.println(\u0026#34;æ¨è–¦: compute\u0026#34;); Map\u0026lt;String, String\u0026gt; stateMachine = new ConcurrentHashMap\u0026lt;\u0026gt;(); // ä½¿ç”¨ computeï¼ˆæ¨è–¦ï¼‰ stateMachine.compute(\u0026#34;task1\u0026#34;, (k, currentState) -\u0026gt; { if (currentState == null) return \u0026#34;CREATED\u0026#34;; switch (currentState) { case \u0026#34;CREATED\u0026#34;: return \u0026#34;PROCESSING\u0026#34;; case \u0026#34;PROCESSING\u0026#34;: return \u0026#34;COMPLETED\u0026#34;; default: return currentState; } }); System.out.println(\u0026#34;çµæœå±•ç¤º:\u0026#34;); System.out.println(\u0026#34;ç¾¤çµ„: \u0026#34; + groups); System.out.println(\u0026#34;è¨ˆæ•¸å™¨: \u0026#34; + counters); System.out.println(\u0026#34;åˆ†æ•¸: \u0026#34; + scores); System.out.println(\u0026#34;ç‹€æ…‹: \u0026#34; + stateMachine); } } 2. å¸¸è¦‹é™·é˜±èˆ‡è§£æ±ºæ–¹æ¡ˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 /** * å¸¸è¦‹é™·é˜±èˆ‡è§£æ±ºæ–¹æ¡ˆ */ public class CommonPitfalls { /** * é™·é˜± 1: åœ¨è¨ˆç®—å‡½æ•¸ä¸­åŸ·è¡Œè€—æ™‚æ“ä½œ */ public static void demonstrateExpensiveOperationPitfall() { System.out.println(\u0026#34;é™·é˜± 1: è¨ˆç®—å‡½æ•¸ä¸­çš„è€—æ™‚æ“ä½œ\u0026#34;); ConcurrentHashMap\u0026lt;String, String\u0026gt; cache = new ConcurrentHashMap\u0026lt;\u0026gt;(); // âŒ éŒ¯èª¤åšæ³•ï¼šåœ¨è¨ˆç®—å‡½æ•¸ä¸­åŸ·è¡Œè€—æ™‚æ“ä½œ String badResult = cache.computeIfAbsent(\u0026#34;user123\u0026#34;, key -\u0026gt; { try { Thread.sleep(1000); // æ¨¡æ“¬è€—æ™‚çš„è³‡æ–™åº«æŸ¥è©¢ return \u0026#34;User data for \u0026#34; + key; } catch (InterruptedException e) { Thread.currentThread().interrupt(); return null; } }); // âœ… æ­£ç¢ºåšæ³•ï¼šé å…ˆè¨ˆç®—æˆ–ä½¿ç”¨ç•°æ­¥è¼‰å…¥ CompletableFuture\u0026lt;String\u0026gt; futureResult = CompletableFuture.supplyAsync(() -\u0026gt; { try { Thread.sleep(1000); // æ¨¡æ“¬è€—æ™‚æ“ä½œ return \u0026#34;User data for user456\u0026#34;; } catch (InterruptedException e) { Thread.currentThread().interrupt(); return null; } }); // åªåœ¨å¿«å–ä¸­å­˜å„²å·²è¨ˆç®—çš„çµæœ try { String goodResult = cache.putIfAbsent(\u0026#34;user456\u0026#34;, futureResult.get()); System.out.println(\u0026#34;é è¨ˆç®—çµæœ: \u0026#34; + goodResult); } catch (Exception e) { System.err.println(\u0026#34;è¨ˆç®—å¤±æ•—: \u0026#34; + e.getMessage()); } } /** * é™·é˜± 2: åœ¨è¨ˆç®—å‡½æ•¸ä¸­ä¿®æ”¹ Map æœ¬èº« */ public static void demonstrateRecursiveModificationPitfall() { System.out.println(\u0026#34;é™·é˜± 2: éè¿´ä¿®æ”¹é™·é˜±\u0026#34;); ConcurrentHashMap\u0026lt;String, Integer\u0026gt; map = new ConcurrentHashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;a\u0026#34;, 1); try { // âŒ éŒ¯èª¤åšæ³•ï¼šåœ¨è¨ˆç®—å‡½æ•¸ä¸­ä¿®æ”¹åŒä¸€å€‹ Map map.compute(\u0026#34;a\u0026#34;, (key, value) -\u0026gt; { map.put(\u0026#34;b\u0026#34;, 2); // é€™å¯èƒ½å°è‡´æ­»é–æˆ–ç•°å¸¸ return value + 1; }); } catch (Exception e) { System.err.println(\u0026#34;éè¿´ä¿®æ”¹éŒ¯èª¤: \u0026#34; + e.getMessage()); } // âœ… æ­£ç¢ºåšæ³•ï¼šåˆ†é›¢è¨ˆç®—å’Œä¿®æ”¹æ“ä½œ Integer currentValue = map.get(\u0026#34;a\u0026#34;); if (currentValue != null) { map.put(\u0026#34;a\u0026#34;, currentValue + 1); map.put(\u0026#34;b\u0026#34;, 2); } System.out.println(\u0026#34;å®‰å…¨ä¿®æ”¹å¾Œçš„ Map: \u0026#34; + map); } /** * é™·é˜± 3: è¨ˆç®—å‡½æ•¸æ‹‹å‡ºç•°å¸¸ */ public static void demonstrateExceptionHandlingPitfall() { System.out.println(\u0026#34;é™·é˜± 3: ç•°å¸¸è™•ç†é™·é˜±\u0026#34;); ConcurrentHashMap\u0026lt;String, Integer\u0026gt; map = new ConcurrentHashMap\u0026lt;\u0026gt;(); // âŒ å¯èƒ½æœ‰å•é¡Œï¼šæœªè™•ç†è¨ˆç®—å‡½æ•¸ä¸­çš„ç•°å¸¸ try { map.compute(\u0026#34;risky\u0026#34;, (key, value) -\u0026gt; { if (Math.random() \u0026gt; 0.5) { throw new RuntimeException(\u0026#34;éš¨æ©Ÿå¤±æ•—\u0026#34;); } return value == null ? 1 : value + 1; }); } catch (RuntimeException e) { System.err.println(\u0026#34;è¨ˆç®—å¤±æ•—: \u0026#34; + e.getMessage()); } // âœ… æ­£ç¢ºåšæ³•ï¼šåœ¨è¨ˆç®—å‡½æ•¸å…§éƒ¨è™•ç†ç•°å¸¸ map.compute(\u0026#34;safe\u0026#34;, (key, value) -\u0026gt; { try { // å¯èƒ½æ‹‹å‡ºç•°å¸¸çš„æ“ä½œ if (Math.random() \u0026gt; 0.5) { throw new RuntimeException(\u0026#34;éš¨æ©Ÿå¤±æ•—\u0026#34;); } return value == null ? 1 : value + 1; } catch (Exception e) { System.err.println(\u0026#34;å…§éƒ¨è™•ç†ç•°å¸¸: \u0026#34; + e.getMessage()); return value; // è¿”å›åŸå€¼æˆ–é è¨­å€¼ } }); System.out.println(\u0026#34;ç•°å¸¸è™•ç†å¾Œçš„ Map: \u0026#34; + map); } /** * é™·é˜± 4: null å€¼è™•ç†ä¸ç•¶ */ public static void demonstrateNullHandlingPitfall() { System.out.println(\u0026#34;é™·é˜± 4: null å€¼è™•ç†é™·é˜±\u0026#34;); ConcurrentHashMap\u0026lt;String, String\u0026gt; map = new ConcurrentHashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;key1\u0026#34;, \u0026#34;value1\u0026#34;); map.put(\u0026#34;key2\u0026#34;, null); // ConcurrentHashMap ä¸å…è¨± null å€¼ï¼Œé€™æœƒæ‹‹å‡ºç•°å¸¸ // âœ… æ­£ç¢ºåšæ³•ï¼šé¿å… null å€¼ map.compute(\u0026#34;key3\u0026#34;, (key, value) -\u0026gt; { if (value == null) { return \u0026#34;default_value\u0026#34;; } return value.toUpperCase(); }); // ä½¿ç”¨ Optional è™•ç†å¯èƒ½çš„ null å€¼ String result = Optional.ofNullable(map.get(\u0026#34;key3\u0026#34;)) .map(String::toUpperCase) .orElse(\u0026#34;DEFAULT\u0026#34;); System.out.println(\u0026#34;å®‰å…¨è™•ç† null å¾Œçš„çµæœ: \u0026#34; + result); } public static void main(String[] args) { demonstrateExpensiveOperationPitfall(); demonstrateRecursiveModificationPitfall(); demonstrateExceptionHandlingPitfall(); // demonstrateNullHandlingPitfall(); // æœƒæ‹‹å‡ºç•°å¸¸ } } ç¸½çµ Java Map çš„è¨ˆç®—æ–¹æ³•ç‚ºé–‹ç™¼è€…æä¾›äº†å¼·å¤§çš„å·¥å…·ä¾†é€²è¡Œé«˜æ•ˆçš„è³‡æ–™æ“ä½œï¼š\næ–¹æ³•ç‰¹æ€§ç¸½çµ æ–¹æ³• é©ç”¨å ´æ™¯ åŸ·è¡Œæ¢ä»¶ è¿”å›å€¼ putIfAbsent æ¢ä»¶å¼æ’å…¥ Key ä¸å­˜åœ¨ ç¾æœ‰å€¼æˆ– null compute ç„¡æ¢ä»¶è¨ˆç®— ç¸½æ˜¯åŸ·è¡Œ è¨ˆç®—çµæœ computeIfAbsent å»¶é²åˆå§‹åŒ– Key ä¸å­˜åœ¨æˆ–å€¼ç‚º null è¨ˆç®—çµæœæˆ–ç¾æœ‰å€¼ computeIfPresent æ¢ä»¶å¼æ›´æ–° Key å­˜åœ¨ä¸”å€¼ä¸ç‚º null è¨ˆç®—çµæœæˆ– null merge å€¼åˆä½µ ç¸½æ˜¯åŸ·è¡Œåˆä½µé‚è¼¯ åˆä½µçµæœ æœ€ä½³å¯¦è¸è¦é» é¸æ“‡åˆé©çš„æ–¹æ³•ï¼šæ ¹æ“šå…·é«”éœ€æ±‚é¸æ“‡æœ€åˆé©çš„è¨ˆç®—æ–¹æ³• é¿å…è€—æ™‚æ“ä½œï¼šåœ¨è¨ˆç®—å‡½æ•¸ä¸­é¿å…åŸ·è¡Œè€—æ™‚çš„ I/O æˆ–ç¶²è·¯æ“ä½œ ç•°å¸¸è™•ç†ï¼šå¦¥å–„è™•ç†è¨ˆç®—å‡½æ•¸ä¸­å¯èƒ½å‡ºç¾çš„ç•°å¸¸ åŸ·è¡Œç·’å®‰å…¨ï¼šé…åˆ ConcurrentHashMap å¯¦ç¾é«˜æ•ˆçš„ä½µç™¼æ“ä½œ æ•ˆèƒ½è€ƒé‡ï¼šåˆç†ä½¿ç”¨é€™äº›æ–¹æ³•å¯ä»¥é¡¯è‘—æå‡æ•ˆèƒ½ é—œéµå„ªå‹¢ åŸå­æ€§ï¼šé¿å… Check-Then-Act ç«¶æ…‹æ¢ä»¶ æ•ˆèƒ½æå‡ï¼šæ¸›å°‘é‡è¤‡çš„ Map æŸ¥æ‰¾æ“ä½œ ç¨‹å¼ç¢¼ç°¡æ½”ï¼šä½¿ç”¨ Lambda è¡¨é”å¼ç°¡åŒ–é‚è¼¯ åŸ·è¡Œç·’å®‰å…¨ï¼šèˆ‡ä½µç™¼é›†åˆå®Œç¾é…åˆ é€šéæŒæ¡é€™äº› Map è¨ˆç®—æ–¹æ³•ï¼Œæ‚¨å¯ä»¥å¯«å‡ºæ›´é«˜æ•ˆã€æ›´å®‰å…¨ã€æ›´ç°¡æ½”çš„ Java ç¨‹å¼ç¢¼ã€‚\n","permalink":"https://xinqilin.github.io/post/backend/mapcompute/","tags":["Java","Map","HashMap","ConcurrentHashMap","Collections","Performance","Lambda","Atomic Operations","Thread Safety"],"title":"Java Map è¨ˆç®—æ–¹æ³•å®Œæ•´æŒ‡å—ï¼šé«˜æ•ˆèƒ½æ•¸æ“šæ“ä½œèˆ‡æœ€ä½³å¯¦è¸"},{"content":"æ¦‚è¿° sedï¼ˆStream Editorï¼Œæµç·¨è¼¯å™¨ï¼‰æ˜¯ Unix/Linux ç³»çµ±ä¸­åŠŸèƒ½å¼·å¤§çš„æ–‡æœ¬è™•ç†å·¥å…·ã€‚å®ƒèƒ½å¤ å°æ–‡æœ¬æµé€²è¡Œéäº’å‹•å¼çš„ç·¨è¼¯æ“ä½œï¼ŒåŒ…æ‹¬æœå°‹ã€æ›¿æ›ã€æ’å…¥ã€åˆªé™¤ç­‰åŠŸèƒ½ã€‚ä½œç‚ºç®¡é“è™•ç†çš„é‡è¦å·¥å…·ï¼Œsed åœ¨è‡ªå‹•åŒ–è…³æœ¬å’Œæ‰¹æ¬¡æ–‡æœ¬è™•ç†ä¸­æ‰®æ¼”é—œéµè§’è‰²ã€‚\næ ¸å¿ƒç‰¹å¾µ æµå¼è™•ç†ï¼šé€è¡Œè™•ç†æ–‡æœ¬ï¼Œé©åˆå¤§æª”æ¡ˆæ“ä½œ éäº’å‹•å¼ï¼šå¯åœ¨è…³æœ¬ä¸­è‡ªå‹•åŸ·è¡Œ æ­£è¦è¡¨é”å¼ï¼šæ”¯æ´å¼·å¤§çš„æ¨¡å¼åŒ¹é… åŸåœ°ç·¨è¼¯ï¼šå¯ç›´æ¥ä¿®æ”¹åŸå§‹æª”æ¡ˆ ç®¡é“å‹å¥½ï¼šé©åˆèˆ‡å…¶ä»–å‘½ä»¤çµ„åˆä½¿ç”¨ åŸºæœ¬èªæ³• 1 2 3 sed [é¸é …] \u0026#39;åœ°å€å®šç•Œcommand\u0026#39; file(s) sed [é¸é …] -e \u0026#39;script1\u0026#39; -e \u0026#39;script2\u0026#39; file(s) sed [é¸é …] -f script.sed file(s) å¸¸ç”¨é¸é … 1 2 3 4 5 6 7 -n # å®‰éœæ¨¡å¼ï¼Œä¸è‡ªå‹•åˆ—å°è™•ç†çµæœ -e script # æŒ‡å®šè¦åŸ·è¡Œçš„è…³æœ¬å‘½ä»¤ -f file # å¾æª”æ¡ˆè®€å–è…³æœ¬å‘½ä»¤ -i[suffix] # ç›´æ¥ä¿®æ”¹æª”æ¡ˆï¼ˆå¯é¸å‚™ä»½å¾Œç¶´ï¼‰ -r æˆ– -E # ä½¿ç”¨æ“´å±•æ­£è¦è¡¨é”å¼ -s # å°‡å¤šå€‹æª”æ¡ˆè¦–ç‚ºç¨ç«‹è™•ç† --debug # åµéŒ¯æ¨¡å¼ï¼Œé¡¯ç¤ºåŸ·è¡Œéç¨‹ åŸºæœ¬ç¯„ä¾‹ 1 2 3 4 5 6 7 8 # åŸºæœ¬æ–‡æœ¬æ›¿æ› sed \u0026#39;s/old/new/\u0026#39; file.txt # æ›¿æ›æ¯è¡Œç¬¬ä¸€å€‹åŒ¹é… sed \u0026#39;s/old/new/g\u0026#39; file.txt # æ›¿æ›æ‰€æœ‰åŒ¹é… sed \u0026#39;s/old/new/2\u0026#39; file.txt # æ›¿æ›æ¯è¡Œç¬¬äºŒå€‹åŒ¹é… # ç›´æ¥ä¿®æ”¹æª”æ¡ˆ sed -i \u0026#39;s/old/new/g\u0026#39; file.txt # ç›´æ¥ä¿®æ”¹åŸæª”æ¡ˆ sed -i.bak \u0026#39;s/old/new/g\u0026#39; file.txt # ä¿®æ”¹å‰å…ˆå‚™ä»½ åœ°å€å®šç•Œ åœ°å€å®šç•Œç”¨æ–¼æŒ‡å®š sed å‘½ä»¤ä½œç”¨çš„è¡Œç¯„åœï¼š\nåŸºæœ¬åœ°å€é¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 # è¡Œè™Ÿåœ°å€ sed \u0026#39;3d\u0026#39; file.txt # åˆªé™¤ç¬¬3è¡Œ sed \u0026#39;1,5d\u0026#39; file.txt # åˆªé™¤ç¬¬1åˆ°5è¡Œ sed \u0026#39;3,$d\u0026#39; file.txt # åˆªé™¤ç¬¬3è¡Œåˆ°æª”æ¡ˆçµå°¾ # æ¨¡å¼åœ°å€ sed \u0026#39;/pattern/d\u0026#39; file.txt # åˆªé™¤åŒ…å«patternçš„è¡Œ sed \u0026#39;/start/,/end/d\u0026#39; file.txt # åˆªé™¤å¾startåˆ°endä¹‹é–“çš„è¡Œ # ç‰¹æ®Šåœ°å€ sed \u0026#39;$d\u0026#39; file.txt # åˆªé™¤æœ€å¾Œä¸€è¡Œ sed \u0026#39;0,/pattern/d\u0026#39; file.txt # åˆªé™¤åˆ°ç¬¬ä¸€å€‹åŒ¹é…patternçš„è¡Œ é€²éšåœ°å€å®šç•Œ 1 2 3 4 5 6 7 8 9 10 11 12 # æ­¥é€²åœ°å€ sed -n \u0026#39;1~2p\u0026#39; file.txt # åˆ—å°å¥‡æ•¸è¡Œï¼ˆå¾ç¬¬1è¡Œé–‹å§‹ï¼Œæ¯2è¡Œä¸€æ¬¡ï¼‰ sed -n \u0026#39;2~2p\u0026#39; file.txt # åˆ—å°å¶æ•¸è¡Œ sed -n \u0026#39;1~3p\u0026#39; file.txt # æ¯ä¸‰è¡Œåˆ—å°ä¸€æ¬¡ # åœ°å€å–å sed \u0026#39;3!d\u0026#39; file.txt # åˆªé™¤é™¤ç¬¬3è¡Œå¤–çš„æ‰€æœ‰è¡Œ sed \u0026#39;/pattern/!d\u0026#39; file.txt # åªä¿ç•™åŒ…å«patternçš„è¡Œ # è¤‡é›œåœ°å€çµ„åˆ sed \u0026#39;1,3d; 5,7d\u0026#39; file.txt # åˆªé™¤1-3è¡Œå’Œ5-7è¡Œ sed \u0026#39;/^#/d; /^$/d\u0026#39; file.txt # åˆªé™¤è¨»é‡‹è¡Œå’Œç©ºè¡Œ æ ¸å¿ƒå‘½ä»¤è©³è§£ 1. æ›¿æ›å‘½ä»¤ (s) sed æœ€å¸¸ç”¨çš„å‘½ä»¤ï¼Œèªæ³•ï¼šs/pattern/replacement/flags\nåŸºæœ¬æ›¿æ› 1 2 3 4 5 6 7 8 9 10 # åŸºæœ¬æ›¿æ›èªæ³• sed \u0026#39;s/pattern/replacement/\u0026#39; file.txt # æ›¿æ›æ¯è¡Œç¬¬ä¸€å€‹åŒ¹é… sed \u0026#39;s/pattern/replacement/g\u0026#39; file.txt # å…¨åŸŸæ›¿æ› sed \u0026#39;s/pattern/replacement/2\u0026#39; file.txt # æ›¿æ›ç¬¬äºŒå€‹åŒ¹é… sed \u0026#39;s/pattern/replacement/2g\u0026#39; file.txt # å¾ç¬¬äºŒå€‹é–‹å§‹å…¨éƒ¨æ›¿æ› # ä½¿ç”¨ä¸åŒåˆ†éš”ç¬¦ sed \u0026#39;s#/old/path#/new/path#g\u0026#39; file.txt # ä½¿ç”¨ # ä½œç‚ºåˆ†éš”ç¬¦ sed \u0026#39;s|old|new|g\u0026#39; file.txt # ä½¿ç”¨ | ä½œç‚ºåˆ†éš”ç¬¦ sed \u0026#39;s@old@new@g\u0026#39; file.txt # ä½¿ç”¨ @ ä½œç‚ºåˆ†éš”ç¬¦ é€²éšæ›¿æ›åŠŸèƒ½ 1 2 3 4 5 6 7 8 9 10 11 12 13 # å¤§å°å¯«è½‰æ› sed \u0026#39;s/.*/\\U\u0026amp;/\u0026#39; file.txt # å…¨éƒ¨è½‰å¤§å¯« sed \u0026#39;s/.*/\\L\u0026amp;/\u0026#39; file.txt # å…¨éƒ¨è½‰å°å¯« sed \u0026#39;s/\\([a-z]\\)/\\U\\1/g\u0026#39; file.txt # æ¯å€‹å­—æ¯è½‰å¤§å¯« sed \u0026#39;s/\\b\\w/\\U\u0026amp;/g\u0026#39; file.txt # å–®è©é¦–å­—æ¯å¤§å¯« # ä½¿ç”¨æ•ç²ç¾¤çµ„ sed \u0026#39;s/\\([0-9]*\\)-\\([0-9]*\\)/\\2-\\1/\u0026#39; file.txt # äº¤æ›æ•¸å­—é †åº sed \u0026#39;s/\\(.*\\): \\(.*\\)/\\2 - \\1/\u0026#39; file.txt # é‡æ–°æ’åˆ—æ ¼å¼ # æ¢ä»¶æ›¿æ› sed \u0026#39;/pattern/s/old/new/g\u0026#39; file.txt # åªåœ¨åŒ…å«patternçš„è¡Œä¸­æ›¿æ› sed \u0026#39;1,10s/old/new/g\u0026#39; file.txt # åªåœ¨ç¬¬1-10è¡Œä¸­æ›¿æ› 2. åˆªé™¤å‘½ä»¤ (d) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # åŸºæœ¬åˆªé™¤ sed \u0026#39;3d\u0026#39; file.txt # åˆªé™¤ç¬¬3è¡Œ sed \u0026#39;1,5d\u0026#39; file.txt # åˆªé™¤ç¬¬1-5è¡Œ sed \u0026#39;$d\u0026#39; file.txt # åˆªé™¤æœ€å¾Œä¸€è¡Œ # æ¨¡å¼åˆªé™¤ sed \u0026#39;/pattern/d\u0026#39; file.txt # åˆªé™¤åŒ…å«patternçš„è¡Œ sed \u0026#39;/^$/d\u0026#39; file.txt # åˆªé™¤ç©ºè¡Œ sed \u0026#39;/^#/d\u0026#39; file.txt # åˆªé™¤è¨»é‡‹è¡Œ sed \u0026#39;/^[[:space:]]*$/d\u0026#39; file.txt # åˆªé™¤ç©ºè¡Œå’Œåªæœ‰ç©ºç™½çš„è¡Œ # ç¯„åœåˆªé™¤ sed \u0026#39;/start/,/end/d\u0026#39; file.txt # åˆªé™¤startåˆ°endä¹‹é–“çš„è¡Œ sed \u0026#39;/BEGIN/,/END/d\u0026#39; file.txt # åˆªé™¤BEGINåˆ°ENDå€å¡Š 3. åˆ—å°å‘½ä»¤ (p) 1 2 3 4 5 6 7 8 9 10 11 12 # åŸºæœ¬åˆ—å°ï¼ˆé€šå¸¸èˆ‡-nä¸€èµ·ä½¿ç”¨ï¼‰ sed -n \u0026#39;3p\u0026#39; file.txt # åªåˆ—å°ç¬¬3è¡Œ sed -n \u0026#39;1,5p\u0026#39; file.txt # åªåˆ—å°ç¬¬1-5è¡Œ sed -n \u0026#39;$p\u0026#39; file.txt # åªåˆ—å°æœ€å¾Œä¸€è¡Œ # æ¨¡å¼åˆ—å° sed -n \u0026#39;/pattern/p\u0026#39; file.txt # åªåˆ—å°åŒ…å«patternçš„è¡Œ sed -n \u0026#39;/^#/p\u0026#39; file.txt # åªåˆ—å°è¨»é‡‹è¡Œ # è¤‡è£½åˆ—å° sed \u0026#39;p\u0026#39; file.txt # æ¯è¡Œåˆ—å°å…©æ¬¡ sed \u0026#39;/pattern/p\u0026#39; file.txt # åŒ¹é…è¡Œåˆ—å°å…©æ¬¡ 4. æ’å…¥å’Œé™„åŠ å‘½ä»¤ (i, a, c) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # æ’å…¥å‘½ä»¤ (i) - åœ¨æŒ‡å®šè¡Œå‰æ’å…¥ sed \u0026#39;3i\\New line before line 3\u0026#39; file.txt # åœ¨ç¬¬3è¡Œå‰æ’å…¥ sed \u0026#39;/pattern/i\\New line\u0026#39; file.txt # åœ¨åŒ¹é…è¡Œå‰æ’å…¥ # é™„åŠ å‘½ä»¤ (a) - åœ¨æŒ‡å®šè¡Œå¾Œé™„åŠ  sed \u0026#39;3a\\New line after line 3\u0026#39; file.txt # åœ¨ç¬¬3è¡Œå¾Œé™„åŠ  sed \u0026#39;/pattern/a\\New line\u0026#39; file.txt # åœ¨åŒ¹é…è¡Œå¾Œé™„åŠ  sed \u0026#39;$a\\Last line\u0026#39; file.txt # åœ¨æª”æ¡ˆæœ«å°¾é™„åŠ  # æ›¿æ›å‘½ä»¤ (c) - æ›¿æ›æ•´è¡Œ sed \u0026#39;3c\\Replacement line\u0026#39; file.txt # æ›¿æ›ç¬¬3è¡Œ sed \u0026#39;/pattern/c\\New content\u0026#39; file.txt # æ›¿æ›åŒ¹é…è¡Œ # å¤šè¡Œæ“ä½œ sed \u0026#39;3i\\Line 1\\nLine 2\\nLine 3\u0026#39; file.txt # æ’å…¥å¤šè¡Œ 5. æª”æ¡ˆæ“ä½œå‘½ä»¤ (r, w) 1 2 3 4 5 6 7 8 # è®€å–æª”æ¡ˆ (r) sed \u0026#39;3r insert.txt\u0026#39; file.txt # åœ¨ç¬¬3è¡Œå¾Œæ’å…¥æª”æ¡ˆå…§å®¹ sed \u0026#39;/pattern/r header.txt\u0026#39; file.txt # åœ¨åŒ¹é…è¡Œå¾Œæ’å…¥æª”æ¡ˆ # å¯«å…¥æª”æ¡ˆ (w) sed -n \u0026#39;1,10w output.txt\u0026#39; file.txt # å°‡ç¬¬1-10è¡Œå¯«å…¥æª”æ¡ˆ sed -n \u0026#39;/pattern/w matches.txt\u0026#39; file.txt # å°‡åŒ¹é…è¡Œå¯«å…¥æª”æ¡ˆ sed \u0026#39;/ERROR/w errors.log\u0026#39; file.txt # å°‡éŒ¯èª¤è¡Œå¯«å…¥æ—¥èªŒ æ­£è¦è¡¨é”å¼é€²éšæ‡‰ç”¨ åŸºæœ¬æ­£è¦è¡¨é”å¼ (BRE) 1 2 3 4 5 6 7 8 9 # åŸºæœ¬å…ƒå­—å…ƒ sed \u0026#39;s/^/\u0026gt; /\u0026#39; file.txt # åœ¨æ¯è¡Œé–‹é ­åŠ ä¸Š \u0026#34;\u0026gt; \u0026#34; sed \u0026#39;s/$/!/\u0026#39; file.txt # åœ¨æ¯è¡Œçµå°¾åŠ ä¸Š \u0026#34;!\u0026#34; sed \u0026#39;s/./X/g\u0026#39; file.txt # å°‡æ¯å€‹å­—å…ƒæ›¿æ›ç‚ºX # å­—å…ƒé¡åˆ¥ sed \u0026#39;s/[0-9]/X/g\u0026#39; file.txt # æ›¿æ›æ‰€æœ‰æ•¸å­— sed \u0026#39;s/[a-zA-Z]/X/g\u0026#39; file.txt # æ›¿æ›æ‰€æœ‰å­—æ¯ sed \u0026#39;s/[[:digit:]]/X/g\u0026#39; file.txt # ä½¿ç”¨POSIXå­—å…ƒé¡åˆ¥ æ“´å±•æ­£è¦è¡¨é”å¼ (ERE) 1 2 3 4 5 6 7 8 9 10 # ä½¿ç”¨ -E æˆ– -r é¸é … sed -E \u0026#39;s/([0-9]+)-([0-9]+)/\\2-\\1/\u0026#39; file.txt # äº¤æ›é€£å­—è™Ÿåˆ†éš”çš„æ•¸å­— sed -E \u0026#39;s/\\b[a-z]+/\\U\u0026amp;/g\u0026#39; file.txt # å–®è©é¦–å­—æ¯å¤§å¯« sed -E \u0026#39;s/(.*\\.)(jpg|png)/\\1webp/\u0026#39; file.txt # æ”¹è®Šæª”æ¡ˆå‰¯æª”å # é‡è©ä½¿ç”¨ sed -E \u0026#39;s/a+/A/g\u0026#39; file.txt # ä¸€å€‹æˆ–å¤šå€‹a sed -E \u0026#39;s/a?/A/g\u0026#39; file.txt # é›¶å€‹æˆ–ä¸€å€‹a sed -E \u0026#39;s/a{3}/AAA/g\u0026#39; file.txt # æ°å¥½ä¸‰å€‹a sed -E \u0026#39;s/a{2,4}/A/g\u0026#39; file.txt # 2åˆ°4å€‹a å¯¦æˆ°æ‡‰ç”¨å ´æ™¯ 1. æª”æ¡ˆå…§å®¹æ¸…ç† 1 2 3 4 5 6 7 8 9 10 # æ¸…ç†ç©ºè¡Œå’Œè¨»é‡‹ sed \u0026#39;/^$/d; /^#/d\u0026#39; file.txt # åˆªé™¤ç©ºè¡Œå’Œè¨»é‡‹è¡Œ sed \u0026#39;/^[[:space:]]*$/d\u0026#39; file.txt # åˆªé™¤ç©ºè¡Œå’Œåªæœ‰ç©ºç™½çš„è¡Œ sed \u0026#39;s/[[:space:]]*$//\u0026#39; file.txt # åˆªé™¤è¡Œå°¾ç©ºç™½ sed \u0026#39;s/^[[:space:]]*//\u0026#39; file.txt # åˆªé™¤è¡Œé¦–ç©ºç™½ # æ¸…ç†ç‰¹æ®Šå­—å…ƒ sed \u0026#39;s/\\r$//\u0026#39; file.txt # åˆªé™¤Windowsæ›è¡Œç¬¦ sed \u0026#39;s/\\t/ /g\u0026#39; file.txt # å°‡tabæ›¿æ›ç‚ºç©ºæ ¼ sed \u0026#39;s/[[:cntrl:]]//g\u0026#39; file.txt # åˆªé™¤æ§åˆ¶å­—å…ƒ 2. è³‡æ–™æ ¼å¼è½‰æ› 1 2 3 4 5 6 7 8 9 10 11 12 # CSVè™•ç† sed \u0026#39;s/,/\\t/g\u0026#39; data.csv # CSVè½‰TSV sed \u0026#39;s/;/,/g\u0026#39; file.csv # æ›´æ”¹åˆ†éš”ç¬¦ sed \u0026#39;1d\u0026#39; data.csv # åˆªé™¤æ¨™é¡Œè¡Œ # æ—¥æœŸæ ¼å¼è½‰æ› sed -E \u0026#39;s/([0-9]{4})-([0-9]{2})-([0-9]{2})/\\3\\/\\2\\/\\1/g\u0026#39; file.txt # 2023-12-25 -\u0026gt; 25/12/2023 # é›»è©±è™Ÿç¢¼æ ¼å¼åŒ– sed -E \u0026#39;s/([0-9]{3})([0-9]{3})([0-9]{4})/(\\1) \\2-\\3/\u0026#39; file.txt # 1234567890 -\u0026gt; (123) 456-7890 3. ç¨‹å¼ç¢¼è™•ç† 1 2 3 4 5 6 7 8 9 # æ‰¹æ¬¡é‡æ§‹ç¨‹å¼ç¢¼ find . -name \u0026#34;*.java\u0026#34; -exec sed -i \u0026#39;s/oldClassName/newClassName/g\u0026#39; {} \\; # ç§»é™¤åµéŒ¯ç¨‹å¼ç¢¼ sed \u0026#39;/console\\.log/d\u0026#39; script.js # åˆªé™¤console.logè¡Œ sed \u0026#39;/DEBUG/,/END_DEBUG/d\u0026#39; code.c # åˆªé™¤DEBUGå€å¡Š # æ·»åŠ æˆæ¬Šæ¨™é¡Œ sed \u0026#39;1i\\// Copyright 2023 Company Name\u0026#39; *.js # åœ¨æ¯å€‹JSæª”æ¡ˆé–‹é ­æ·»åŠ ç‰ˆæ¬Š 4. æ—¥èªŒåˆ†æ 1 2 3 4 5 6 7 8 9 10 # æå–ç‰¹å®šæ™‚é–“ç¯„åœçš„æ—¥èªŒ sed -n \u0026#39;/2023-12-01/,/2023-12-31/p\u0026#39; access.log # éæ¿¾éŒ¯èª¤æ—¥èªŒ sed -n \u0026#39;/ERROR\\|FATAL/p\u0026#39; application.log # åªé¡¯ç¤ºéŒ¯èª¤å’Œè‡´å‘½éŒ¯èª¤ sed \u0026#39;/INFO\\|DEBUG/d\u0026#39; application.log # éš±è—è³‡è¨Šå’ŒåµéŒ¯è¨Šæ¯ # æ—¥èªŒæ ¼å¼åŒ– sed \u0026#39;s/\\[\\([^]]*\\)\\]/\\1/g\u0026#39; syslog # ç§»é™¤æ–¹æ‹¬è™Ÿ sed -E \u0026#39;s/^([^ ]+) ([^ ]+)/[\\1] \\2:/\u0026#39; log.txt # é‡æ–°æ ¼å¼åŒ–æ™‚é–“æˆ³ 5. è¨­å®šæª”ç®¡ç† 1 2 3 4 5 6 7 8 # ä¿®æ”¹è¨­å®šå€¼ sed -i \u0026#39;s/^port=.*/port=8080/\u0026#39; config.ini # ä¿®æ”¹é€£æ¥åŸ è¨­å®š sed -i \u0026#39;/^#.*debug/s/^#//\u0026#39; config.conf # å–æ¶ˆè¨»é‡‹debugè¨­å®š sed -i \u0026#39;/^debug=/s/false/true/\u0026#39; config.conf # å•Ÿç”¨debugæ¨¡å¼ # æ·»åŠ è¨­å®šé …ç›® sed -i \u0026#39;/\\[database\\]/a\\timeout=30\u0026#39; config.ini # åœ¨[database]æ®µè½å¾Œæ·»åŠ è¨­å®š sed -i \u0026#39;$a\\new_setting=value\u0026#39; config.conf # åœ¨æª”æ¡ˆæœ«å°¾æ·»åŠ è¨­å®š é€²éšæŠ€å·§ 1. å¤šå‘½ä»¤è™•ç† 1 2 3 4 5 6 7 8 # ä½¿ç”¨åˆ†è™Ÿåˆ†éš”å‘½ä»¤ sed \u0026#39;1d; s/old/new/g; $a\\EOF\u0026#39; file.txt # ä½¿ç”¨-eé¸é … sed -e \u0026#39;1d\u0026#39; -e \u0026#39;s/old/new/g\u0026#39; -e \u0026#39;$a\\EOF\u0026#39; file.txt # ä½¿ç”¨å¤§æ‹¬è™Ÿçµ„åˆå‘½ä»¤ sed \u0026#39;/pattern/{s/old/new/; p;}\u0026#39; file.txt 2. æ¢ä»¶è™•ç† 1 2 3 4 5 6 7 8 # åˆ†æ”¯å’Œæ¨™ç±¤ sed \u0026#39;:label; s/\\([0-9]*\\),\\([0-9]\\)/\\1\\2,/; t label\u0026#39; file.txt # ç§»é™¤æ•¸å­—ä¸­çš„é€—è™Ÿ # æ¸¬è©¦å‘½ä»¤ sed \u0026#39;s/old/new/; t end; s/fallback/replacement/; :end\u0026#39; file.txt # è¤‡é›œæ¢ä»¶é‚è¼¯ sed \u0026#39;/pattern1/{s/old/new/; b}; /pattern2/s/old/different/\u0026#39; file.txt 3. ä¿æŒç©ºé–“ (Hold Space) 1 2 3 4 5 6 # åŸºæœ¬ä¿æŒç©ºé–“æ“ä½œ sed -n \u0026#39;1h; 2g; 2p\u0026#39; file.txt # å°‡ç¬¬1è¡Œè¤‡è£½åˆ°ç¬¬2è¡Œä½ç½®é¡¯ç¤º sed -n \u0026#39;1h; 1!H; $!d; x; p\u0026#39; file.txt # åè½‰æª”æ¡ˆè¡Œé †åº # è¤‡é›œçš„ä¿æŒç©ºé–“ç¯„ä¾‹ sed -n \u0026#39;/pattern/{h; n; s/old/new/; H; x; s/\\n/ - /; p;}\u0026#39; file.txt 4. è…³æœ¬æª”æ¡ˆ å»ºç«‹ script.sed æª”æ¡ˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 # é€™æ˜¯ä¸€å€‹sedè…³æœ¬æª”æ¡ˆ # åˆªé™¤ç©ºè¡Œ /^$/d # åˆªé™¤è¨»é‡‹è¡Œ /^#/d # æ›¿æ›ç‰¹å®šæ¨¡å¼ s/old_pattern/new_pattern/g # åœ¨æª”æ¡ˆæœ«å°¾æ·»åŠ å…§å®¹ $a\\ Processing completed. ä½¿ç”¨è…³æœ¬ï¼š\n1 sed -f script.sed input.txt æ•ˆèƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. æ•ˆèƒ½å„ªåŒ–æŠ€å·§ 1 2 3 4 5 6 7 8 9 10 # ä½¿ç”¨quitå‘½ä»¤ææ—©é€€å‡º sed \u0026#39;10q\u0026#39; file.txt # åªè™•ç†å‰10è¡Œå¾Œé€€å‡º sed \u0026#39;/pattern/q\u0026#39; file.txt # æ‰¾åˆ°åŒ¹é…å¾Œç«‹å³é€€å‡º # é¿å…ä¸å¿…è¦çš„è™•ç† sed -n \u0026#39;/pattern/p\u0026#39; file.txt # ä½¿ç”¨-né¿å…è‡ªå‹•åˆ—å° sed \u0026#39;/pattern/!d\u0026#39; file.txt # åªä¿ç•™åŒ¹é…è¡Œ # çµ„åˆå¤šå€‹æ“ä½œ sed \u0026#39;s/old1/new1/g; s/old2/new2/g\u0026#39; file.txt # ä¸€æ¬¡åŸ·è¡Œå¤šå€‹æ›¿æ› 2. è¨˜æ†¶é«”ä½¿ç”¨å„ªåŒ– 1 2 3 4 5 6 # è™•ç†å¤§æª”æ¡ˆæ™‚çš„æ³¨æ„äº‹é … sed \u0026#39;1,1000d\u0026#39; hugefile.txt \u0026gt; output.txt # åˆ†æ®µè™•ç†å¤§æª”æ¡ˆ sed -n \u0026#39;1000,2000p\u0026#39; hugefile.txt # åªè™•ç†ç‰¹å®šç¯„åœ # ä½¿ç”¨ç®¡é“æ¸›å°‘ä¸­é–“æª”æ¡ˆ cat input.txt | sed \u0026#39;s/old/new/g\u0026#39; | sed \u0026#39;/pattern/d\u0026#39; \u0026gt; output.txt 3. éŒ¯èª¤è™•ç† 1 2 3 4 5 6 7 8 9 # å‚™ä»½é‡è¦æª”æ¡ˆ sed -i.backup \u0026#39;s/old/new/g\u0026#39; important.txt # è‡ªå‹•å‚™ä»½ # æ¸¬è©¦å‘½ä»¤ sed \u0026#39;s/old/new/g\u0026#39; file.txt \u0026gt; test_output.txt # å…ˆæ¸¬è©¦è¼¸å‡º diff file.txt test_output.txt # æª¢æŸ¥å·®ç•° # æª¢æŸ¥æª”æ¡ˆå­˜åœ¨ [ -f file.txt ] \u0026amp;\u0026amp; sed -i \u0026#39;s/old/new/g\u0026#39; file.txt å¸¸è¦‹éŒ¯èª¤èˆ‡é™¤éŒ¯ 1. å¸¸è¦‹éŒ¯èª¤ 1 2 3 4 5 6 7 8 9 10 11 # éŒ¯èª¤ï¼šæœªè½‰ç¾©ç‰¹æ®Šå­—å…ƒ sed \u0026#39;s/file.txt/newfile.txt/\u0026#39; file # éŒ¯èª¤ï¼š.åŒ¹é…ä»»æ„å­—å…ƒ sed \u0026#39;s/file\\.txt/newfile.txt/\u0026#39; file # æ­£ç¢ºï¼šè½‰ç¾©.å­—å…ƒ # éŒ¯èª¤ï¼šåœ°å€ç¯„åœå•é¡Œ sed \u0026#39;1,$s/old/new/\u0026#39; file.txt # å¯èƒ½é€ æˆæ··æ·† sed \u0026#39;1,$ s/old/new/\u0026#39; file.txt # æ›´æ¸…æ¥šçš„å¯«æ³• # éŒ¯èª¤ï¼šå¿˜è¨˜åˆ†éš”ç¬¦è½‰ç¾© sed \u0026#39;s/http://old.com/http://new.com/\u0026#39; file # éŒ¯èª¤ï¼šåˆ†éš”ç¬¦è¡çª sed \u0026#39;s#http://old.com#http://new.com#\u0026#39; file # æ­£ç¢ºï¼šä½¿ç”¨ä¸åŒåˆ†éš”ç¬¦ 2. é™¤éŒ¯æŠ€å·§ 1 2 3 4 5 6 7 8 9 # ä½¿ç”¨åµéŒ¯æ¨¡å¼ sed --debug \u0026#39;s/old/new/g\u0026#39; file.txt # é€æ­¥æ¸¬è©¦ sed -n \u0026#39;l\u0026#39; file.txt # é¡¯ç¤ºä¸å¯è¦‹å­—å…ƒ sed = file.txt | sed \u0026#39;N; s/\\n/\\t/\u0026#39; # é¡¯ç¤ºè¡Œè™Ÿ # æ¸¬è©¦æ­£è¦è¡¨é”å¼ echo \u0026#34;test string\u0026#34; | sed \u0026#39;s/pattern/replacement/\u0026#39; èˆ‡å…¶ä»–å·¥å…·æ•´åˆ 1. èˆ‡ find çµ„åˆ 1 2 3 4 5 6 # æ‰¹æ¬¡è™•ç†æª”æ¡ˆ find . -name \u0026#34;*.txt\u0026#34; -exec sed -i \u0026#39;s/old/new/g\u0026#39; {} \\; find . -name \u0026#34;*.conf\u0026#34; -exec sed -i \u0026#39;/^#/d\u0026#39; {} \\; # ä½¿ç”¨ xargs æå‡æ•ˆèƒ½ find . -name \u0026#34;*.txt\u0026#34; | xargs sed -i \u0026#39;s/old/new/g\u0026#39; 2. èˆ‡ awk çµ„åˆ 1 2 3 4 5 # sedè™•ç†æ ¼å¼ï¼Œawkè™•ç†é‚è¼¯ sed \u0026#39;s/,/ /g\u0026#39; data.csv | awk \u0026#39;{print $1, $3}\u0026#39; # ç®¡é“çµ„åˆè™•ç† cat log.txt | sed \u0026#39;/ERROR/!d\u0026#39; | awk \u0026#39;{print $1, $4}\u0026#39; 3. èˆ‡ grep çµ„åˆ 1 2 3 4 5 # å…ˆéæ¿¾å†è™•ç† grep \u0026#34;pattern\u0026#34; file.txt | sed \u0026#39;s/old/new/g\u0026#39; # çµ„åˆæ¢ä»¶è™•ç† sed -n \u0026#39;/start/,/end/p\u0026#39; file.txt | grep \u0026#34;important\u0026#34; å¯¦ç”¨è…³æœ¬ç¯„ä¾‹ 1. æ—¥èªŒæ¸…ç†è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #!/bin/bash # log_cleanup.sh - æ¸…ç†å’Œæ ¼å¼åŒ–æ—¥èªŒæª”æ¡ˆ LOG_FILE=\u0026#34;$1\u0026#34; OUTPUT_FILE=\u0026#34;${LOG_FILE}.clean\u0026#34; sed -e \u0026#39;/^$/d\u0026#39; \\ -e \u0026#39;/^#/d\u0026#39; \\ -e \u0026#39;s/[[:space:]]*$//\u0026#39; \\ -e \u0026#39;s/\\t/ /g\u0026#39; \\ -e \u0026#39;/DEBUG/d\u0026#39; \\ \u0026#34;$LOG_FILE\u0026#34; \u0026gt; \u0026#34;$OUTPUT_FILE\u0026#34; echo \u0026#34;æ¸…ç†å®Œæˆï¼š$OUTPUT_FILE\u0026#34; 2. è¨­å®šæª”æ›´æ–°è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #!/bin/bash # config_update.sh - æ‰¹æ¬¡æ›´æ–°è¨­å®šæª” CONFIG_DIR=\u0026#34;/etc/myapp\u0026#34; BACKUP_DIR=\u0026#34;/etc/myapp/backup\u0026#34; # å‚™ä»½è¨­å®šæª” mkdir -p \u0026#34;$BACKUP_DIR\u0026#34; cp \u0026#34;$CONFIG_DIR\u0026#34;/*.conf \u0026#34;$BACKUP_DIR\u0026#34;/ # æ›´æ–°è¨­å®š find \u0026#34;$CONFIG_DIR\u0026#34; -name \u0026#34;*.conf\u0026#34; -exec sed -i \\ -e \u0026#39;s/^port=.*/port=8080/\u0026#39; \\ -e \u0026#39;s/^debug=false/debug=true/\u0026#39; \\ -e \u0026#39;/^#.*logging/s/^#//\u0026#39; \\ {} \\; echo \u0026#34;è¨­å®šæ›´æ–°å®Œæˆ\u0026#34; 3. ç¨‹å¼ç¢¼é‡æ§‹è…³æœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/bin/bash # refactor.sh - æ‰¹æ¬¡é‡æ§‹ç¨‹å¼ç¢¼ OLD_CLASS=\u0026#34;$1\u0026#34; NEW_CLASS=\u0026#34;$2\u0026#34; if [ $# -ne 2 ]; then echo \u0026#34;ç”¨æ³•: $0 \u0026lt;èˆŠé¡åˆ¥å\u0026gt; \u0026lt;æ–°é¡åˆ¥å\u0026gt;\u0026#34; exit 1 fi # æ›´æ–°Javaæª”æ¡ˆ find . -name \u0026#34;*.java\u0026#34; -exec sed -i \\ -e \u0026#34;s/class $OLD_CLASS/class $NEW_CLASS/g\u0026#34; \\ -e \u0026#34;s/new $OLD_CLASS(/new $NEW_CLASS(/g\u0026#34; \\ -e \u0026#34;s/$OLD_CLASS\\.class/$NEW_CLASS.class/g\u0026#34; \\ {} \\; echo \u0026#34;é‡æ§‹å®Œæˆï¼š$OLD_CLASS -\u0026gt; $NEW_CLASS\u0026#34; ç¸½çµ æ ¸å¿ƒå„ªå‹¢ é«˜æ•ˆç‡ï¼šæµå¼è™•ç†ï¼Œè¨˜æ†¶é«”ä½¿ç”¨é‡å° éˆæ´»æ€§ï¼šæ”¯æ´è¤‡é›œçš„æ–‡æœ¬æ“ä½œ è‡ªå‹•åŒ–ï¼šé©åˆè…³æœ¬å’Œæ‰¹æ¬¡è™•ç† æ¨™æº–åŒ–ï¼šè·¨å¹³å°ä¸€è‡´æ€§å¥½ æœ€ä½³å¯¦è¸ æ¸¬è©¦å…ˆè¡Œï¼šé‡è¦æ“ä½œå‰å…ˆæ¸¬è©¦è¼¸å‡º å‚™ä»½é‡è¦æª”æ¡ˆï¼šä½¿ç”¨ -i.backup é¸é … å–„ç”¨æ­£è¦è¡¨é”å¼ï¼šæå‡è™•ç†æ•ˆç‡ çµ„åˆå·¥å…·ï¼šèˆ‡å…¶ä»–å‘½ä»¤å”ä½œä½¿ç”¨ è…³æœ¬åŒ–ï¼šå°‡è¤‡é›œæ“ä½œå°è£ç‚ºè…³æœ¬ å­¸ç¿’å»ºè­° 1 2 3 4 5 6 7 # å¸¸ç”¨æ“ä½œè¨˜æ†¶å£è¨£ sed \u0026#39;s/old/new/g\u0026#39; # æ›¿æ›ï¼šsubstitute sed \u0026#39;3d\u0026#39; # åˆªé™¤ï¼šdelete sed \u0026#39;3p\u0026#39; # åˆ—å°ï¼šprint sed \u0026#39;3a\\text\u0026#39; # é™„åŠ ï¼šappend sed \u0026#39;3i\\text\u0026#39; # æ’å…¥ï¼šinsert sed \u0026#39;3c\\text\u0026#39; # æ”¹è®Šï¼šchange sed æ˜¯æ–‡æœ¬è™•ç†çš„ç‘å£«è»åˆ€ï¼ŒæŒæ¡å…¶æ ¸å¿ƒæ¦‚å¿µå’Œå¸¸ç”¨æ“ä½œï¼Œèƒ½å¤ å¤§å¹…æå‡ Linux ç³»çµ±ç®¡ç†å’Œè‡ªå‹•åŒ–è…³æœ¬çš„æ•ˆç‡ã€‚è¨˜ä½ï¼šå¯¦å‹™ä¸­æœ€é‡è¦çš„æ˜¯ç†è§£æ¨¡å¼ç©ºé–“çš„æ¦‚å¿µï¼Œä¸¦å–„ç”¨åœ°å€å®šç•Œä¾†ç²¾ç¢ºæ§åˆ¶æ“ä½œç¯„åœã€‚\nåƒè€ƒè³‡æ–™ GNU sed Manual sed \u0026amp; awk by O\u0026rsquo;Reilly Advanced Bash-Scripting Guide Regular Expressions Info ","permalink":"https://xinqilin.github.io/post/tools/sed/","tags":["Linux","Sed","Stream Editor","Text Processing","Regular Expression","Shell","Unix"],"title":"Sed æµç·¨è¼¯å™¨å®Œæ•´æŒ‡å—ï¼šLinux æ–‡æœ¬è™•ç†çš„å¼·å¤§å·¥å…·"},{"content":"Memento ç•¶æˆ‘å€‘æƒ³è¦ä¿å­˜å°è±¡çš„ç‹€æ…‹ä»¥ä¾¿ä»¥å¾Œæ¢å¾©å®ƒæ™‚ï¼Œæˆ‘å€‘ä½¿ç”¨å‚™å¿˜éŒ„è¨­è¨ˆæ¨¡å¼ã€‚å‚™å¿˜éŒ„æ¨¡å¼æœ‰åŠ©æ–¼ä»¥é€™æ¨£ä¸€ç¨®æ–¹å¼å¯¦ç¾é€™ä¸€é»ï¼Œå³å°è±¡çš„å·²ä¿å­˜ç‹€æ…‹æ•¸æ“šåœ¨å°åƒå¤–éƒ¨ç„¡æ³•è¨ªå•ï¼›é€™ä¿è­·äº†å·²ä¿å­˜ç‹€æ…‹æ•¸æ“šçš„å®Œæ•´æ€§ã€‚\nå¯¦ç¾ Memento æ¨¡å¼çš„æƒ³æ³•å§‹æ–¼å…©å€‹å°è±¡â€”â€” Originator å’Œ Caretakerã€‚Originatoræ˜¯éœ€è¦ä¿å­˜å’Œæ¢å¾©ç‹€æ…‹çš„å°è±¡ï¼Œå®ƒä½¿ç”¨ä¸€å€‹å…§éƒ¨é¡ä¾†ä¿å­˜Objectçš„ç‹€æ…‹ã€‚å…§éƒ¨é¡ç¨±ç‚º Memento åŠå…¶ç§æœ‰ï¼Œå› æ­¤ç„¡æ³•å¾å…¶ä»–å°è±¡è¨ªå•ã€‚\nCaretaker æ˜¯å¹«åŠ©é¡ï¼Œè² è²¬é€šé Memento å°è±¡å­˜å„²å’Œæ¢å¾© Originator çš„ç‹€æ…‹ã€‚ç”±æ–¼ Memento å° Originator æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤ Caretaker ç„¡æ³•è¨ªå•å®ƒï¼Œä¸¦ä¸”å®ƒä½œç‚º Object å­˜å„²åœ¨ caretaker ä¸­ã€‚\nç¾å¯¦ç”Ÿæ´»ä¸­æœ€å¥½çš„ä¾‹å­ä¹‹ä¸€æ˜¯ IDE, æˆ‘å€‘å¯ä»¥éš¨æ™‚ä¿å­˜å…¶æ•¸æ“šä¸¦ä½¿ç”¨æ’¤æ¶ˆå°‡å…¶æ¢å¾©åˆ°ä»¥å‰ä¿å­˜çš„ç‹€æ…‹ã€‚\nå¿…é ˆä¿å­˜å°è±¡ç‹€æ…‹ï¼ˆæŸäº›éƒ¨åˆ†ï¼‰çš„å¿«ç…§ï¼Œä»¥ä¾¿ä»¥å¾Œå¯ä»¥å°‡å…¶æ¢å¾©åˆ°è©²ç‹€æ…‹ï¼Œä¸¦ä¸” ç²å–ç‹€æ…‹çš„ç›´æ¥æ¥å£æœƒæš´éœ²å¯¦ç¾ç´°ç¯€ä¸¦ç ´å£å°è±¡çš„å°è£ã€‚ ","permalink":"https://xinqilin.github.io/post/architecture/memento/","tags":[],"title":"DesignPattern - Behavioral - Memento"},{"content":"Interpreter ç”¨å®ƒä¾†å®šç¾©ä¸€ç¨®èªè¨€çš„èªæ³•è¡¨ç¤ºï¼Œå®ƒæä¾›äº†ä¸€å€‹è§£é‡‹å™¨ä¾†è™•ç†èªæ³•ã€‚é€™ç¨®æ¨¡å¼çš„æœ€ä½³ç¤ºä¾‹æ˜¯ java ç·¨è­¯å™¨ï¼Œå®ƒå°‡ java æºä»£ç¢¼è§£é‡‹ç‚º JVM å¯ä»¥ç†è§£çš„å­—ç¯€ç¢¼ã€‚google translation ä¹Ÿæ˜¯Interpreter çš„ä¸€å€‹ä¾‹å­ï¼Œå…¶ä¸­è¼¸å…¥å¯ä»¥æ˜¯ä»»ä½•èªè¨€ï¼Œæˆ‘å€‘å¯ä»¥å¾—åˆ°å¦ä¸€ç¨®èªè¨€çš„è§£é‡‹è¼¸å‡ºã€‚\nç‚ºäº† Interpreterï¼Œæˆ‘å€‘éœ€è¦å‰µå»º Interpreter ä¸Šä¸‹æ–‡å¼•æ“ä¾†å®Œæˆè§£é‡‹å·¥ä½œã€‚ç„¶å¾Œï¼Œæˆ‘å€‘éœ€è¦å‰µå»ºä¸åŒçš„ Expression å¯¦ç¾ï¼Œé€™äº›å¯¦ç¾å°‡ä½¿ç”¨è§£é‡‹å™¨ä¸Šä¸‹æ–‡æä¾›çš„åŠŸèƒ½ã€‚æœ€å¾Œï¼Œæˆ‘å€‘éœ€è¦å‰µå»ºå®¢æˆ¶ç«¯ï¼Œè©²å®¢æˆ¶ç«¯å°‡å¾ç”¨æˆ¶é‚£è£¡ç²å–è¼¸å…¥ä¸¦æ±ºå®šä½¿ç”¨å“ªå€‹è¡¨é”å¼ï¼Œç„¶å¾Œç‚ºç”¨æˆ¶ç”Ÿæˆè¼¸å‡ºã€‚\nèªæ³•å¾ˆç°¡å–®ã€‚å°æ–¼å¾©é›œçš„èªæ³•ï¼Œèªæ³•çš„é¡å±¤æ¬¡çµæ§‹è®Šå¾—é¾å¤§ä¸”é›£ä»¥ç®¡ç†ã€‚åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œè§£æå™¨ç”Ÿæˆå™¨ç­‰å·¥å…·æ˜¯æ›´å¥½çš„é¸æ“‡ã€‚ä»–å€‘å¯ä»¥åœ¨ä¸æ§‹å»ºæŠ½è±¡èªæ³•æ¨¹ (AST) çš„æƒ…æ³ä¸‹è§£é‡‹è¡¨é”å¼ï¼Œé€™ä¹Ÿå¯ä»¥ç¯€çœç©ºé–“å’Œæ™‚é–“ã€‚ æ•ˆç‡ä¸æ˜¯é—œéµå•é¡Œã€‚æœ€æœ‰æ•ˆçš„è§£é‡‹å™¨é€šå¸¸ä¸æ˜¯é€šéç›´æ¥è§£é‡‹è§£ææ¨¹ä¾†å¯¦ç¾ï¼Œè€Œæ˜¯é¦–å…ˆå°‡å®ƒå€‘ç¿»è­¯æˆå¦ä¸€ç¨®å½¢å¼ã€‚ä¾‹å¦‚ï¼Œæ­£å‰‡è¡¨é”å¼ç¶“å¸¸è¢«è½‰æ›ç‚ºç‹€æ…‹æ©Ÿã€‚ä½†å³ä¾¿å¦‚æ­¤ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥è—‰åŠ©è§£é‡‹å™¨æ¨¡å¼ä¾†å¯¦ç¾ç¿»è­¯å™¨ï¼Œå› æ­¤è©²æ¨¡å¼ä»ç„¶é©ç”¨ã€‚ ","permalink":"https://xinqilin.github.io/post/architecture/interpreter/","tags":[],"title":"DesignPattern - Behavioral - Interpreter"},{"content":"è¿­ä»£å™¨æ¨¡å¼ (Iterator Pattern) ç¾ä»£åŒ–å®Œæ•´æŒ‡å— æ¨¡å¼æ¦‚è¿° è¿­ä»£å™¨æ¨¡å¼æ˜¯ä¸€ç¨®è¡Œç‚ºè¨­è¨ˆæ¨¡å¼ï¼Œå®ƒæä¾›ä¸€ç¨®çµ±ä¸€çš„æ–¹å¼ä¾†éæ­·èšåˆå°è±¡ä¸­çš„å…ƒç´ ï¼Œè€Œä¸éœ€è¦æš´éœ²èšåˆå°è±¡çš„å…§éƒ¨çµæ§‹ã€‚åœ¨ç¾ä»£ Java é–‹ç™¼ä¸­ï¼Œè¿­ä»£å™¨æ¨¡å¼ä¸åƒ…åŒ…å«å‚³çµ±çš„ Iterator æ¥å£å¯¦ç¾ï¼Œæ›´æ“´å±•åˆ° Stream APIã€Spring Data åˆ†é å’Œä¼æ¥­ç´šæ•¸æ“šè™•ç†å ´æ™¯ã€‚\næ ¸å¿ƒæ¦‚å¿µ 1. è¿­ä»£å™¨æ¨¡å¼è§£æ±ºçš„å•é¡Œ çµ±ä¸€éæ­·æ¥å£ï¼šç‚ºä¸åŒé¡å‹çš„èšåˆå°è±¡æä¾›ä¸€è‡´çš„éæ­·æ–¹å¼ å°è£å…§éƒ¨çµæ§‹ï¼šéš±è—é›†åˆå…§éƒ¨å¯¦ç¾ç´°ç¯€ æ”¯æŒå¤šç¨®éæ­·ï¼šåŒæ™‚æ”¯æŒå¤šå€‹è¿­ä»£å™¨ä¸¦è¡Œéæ­· å»¶é²åŠ è¼‰ï¼šæ”¯æŒå¤§æ•¸æ“šé›†çš„åˆ†æ‰¹è™•ç†å’Œå»¶é²åŠ è¼‰ å‡½æ•¸å¼ç·¨ç¨‹ï¼šæ•´åˆç¾ä»£ Java å‡½æ•¸å¼ç·¨ç¨‹ç‰¹æ€§ 2. ç¾ä»£è¿­ä»£å™¨æ¶æ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 /** * ç¾ä»£åŒ–è¿­ä»£å™¨æ¥å£è¨­è¨ˆ */ public interface ModernIterator\u0026lt;T\u0026gt; extends Iterator\u0026lt;T\u0026gt; { /** * å‚³çµ±çš„ä¸‹ä¸€å€‹å…ƒç´ æª¢æŸ¥ */ @Override boolean hasNext(); /** * ç²å–ä¸‹ä¸€å€‹å…ƒç´  */ @Override T next(); /** * å¯é¸çš„ç§»é™¤æ“ä½œ */ @Override default void remove() { throw new UnsupportedOperationException(\u0026#34;Remove not supported\u0026#34;); } /** * æ‰¹é‡ç²å–å…ƒç´  */ default List\u0026lt;T\u0026gt; nextBatch(int size) { List\u0026lt;T\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(size); for (int i = 0; i \u0026lt; size \u0026amp;\u0026amp; hasNext(); i++) { batch.add(next()); } return batch; } /** * è½‰æ›ç‚º Stream */ default Stream\u0026lt;T\u0026gt; asStream() { return StreamSupport.stream( Spliterators.spliteratorUnknownSize(this, Spliterator.ORDERED), false ); } /** * å¸¶éæ¿¾çš„è¿­ä»£ */ default ModernIterator\u0026lt;T\u0026gt; filter(Predicate\u0026lt;T\u0026gt; predicate) { return new FilteringIterator\u0026lt;\u0026gt;(this, predicate); } /** * å…ƒç´ è½‰æ› */ default \u0026lt;R\u0026gt; ModernIterator\u0026lt;R\u0026gt; map(Function\u0026lt;T, R\u0026gt; mapper) { return new MappingIterator\u0026lt;\u0026gt;(this, mapper); } } /** * éæ¿¾è¿­ä»£å™¨å¯¦ç¾ */ class FilteringIterator\u0026lt;T\u0026gt; implements ModernIterator\u0026lt;T\u0026gt; { private final ModernIterator\u0026lt;T\u0026gt; source; private final Predicate\u0026lt;T\u0026gt; predicate; private T nextElement; private boolean hasNextElement; public FilteringIterator(ModernIterator\u0026lt;T\u0026gt; source, Predicate\u0026lt;T\u0026gt; predicate) { this.source = source; this.predicate = predicate; advance(); } private void advance() { hasNextElement = false; while (source.hasNext()) { T element = source.next(); if (predicate.test(element)) { nextElement = element; hasNextElement = true; break; } } } @Override public boolean hasNext() { return hasNextElement; } @Override public T next() { if (!hasNextElement) { throw new NoSuchElementException(); } T result = nextElement; advance(); return result; } } /** * æ˜ å°„è¿­ä»£å™¨å¯¦ç¾ */ class MappingIterator\u0026lt;T, R\u0026gt; implements ModernIterator\u0026lt;R\u0026gt; { private final ModernIterator\u0026lt;T\u0026gt; source; private final Function\u0026lt;T, R\u0026gt; mapper; public MappingIterator(ModernIterator\u0026lt;T\u0026gt; source, Function\u0026lt;T, R\u0026gt; mapper) { this.source = source; this.mapper = mapper; } @Override public boolean hasNext() { return source.hasNext(); } @Override public R next() { return mapper.apply(source.next()); } } åŸºç¤å¯¦ä½œç¯„ä¾‹ 1. ä¼æ¥­ç´šå®¢æˆ¶è³‡æ–™è¿­ä»£å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 /** * å®¢æˆ¶è³‡æ–™æ¨¡å‹ */ public class Customer { private String customerId; private String name; private String email; private CustomerType type; private BigDecimal totalOrderAmount; private LocalDateTime createdAt; private boolean active; public Customer(String customerId, String name, String email, CustomerType type) { this.customerId = customerId; this.name = name; this.email = email; this.type = type; this.totalOrderAmount = BigDecimal.ZERO; this.createdAt = LocalDateTime.now(); this.active = true; } // Getters and setters public String getCustomerId() { return customerId; } public void setCustomerId(String customerId) { this.customerId = customerId; } public String getName() { return name; } public void setName(String name) { this.name = name; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public CustomerType getType() { return type; } public void setType(CustomerType type) { this.type = type; } public BigDecimal getTotalOrderAmount() { return totalOrderAmount; } public void setTotalOrderAmount(BigDecimal totalOrderAmount) { this.totalOrderAmount = totalOrderAmount; } public LocalDateTime getCreatedAt() { return createdAt; } public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; } public boolean isActive() { return active; } public void setActive(boolean active) { this.active = active; } @Override public String toString() { return String.format(\u0026#34;Customer{id=\u0026#39;%s\u0026#39;, name=\u0026#39;%s\u0026#39;, type=%s, amount=%s}\u0026#34;, customerId, name, type, totalOrderAmount); } } /** * å®¢æˆ¶é¡å‹æšèˆ‰ */ public enum CustomerType { REGULAR(\u0026#34;ä¸€èˆ¬å®¢æˆ¶\u0026#34;), VIP(\u0026#34;VIPå®¢æˆ¶\u0026#34;), ENTERPRISE(\u0026#34;ä¼æ¥­å®¢æˆ¶\u0026#34;), PREMIUM(\u0026#34;é«˜ç´šå®¢æˆ¶\u0026#34;); private final String description; CustomerType(String description) { this.description = description; } public String getDescription() { return description; } } /** * åˆ†é å®¢æˆ¶è¿­ä»£å™¨ */ public class PagedCustomerIterator implements ModernIterator\u0026lt;Customer\u0026gt; { private final CustomerRepository customerRepository; private final Pageable pageable; private final CustomerCriteria criteria; private Page\u0026lt;Customer\u0026gt; currentPage; private Iterator\u0026lt;Customer\u0026gt; currentPageIterator; private int currentPageNumber = 0; public PagedCustomerIterator(CustomerRepository customerRepository, CustomerCriteria criteria, int pageSize) { this.customerRepository = customerRepository; this.criteria = criteria; this.pageable = PageRequest.of(0, pageSize, Sort.by(\u0026#34;createdAt\u0026#34;).descending()); loadNextPage(); } private void loadNextPage() { Pageable pageRequest = PageRequest.of(currentPageNumber, pageable.getPageSize(), pageable.getSort()); currentPage = customerRepository.findByCriteria(criteria, pageRequest); currentPageIterator = currentPage.getContent().iterator(); } @Override public boolean hasNext() { if (currentPageIterator.hasNext()) { return true; } // æª¢æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€é  if (currentPage.hasNext()) { currentPageNumber++; loadNextPage(); return currentPageIterator.hasNext(); } return false; } @Override public Customer next() { if (!hasNext()) { throw new NoSuchElementException(\u0026#34;No more customers\u0026#34;); } return currentPageIterator.next(); } /** * ç²å–ç¸½æ•¸é‡ */ public long getTotalElements() { return currentPage.getTotalElements(); } /** * ç²å–ç¸½é æ•¸ */ public int getTotalPages() { return currentPage.getTotalPages(); } } /** * å®¢æˆ¶æŸ¥è©¢æ¢ä»¶ */ public class CustomerCriteria { private CustomerType type; private BigDecimal minOrderAmount; private LocalDateTime createdAfter; private LocalDateTime createdBefore; private Boolean active; private String namePattern; public CustomerCriteria() {} // Builder pattern public static CustomerCriteria builder() { return new CustomerCriteria(); } public CustomerCriteria withType(CustomerType type) { this.type = type; return this; } public CustomerCriteria withMinOrderAmount(BigDecimal amount) { this.minOrderAmount = amount; return this; } public CustomerCriteria withCreatedAfter(LocalDateTime date) { this.createdAfter = date; return this; } public CustomerCriteria withCreatedBefore(LocalDateTime date) { this.createdBefore = date; return this; } public CustomerCriteria withActiveStatus(Boolean active) { this.active = active; return this; } public CustomerCriteria withNamePattern(String pattern) { this.namePattern = pattern; return this; } // Getters public CustomerType getType() { return type; } public BigDecimal getMinOrderAmount() { return minOrderAmount; } public LocalDateTime getCreatedAfter() { return createdAfter; } public LocalDateTime getCreatedBefore() { return createdBefore; } public Boolean getActive() { return active; } public String getNamePattern() { return namePattern; } } 2. è¤‡åˆé›†åˆè¿­ä»£å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 /** * è¤‡åˆé›†åˆè¿­ä»£å™¨ - å°‡å¤šå€‹é›†åˆçµ±ä¸€è¿­ä»£ */ public class CompositeIterator\u0026lt;T\u0026gt; implements ModernIterator\u0026lt;T\u0026gt; { private final List\u0026lt;ModernIterator\u0026lt;T\u0026gt;\u0026gt; iterators; private int currentIteratorIndex = 0; @SafeVarargs public CompositeIterator(ModernIterator\u0026lt;T\u0026gt;... iterators) { this.iterators = Arrays.asList(iterators); } public CompositeIterator(List\u0026lt;ModernIterator\u0026lt;T\u0026gt;\u0026gt; iterators) { this.iterators = new ArrayList\u0026lt;\u0026gt;(iterators); } @Override public boolean hasNext() { while (currentIteratorIndex \u0026lt; iterators.size()) { if (iterators.get(currentIteratorIndex).hasNext()) { return true; } currentIteratorIndex++; } return false; } @Override public T next() { if (!hasNext()) { throw new NoSuchElementException(); } return iterators.get(currentIteratorIndex).next(); } /** * ç²å–ç•¶å‰è¿­ä»£å™¨ç´¢å¼• */ public int getCurrentIteratorIndex() { return currentIteratorIndex; } /** * ç²å–è¿­ä»£å™¨ç¸½æ•¸ */ public int getIteratorCount() { return iterators.size(); } } /** * å»¶é²åŠ è¼‰è¿­ä»£å™¨ */ public class LazyLoadingIterator\u0026lt;T\u0026gt; implements ModernIterator\u0026lt;T\u0026gt; { private final Supplier\u0026lt;List\u0026lt;T\u0026gt;\u0026gt; dataProvider; private final int batchSize; private Iterator\u0026lt;T\u0026gt; currentBatch; private boolean dataLoaded = false; public LazyLoadingIterator(Supplier\u0026lt;List\u0026lt;T\u0026gt;\u0026gt; dataProvider, int batchSize) { this.dataProvider = dataProvider; this.batchSize = batchSize; } private void ensureDataLoaded() { if (!dataLoaded) { List\u0026lt;T\u0026gt; data = dataProvider.get(); currentBatch = data.iterator(); dataLoaded = true; } } @Override public boolean hasNext() { ensureDataLoaded(); return currentBatch.hasNext(); } @Override public T next() { ensureDataLoaded(); return currentBatch.next(); } } 3. ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 /** * è¿­ä»£å™¨ä½¿ç”¨ç¯„ä¾‹ */ public class IteratorUsageExample { public static void main(String[] args) { // å‰µå»ºæ¸¬è©¦æ•¸æ“š List\u0026lt;Customer\u0026gt; customers = createTestCustomers(); // 1. åŸºæœ¬è¿­ä»£å™¨ä½¿ç”¨ System.out.println(\u0026#34;=== åŸºæœ¬è¿­ä»£å™¨ä½¿ç”¨ ===\u0026#34;); demonstrateBasicIteration(customers); // 2. éæ¿¾å’Œè½‰æ› System.out.println(\u0026#34;\\n=== éæ¿¾å’Œè½‰æ› ===\u0026#34;); demonstrateFilteringAndMapping(customers); // 3. å¾©åˆè¿­ä»£å™¨ System.out.println(\u0026#34;\\n=== å¾©åˆè¿­ä»£å™¨ ===\u0026#34;); demonstrateCompositeIterator(customers); // 4. Stream API æ•´åˆ System.out.println(\u0026#34;\\n=== Stream API æ•´åˆ ===\u0026#34;); demonstrateStreamIntegration(customers); } private static void demonstrateBasicIteration(List\u0026lt;Customer\u0026gt; customers) { ModernIterator\u0026lt;Customer\u0026gt; iterator = new ListIteratorAdapter\u0026lt;\u0026gt;(customers); int count = 0; while (iterator.hasNext() \u0026amp;\u0026amp; count \u0026lt; 3) { Customer customer = iterator.next(); System.out.println(\u0026#34;å®¢æˆ¶: \u0026#34; + customer); count++; } } private static void demonstrateFilteringAndMapping(List\u0026lt;Customer\u0026gt; customers) { ModernIterator\u0026lt;Customer\u0026gt; iterator = new ListIteratorAdapter\u0026lt;\u0026gt;(customers); // éæ¿¾ VIP å®¢æˆ¶ä¸¦è½‰æ›ç‚ºéƒµä»¶åœ°å€ ModernIterator\u0026lt;String\u0026gt; emailIterator = iterator .filter(customer -\u0026gt; customer.getType() == CustomerType.VIP) .map(Customer::getEmail); System.out.println(\u0026#34;VIP å®¢æˆ¶éƒµä»¶åœ°å€:\u0026#34;); while (emailIterator.hasNext()) { System.out.println(\u0026#34;- \u0026#34; + emailIterator.next()); } } private static void demonstrateCompositeIterator(List\u0026lt;Customer\u0026gt; customers) { // å°‡å®¢æˆ¶æŒ‰é¡å‹åˆ†çµ„ List\u0026lt;Customer\u0026gt; regularCustomers = customers.stream() .filter(c -\u0026gt; c.getType() == CustomerType.REGULAR) .collect(Collectors.toList()); List\u0026lt;Customer\u0026gt; vipCustomers = customers.stream() .filter(c -\u0026gt; c.getType() == CustomerType.VIP) .collect(Collectors.toList()); // å‰µå»ºå¾©åˆè¿­ä»£å™¨ CompositeIterator\u0026lt;Customer\u0026gt; compositeIterator = new CompositeIterator\u0026lt;\u0026gt;( new ListIteratorAdapter\u0026lt;\u0026gt;(regularCustomers), new ListIteratorAdapter\u0026lt;\u0026gt;(vipCustomers) ); System.out.println(\u0026#34;å¾©åˆè¿­ä»£å™¨éæ­·:\u0026#34;); while (compositeIterator.hasNext()) { Customer customer = compositeIterator.next(); System.out.println(String.format(\u0026#34;è¿­ä»£å™¨ %d: %s\u0026#34;, compositeIterator.getCurrentIteratorIndex(), customer.getName())); } } private static void demonstrateStreamIntegration(List\u0026lt;Customer\u0026gt; customers) { ModernIterator\u0026lt;Customer\u0026gt; iterator = new ListIteratorAdapter\u0026lt;\u0026gt;(customers); // è½‰æ›ç‚º Stream ä¸¦é€²è¡Œè¤‡é›œæ“ä½œ Map\u0026lt;CustomerType, BigDecimal\u0026gt; totalByType = iterator.asStream() .collect(Collectors.groupingBy( Customer::getType, Collectors.reducing(BigDecimal.ZERO, Customer::getTotalOrderAmount, BigDecimal::add) )); System.out.println(\u0026#34;å„é¡å‹å®¢æˆ¶ç¸½è¨‚å–®é‡‘é¡:\u0026#34;); totalByType.forEach((type, total) -\u0026gt; System.out.println(String.format(\u0026#34;%s: $%s\u0026#34;, type.getDescription(), total))); } private static List\u0026lt;Customer\u0026gt; createTestCustomers() { List\u0026lt;Customer\u0026gt; customers = new ArrayList\u0026lt;\u0026gt;(); Customer customer1 = new Customer(\u0026#34;C001\u0026#34;, \u0026#34;å¼µä¸‰\u0026#34;, \u0026#34;zhangsan@example.com\u0026#34;, CustomerType.REGULAR); customer1.setTotalOrderAmount(new BigDecimal(\u0026#34;1500.00\u0026#34;)); Customer customer2 = new Customer(\u0026#34;C002\u0026#34;, \u0026#34;æå››\u0026#34;, \u0026#34;lisi@example.com\u0026#34;, CustomerType.VIP); customer2.setTotalOrderAmount(new BigDecimal(\u0026#34;5000.00\u0026#34;)); Customer customer3 = new Customer(\u0026#34;C003\u0026#34;, \u0026#34;ç‹äº”\u0026#34;, \u0026#34;wangwu@example.com\u0026#34;, CustomerType.ENTERPRISE); customer3.setTotalOrderAmount(new BigDecimal(\u0026#34;25000.00\u0026#34;)); Customer customer4 = new Customer(\u0026#34;C004\u0026#34;, \u0026#34;è¶™å…­\u0026#34;, \u0026#34;zhaoliu@example.com\u0026#34;, CustomerType.VIP); customer4.setTotalOrderAmount(new BigDecimal(\u0026#34;8000.00\u0026#34;)); customers.addAll(Arrays.asList(customer1, customer2, customer3, customer4)); return customers; } } /** * List é©é…å™¨ */ class ListIteratorAdapter\u0026lt;T\u0026gt; implements ModernIterator\u0026lt;T\u0026gt; { private final Iterator\u0026lt;T\u0026gt; iterator; public ListIteratorAdapter(List\u0026lt;T\u0026gt; list) { this.iterator = list.iterator(); } @Override public boolean hasNext() { return iterator.hasNext(); } @Override public T next() { return iterator.next(); } } Spring Boot æ•´åˆ 1. Spring Data åˆ†é è¿­ä»£å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 /** * Spring Data Repository */ @Repository public interface CustomerRepository extends JpaRepository\u0026lt;Customer, String\u0026gt; { /** * æ ¹æ“šæ¢ä»¶åˆ†é æŸ¥è©¢ */ @Query(\u0026#34;SELECT c FROM Customer c WHERE \u0026#34; + \u0026#34;(:#{#criteria.type} IS NULL OR c.type = :#{#criteria.type}) AND \u0026#34; + \u0026#34;(:#{#criteria.minOrderAmount} IS NULL OR c.totalOrderAmount \u0026gt;= :#{#criteria.minOrderAmount}) AND \u0026#34; + \u0026#34;(:#{#criteria.active} IS NULL OR c.active = :#{#criteria.active}) AND \u0026#34; + \u0026#34;(:#{#criteria.namePattern} IS NULL OR c.name LIKE %:#{#criteria.namePattern}%) AND \u0026#34; + \u0026#34;(:#{#criteria.createdAfter} IS NULL OR c.createdAt \u0026gt;= :#{#criteria.createdAfter}) AND \u0026#34; + \u0026#34;(:#{#criteria.createdBefore} IS NULL OR c.createdAt \u0026lt;= :#{#criteria.createdBefore})\u0026#34;) Page\u0026lt;Customer\u0026gt; findByCriteria(@Param(\u0026#34;criteria\u0026#34;) CustomerCriteria criteria, Pageable pageable); /** * æµå¼æŸ¥è©¢ - é©åˆå¤§æ•¸æ“šé‡è™•ç† */ @Query(\u0026#34;SELECT c FROM Customer c WHERE c.active = true\u0026#34;) Stream\u0026lt;Customer\u0026gt; findAllActiveCustomersAsStream(); /** * æŒ‰é¡å‹æŸ¥è©¢ */ Page\u0026lt;Customer\u0026gt; findByType(CustomerType type, Pageable pageable); /** * æŸ¥è©¢è¨‚å–®é‡‘é¡ç¯„åœå…§çš„å®¢æˆ¶ */ Page\u0026lt;Customer\u0026gt; findByTotalOrderAmountBetween(BigDecimal min, BigDecimal max, Pageable pageable); } /** * Spring Boot è¿­ä»£å™¨æœå‹™ */ @Service @Transactional(readOnly = true) public class CustomerIteratorService { private final CustomerRepository customerRepository; private final Logger logger = LoggerFactory.getLogger(CustomerIteratorService.class); public CustomerIteratorService(CustomerRepository customerRepository) { this.customerRepository = customerRepository; } /** * å‰µå»ºåˆ†é å®¢æˆ¶è¿­ä»£å™¨ */ public PagedCustomerIterator createPagedIterator(CustomerCriteria criteria, int pageSize) { logger.info(\u0026#34;å‰µå»ºåˆ†é è¿­ä»£å™¨: criteria={}, pageSize={}\u0026#34;, criteria, pageSize); return new PagedCustomerIterator(customerRepository, criteria, pageSize); } /** * å‰µå»ºæµå¼è¿­ä»£å™¨ */ public Stream\u0026lt;Customer\u0026gt; createStreamIterator() { logger.info(\u0026#34;å‰µå»ºæµå¼è¿­ä»£å™¨\u0026#34;); return customerRepository.findAllActiveCustomersAsStream(); } /** * æ‰¹é‡è™•ç†å®¢æˆ¶æ•¸æ“š */ public void processBatchCustomers(CustomerCriteria criteria, int batchSize, Consumer\u0026lt;List\u0026lt;Customer\u0026gt;\u0026gt; processor) { PagedCustomerIterator iterator = createPagedIterator(criteria, batchSize); while (iterator.hasNext()) { List\u0026lt;Customer\u0026gt; batch = iterator.nextBatch(batchSize); processor.accept(batch); logger.debug(\u0026#34;è™•ç†æ‰¹æ¬¡: {} å®¢æˆ¶\u0026#34;, batch.size()); } logger.info(\u0026#34;æ‰¹æ¬¡è™•ç†å®Œæˆï¼Œç¸½å®¢æˆ¶æ•¸: {}\u0026#34;, iterator.getTotalElements()); } /** * ç•°æ­¥è¿­ä»£è™•ç† */ @Async public CompletableFuture\u0026lt;ProcessingResult\u0026gt; processCustomersAsync(CustomerCriteria criteria, Function\u0026lt;Customer, String\u0026gt; processor) { return CompletableFuture.supplyAsync(() -\u0026gt; { PagedCustomerIterator iterator = createPagedIterator(criteria, 100); List\u0026lt;String\u0026gt; results = new ArrayList\u0026lt;\u0026gt;(); int processedCount = 0; while (iterator.hasNext()) { Customer customer = iterator.next(); String result = processor.apply(customer); results.add(result); processedCount++; if (processedCount % 100 == 0) { logger.info(\u0026#34;å·²è™•ç† {} å®¢æˆ¶\u0026#34;, processedCount); } } return new ProcessingResult(processedCount, results); }); } /** * æŒ‰é¡å‹ä¸¦è¡Œè™•ç† */ public Map\u0026lt;CustomerType, Long\u0026gt; countCustomersByTypeParallel() { return Arrays.stream(CustomerType.values()) .parallel() .collect(Collectors.toMap( type -\u0026gt; type, type -\u0026gt; { PagedCustomerIterator iterator = createPagedIterator( CustomerCriteria.builder().withType(type), 1000); return iterator.getTotalElements(); } )); } } /** * è™•ç†çµæœ */ public class ProcessingResult { private final int processedCount; private final List\u0026lt;String\u0026gt; results; private final LocalDateTime timestamp; public ProcessingResult(int processedCount, List\u0026lt;String\u0026gt; results) { this.processedCount = processedCount; this.results = results; this.timestamp = LocalDateTime.now(); } // Getters public int getProcessedCount() { return processedCount; } public List\u0026lt;String\u0026gt; getResults() { return results; } public LocalDateTime getTimestamp() { return timestamp; } @Override public String toString() { return String.format(\u0026#34;ProcessingResult{processedCount=%d, resultsSize=%d, timestamp=%s}\u0026#34;, processedCount, results.size(), timestamp); } } 2. Spring Boot é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 /** * è¿­ä»£å™¨æ¨¡å¼é…ç½® */ @Configuration @EnableAsync @EnableConfigurationProperties(IteratorProperties.class) public class IteratorPatternConfig { /** * ç•°æ­¥åŸ·è¡Œå™¨é…ç½® */ @Bean(name = \u0026#34;customerProcessingExecutor\u0026#34;) public TaskExecutor customerProcessingExecutor() { ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(4); executor.setMaxPoolSize(8); executor.setQueueCapacity(100); executor.setThreadNamePrefix(\u0026#34;customer-processing-\u0026#34;); executor.initialize(); return executor; } /** * åˆ†é é…ç½® */ @Bean public PageableExecutionUtils pageableExecutionUtils() { return new PageableExecutionUtils(); } } /** * è¿­ä»£å™¨é…ç½®å±¬æ€§ */ @ConfigurationProperties(prefix = \u0026#34;app.iterator\u0026#34;) @Data public class IteratorProperties { /** * é è¨­åˆ†é å¤§å° */ private int defaultPageSize = 50; /** * æœ€å¤§åˆ†é å¤§å° */ private int maxPageSize = 1000; /** * æ‰¹æ¬¡è™•ç†å¤§å° */ private int batchSize = 100; /** * æ˜¯å¦å•Ÿç”¨å¿«å– */ private boolean cacheEnabled = true; /** * å¿«å–éæœŸæ™‚é–“ï¼ˆåˆ†é˜ï¼‰ */ private int cacheExpirationMinutes = 30; } 3. REST API æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 /** * å®¢æˆ¶è¿­ä»£å™¨ REST API */ @RestController @RequestMapping(\u0026#34;/api/customers\u0026#34;) @Validated public class CustomerIteratorController { private final CustomerIteratorService customerIteratorService; private final IteratorProperties iteratorProperties; public CustomerIteratorController(CustomerIteratorService customerIteratorService, IteratorProperties iteratorProperties) { this.customerIteratorService = customerIteratorService; this.iteratorProperties = iteratorProperties; } /** * åˆ†é æŸ¥è©¢å®¢æˆ¶ */ @GetMapping(\u0026#34;/paged\u0026#34;) public ResponseEntity\u0026lt;PagedCustomerResponse\u0026gt; getPagedCustomers( @RequestParam(defaultValue = \u0026#34;0\u0026#34;) int page, @RequestParam(required = false) Integer size, @RequestParam(required = false) String type, @RequestParam(required = false) String minAmount, @RequestParam(required = false) Boolean active, @RequestParam(required = false) String namePattern) { // å»ºæ§‹æŸ¥è©¢æ¢ä»¶ CustomerCriteria criteria = CustomerCriteria.builder(); if (type != null) { criteria.withType(CustomerType.valueOf(type.toUpperCase())); } if (minAmount != null) { criteria.withMinOrderAmount(new BigDecimal(minAmount)); } if (active != null) { criteria.withActiveStatus(active); } if (namePattern != null) { criteria.withNamePattern(namePattern); } int pageSize = size != null ? Math.min(size, iteratorProperties.getMaxPageSize()) : iteratorProperties.getDefaultPageSize(); PagedCustomerIterator iterator = customerIteratorService.createPagedIterator(criteria, pageSize); // ç²å–ç•¶å‰é é¢æ•¸æ“š List\u0026lt;Customer\u0026gt; customers = new ArrayList\u0026lt;\u0026gt;(); int currentPage = 0; // è·³åˆ°æŒ‡å®šé é¢ while (currentPage \u0026lt; page \u0026amp;\u0026amp; iterator.hasNext()) { iterator.nextBatch(pageSize); currentPage++; } // ç²å–ç•¶å‰é é¢æ•¸æ“š if (iterator.hasNext()) { customers = iterator.nextBatch(pageSize); } PagedCustomerResponse response = new PagedCustomerResponse( customers, page, pageSize, iterator.getTotalElements(), iterator.getTotalPages()); return ResponseEntity.ok(response); } /** * æ‰¹æ¬¡è™•ç†å®¢æˆ¶ */ @PostMapping(\u0026#34;/batch-process\u0026#34;) public ResponseEntity\u0026lt;BatchProcessResponse\u0026gt; batchProcessCustomers( @RequestBody @Valid BatchProcessRequest request) { CustomerCriteria criteria = buildCriteriaFromRequest(request); AtomicInteger processedCount = new AtomicInteger(0); List\u0026lt;String\u0026gt; results = new ArrayList\u0026lt;\u0026gt;(); customerIteratorService.processBatchCustomers(criteria, request.getBatchSize(), batch -\u0026gt; { batch.forEach(customer -\u0026gt; { // åŸ·è¡Œè™•ç†é‚è¼¯ String result = processCustomer(customer, request.getProcessingType()); results.add(result); processedCount.incrementAndGet(); }); }); return ResponseEntity.ok(new BatchProcessResponse(processedCount.get(), results)); } /** * ç•°æ­¥è™•ç†å®¢æˆ¶ */ @PostMapping(\u0026#34;/async-process\u0026#34;) public ResponseEntity\u0026lt;AsyncProcessResponse\u0026gt; asyncProcessCustomers( @RequestBody @Valid AsyncProcessRequest request) { CustomerCriteria criteria = buildCriteriaFromRequest(request); CompletableFuture\u0026lt;ProcessingResult\u0026gt; future = customerIteratorService.processCustomersAsync( criteria, customer -\u0026gt; processCustomer(customer, request.getProcessingType())); // è¿”å›è™•ç† ID ä¾›å®¢æˆ¶ç«¯æŸ¥è©¢é€²åº¦ String processId = UUID.randomUUID().toString(); // é€™è£¡æ‡‰è©²å°‡ future å­˜å„²èµ·ä¾†ä»¥ä¾›å¾ŒçºŒæŸ¥è©¢ return ResponseEntity.accepted().body(new AsyncProcessResponse(processId, \u0026#34;è™•ç†å·²é–‹å§‹\u0026#34;)); } /** * ç²å–çµ±è¨ˆä¿¡æ¯ */ @GetMapping(\u0026#34;/statistics\u0026#34;) public ResponseEntity\u0026lt;CustomerStatistics\u0026gt; getCustomerStatistics() { Map\u0026lt;CustomerType, Long\u0026gt; countsByType = customerIteratorService.countCustomersByTypeParallel(); CustomerStatistics statistics = new CustomerStatistics(countsByType); return ResponseEntity.ok(statistics); } private CustomerCriteria buildCriteriaFromRequest(Object request) { // ç°¡åŒ–å¯¦ç¾ï¼Œå¯¦éš›æ‡‰æ ¹æ“šè«‹æ±‚é¡å‹æ§‹å»ºæ¢ä»¶ return CustomerCriteria.builder(); } private String processCustomer(Customer customer, String processingType) { // æ ¹æ“šè™•ç†é¡å‹åŸ·è¡Œä¸åŒé‚è¼¯ switch (processingType.toUpperCase()) { case \u0026#34;EMAIL_NOTIFICATION\u0026#34;: return \u0026#34;å·²ç™¼é€éƒµä»¶é€šçŸ¥çµ¦: \u0026#34; + customer.getEmail(); case \u0026#34;LOYALTY_POINTS\u0026#34;: return \u0026#34;å·²è¨ˆç®—å¿ èª åº¦ç©åˆ†: \u0026#34; + customer.getCustomerId(); case \u0026#34;DATA_EXPORT\u0026#34;: return \u0026#34;å·²åŒ¯å‡ºæ•¸æ“š: \u0026#34; + customer.toString(); default: return \u0026#34;å·²è™•ç†å®¢æˆ¶: \u0026#34; + customer.getCustomerId(); } } } /** * è«‹æ±‚å’Œå›æ‡‰ DTO */ @Data public class BatchProcessRequest { @NotNull private String processingType; @Min(1) @Max(1000) private int batchSize = 100; private String customerType; private String minOrderAmount; private Boolean active; private String namePattern; } @Data public class AsyncProcessRequest { @NotNull private String processingType; private String customerType; private String minOrderAmount; private Boolean active; private String namePattern; } @Data public class PagedCustomerResponse { private List\u0026lt;Customer\u0026gt; customers; private int currentPage; private int pageSize; private long totalElements; private int totalPages; private LocalDateTime timestamp; public PagedCustomerResponse(List\u0026lt;Customer\u0026gt; customers, int currentPage, int pageSize, long totalElements, int totalPages) { this.customers = customers; this.currentPage = currentPage; this.pageSize = pageSize; this.totalElements = totalElements; this.totalPages = totalPages; this.timestamp = LocalDateTime.now(); } } @Data public class BatchProcessResponse { private int processedCount; private List\u0026lt;String\u0026gt; results; private LocalDateTime timestamp; public BatchProcessResponse(int processedCount, List\u0026lt;String\u0026gt; results) { this.processedCount = processedCount; this.results = results; this.timestamp = LocalDateTime.now(); } } @Data public class AsyncProcessResponse { private String processId; private String message; private LocalDateTime timestamp; public AsyncProcessResponse(String processId, String message) { this.processId = processId; this.message = message; this.timestamp = LocalDateTime.now(); } } @Data public class CustomerStatistics { private Map\u0026lt;CustomerType, Long\u0026gt; countsByType; private long totalCustomers; private LocalDateTime timestamp; public CustomerStatistics(Map\u0026lt;CustomerType, Long\u0026gt; countsByType) { this.countsByType = countsByType; this.totalCustomers = countsByType.values().stream().mapToLong(Long::longValue).sum(); this.timestamp = LocalDateTime.now(); } } é€²éšä¸»é¡Œ 1. æ•ˆèƒ½å„ªåŒ–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 /** * é«˜æ•ˆèƒ½è¿­ä»£å™¨å¯¦ç¾ */ @Component public class OptimizedIteratorService { private final Cache\u0026lt;String, List\u0026lt;Customer\u0026gt;\u0026gt; iteratorCache; private final ExecutorService executorService; public OptimizedIteratorService() { this.iteratorCache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(15, TimeUnit.MINUTES) .recordStats() .build(); this.executorService = ForkJoinPool.commonPool(); } /** * å¸¶å¿«å–çš„åˆ†é è¿­ä»£å™¨ */ public ModernIterator\u0026lt;Customer\u0026gt; createCachedIterator(CustomerCriteria criteria, int pageSize) { String cacheKey = generateCacheKey(criteria, pageSize); List\u0026lt;Customer\u0026gt; cachedData = iteratorCache.getIfPresent(cacheKey); if (cachedData != null) { return new ListIteratorAdapter\u0026lt;\u0026gt;(cachedData); } return new CachingIterator\u0026lt;\u0026gt;(criteria, pageSize, iteratorCache, cacheKey); } /** * ä¸¦è¡Œè™•ç†è¿­ä»£å™¨ */ public \u0026lt;R\u0026gt; CompletableFuture\u0026lt;List\u0026lt;R\u0026gt;\u0026gt; processInParallel(ModernIterator\u0026lt;Customer\u0026gt; iterator, Function\u0026lt;Customer, R\u0026gt; processor, int parallelism) { return CompletableFuture.supplyAsync(() -\u0026gt; { List\u0026lt;Customer\u0026gt; customers = new ArrayList\u0026lt;\u0026gt;(); while (iterator.hasNext()) { customers.add(iterator.next()); } return customers.parallelStream() .map(processor) .collect(Collectors.toList()); }, executorService); } /** * æ‰¹æ¬¡è™•ç†å„ªåŒ– */ public void processInBatchesOptimized(ModernIterator\u0026lt;Customer\u0026gt; iterator, Consumer\u0026lt;List\u0026lt;Customer\u0026gt;\u0026gt; processor, int batchSize) { List\u0026lt;Customer\u0026gt; batch = new ArrayList\u0026lt;\u0026gt;(batchSize); while (iterator.hasNext()) { batch.add(iterator.next()); if (batch.size() \u0026gt;= batchSize) { processor.accept(new ArrayList\u0026lt;\u0026gt;(batch)); batch.clear(); } } // è™•ç†å‰©é¤˜å…ƒç´  if (!batch.isEmpty()) { processor.accept(batch); } } private String generateCacheKey(CustomerCriteria criteria, int pageSize) { return String.format(\u0026#34;customers_%s_%d\u0026#34;, criteria.hashCode(), pageSize); } } /** * å¿«å–è¿­ä»£å™¨å¯¦ç¾ */ class CachingIterator\u0026lt;T\u0026gt; implements ModernIterator\u0026lt;T\u0026gt; { private final Iterator\u0026lt;T\u0026gt; delegate; private final List\u0026lt;T\u0026gt; cache = new ArrayList\u0026lt;\u0026gt;(); private final Cache\u0026lt;String, List\u0026lt;T\u0026gt;\u0026gt; globalCache; private final String cacheKey; public CachingIterator(CustomerCriteria criteria, int pageSize, Cache\u0026lt;String, List\u0026lt;T\u0026gt;\u0026gt; globalCache, String cacheKey) { this.globalCache = globalCache; this.cacheKey = cacheKey; // å¯¦éš›å¾æ•¸æ“šåº«åŠ è¼‰æ•¸æ“šçš„é‚è¼¯ List\u0026lt;T\u0026gt; data = loadDataFromDatabase(criteria, pageSize); this.delegate = data.iterator(); } @Override public boolean hasNext() { return delegate.hasNext(); } @Override public T next() { T element = delegate.next(); cache.add(element); // ç•¶è¿­ä»£å®Œæˆæ™‚ï¼Œå°‡æ•¸æ“šåŠ å…¥å¿«å– if (!delegate.hasNext()) { globalCache.put(cacheKey, new ArrayList\u0026lt;\u0026gt;(cache)); } return element; } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) private List\u0026lt;T\u0026gt; loadDataFromDatabase(CustomerCriteria criteria, int pageSize) { // ç°¡åŒ–å¯¦ç¾ï¼Œå¯¦éš›æ‡‰è©²èª¿ç”¨æ•¸æ“šåº«æœå‹™ return (List\u0026lt;T\u0026gt;) new ArrayList\u0026lt;Customer\u0026gt;(); } } 2. æ¸¬è©¦ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 /** * è¿­ä»£å™¨æ¨¡å¼æ¸¬è©¦ */ @ExtendWith(MockitoExtension.class) class IteratorPatternTest { @Mock private CustomerRepository customerRepository; @InjectMocks private CustomerIteratorService customerIteratorService; @Test void testPagedIteratorBasicFunctionality() { // Given CustomerCriteria criteria = CustomerCriteria.builder().withType(CustomerType.VIP); List\u0026lt;Customer\u0026gt; customers = createTestCustomers(); Page\u0026lt;Customer\u0026gt; page = new PageImpl\u0026lt;\u0026gt;(customers); when(customerRepository.findByCriteria(eq(criteria), any(Pageable.class))) .thenReturn(page); // When PagedCustomerIterator iterator = customerIteratorService.createPagedIterator(criteria, 2); // Then assertThat(iterator.hasNext()).isTrue(); Customer first = iterator.next(); assertThat(first).isNotNull(); assertThat(iterator.getTotalElements()).isEqualTo(customers.size()); } @Test void testModernIteratorFiltering() { // Given List\u0026lt;Customer\u0026gt; customers = createTestCustomers(); ModernIterator\u0026lt;Customer\u0026gt; iterator = new ListIteratorAdapter\u0026lt;\u0026gt;(customers); // When ModernIterator\u0026lt;Customer\u0026gt; filteredIterator = iterator.filter( customer -\u0026gt; customer.getType() == CustomerType.VIP); // Then List\u0026lt;Customer\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); while (filteredIterator.hasNext()) { result.add(filteredIterator.next()); } assertThat(result).allMatch(customer -\u0026gt; customer.getType() == CustomerType.VIP); } @Test void testModernIteratorMapping() { // Given List\u0026lt;Customer\u0026gt; customers = createTestCustomers(); ModernIterator\u0026lt;Customer\u0026gt; iterator = new ListIteratorAdapter\u0026lt;\u0026gt;(customers); // When ModernIterator\u0026lt;String\u0026gt; emailIterator = iterator.map(Customer::getEmail); // Then List\u0026lt;String\u0026gt; emails = new ArrayList\u0026lt;\u0026gt;(); while (emailIterator.hasNext()) { emails.add(emailIterator.next()); } assertThat(emails).hasSize(customers.size()); assertThat(emails).allMatch(email -\u0026gt; email.contains(\u0026#34;@\u0026#34;)); } @Test void testCompositeIterator() { // Given List\u0026lt;Customer\u0026gt; batch1 = createTestCustomers().subList(0, 2); List\u0026lt;Customer\u0026gt; batch2 = createTestCustomers().subList(2, 4); CompositeIterator\u0026lt;Customer\u0026gt; compositeIterator = new CompositeIterator\u0026lt;\u0026gt;( new ListIteratorAdapter\u0026lt;\u0026gt;(batch1), new ListIteratorAdapter\u0026lt;\u0026gt;(batch2) ); // When List\u0026lt;Customer\u0026gt; result = new ArrayList\u0026lt;\u0026gt;(); while (compositeIterator.hasNext()) { result.add(compositeIterator.next()); } // Then assertThat(result).hasSize(4); } @Test void testStreamIntegration() { // Given List\u0026lt;Customer\u0026gt; customers = createTestCustomers(); ModernIterator\u0026lt;Customer\u0026gt; iterator = new ListIteratorAdapter\u0026lt;\u0026gt;(customers); // When long vipCount = iterator.asStream() .filter(customer -\u0026gt; customer.getType() == CustomerType.VIP) .count(); // Then long expectedVipCount = customers.stream() .filter(customer -\u0026gt; customer.getType() == CustomerType.VIP) .count(); assertThat(vipCount).isEqualTo(expectedVipCount); } private List\u0026lt;Customer\u0026gt; createTestCustomers() { return Arrays.asList( new Customer(\u0026#34;C001\u0026#34;, \u0026#34;æ¸¬è©¦1\u0026#34;, \u0026#34;test1@example.com\u0026#34;, CustomerType.REGULAR), new Customer(\u0026#34;C002\u0026#34;, \u0026#34;æ¸¬è©¦2\u0026#34;, \u0026#34;test2@example.com\u0026#34;, CustomerType.VIP), new Customer(\u0026#34;C003\u0026#34;, \u0026#34;æ¸¬è©¦3\u0026#34;, \u0026#34;test3@example.com\u0026#34;, CustomerType.ENTERPRISE), new Customer(\u0026#34;C004\u0026#34;, \u0026#34;æ¸¬è©¦4\u0026#34;, \u0026#34;test4@example.com\u0026#34;, CustomerType.VIP) ); } } /** * Spring Boot æ•´åˆæ¸¬è©¦ */ @SpringBootTest @TestPropertySource(properties = { \u0026#34;app.iterator.default-page-size=10\u0026#34;, \u0026#34;app.iterator.max-page-size=100\u0026#34; }) class IteratorPatternIntegrationTest { @Autowired private CustomerIteratorService customerIteratorService; @Autowired private CustomerRepository customerRepository; @Test @Transactional void testPaginatedIteratorWithDatabase() { // Given saveTestCustomers(); CustomerCriteria criteria = CustomerCriteria.builder(); // When PagedCustomerIterator iterator = customerIteratorService.createPagedIterator(criteria, 2); // Then assertThat(iterator.hasNext()).isTrue(); assertThat(iterator.getTotalElements()).isGreaterThan(0); List\u0026lt;Customer\u0026gt; firstBatch = iterator.nextBatch(2); assertThat(firstBatch).hasSizeLessThanOrEqualTo(2); } @Test void testBatchProcessing() { // Given saveTestCustomers(); CustomerCriteria criteria = CustomerCriteria.builder().withActiveStatus(true); AtomicInteger processedCount = new AtomicInteger(0); // When customerIteratorService.processBatchCustomers(criteria, 5, batch -\u0026gt; { processedCount.addAndGet(batch.size()); }); // Then assertThat(processedCount.get()).isGreaterThan(0); } private void saveTestCustomers() { List\u0026lt;Customer\u0026gt; customers = createTestCustomers(); customerRepository.saveAll(customers); } private List\u0026lt;Customer\u0026gt; createTestCustomers() { return Arrays.asList( new Customer(\u0026#34;IT001\u0026#34;, \u0026#34;æ•´åˆæ¸¬è©¦1\u0026#34;, \u0026#34;integration1@example.com\u0026#34;, CustomerType.REGULAR), new Customer(\u0026#34;IT002\u0026#34;, \u0026#34;æ•´åˆæ¸¬è©¦2\u0026#34;, \u0026#34;integration2@example.com\u0026#34;, CustomerType.VIP), new Customer(\u0026#34;IT003\u0026#34;, \u0026#34;æ•´åˆæ¸¬è©¦3\u0026#34;, \u0026#34;integration3@example.com\u0026#34;, CustomerType.ENTERPRISE) ); } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. è¨­è¨ˆåŸå‰‡ è²¬ä»»åˆ†é›¢ï¼šå°‡è¿­ä»£é‚è¼¯èˆ‡æ¥­å‹™é‚è¼¯åˆ†é›¢ å»¶é²åŠ è¼‰ï¼šå°å¤§æ•¸æ“šé›†æ¡ç”¨åˆ†é æˆ–æµå¼è™•ç† è¨˜æ†¶é«”æ•ˆç‡ï¼šé¿å…ä¸€æ¬¡åŠ è¼‰æ‰€æœ‰æ•¸æ“šåˆ°è¨˜æ†¶é«” ç•°å¸¸å®‰å…¨ï¼šç¢ºä¿è¿­ä»£éç¨‹ä¸­çš„ç•°å¸¸å¾—åˆ°é©ç•¶è™•ç† 2. å¸¸è¦‹é™·é˜± é¿å…åœ¨è¿­ä»£éç¨‹ä¸­ä¿®æ”¹é›†åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // âŒ éŒ¯èª¤çš„è¨­è¨ˆ - åœ¨è¿­ä»£ä¸­ä¿®æ”¹é›†åˆ List\u0026lt;Customer\u0026gt; customers = getCustomers(); for (Customer customer : customers) { if (customer.isInactive()) { customers.remove(customer); // ConcurrentModificationException } } // âœ… æ­£ç¢ºçš„è¨­è¨ˆ - ä½¿ç”¨ Iterator.remove() æˆ–æ”¶é›†å¾Œæ‰¹é‡è™•ç† Iterator\u0026lt;Customer\u0026gt; iterator = customers.iterator(); while (iterator.hasNext()) { Customer customer = iterator.next(); if (customer.isInactive()) { iterator.remove(); } } æ­£ç¢ºè™•ç†è³‡æºé‡‹æ”¾ 1 2 3 4 5 6 // âœ… ä½¿ç”¨ try-with-resources ç¢ºä¿è³‡æºé‡‹æ”¾ try (Stream\u0026lt;Customer\u0026gt; customerStream = customerRepository.findAllActiveCustomersAsStream()) { customerStream .filter(customer -\u0026gt; customer.getType() == CustomerType.VIP) .forEach(this::processVipCustomer); } 3. ä½¿ç”¨å»ºè­° é©ç”¨å ´æ™¯ï¼šå¤§æ•¸æ“šé›†éæ­·ã€åˆ†é è™•ç†ã€æµå¼æ•¸æ“šè™•ç† Spring Data æ•´åˆï¼šå–„ç”¨ Pageã€Slice å’Œ Stream æŸ¥è©¢ æ•ˆèƒ½å„ªåŒ–ï¼šè€ƒæ…®ä½¿ç”¨å¿«å–ã€ç•°æ­¥è™•ç†å’Œä¸¦è¡Œæµ ç¸½çµ ç¾ä»£åŒ–çš„è¿­ä»£å™¨æ¨¡å¼ä¸åƒ…åŒ…å«å‚³çµ±çš„éæ­·åŠŸèƒ½ï¼Œæ›´æ•´åˆäº† Java 8+ çš„ Stream APIã€Spring Data çš„åˆ†é æ©Ÿåˆ¶ï¼Œä»¥åŠä¼æ¥­ç´šçš„æ‰¹é‡è™•ç†èƒ½åŠ›ã€‚é€šéåˆç†é‹ç”¨é€™äº›ç¾ä»£ç‰¹æ€§ï¼Œå¯ä»¥æ§‹å»ºé«˜æ•ˆã€å¯æ“´å±•çš„æ•¸æ“šè™•ç†ç³»çµ±ã€‚\nä¸»è¦å„ªé» çµ±ä¸€æ¥å£ï¼šæä¾›ä¸€è‡´çš„éæ­·æ–¹å¼ è¨˜æ†¶é«”æ•ˆç‡ï¼šæ”¯æŒå¤§æ•¸æ“šé›†çš„åˆ†æ‰¹è™•ç† å‡½æ•¸å¼æ•´åˆï¼šèˆ‡ç¾ä»£ Java å‡½æ•¸å¼ç·¨ç¨‹ç„¡ç¸«æ•´åˆ ä¼æ¥­ç´šç‰¹æ€§ï¼šæ”¯æŒåˆ†é ã€å¿«å–ã€ç•°æ­¥è™•ç† ä¸»è¦ç¼ºé» è¤‡é›œæ€§å¢åŠ ï¼šç¾ä»£åŒ–åŠŸèƒ½å¢åŠ äº†å¯¦ç¾è¤‡é›œåº¦ æ•ˆèƒ½é–‹éŠ·ï¼šæŸäº›é«˜ç´šåŠŸèƒ½å¯èƒ½å¸¶ä¾†é¡å¤–é–‹éŠ· ä¾è³´æ€§ï¼šèˆ‡ç‰¹å®šæ¡†æ¶ï¼ˆå¦‚ Spring Dataï¼‰è€¦åˆ æ­£ç¢ºä½¿ç”¨ç¾ä»£åŒ–è¿­ä»£å™¨æ¨¡å¼å¯ä»¥å¤§å¹…æå‡æ•¸æ“šè™•ç†çš„æ•ˆç‡å’Œå¯ç¶­è­·æ€§ï¼Œæ˜¯ä¼æ¥­ç´šæ‡‰ç”¨é–‹ç™¼ä¸­ä¸å¯æˆ–ç¼ºçš„é‡è¦æ¨¡å¼ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/iterator/","tags":["Design Pattern","Iterator Pattern","Behavioral Pattern","Java Iterator","Stream API","Spring Data","Pagination","Custom Iterator","Java 8+","Spring Boot","Enterprise Architecture","Collection Traversal","Lazy Loading","Performance Optimization","Functional Programming","Lambda Expressions","Best Practices"],"title":"è¿­ä»£å™¨æ¨¡å¼ (Iterator Pattern) ç¾ä»£åŒ–å®Œæ•´æŒ‡å—ï¼šJava 8+ Stream APIã€Spring Data åˆ†é èˆ‡ä¼æ¥­ç´šè¿­ä»£å™¨å¯¦ä½œæœ€ä½³å¯¦è¸"},{"content":"Visitor ç•¶å¿…é ˆå°ä¸€çµ„ç›¸ä¼¼é¡å‹çš„å°è±¡åŸ·è¡Œæ“ä½œæ™‚ï¼Œæˆ‘å€‘ä½¿ç”¨è¨ªå•è€…æ¨¡å¼ã€‚å€ŸåŠ© visitor patternï¼Œæˆ‘å€‘å¯ä»¥å°‡æ“ä½œé‚è¼¯å¾å°è±¡è½‰ç§»åˆ°å¦ä¸€å€‹é¡ã€‚ä¾‹å¦‚ï¼Œè€ƒæ…®ä¸€å€‹è³¼ç‰©è»Šï¼Œæˆ‘å€‘å¯ä»¥åœ¨å…¶ä¸­æ·»åŠ ä¸åŒé¡å‹çš„å•†å“ï¼ˆå…ƒç´ ï¼‰ï¼Œç•¶æˆ‘å€‘é»æ“Šçµå¸³æŒ‰éˆ•æ™‚ï¼Œå®ƒæœƒè¨ˆç®—å‡ºæˆ‘å€‘éœ€è¦æ”¯ä»˜çš„ç¸½é‡‘é¡ã€‚ç¾åœ¨ï¼Œæˆ‘å€‘å¯ä»¥åœ¨é …ç›®é¡ä¸­åŒ…å«è¨ˆç®—é‚è¼¯ï¼Œæˆ–è€…æˆ‘å€‘å¯ä»¥ä½¿ç”¨ visitor pattern å°‡æ­¤é‚è¼¯ç§»åˆ°å¦ä¸€å€‹é¡ä¸­ã€‚å› æ­¤ï¼Œä½¿ç”¨ visitor patternï¼Œæˆ‘å€‘å¯ä»¥å°‡é‚è¼¯ç§»åˆ°å¦ä¸€å€‹é¡ã€‚\nvisitor pattern å…è¨±åœ¨ä¸æ›´æ”¹é›†åˆä¸­ä»»ä½•å°è±¡çš„é¡çš„æƒ…æ³ä¸‹å®šç¾©æ“ä½œã€‚ç‚ºæ­¤ï¼Œvisitor pattern å»ºè­°åœ¨ç¨±ç‚º visitoré¡çš„å–®ç¨é¡ä¸­å®šç¾©æ“ä½œã€‚é€™å°‡æ“ä½œèˆ‡å…¶æ“ä½œçš„å°è±¡é›†åˆåˆ†é–‹ã€‚å°æ–¼è¦å®šç¾©çš„æ¯å€‹æ–°æ“ä½œï¼Œéƒ½æœƒå‰µå»ºä¸€å€‹æ–°çš„è¨ªå•è€…é¡ã€‚ç”±æ–¼æ“ä½œå°‡åœ¨ä¸€çµ„å°åƒä¸ŠåŸ·è¡Œï¼Œå› æ­¤è¨ªå•è€…éœ€è¦ä¸€ç¨®è¨ªå•é€™äº›å°è±¡çš„å…¬å…±æˆå“¡çš„æ–¹æ³•ã€‚\nVisitorï¼šç‚ºå°è±¡çµæ§‹ä¸­çš„æ¯å€‹ ConcreteElement é¡è²æ˜ä¸€å€‹è¨ªå•æ“ä½œã€‚æ“ä½œçš„åç¨±å’Œç°½åæ¨™è­˜å‘è¨ªå•è€…ç™¼é€è¨ªå•è«‹æ±‚çš„é¡ã€‚é€™è®“è¨ªå•è€…å¯ä»¥ç¢ºå®šè¢«è¨ªå•å…ƒç´ çš„å…·é«”é¡ã€‚ç„¶å¾Œè¨ªå•è€…å¯ä»¥é€šéå…¶ç‰¹å®šçš„ç•Œé¢ç›´æ¥è¨ªå•è©²å…ƒç´ ã€‚ ConcreteVisitorï¼šå¯¦ç¾è¨ªå•è€…è²æ˜çš„æ¯å€‹æ“ä½œã€‚æ¯å€‹æ“ä½œéƒ½å¯¦ç¾äº†ç‚ºçµæ§‹ä¸­çš„ç›¸æ‡‰å°åƒé¡å®šç¾©çš„ç®—æ³•ç‰‡æ®µã€‚ConcreteVisitor ç‚ºç®—æ³•æä¾›ä¸Šä¸‹æ–‡ä¸¦å­˜å„²å…¶æœ¬åœ°ç‹€æ…‹ã€‚é€™ç¨®ç‹€æ…‹é€šå¸¸æœƒåœ¨çµæ§‹çš„éæ­·éç¨‹ä¸­ç´¯ç©çµæœã€‚ Elementï¼šå®šç¾©ä¸€å€‹æ¥å—è¨ªå•è€…ä½œç‚ºåƒæ•¸çš„æ“ä½œã€‚ ConcreteElementï¼šå¯¦ç¾ä»¥è¨ªå•è€…ç‚ºåƒæ•¸çš„ Accept æ“ä½œã€‚ ObjectStructure:\nå¯ä»¥æšèˆ‰å®ƒçš„å…ƒç´ ã€‚ å¯ä»¥æä¾›é«˜ç´šç•Œé¢ä»¥å…è¨±è¨ªå•è€…è¨ªå•å…¶å…ƒç´ ã€‚ å¯ä»¥æ˜¯çµ„åˆæˆ–é›†åˆï¼Œä¾‹å¦‚åˆ—è¡¨æˆ–é›†åˆã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 public interface ShoppingCartElement { public int accept(ShoppingCartVisitor visitor); } public class Beef implements ShoppingCartElement { private int price; private double weight; // constructor , getter , setter @Override //Notice the implementation of accept() method in concrete classes, //its calling visit() method of Visitor and passing itself as argument. public int accept(ShoppingCartVisitor visitor) { return visitor.visit(this); } } public class Fruit implements ShoppingCartElement { private int pricePerKg; private int weight; private String name; // constructor , getter , setter @Override public int accept(ShoppingCartVisitor visitor) { return visitor.visit(this); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 public interface ShoppingCartVisitor { int visit(Beef book); int visit(Fruit fruit); } public class ShoppingCartVisitorImpl implements ShoppingCartVisitor { @Override public int visit(Beef beef) { var cost = 0; //apply 5$ discount if book price is greater than 50 if(beef.getPrice() \u0026gt; 50){ cost = beef.getPrice() - 5; } else { cost = beef.getPrice(); } log.info(\u0026#34;beef: {}\u0026#34;, beef); return cost; } @Override public int visit(Fruit fruit) { var cost = fruit.getPricePerKg() * fruit.getWeight(); log.info(\u0026#34;cost: \u0026#34; + cost); return cost; } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public static void main(String[] args) { var items = new ShoppingCartElement[]{ new Beef(20, 2.0), new Beef(100, 3.0), new Fruit(10, 2, \u0026#34;Apple\u0026#34;), new Fruit(5, 5, \u0026#34;Banana\u0026#34;) }; int total = calculatePrice(items); log.info(\u0026#34;total: \u0026#34; + total); } private static int calculatePrice(ShoppingCartElement[] items) { var visitor = new ShoppingCartVisitorImpl(); int sum = 0; for(ShoppingCartElement item : items){ sum += item.accept(visitor); } return sum; } ä¸€å€‹å°è±¡çµæ§‹åŒ…å«è¨±å¤šå…·æœ‰ä¸åŒæ¥å£çš„å°åƒé¡ï¼Œä¸¦ä¸”æ‚¨å¸Œæœ›å°é€™äº›å°è±¡åŸ·è¡Œä¾è³´æ–¼å®ƒå€‘çš„å…·é«”é¡çš„æ“ä½œã€‚ ç•¶æˆ‘å€‘éœ€è¦å°å°è±¡çµæ§‹ä¸­çš„å°è±¡åŸ·è¡Œè¨±å¤šä¸åŒä¸”ä¸ç›¸é—œçš„æ“ä½œæ™‚ï¼Œæˆ‘å€‘å¸Œæœ›é¿å…é€™äº›æ“ä½œ \u0026ldquo;æ±¡æŸ“\u0026rdquo; å®ƒå€‘çš„ classã€‚è¨ªå•è€…å…è¨±æ‚¨é€šéåœ¨ä¸€å€‹é¡ä¸­å®šç¾©ç›¸é—œæ“ä½œä¾†å°‡å®ƒå€‘ä¿æŒåœ¨ä¸€èµ·ã€‚ç•¶æˆ‘å€‘éœ€è¦èˆ‡è¨±å¤šæ‡‰ç”¨ç¨‹åºå…±äº«å°è±¡çµæ§‹æ™‚ï¼Œä½¿ç”¨è¨ªå•è€…å°‡æ“ä½œæ”¾åœ¨é‚£äº›éœ€è¦å®ƒå€‘çš„æ‡‰ç”¨ç¨‹åºä¸­ã€‚ å®šç¾©å°è±¡çµæ§‹çš„é¡å¾ˆå°‘æ›´æ”¹ï¼Œä½†æ‚¨ç¶“å¸¸å¸Œæœ›åœ¨è©²çµæ§‹ä¸Šå®šç¾©æ–°æ“ä½œã€‚ä½†æ˜¯ï¼Œæ›´æ”¹å°è±¡çµæ§‹é¡éœ€è¦é‡æ–°å®šç¾©æ‰€æœ‰è¨ªå•è€…çš„æ¥å£ï¼Œé€™å¯èƒ½æ˜¯æ˜‚è²´çš„ã€‚å¦‚æœå°è±¡çµæ§‹é¡ç¶“å¸¸æ›´æ”¹ï¼Œé‚£éº¼æœ€å¥½åœ¨é€™äº›é¡ä¸­å®šç¾©æ“ä½œã€‚ ","permalink":"https://xinqilin.github.io/post/architecture/visitor/","tags":[],"title":"DesignPattern - Behavioral - Visitor"},{"content":"ç‹€æ…‹æ¨¡å¼ (State Pattern) å®Œæ•´å¯¦ä½œæŒ‡å— æ¨¡å¼æ¦‚è¿° ç‹€æ…‹æ¨¡å¼æ˜¯ä¸€ç¨®è¡Œç‚ºè¨­è¨ˆæ¨¡å¼ï¼Œå®ƒå…è¨±ç‰©ä»¶åœ¨å…¶å…§éƒ¨ç‹€æ…‹æ”¹è®Šæ™‚æ”¹è®Šå…¶è¡Œç‚ºã€‚é€™å€‹æ¨¡å¼å°‡ç‹€æ…‹ç›¸é—œçš„è¡Œç‚ºæŠ½å–åˆ°ç¨ç«‹çš„ç‹€æ…‹é¡åˆ¥ä¸­ï¼Œè®“åŸç‰©ä»¶å°‡å·¥ä½œå§”æ´¾çµ¦ç‹€æ…‹ç‰©ä»¶çš„å¯¦ä¾‹ï¼Œè€Œä¸æ˜¯è‡ªè¡Œé€²è¡Œè™•ç†ã€‚\næ ¸å¿ƒæ¦‚å¿µ 1. ç‹€æ…‹æ¨¡å¼è§£æ±ºçš„å•é¡Œ è¤‡é›œçš„æ¢ä»¶é‚è¼¯ï¼šé¿å…å¤§é‡çš„ if-else å’Œ switch-case èªå¥ ç‹€æ…‹ç›¸é—œè¡Œç‚ºåˆ†æ•£ï¼šå°‡ç‹€æ…‹ç›¸é—œçš„é‚è¼¯é›†ä¸­ç®¡ç† ç‹€æ…‹è½‰æ›è¤‡é›œæ€§ï¼šæä¾›æ¸…æ™°çš„ç‹€æ…‹è½‰æ›æ©Ÿåˆ¶ è¡Œç‚ºè®ŠåŒ–ç®¡ç†ï¼šè®“ç‰©ä»¶æ ¹æ“šç‹€æ…‹å‹•æ…‹æ”¹è®Šè¡Œç‚º 2. æ¨¡å¼çµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 // ç‹€æ…‹ä»‹é¢ public interface State { void handle(Context context); String getStateName(); } // ä¸Šä¸‹æ–‡é¡åˆ¥ public class Context { private State currentState; public Context(State initialState) { this.currentState = initialState; } public void setState(State state) { this.currentState = state; } public void request() { currentState.handle(this); } public State getCurrentState() { return currentState; } } // å…·é«”ç‹€æ…‹é¡åˆ¥ public class ConcreteStateA implements State { @Override public void handle(Context context) { System.out.println(\u0026#34;è™•ç†ç‹€æ…‹ A çš„é‚è¼¯\u0026#34;); // å¯èƒ½çš„ç‹€æ…‹è½‰æ› context.setState(new ConcreteStateB()); } @Override public String getStateName() { return \u0026#34;State A\u0026#34;; } } public class ConcreteStateB implements State { @Override public void handle(Context context) { System.out.println(\u0026#34;è™•ç†ç‹€æ…‹ B çš„é‚è¼¯\u0026#34;); // å¯èƒ½çš„ç‹€æ…‹è½‰æ› context.setState(new ConcreteStateA()); } @Override public String getStateName() { return \u0026#34;State B\u0026#34;; } } åŸºç¤å¯¦ä½œç¯„ä¾‹ 1. æ–‡ä»¶å¯©æ ¸æµç¨‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 /** * æ–‡ä»¶å¯©æ ¸ç‹€æ…‹ä»‹é¢ */ public interface DocumentState { void submit(DocumentContext document); void approve(DocumentContext document); void reject(DocumentContext document); void publish(DocumentContext document); String getStatusName(); boolean canTransitionTo(DocumentState newState); } /** * æ–‡ä»¶ä¸Šä¸‹æ–‡é¡åˆ¥ */ public class DocumentContext { private DocumentState currentState; private String documentId; private String content; private String author; private LocalDateTime lastModified; private List\u0026lt;String\u0026gt; reviewComments; public DocumentContext(String documentId, String content, String author) { this.documentId = documentId; this.content = content; this.author = author; this.lastModified = LocalDateTime.now(); this.reviewComments = new ArrayList\u0026lt;\u0026gt;(); this.currentState = new DraftState(); } public void setState(DocumentState state) { if (currentState.canTransitionTo(state)) { System.out.println(\u0026#34;æ–‡ä»¶ç‹€æ…‹å¾ \u0026#34; + currentState.getStatusName() + \u0026#34; è½‰æ›ç‚º \u0026#34; + state.getStatusName()); this.currentState = state; this.lastModified = LocalDateTime.now(); } else { throw new IllegalStateException(\u0026#34;ç„¡æ³•å¾ \u0026#34; + currentState.getStatusName() + \u0026#34; è½‰æ›ç‚º \u0026#34; + state.getStatusName()); } } public void submit() { currentState.submit(this); } public void approve() { currentState.approve(this); } public void reject() { currentState.reject(this); } public void publish() { currentState.publish(this); } // Getters and Setters public DocumentState getCurrentState() { return currentState; } public String getDocumentId() { return documentId; } public String getContent() { return content; } public void setContent(String content) { this.content = content; } public String getAuthor() { return author; } public LocalDateTime getLastModified() { return lastModified; } public List\u0026lt;String\u0026gt; getReviewComments() { return reviewComments; } public void addReviewComment(String comment) { reviewComments.add(comment); } } /** * è‰ç¨¿ç‹€æ…‹ */ public class DraftState implements DocumentState { @Override public void submit(DocumentContext document) { System.out.println(\u0026#34;æäº¤æ–‡ä»¶é€²è¡Œå¯©æ ¸\u0026#34;); document.setState(new UnderReviewState()); } @Override public void approve(DocumentContext document) { throw new IllegalStateException(\u0026#34;è‰ç¨¿ç‹€æ…‹ç„¡æ³•ç›´æ¥æ‰¹å‡†\u0026#34;); } @Override public void reject(DocumentContext document) { throw new IllegalStateException(\u0026#34;è‰ç¨¿ç‹€æ…‹ç„¡æ³•æ‹’çµ•\u0026#34;); } @Override public void publish(DocumentContext document) { throw new IllegalStateException(\u0026#34;è‰ç¨¿ç‹€æ…‹ç„¡æ³•ç›´æ¥ç™¼å¸ƒ\u0026#34;); } @Override public String getStatusName() { return \u0026#34;DRAFT\u0026#34;; } @Override public boolean canTransitionTo(DocumentState newState) { return newState instanceof UnderReviewState; } } /** * å¯©æ ¸ä¸­ç‹€æ…‹ */ public class UnderReviewState implements DocumentState { @Override public void submit(DocumentContext document) { throw new IllegalStateException(\u0026#34;æ–‡ä»¶å·²åœ¨å¯©æ ¸ä¸­\u0026#34;); } @Override public void approve(DocumentContext document) { System.out.println(\u0026#34;å¯©æ ¸é€šéï¼Œæ–‡ä»¶å·²æ‰¹å‡†\u0026#34;); document.setState(new ApprovedState()); } @Override public void reject(DocumentContext document) { System.out.println(\u0026#34;å¯©æ ¸æœªé€šéï¼Œæ–‡ä»¶è¢«æ‹’çµ•\u0026#34;); document.setState(new RejectedState()); } @Override public void publish(DocumentContext document) { throw new IllegalStateException(\u0026#34;å¯©æ ¸ä¸­çš„æ–‡ä»¶ç„¡æ³•ç›´æ¥ç™¼å¸ƒ\u0026#34;); } @Override public String getStatusName() { return \u0026#34;UNDER_REVIEW\u0026#34;; } @Override public boolean canTransitionTo(DocumentState newState) { return newState instanceof ApprovedState || newState instanceof RejectedState; } } /** * å·²æ‰¹å‡†ç‹€æ…‹ */ public class ApprovedState implements DocumentState { @Override public void submit(DocumentContext document) { throw new IllegalStateException(\u0026#34;å·²æ‰¹å‡†çš„æ–‡ä»¶ç„¡æ³•é‡æ–°æäº¤\u0026#34;); } @Override public void approve(DocumentContext document) { System.out.println(\u0026#34;æ–‡ä»¶å·²ç¶“æ˜¯æ‰¹å‡†ç‹€æ…‹\u0026#34;); } @Override public void reject(DocumentContext document) { System.out.println(\u0026#34;æ’¤éŠ·æ‰¹å‡†ï¼Œæ–‡ä»¶è¢«æ‹’çµ•\u0026#34;); document.setState(new RejectedState()); } @Override public void publish(DocumentContext document) { System.out.println(\u0026#34;ç™¼å¸ƒæ–‡ä»¶\u0026#34;); document.setState(new PublishedState()); } @Override public String getStatusName() { return \u0026#34;APPROVED\u0026#34;; } @Override public boolean canTransitionTo(DocumentState newState) { return newState instanceof PublishedState || newState instanceof RejectedState; } } /** * å·²æ‹’çµ•ç‹€æ…‹ */ public class RejectedState implements DocumentState { @Override public void submit(DocumentContext document) { System.out.println(\u0026#34;é‡æ–°æäº¤æ–‡ä»¶é€²è¡Œå¯©æ ¸\u0026#34;); document.setState(new UnderReviewState()); } @Override public void approve(DocumentContext document) { throw new IllegalStateException(\u0026#34;è¢«æ‹’çµ•çš„æ–‡ä»¶ç„¡æ³•ç›´æ¥æ‰¹å‡†\u0026#34;); } @Override public void reject(DocumentContext document) { System.out.println(\u0026#34;æ–‡ä»¶å·²ç¶“æ˜¯æ‹’çµ•ç‹€æ…‹\u0026#34;); } @Override public void publish(DocumentContext document) { throw new IllegalStateException(\u0026#34;è¢«æ‹’çµ•çš„æ–‡ä»¶ç„¡æ³•ç™¼å¸ƒ\u0026#34;); } @Override public String getStatusName() { return \u0026#34;REJECTED\u0026#34;; } @Override public boolean canTransitionTo(DocumentState newState) { return newState instanceof UnderReviewState; } } /** * å·²ç™¼å¸ƒç‹€æ…‹ */ public class PublishedState implements DocumentState { @Override public void submit(DocumentContext document) { throw new IllegalStateException(\u0026#34;å·²ç™¼å¸ƒçš„æ–‡ä»¶ç„¡æ³•é‡æ–°æäº¤\u0026#34;); } @Override public void approve(DocumentContext document) { System.out.println(\u0026#34;æ–‡ä»¶å·²ç¶“æ˜¯ç™¼å¸ƒç‹€æ…‹\u0026#34;); } @Override public void reject(DocumentContext document) { throw new IllegalStateException(\u0026#34;å·²ç™¼å¸ƒçš„æ–‡ä»¶ç„¡æ³•æ‹’çµ•\u0026#34;); } @Override public void publish(DocumentContext document) { System.out.println(\u0026#34;æ–‡ä»¶å·²ç¶“æ˜¯ç™¼å¸ƒç‹€æ…‹\u0026#34;); } @Override public String getStatusName() { return \u0026#34;PUBLISHED\u0026#34;; } @Override public boolean canTransitionTo(DocumentState newState) { return false; // ç™¼å¸ƒç‹€æ…‹æ˜¯çµ‚ç«¯ç‹€æ…‹ } } 2. æ–‡ä»¶å¯©æ ¸æµç¨‹æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 /** * æ–‡ä»¶å¯©æ ¸æµç¨‹æ¸¬è©¦é¡åˆ¥ */ public class DocumentWorkflowExample { public static void main(String[] args) { // å‰µå»ºæ–‡ä»¶ DocumentContext document = new DocumentContext( \u0026#34;DOC-001\u0026#34;, \u0026#34;é€™æ˜¯ä¸€ä»½é‡è¦çš„æŠ€è¡“æ–‡ä»¶\u0026#34;, \u0026#34;å¼µä¸‰\u0026#34; ); System.out.println(\u0026#34;=== æ–‡ä»¶å·¥ä½œæµç¨‹ç¤ºç¯„ ===\u0026#34;); System.out.println(\u0026#34;åˆå§‹ç‹€æ…‹: \u0026#34; + document.getCurrentState().getStatusName()); try { // æäº¤å¯©æ ¸ document.submit(); System.out.println(\u0026#34;ç•¶å‰ç‹€æ…‹: \u0026#34; + document.getCurrentState().getStatusName()); // å¯©æ ¸é€šé document.approve(); System.out.println(\u0026#34;ç•¶å‰ç‹€æ…‹: \u0026#34; + document.getCurrentState().getStatusName()); // ç™¼å¸ƒæ–‡ä»¶ document.publish(); System.out.println(\u0026#34;ç•¶å‰ç‹€æ…‹: \u0026#34; + document.getCurrentState().getStatusName()); } catch (IllegalStateException e) { System.err.println(\u0026#34;ç‹€æ…‹è½‰æ›éŒ¯èª¤: \u0026#34; + e.getMessage()); } // æ¸¬è©¦éŒ¯èª¤çš„ç‹€æ…‹è½‰æ› System.out.println(\u0026#34;\\n=== æ¸¬è©¦éŒ¯èª¤ç‹€æ…‹è½‰æ› ===\u0026#34;); try { document.submit(); // å·²ç™¼å¸ƒçš„æ–‡ä»¶ç„¡æ³•é‡æ–°æäº¤ } catch (IllegalStateException e) { System.err.println(\u0026#34;é æœŸéŒ¯èª¤: \u0026#34; + e.getMessage()); } } } ä¼æ¥­ç´šæ‡‰ç”¨æ¡ˆä¾‹ 1. è¨‚å–®è™•ç†ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 /** * è¨‚å–®ç‹€æ…‹ä»‹é¢ */ public interface OrderState { void confirmOrder(OrderContext order); void payOrder(OrderContext order); void shipOrder(OrderContext order); void deliverOrder(OrderContext order); void cancelOrder(OrderContext order); void returnOrder(OrderContext order); OrderStatus getStatus(); Set\u0026lt;OrderStatus\u0026gt; getAllowedTransitions(); } /** * è¨‚å–®ç‹€æ…‹æšèˆ‰ */ public enum OrderStatus { PENDING(\u0026#34;å¾…ç¢ºèª\u0026#34;), CONFIRMED(\u0026#34;å·²ç¢ºèª\u0026#34;), PAID(\u0026#34;å·²ä»˜æ¬¾\u0026#34;), SHIPPED(\u0026#34;å·²ç™¼è²¨\u0026#34;), DELIVERED(\u0026#34;å·²é€é”\u0026#34;), CANCELLED(\u0026#34;å·²å–æ¶ˆ\u0026#34;), RETURNED(\u0026#34;å·²é€€è²¨\u0026#34;); private final String description; OrderStatus(String description) { this.description = description; } public String getDescription() { return description; } } /** * è¨‚å–®ä¸Šä¸‹æ–‡é¡åˆ¥ */ public class OrderContext { private OrderState currentState; private String orderId; private String customerId; private List\u0026lt;OrderItem\u0026gt; items; private BigDecimal totalAmount; private LocalDateTime orderDate; private LocalDateTime lastUpdated; private List\u0026lt;OrderEvent\u0026gt; eventHistory; public OrderContext(String orderId, String customerId, List\u0026lt;OrderItem\u0026gt; items) { this.orderId = orderId; this.customerId = customerId; this.items = new ArrayList\u0026lt;\u0026gt;(items); this.totalAmount = calculateTotal(); this.orderDate = LocalDateTime.now(); this.lastUpdated = LocalDateTime.now(); this.eventHistory = new ArrayList\u0026lt;\u0026gt;(); this.currentState = new PendingOrderState(); addEvent(\u0026#34;ORDER_CREATED\u0026#34;, \u0026#34;è¨‚å–®å·²å‰µå»º\u0026#34;); } public void setState(OrderState newState) { OrderState oldState = this.currentState; this.currentState = newState; this.lastUpdated = LocalDateTime.now(); addEvent(\u0026#34;STATE_CHANGED\u0026#34;, String.format(\u0026#34;ç‹€æ…‹å¾ %s è®Šæ›´ç‚º %s\u0026#34;, oldState.getStatus().getDescription(), newState.getStatus().getDescription())); } private void addEvent(String eventType, String description) { eventHistory.add(new OrderEvent(LocalDateTime.now(), eventType, description)); } private BigDecimal calculateTotal() { return items.stream() .map(item -\u0026gt; item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity()))) .reduce(BigDecimal.ZERO, BigDecimal::add); } // å§”æ´¾çµ¦ç•¶å‰ç‹€æ…‹çš„æ–¹æ³• public void confirmOrder() { currentState.confirmOrder(this); } public void payOrder() { currentState.payOrder(this); } public void shipOrder() { currentState.shipOrder(this); } public void deliverOrder() { currentState.deliverOrder(this); } public void cancelOrder() { currentState.cancelOrder(this); } public void returnOrder() { currentState.returnOrder(this); } // Getters and Setters public OrderState getCurrentState() { return currentState; } public String getOrderId() { return orderId; } public String getCustomerId() { return customerId; } public List\u0026lt;OrderItem\u0026gt; getItems() { return items; } public BigDecimal getTotalAmount() { return totalAmount; } public LocalDateTime getOrderDate() { return orderDate; } public LocalDateTime getLastUpdated() { return lastUpdated; } public List\u0026lt;OrderEvent\u0026gt; getEventHistory() { return eventHistory; } } /** * å¾…ç¢ºèªè¨‚å–®ç‹€æ…‹ */ public class PendingOrderState implements OrderState { @Override public void confirmOrder(OrderContext order) { System.out.println(\u0026#34;ç¢ºèªè¨‚å–®: \u0026#34; + order.getOrderId()); order.setState(new ConfirmedOrderState()); } @Override public void payOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å¾…ç¢ºèªçš„è¨‚å–®ç„¡æ³•ç›´æ¥ä»˜æ¬¾\u0026#34;); } @Override public void shipOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å¾…ç¢ºèªçš„è¨‚å–®ç„¡æ³•ç™¼è²¨\u0026#34;); } @Override public void deliverOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å¾…ç¢ºèªçš„è¨‚å–®ç„¡æ³•é€é”\u0026#34;); } @Override public void cancelOrder(OrderContext order) { System.out.println(\u0026#34;å–æ¶ˆè¨‚å–®: \u0026#34; + order.getOrderId()); order.setState(new CancelledOrderState()); } @Override public void returnOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å¾…ç¢ºèªçš„è¨‚å–®ç„¡æ³•é€€è²¨\u0026#34;); } @Override public OrderStatus getStatus() { return OrderStatus.PENDING; } @Override public Set\u0026lt;OrderStatus\u0026gt; getAllowedTransitions() { return Set.of(OrderStatus.CONFIRMED, OrderStatus.CANCELLED); } } /** * å·²ç¢ºèªè¨‚å–®ç‹€æ…‹ */ public class ConfirmedOrderState implements OrderState { @Override public void confirmOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“æ˜¯ç¢ºèªç‹€æ…‹\u0026#34;); } @Override public void payOrder(OrderContext order) { System.out.println(\u0026#34;ä»˜æ¬¾æˆåŠŸ: \u0026#34; + order.getOrderId()); // é€™è£¡å¯ä»¥æ•´åˆæ”¯ä»˜ç³»çµ± order.setState(new PaidOrderState()); } @Override public void shipOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;æœªä»˜æ¬¾çš„è¨‚å–®ç„¡æ³•ç™¼è²¨\u0026#34;); } @Override public void deliverOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;æœªä»˜æ¬¾çš„è¨‚å–®ç„¡æ³•é€é”\u0026#34;); } @Override public void cancelOrder(OrderContext order) { System.out.println(\u0026#34;å–æ¶ˆå·²ç¢ºèªçš„è¨‚å–®: \u0026#34; + order.getOrderId()); order.setState(new CancelledOrderState()); } @Override public void returnOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;æœªä»˜æ¬¾çš„è¨‚å–®ç„¡æ³•é€€è²¨\u0026#34;); } @Override public OrderStatus getStatus() { return OrderStatus.CONFIRMED; } @Override public Set\u0026lt;OrderStatus\u0026gt; getAllowedTransitions() { return Set.of(OrderStatus.PAID, OrderStatus.CANCELLED); } } /** * å·²ä»˜æ¬¾è¨‚å–®ç‹€æ…‹ */ public class PaidOrderState implements OrderState { @Override public void confirmOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“æ˜¯ç¢ºèªç‹€æ…‹\u0026#34;); } @Override public void payOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“ä»˜æ¬¾\u0026#34;); } @Override public void shipOrder(OrderContext order) { System.out.println(\u0026#34;ç™¼è²¨: \u0026#34; + order.getOrderId()); // æ•´åˆç‰©æµç³»çµ± order.setState(new ShippedOrderState()); } @Override public void deliverOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;æœªç™¼è²¨çš„è¨‚å–®ç„¡æ³•ç›´æ¥é€é”\u0026#34;); } @Override public void cancelOrder(OrderContext order) { System.out.println(\u0026#34;å–æ¶ˆå·²ä»˜æ¬¾çš„è¨‚å–®ï¼Œå°‡é€²è¡Œé€€æ¬¾: \u0026#34; + order.getOrderId()); // é€™è£¡éœ€è¦è§¸ç™¼é€€æ¬¾æµç¨‹ order.setState(new CancelledOrderState()); } @Override public void returnOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;æœªç™¼è²¨çš„è¨‚å–®ç„¡æ³•é€€è²¨\u0026#34;); } @Override public OrderStatus getStatus() { return OrderStatus.PAID; } @Override public Set\u0026lt;OrderStatus\u0026gt; getAllowedTransitions() { return Set.of(OrderStatus.SHIPPED, OrderStatus.CANCELLED); } } /** * å·²ç™¼è²¨è¨‚å–®ç‹€æ…‹ */ public class ShippedOrderState implements OrderState { @Override public void confirmOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“ç¢ºèªä¸¦ç™¼è²¨\u0026#34;); } @Override public void payOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“ä»˜æ¬¾\u0026#34;); } @Override public void shipOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“ç™¼è²¨\u0026#34;); } @Override public void deliverOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®é€é”: \u0026#34; + order.getOrderId()); order.setState(new DeliveredOrderState()); } @Override public void cancelOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²ç™¼è²¨çš„è¨‚å–®ç„¡æ³•å–æ¶ˆï¼Œè«‹è¯ç¹«å®¢æœ\u0026#34;); } @Override public void returnOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;æœªé€é”çš„è¨‚å–®ç„¡æ³•é€€è²¨\u0026#34;); } @Override public OrderStatus getStatus() { return OrderStatus.SHIPPED; } @Override public Set\u0026lt;OrderStatus\u0026gt; getAllowedTransitions() { return Set.of(OrderStatus.DELIVERED); } } /** * å·²é€é”è¨‚å–®ç‹€æ…‹ */ public class DeliveredOrderState implements OrderState { @Override public void confirmOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²å®Œæˆ\u0026#34;); } @Override public void payOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ä»˜æ¬¾ä¸¦å®Œæˆ\u0026#34;); } @Override public void shipOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç™¼è²¨ä¸¦é€é”\u0026#34;); } @Override public void deliverOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“é€é”\u0026#34;); } @Override public void cancelOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²é€é”çš„è¨‚å–®ç„¡æ³•å–æ¶ˆ\u0026#34;); } @Override public void returnOrder(OrderContext order) { System.out.println(\u0026#34;è™•ç†é€€è²¨è«‹æ±‚: \u0026#34; + order.getOrderId()); order.setState(new ReturnedOrderState()); } @Override public OrderStatus getStatus() { return OrderStatus.DELIVERED; } @Override public Set\u0026lt;OrderStatus\u0026gt; getAllowedTransitions() { return Set.of(OrderStatus.RETURNED); } } /** * å·²å–æ¶ˆè¨‚å–®ç‹€æ…‹ */ public class CancelledOrderState implements OrderState { @Override public void confirmOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²å–æ¶ˆçš„è¨‚å–®ç„¡æ³•ç¢ºèª\u0026#34;); } @Override public void payOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²å–æ¶ˆçš„è¨‚å–®ç„¡æ³•ä»˜æ¬¾\u0026#34;); } @Override public void shipOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²å–æ¶ˆçš„è¨‚å–®ç„¡æ³•ç™¼è²¨\u0026#34;); } @Override public void deliverOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²å–æ¶ˆçš„è¨‚å–®ç„¡æ³•é€é”\u0026#34;); } @Override public void cancelOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“æ˜¯å–æ¶ˆç‹€æ…‹\u0026#34;); } @Override public void returnOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²å–æ¶ˆçš„è¨‚å–®ç„¡æ³•é€€è²¨\u0026#34;); } @Override public OrderStatus getStatus() { return OrderStatus.CANCELLED; } @Override public Set\u0026lt;OrderStatus\u0026gt; getAllowedTransitions() { return Set.of(); // çµ‚ç«¯ç‹€æ…‹ } } /** * å·²é€€è²¨è¨‚å–®ç‹€æ…‹ */ public class ReturnedOrderState implements OrderState { @Override public void confirmOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²é€€è²¨çš„è¨‚å–®ç„¡æ³•ç¢ºèª\u0026#34;); } @Override public void payOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²é€€è²¨çš„è¨‚å–®ç„¡æ³•ä»˜æ¬¾\u0026#34;); } @Override public void shipOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²é€€è²¨çš„è¨‚å–®ç„¡æ³•ç™¼è²¨\u0026#34;); } @Override public void deliverOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²é€€è²¨çš„è¨‚å–®ç„¡æ³•é€é”\u0026#34;); } @Override public void cancelOrder(OrderContext order) { throw new IllegalStateException(\u0026#34;å·²é€€è²¨çš„è¨‚å–®ç„¡æ³•å–æ¶ˆ\u0026#34;); } @Override public void returnOrder(OrderContext order) { System.out.println(\u0026#34;è¨‚å–®å·²ç¶“æ˜¯é€€è²¨ç‹€æ…‹\u0026#34;); } @Override public OrderStatus getStatus() { return OrderStatus.RETURNED; } @Override public Set\u0026lt;OrderStatus\u0026gt; getAllowedTransitions() { return Set.of(); // çµ‚ç«¯ç‹€æ…‹ } } /** * è¼”åŠ©é¡åˆ¥ */ public class OrderItem { private String productId; private String productName; private BigDecimal price; private int quantity; public OrderItem(String productId, String productName, BigDecimal price, int quantity) { this.productId = productId; this.productName = productName; this.price = price; this.quantity = quantity; } // Getters public String getProductId() { return productId; } public String getProductName() { return productName; } public BigDecimal getPrice() { return price; } public int getQuantity() { return quantity; } } public class OrderEvent { private LocalDateTime timestamp; private String eventType; private String description; public OrderEvent(LocalDateTime timestamp, String eventType, String description) { this.timestamp = timestamp; this.eventType = eventType; this.description = description; } // Getters public LocalDateTime getTimestamp() { return timestamp; } public String getEventType() { return eventType; } public String getDescription() { return description; } @Override public String toString() { return String.format(\u0026#34;[%s] %s: %s\u0026#34;, timestamp, eventType, description); } } 2. è¨‚å–®è™•ç†ç³»çµ±æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 /** * è¨‚å–®è™•ç†ç³»çµ±ç¤ºç¯„ */ public class OrderProcessingExample { public static void main(String[] args) { // å‰µå»ºè¨‚å–®é …ç›® List\u0026lt;OrderItem\u0026gt; items = Arrays.asList( new OrderItem(\u0026#34;P001\u0026#34;, \u0026#34;ç­†è¨˜å‹é›»è…¦\u0026#34;, new BigDecimal(\u0026#34;50000\u0026#34;), 1), new OrderItem(\u0026#34;P002\u0026#34;, \u0026#34;æ»‘é¼ \u0026#34;, new BigDecimal(\u0026#34;1000\u0026#34;), 2) ); // å‰µå»ºè¨‚å–® OrderContext order = new OrderContext(\u0026#34;ORDER-2023-001\u0026#34;, \u0026#34;CUST-001\u0026#34;, items); System.out.println(\u0026#34;=== è¨‚å–®è™•ç†æµç¨‹ç¤ºç¯„ ===\u0026#34;); System.out.println(\u0026#34;è¨‚å–®ç¸½é¡: \u0026#34; + order.getTotalAmount()); System.out.println(\u0026#34;åˆå§‹ç‹€æ…‹: \u0026#34; + order.getCurrentState().getStatus().getDescription()); try { // æ­£å¸¸æµç¨‹ order.confirmOrder(); System.out.println(\u0026#34;ç•¶å‰ç‹€æ…‹: \u0026#34; + order.getCurrentState().getStatus().getDescription()); order.payOrder(); System.out.println(\u0026#34;ç•¶å‰ç‹€æ…‹: \u0026#34; + order.getCurrentState().getStatus().getDescription()); order.shipOrder(); System.out.println(\u0026#34;ç•¶å‰ç‹€æ…‹: \u0026#34; + order.getCurrentState().getStatus().getDescription()); order.deliverOrder(); System.out.println(\u0026#34;ç•¶å‰ç‹€æ…‹: \u0026#34; + order.getCurrentState().getStatus().getDescription()); // æŸ¥çœ‹äº‹ä»¶æ­·å² System.out.println(\u0026#34;\\n=== è¨‚å–®äº‹ä»¶æ­·å² ===\u0026#34;); order.getEventHistory().forEach(System.out::println); } catch (IllegalStateException e) { System.err.println(\u0026#34;ç‹€æ…‹è½‰æ›éŒ¯èª¤: \u0026#34; + e.getMessage()); } } } Spring Boot æ•´åˆ 1. ç‹€æ…‹ç®¡ç†æœå‹™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 /** * ç‹€æ…‹å·¥å» ä»‹é¢ */ public interface StateFactory\u0026lt;T extends Enum\u0026lt;T\u0026gt;\u0026gt; { State createState(T stateType); Set\u0026lt;T\u0026gt; getValidTransitions(T currentState); } /** * æ–‡ä»¶ç‹€æ…‹å·¥å»  */ @Component public class DocumentStateFactory implements StateFactory\u0026lt;DocumentStatus\u0026gt; { private final Map\u0026lt;DocumentStatus, Supplier\u0026lt;DocumentState\u0026gt;\u0026gt; stateCreators; private final Map\u0026lt;DocumentStatus, Set\u0026lt;DocumentStatus\u0026gt;\u0026gt; transitionRules; public DocumentStateFactory() { // åˆå§‹åŒ–ç‹€æ…‹å‰µå»ºå™¨ stateCreators = Map.of( DocumentStatus.DRAFT, DraftState::new, DocumentStatus.UNDER_REVIEW, UnderReviewState::new, DocumentStatus.APPROVED, ApprovedState::new, DocumentStatus.REJECTED, RejectedState::new, DocumentStatus.PUBLISHED, PublishedState::new ); // åˆå§‹åŒ–ç‹€æ…‹è½‰æ›è¦å‰‡ transitionRules = Map.of( DocumentStatus.DRAFT, Set.of(DocumentStatus.UNDER_REVIEW), DocumentStatus.UNDER_REVIEW, Set.of(DocumentStatus.APPROVED, DocumentStatus.REJECTED), DocumentStatus.APPROVED, Set.of(DocumentStatus.PUBLISHED, DocumentStatus.REJECTED), DocumentStatus.REJECTED, Set.of(DocumentStatus.UNDER_REVIEW), DocumentStatus.PUBLISHED, Set.of() // çµ‚ç«¯ç‹€æ…‹ ); } @Override public DocumentState createState(DocumentStatus stateType) { Supplier\u0026lt;DocumentState\u0026gt; creator = stateCreators.get(stateType); if (creator == null) { throw new IllegalArgumentException(\u0026#34;æœªçŸ¥çš„æ–‡ä»¶ç‹€æ…‹: \u0026#34; + stateType); } return creator.get(); } @Override public Set\u0026lt;DocumentStatus\u0026gt; getValidTransitions(DocumentStatus currentState) { return transitionRules.getOrDefault(currentState, Set.of()); } } /** * æ–‡ä»¶ç‹€æ…‹æšèˆ‰ */ public enum DocumentStatus { DRAFT, UNDER_REVIEW, APPROVED, REJECTED, PUBLISHED } /** * æ–‡ä»¶å¯¦é«” */ @Entity @Table(name = \u0026#34;documents\u0026#34;) public class DocumentEntity { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @Column(unique = true, nullable = false) private String documentId; @Column(nullable = false) private String title; @Lob private String content; @Column(nullable = false) private String author; @Enumerated(EnumType.STRING) @Column(nullable = false) private DocumentStatus status; @CreationTimestamp private LocalDateTime createdAt; @UpdateTimestamp private LocalDateTime updatedAt; @OneToMany(mappedBy = \u0026#34;document\u0026#34;, cascade = CascadeType.ALL, fetch = FetchType.LAZY) private List\u0026lt;DocumentEventEntity\u0026gt; events = new ArrayList\u0026lt;\u0026gt;(); // Constructors, Getters, and Setters public DocumentEntity() {} public DocumentEntity(String documentId, String title, String content, String author) { this.documentId = documentId; this.title = title; this.content = content; this.author = author; this.status = DocumentStatus.DRAFT; } // Getters and Setters public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getDocumentId() { return documentId; } public void setDocumentId(String documentId) { this.documentId = documentId; } public String getTitle() { return title; } public void setTitle(String title) { this.title = title; } public String getContent() { return content; } public void setContent(String content) { this.content = content; } public String getAuthor() { return author; } public void setAuthor(String author) { this.author = author; } public DocumentStatus getStatus() { return status; } public void setStatus(DocumentStatus status) { this.status = status; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } public List\u0026lt;DocumentEventEntity\u0026gt; getEvents() { return events; } } /** * æ–‡ä»¶äº‹ä»¶å¯¦é«” */ @Entity @Table(name = \u0026#34;document_events\u0026#34;) public class DocumentEventEntity { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; @ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = \u0026#34;document_id\u0026#34;) private DocumentEntity document; @Column(nullable = false) private String eventType; @Column(nullable = false) private String description; @CreationTimestamp private LocalDateTime timestamp; // Constructors, Getters, and Setters public DocumentEventEntity() {} public DocumentEventEntity(DocumentEntity document, String eventType, String description) { this.document = document; this.eventType = eventType; this.description = description; } // Getters and Setters public Long getId() { return id; } public DocumentEntity getDocument() { return document; } public String getEventType() { return eventType; } public String getDescription() { return description; } public LocalDateTime getTimestamp() { return timestamp; } } /** * æ–‡ä»¶ç®¡ç†æœå‹™ */ @Service @Transactional public class DocumentManagementService { private final DocumentRepository documentRepository; private final DocumentEventRepository eventRepository; private final DocumentStateFactory stateFactory; private final ApplicationEventPublisher eventPublisher; public DocumentManagementService(DocumentRepository documentRepository, DocumentEventRepository eventRepository, DocumentStateFactory stateFactory, ApplicationEventPublisher eventPublisher) { this.documentRepository = documentRepository; this.eventRepository = eventRepository; this.stateFactory = stateFactory; this.eventPublisher = eventPublisher; } public DocumentEntity createDocument(String title, String content, String author) { String documentId = \u0026#34;DOC-\u0026#34; + System.currentTimeMillis(); DocumentEntity document = new DocumentEntity(documentId, title, content, author); DocumentEntity savedDocument = documentRepository.save(document); recordEvent(savedDocument, \u0026#34;DOCUMENT_CREATED\u0026#34;, \u0026#34;æ–‡ä»¶å·²å‰µå»º\u0026#34;); return savedDocument; } public DocumentEntity transitionState(String documentId, DocumentStatus newStatus) { DocumentEntity document = documentRepository.findByDocumentId(documentId) .orElseThrow(() -\u0026gt; new EntityNotFoundException(\u0026#34;æ–‡ä»¶ä¸å­˜åœ¨: \u0026#34; + documentId)); DocumentStatus currentStatus = document.getStatus(); // é©—è­‰ç‹€æ…‹è½‰æ›æ˜¯å¦æœ‰æ•ˆ Set\u0026lt;DocumentStatus\u0026gt; validTransitions = stateFactory.getValidTransitions(currentStatus); if (!validTransitions.contains(newStatus)) { throw new IllegalStateException( String.format(\u0026#34;ç„¡æ³•å¾ç‹€æ…‹ %s è½‰æ›åˆ° %s\u0026#34;, currentStatus, newStatus)); } // åŸ·è¡Œç‹€æ…‹è½‰æ› document.setStatus(newStatus); DocumentEntity savedDocument = documentRepository.save(document); // è¨˜éŒ„äº‹ä»¶ recordEvent(savedDocument, \u0026#34;STATE_CHANGED\u0026#34;, String.format(\u0026#34;ç‹€æ…‹å¾ %s è®Šæ›´ç‚º %s\u0026#34;, currentStatus, newStatus)); // ç™¼å¸ƒé ˜åŸŸäº‹ä»¶ eventPublisher.publishEvent(new DocumentStateChangedEvent( documentId, currentStatus, newStatus, LocalDateTime.now())); return savedDocument; } public DocumentEntity submitForReview(String documentId) { return transitionState(documentId, DocumentStatus.UNDER_REVIEW); } public DocumentEntity approveDocument(String documentId, String reviewComment) { DocumentEntity document = transitionState(documentId, DocumentStatus.APPROVED); if (reviewComment != null \u0026amp;\u0026amp; !reviewComment.trim().isEmpty()) { recordEvent(document, \u0026#34;REVIEW_COMMENT\u0026#34;, reviewComment); } return document; } public DocumentEntity rejectDocument(String documentId, String rejectionReason) { DocumentEntity document = transitionState(documentId, DocumentStatus.REJECTED); if (rejectionReason != null \u0026amp;\u0026amp; !rejectionReason.trim().isEmpty()) { recordEvent(document, \u0026#34;REJECTION_REASON\u0026#34;, rejectionReason); } return document; } public DocumentEntity publishDocument(String documentId) { return transitionState(documentId, DocumentStatus.PUBLISHED); } @Transactional(readOnly = true) public DocumentEntity getDocument(String documentId) { return documentRepository.findByDocumentId(documentId) .orElseThrow(() -\u0026gt; new EntityNotFoundException(\u0026#34;æ–‡ä»¶ä¸å­˜åœ¨: \u0026#34; + documentId)); } @Transactional(readOnly = true) public List\u0026lt;DocumentEventEntity\u0026gt; getDocumentHistory(String documentId) { DocumentEntity document = getDocument(documentId); return eventRepository.findByDocumentOrderByTimestampAsc(document); } private void recordEvent(DocumentEntity document, String eventType, String description) { DocumentEventEntity event = new DocumentEventEntity(document, eventType, description); eventRepository.save(event); } } /** * æ–‡ä»¶ç‹€æ…‹è®Šæ›´äº‹ä»¶ */ public class DocumentStateChangedEvent { private final String documentId; private final DocumentStatus fromStatus; private final DocumentStatus toStatus; private final LocalDateTime timestamp; public DocumentStateChangedEvent(String documentId, DocumentStatus fromStatus, DocumentStatus toStatus, LocalDateTime timestamp) { this.documentId = documentId; this.fromStatus = fromStatus; this.toStatus = toStatus; this.timestamp = timestamp; } // Getters public String getDocumentId() { return documentId; } public DocumentStatus getFromStatus() { return fromStatus; } public DocumentStatus getToStatus() { return toStatus; } public LocalDateTime getTimestamp() { return timestamp; } } /** * äº‹ä»¶ç›£è½å™¨ */ @Component public class DocumentEventListener { private static final Logger logger = LoggerFactory.getLogger(DocumentEventListener.class); @EventListener public void handleDocumentStateChanged(DocumentStateChangedEvent event) { logger.info(\u0026#34;æ–‡ä»¶ç‹€æ…‹è®Šæ›´: {} å¾ {} è®Šæ›´ç‚º {}\u0026#34;, event.getDocumentId(), event.getFromStatus(), event.getToStatus()); // æ ¹æ“šç‹€æ…‹è®Šæ›´åŸ·è¡Œç›¸æ‡‰çš„æ¥­å‹™é‚è¼¯ switch (event.getToStatus()) { case UNDER_REVIEW: sendReviewNotification(event.getDocumentId()); break; case APPROVED: sendApprovalNotification(event.getDocumentId()); break; case PUBLISHED: sendPublicationNotification(event.getDocumentId()); break; default: // å…¶ä»–ç‹€æ…‹çš„è™•ç† break; } } private void sendReviewNotification(String documentId) { logger.info(\u0026#34;ç™¼é€å¯©æ ¸é€šçŸ¥: {}\u0026#34;, documentId); // å¯¦ä½œé€šçŸ¥é‚è¼¯ } private void sendApprovalNotification(String documentId) { logger.info(\u0026#34;ç™¼é€æ‰¹å‡†é€šçŸ¥: {}\u0026#34;, documentId); // å¯¦ä½œé€šçŸ¥é‚è¼¯ } private void sendPublicationNotification(String documentId) { logger.info(\u0026#34;ç™¼é€ç™¼å¸ƒé€šçŸ¥: {}\u0026#34;, documentId); // å¯¦ä½œé€šçŸ¥é‚è¼¯ } } 2. REST API æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 /** * æ–‡ä»¶ç®¡ç† REST API */ @RestController @RequestMapping(\u0026#34;/api/documents\u0026#34;) @Validated public class DocumentController { private final DocumentManagementService documentService; public DocumentController(DocumentManagementService documentService) { this.documentService = documentService; } @PostMapping public ResponseEntity\u0026lt;DocumentResponse\u0026gt; createDocument( @Valid @RequestBody CreateDocumentRequest request) { DocumentEntity document = documentService.createDocument( request.getTitle(), request.getContent(), request.getAuthor() ); return ResponseEntity.status(HttpStatus.CREATED) .body(DocumentResponse.from(document)); } @GetMapping(\u0026#34;/{documentId}\u0026#34;) public ResponseEntity\u0026lt;DocumentResponse\u0026gt; getDocument( @PathVariable @NotBlank String documentId) { DocumentEntity document = documentService.getDocument(documentId); return ResponseEntity.ok(DocumentResponse.from(document)); } @PostMapping(\u0026#34;/{documentId}/submit\u0026#34;) public ResponseEntity\u0026lt;DocumentResponse\u0026gt; submitDocument( @PathVariable @NotBlank String documentId) { DocumentEntity document = documentService.submitForReview(documentId); return ResponseEntity.ok(DocumentResponse.from(document)); } @PostMapping(\u0026#34;/{documentId}/approve\u0026#34;) public ResponseEntity\u0026lt;DocumentResponse\u0026gt; approveDocument( @PathVariable @NotBlank String documentId, @RequestBody(required = false) ApprovalRequest request) { String comment = request != null ? request.getComment() : null; DocumentEntity document = documentService.approveDocument(documentId, comment); return ResponseEntity.ok(DocumentResponse.from(document)); } @PostMapping(\u0026#34;/{documentId}/reject\u0026#34;) public ResponseEntity\u0026lt;DocumentResponse\u0026gt; rejectDocument( @PathVariable @NotBlank String documentId, @Valid @RequestBody RejectionRequest request) { DocumentEntity document = documentService.rejectDocument( documentId, request.getReason()); return ResponseEntity.ok(DocumentResponse.from(document)); } @PostMapping(\u0026#34;/{documentId}/publish\u0026#34;) public ResponseEntity\u0026lt;DocumentResponse\u0026gt; publishDocument( @PathVariable @NotBlank String documentId) { DocumentEntity document = documentService.publishDocument(documentId); return ResponseEntity.ok(DocumentResponse.from(document)); } @GetMapping(\u0026#34;/{documentId}/history\u0026#34;) public ResponseEntity\u0026lt;List\u0026lt;DocumentEventResponse\u0026gt;\u0026gt; getDocumentHistory( @PathVariable @NotBlank String documentId) { List\u0026lt;DocumentEventEntity\u0026gt; events = documentService.getDocumentHistory(documentId); List\u0026lt;DocumentEventResponse\u0026gt; responses = events.stream() .map(DocumentEventResponse::from) .collect(Collectors.toList()); return ResponseEntity.ok(responses); } @ExceptionHandler(IllegalStateException.class) public ResponseEntity\u0026lt;ErrorResponse\u0026gt; handleIllegalStateException( IllegalStateException ex) { ErrorResponse error = new ErrorResponse(\u0026#34;STATE_TRANSITION_ERROR\u0026#34;, ex.getMessage()); return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error); } @ExceptionHandler(EntityNotFoundException.class) public ResponseEntity\u0026lt;ErrorResponse\u0026gt; handleEntityNotFoundException( EntityNotFoundException ex) { ErrorResponse error = new ErrorResponse(\u0026#34;ENTITY_NOT_FOUND\u0026#34;, ex.getMessage()); return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error); } } /** * è«‹æ±‚/å›æ‡‰ DTO é¡åˆ¥ */ public class CreateDocumentRequest { @NotBlank(message = \u0026#34;æ¨™é¡Œä¸èƒ½ç‚ºç©º\u0026#34;) private String title; @NotBlank(message = \u0026#34;å…§å®¹ä¸èƒ½ç‚ºç©º\u0026#34;) private String content; @NotBlank(message = \u0026#34;ä½œè€…ä¸èƒ½ç‚ºç©º\u0026#34;) private String author; // Getters and Setters public String getTitle() { return title; } public void setTitle(String title) { this.title = title; } public String getContent() { return content; } public void setContent(String content) { this.content = content; } public String getAuthor() { return author; } public void setAuthor(String author) { this.author = author; } } public class ApprovalRequest { private String comment; public String getComment() { return comment; } public void setComment(String comment) { this.comment = comment; } } public class RejectionRequest { @NotBlank(message = \u0026#34;æ‹’çµ•åŸå› ä¸èƒ½ç‚ºç©º\u0026#34;) private String reason; public String getReason() { return reason; } public void setReason(String reason) { this.reason = reason; } } public class DocumentResponse { private String documentId; private String title; private String content; private String author; private DocumentStatus status; private LocalDateTime createdAt; private LocalDateTime updatedAt; public static DocumentResponse from(DocumentEntity entity) { DocumentResponse response = new DocumentResponse(); response.documentId = entity.getDocumentId(); response.title = entity.getTitle(); response.content = entity.getContent(); response.author = entity.getAuthor(); response.status = entity.getStatus(); response.createdAt = entity.getCreatedAt(); response.updatedAt = entity.getUpdatedAt(); return response; } // Getters public String getDocumentId() { return documentId; } public String getTitle() { return title; } public String getContent() { return content; } public String getAuthor() { return author; } public DocumentStatus getStatus() { return status; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } } public class DocumentEventResponse { private String eventType; private String description; private LocalDateTime timestamp; public static DocumentEventResponse from(DocumentEventEntity entity) { DocumentEventResponse response = new DocumentEventResponse(); response.eventType = entity.getEventType(); response.description = entity.getDescription(); response.timestamp = entity.getTimestamp(); return response; } // Getters public String getEventType() { return eventType; } public String getDescription() { return description; } public LocalDateTime getTimestamp() { return timestamp; } } public class ErrorResponse { private String errorCode; private String message; private LocalDateTime timestamp; public ErrorResponse(String errorCode, String message) { this.errorCode = errorCode; this.message = message; this.timestamp = LocalDateTime.now(); } // Getters public String getErrorCode() { return errorCode; } public String getMessage() { return message; } public LocalDateTime getTimestamp() { return timestamp; } } ç‹€æ…‹æ©Ÿå¼•æ“å¯¦ä½œ 1. é€šç”¨ç‹€æ…‹æ©Ÿå¼•æ“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 /** * é€šç”¨ç‹€æ…‹æ©Ÿä»‹é¢ */ public interface StateMachine\u0026lt;S extends Enum\u0026lt;S\u0026gt;, E extends Enum\u0026lt;E\u0026gt;, C\u0026gt; { S getCurrentState(); void sendEvent(E event, C context); Set\u0026lt;E\u0026gt; getAvailableEvents(); boolean canTransition(E event); void addTransitionListener(TransitionListener\u0026lt;S, E, C\u0026gt; listener); void removeTransitionListener(TransitionListener\u0026lt;S, E, C\u0026gt; listener); } /** * ç‹€æ…‹è½‰æ›ç›£è½å™¨ */ public interface TransitionListener\u0026lt;S extends Enum\u0026lt;S\u0026gt;, E extends Enum\u0026lt;E\u0026gt;, C\u0026gt; { void onTransition(S fromState, S toState, E event, C context); void onTransitionFailed(S currentState, E event, C context, Exception exception); } /** * ç‹€æ…‹è½‰æ›å®šç¾© */ public class StateTransition\u0026lt;S extends Enum\u0026lt;S\u0026gt;, E extends Enum\u0026lt;E\u0026gt;, C\u0026gt; { private final S fromState; private final S toState; private final E event; private final Predicate\u0026lt;C\u0026gt; guard; private final Consumer\u0026lt;C\u0026gt; action; public StateTransition(S fromState, S toState, E event) { this(fromState, toState, event, null, null); } public StateTransition(S fromState, S toState, E event, Predicate\u0026lt;C\u0026gt; guard) { this(fromState, toState, event, guard, null); } public StateTransition(S fromState, S toState, E event, Predicate\u0026lt;C\u0026gt; guard, Consumer\u0026lt;C\u0026gt; action) { this.fromState = fromState; this.toState = toState; this.event = event; this.guard = guard != null ? guard : context -\u0026gt; true; this.action = action; } public boolean canExecute(S currentState, E triggerEvent, C context) { return fromState.equals(currentState) \u0026amp;\u0026amp; event.equals(triggerEvent) \u0026amp;\u0026amp; guard.test(context); } public void execute(C context) { if (action != null) { action.accept(context); } } // Getters public S getFromState() { return fromState; } public S getToState() { return toState; } public E getEvent() { return event; } } /** * ç‹€æ…‹æ©Ÿå¯¦ä½œ */ public class DefaultStateMachine\u0026lt;S extends Enum\u0026lt;S\u0026gt;, E extends Enum\u0026lt;E\u0026gt;, C\u0026gt; implements StateMachine\u0026lt;S, E, C\u0026gt; { private S currentState; private final Map\u0026lt;String, StateTransition\u0026lt;S, E, C\u0026gt;\u0026gt; transitions; private final List\u0026lt;TransitionListener\u0026lt;S, E, C\u0026gt;\u0026gt; listeners; public DefaultStateMachine(S initialState) { this.currentState = initialState; this.transitions = new ConcurrentHashMap\u0026lt;\u0026gt;(); this.listeners = new CopyOnWriteArrayList\u0026lt;\u0026gt;(); } public void addTransition(StateTransition\u0026lt;S, E, C\u0026gt; transition) { String key = createTransitionKey(transition.getFromState(), transition.getEvent()); transitions.put(key, transition); } @Override public synchronized void sendEvent(E event, C context) { String key = createTransitionKey(currentState, event); StateTransition\u0026lt;S, E, C\u0026gt; transition = transitions.get(key); if (transition == null) { String error = String.format(\u0026#34;æ²’æœ‰å¾ç‹€æ…‹ %s é€éäº‹ä»¶ %s çš„è½‰æ›\u0026#34;, currentState, event); notifyTransitionFailed(currentState, event, context, new IllegalStateException(error)); throw new IllegalStateException(error); } if (!transition.canExecute(currentState, event, context)) { String error = String.format(\u0026#34;è½‰æ›æ¢ä»¶ä¸æ»¿è¶³: %s -\u0026gt; %s (%s)\u0026#34;, currentState, transition.getToState(), event); notifyTransitionFailed(currentState, event, context, new IllegalStateException(error)); throw new IllegalStateException(error); } try { S fromState = currentState; transition.execute(context); currentState = transition.getToState(); notifyTransition(fromState, currentState, event, context); } catch (Exception e) { notifyTransitionFailed(currentState, event, context, e); throw new RuntimeException(\u0026#34;ç‹€æ…‹è½‰æ›åŸ·è¡Œå¤±æ•—\u0026#34;, e); } } @Override public S getCurrentState() { return currentState; } @Override public Set\u0026lt;E\u0026gt; getAvailableEvents() { return transitions.keySet().stream() .filter(key -\u0026gt; key.startsWith(currentState.name() + \u0026#34;:\u0026#34;)) .map(key -\u0026gt; key.substring(key.indexOf(\u0026#34;:\u0026#34;) + 1)) .map(eventName -\u0026gt; Enum.valueOf(getEventClass(), eventName)) .collect(Collectors.toSet()); } @Override public boolean canTransition(E event) { String key = createTransitionKey(currentState, event); return transitions.containsKey(key); } @Override public void addTransitionListener(TransitionListener\u0026lt;S, E, C\u0026gt; listener) { listeners.add(listener); } @Override public void removeTransitionListener(TransitionListener\u0026lt;S, E, C\u0026gt; listener) { listeners.remove(listener); } private String createTransitionKey(S state, E event) { return state.name() + \u0026#34;:\u0026#34; + event.name(); } private void notifyTransition(S fromState, S toState, E event, C context) { for (TransitionListener\u0026lt;S, E, C\u0026gt; listener : listeners) { try { listener.onTransition(fromState, toState, event, context); } catch (Exception e) { System.err.println(\u0026#34;è½‰æ›ç›£è½å™¨åŸ·è¡ŒéŒ¯èª¤: \u0026#34; + e.getMessage()); } } } private void notifyTransitionFailed(S currentState, E event, C context, Exception exception) { for (TransitionListener\u0026lt;S, E, C\u0026gt; listener : listeners) { try { listener.onTransitionFailed(currentState, event, context, exception); } catch (Exception e) { System.err.println(\u0026#34;è½‰æ›å¤±æ•—ç›£è½å™¨åŸ·è¡ŒéŒ¯èª¤: \u0026#34; + e.getMessage()); } } } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) private Class\u0026lt;E\u0026gt; getEventClass() { // é€™æ˜¯ä¸€å€‹ç°¡åŒ–çš„å¯¦ä½œï¼Œå¯¦éš›æ‡‰ç”¨ä¸­å¯èƒ½éœ€è¦æ›´è¤‡é›œçš„é¡å‹æ¨æ–· return (Class\u0026lt;E\u0026gt;) transitions.values().iterator().next().getEvent().getClass(); } } /** * ç‹€æ…‹æ©Ÿå»ºæ§‹å™¨ */ public class StateMachineBuilder\u0026lt;S extends Enum\u0026lt;S\u0026gt;, E extends Enum\u0026lt;E\u0026gt;, C\u0026gt; { private final S initialState; private final List\u0026lt;StateTransition\u0026lt;S, E, C\u0026gt;\u0026gt; transitions; public StateMachineBuilder(S initialState) { this.initialState = initialState; this.transitions = new ArrayList\u0026lt;\u0026gt;(); } public static \u0026lt;S extends Enum\u0026lt;S\u0026gt;, E extends Enum\u0026lt;E\u0026gt;, C\u0026gt; StateMachineBuilder\u0026lt;S, E, C\u0026gt; create(S initialState) { return new StateMachineBuilder\u0026lt;\u0026gt;(initialState); } public StateMachineBuilder\u0026lt;S, E, C\u0026gt; transition(S from, S to, E event) { transitions.add(new StateTransition\u0026lt;\u0026gt;(from, to, event)); return this; } public StateMachineBuilder\u0026lt;S, E, C\u0026gt; transition(S from, S to, E event, Predicate\u0026lt;C\u0026gt; guard) { transitions.add(new StateTransition\u0026lt;\u0026gt;(from, to, event, guard)); return this; } public StateMachineBuilder\u0026lt;S, E, C\u0026gt; transition(S from, S to, E event, Predicate\u0026lt;C\u0026gt; guard, Consumer\u0026lt;C\u0026gt; action) { transitions.add(new StateTransition\u0026lt;\u0026gt;(from, to, event, guard, action)); return this; } public StateMachine\u0026lt;S, E, C\u0026gt; build() { DefaultStateMachine\u0026lt;S, E, C\u0026gt; stateMachine = new DefaultStateMachine\u0026lt;\u0026gt;(initialState); transitions.forEach(stateMachine::addTransition); return stateMachine; } } 2. ç‹€æ…‹æ©Ÿä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 /** * è¨‚å–®ç‹€æ…‹å’Œäº‹ä»¶å®šç¾© */ public enum OrderState { PENDING, CONFIRMED, PAID, SHIPPED, DELIVERED, CANCELLED, RETURNED } public enum OrderEvent { CONFIRM, PAY, SHIP, DELIVER, CANCEL, RETURN } /** * è¨‚å–®ä¸Šä¸‹æ–‡ */ public class OrderContext { private String orderId; private BigDecimal amount; private String customerId; private boolean paymentVerified; private boolean inventoryAvailable; public OrderContext(String orderId, BigDecimal amount, String customerId) { this.orderId = orderId; this.amount = amount; this.customerId = customerId; this.paymentVerified = false; this.inventoryAvailable = true; } // Getters and Setters public String getOrderId() { return orderId; } public BigDecimal getAmount() { return amount; } public String getCustomerId() { return customerId; } public boolean isPaymentVerified() { return paymentVerified; } public void setPaymentVerified(boolean paymentVerified) { this.paymentVerified = paymentVerified; } public boolean isInventoryAvailable() { return inventoryAvailable; } public void setInventoryAvailable(boolean inventoryAvailable) { this.inventoryAvailable = inventoryAvailable; } } /** * è¨‚å–®ç‹€æ…‹æ©Ÿç¯„ä¾‹ */ public class OrderStateMachineExample { public static void main(String[] args) { // å»ºç«‹è¨‚å–®ç‹€æ…‹æ©Ÿ StateMachine\u0026lt;OrderState, OrderEvent, OrderContext\u0026gt; orderStateMachine = StateMachineBuilder.\u0026lt;OrderState, OrderEvent, OrderContext\u0026gt;create(OrderState.PENDING) // åŸºæœ¬è½‰æ› .transition(OrderState.PENDING, OrderState.CONFIRMED, OrderEvent.CONFIRM) .transition(OrderState.CONFIRMED, OrderState.PAID, OrderEvent.PAY, context -\u0026gt; context.isInventoryAvailable()) // æœ‰åº«å­˜æ‰èƒ½ä»˜æ¬¾ .transition(OrderState.PAID, OrderState.SHIPPED, OrderEvent.SHIP, context -\u0026gt; context.isPaymentVerified()) // ä»˜æ¬¾ç¢ºèªå¾Œæ‰èƒ½ç™¼è²¨ .transition(OrderState.SHIPPED, OrderState.DELIVERED, OrderEvent.DELIVER) // å–æ¶ˆè½‰æ› .transition(OrderState.PENDING, OrderState.CANCELLED, OrderEvent.CANCEL) .transition(OrderState.CONFIRMED, OrderState.CANCELLED, OrderEvent.CANCEL) .transition(OrderState.PAID, OrderState.CANCELLED, OrderEvent.CANCEL, null, context -\u0026gt; System.out.println(\u0026#34;åŸ·è¡Œé€€æ¬¾: \u0026#34; + context.getOrderId())) // é€€è²¨è½‰æ› .transition(OrderState.DELIVERED, OrderState.RETURNED, OrderEvent.RETURN, null, context -\u0026gt; System.out.println(\u0026#34;è™•ç†é€€è²¨: \u0026#34; + context.getOrderId())) .build(); // æ·»åŠ è½‰æ›ç›£è½å™¨ orderStateMachine.addTransitionListener(new TransitionListener\u0026lt;OrderState, OrderEvent, OrderContext\u0026gt;() { @Override public void onTransition(OrderState fromState, OrderState toState, OrderEvent event, OrderContext context) { System.out.printf(\u0026#34;è¨‚å–® %s: %s -\u0026gt; %s (äº‹ä»¶: %s)\\n\u0026#34;, context.getOrderId(), fromState, toState, event); } @Override public void onTransitionFailed(OrderState currentState, OrderEvent event, OrderContext context, Exception exception) { System.err.printf(\u0026#34;è½‰æ›å¤±æ•— - è¨‚å–® %s åœ¨ç‹€æ…‹ %s åŸ·è¡Œäº‹ä»¶ %s: %s\\n\u0026#34;, context.getOrderId(), currentState, event, exception.getMessage()); } }); // æ¨¡æ“¬è¨‚å–®è™•ç†æµç¨‹ OrderContext orderContext = new OrderContext(\u0026#34;ORDER-001\u0026#34;, new BigDecimal(\u0026#34;1000\u0026#34;), \u0026#34;CUST-001\u0026#34;); try { System.out.println(\u0026#34;=== è¨‚å–®è™•ç†æµç¨‹ ===\u0026#34;); System.out.println(\u0026#34;åˆå§‹ç‹€æ…‹: \u0026#34; + orderStateMachine.getCurrentState()); System.out.println(\u0026#34;å¯ç”¨äº‹ä»¶: \u0026#34; + orderStateMachine.getAvailableEvents()); // ç¢ºèªè¨‚å–® orderStateMachine.sendEvent(OrderEvent.CONFIRM, orderContext); System.out.println(\u0026#34;å¯ç”¨äº‹ä»¶: \u0026#34; + orderStateMachine.getAvailableEvents()); // ä»˜æ¬¾ orderStateMachine.sendEvent(OrderEvent.PAY, orderContext); System.out.println(\u0026#34;å¯ç”¨äº‹ä»¶: \u0026#34; + orderStateMachine.getAvailableEvents()); // é©—è­‰ä»˜æ¬¾ orderContext.setPaymentVerified(true); // ç™¼è²¨ orderStateMachine.sendEvent(OrderEvent.SHIP, orderContext); System.out.println(\u0026#34;å¯ç”¨äº‹ä»¶: \u0026#34; + orderStateMachine.getAvailableEvents()); // é€é” orderStateMachine.sendEvent(OrderEvent.DELIVER, orderContext); System.out.println(\u0026#34;æœ€çµ‚ç‹€æ…‹: \u0026#34; + orderStateMachine.getCurrentState()); System.out.println(\u0026#34;å¯ç”¨äº‹ä»¶: \u0026#34; + orderStateMachine.getAvailableEvents()); } catch (Exception e) { System.err.println(\u0026#34;è™•ç†éŒ¯èª¤: \u0026#34; + e.getMessage()); } } } æœ€ä½³å¯¦è¸èˆ‡è¨­è¨ˆåŸå‰‡ 1. ç‹€æ…‹æ¨¡å¼ vs ç­–ç•¥æ¨¡å¼ ç‰¹å¾µ ç‹€æ…‹æ¨¡å¼ ç­–ç•¥æ¨¡å¼ ç›®çš„ æ ¹æ“šå…§éƒ¨ç‹€æ…‹æ”¹è®Šè¡Œç‚º å°è£å¯äº’æ›çš„ç®—æ³• ç‹€æ…‹/ç­–ç•¥æ•¸é‡ é€šå¸¸å›ºå®šä¸”æœ‰é™ å¯å‹•æ…‹æ“´å±• è½‰æ›æ§åˆ¶ ç‹€æ…‹è‡ªå·±æ§åˆ¶è½‰æ› å®¢æˆ¶ç«¯é¸æ“‡ç­–ç•¥ ä¸Šä¸‹æ–‡ä¾è³´ ç‹€æ…‹çŸ¥é“ä¸Šä¸‹æ–‡ ç­–ç•¥ç›¸å°ç¨ç«‹ ç”Ÿå‘½é€±æœŸ ç‹€æ…‹å¯èƒ½æœ‰ç”Ÿå‘½é€±æœŸ ç­–ç•¥é€šå¸¸ç„¡ç‹€æ…‹ 2. è¨­è¨ˆåŸå‰‡ å–®ä¸€è·è²¬åŸå‰‡ (SRP) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // âœ… å¥½çš„è¨­è¨ˆï¼šæ¯å€‹ç‹€æ…‹é¡åˆ¥åªè² è²¬ä¸€å€‹ç‹€æ…‹çš„è¡Œç‚º public class DraftDocumentState implements DocumentState { @Override public void submit(DocumentContext context) { // åªè™•ç†è‰ç¨¿ç‹€æ…‹çš„æäº¤é‚è¼¯ validateDocument(context); context.setState(new UnderReviewState()); } private void validateDocument(DocumentContext context) { // æ–‡ä»¶é©—è­‰é‚è¼¯ } } // âŒ å£çš„è¨­è¨ˆï¼šä¸€å€‹é¡åˆ¥è™•ç†å¤šå€‹ç‹€æ…‹ public class DocumentProcessor { public void processDocument(DocumentContext context, String action) { switch (context.getStatus()) { case DRAFT: if (\u0026#34;submit\u0026#34;.equals(action)) { // è™•ç†æäº¤ } break; case UNDER_REVIEW: if (\u0026#34;approve\u0026#34;.equals(action)) { // è™•ç†æ‰¹å‡† } break; // æ›´å¤šç‹€æ…‹... } } } é–‹é–‰åŸå‰‡ (OCP) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // âœ… å®¹æ˜“æ“´å±•ï¼šæ·»åŠ æ–°ç‹€æ…‹ä¸éœ€è¦ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ public class ArchiveState implements DocumentState { @Override public void submit(DocumentContext document) { throw new IllegalStateException(\u0026#34;å·²æ­¸æª”çš„æ–‡ä»¶ç„¡æ³•é‡æ–°æäº¤\u0026#34;); } @Override public void approve(DocumentContext document) { throw new IllegalStateException(\u0026#34;å·²æ­¸æª”çš„æ–‡ä»¶ç„¡æ³•æ‰¹å‡†\u0026#34;); } // å¯¦ç¾å…¶ä»–æ–¹æ³•... } 3. æ•ˆèƒ½å„ªåŒ–ç­–ç•¥ ç‹€æ…‹å¯¦ä¾‹ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 /** * ç‹€æ…‹å¯¦ä¾‹æ±  - é¿å…é‡è¤‡å‰µå»ºç‹€æ…‹å°è±¡ */ public class StateInstancePool { private static final Map\u0026lt;Class\u0026lt;? extends DocumentState\u0026gt;, DocumentState\u0026gt; INSTANCE_POOL = new ConcurrentHashMap\u0026lt;\u0026gt;(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public static \u0026lt;T extends DocumentState\u0026gt; T getInstance(Class\u0026lt;T\u0026gt; stateClass) { return (T) INSTANCE_POOL.computeIfAbsent(stateClass, key -\u0026gt; { try { return key.getDeclaredConstructor().newInstance(); } catch (Exception e) { throw new RuntimeException(\u0026#34;ç„¡æ³•å‰µå»ºç‹€æ…‹å¯¦ä¾‹: \u0026#34; + key.getName(), e); } }); } } // ä½¿ç”¨ç‹€æ…‹æ±  public class OptimizedDraftState implements DocumentState { @Override public void submit(DocumentContext document) { document.setState(StateInstancePool.getInstance(UnderReviewState.class)); } } ç‹€æ…‹è½‰æ›å¿«å– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * ç‹€æ…‹è½‰æ›å¿«å– */ @Component public class StateTransitionCache { private final Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; transitionCache = new ConcurrentHashMap\u0026lt;\u0026gt;(); public boolean isValidTransition(String fromState, String toState) { String key = fromState + \u0026#34;-\u0026gt;\u0026#34; + toState; return transitionCache.computeIfAbsent(fromState, this::loadValidTransitions) .contains(toState); } private Set\u0026lt;String\u0026gt; loadValidTransitions(String fromState) { // å¾é…ç½®æˆ–è³‡æ–™åº«è¼‰å…¥æœ‰æ•ˆè½‰æ› // é€™è£¡ç°¡åŒ–ç‚ºç¡¬ç·¨ç¢¼ switch (fromState) { case \u0026#34;DRAFT\u0026#34;: return Set.of(\u0026#34;UNDER_REVIEW\u0026#34;); case \u0026#34;UNDER_REVIEW\u0026#34;: return Set.of(\u0026#34;APPROVED\u0026#34;, \u0026#34;REJECTED\u0026#34;); case \u0026#34;APPROVED\u0026#34;: return Set.of(\u0026#34;PUBLISHED\u0026#34;, \u0026#34;REJECTED\u0026#34;); case \u0026#34;REJECTED\u0026#34;: return Set.of(\u0026#34;UNDER_REVIEW\u0026#34;); default: return Set.of(); } } } 4. æ¸¬è©¦ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 /** * ç‹€æ…‹æ¨¡å¼å–®å…ƒæ¸¬è©¦ */ @ExtendWith(MockitoExtension.class) class DocumentStateTest { @Mock private DocumentContext mockContext; @Test void testDraftStateSubmit() { // Given DraftState draftState = new DraftState(); // When draftState.submit(mockContext); // Then verify(mockContext).setState(any(UnderReviewState.class)); } @Test void testDraftStateCannotApprove() { // Given DraftState draftState = new DraftState(); // When \u0026amp; Then assertThrows(IllegalStateException.class, () -\u0026gt; { draftState.approve(mockContext); }); } @Test void testStateTransitionValidation() { // Given DocumentContext document = new DocumentContext(\u0026#34;DOC-001\u0026#34;, \u0026#34;Content\u0026#34;, \u0026#34;Author\u0026#34;); // When \u0026amp; Then assertDoesNotThrow(() -\u0026gt; document.submit()); assertEquals(\u0026#34;UNDER_REVIEW\u0026#34;, document.getCurrentState().getStatusName()); assertDoesNotThrow(() -\u0026gt; document.approve()); assertEquals(\u0026#34;APPROVED\u0026#34;, document.getCurrentState().getStatusName()); assertThrows(IllegalStateException.class, () -\u0026gt; document.submit()); } } /** * ç‹€æ…‹æ©Ÿæ•´åˆæ¸¬è©¦ */ @SpringBootTest @Transactional class DocumentWorkflowIntegrationTest { @Autowired private DocumentManagementService documentService; @Test void testCompleteDocumentWorkflow() { // Given DocumentEntity document = documentService.createDocument( \u0026#34;æ¸¬è©¦æ–‡ä»¶\u0026#34;, \u0026#34;æ¸¬è©¦å…§å®¹\u0026#34;, \u0026#34;æ¸¬è©¦ä½œè€…\u0026#34;); String documentId = document.getDocumentId(); // When \u0026amp; Then // æäº¤å¯©æ ¸ document = documentService.submitForReview(documentId); assertEquals(DocumentStatus.UNDER_REVIEW, document.getStatus()); // æ‰¹å‡†æ–‡ä»¶ document = documentService.approveDocument(documentId, \u0026#34;å¯©æ ¸é€šé\u0026#34;); assertEquals(DocumentStatus.APPROVED, document.getStatus()); // ç™¼å¸ƒæ–‡ä»¶ document = documentService.publishDocument(documentId); assertEquals(DocumentStatus.PUBLISHED, document.getStatus()); // é©—è­‰äº‹ä»¶æ­·å² List\u0026lt;DocumentEventEntity\u0026gt; events = documentService.getDocumentHistory(documentId); assertTrue(events.size() \u0026gt;= 4); // å‰µå»ºã€æäº¤ã€æ‰¹å‡†ã€ç™¼å¸ƒ } @Test void testInvalidStateTransition() { // Given DocumentEntity document = documentService.createDocument( \u0026#34;æ¸¬è©¦æ–‡ä»¶\u0026#34;, \u0026#34;æ¸¬è©¦å…§å®¹\u0026#34;, \u0026#34;æ¸¬è©¦ä½œè€…\u0026#34;); // When \u0026amp; Then assertThrows(IllegalStateException.class, () -\u0026gt; { documentService.publishDocument(document.getDocumentId()); // è‰ç¨¿ç„¡æ³•ç›´æ¥ç™¼å¸ƒ }); } } ç¸½çµèˆ‡æœ€ä½³å¯¦è¸ ç‹€æ…‹æ¨¡å¼çš„å„ªé» æ¸…æ™°çš„ç‹€æ…‹ç®¡ç†ï¼šå°‡ç‹€æ…‹ç›¸é—œçš„è¡Œç‚ºå°è£åœ¨ç¨ç«‹çš„é¡åˆ¥ä¸­ æ˜“æ–¼æ“´å±•ï¼šæ–°å¢ç‹€æ…‹ä¸éœ€è¦ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ é¿å…è¤‡é›œçš„æ¢ä»¶åˆ¤æ–·ï¼šæ¶ˆé™¤å¤§é‡çš„ if-else å’Œ switch-case èªå¥ ç¬¦åˆé–‹é–‰åŸå‰‡ï¼šå°æ“´å±•é–‹æ”¾ï¼Œå°ä¿®æ”¹å°é–‰ ç‹€æ…‹è½‰æ›æ˜ç¢ºï¼šç‹€æ…‹ä¹‹é–“çš„è½‰æ›é—œä¿‚æ¸…æ™°å¯è¦‹ ç‹€æ…‹æ¨¡å¼çš„ç¼ºé» é¡åˆ¥æ•¸é‡å¢åŠ ï¼šæ¯å€‹ç‹€æ…‹éƒ½éœ€è¦ä¸€å€‹é¡åˆ¥ è¤‡é›œåº¦å¢åŠ ï¼šå°æ–¼ç°¡å–®çš„ç‹€æ…‹é‚è¼¯å¯èƒ½éåº¦è¨­è¨ˆ ç‹€æ…‹å…±äº«å›°é›£ï¼šç‹€æ…‹ä¹‹é–“é›£ä»¥å…±äº«æ•¸æ“š ä½¿ç”¨å»ºè­° é©ç”¨å ´æ™¯ï¼š\nå°è±¡è¡Œç‚ºä¾è³´æ–¼å…¶ç‹€æ…‹ å­˜åœ¨å¤§é‡ç‹€æ…‹ç›¸é—œçš„æ¢ä»¶åˆ¤æ–· ç‹€æ…‹è½‰æ›é‚è¼¯è¤‡é›œ éœ€è¦æ˜ç¢ºçš„ç‹€æ…‹ç®¡ç† è¨­è¨ˆåŸå‰‡ï¼š\nä¿æŒç‹€æ…‹é¡åˆ¥çš„å–®ä¸€è·è²¬ ä½¿ç”¨å·¥å» æ¨¡å¼ç®¡ç†ç‹€æ…‹å¯¦ä¾‹ è€ƒæ…®ç‹€æ…‹è½‰æ›çš„åŸå­æ€§ å¯¦ä½œå®Œæ•´çš„ç•°å¸¸è™•ç† å¯¦ä½œæŠ€å·§ï¼š\nä½¿ç”¨æšèˆ‰å®šç¾©ç‹€æ…‹å’Œäº‹ä»¶ å¯¦ä½œç‹€æ…‹è½‰æ›é©—è­‰ æ·»åŠ äº‹ä»¶ç›£è½æ©Ÿåˆ¶ è€ƒæ…®æŒä¹…åŒ–ç‹€æ…‹ä¿¡æ¯ ç‹€æ…‹æ¨¡å¼æ˜¯ç®¡ç†å¾©é›œç‹€æ…‹é‚è¼¯çš„å¼·å¤§å·¥å…·ï¼Œç‰¹åˆ¥é©åˆå·¥ä½œæµç¨‹ã€è¨‚å–®è™•ç†ã€ç”¨æˆ¶èªè­‰ç­‰éœ€è¦æ˜ç¢ºç‹€æ…‹ç®¡ç†çš„å ´æ™¯ã€‚æ­£ç¢ºä½¿ç”¨ç‹€æ…‹æ¨¡å¼å¯ä»¥å¤§å¹…æå‡ä»£ç¢¼çš„å¯ç¶­è­·æ€§å’Œå¯æ“´å±•æ€§ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/state/","tags":["Design Pattern","State Pattern","Behavioral Pattern","State Machine","Finite State Machine","Dynamic Behavior","Context","State Transition","Java","Spring Boot","Enterprise Architecture","Workflow Engine","Business Process","Event-Driven Architecture","Order Processing","User Authentication","Document Lifecycle","Best Practices"],"title":"ç‹€æ…‹æ¨¡å¼ (State Pattern) å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šå‹•æ…‹è¡Œç‚ºåˆ‡æ›èˆ‡ç‹€æ…‹æ©Ÿè¨­è¨ˆæœ€ä½³å¯¦è¸"},{"content":"Command Pattern å‘½ä»¤æ¨¡å¼ Command Pattern æ˜¯è¡Œç‚ºå‹è¨­è¨ˆæ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒå°‡ä¸€å€‹è«‹æ±‚å°è£ç‚ºä¸€å€‹å°è±¡ï¼Œå¾è€Œè®“ä½ å¯ä»¥ç”¨ä¸åŒçš„è«‹æ±‚å°å®¢æˆ¶ç«¯é€²è¡Œåƒæ•¸åŒ–ã€å°è«‹æ±‚æ’éšŠæˆ–è¨˜éŒ„è«‹æ±‚æ—¥èªŒï¼Œä»¥åŠæ”¯æŒå¯æ’¤éŠ·çš„æ“ä½œã€‚\næ ¸å¿ƒæ¦‚å¿µ å‘½ä»¤æ¨¡å¼å°‡ç™¼å‡ºè«‹æ±‚çš„å°è±¡èˆ‡è™•ç†è«‹æ±‚çš„å°è±¡åˆ†é›¢é–‹ä¾†ã€‚é€™å€‹æ¨¡å¼çš„é—œéµåœ¨æ–¼å¼•å…¥äº†å‘½ä»¤å°è±¡ï¼Œå®ƒå°è£äº†ä¸€å€‹è¡Œç‚ºæˆ–ä¸€çµ„è¡Œç‚ºï¼Œä½¿å¾—å¯ä»¥åœ¨ä¸åŒçš„æ™‚é–“ã€ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­åŸ·è¡Œé€™äº›è¡Œç‚ºã€‚\nä¸»è¦çµ„æˆéƒ¨åˆ† Command (å‘½ä»¤æ¥å£): å®šç¾©åŸ·è¡Œæ“ä½œçš„æ¥å£ ConcreteCommand (å…·é«”å‘½ä»¤): å¯¦ç¾å‘½ä»¤æ¥å£ï¼Œç¶å®šæ¥æ”¶è€…å’Œå‹•ä½œ Receiver (æ¥æ”¶è€…): åŸ·è¡Œå¯¦éš›æ“ä½œçš„å°è±¡ Invoker (èª¿ç”¨è€…): èª¿ç”¨å‘½ä»¤å°è±¡åŸ·è¡Œè«‹æ±‚ Client (å®¢æˆ¶ç«¯): å‰µå»ºå…·é«”å‘½ä»¤å°è±¡ä¸¦è¨­ç½®æ¥æ”¶è€… ä¸»è¦å„ªå‹¢ è§£è€¦: èª¿ç”¨è€…å’Œæ¥æ”¶è€…ä¹‹é–“å®Œå…¨è§£è€¦ å¯æ’¤éŠ·: æ”¯æŒæ’¤éŠ·å’Œé‡åšæ“ä½œ å®å‘½ä»¤: æ”¯æŒå‘½ä»¤çš„çµ„åˆå’Œæ‰¹è™•ç† æ—¥èªŒè¨˜éŒ„: ä¾¿æ–¼è¨˜éŒ„å’Œå¯©è¨ˆæ“ä½œ éšŠåˆ—è™•ç†: æ”¯æŒè«‹æ±‚çš„æ’éšŠå’Œå»¶é²åŸ·è¡Œ 1. åŸºç¤å‘½ä»¤æ¨¡å¼å¯¦ç¾ åŸºæœ¬å‘½ä»¤æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 // å‘½ä»¤æ¥å£ public interface Command { void execute(); void undo(); String getDescription(); } // ç©ºå‘½ä»¤å¯¦ç¾ - ç©ºå°è±¡æ¨¡å¼ public class NoCommand implements Command { @Override public void execute() { // ä»€éº¼éƒ½ä¸åš } @Override public void undo() { // ä»€éº¼éƒ½ä¸åš } @Override public String getDescription() { return \u0026#34;No Command\u0026#34;; } } // æŠ½è±¡å‘½ä»¤åŸºé¡ public abstract class AbstractCommand implements Command { protected final String description; protected final LocalDateTime timestamp; public AbstractCommand(String description) { this.description = description; this.timestamp = LocalDateTime.now(); } @Override public String getDescription() { return description; } public LocalDateTime getTimestamp() { return timestamp; } @Override public String toString() { return String.format(\u0026#34;%s [%s]\u0026#34;, description, timestamp); } } æ–‡æœ¬ç·¨è¼¯å™¨å‘½ä»¤ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 // æ¥æ”¶è€… - æ–‡æœ¬ç·¨è¼¯å™¨ public class TextEditor { private StringBuilder content; private int cursor; public TextEditor() { this.content = new StringBuilder(); this.cursor = 0; } public void insertText(String text) { content.insert(cursor, text); cursor += text.length(); } public void deleteText(int length) { int startPos = Math.max(0, cursor - length); content.delete(startPos, cursor); cursor = startPos; } public void setCursor(int position) { this.cursor = Math.max(0, Math.min(position, content.length())); } public String getContent() { return content.toString(); } public int getCursor() { return cursor; } public void clear() { content.setLength(0); cursor = 0; } } // å…·é«”å‘½ä»¤å¯¦ç¾ public class InsertTextCommand extends AbstractCommand { private final TextEditor editor; private final String text; private final int savedCursor; public InsertTextCommand(TextEditor editor, String text) { super(\u0026#34;Insert: \u0026#34; + text); this.editor = editor; this.text = text; this.savedCursor = editor.getCursor(); } @Override public void execute() { editor.insertText(text); } @Override public void undo() { editor.setCursor(savedCursor + text.length()); editor.deleteText(text.length()); } } public class DeleteTextCommand extends AbstractCommand { private final TextEditor editor; private final int length; private final int savedCursor; private String deletedText; public DeleteTextCommand(TextEditor editor, int length) { super(\u0026#34;Delete: \u0026#34; + length + \u0026#34; chars\u0026#34;); this.editor = editor; this.length = length; this.savedCursor = editor.getCursor(); } @Override public void execute() { int startPos = Math.max(0, savedCursor - length); deletedText = editor.getContent().substring(startPos, savedCursor); editor.deleteText(length); } @Override public void undo() { editor.setCursor(savedCursor - length); editor.insertText(deletedText); } } public class ClearCommand extends AbstractCommand { private final TextEditor editor; private String savedContent; private int savedCursor; public ClearCommand(TextEditor editor) { super(\u0026#34;Clear all\u0026#34;); this.editor = editor; } @Override public void execute() { savedContent = editor.getContent(); savedCursor = editor.getCursor(); editor.clear(); } @Override public void undo() { editor.clear(); editor.insertText(savedContent); editor.setCursor(savedCursor); } } å‘½ä»¤èª¿ç”¨è€…å’Œæ­·å²ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 // å‘½ä»¤èª¿ç”¨è€… public class CommandInvoker { private final Stack\u0026lt;Command\u0026gt; undoStack = new Stack\u0026lt;\u0026gt;(); private final Stack\u0026lt;Command\u0026gt; redoStack = new Stack\u0026lt;\u0026gt;(); private final int maxHistorySize; public CommandInvoker(int maxHistorySize) { this.maxHistorySize = maxHistorySize; } public void executeCommand(Command command) { command.execute(); // æ·»åŠ åˆ°æ’¤éŠ·å †æ£§ undoStack.push(command); // æ¸…ç©ºé‡åšå †æ£§ redoStack.clear(); // é™åˆ¶æ­·å²å¤§å° if (undoStack.size() \u0026gt; maxHistorySize) { undoStack.removeElementAt(0); } } public boolean canUndo() { return !undoStack.isEmpty(); } public boolean canRedo() { return !redoStack.isEmpty(); } public void undo() { if (canUndo()) { Command command = undoStack.pop(); command.undo(); redoStack.push(command); } } public void redo() { if (canRedo()) { Command command = redoStack.pop(); command.execute(); undoStack.push(command); } } public List\u0026lt;Command\u0026gt; getUndoHistory() { return new ArrayList\u0026lt;\u0026gt;(undoStack); } public List\u0026lt;Command\u0026gt; getRedoHistory() { return new ArrayList\u0026lt;\u0026gt;(redoStack); } public void clearHistory() { undoStack.clear(); redoStack.clear(); } } åŸºç¤ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 public class BasicCommandDemo { public static void main(String[] args) { // å‰µå»ºæ–‡æœ¬ç·¨è¼¯å™¨å’Œå‘½ä»¤èª¿ç”¨è€… TextEditor editor = new TextEditor(); CommandInvoker invoker = new CommandInvoker(10); // åŸ·è¡Œä¸€ç³»åˆ—å‘½ä»¤ invoker.executeCommand(new InsertTextCommand(editor, \u0026#34;Hello\u0026#34;)); System.out.println(\u0026#34;After insert \u0026#39;Hello\u0026#39;: \u0026#34; + editor.getContent()); invoker.executeCommand(new InsertTextCommand(editor, \u0026#34; World\u0026#34;)); System.out.println(\u0026#34;After insert \u0026#39; World\u0026#39;: \u0026#34; + editor.getContent()); invoker.executeCommand(new DeleteTextCommand(editor, 5)); System.out.println(\u0026#34;After delete 5 chars: \u0026#34; + editor.getContent()); // æ’¤éŠ·æ“ä½œ System.out.println(\u0026#34;\\n=== Undo Operations ===\u0026#34;); while (invoker.canUndo()) { System.out.println(\u0026#34;Undoing...\u0026#34;); invoker.undo(); System.out.println(\u0026#34;Content: \u0026#34; + editor.getContent()); } // é‡åšæ“ä½œ System.out.println(\u0026#34;\\n=== Redo Operations ===\u0026#34;); while (invoker.canRedo()) { System.out.println(\u0026#34;Redoing...\u0026#34;); invoker.redo(); System.out.println(\u0026#34;Content: \u0026#34; + editor.getContent()); } // é¡¯ç¤ºæ­·å²è¨˜éŒ„ System.out.println(\u0026#34;\\n=== Command History ===\u0026#34;); invoker.getUndoHistory().forEach(System.out::println); } } 2. å®å‘½ä»¤å’Œè¤‡åˆå‘½ä»¤ å®å‘½ä»¤å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // å®å‘½ä»¤ - çµ„åˆå¤šå€‹å‘½ä»¤ public class MacroCommand extends AbstractCommand { private final List\u0026lt;Command\u0026gt; commands = new ArrayList\u0026lt;\u0026gt;(); public MacroCommand(String description) { super(description); } public void addCommand(Command command) { commands.add(command); } public void removeCommand(Command command) { commands.remove(command); } @Override public void execute() { for (Command command : commands) { command.execute(); } } @Override public void undo() { // åå‘åŸ·è¡Œæ’¤éŠ·æ“ä½œ for (int i = commands.size() - 1; i \u0026gt;= 0; i--) { commands.get(i).undo(); } } public List\u0026lt;Command\u0026gt; getCommands() { return new ArrayList\u0026lt;\u0026gt;(commands); } } // æ¢ä»¶å‘½ä»¤ - æ ¹æ“šæ¢ä»¶åŸ·è¡Œ public class ConditionalCommand extends AbstractCommand { private final Command command; private final Supplier\u0026lt;Boolean\u0026gt; condition; public ConditionalCommand(String description, Command command, Supplier\u0026lt;Boolean\u0026gt; condition) { super(description); this.command = command; this.condition = condition; } @Override public void execute() { if (condition.get()) { command.execute(); } } @Override public void undo() { if (condition.get()) { command.undo(); } } } ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public class MacroCommandDemo { public static void main(String[] args) { TextEditor editor = new TextEditor(); CommandInvoker invoker = new CommandInvoker(10); // å‰µå»ºå®å‘½ä»¤ MacroCommand formatTextMacro = new MacroCommand(\u0026#34;Format Text\u0026#34;); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34;public class HelloWorld {\u0026#34;)); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34;\\n\u0026#34;)); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34; public static void main(String[] args) {\u0026#34;)); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34;\\n\u0026#34;)); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34; System.out.println(\\\u0026#34;Hello, World!\\\u0026#34;);\u0026#34;)); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34;\\n\u0026#34;)); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34; }\u0026#34;)); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34;\\n\u0026#34;)); formatTextMacro.addCommand(new InsertTextCommand(editor, \u0026#34;}\u0026#34;)); // åŸ·è¡Œå®å‘½ä»¤ invoker.executeCommand(formatTextMacro); System.out.println(\u0026#34;After macro execution:\u0026#34;); System.out.println(editor.getContent()); // æ’¤éŠ·å®å‘½ä»¤ invoker.undo(); System.out.println(\u0026#34;\\nAfter undo macro:\u0026#34;); System.out.println(editor.getContent()); } } 3. CQRS (Command Query Responsibility Segregation) CQRS åŸºç¤çµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // å‘½ä»¤åŸºé¡ public abstract class CommandBase { private final String commandId; private final LocalDateTime timestamp; public CommandBase() { this.commandId = UUID.randomUUID().toString(); this.timestamp = LocalDateTime.now(); } public String getCommandId() { return commandId; } public LocalDateTime getTimestamp() { return timestamp; } } // æŸ¥è©¢åŸºé¡ public abstract class QueryBase\u0026lt;T\u0026gt; { private final String queryId; private final LocalDateTime timestamp; public QueryBase() { this.queryId = UUID.randomUUID().toString(); this.timestamp = LocalDateTime.now(); } public String getQueryId() { return queryId; } public LocalDateTime getTimestamp() { return timestamp; } } // ç”¨æˆ¶é ˜åŸŸæ¨¡å‹ public class User { private String id; private String email; private String name; private LocalDateTime createdAt; private LocalDateTime updatedAt; public User(String id, String email, String name) { this.id = id; this.email = email; this.name = name; this.createdAt = LocalDateTime.now(); this.updatedAt = LocalDateTime.now(); } public void updateName(String newName) { this.name = newName; this.updatedAt = LocalDateTime.now(); } public void updateEmail(String newEmail) { this.email = newEmail; this.updatedAt = LocalDateTime.now(); } // getters public String getId() { return id; } public String getEmail() { return email; } public String getName() { return name; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } } CQRS å‘½ä»¤å®šç¾© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 // ç”¨æˆ¶å‘½ä»¤ public class CreateUserCommand extends CommandBase { private final String email; private final String name; public CreateUserCommand(String email, String name) { super(); this.email = email; this.name = name; } public String getEmail() { return email; } public String getName() { return name; } } public class UpdateUserNameCommand extends CommandBase { private final String userId; private final String newName; public UpdateUserNameCommand(String userId, String newName) { super(); this.userId = userId; this.newName = newName; } public String getUserId() { return userId; } public String getNewName() { return newName; } } public class UpdateUserEmailCommand extends CommandBase { private final String userId; private final String newEmail; public UpdateUserEmailCommand(String userId, String newEmail) { super(); this.userId = userId; this.newEmail = newEmail; } public String getUserId() { return userId; } public String getNewEmail() { return newEmail; } } public class DeleteUserCommand extends CommandBase { private final String userId; public DeleteUserCommand(String userId) { super(); this.userId = userId; } public String getUserId() { return userId; } } CQRS æŸ¥è©¢å®šç¾© 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // ç”¨æˆ¶æŸ¥è©¢ public class GetUserByIdQuery extends QueryBase\u0026lt;User\u0026gt; { private final String userId; public GetUserByIdQuery(String userId) { super(); this.userId = userId; } public String getUserId() { return userId; } } public class GetUserByEmailQuery extends QueryBase\u0026lt;User\u0026gt; { private final String email; public GetUserByEmailQuery(String email) { super(); this.email = email; } public String getEmail() { return email; } } public class GetAllUsersQuery extends QueryBase\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; { private final int page; private final int size; public GetAllUsersQuery(int page, int size) { super(); this.page = page; this.size = size; } public int getPage() { return page; } public int getSize() { return size; } } CQRS å‘½ä»¤å’ŒæŸ¥è©¢è™•ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 // å‘½ä»¤è™•ç†å™¨æ¥å£ public interface CommandHandler\u0026lt;T extends CommandBase\u0026gt; { void handle(T command); } // æŸ¥è©¢è™•ç†å™¨æ¥å£ public interface QueryHandler\u0026lt;Q extends QueryBase\u0026lt;R\u0026gt;, R\u0026gt; { R handle(Q query); } // ç”¨æˆ¶å‘½ä»¤è™•ç†å™¨ @Component public class UserCommandHandler implements CommandHandler\u0026lt;CreateUserCommand\u0026gt;, CommandHandler\u0026lt;UpdateUserNameCommand\u0026gt;, CommandHandler\u0026lt;UpdateUserEmailCommand\u0026gt;, CommandHandler\u0026lt;DeleteUserCommand\u0026gt; { private final Map\u0026lt;String, User\u0026gt; userStore = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Override public void handle(CreateUserCommand command) { String userId = UUID.randomUUID().toString(); User user = new User(userId, command.getEmail(), command.getName()); userStore.put(userId, user); System.out.println(\u0026#34;User created: \u0026#34; + userId); } @Override public void handle(UpdateUserNameCommand command) { User user = userStore.get(command.getUserId()); if (user != null) { user.updateName(command.getNewName()); System.out.println(\u0026#34;User name updated: \u0026#34; + command.getUserId()); } else { throw new IllegalArgumentException(\u0026#34;User not found: \u0026#34; + command.getUserId()); } } @Override public void handle(UpdateUserEmailCommand command) { User user = userStore.get(command.getUserId()); if (user != null) { user.updateEmail(command.getNewEmail()); System.out.println(\u0026#34;User email updated: \u0026#34; + command.getUserId()); } else { throw new IllegalArgumentException(\u0026#34;User not found: \u0026#34; + command.getUserId()); } } @Override public void handle(DeleteUserCommand command) { User user = userStore.remove(command.getUserId()); if (user != null) { System.out.println(\u0026#34;User deleted: \u0026#34; + command.getUserId()); } else { throw new IllegalArgumentException(\u0026#34;User not found: \u0026#34; + command.getUserId()); } } public Map\u0026lt;String, User\u0026gt; getUserStore() { return new HashMap\u0026lt;\u0026gt;(userStore); } } // ç”¨æˆ¶æŸ¥è©¢è™•ç†å™¨ @Component public class UserQueryHandler implements QueryHandler\u0026lt;GetUserByIdQuery, User\u0026gt;, QueryHandler\u0026lt;GetUserByEmailQuery, User\u0026gt;, QueryHandler\u0026lt;GetAllUsersQuery, List\u0026lt;User\u0026gt;\u0026gt; { private final UserCommandHandler userCommandHandler; public UserQueryHandler(UserCommandHandler userCommandHandler) { this.userCommandHandler = userCommandHandler; } @Override public User handle(GetUserByIdQuery query) { return userCommandHandler.getUserStore().get(query.getUserId()); } @Override public User handle(GetUserByEmailQuery query) { return userCommandHandler.getUserStore().values().stream() .filter(user -\u0026gt; user.getEmail().equals(query.getEmail())) .findFirst() .orElse(null); } @Override public List\u0026lt;User\u0026gt; handle(GetAllUsersQuery query) { List\u0026lt;User\u0026gt; allUsers = new ArrayList\u0026lt;\u0026gt;(userCommandHandler.getUserStore().values()); int start = query.getPage() * query.getSize(); int end = Math.min(start + query.getSize(), allUsers.size()); if (start \u0026gt;= allUsers.size()) { return Collections.emptyList(); } return allUsers.subList(start, end); } } 4. å‘½ä»¤ç¸½ç·š (Command Bus) å‘½ä»¤ç¸½ç·šæ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 // å‘½ä»¤ç¸½ç·šæ¥å£ public interface CommandBus { \u0026lt;T extends CommandBase\u0026gt; void send(T command); \u0026lt;T extends CommandBase\u0026gt; CompletableFuture\u0026lt;Void\u0026gt; sendAsync(T command); } // æŸ¥è©¢ç¸½ç·šæ¥å£ public interface QueryBus { \u0026lt;Q extends QueryBase\u0026lt;R\u0026gt;, R\u0026gt; R send(Q query); \u0026lt;Q extends QueryBase\u0026lt;R\u0026gt;, R\u0026gt; CompletableFuture\u0026lt;R\u0026gt; sendAsync(Q query); } // å‘½ä»¤ç¸½ç·šå¯¦ç¾ @Component public class SimpleCommandBus implements CommandBus { private final Map\u0026lt;Class\u0026lt;?\u0026gt;, CommandHandler\u0026lt;?\u0026gt;\u0026gt; handlers = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final ExecutorService executorService = Executors.newFixedThreadPool(10); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T extends CommandBase\u0026gt; void registerHandler(Class\u0026lt;T\u0026gt; commandType, CommandHandler\u0026lt;T\u0026gt; handler) { handlers.put(commandType, handler); } @Override @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T extends CommandBase\u0026gt; void send(T command) { CommandHandler\u0026lt;T\u0026gt; handler = (CommandHandler\u0026lt;T\u0026gt;) handlers.get(command.getClass()); if (handler == null) { throw new IllegalArgumentException(\u0026#34;No handler found for command: \u0026#34; + command.getClass()); } try { handler.handle(command); } catch (Exception e) { throw new RuntimeException(\u0026#34;Command handling failed: \u0026#34; + e.getMessage(), e); } } @Override public \u0026lt;T extends CommandBase\u0026gt; CompletableFuture\u0026lt;Void\u0026gt; sendAsync(T command) { return CompletableFuture.runAsync(() -\u0026gt; send(command), executorService); } public void shutdown() { executorService.shutdown(); } } // æŸ¥è©¢ç¸½ç·šå¯¦ç¾ @Component public class SimpleQueryBus implements QueryBus { private final Map\u0026lt;Class\u0026lt;?\u0026gt;, QueryHandler\u0026lt;?, ?\u0026gt;\u0026gt; handlers = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final ExecutorService executorService = Executors.newFixedThreadPool(10); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;Q extends QueryBase\u0026lt;R\u0026gt;, R\u0026gt; void registerHandler(Class\u0026lt;Q\u0026gt; queryType, QueryHandler\u0026lt;Q, R\u0026gt; handler) { handlers.put(queryType, handler); } @Override @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;Q extends QueryBase\u0026lt;R\u0026gt;, R\u0026gt; R send(Q query) { QueryHandler\u0026lt;Q, R\u0026gt; handler = (QueryHandler\u0026lt;Q, R\u0026gt;) handlers.get(query.getClass()); if (handler == null) { throw new IllegalArgumentException(\u0026#34;No handler found for query: \u0026#34; + query.getClass()); } try { return handler.handle(query); } catch (Exception e) { throw new RuntimeException(\u0026#34;Query handling failed: \u0026#34; + e.getMessage(), e); } } @Override public \u0026lt;Q extends QueryBase\u0026lt;R\u0026gt;, R\u0026gt; CompletableFuture\u0026lt;R\u0026gt; sendAsync(Q query) { return CompletableFuture.supplyAsync(() -\u0026gt; send(query), executorService); } public void shutdown() { executorService.shutdown(); } } å‘½ä»¤ç¸½ç·šé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // å‘½ä»¤ç¸½ç·šé…ç½® @Configuration public class CommandBusConfiguration { @Bean public SimpleCommandBus commandBus(UserCommandHandler userCommandHandler) { SimpleCommandBus commandBus = new SimpleCommandBus(); // è¨»å†Šå‘½ä»¤è™•ç†å™¨ commandBus.registerHandler(CreateUserCommand.class, userCommandHandler); commandBus.registerHandler(UpdateUserNameCommand.class, userCommandHandler); commandBus.registerHandler(UpdateUserEmailCommand.class, userCommandHandler); commandBus.registerHandler(DeleteUserCommand.class, userCommandHandler); return commandBus; } @Bean public SimpleQueryBus queryBus(UserQueryHandler userQueryHandler) { SimpleQueryBus queryBus = new SimpleQueryBus(); // è¨»å†ŠæŸ¥è©¢è™•ç†å™¨ queryBus.registerHandler(GetUserByIdQuery.class, userQueryHandler); queryBus.registerHandler(GetUserByEmailQuery.class, userQueryHandler); queryBus.registerHandler(GetAllUsersQuery.class, userQueryHandler); return queryBus; } } 5. å¯©è¨ˆå’Œæ—¥èªŒè¨˜éŒ„ å¯©è¨ˆå‘½ä»¤è£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 // å¯©è¨ˆä¿¡æ¯ public class AuditInfo { private final String userId; private final String sessionId; private final String ipAddress; private final LocalDateTime timestamp; public AuditInfo(String userId, String sessionId, String ipAddress) { this.userId = userId; this.sessionId = sessionId; this.ipAddress = ipAddress; this.timestamp = LocalDateTime.now(); } // getters public String getUserId() { return userId; } public String getSessionId() { return sessionId; } public String getIpAddress() { return ipAddress; } public LocalDateTime getTimestamp() { return timestamp; } } // å¯å¯©è¨ˆçš„å‘½ä»¤ public interface AuditableCommand { void setAuditInfo(AuditInfo auditInfo); AuditInfo getAuditInfo(); } // å¢å¼·çš„å‘½ä»¤åŸºé¡ public abstract class AuditableCommandBase extends CommandBase implements AuditableCommand { private AuditInfo auditInfo; @Override public void setAuditInfo(AuditInfo auditInfo) { this.auditInfo = auditInfo; } @Override public AuditInfo getAuditInfo() { return auditInfo; } } // å¯©è¨ˆè¨˜éŒ„ public class AuditRecord { private final String recordId; private final String commandId; private final String commandType; private final String userId; private final String sessionId; private final String ipAddress; private final LocalDateTime timestamp; private final String details; private final boolean success; private final String errorMessage; public AuditRecord(String commandId, String commandType, String userId, String sessionId, String ipAddress, LocalDateTime timestamp, String details, boolean success, String errorMessage) { this.recordId = UUID.randomUUID().toString(); this.commandId = commandId; this.commandType = commandType; this.userId = userId; this.sessionId = sessionId; this.ipAddress = ipAddress; this.timestamp = timestamp; this.details = details; this.success = success; this.errorMessage = errorMessage; } // getters public String getRecordId() { return recordId; } public String getCommandId() { return commandId; } public String getCommandType() { return commandType; } public String getUserId() { return userId; } public String getSessionId() { return sessionId; } public String getIpAddress() { return ipAddress; } public LocalDateTime getTimestamp() { return timestamp; } public String getDetails() { return details; } public boolean isSuccess() { return success; } public String getErrorMessage() { return errorMessage; } @Override public String toString() { return String.format(\u0026#34;[%s] %s by %s at %s - %s\u0026#34;, success ? \u0026#34;SUCCESS\u0026#34; : \u0026#34;FAILED\u0026#34;, commandType, userId, timestamp, details); } } å¯©è¨ˆå‘½ä»¤ç¸½ç·š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 // å¸¶å¯©è¨ˆåŠŸèƒ½çš„å‘½ä»¤ç¸½ç·š @Component public class AuditableCommandBus implements CommandBus { private final SimpleCommandBus commandBus; private final List\u0026lt;AuditRecord\u0026gt; auditRecords = new ArrayList\u0026lt;\u0026gt;(); public AuditableCommandBus(SimpleCommandBus commandBus) { this.commandBus = commandBus; } @Override public \u0026lt;T extends CommandBase\u0026gt; void send(T command) { String commandId = command.getCommandId(); String commandType = command.getClass().getSimpleName(); AuditInfo auditInfo = null; if (command instanceof AuditableCommand) { auditInfo = ((AuditableCommand) command).getAuditInfo(); } boolean success = false; String errorMessage = null; try { commandBus.send(command); success = true; } catch (Exception e) { errorMessage = e.getMessage(); throw e; } finally { // è¨˜éŒ„å¯©è¨ˆä¿¡æ¯ AuditRecord record = new AuditRecord( commandId, commandType, auditInfo != null ? auditInfo.getUserId() : \u0026#34;unknown\u0026#34;, auditInfo != null ? auditInfo.getSessionId() : \u0026#34;unknown\u0026#34;, auditInfo != null ? auditInfo.getIpAddress() : \u0026#34;unknown\u0026#34;, LocalDateTime.now(), generateCommandDetails(command), success, errorMessage ); auditRecords.add(record); System.out.println(\u0026#34;Audit: \u0026#34; + record); } } @Override public \u0026lt;T extends CommandBase\u0026gt; CompletableFuture\u0026lt;Void\u0026gt; sendAsync(T command) { return CompletableFuture.runAsync(() -\u0026gt; send(command)); } private String generateCommandDetails(CommandBase command) { // ä½¿ç”¨åå°„ç”Ÿæˆå‘½ä»¤è©³æƒ… StringBuilder details = new StringBuilder(); details.append(command.getClass().getSimpleName()).append(\u0026#34; {\u0026#34;); try { Field[] fields = command.getClass().getDeclaredFields(); for (Field field : fields) { field.setAccessible(true); Object value = field.get(command); if (value != null \u0026amp;\u0026amp; !field.getName().equals(\u0026#34;commandId\u0026#34;) \u0026amp;\u0026amp; !field.getName().equals(\u0026#34;timestamp\u0026#34;)) { details.append(field.getName()).append(\u0026#34;=\u0026#34;).append(value).append(\u0026#34;, \u0026#34;); } } } catch (Exception e) { details.append(\u0026#34;details unavailable\u0026#34;); } details.append(\u0026#34;}\u0026#34;); return details.toString(); } public List\u0026lt;AuditRecord\u0026gt; getAuditRecords() { return new ArrayList\u0026lt;\u0026gt;(auditRecords); } public List\u0026lt;AuditRecord\u0026gt; getAuditRecords(String userId) { return auditRecords.stream() .filter(record -\u0026gt; record.getUserId().equals(userId)) .collect(Collectors.toList()); } } 6. Spring Boot é›†æˆ Spring Boot å‘½ä»¤æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 // ç”¨æˆ¶ REST æ§åˆ¶å™¨ @RestController @RequestMapping(\u0026#34;/api/users\u0026#34;) public class UserController { private final CommandBus commandBus; private final QueryBus queryBus; public UserController(CommandBus commandBus, QueryBus queryBus) { this.commandBus = commandBus; this.queryBus = queryBus; } @PostMapping public ResponseEntity\u0026lt;String\u0026gt; createUser(@RequestBody CreateUserRequest request, HttpServletRequest httpRequest) { try { CreateUserCommand command = new CreateUserCommand(request.getEmail(), request.getName()); // è¨­ç½®å¯©è¨ˆä¿¡æ¯ if (command instanceof AuditableCommand) { AuditInfo auditInfo = new AuditInfo( \u0026#34;current-user-id\u0026#34;, // å¾å®‰å…¨ä¸Šä¸‹æ–‡ç²å– httpRequest.getSession().getId(), httpRequest.getRemoteAddr() ); ((AuditableCommand) command).setAuditInfo(auditInfo); } commandBus.send(command); return ResponseEntity.ok(\u0026#34;User created successfully\u0026#34;); } catch (Exception e) { return ResponseEntity.badRequest().body(\u0026#34;Failed to create user: \u0026#34; + e.getMessage()); } } @GetMapping(\u0026#34;/{id}\u0026#34;) public ResponseEntity\u0026lt;User\u0026gt; getUser(@PathVariable String id) { try { GetUserByIdQuery query = new GetUserByIdQuery(id); User user = queryBus.send(query); if (user != null) { return ResponseEntity.ok(user); } else { return ResponseEntity.notFound().build(); } } catch (Exception e) { return ResponseEntity.badRequest().build(); } } @GetMapping public ResponseEntity\u0026lt;List\u0026lt;User\u0026gt;\u0026gt; getAllUsers(@RequestParam(defaultValue = \u0026#34;0\u0026#34;) int page, @RequestParam(defaultValue = \u0026#34;10\u0026#34;) int size) { try { GetAllUsersQuery query = new GetAllUsersQuery(page, size); List\u0026lt;User\u0026gt; users = queryBus.send(query); return ResponseEntity.ok(users); } catch (Exception e) { return ResponseEntity.badRequest().build(); } } @PutMapping(\u0026#34;/{id}/name\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; updateUserName(@PathVariable String id, @RequestBody UpdateUserNameRequest request, HttpServletRequest httpRequest) { try { UpdateUserNameCommand command = new UpdateUserNameCommand(id, request.getName()); // è¨­ç½®å¯©è¨ˆä¿¡æ¯ if (command instanceof AuditableCommand) { AuditInfo auditInfo = new AuditInfo( \u0026#34;current-user-id\u0026#34;, httpRequest.getSession().getId(), httpRequest.getRemoteAddr() ); ((AuditableCommand) command).setAuditInfo(auditInfo); } commandBus.send(command); return ResponseEntity.ok(\u0026#34;User name updated successfully\u0026#34;); } catch (Exception e) { return ResponseEntity.badRequest().body(\u0026#34;Failed to update user name: \u0026#34; + e.getMessage()); } } @DeleteMapping(\u0026#34;/{id}\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; deleteUser(@PathVariable String id, HttpServletRequest httpRequest) { try { DeleteUserCommand command = new DeleteUserCommand(id); // è¨­ç½®å¯©è¨ˆä¿¡æ¯ if (command instanceof AuditableCommand) { AuditInfo auditInfo = new AuditInfo( \u0026#34;current-user-id\u0026#34;, httpRequest.getSession().getId(), httpRequest.getRemoteAddr() ); ((AuditableCommand) command).setAuditInfo(auditInfo); } commandBus.send(command); return ResponseEntity.ok(\u0026#34;User deleted successfully\u0026#34;); } catch (Exception e) { return ResponseEntity.badRequest().body(\u0026#34;Failed to delete user: \u0026#34; + e.getMessage()); } } } // è«‹æ±‚ DTO public class CreateUserRequest { private String email; private String name; // getters and setters public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public String getName() { return name; } public void setName(String name) { this.name = name; } } public class UpdateUserNameRequest { private String name; // getter and setter public String getName() { return name; } public void setName(String name) { this.name = name; } } 7. å‘½ä»¤æ¨¡å¼çš„é«˜ç´šç‰¹æ€§ ç•°æ­¥å‘½ä»¤è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // ç•°æ­¥å‘½ä»¤è™•ç†å™¨ @Component public class AsyncCommandProcessor { private final CommandBus commandBus; private final ExecutorService executorService = Executors.newFixedThreadPool(5); public AsyncCommandProcessor(CommandBus commandBus) { this.commandBus = commandBus; } public \u0026lt;T extends CommandBase\u0026gt; CompletableFuture\u0026lt;Void\u0026gt; processAsync(T command) { return CompletableFuture.runAsync(() -\u0026gt; { try { commandBus.send(command); } catch (Exception e) { throw new RuntimeException(\u0026#34;Async command processing failed\u0026#34;, e); } }, executorService); } public \u0026lt;T extends CommandBase\u0026gt; CompletableFuture\u0026lt;Void\u0026gt; processWithDelay(T command, long delayMs) { return CompletableFuture.runAsync(() -\u0026gt; { try { Thread.sleep(delayMs); commandBus.send(command); } catch (InterruptedException e) { Thread.currentThread().interrupt(); throw new RuntimeException(\u0026#34;Command processing interrupted\u0026#34;, e); } catch (Exception e) { throw new RuntimeException(\u0026#34;Delayed command processing failed\u0026#34;, e); } }, executorService); } public void shutdown() { executorService.shutdown(); } } å‘½ä»¤é©—è­‰å’Œä¸­é–“ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 // å‘½ä»¤é©—è­‰å™¨ public interface CommandValidator\u0026lt;T extends CommandBase\u0026gt; { ValidationResult validate(T command); } // é©—è­‰çµæœ public class ValidationResult { private final boolean valid; private final List\u0026lt;String\u0026gt; errors; public ValidationResult(boolean valid, List\u0026lt;String\u0026gt; errors) { this.valid = valid; this.errors = errors != null ? errors : Collections.emptyList(); } public static ValidationResult success() { return new ValidationResult(true, null); } public static ValidationResult failure(List\u0026lt;String\u0026gt; errors) { return new ValidationResult(false, errors); } public boolean isValid() { return valid; } public List\u0026lt;String\u0026gt; getErrors() { return errors; } } // ç”¨æˆ¶å‘½ä»¤é©—è­‰å™¨ @Component public class UserCommandValidator implements CommandValidator\u0026lt;CreateUserCommand\u0026gt; { @Override public ValidationResult validate(CreateUserCommand command) { List\u0026lt;String\u0026gt; errors = new ArrayList\u0026lt;\u0026gt;(); if (command.getEmail() == null || command.getEmail().trim().isEmpty()) { errors.add(\u0026#34;Email is required\u0026#34;); } else if (!isValidEmail(command.getEmail())) { errors.add(\u0026#34;Invalid email format\u0026#34;); } if (command.getName() == null || command.getName().trim().isEmpty()) { errors.add(\u0026#34;Name is required\u0026#34;); } else if (command.getName().length() \u0026lt; 2) { errors.add(\u0026#34;Name must be at least 2 characters\u0026#34;); } return errors.isEmpty() ? ValidationResult.success() : ValidationResult.failure(errors); } private boolean isValidEmail(String email) { return email.contains(\u0026#34;@\u0026#34;) \u0026amp;\u0026amp; email.contains(\u0026#34;.\u0026#34;); } } // å¸¶é©—è­‰çš„å‘½ä»¤ç¸½ç·š @Component public class ValidatingCommandBus implements CommandBus { private final CommandBus commandBus; private final Map\u0026lt;Class\u0026lt;?\u0026gt;, CommandValidator\u0026lt;?\u0026gt;\u0026gt; validators = new ConcurrentHashMap\u0026lt;\u0026gt;(); public ValidatingCommandBus(CommandBus commandBus) { this.commandBus = commandBus; } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T extends CommandBase\u0026gt; void registerValidator(Class\u0026lt;T\u0026gt; commandType, CommandValidator\u0026lt;T\u0026gt; validator) { validators.put(commandType, validator); } @Override @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T extends CommandBase\u0026gt; void send(T command) { // åŸ·è¡Œé©—è­‰ CommandValidator\u0026lt;T\u0026gt; validator = (CommandValidator\u0026lt;T\u0026gt;) validators.get(command.getClass()); if (validator != null) { ValidationResult result = validator.validate(command); if (!result.isValid()) { throw new IllegalArgumentException(\u0026#34;Command validation failed: \u0026#34; + result.getErrors()); } } // åŸ·è¡Œå‘½ä»¤ commandBus.send(command); } @Override public \u0026lt;T extends CommandBase\u0026gt; CompletableFuture\u0026lt;Void\u0026gt; sendAsync(T command) { return CompletableFuture.runAsync(() -\u0026gt; send(command)); } } 8. å‘½ä»¤æ¨¡å¼çš„æœ€ä½³å¯¦è¸ éŒ¯èª¤è™•ç†å’Œé‡è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 // å‘½ä»¤åŸ·è¡Œçµæœ public class CommandResult { private final boolean success; private final String message; private final Exception exception; public CommandResult(boolean success, String message, Exception exception) { this.success = success; this.message = message; this.exception = exception; } public static CommandResult success(String message) { return new CommandResult(true, message, null); } public static CommandResult failure(String message, Exception exception) { return new CommandResult(false, message, exception); } public boolean isSuccess() { return success; } public String getMessage() { return message; } public Exception getException() { return exception; } } // å¸¶é‡è©¦çš„å‘½ä»¤ç¸½ç·š @Component public class RetryableCommandBus implements CommandBus { private final CommandBus commandBus; private final int maxRetries; private final long retryDelayMs; public RetryableCommandBus(CommandBus commandBus, int maxRetries, long retryDelayMs) { this.commandBus = commandBus; this.maxRetries = maxRetries; this.retryDelayMs = retryDelayMs; } @Override public \u0026lt;T extends CommandBase\u0026gt; void send(T command) { int attempts = 0; Exception lastException = null; while (attempts \u0026lt;= maxRetries) { try { commandBus.send(command); return; // æˆåŠŸåŸ·è¡Œ } catch (Exception e) { lastException = e; attempts++; if (attempts \u0026lt;= maxRetries) { System.out.println(\u0026#34;Command failed, retrying... (attempt \u0026#34; + attempts + \u0026#34;/\u0026#34; + maxRetries + \u0026#34;)\u0026#34;); try { Thread.sleep(retryDelayMs); } catch (InterruptedException ie) { Thread.currentThread().interrupt(); throw new RuntimeException(\u0026#34;Command retry interrupted\u0026#34;, ie); } } } } throw new RuntimeException(\u0026#34;Command failed after \u0026#34; + maxRetries + \u0026#34; retries\u0026#34;, lastException); } @Override public \u0026lt;T extends CommandBase\u0026gt; CompletableFuture\u0026lt;Void\u0026gt; sendAsync(T command) { return CompletableFuture.runAsync(() -\u0026gt; send(command)); } } å‘½ä»¤æ¨¡å¼æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 @ExtendWith(MockitoExtension.class) class CommandPatternTest { @Test void shouldExecuteCommandSuccessfully() { // Given TextEditor editor = new TextEditor(); Command command = new InsertTextCommand(editor, \u0026#34;Hello World\u0026#34;); // When command.execute(); // Then assertEquals(\u0026#34;Hello World\u0026#34;, editor.getContent()); } @Test void shouldUndoCommandSuccessfully() { // Given TextEditor editor = new TextEditor(); Command command = new InsertTextCommand(editor, \u0026#34;Hello World\u0026#34;); // When command.execute(); command.undo(); // Then assertEquals(\u0026#34;\u0026#34;, editor.getContent()); } @Test void shouldHandleCommandHistory() { // Given TextEditor editor = new TextEditor(); CommandInvoker invoker = new CommandInvoker(10); // When invoker.executeCommand(new InsertTextCommand(editor, \u0026#34;Hello\u0026#34;)); invoker.executeCommand(new InsertTextCommand(editor, \u0026#34; World\u0026#34;)); // Then assertEquals(\u0026#34;Hello World\u0026#34;, editor.getContent()); assertTrue(invoker.canUndo()); invoker.undo(); assertEquals(\u0026#34;Hello\u0026#34;, editor.getContent()); assertTrue(invoker.canRedo()); invoker.redo(); assertEquals(\u0026#34;Hello World\u0026#34;, editor.getContent()); } } // CQRS æ¸¬è©¦ @SpringBootTest class CQRSTest { @Autowired private CommandBus commandBus; @Autowired private QueryBus queryBus; @Test void shouldHandleCreateUserCommand() { // Given CreateUserCommand command = new CreateUserCommand(\u0026#34;test@example.com\u0026#34;, \u0026#34;Test User\u0026#34;); // When commandBus.send(command); // Then GetUserByEmailQuery query = new GetUserByEmailQuery(\u0026#34;test@example.com\u0026#34;); User user = queryBus.send(query); assertNotNull(user); assertEquals(\u0026#34;test@example.com\u0026#34;, user.getEmail()); assertEquals(\u0026#34;Test User\u0026#34;, user.getName()); } @Test void shouldHandleUpdateUserNameCommand() { // Given CreateUserCommand createCommand = new CreateUserCommand(\u0026#34;test@example.com\u0026#34;, \u0026#34;Test User\u0026#34;); commandBus.send(createCommand); GetUserByEmailQuery query = new GetUserByEmailQuery(\u0026#34;test@example.com\u0026#34;); User user = queryBus.send(query); // When UpdateUserNameCommand updateCommand = new UpdateUserNameCommand(user.getId(), \u0026#34;Updated Name\u0026#34;); commandBus.send(updateCommand); // Then User updatedUser = queryBus.send(new GetUserByIdQuery(user.getId())); assertEquals(\u0026#34;Updated Name\u0026#34;, updatedUser.getName()); } } 9. ç¸½çµ é©ç”¨å ´æ™¯ GUI æ‡‰ç”¨: å¯¦ç¾èœå–®æ“ä½œã€å·¥å…·æ¬„æŒ‰éˆ•ç­‰ æ’¤éŠ·é‡åš: éœ€è¦æ”¯æŒæ’¤éŠ·é‡åšåŠŸèƒ½çš„ç³»çµ± å®æ“ä½œ: éœ€è¦éŒ„è£½å’Œå›æ”¾ä¸€ç³»åˆ—æ“ä½œ äº‹å‹™è™•ç†: éœ€è¦å°‡æ“ä½œå°è£ç‚ºäº‹å‹™çš„ç³»çµ± ç•°æ­¥è™•ç†: éœ€è¦å°‡è«‹æ±‚æ’éšŠè™•ç†çš„ç³»çµ± é—œéµè¦é» å°è£è«‹æ±‚: å°‡è«‹æ±‚å°è£ç‚ºå°è±¡ è§£è€¦èª¿ç”¨è€…å’Œæ¥æ”¶è€…: èª¿ç”¨è€…ç„¡éœ€çŸ¥é“æ¥æ”¶è€…çš„å…·é«”å¯¦ç¾ æ”¯æŒæ’¤éŠ·é‡åš: é€šé undo æ–¹æ³•å¯¦ç¾æ’¤éŠ·åŠŸèƒ½ æ”¯æŒæ—¥èªŒå’Œå¯©è¨ˆ: ä¾¿æ–¼è¨˜éŒ„æ“ä½œæ­·å² æ”¯æŒå®å‘½ä»¤: å¯ä»¥çµ„åˆå¤šå€‹å‘½ä»¤ ä¼æ¥­ç´šæ‡‰ç”¨ CQRS: åˆ†é›¢å‘½ä»¤å’ŒæŸ¥è©¢çš„è·è²¬ å‘½ä»¤ç¸½ç·š: çµ±ä¸€ç®¡ç†å‘½ä»¤çš„åˆ†ç™¼å’Œè™•ç† å¯©è¨ˆæ—¥èªŒ: è¨˜éŒ„æ‰€æœ‰å‘½ä»¤çš„åŸ·è¡Œæƒ…æ³ ç•°æ­¥è™•ç†: æ”¯æŒå‘½ä»¤çš„ç•°æ­¥åŸ·è¡Œ é©—è­‰å’Œé‡è©¦: ç¢ºä¿å‘½ä»¤åŸ·è¡Œçš„å¯é æ€§ èˆ‡å…¶ä»–æ¨¡å¼çš„é—œä¿‚ ç­–ç•¥æ¨¡å¼: å‘½ä»¤æ¨¡å¼å°è£å‹•ä½œï¼Œç­–ç•¥æ¨¡å¼å°è£ç®—æ³• è§€å¯Ÿè€…æ¨¡å¼: å‘½ä»¤åŸ·è¡Œå¾Œå¯ä»¥é€šçŸ¥è§€å¯Ÿè€… è·è²¬éˆæ¨¡å¼: å¯ä»¥å°‡å‘½ä»¤æ²¿è‘—è·è²¬éˆå‚³é å‚™å¿˜éŒ„æ¨¡å¼: çµåˆä½¿ç”¨å¯¦ç¾è¤‡é›œçš„æ’¤éŠ·é‡åšåŠŸèƒ½ å‘½ä»¤æ¨¡å¼åœ¨ç¾ä»£ä¼æ¥­ç´šæ‡‰ç”¨ä¸­æ‰®æ¼”è‘—é‡è¦è§’è‰²ï¼Œç‰¹åˆ¥æ˜¯åœ¨ CQRS æ¶æ§‹å’Œäº‹ä»¶é©…å‹•ç³»çµ±ä¸­ã€‚çµåˆ Spring Boot å’Œç¾ä»£ Java ç‰¹æ€§ï¼Œå¯ä»¥æ§‹å»ºå‡ºé«˜åº¦å¯ç¶­è­·å’Œå¯æ“´å±•çš„ç³»çµ±æ¶æ§‹ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/command/","tags":[],"title":"DesignPattern - Behavioral - Command Pattern"},{"content":"Strategy Pattern ç­–ç•¥æ¨¡å¼ Strategy Pattern æ˜¯è¡Œç‚ºå‹è¨­è¨ˆæ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒå®šç¾©äº†ä¸€ç³»åˆ—ç®—æ³•ï¼ŒæŠŠå®ƒå€‘å°è£èµ·ä¾†ï¼Œä¸¦ä½¿å®ƒå€‘å¯ä»¥ç›¸äº’æ›¿æ›ã€‚ç­–ç•¥æ¨¡å¼è®“ç®—æ³•çš„è®ŠåŒ–ç¨ç«‹æ–¼ä½¿ç”¨ç®—æ³•çš„å®¢æˆ¶ç«¯ã€‚\næ ¸å¿ƒæ¦‚å¿µ ç­–ç•¥æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°‡ç®—æ³•çš„å®šç¾©èˆ‡ä½¿ç”¨åˆ†é›¢ï¼Œé€šéå®šç¾©ä¸€æ—ç®—æ³•ï¼Œå°‡æ¯å€‹ç®—æ³•å°è£èµ·ä¾†ï¼Œä¸¦ä½¿å®ƒå€‘å¯ä»¥äº’ç›¸æ›¿æ›ã€‚é€™æ¨£å¯ä»¥è®“ç®—æ³•çš„è®ŠåŒ–ä¸æœƒå½±éŸ¿åˆ°ä½¿ç”¨ç®—æ³•çš„å®¢æˆ¶ç«¯ã€‚\nä¸»è¦çµ„æˆéƒ¨åˆ† Strategy (ç­–ç•¥æ¥å£): å®šç¾©æ‰€æœ‰å…·é«”ç­–ç•¥çš„å…¬å…±æ¥å£ ConcreteStrategy (å…·é«”ç­–ç•¥): å¯¦ç¾å…·é«”çš„ç®—æ³• Context (ä¸Šä¸‹æ–‡): æŒæœ‰ç­–ç•¥çš„å¼•ç”¨ï¼Œä¸¦å°‡å®¢æˆ¶ç«¯çš„è«‹æ±‚å§”æ´¾çµ¦ç­–ç•¥ ä¸»è¦å„ªå‹¢ ç®—æ³•åˆ‡æ›éˆæ´»: å¯ä»¥åœ¨é‹è¡Œæ™‚åˆ‡æ›ç®—æ³• ç®—æ³•ç¨ç«‹: ç®—æ³•çš„è®ŠåŒ–ä¸å½±éŸ¿å®¢æˆ¶ç«¯ é–‹é–‰åŸå‰‡: æ–°å¢ç®—æ³•ç„¡éœ€ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ å¯æ¸¬è©¦æ€§: æ¯å€‹ç­–ç•¥éƒ½å¯ä»¥ç¨ç«‹æ¸¬è©¦ ä»£ç¢¼é‡ç”¨: ç®—æ³•å¯ä»¥åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­é‡ç”¨ 1. åŸºç¤ç­–ç•¥æ¨¡å¼å¯¦ç¾ ç¶“å…¸æ”¯ä»˜ç­–ç•¥ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // ç­–ç•¥æ¥å£ public interface PaymentStrategy { PaymentResult processPayment(PaymentRequest request); boolean validatePayment(PaymentRequest request); String getPaymentMethodName(); } // æ”¯ä»˜è«‹æ±‚æ¨¡å‹ public class PaymentRequest { private final BigDecimal amount; private final String currency; private final String merchantId; private final Map\u0026lt;String, String\u0026gt; additionalData; public PaymentRequest(BigDecimal amount, String currency, String merchantId) { this.amount = amount; this.currency = currency; this.merchantId = merchantId; this.additionalData = new HashMap\u0026lt;\u0026gt;(); } // getters and setters public BigDecimal getAmount() { return amount; } public String getCurrency() { return currency; } public String getMerchantId() { return merchantId; } public Map\u0026lt;String, String\u0026gt; getAdditionalData() { return additionalData; } } // æ”¯ä»˜çµæœæ¨¡å‹ public class PaymentResult { private final boolean success; private final String transactionId; private final String message; private final LocalDateTime timestamp; public PaymentResult(boolean success, String transactionId, String message) { this.success = success; this.transactionId = transactionId; this.message = message; this.timestamp = LocalDateTime.now(); } // getters public boolean isSuccess() { return success; } public String getTransactionId() { return transactionId; } public String getMessage() { return message; } public LocalDateTime getTimestamp() { return timestamp; } } å…·é«”ç­–ç•¥å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 // ä¿¡ç”¨å¡æ”¯ä»˜ç­–ç•¥ public class CreditCardPaymentStrategy implements PaymentStrategy { private final String cardNumber; private final String cardHolderName; private final String expiryDate; private final String cvv; public CreditCardPaymentStrategy(String cardNumber, String cardHolderName, String expiryDate, String cvv) { this.cardNumber = cardNumber; this.cardHolderName = cardHolderName; this.expiryDate = expiryDate; this.cvv = cvv; } @Override public PaymentResult processPayment(PaymentRequest request) { if (!validatePayment(request)) { return new PaymentResult(false, null, \u0026#34;ä¿¡ç”¨å¡é©—è­‰å¤±æ•—\u0026#34;); } try { // æ¨¡æ“¬ä¿¡ç”¨å¡æ”¯ä»˜è™•ç† String transactionId = \u0026#34;CC_\u0026#34; + System.currentTimeMillis(); System.out.println(\u0026#34;æ­£åœ¨è™•ç†ä¿¡ç”¨å¡æ”¯ä»˜...\u0026#34;); System.out.println(\u0026#34;é‡‘é¡: \u0026#34; + request.getAmount() + \u0026#34; \u0026#34; + request.getCurrency()); System.out.println(\u0026#34;å¡è™Ÿ: \u0026#34; + maskCardNumber(cardNumber)); // æ¨¡æ“¬ç¶²çµ¡å»¶é² Thread.sleep(1000); return new PaymentResult(true, transactionId, \u0026#34;ä¿¡ç”¨å¡æ”¯ä»˜æˆåŠŸ\u0026#34;); } catch (InterruptedException e) { return new PaymentResult(false, null, \u0026#34;æ”¯ä»˜éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤\u0026#34;); } } @Override public boolean validatePayment(PaymentRequest request) { // é©—è­‰é‚è¼¯ if (request.getAmount().compareTo(BigDecimal.ZERO) \u0026lt;= 0) { return false; } if (cardNumber == null || cardNumber.length() \u0026lt; 16) { return false; } if (cvv == null || cvv.length() != 3) { return false; } return true; } @Override public String getPaymentMethodName() { return \u0026#34;ä¿¡ç”¨å¡æ”¯ä»˜\u0026#34;; } private String maskCardNumber(String cardNumber) { return \u0026#34;**** **** **** \u0026#34; + cardNumber.substring(cardNumber.length() - 4); } } // PayPal æ”¯ä»˜ç­–ç•¥ public class PayPalPaymentStrategy implements PaymentStrategy { private final String email; private final String password; public PayPalPaymentStrategy(String email, String password) { this.email = email; this.password = password; } @Override public PaymentResult processPayment(PaymentRequest request) { if (!validatePayment(request)) { return new PaymentResult(false, null, \u0026#34;PayPal é©—è­‰å¤±æ•—\u0026#34;); } try { String transactionId = \u0026#34;PP_\u0026#34; + System.currentTimeMillis(); System.out.println(\u0026#34;æ­£åœ¨è™•ç† PayPal æ”¯ä»˜...\u0026#34;); System.out.println(\u0026#34;é‡‘é¡: \u0026#34; + request.getAmount() + \u0026#34; \u0026#34; + request.getCurrency()); System.out.println(\u0026#34;PayPal å¸³æˆ¶: \u0026#34; + email); // æ¨¡æ“¬ PayPal API èª¿ç”¨ Thread.sleep(800); return new PaymentResult(true, transactionId, \u0026#34;PayPal æ”¯ä»˜æˆåŠŸ\u0026#34;); } catch (InterruptedException e) { return new PaymentResult(false, null, \u0026#34;PayPal æ”¯ä»˜éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤\u0026#34;); } } @Override public boolean validatePayment(PaymentRequest request) { if (request.getAmount().compareTo(BigDecimal.ZERO) \u0026lt;= 0) { return false; } if (email == null || !email.contains(\u0026#34;@\u0026#34;)) { return false; } if (password == null || password.length() \u0026lt; 6) { return false; } return true; } @Override public String getPaymentMethodName() { return \u0026#34;PayPal æ”¯ä»˜\u0026#34;; } } // éŠ€è¡Œè½‰å¸³ç­–ç•¥ public class BankTransferPaymentStrategy implements PaymentStrategy { private final String accountNumber; private final String routingNumber; private final String accountHolderName; public BankTransferPaymentStrategy(String accountNumber, String routingNumber, String accountHolderName) { this.accountNumber = accountNumber; this.routingNumber = routingNumber; this.accountHolderName = accountHolderName; } @Override public PaymentResult processPayment(PaymentRequest request) { if (!validatePayment(request)) { return new PaymentResult(false, null, \u0026#34;éŠ€è¡Œè½‰å¸³é©—è­‰å¤±æ•—\u0026#34;); } try { String transactionId = \u0026#34;BT_\u0026#34; + System.currentTimeMillis(); System.out.println(\u0026#34;æ­£åœ¨è™•ç†éŠ€è¡Œè½‰å¸³...\u0026#34;); System.out.println(\u0026#34;é‡‘é¡: \u0026#34; + request.getAmount() + \u0026#34; \u0026#34; + request.getCurrency()); System.out.println(\u0026#34;æ”¶æ¬¾å¸³æˆ¶: \u0026#34; + maskAccountNumber(accountNumber)); // æ¨¡æ“¬éŠ€è¡Œè™•ç†æ™‚é–“ Thread.sleep(2000); return new PaymentResult(true, transactionId, \u0026#34;éŠ€è¡Œè½‰å¸³æˆåŠŸ\u0026#34;); } catch (InterruptedException e) { return new PaymentResult(false, null, \u0026#34;éŠ€è¡Œè½‰å¸³éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤\u0026#34;); } } @Override public boolean validatePayment(PaymentRequest request) { if (request.getAmount().compareTo(BigDecimal.ZERO) \u0026lt;= 0) { return false; } if (accountNumber == null || accountNumber.length() \u0026lt; 10) { return false; } if (routingNumber == null || routingNumber.length() != 9) { return false; } return true; } @Override public String getPaymentMethodName() { return \u0026#34;éŠ€è¡Œè½‰å¸³\u0026#34;; } private String maskAccountNumber(String accountNumber) { return \u0026#34;*\u0026#34;.repeat(accountNumber.length() - 4) + accountNumber.substring(accountNumber.length() - 4); } } ä¸Šä¸‹æ–‡é¡å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // æ”¯ä»˜è™•ç†å™¨ä¸Šä¸‹æ–‡ public class PaymentProcessor { private PaymentStrategy paymentStrategy; public PaymentProcessor(PaymentStrategy paymentStrategy) { this.paymentStrategy = paymentStrategy; } public void setPaymentStrategy(PaymentStrategy paymentStrategy) { this.paymentStrategy = paymentStrategy; } public PaymentResult processPayment(PaymentRequest request) { if (paymentStrategy == null) { return new PaymentResult(false, null, \u0026#34;æœªè¨­ç½®æ”¯ä»˜ç­–ç•¥\u0026#34;); } System.out.println(\u0026#34;ä½¿ç”¨æ”¯ä»˜æ–¹å¼: \u0026#34; + paymentStrategy.getPaymentMethodName()); PaymentResult result = paymentStrategy.processPayment(request); // è¨˜éŒ„æ”¯ä»˜çµæœ logPaymentResult(request, result); return result; } private void logPaymentResult(PaymentRequest request, PaymentResult result) { System.out.println(\u0026#34;=== æ”¯ä»˜æ—¥èªŒ ===\u0026#34;); System.out.println(\u0026#34;æ™‚é–“: \u0026#34; + result.getTimestamp()); System.out.println(\u0026#34;é‡‘é¡: \u0026#34; + request.getAmount() + \u0026#34; \u0026#34; + request.getCurrency()); System.out.println(\u0026#34;ç‹€æ…‹: \u0026#34; + (result.isSuccess() ? \u0026#34;æˆåŠŸ\u0026#34; : \u0026#34;å¤±æ•—\u0026#34;)); System.out.println(\u0026#34;è¨Šæ¯: \u0026#34; + result.getMessage()); if (result.getTransactionId() != null) { System.out.println(\u0026#34;äº¤æ˜“ID: \u0026#34; + result.getTransactionId()); } System.out.println(\u0026#34;==================\u0026#34;); } } åŸºç¤ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 public class BasicStrategyDemo { public static void main(String[] args) { // å‰µå»ºæ”¯ä»˜è«‹æ±‚ PaymentRequest request = new PaymentRequest( new BigDecimal(\u0026#34;299.99\u0026#34;), \u0026#34;TWD\u0026#34;, \u0026#34;MERCHANT_001\u0026#34; ); // ä¿¡ç”¨å¡æ”¯ä»˜ PaymentStrategy creditCardStrategy = new CreditCardPaymentStrategy( \u0026#34;4111111111111111\u0026#34;, \u0026#34;John Doe\u0026#34;, \u0026#34;12/25\u0026#34;, \u0026#34;123\u0026#34; ); PaymentProcessor processor = new PaymentProcessor(creditCardStrategy); PaymentResult result1 = processor.processPayment(request); // åˆ‡æ›åˆ° PayPal æ”¯ä»˜ PaymentStrategy paypalStrategy = new PayPalPaymentStrategy( \u0026#34;user@example.com\u0026#34;, \u0026#34;password123\u0026#34; ); processor.setPaymentStrategy(paypalStrategy); PaymentResult result2 = processor.processPayment(request); // åˆ‡æ›åˆ°éŠ€è¡Œè½‰å¸³ PaymentStrategy bankTransferStrategy = new BankTransferPaymentStrategy( \u0026#34;1234567890\u0026#34;, \u0026#34;123456789\u0026#34;, \u0026#34;John Doe\u0026#34; ); processor.setPaymentStrategy(bankTransferStrategy); PaymentResult result3 = processor.processPayment(request); } } 2. ç¾ä»£ Java å‡½æ•¸å¼ç­–ç•¥æ¨¡å¼ ä½¿ç”¨ Lambda è¡¨é”å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 // å‡½æ•¸å¼ç­–ç•¥æ¥å£ @FunctionalInterface public interface DiscountStrategy { BigDecimal calculateDiscount(BigDecimal originalPrice, Customer customer); } // å®¢æˆ¶æ¨¡å‹ public class Customer { private final String id; private final String name; private final CustomerType type; private final LocalDate memberSince; private final BigDecimal totalSpent; public Customer(String id, String name, CustomerType type, LocalDate memberSince, BigDecimal totalSpent) { this.id = id; this.name = name; this.type = type; this.memberSince = memberSince; this.totalSpent = totalSpent; } // getters public String getId() { return id; } public String getName() { return name; } public CustomerType getType() { return type; } public LocalDate getMemberSince() { return memberSince; } public BigDecimal getTotalSpent() { return totalSpent; } } public enum CustomerType { REGULAR, PREMIUM, VIP } // å‡½æ•¸å¼æŠ˜æ‰£ç­–ç•¥ public class FunctionalDiscountStrategies { // å¸¸è¦æŠ˜æ‰£ç­–ç•¥ public static final DiscountStrategy REGULAR_DISCOUNT = (price, customer) -\u0026gt; price.multiply(BigDecimal.valueOf(0.05)); // æœƒå“¡æŠ˜æ‰£ç­–ç•¥ public static final DiscountStrategy MEMBER_DISCOUNT = (price, customer) -\u0026gt; { long membershipYears = ChronoUnit.YEARS.between( customer.getMemberSince(), LocalDate.now()); double discountRate = Math.min(0.20, 0.05 + (membershipYears * 0.01)); return price.multiply(BigDecimal.valueOf(discountRate)); }; // VIP æŠ˜æ‰£ç­–ç•¥ public static final DiscountStrategy VIP_DISCOUNT = (price, customer) -\u0026gt; { if (customer.getType() == CustomerType.VIP) { return price.multiply(BigDecimal.valueOf(0.25)); } return BigDecimal.ZERO; }; // å¤§é¡æ¶ˆè²»æŠ˜æ‰£ç­–ç•¥ public static final DiscountStrategy HIGH_SPENDER_DISCOUNT = (price, customer) -\u0026gt; { if (customer.getTotalSpent().compareTo(BigDecimal.valueOf(10000)) \u0026gt;= 0) { return price.multiply(BigDecimal.valueOf(0.15)); } return BigDecimal.ZERO; }; // çµ„åˆç­–ç•¥ - å–æœ€å¤§æŠ˜æ‰£ public static DiscountStrategy maxDiscount(DiscountStrategy... strategies) { return (price, customer) -\u0026gt; { return Arrays.stream(strategies) .map(strategy -\u0026gt; strategy.calculateDiscount(price, customer)) .max(BigDecimal::compareTo) .orElse(BigDecimal.ZERO); }; } // çµ„åˆç­–ç•¥ - ç´¯åŠ æŠ˜æ‰£ public static DiscountStrategy additiveDiscount(DiscountStrategy... strategies) { return (price, customer) -\u0026gt; { return Arrays.stream(strategies) .map(strategy -\u0026gt; strategy.calculateDiscount(price, customer)) .reduce(BigDecimal.ZERO, BigDecimal::add); }; } } å‡½æ•¸å¼ç­–ç•¥ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 // åƒ¹æ ¼è¨ˆç®—å™¨ public class PriceCalculator { private DiscountStrategy discountStrategy; public PriceCalculator(DiscountStrategy discountStrategy) { this.discountStrategy = discountStrategy; } public BigDecimal calculateFinalPrice(BigDecimal originalPrice, Customer customer) { BigDecimal discount = discountStrategy.calculateDiscount(originalPrice, customer); BigDecimal finalPrice = originalPrice.subtract(discount); System.out.printf(\u0026#34;åŸåƒ¹: %s, æŠ˜æ‰£: %s, æœ€çµ‚åƒ¹æ ¼: %s%n\u0026#34;, originalPrice, discount, finalPrice); return finalPrice; } public void setDiscountStrategy(DiscountStrategy discountStrategy) { this.discountStrategy = discountStrategy; } } // å‡½æ•¸å¼ç­–ç•¥ç¯„ä¾‹ public class FunctionalStrategyDemo { public static void main(String[] args) { // å‰µå»ºå®¢æˆ¶ Customer regularCustomer = new Customer(\u0026#34;001\u0026#34;, \u0026#34;Alice\u0026#34;, CustomerType.REGULAR, LocalDate.now().minusYears(1), BigDecimal.valueOf(5000)); Customer vipCustomer = new Customer(\u0026#34;002\u0026#34;, \u0026#34;Bob\u0026#34;, CustomerType.VIP, LocalDate.now().minusYears(3), BigDecimal.valueOf(15000)); BigDecimal originalPrice = BigDecimal.valueOf(1000); // ä½¿ç”¨é å®šç¾©ç­–ç•¥ PriceCalculator calculator = new PriceCalculator( FunctionalDiscountStrategies.REGULAR_DISCOUNT); calculator.calculateFinalPrice(originalPrice, regularCustomer); // ä½¿ç”¨ Lambda è¡¨é”å¼å‰µå»ºç­–ç•¥ DiscountStrategy seasonalDiscount = (price, customer) -\u0026gt; price.multiply(BigDecimal.valueOf(0.10)); // 10% å­£ç¯€æ€§æŠ˜æ‰£ calculator.setDiscountStrategy(seasonalDiscount); calculator.calculateFinalPrice(originalPrice, regularCustomer); // ä½¿ç”¨çµ„åˆç­–ç•¥ DiscountStrategy combinedStrategy = FunctionalDiscountStrategies.maxDiscount( FunctionalDiscountStrategies.MEMBER_DISCOUNT, FunctionalDiscountStrategies.VIP_DISCOUNT, FunctionalDiscountStrategies.HIGH_SPENDER_DISCOUNT ); calculator.setDiscountStrategy(combinedStrategy); calculator.calculateFinalPrice(originalPrice, vipCustomer); // ä½¿ç”¨æ–¹æ³•å¼•ç”¨ calculator.setDiscountStrategy(FunctionalStrategyDemo::loyaltyDiscount); calculator.calculateFinalPrice(originalPrice, vipCustomer); } // éœæ…‹æ–¹æ³•ä½œç‚ºç­–ç•¥ private static BigDecimal loyaltyDiscount(BigDecimal price, Customer customer) { long membershipDays = ChronoUnit.DAYS.between( customer.getMemberSince(), LocalDate.now()); double discountRate = Math.min(0.30, membershipDays * 0.0001); return price.multiply(BigDecimal.valueOf(discountRate)); } } 3. Spring Boot ä¸­çš„ç­–ç•¥æ¨¡å¼ Spring é…ç½®å’Œä¾è³´æ³¨å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 // é€šçŸ¥ç­–ç•¥æ¥å£ public interface NotificationStrategy { void sendNotification(String recipient, String message); boolean isAvailable(); String getChannelName(); } // å…·é«”é€šçŸ¥ç­–ç•¥å¯¦ç¾ @Component public class EmailNotificationStrategy implements NotificationStrategy { @Value(\u0026#34;${notification.email.enabled:true}\u0026#34;) private boolean enabled; @Autowired private JavaMailSender mailSender; @Override public void sendNotification(String recipient, String message) { if (!isAvailable()) { throw new IllegalStateException(\u0026#34;Email é€šçŸ¥æœå‹™ä¸å¯ç”¨\u0026#34;); } try { SimpleMailMessage mailMessage = new SimpleMailMessage(); mailMessage.setTo(recipient); mailMessage.setSubject(\u0026#34;ç³»çµ±é€šçŸ¥\u0026#34;); mailMessage.setText(message); mailSender.send(mailMessage); System.out.println(\u0026#34;Email é€šçŸ¥å·²ç™¼é€åˆ°: \u0026#34; + recipient); } catch (Exception e) { System.err.println(\u0026#34;Email ç™¼é€å¤±æ•—: \u0026#34; + e.getMessage()); } } @Override public boolean isAvailable() { return enabled \u0026amp;\u0026amp; mailSender != null; } @Override public String getChannelName() { return \u0026#34;email\u0026#34;; } } @Component public class SmsNotificationStrategy implements NotificationStrategy { @Value(\u0026#34;${notification.sms.enabled:true}\u0026#34;) private boolean enabled; @Value(\u0026#34;${notification.sms.api-key:}\u0026#34;) private String apiKey; @Override public void sendNotification(String recipient, String message) { if (!isAvailable()) { throw new IllegalStateException(\u0026#34;SMS é€šçŸ¥æœå‹™ä¸å¯ç”¨\u0026#34;); } // æ¨¡æ“¬ SMS API èª¿ç”¨ System.out.println(\u0026#34;SMS é€šçŸ¥å·²ç™¼é€åˆ°: \u0026#34; + recipient); System.out.println(\u0026#34;å…§å®¹: \u0026#34; + message); } @Override public boolean isAvailable() { return enabled \u0026amp;\u0026amp; apiKey != null \u0026amp;\u0026amp; !apiKey.isEmpty(); } @Override public String getChannelName() { return \u0026#34;sms\u0026#34;; } } ç­–ç•¥å·¥å» å’Œç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 // é€šçŸ¥ç­–ç•¥å·¥å»  @Component public class NotificationStrategyFactory { private final Map\u0026lt;String, NotificationStrategy\u0026gt; strategies; public NotificationStrategyFactory(List\u0026lt;NotificationStrategy\u0026gt; strategyList) { this.strategies = strategyList.stream() .collect(Collectors.toMap( NotificationStrategy::getChannelName, Function.identity() )); } public NotificationStrategy getStrategy(String channelName) { NotificationStrategy strategy = strategies.get(channelName); if (strategy == null) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„é€šçŸ¥æ–¹å¼: \u0026#34; + channelName); } return strategy; } public List\u0026lt;NotificationStrategy\u0026gt; getAvailableStrategies() { return strategies.values().stream() .filter(NotificationStrategy::isAvailable) .collect(Collectors.toList()); } public Set\u0026lt;String\u0026gt; getSupportedChannels() { return strategies.keySet(); } } // é€šçŸ¥æœå‹™ @Service public class NotificationService { private final NotificationStrategyFactory strategyFactory; public NotificationService(NotificationStrategyFactory strategyFactory) { this.strategyFactory = strategyFactory; } public void sendNotification(String channel, String recipient, String message) { NotificationStrategy strategy = strategyFactory.getStrategy(channel); if (!strategy.isAvailable()) { // é™ç´šç­–ç•¥ - å˜—è©¦å…¶ä»–å¯ç”¨çš„é€šçŸ¥æ–¹å¼ List\u0026lt;NotificationStrategy\u0026gt; availableStrategies = strategyFactory.getAvailableStrategies(); if (!availableStrategies.isEmpty()) { NotificationStrategy fallbackStrategy = availableStrategies.get(0); System.out.println(\u0026#34;åŸé€šçŸ¥æ–¹å¼ä¸å¯ç”¨ï¼Œä½¿ç”¨å‚™é¸æ–¹å¼: \u0026#34; + fallbackStrategy.getChannelName()); fallbackStrategy.sendNotification(recipient, message); return; } throw new IllegalStateException(\u0026#34;æ‰€æœ‰é€šçŸ¥æ–¹å¼éƒ½ä¸å¯ç”¨\u0026#34;); } strategy.sendNotification(recipient, message); } public void broadcastNotification(String message) { List\u0026lt;NotificationStrategy\u0026gt; availableStrategies = strategyFactory.getAvailableStrategies(); availableStrategies.parallelStream() .forEach(strategy -\u0026gt; { try { strategy.sendNotification(\u0026#34;broadcast\u0026#34;, message); } catch (Exception e) { System.err.println(\u0026#34;å»£æ’­é€šçŸ¥å¤±æ•— [\u0026#34; + strategy.getChannelName() + \u0026#34;]: \u0026#34; + e.getMessage()); } }); } } 4. ç­–ç•¥æ¨¡å¼çš„æœ€ä½³å¯¦è¸ é¿å…å¸¸è¦‹é™·é˜± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // âŒ éŒ¯èª¤ï¼šç­–ç•¥é¡éæ–¼è¤‡é›œ public class BadComplexStrategy implements PaymentStrategy { @Override public PaymentResult processPayment(PaymentRequest request) { // 100+ è¡Œè¤‡é›œé‚è¼¯ // åŒ…å«å¤šå€‹è·è²¬ // é›£ä»¥æ¸¬è©¦å’Œç¶­è­· return null; } } // âœ… æ­£ç¢ºï¼šå–®ä¸€è·è²¬çš„ç­–ç•¥ public class GoodSimpleStrategy implements PaymentStrategy { private final PaymentValidator validator; private final PaymentProcessor processor; public GoodSimpleStrategy(PaymentValidator validator, PaymentProcessor processor) { this.validator = validator; this.processor = processor; } @Override public PaymentResult processPayment(PaymentRequest request) { if (!validator.validate(request)) { return new PaymentResult(false, null, \u0026#34;é©—è­‰å¤±æ•—\u0026#34;); } return processor.process(request); } } ç­–ç•¥æ¨¡å¼æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 @ExtendWith(MockitoExtension.class) class PaymentStrategyTest { @Test void creditCardPayment_shouldProcessSuccessfully() { // Given PaymentStrategy strategy = new CreditCardPaymentStrategy( \u0026#34;4111111111111111\u0026#34;, \u0026#34;John Doe\u0026#34;, \u0026#34;12/25\u0026#34;, \u0026#34;123\u0026#34;); PaymentRequest request = new PaymentRequest( BigDecimal.valueOf(100), \u0026#34;USD\u0026#34;, \u0026#34;MERCHANT_001\u0026#34;); // When PaymentResult result = strategy.processPayment(request); // Then assertThat(result.isSuccess()).isTrue(); assertThat(result.getTransactionId()).isNotNull(); assertThat(result.getTransactionId()).startsWith(\u0026#34;CC_\u0026#34;); } @Test void paymentProcessor_shouldSwitchStrategies() { // Given PaymentStrategy creditCardStrategy = new CreditCardPaymentStrategy( \u0026#34;4111111111111111\u0026#34;, \u0026#34;John Doe\u0026#34;, \u0026#34;12/25\u0026#34;, \u0026#34;123\u0026#34;); PaymentStrategy paypalStrategy = new PayPalPaymentStrategy( \u0026#34;user@example.com\u0026#34;, \u0026#34;password123\u0026#34;); PaymentProcessor processor = new PaymentProcessor(creditCardStrategy); PaymentRequest request = new PaymentRequest( BigDecimal.valueOf(100), \u0026#34;USD\u0026#34;, \u0026#34;MERCHANT_001\u0026#34;); // When \u0026amp; Then PaymentResult result1 = processor.processPayment(request); assertThat(result1.isSuccess()).isTrue(); processor.setPaymentStrategy(paypalStrategy); PaymentResult result2 = processor.processPayment(request); assertThat(result2.isSuccess()).isTrue(); assertThat(result2.getTransactionId()).startsWith(\u0026#34;PP_\u0026#34;); } } 5. ç¸½çµ é©ç”¨å ´æ™¯ ç®—æ³•é¸æ“‡: éœ€è¦åœ¨å¤šå€‹ç®—æ³•é–“å‹•æ…‹é¸æ“‡ è¡Œç‚ºè®ŠåŒ–: å°è±¡è¡Œç‚ºéœ€è¦åœ¨é‹è¡Œæ™‚æ”¹è®Š æ¢ä»¶é‚è¼¯: æ›¿ä»£è¤‡é›œçš„æ¢ä»¶åˆ†æ”¯çµæ§‹ æ“´å±•æ€§: éœ€è¦é »ç¹æ·»åŠ æ–°çš„è¡Œç‚ºå¯¦ç¾ é—œéµè¦é» å–®ä¸€è·è²¬: æ¯å€‹ç­–ç•¥å°ˆæ³¨æ–¼ä¸€å€‹ç‰¹å®šç®—æ³• é–‹é–‰åŸå‰‡: å®¹æ˜“æ·»åŠ æ–°ç­–ç•¥ï¼Œç„¡éœ€ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ é‹è¡Œæ™‚åˆ‡æ›: æ”¯æŒå‹•æ…‹åˆ‡æ›ç­–ç•¥ æ¸¬è©¦å‹å¥½: æ¯å€‹ç­–ç•¥å¯ä»¥ç¨ç«‹æ¸¬è©¦ Spring Boot æœ€ä½³å¯¦è¸ ä¾è³´æ³¨å…¥: ä½¿ç”¨ Spring ç®¡ç†ç­–ç•¥å¯¦ä¾‹ é…ç½®é©…å‹•: é€šéé…ç½®æ–‡ä»¶æ§åˆ¶ç­–ç•¥é¸æ“‡ æ¢ä»¶å‰µå»º: ä½¿ç”¨ @ConditionalOnProperty æ§åˆ¶ç­–ç•¥è¼‰å…¥ ç›£æ§é›†æˆ: æ•´åˆ Spring Actuator ç›£æ§ç­–ç•¥ä½¿ç”¨æƒ…æ³ èˆ‡å…¶ä»–æ¨¡å¼çš„é—œä¿‚ å·¥å» æ¨¡å¼: ç”¨æ–¼å‰µå»ºç­–ç•¥å¯¦ä¾‹ è£é£¾å™¨æ¨¡å¼: ç‚ºç­–ç•¥æ·»åŠ é¡å¤–åŠŸèƒ½ è²¬ä»»éˆæ¨¡å¼: çµ„åˆå¤šå€‹ç­–ç•¥è™•ç†è¤‡é›œæ¥­å‹™ æ¨¡æ¿æ–¹æ³•æ¨¡å¼: åœ¨ç­–ç•¥å…§éƒ¨å®šç¾©ç®—æ³•éª¨æ¶ ç­–ç•¥æ¨¡å¼æ˜¯ä¼æ¥­ç´šæ‡‰ç”¨ä¸­æœ€å¸¸ç”¨çš„è¨­è¨ˆæ¨¡å¼ä¹‹ä¸€ï¼Œç‰¹åˆ¥é©åˆè™•ç†æ¥­å‹™è¦å‰‡é »ç¹è®ŠåŒ–çš„å ´æ™¯ã€‚åœ¨ Spring Boot ç’°å¢ƒä¸­ï¼Œçµåˆä¾è³´æ³¨å…¥å’Œé…ç½®ç®¡ç†ï¼Œå¯ä»¥æ§‹å»ºå‡ºé«˜åº¦éˆæ´»å’Œå¯ç¶­è­·çš„æ‡‰ç”¨ç³»çµ±ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/strategy/","tags":[],"title":"DesignPattern - Behavioral - Strategy Pattern"},{"content":"Observer Pattern è§€å¯Ÿè€…æ¨¡å¼ Observer Pattern æ˜¯è¡Œç‚ºå‹è¨­è¨ˆæ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒå®šç¾©äº†ä¸€ç¨®ä¸€å°å¤šçš„ä¾è³´é—œä¿‚ï¼Œç•¶ä¸€å€‹å°è±¡çš„ç‹€æ…‹ç™¼ç”Ÿæ”¹è®Šæ™‚ï¼Œæ‰€æœ‰ä¾è³´æ–¼å®ƒçš„å°è±¡éƒ½æœƒå¾—åˆ°é€šçŸ¥ä¸¦è¢«è‡ªå‹•æ›´æ–°ã€‚\næ ¸å¿ƒæ¦‚å¿µ è§€å¯Ÿè€…æ¨¡å¼å»ºç«‹äº†ä¸€ç¨®ã€Œç™¼å¸ƒ-è¨‚é–±ã€(Publisher-Subscriber) çš„é—œä¿‚ï¼Œè®“è§€å¯Ÿè€…(Observer)èƒ½å¤ ç›£è½ä¸»é¡Œ(Subject)çš„ç‹€æ…‹è®ŠåŒ–ã€‚ç•¶ä¸»é¡Œç‹€æ…‹ç™¼ç”Ÿæ”¹è®Šæ™‚ï¼Œå®ƒæœƒè‡ªå‹•é€šçŸ¥æ‰€æœ‰è¨»å†Šçš„è§€å¯Ÿè€…ã€‚\nä¸»è¦çµ„æˆéƒ¨åˆ† Subject (ä¸»é¡Œ): ç¶­è­·è§€å¯Ÿè€…åˆ—è¡¨ï¼Œæä¾›è¨»å†Š/å–æ¶ˆè¨»å†Šä»‹é¢ Observer (è§€å¯Ÿè€…): å®šç¾©æ¥æ”¶é€šçŸ¥çš„ä»‹é¢ ConcreteSubject (å…·é«”ä¸»é¡Œ): å¯¦ç¾ä¸»é¡Œä»‹é¢ï¼Œå„²å­˜ç‹€æ…‹ä¸¦é€šçŸ¥è§€å¯Ÿè€… ConcreteObserver (å…·é«”è§€å¯Ÿè€…): å¯¦ç¾è§€å¯Ÿè€…ä»‹é¢ï¼Œè™•ç†é€šçŸ¥ ä¸»è¦å„ªå‹¢ é¬†è€¦åˆ: ä¸»é¡Œå’Œè§€å¯Ÿè€…ä¹‹é–“ä¿æŒé¬†è€¦åˆé—œä¿‚ å‹•æ…‹é—œä¿‚: å¯ä»¥åœ¨é‹è¡Œæ™‚å‹•æ…‹æ·»åŠ æˆ–ç§»é™¤è§€å¯Ÿè€… å»£æ’­é€šä¿¡: ä¸€å€‹ä¸»é¡Œå¯ä»¥åŒæ™‚é€šçŸ¥å¤šå€‹è§€å¯Ÿè€… é–‹é–‰åŸå‰‡: æ–°å¢è§€å¯Ÿè€…é¡å‹ç„¡éœ€ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ 1. å‚³çµ± Observer æ¨¡å¼å¯¦ç¾ åŸºç¤è§€å¯Ÿè€…æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 // ä¸»é¡Œæ¥å£ public interface Subject\u0026lt;T\u0026gt; { void registerObserver(Observer\u0026lt;T\u0026gt; observer); void unregisterObserver(Observer\u0026lt;T\u0026gt; observer); void notifyObservers(); void notifyObservers(T data); } // è§€å¯Ÿè€…æ¥å£ public interface Observer\u0026lt;T\u0026gt; { void update(T data); void update(Subject\u0026lt;T\u0026gt; subject); } // æŠ½è±¡ä¸»é¡Œå¯¦ç¾ public abstract class AbstractSubject\u0026lt;T\u0026gt; implements Subject\u0026lt;T\u0026gt; { private final List\u0026lt;Observer\u0026lt;T\u0026gt;\u0026gt; observers = new CopyOnWriteArrayList\u0026lt;\u0026gt;(); private final Object lock = new Object(); @Override public void registerObserver(Observer\u0026lt;T\u0026gt; observer) { if (observer == null) { throw new IllegalArgumentException(\u0026#34;Observer cannot be null\u0026#34;); } synchronized (lock) { if (!observers.contains(observer)) { observers.add(observer); } } } @Override public void unregisterObserver(Observer\u0026lt;T\u0026gt; observer) { synchronized (lock) { observers.remove(observer); } } @Override public void notifyObservers() { List\u0026lt;Observer\u0026lt;T\u0026gt;\u0026gt; currentObservers; synchronized (lock) { currentObservers = new ArrayList\u0026lt;\u0026gt;(observers); } for (Observer\u0026lt;T\u0026gt; observer : currentObservers) { try { observer.update(this); } catch (Exception e) { System.err.println(\u0026#34;Observer notification failed: \u0026#34; + e.getMessage()); } } } @Override public void notifyObservers(T data) { List\u0026lt;Observer\u0026lt;T\u0026gt;\u0026gt; currentObservers; synchronized (lock) { currentObservers = new ArrayList\u0026lt;\u0026gt;(observers); } for (Observer\u0026lt;T\u0026gt; observer : currentObservers) { try { observer.update(data); } catch (Exception e) { System.err.println(\u0026#34;Observer notification failed: \u0026#34; + e.getMessage()); } } } public int getObserverCount() { synchronized (lock) { return observers.size(); } } } å…·é«”å¯¦ç¾ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 // è‚¡ç¥¨æ¨¡å‹ public class Stock { private final String symbol; private BigDecimal price; private BigDecimal change; private LocalDateTime timestamp; public Stock(String symbol, BigDecimal price) { this.symbol = symbol; this.price = price; this.change = BigDecimal.ZERO; this.timestamp = LocalDateTime.now(); } // getters and setters public String getSymbol() { return symbol; } public BigDecimal getPrice() { return price; } public BigDecimal getChange() { return change; } public LocalDateTime getTimestamp() { return timestamp; } public void updatePrice(BigDecimal newPrice) { this.change = newPrice.subtract(this.price); this.price = newPrice; this.timestamp = LocalDateTime.now(); } @Override public String toString() { return String.format(\u0026#34;Stock{symbol=\u0026#39;%s\u0026#39;, price=%s, change=%s, timestamp=%s}\u0026#34;, symbol, price, change, timestamp); } } // è‚¡ç¥¨åƒ¹æ ¼ä¸»é¡Œ public class StockPrice extends AbstractSubject\u0026lt;Stock\u0026gt; { private Stock stock; public StockPrice(String symbol, BigDecimal initialPrice) { this.stock = new Stock(symbol, initialPrice); } public void updatePrice(BigDecimal newPrice) { stock.updatePrice(newPrice); notifyObservers(stock); } public Stock getStock() { return stock; } } // è‚¡ç¥¨é¡¯ç¤ºè§€å¯Ÿè€… public class StockDisplay implements Observer\u0026lt;Stock\u0026gt; { private final String displayName; public StockDisplay(String displayName) { this.displayName = displayName; } @Override public void update(Stock stock) { System.out.printf(\u0026#34;[%s] è‚¡ç¥¨æ›´æ–°: %s%n\u0026#34;, displayName, stock); } @Override public void update(Subject\u0026lt;Stock\u0026gt; subject) { if (subject instanceof StockPrice) { StockPrice stockPrice = (StockPrice) subject; update(stockPrice.getStock()); } } } // è‚¡ç¥¨è­¦å ±è§€å¯Ÿè€… public class StockAlert implements Observer\u0026lt;Stock\u0026gt; { private final BigDecimal threshold; private final String alertType; public StockAlert(BigDecimal threshold, String alertType) { this.threshold = threshold; this.alertType = alertType; } @Override public void update(Stock stock) { if (\u0026#34;HIGH\u0026#34;.equals(alertType) \u0026amp;\u0026amp; stock.getPrice().compareTo(threshold) \u0026gt; 0) { System.out.printf(\u0026#34;ğŸš¨ é«˜åƒ¹è­¦å ±: %s è¶…é %s%n\u0026#34;, stock.getSymbol(), threshold); } else if (\u0026#34;LOW\u0026#34;.equals(alertType) \u0026amp;\u0026amp; stock.getPrice().compareTo(threshold) \u0026lt; 0) { System.out.printf(\u0026#34;ğŸš¨ ä½åƒ¹è­¦å ±: %s ä½æ–¼ %s%n\u0026#34;, stock.getSymbol(), threshold); } } @Override public void update(Subject\u0026lt;Stock\u0026gt; subject) { if (subject instanceof StockPrice) { StockPrice stockPrice = (StockPrice) subject; update(stockPrice.getStock()); } } } åŸºç¤ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public class BasicObserverDemo { public static void main(String[] args) { // å‰µå»ºè‚¡ç¥¨åƒ¹æ ¼ä¸»é¡Œ StockPrice appleStock = new StockPrice(\u0026#34;AAPL\u0026#34;, BigDecimal.valueOf(150.00)); // å‰µå»ºè§€å¯Ÿè€… StockDisplay mobileDisplay = new StockDisplay(\u0026#34;æ‰‹æ©Ÿæ‡‰ç”¨\u0026#34;); StockDisplay webDisplay = new StockDisplay(\u0026#34;ç¶²é ç‰ˆ\u0026#34;); StockAlert highAlert = new StockAlert(BigDecimal.valueOf(160.00), \u0026#34;HIGH\u0026#34;); StockAlert lowAlert = new StockAlert(BigDecimal.valueOf(140.00), \u0026#34;LOW\u0026#34;); // è¨»å†Šè§€å¯Ÿè€… appleStock.registerObserver(mobileDisplay); appleStock.registerObserver(webDisplay); appleStock.registerObserver(highAlert); appleStock.registerObserver(lowAlert); System.out.println(\u0026#34;=== åˆå§‹ç‹€æ…‹ ===\u0026#34;); System.out.println(\u0026#34;è§€å¯Ÿè€…æ•¸é‡: \u0026#34; + appleStock.getObserverCount()); // æ›´æ–°è‚¡ç¥¨åƒ¹æ ¼ System.out.println(\u0026#34;\\n=== åƒ¹æ ¼ä¸Šæ¼² ===\u0026#34;); appleStock.updatePrice(BigDecimal.valueOf(155.50)); System.out.println(\u0026#34;\\n=== åƒ¹æ ¼ä¸‹è·Œ ===\u0026#34;); appleStock.updatePrice(BigDecimal.valueOf(135.00)); System.out.println(\u0026#34;\\n=== åƒ¹æ ¼å¤§å¹…ä¸Šæ¼² ===\u0026#34;); appleStock.updatePrice(BigDecimal.valueOf(165.00)); // ç§»é™¤è§€å¯Ÿè€… appleStock.unregisterObserver(webDisplay); System.out.println(\u0026#34;\\n=== ç§»é™¤ç¶²é é¡¯ç¤ºè§€å¯Ÿè€…å¾Œ ===\u0026#34;); appleStock.updatePrice(BigDecimal.valueOf(170.00)); } } 2. ç¾ä»£ Java è§€å¯Ÿè€…æ¨¡å¼ ä½¿ç”¨ Java å…§å»º Observable 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 import java.util.Observable; import java.util.Observer; // ä½¿ç”¨ Java å…§å»º Observable (å·²æ£„ç”¨ï¼Œä½†ä»å¯å­¸ç¿’) public class NewsAgency extends Observable { private String news; public void setNews(String news) { this.news = news; setChanged(); notifyObservers(news); } public String getNews() { return news; } } // ä½¿ç”¨ PropertyChangeSupport çš„ç¾ä»£å¯¦ç¾ public class ModernNewsAgency { private String news; private final PropertyChangeSupport support; public ModernNewsAgency() { this.support = new PropertyChangeSupport(this); } public void addPropertyChangeListener(PropertyChangeListener listener) { support.addPropertyChangeListener(listener); } public void removePropertyChangeListener(PropertyChangeListener listener) { support.removePropertyChangeListener(listener); } public void setNews(String news) { String oldNews = this.news; this.news = news; support.firePropertyChange(\u0026#34;news\u0026#34;, oldNews, news); } public String getNews() { return news; } } å‡½æ•¸å¼è§€å¯Ÿè€…æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // å‡½æ•¸å¼è§€å¯Ÿè€…æ¥å£ @FunctionalInterface public interface EventListener\u0026lt;T\u0026gt; { void onEvent(T event); } // äº‹ä»¶ç™¼å¸ƒå™¨ public class EventPublisher\u0026lt;T\u0026gt; { private final List\u0026lt;EventListener\u0026lt;T\u0026gt;\u0026gt; listeners = new CopyOnWriteArrayList\u0026lt;\u0026gt;(); public void subscribe(EventListener\u0026lt;T\u0026gt; listener) { listeners.add(listener); } public void unsubscribe(EventListener\u0026lt;T\u0026gt; listener) { listeners.remove(listener); } public void publish(T event) { listeners.parallelStream().forEach(listener -\u0026gt; { try { listener.onEvent(event); } catch (Exception e) { System.err.println(\u0026#34;Event listener failed: \u0026#34; + e.getMessage()); } }); } } // ä½¿ç”¨ç¯„ä¾‹ public class FunctionalObserverDemo { public static void main(String[] args) { EventPublisher\u0026lt;String\u0026gt; publisher = new EventPublisher\u0026lt;\u0026gt;(); // ä½¿ç”¨ Lambda è¡¨é”å¼ publisher.subscribe(message -\u0026gt; System.out.println(\u0026#34;é›»å­éƒµä»¶: \u0026#34; + message)); publisher.subscribe(message -\u0026gt; System.out.println(\u0026#34;ç°¡è¨Š: \u0026#34; + message)); // ä½¿ç”¨æ–¹æ³•å¼•ç”¨ publisher.subscribe(System.out::println); // ç™¼å¸ƒäº‹ä»¶ publisher.publish(\u0026#34;æ–°æ–‡ç« ç™¼å¸ƒ!\u0026#34;); } } 3. Spring Boot äº‹ä»¶é©…å‹•æ¶æ§‹ Spring Events åŸºç¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // è‡ªå®šç¾©äº‹ä»¶ public class UserRegisteredEvent extends ApplicationEvent { private final User user; public UserRegisteredEvent(Object source, User user) { super(source); this.user = user; } public User getUser() { return user; } } // ç”¨æˆ¶æ¨¡å‹ public class User { private final String id; private final String email; private final String name; private final LocalDateTime registeredAt; public User(String id, String email, String name) { this.id = id; this.email = email; this.name = name; this.registeredAt = LocalDateTime.now(); } // getters public String getId() { return id; } public String getEmail() { return email; } public String getName() { return name; } public LocalDateTime getRegisteredAt() { return registeredAt; } } // äº‹ä»¶ç™¼å¸ƒæœå‹™ @Service public class UserService { private final ApplicationEventPublisher eventPublisher; public UserService(ApplicationEventPublisher eventPublisher) { this.eventPublisher = eventPublisher; } public void registerUser(String email, String name) { // ç”¨æˆ¶è¨»å†Šé‚è¼¯ String userId = UUID.randomUUID().toString(); User user = new User(userId, email, name); // ä¿å­˜ç”¨æˆ¶åˆ°æ•¸æ“šåº« saveUser(user); // ç™¼å¸ƒäº‹ä»¶ eventPublisher.publishEvent(new UserRegisteredEvent(this, user)); } private void saveUser(User user) { // æ¨¡æ“¬æ•¸æ“šåº«ä¿å­˜ System.out.println(\u0026#34;ç”¨æˆ¶å·²ä¿å­˜: \u0026#34; + user.getName()); } } Spring Event Listeners 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 // éƒµä»¶æœå‹™äº‹ä»¶ç›£è½å™¨ @Component public class EmailNotificationListener { @EventListener public void handleUserRegistered(UserRegisteredEvent event) { User user = event.getUser(); sendWelcomeEmail(user); } @Async @EventListener public void handleUserRegisteredAsync(UserRegisteredEvent event) { User user = event.getUser(); sendPromotionalEmail(user); } private void sendWelcomeEmail(User user) { System.out.println(\u0026#34;ç™¼é€æ­¡è¿éƒµä»¶çµ¦: \u0026#34; + user.getEmail()); // å¯¦éš›éƒµä»¶ç™¼é€é‚è¼¯ } private void sendPromotionalEmail(User user) { System.out.println(\u0026#34;ç™¼é€ä¿ƒéŠ·éƒµä»¶çµ¦: \u0026#34; + user.getEmail()); // å¯¦éš›éƒµä»¶ç™¼é€é‚è¼¯ } } // å¯©è¨ˆæœå‹™äº‹ä»¶ç›£è½å™¨ @Component public class AuditListener { @EventListener @Order(1) // ç¢ºä¿å¯©è¨ˆå„ªå…ˆåŸ·è¡Œ public void handleUserRegistered(UserRegisteredEvent event) { User user = event.getUser(); logUserRegistration(user); } private void logUserRegistration(User user) { System.out.println(\u0026#34;å¯©è¨ˆæ—¥èªŒ - ç”¨æˆ¶è¨»å†Š: \u0026#34; + user.getId() + \u0026#34; at \u0026#34; + user.getRegisteredAt()); } } // çµ±è¨ˆæœå‹™äº‹ä»¶ç›£è½å™¨ @Component public class StatisticsListener { private final AtomicLong registrationCount = new AtomicLong(0); @EventListener public void handleUserRegistered(UserRegisteredEvent event) { long count = registrationCount.incrementAndGet(); System.out.println(\u0026#34;è¨»å†Šç”¨æˆ¶ç¸½æ•¸: \u0026#34; + count); // æ›´æ–°çµ±è¨ˆæ•¸æ“š updateRegistrationStats(event.getUser()); } private void updateRegistrationStats(User user) { // æ›´æ–°çµ±è¨ˆæ•¸æ“šåº« System.out.println(\u0026#34;æ›´æ–°çµ±è¨ˆæ•¸æ“š\u0026#34;); } } æ¢ä»¶äº‹ä»¶ç›£è½ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // æ¢ä»¶äº‹ä»¶ç›£è½å™¨ @Component public class ConditionalEventListener { @EventListener(condition = \u0026#34;#event.user.email.contains(\u0026#39;admin\u0026#39;)\u0026#34;) public void handleAdminUserRegistered(UserRegisteredEvent event) { User user = event.getUser(); System.out.println(\u0026#34;ç®¡ç†å“¡ç”¨æˆ¶è¨»å†Š: \u0026#34; + user.getEmail()); notifyAdminTeam(user); } @EventListener(condition = \u0026#34;#event.user.email.endsWith(\u0026#39;.com\u0026#39;)\u0026#34;) public void handleComEmailRegistered(UserRegisteredEvent event) { User user = event.getUser(); System.out.println(\u0026#34;å•†æ¥­ç”¨æˆ¶è¨»å†Š: \u0026#34; + user.getEmail()); } private void notifyAdminTeam(User user) { System.out.println(\u0026#34;é€šçŸ¥ç®¡ç†å“¡åœ˜éšŠ: æ–°ç®¡ç†å“¡ç”¨æˆ¶ \u0026#34; + user.getName()); } } 4. éŸ¿æ‡‰å¼ç·¨ç¨‹è§€å¯Ÿè€…æ¨¡å¼ RxJava éŸ¿æ‡‰å¼è§€å¯Ÿè€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // ä½¿ç”¨ RxJava çš„éŸ¿æ‡‰å¼è§€å¯Ÿè€… public class RxObserverDemo { public static void main(String[] args) { // å‰µå»º Observable Observable\u0026lt;String\u0026gt; newsObservable = Observable.create(emitter -\u0026gt; { // æ¨¡æ“¬æ–°èç™¼å¸ƒ emitter.onNext(\u0026#34;çªç™¼æ–°è: è‚¡å¸‚å¤§æ¼²\u0026#34;); emitter.onNext(\u0026#34;é«”è‚²æ–°è: ä¸–ç•Œæ¯é–‹å¹•\u0026#34;); emitter.onNext(\u0026#34;ç§‘æŠ€æ–°è: æ–° AI æŠ€è¡“ç™¼å¸ƒ\u0026#34;); emitter.onComplete(); }); // å‰µå»ºè§€å¯Ÿè€… Observer\u0026lt;String\u0026gt; newsObserver = new Observer\u0026lt;String\u0026gt;() { @Override public void onSubscribe(Disposable d) { System.out.println(\u0026#34;è¨‚é–±æ–°èæœå‹™\u0026#34;); } @Override public void onNext(String news) { System.out.println(\u0026#34;æ¥æ”¶æ–°è: \u0026#34; + news); } @Override public void onError(Throwable e) { System.err.println(\u0026#34;æ–°èæ¥æ”¶éŒ¯èª¤: \u0026#34; + e.getMessage()); } @Override public void onComplete() { System.out.println(\u0026#34;æ–°èæ¥æ”¶å®Œæˆ\u0026#34;); } }; // è¨‚é–± newsObservable.subscribe(newsObserver); // ä½¿ç”¨æ“ä½œç¬¦é€²è¡Œè½‰æ›å’Œéæ¿¾ newsObservable .filter(news -\u0026gt; news.contains(\u0026#34;è‚¡å¸‚\u0026#34;)) .map(news -\u0026gt; news.toUpperCase()) .subscribe(news -\u0026gt; System.out.println(\u0026#34;è‚¡å¸‚æ–°è: \u0026#34; + news)); } } Project Reactor éŸ¿æ‡‰å¼æµ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 // ä½¿ç”¨ Project Reactor çš„éŸ¿æ‡‰å¼æµ @Service public class ReactiveStockService { private final Flux\u0026lt;Stock\u0026gt; stockStream; public ReactiveStockService() { this.stockStream = Flux.interval(Duration.ofSeconds(1)) .map(i -\u0026gt; generateRandomStock()) .share(); // å…±äº«æµ } private Stock generateRandomStock() { String[] symbols = {\u0026#34;AAPL\u0026#34;, \u0026#34;GOOGL\u0026#34;, \u0026#34;MSFT\u0026#34;, \u0026#34;AMZN\u0026#34;, \u0026#34;TSLA\u0026#34;}; String symbol = symbols[new Random().nextInt(symbols.length)]; BigDecimal price = BigDecimal.valueOf(100 + new Random().nextDouble() * 100); return new Stock(symbol, price); } public Flux\u0026lt;Stock\u0026gt; getStockStream() { return stockStream; } public Flux\u0026lt;Stock\u0026gt; getStockStream(String symbol) { return stockStream.filter(stock -\u0026gt; stock.getSymbol().equals(symbol)); } } // éŸ¿æ‡‰å¼æ§åˆ¶å™¨ @RestController public class ReactiveStockController { private final ReactiveStockService stockService; public ReactiveStockController(ReactiveStockService stockService) { this.stockService = stockService; } @GetMapping(value = \u0026#34;/stocks/stream\u0026#34;, produces = MediaType.TEXT_EVENT_STREAM_VALUE) public Flux\u0026lt;Stock\u0026gt; streamStocks() { return stockService.getStockStream(); } @GetMapping(value = \u0026#34;/stocks/{symbol}/stream\u0026#34;, produces = MediaType.TEXT_EVENT_STREAM_VALUE) public Flux\u0026lt;Stock\u0026gt; streamStock(@PathVariable String symbol) { return stockService.getStockStream(symbol); } } 5. ç•°æ­¥è§€å¯Ÿè€…æ¨¡å¼ CompletableFuture ç•°æ­¥é€šçŸ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 // ç•°æ­¥è§€å¯Ÿè€…æ¨¡å¼å¯¦ç¾ public class AsyncObserverPattern { public static class AsyncSubject\u0026lt;T\u0026gt; { private final List\u0026lt;Function\u0026lt;T, CompletableFuture\u0026lt;Void\u0026gt;\u0026gt;\u0026gt; observers = new CopyOnWriteArrayList\u0026lt;\u0026gt;(); private final Executor executor; public AsyncSubject(Executor executor) { this.executor = executor; } public void subscribe(Function\u0026lt;T, CompletableFuture\u0026lt;Void\u0026gt;\u0026gt; observer) { observers.add(observer); } public void unsubscribe(Function\u0026lt;T, CompletableFuture\u0026lt;Void\u0026gt;\u0026gt; observer) { observers.remove(observer); } public CompletableFuture\u0026lt;Void\u0026gt; notifyObservers(T data) { List\u0026lt;CompletableFuture\u0026lt;Void\u0026gt;\u0026gt; futures = observers.stream() .map(observer -\u0026gt; observer.apply(data)) .collect(Collectors.toList()); return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])); } } public static void main(String[] args) { ExecutorService executor = Executors.newFixedThreadPool(4); AsyncSubject\u0026lt;String\u0026gt; subject = new AsyncSubject\u0026lt;\u0026gt;(executor); // è¨»å†Šç•°æ­¥è§€å¯Ÿè€… subject.subscribe(message -\u0026gt; CompletableFuture.runAsync(() -\u0026gt; { System.out.println(\u0026#34;è§€å¯Ÿè€… 1 è™•ç†: \u0026#34; + message); try { Thread.sleep(1000); } catch (InterruptedException e) {} System.out.println(\u0026#34;è§€å¯Ÿè€… 1 å®Œæˆ\u0026#34;); }, executor) ); subject.subscribe(message -\u0026gt; CompletableFuture.runAsync(() -\u0026gt; { System.out.println(\u0026#34;è§€å¯Ÿè€… 2 è™•ç†: \u0026#34; + message); try { Thread.sleep(500); } catch (InterruptedException e) {} System.out.println(\u0026#34;è§€å¯Ÿè€… 2 å®Œæˆ\u0026#34;); }, executor) ); // ç™¼é€é€šçŸ¥ subject.notifyObservers(\u0026#34;ç•°æ­¥æ¶ˆæ¯\u0026#34;) .thenRun(() -\u0026gt; System.out.println(\u0026#34;æ‰€æœ‰è§€å¯Ÿè€…è™•ç†å®Œæˆ\u0026#34;)) .join(); executor.shutdown(); } } æ¶ˆæ¯éšŠåˆ—è§€å¯Ÿè€…æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 // ä½¿ç”¨æ¶ˆæ¯éšŠåˆ—çš„è§€å¯Ÿè€…æ¨¡å¼ @Component public class MessageQueueObserver { @RabbitListener(queues = \u0026#34;user.registered\u0026#34;) public void handleUserRegistered(UserRegisteredEvent event) { System.out.println(\u0026#34;å¾æ¶ˆæ¯éšŠåˆ—æ¥æ”¶ç”¨æˆ¶è¨»å†Šäº‹ä»¶: \u0026#34; + event.getUser().getName()); // è™•ç†æ¥­å‹™é‚è¼¯ processUserRegistration(event.getUser()); } @RabbitListener(queues = \u0026#34;order.created\u0026#34;) public void handleOrderCreated(OrderCreatedEvent event) { System.out.println(\u0026#34;å¾æ¶ˆæ¯éšŠåˆ—æ¥æ”¶è¨‚å–®å‰µå»ºäº‹ä»¶: \u0026#34; + event.getOrderId()); // è™•ç†è¨‚å–®é‚è¼¯ processOrderCreation(event); } private void processUserRegistration(User user) { // ç™¼é€æ­¡è¿éƒµä»¶ // æ›´æ–°çµ±è¨ˆæ•¸æ“š // è§¸ç™¼å…¶ä»–æ¥­å‹™æµç¨‹ } private void processOrderCreation(OrderCreatedEvent event) { // æ›´æ–°åº«å­˜ // ç™¼é€ç¢ºèªéƒµä»¶ // è§¸ç™¼é…é€æµç¨‹ } } // è¨‚å–®å‰µå»ºäº‹ä»¶ public class OrderCreatedEvent { private final String orderId; private final String userId; private final BigDecimal amount; private final LocalDateTime createdAt; public OrderCreatedEvent(String orderId, String userId, BigDecimal amount) { this.orderId = orderId; this.userId = userId; this.amount = amount; this.createdAt = LocalDateTime.now(); } // getters public String getOrderId() { return orderId; } public String getUserId() { return userId; } public BigDecimal getAmount() { return amount; } public LocalDateTime getCreatedAt() { return createdAt; } } 6. äº‹ä»¶æº¯æº (Event Sourcing) äº‹ä»¶æº¯æºæ¨¡å¼å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 // é ˜åŸŸäº‹ä»¶åŸºé¡ public abstract class DomainEvent { private final String eventId; private final LocalDateTime occurredAt; private final String aggregateId; private final int version; public DomainEvent(String aggregateId, int version) { this.eventId = UUID.randomUUID().toString(); this.occurredAt = LocalDateTime.now(); this.aggregateId = aggregateId; this.version = version; } // getters public String getEventId() { return eventId; } public LocalDateTime getOccurredAt() { return occurredAt; } public String getAggregateId() { return aggregateId; } public int getVersion() { return version; } } // è³¬æˆ¶ç›¸é—œäº‹ä»¶ public class AccountCreatedEvent extends DomainEvent { private final String accountHolderName; private final BigDecimal initialBalance; public AccountCreatedEvent(String aggregateId, int version, String accountHolderName, BigDecimal initialBalance) { super(aggregateId, version); this.accountHolderName = accountHolderName; this.initialBalance = initialBalance; } // getters public String getAccountHolderName() { return accountHolderName; } public BigDecimal getInitialBalance() { return initialBalance; } } public class MoneyDepositedEvent extends DomainEvent { private final BigDecimal amount; private final String description; public MoneyDepositedEvent(String aggregateId, int version, BigDecimal amount, String description) { super(aggregateId, version); this.amount = amount; this.description = description; } // getters public BigDecimal getAmount() { return amount; } public String getDescription() { return description; } } public class MoneyWithdrawnEvent extends DomainEvent { private final BigDecimal amount; private final String description; public MoneyWithdrawnEvent(String aggregateId, int version, BigDecimal amount, String description) { super(aggregateId, version); this.amount = amount; this.description = description; } // getters public BigDecimal getAmount() { return amount; } public String getDescription() { return description; } } äº‹ä»¶å­˜å„²å’Œé‡æ”¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 // äº‹ä»¶å­˜å„²æ¥å£ public interface EventStore { void saveEvents(String aggregateId, List\u0026lt;DomainEvent\u0026gt; events, int expectedVersion); List\u0026lt;DomainEvent\u0026gt; getEventsForAggregate(String aggregateId); } // å…§å­˜äº‹ä»¶å­˜å„²å¯¦ç¾ @Component public class InMemoryEventStore implements EventStore { private final Map\u0026lt;String, List\u0026lt;DomainEvent\u0026gt;\u0026gt; eventStore = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Override public void saveEvents(String aggregateId, List\u0026lt;DomainEvent\u0026gt; events, int expectedVersion) { List\u0026lt;DomainEvent\u0026gt; existingEvents = eventStore.computeIfAbsent(aggregateId, k -\u0026gt; new ArrayList\u0026lt;\u0026gt;()); // æª¢æŸ¥ç‰ˆæœ¬è¡çª if (existingEvents.size() != expectedVersion) { throw new ConcurrencyException(\u0026#34;Expected version \u0026#34; + expectedVersion + \u0026#34; but was \u0026#34; + existingEvents.size()); } existingEvents.addAll(events); } @Override public List\u0026lt;DomainEvent\u0026gt; getEventsForAggregate(String aggregateId) { return eventStore.getOrDefault(aggregateId, Collections.emptyList()); } } // è³¬æˆ¶èšåˆæ ¹ public class Account { private String accountId; private String accountHolderName; private BigDecimal balance; private int version; private List\u0026lt;DomainEvent\u0026gt; changes = new ArrayList\u0026lt;\u0026gt;(); public Account() {} public Account(String accountId, String accountHolderName, BigDecimal initialBalance) { this.accountId = accountId; applyChange(new AccountCreatedEvent(accountId, 0, accountHolderName, initialBalance)); } public void deposit(BigDecimal amount, String description) { if (amount.compareTo(BigDecimal.ZERO) \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;å­˜æ¬¾é‡‘é¡å¿…é ˆå¤§æ–¼é›¶\u0026#34;); } applyChange(new MoneyDepositedEvent(accountId, version, amount, description)); } public void withdraw(BigDecimal amount, String description) { if (amount.compareTo(BigDecimal.ZERO) \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;ææ¬¾é‡‘é¡å¿…é ˆå¤§æ–¼é›¶\u0026#34;); } if (balance.compareTo(amount) \u0026lt; 0) { throw new IllegalStateException(\u0026#34;é¤˜é¡ä¸è¶³\u0026#34;); } applyChange(new MoneyWithdrawnEvent(accountId, version, amount, description)); } private void applyChange(DomainEvent event) { applyChange(event, true); } private void applyChange(DomainEvent event, boolean isNew) { // æ‡‰ç”¨äº‹ä»¶åˆ°èšåˆç‹€æ…‹ if (event instanceof AccountCreatedEvent) { AccountCreatedEvent e = (AccountCreatedEvent) event; this.accountHolderName = e.getAccountHolderName(); this.balance = e.getInitialBalance(); } else if (event instanceof MoneyDepositedEvent) { MoneyDepositedEvent e = (MoneyDepositedEvent) event; this.balance = this.balance.add(e.getAmount()); } else if (event instanceof MoneyWithdrawnEvent) { MoneyWithdrawnEvent e = (MoneyWithdrawnEvent) event; this.balance = this.balance.subtract(e.getAmount()); } this.version = event.getVersion(); if (isNew) { changes.add(event); } } public void loadFromHistory(List\u0026lt;DomainEvent\u0026gt; events) { for (DomainEvent event : events) { applyChange(event, false); } } public List\u0026lt;DomainEvent\u0026gt; getUncommittedChanges() { return new ArrayList\u0026lt;\u0026gt;(changes); } public void markChangesAsCommitted() { changes.clear(); } // getters public String getAccountId() { return accountId; } public String getAccountHolderName() { return accountHolderName; } public BigDecimal getBalance() { return balance; } public int getVersion() { return version; } } äº‹ä»¶è™•ç†å™¨å’ŒæŠ•å½± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // äº‹ä»¶è™•ç†å™¨ @Component public class AccountEventHandler { @EventListener public void handle(AccountCreatedEvent event) { System.out.println(\u0026#34;å¸³æˆ¶å·²å‰µå»º: \u0026#34; + event.getAccountHolderName() + \u0026#34;, åˆå§‹é¤˜é¡: \u0026#34; + event.getInitialBalance()); // æ›´æ–°è®€å–æ¨¡å‹ updateAccountProjection(event); } @EventListener public void handle(MoneyDepositedEvent event) { System.out.println(\u0026#34;å­˜æ¬¾: \u0026#34; + event.getAmount() + \u0026#34;, æè¿°: \u0026#34; + event.getDescription()); // æ›´æ–°è®€å–æ¨¡å‹ updateBalanceProjection(event); } @EventListener public void handle(MoneyWithdrawnEvent event) { System.out.println(\u0026#34;ææ¬¾: \u0026#34; + event.getAmount() + \u0026#34;, æè¿°: \u0026#34; + event.getDescription()); // æ›´æ–°è®€å–æ¨¡å‹ updateBalanceProjection(event); } private void updateAccountProjection(AccountCreatedEvent event) { // æ›´æ–°å¸³æˆ¶æŠ•å½±è¡¨ System.out.println(\u0026#34;æ›´æ–°å¸³æˆ¶æŠ•å½±: \u0026#34; + event.getAggregateId()); } private void updateBalanceProjection(DomainEvent event) { // æ›´æ–°é¤˜é¡æŠ•å½±è¡¨ System.out.println(\u0026#34;æ›´æ–°é¤˜é¡æŠ•å½±: \u0026#34; + event.getAggregateId()); } } // è‡ªå®šç¾©ä½µç™¼ç•°å¸¸ public class ConcurrencyException extends RuntimeException { public ConcurrencyException(String message) { super(message); } } 7. ä¼æ¥­ç´šè§€å¯Ÿè€…æ¨¡å¼ åˆ†æ•£å¼äº‹ä»¶ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 // åˆ†æ•£å¼äº‹ä»¶ç™¼å¸ƒå™¨ @Component public class DistributedEventPublisher { private final RabbitTemplate rabbitTemplate; private final ApplicationEventPublisher localEventPublisher; public DistributedEventPublisher(RabbitTemplate rabbitTemplate, ApplicationEventPublisher localEventPublisher) { this.rabbitTemplate = rabbitTemplate; this.localEventPublisher = localEventPublisher; } public void publishEvent(DomainEvent event) { // æœ¬åœ°äº‹ä»¶ç™¼å¸ƒ localEventPublisher.publishEvent(event); // åˆ†æ•£å¼äº‹ä»¶ç™¼å¸ƒ publishToMessageQueue(event); } private void publishToMessageQueue(DomainEvent event) { try { String routingKey = event.getClass().getSimpleName(); rabbitTemplate.convertAndSend(\u0026#34;domain.events\u0026#34;, routingKey, event); } catch (Exception e) { System.err.println(\u0026#34;åˆ†æ•£å¼äº‹ä»¶ç™¼å¸ƒå¤±æ•—: \u0026#34; + e.getMessage()); } } } // äº‹ä»¶ç¸½ç·šé…ç½® @Configuration @EnableRabbit public class EventBusConfiguration { @Bean public TopicExchange domainEventsExchange() { return new TopicExchange(\u0026#34;domain.events\u0026#34;); } @Bean public Queue userEventsQueue() { return QueueBuilder.durable(\u0026#34;user.events\u0026#34;).build(); } @Bean public Queue orderEventsQueue() { return QueueBuilder.durable(\u0026#34;order.events\u0026#34;).build(); } @Bean public Binding userEventsBinding() { return BindingBuilder.bind(userEventsQueue()) .to(domainEventsExchange()) .with(\u0026#34;User*\u0026#34;); } @Bean public Binding orderEventsBinding() { return BindingBuilder.bind(orderEventsQueue()) .to(domainEventsExchange()) .with(\u0026#34;Order*\u0026#34;); } } äº‹ä»¶é‡è©¦å’ŒéŒ¯èª¤è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // å¯é äº‹ä»¶è™•ç†å™¨ @Component public class ReliableEventHandler { private final RetryTemplate retryTemplate; public ReliableEventHandler() { this.retryTemplate = RetryTemplate.builder() .maxAttempts(3) .fixedBackoff(1000) .retryOn(Exception.class) .build(); } @RabbitListener(queues = \u0026#34;user.events\u0026#34;) public void handleUserEvent(UserRegisteredEvent event) { retryTemplate.execute(context -\u0026gt; { processUserEvent(event); return null; }); } @Retryable(value = Exception.class, maxAttempts = 3, backoff = @Backoff(delay = 1000)) public void processUserEvent(UserRegisteredEvent event) { // æ¨¡æ“¬å¯èƒ½å¤±æ•—çš„æ“ä½œ if (Math.random() \u0026lt; 0.3) { throw new RuntimeException(\u0026#34;è™•ç†å¤±æ•—\u0026#34;); } System.out.println(\u0026#34;æˆåŠŸè™•ç†ç”¨æˆ¶äº‹ä»¶: \u0026#34; + event.getUser().getName()); } @Recover public void recover(Exception e, UserRegisteredEvent event) { System.err.println(\u0026#34;ç”¨æˆ¶äº‹ä»¶è™•ç†æœ€çµ‚å¤±æ•—: \u0026#34; + e.getMessage()); // å°‡å¤±æ•—äº‹ä»¶é€åˆ°æ­»ä¿¡éšŠåˆ—æˆ–è¨˜éŒ„åˆ°éŒ¯èª¤æ—¥èªŒ handleFailedEvent(event, e); } private void handleFailedEvent(UserRegisteredEvent event, Exception e) { // è¨˜éŒ„å¤±æ•—äº‹ä»¶ System.err.println(\u0026#34;è¨˜éŒ„å¤±æ•—äº‹ä»¶: \u0026#34; + event.getUser().getName()); } } 8. è§€å¯Ÿè€…æ¨¡å¼çš„æœ€ä½³å¯¦è¸ æ€§èƒ½å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // é«˜æ€§èƒ½è§€å¯Ÿè€…æ¨¡å¼å¯¦ç¾ public class HighPerformanceObserver { // ä½¿ç”¨ Disruptor çš„é«˜æ€§èƒ½äº‹ä»¶è™•ç† public static class DisruptorEventPublisher { private final RingBuffer\u0026lt;EventWrapper\u0026gt; ringBuffer; private final Disruptor\u0026lt;EventWrapper\u0026gt; disruptor; public DisruptorEventPublisher() { this.disruptor = new Disruptor\u0026lt;\u0026gt;(EventWrapper::new, 1024, Executors.defaultThreadFactory()); this.ringBuffer = disruptor.getRingBuffer(); // è¨»å†Šäº‹ä»¶è™•ç†å™¨ disruptor.handleEventsWith(new EventHandler\u0026lt;EventWrapper\u0026gt;() { @Override public void onEvent(EventWrapper event, long sequence, boolean endOfBatch) { // è™•ç†äº‹ä»¶ System.out.println(\u0026#34;è™•ç†äº‹ä»¶: \u0026#34; + event.getData()); } }); disruptor.start(); } public void publishEvent(String data) { long sequence = ringBuffer.next(); try { EventWrapper event = ringBuffer.get(sequence); event.setData(data); } finally { ringBuffer.publish(sequence); } } public void shutdown() { disruptor.shutdown(); } } public static class EventWrapper { private String data; public String getData() { return data; } public void setData(String data) { this.data = data; } } } æ¸¬è©¦ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 @ExtendWith(MockitoExtension.class) class ObserverPatternTest { @Test void shouldNotifyAllObservers() { // Given StockPrice stockPrice = new StockPrice(\u0026#34;AAPL\u0026#34;, BigDecimal.valueOf(150.00)); StockDisplay display1 = mock(StockDisplay.class); StockDisplay display2 = mock(StockDisplay.class); stockPrice.registerObserver(display1); stockPrice.registerObserver(display2); // When stockPrice.updatePrice(BigDecimal.valueOf(155.00)); // Then verify(display1).update(any(Stock.class)); verify(display2).update(any(Stock.class)); } @Test void shouldHandleObserverExceptions() { // Given StockPrice stockPrice = new StockPrice(\u0026#34;AAPL\u0026#34;, BigDecimal.valueOf(150.00)); Observer\u0026lt;Stock\u0026gt; faultyObserver = mock(Observer.class); Observer\u0026lt;Stock\u0026gt; normalObserver = mock(Observer.class); doThrow(new RuntimeException(\u0026#34;Observer failed\u0026#34;)).when(faultyObserver).update(any(Stock.class)); stockPrice.registerObserver(faultyObserver); stockPrice.registerObserver(normalObserver); // When stockPrice.updatePrice(BigDecimal.valueOf(155.00)); // Then verify(faultyObserver).update(any(Stock.class)); verify(normalObserver).update(any(Stock.class)); // æ‡‰è©²ä»ç„¶è¢«èª¿ç”¨ } } // Spring Boot é›†æˆæ¸¬è©¦ @SpringBootTest @TestPropertySource(properties = { \u0026#34;spring.rabbitmq.host=localhost\u0026#34;, \u0026#34;spring.rabbitmq.port=5672\u0026#34; }) class SpringEventIntegrationTest { @Autowired private UserService userService; @MockBean private EmailNotificationListener emailListener; @Test void shouldPublishUserRegisteredEvent() { // When userService.registerUser(\u0026#34;test@example.com\u0026#34;, \u0026#34;Test User\u0026#34;); // Then verify(emailListener, timeout(1000)).handleUserRegistered(any(UserRegisteredEvent.class)); } } 9. ç¸½çµ é©ç”¨å ´æ™¯ ç‹€æ…‹è®ŠåŒ–é€šçŸ¥: ç•¶å°è±¡ç‹€æ…‹æ”¹è®Šéœ€è¦é€šçŸ¥å¤šå€‹ä¾è³´å°è±¡ äº‹ä»¶é©…å‹•æ¶æ§‹: æ§‹å»ºé¬†è€¦åˆçš„äº‹ä»¶é©…å‹•ç³»çµ± ç™¼å¸ƒ-è¨‚é–±æ¨¡å¼: å¯¦ç¾æ¶ˆæ¯çš„ç™¼å¸ƒå’Œè¨‚é–±æ©Ÿåˆ¶ æ¨¡å‹-è¦–åœ–åˆ†é›¢: åœ¨ MVC æ¶æ§‹ä¸­åˆ†é›¢æ¨¡å‹å’Œè¦–åœ– é—œéµè¦é» é¬†è€¦åˆ: ä¸»é¡Œå’Œè§€å¯Ÿè€…ä¹‹é–“ä¿æŒé¬†è€¦åˆ å‹•æ…‹è¨‚é–±: æ”¯æŒé‹è¡Œæ™‚å‹•æ…‹æ·»åŠ å’Œç§»é™¤è§€å¯Ÿè€… å»£æ’­é€šä¿¡: ä¸€å°å¤šçš„é€šä¿¡æ©Ÿåˆ¶ ç•°å¸¸è™•ç†: ç¢ºä¿å–®å€‹è§€å¯Ÿè€…ç•°å¸¸ä¸å½±éŸ¿å…¶ä»–è§€å¯Ÿè€… ç¾ä»£å¯¦è¸ Spring Events: åˆ©ç”¨ Spring æ¡†æ¶çš„äº‹ä»¶æ©Ÿåˆ¶ éŸ¿æ‡‰å¼ç·¨ç¨‹: ä½¿ç”¨ RxJava æˆ– Project Reactor æ¶ˆæ¯éšŠåˆ—: é€šé RabbitMQã€Kafka ç­‰å¯¦ç¾åˆ†æ•£å¼è§€å¯Ÿè€… äº‹ä»¶æº¯æº: æ§‹å»ºåŸºæ–¼äº‹ä»¶çš„ç³»çµ±æ¶æ§‹ æ€§èƒ½è€ƒæ…® ä¸¦ç™¼å®‰å…¨: ä½¿ç”¨ç·šç¨‹å®‰å…¨çš„è§€å¯Ÿè€…åˆ—è¡¨ ç•°æ­¥è™•ç†: é¿å…é˜»å¡ä¸»ç·šç¨‹ æ‰¹é‡è™•ç†: å°å¤§é‡äº‹ä»¶é€²è¡Œæ‰¹é‡è™•ç† éŒ¯èª¤éš”é›¢: ç¢ºä¿å–®å€‹è§€å¯Ÿè€…ç•°å¸¸ä¸å½±éŸ¿ç³»çµ± è§€å¯Ÿè€…æ¨¡å¼æ˜¯æ§‹å»ºç¾ä»£ä¼æ¥­ç´šæ‡‰ç”¨çš„é‡è¦è¨­è¨ˆæ¨¡å¼ï¼Œç‰¹åˆ¥æ˜¯åœ¨å¾®æœå‹™æ¶æ§‹å’Œäº‹ä»¶é©…å‹•ç³»çµ±ä¸­ã€‚çµåˆ Spring Boot å’ŒéŸ¿æ‡‰å¼ç·¨ç¨‹ï¼Œå¯ä»¥æ§‹å»ºå‡ºé«˜åº¦å¯æ“´å±•å’Œmaintainableçš„ç³»çµ±ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/observer/","tags":[],"title":"DesignPattern - Behavioral - Observer Pattern"},{"content":"è²¬ä»»éˆæ¨¡å¼ (Chain of Responsibility Pattern) å®Œæ•´å¯¦ä½œæŒ‡å— æ¨¡å¼æ¦‚è¿° è²¬ä»»éˆæ¨¡å¼æ˜¯ä¸€ç¨®è¡Œç‚ºè¨­è¨ˆæ¨¡å¼ï¼Œå®ƒå…è¨±ä½ å°‡è«‹æ±‚æ²¿è‘—è™•ç†è€…éˆå‚³éï¼Œç›´åˆ°å…¶ä¸­ä¸€å€‹è™•ç†è€…è™•ç†è©²è«‹æ±‚ã€‚è©²æ¨¡å¼è®“å¤šå€‹å°è±¡éƒ½æœ‰æ©Ÿæœƒè™•ç†è«‹æ±‚ï¼Œå¾è€Œé¿å…äº†è«‹æ±‚çš„ç™¼é€è€…å’Œæ¥æ”¶è€…ä¹‹é–“çš„è€¦åˆé—œä¿‚ã€‚\næ ¸å¿ƒæ¦‚å¿µ è²¬ä»»éˆæ¨¡å¼è§£æ±ºçš„æ ¸å¿ƒå•é¡Œï¼š\nè«‹æ±‚èˆ‡è™•ç†è€…è§£è€¦ï¼šç™¼é€è€…ä¸éœ€è¦çŸ¥é“å…·é«”çš„è™•ç†è€… å‹•æ…‹è™•ç†æµç¨‹ï¼šå¯ä»¥å‹•æ…‹åœ°çµ„åˆå’Œé‡æ’è™•ç†è€… è«‹æ±‚è·¯ç”±ï¼šè«‹æ±‚æœƒè‡ªå‹•æµå‘åˆé©çš„è™•ç†è€… æ“´å±•æ€§ï¼šæ˜“æ–¼æ·»åŠ æ–°çš„è™•ç†è€…ï¼Œä¸å½±éŸ¿ç¾æœ‰ä»£ç¢¼ åŸºæœ¬æ¶æ§‹ 1. å‚³çµ±è²¬ä»»éˆå¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 // è«‹æ±‚åŸºé¡ public abstract class Request { private String requestId; private RequestType type; private Object data; private LocalDateTime timestamp; public Request(RequestType type, Object data) { this.requestId = UUID.randomUUID().toString(); this.type = type; this.data = data; this.timestamp = LocalDateTime.now(); } // Getter å’Œ Setter æ–¹æ³• public String getRequestId() { return requestId; } public RequestType getType() { return type; } public Object getData() { return data; } public LocalDateTime getTimestamp() { return timestamp; } } // è«‹æ±‚é¡å‹æšèˆ‰ public enum RequestType { AUTHENTICATION, AUTHORIZATION, VALIDATION, PROCESSING, LOGGING } // è™•ç†è€…æŠ½è±¡é¡ public abstract class Handler { protected Handler nextHandler; public void setNext(Handler handler) { this.nextHandler = handler; } public Handler getNext() { return nextHandler; } public abstract boolean canHandle(Request request); public abstract void handle(Request request); // è™•ç†è«‹æ±‚çš„å…¬å…±æ–¹æ³• public void processRequest(Request request) { if (canHandle(request)) { handle(request); } else if (nextHandler != null) { nextHandler.processRequest(request); } else { handleUnprocessedRequest(request); } } protected void handleUnprocessedRequest(Request request) { System.out.println(\u0026#34;è«‹æ±‚ç„¡æ³•è™•ç†: \u0026#34; + request.getRequestId()); } } 2. å…·é«”è™•ç†è€…å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 // èªè­‰è™•ç†è€… public class AuthenticationHandler extends Handler { private AuthenticationService authService; public AuthenticationHandler(AuthenticationService authService) { this.authService = authService; } @Override public boolean canHandle(Request request) { return request.getType() == RequestType.AUTHENTICATION; } @Override public void handle(Request request) { System.out.println(\u0026#34;è™•ç†èªè­‰è«‹æ±‚: \u0026#34; + request.getRequestId()); if (request.getData() instanceof AuthenticationRequest) { AuthenticationRequest authRequest = (AuthenticationRequest) request.getData(); try { boolean isValid = authService.authenticate(authRequest.getUsername(), authRequest.getPassword()); if (isValid) { System.out.println(\u0026#34;èªè­‰æˆåŠŸ: \u0026#34; + authRequest.getUsername()); // å‰µå»ºä¸‹ä¸€å€‹è™•ç†éšæ®µçš„è«‹æ±‚ AuthorizationRequest authzRequest = new AuthorizationRequest( authRequest.getUsername(), authRequest.getResource() ); Request nextRequest = new Request(RequestType.AUTHORIZATION, authzRequest); if (nextHandler != null) { nextHandler.processRequest(nextRequest); } } else { System.out.println(\u0026#34;èªè­‰å¤±æ•—: \u0026#34; + authRequest.getUsername()); } } catch (Exception e) { System.err.println(\u0026#34;èªè­‰è™•ç†å‡ºéŒ¯: \u0026#34; + e.getMessage()); } } } } // æˆæ¬Šè™•ç†è€… public class AuthorizationHandler extends Handler { private AuthorizationService authzService; public AuthorizationHandler(AuthorizationService authzService) { this.authzService = authzService; } @Override public boolean canHandle(Request request) { return request.getType() == RequestType.AUTHORIZATION; } @Override public void handle(Request request) { System.out.println(\u0026#34;è™•ç†æˆæ¬Šè«‹æ±‚: \u0026#34; + request.getRequestId()); if (request.getData() instanceof AuthorizationRequest) { AuthorizationRequest authzRequest = (AuthorizationRequest) request.getData(); try { boolean hasPermission = authzService.authorize( authzRequest.getUsername(), authzRequest.getResource() ); if (hasPermission) { System.out.println(\u0026#34;æˆæ¬ŠæˆåŠŸ: \u0026#34; + authzRequest.getUsername() + \u0026#34; è¨ªå• \u0026#34; + authzRequest.getResource()); // å‰µå»ºé©—è­‰è«‹æ±‚ ValidationRequest validationRequest = new ValidationRequest( authzRequest.getUsername(), authzRequest.getResource() ); Request nextRequest = new Request(RequestType.VALIDATION, validationRequest); if (nextHandler != null) { nextHandler.processRequest(nextRequest); } } else { System.out.println(\u0026#34;æˆæ¬Šå¤±æ•—: \u0026#34; + authzRequest.getUsername() + \u0026#34; ç„¡æ¬Šè¨ªå• \u0026#34; + authzRequest.getResource()); } } catch (Exception e) { System.err.println(\u0026#34;æˆæ¬Šè™•ç†å‡ºéŒ¯: \u0026#34; + e.getMessage()); } } } } // é©—è­‰è™•ç†è€… public class ValidationHandler extends Handler { private ValidationService validationService; public ValidationHandler(ValidationService validationService) { this.validationService = validationService; } @Override public boolean canHandle(Request request) { return request.getType() == RequestType.VALIDATION; } @Override public void handle(Request request) { System.out.println(\u0026#34;è™•ç†é©—è­‰è«‹æ±‚: \u0026#34; + request.getRequestId()); if (request.getData() instanceof ValidationRequest) { ValidationRequest validationRequest = (ValidationRequest) request.getData(); try { ValidationResult result = validationService.validate(validationRequest); if (result.isValid()) { System.out.println(\u0026#34;é©—è­‰æˆåŠŸ: \u0026#34; + validationRequest.getUsername()); // å‰µå»ºè™•ç†è«‹æ±‚ ProcessingRequest processingRequest = new ProcessingRequest( validationRequest.getUsername(), validationRequest.getResource(), result.getValidatedData() ); Request nextRequest = new Request(RequestType.PROCESSING, processingRequest); if (nextHandler != null) { nextHandler.processRequest(nextRequest); } } else { System.out.println(\u0026#34;é©—è­‰å¤±æ•—: \u0026#34; + result.getErrorMessage()); } } catch (Exception e) { System.err.println(\u0026#34;é©—è­‰è™•ç†å‡ºéŒ¯: \u0026#34; + e.getMessage()); } } } } // æ¥­å‹™è™•ç†è€… public class ProcessingHandler extends Handler { private BusinessService businessService; public ProcessingHandler(BusinessService businessService) { this.businessService = businessService; } @Override public boolean canHandle(Request request) { return request.getType() == RequestType.PROCESSING; } @Override public void handle(Request request) { System.out.println(\u0026#34;è™•ç†æ¥­å‹™è«‹æ±‚: \u0026#34; + request.getRequestId()); if (request.getData() instanceof ProcessingRequest) { ProcessingRequest processingRequest = (ProcessingRequest) request.getData(); try { BusinessResult result = businessService.process(processingRequest); if (result.isSuccess()) { System.out.println(\u0026#34;æ¥­å‹™è™•ç†æˆåŠŸ: \u0026#34; + result.getMessage()); // å‰µå»ºæ—¥èªŒè«‹æ±‚ LoggingRequest loggingRequest = new LoggingRequest( processingRequest.getUsername(), \u0026#34;æ¥­å‹™è™•ç†æˆåŠŸ\u0026#34;, result ); Request nextRequest = new Request(RequestType.LOGGING, loggingRequest); if (nextHandler != null) { nextHandler.processRequest(nextRequest); } } else { System.out.println(\u0026#34;æ¥­å‹™è™•ç†å¤±æ•—: \u0026#34; + result.getErrorMessage()); } } catch (Exception e) { System.err.println(\u0026#34;æ¥­å‹™è™•ç†å‡ºéŒ¯: \u0026#34; + e.getMessage()); } } } } // æ—¥èªŒè™•ç†è€… public class LoggingHandler extends Handler { private LoggingService loggingService; public LoggingHandler(LoggingService loggingService) { this.loggingService = loggingService; } @Override public boolean canHandle(Request request) { return request.getType() == RequestType.LOGGING; } @Override public void handle(Request request) { System.out.println(\u0026#34;è™•ç†æ—¥èªŒè«‹æ±‚: \u0026#34; + request.getRequestId()); if (request.getData() instanceof LoggingRequest) { LoggingRequest loggingRequest = (LoggingRequest) request.getData(); try { loggingService.log( loggingRequest.getUsername(), loggingRequest.getMessage(), loggingRequest.getData() ); System.out.println(\u0026#34;æ—¥èªŒè¨˜éŒ„å®Œæˆ: \u0026#34; + loggingRequest.getMessage()); } catch (Exception e) { System.err.println(\u0026#34;æ—¥èªŒè™•ç†å‡ºéŒ¯: \u0026#34; + e.getMessage()); } } } } 3. è«‹æ±‚æ•¸æ“šé¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 // èªè­‰è«‹æ±‚ public class AuthenticationRequest { private String username; private String password; private String resource; public AuthenticationRequest(String username, String password, String resource) { this.username = username; this.password = password; this.resource = resource; } // Getter å’Œ Setter æ–¹æ³• public String getUsername() { return username; } public String getPassword() { return password; } public String getResource() { return resource; } } // æˆæ¬Šè«‹æ±‚ public class AuthorizationRequest { private String username; private String resource; public AuthorizationRequest(String username, String resource) { this.username = username; this.resource = resource; } // Getter å’Œ Setter æ–¹æ³• public String getUsername() { return username; } public String getResource() { return resource; } } // é©—è­‰è«‹æ±‚ public class ValidationRequest { private String username; private String resource; private Map\u0026lt;String, Object\u0026gt; parameters; public ValidationRequest(String username, String resource) { this.username = username; this.resource = resource; this.parameters = new HashMap\u0026lt;\u0026gt;(); } // Getter å’Œ Setter æ–¹æ³• public String getUsername() { return username; } public String getResource() { return resource; } public Map\u0026lt;String, Object\u0026gt; getParameters() { return parameters; } public void addParameter(String key, Object value) { parameters.put(key, value); } } // è™•ç†è«‹æ±‚ public class ProcessingRequest { private String username; private String resource; private Object validatedData; public ProcessingRequest(String username, String resource, Object validatedData) { this.username = username; this.resource = resource; this.validatedData = validatedData; } // Getter å’Œ Setter æ–¹æ³• public String getUsername() { return username; } public String getResource() { return resource; } public Object getValidatedData() { return validatedData; } } // æ—¥èªŒè«‹æ±‚ public class LoggingRequest { private String username; private String message; private Object data; public LoggingRequest(String username, String message, Object data) { this.username = username; this.message = message; this.data = data; } // Getter å’Œ Setter æ–¹æ³• public String getUsername() { return username; } public String getMessage() { return message; } public Object getData() { return data; } } ç¾ä»£è²¬ä»»éˆå¯¦ç¾ 1. æµå¼è™•ç†å™¨éˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 // è™•ç†å™¨å‡½æ•¸æ¥å£ @FunctionalInterface public interface RequestProcessor\u0026lt;T\u0026gt; { ProcessingResult\u0026lt;T\u0026gt; process(T request); } // è™•ç†çµæœ public class ProcessingResult\u0026lt;T\u0026gt; { private boolean processed; private T result; private String message; private Exception error; private ProcessingResult(boolean processed, T result, String message, Exception error) { this.processed = processed; this.result = result; this.message = message; this.error = error; } public static \u0026lt;T\u0026gt; ProcessingResult\u0026lt;T\u0026gt; processed(T result) { return new ProcessingResult\u0026lt;\u0026gt;(true, result, null, null); } public static \u0026lt;T\u0026gt; ProcessingResult\u0026lt;T\u0026gt; processed(T result, String message) { return new ProcessingResult\u0026lt;\u0026gt;(true, result, message, null); } public static \u0026lt;T\u0026gt; ProcessingResult\u0026lt;T\u0026gt; notProcessed() { return new ProcessingResult\u0026lt;\u0026gt;(false, null, null, null); } public static \u0026lt;T\u0026gt; ProcessingResult\u0026lt;T\u0026gt; error(Exception error) { return new ProcessingResult\u0026lt;\u0026gt;(false, null, null, error); } // Getter æ–¹æ³• public boolean isProcessed() { return processed; } public T getResult() { return result; } public String getMessage() { return message; } public Exception getError() { return error; } public boolean hasError() { return error != null; } } // ç¾ä»£è²¬ä»»éˆå¯¦ç¾ public class ProcessorChain\u0026lt;T\u0026gt; { private final List\u0026lt;RequestProcessor\u0026lt;T\u0026gt;\u0026gt; processors; public ProcessorChain() { this.processors = new ArrayList\u0026lt;\u0026gt;(); } public ProcessorChain\u0026lt;T\u0026gt; addProcessor(RequestProcessor\u0026lt;T\u0026gt; processor) { processors.add(processor); return this; } public ProcessorChain\u0026lt;T\u0026gt; addProcessor(Predicate\u0026lt;T\u0026gt; condition, RequestProcessor\u0026lt;T\u0026gt; processor) { processors.add(request -\u0026gt; { if (condition.test(request)) { return processor.process(request); } return ProcessingResult.notProcessed(); }); return this; } public ProcessingResult\u0026lt;T\u0026gt; process(T request) { for (RequestProcessor\u0026lt;T\u0026gt; processor : processors) { try { ProcessingResult\u0026lt;T\u0026gt; result = processor.process(request); if (result.isProcessed()) { return result; } if (result.hasError()) { return result; } } catch (Exception e) { return ProcessingResult.error(e); } } return ProcessingResult.notProcessed(); } } 2. ä¸­ä»‹è»Ÿé«”æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // ä¸­ä»‹è»Ÿé«”æ¥å£ @FunctionalInterface public interface Middleware\u0026lt;T\u0026gt; { void process(T request, MiddlewareChain\u0026lt;T\u0026gt; chain); } // ä¸­ä»‹è»Ÿé«”éˆ public class MiddlewareChain\u0026lt;T\u0026gt; { private final List\u0026lt;Middleware\u0026lt;T\u0026gt;\u0026gt; middlewares; private int currentIndex = 0; public MiddlewareChain(List\u0026lt;Middleware\u0026lt;T\u0026gt;\u0026gt; middlewares) { this.middlewares = new ArrayList\u0026lt;\u0026gt;(middlewares); } public void next(T request) { if (currentIndex \u0026lt; middlewares.size()) { Middleware\u0026lt;T\u0026gt; middleware = middlewares.get(currentIndex++); middleware.process(request, this); } } public void reset() { currentIndex = 0; } } // ä¸­ä»‹è»Ÿé«”ç®¡ç†å™¨ public class MiddlewareManager\u0026lt;T\u0026gt; { private final List\u0026lt;Middleware\u0026lt;T\u0026gt;\u0026gt; middlewares; public MiddlewareManager() { this.middlewares = new ArrayList\u0026lt;\u0026gt;(); } public MiddlewareManager\u0026lt;T\u0026gt; use(Middleware\u0026lt;T\u0026gt; middleware) { middlewares.add(middleware); return this; } public void process(T request) { MiddlewareChain\u0026lt;T\u0026gt; chain = new MiddlewareChain\u0026lt;\u0026gt;(middlewares); chain.next(request); } } ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯ 1. HTTP è«‹æ±‚è™•ç†ç®¡é“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 // HTTP è«‹æ±‚å°è±¡ public class HttpRequestContext { private String method; private String path; private Map\u0026lt;String, String\u0026gt; headers; private Map\u0026lt;String, String\u0026gt; parameters; private Object body; private String userAgent; private String clientIp; private LocalDateTime timestamp; public HttpRequestContext(String method, String path) { this.method = method; this.path = path; this.headers = new HashMap\u0026lt;\u0026gt;(); this.parameters = new HashMap\u0026lt;\u0026gt;(); this.timestamp = LocalDateTime.now(); } // Getter å’Œ Setter æ–¹æ³• public String getMethod() { return method; } public String getPath() { return path; } public Map\u0026lt;String, String\u0026gt; getHeaders() { return headers; } public Map\u0026lt;String, String\u0026gt; getParameters() { return parameters; } public Object getBody() { return body; } public void setBody(Object body) { this.body = body; } public String getUserAgent() { return userAgent; } public void setUserAgent(String userAgent) { this.userAgent = userAgent; } public String getClientIp() { return clientIp; } public void setClientIp(String clientIp) { this.clientIp = clientIp; } public LocalDateTime getTimestamp() { return timestamp; } public void addHeader(String key, String value) { headers.put(key, value); } public void addParameter(String key, String value) { parameters.put(key, value); } } // å®‰å…¨æª¢æŸ¥ä¸­ä»‹è»Ÿé«” public class SecurityMiddleware implements Middleware\u0026lt;HttpRequestContext\u0026gt; { private final SecurityService securityService; public SecurityMiddleware(SecurityService securityService) { this.securityService = securityService; } @Override public void process(HttpRequestContext request, MiddlewareChain\u0026lt;HttpRequestContext\u0026gt; chain) { System.out.println(\u0026#34;åŸ·è¡Œå®‰å…¨æª¢æŸ¥ä¸­ä»‹è»Ÿé«”\u0026#34;); // æª¢æŸ¥ IP ç™½åå–® if (!securityService.isAllowedIp(request.getClientIp())) { System.out.println(\u0026#34;IP åœ°å€è¢«æ‹’çµ•: \u0026#34; + request.getClientIp()); return; } // æª¢æŸ¥ User-Agent if (!securityService.isValidUserAgent(request.getUserAgent())) { System.out.println(\u0026#34;ç„¡æ•ˆçš„ User-Agent: \u0026#34; + request.getUserAgent()); return; } // æª¢æŸ¥è«‹æ±‚é »ç‡ if (!securityService.checkRateLimit(request.getClientIp())) { System.out.println(\u0026#34;è«‹æ±‚é »ç‡éé«˜: \u0026#34; + request.getClientIp()); return; } System.out.println(\u0026#34;å®‰å…¨æª¢æŸ¥é€šé\u0026#34;); chain.next(request); } } // èªè­‰ä¸­ä»‹è»Ÿé«” public class AuthenticationMiddleware implements Middleware\u0026lt;HttpRequestContext\u0026gt; { private final AuthenticationService authService; public AuthenticationMiddleware(AuthenticationService authService) { this.authService = authService; } @Override public void process(HttpRequestContext request, MiddlewareChain\u0026lt;HttpRequestContext\u0026gt; chain) { System.out.println(\u0026#34;åŸ·è¡Œèªè­‰ä¸­ä»‹è»Ÿé«”\u0026#34;); String authHeader = request.getHeaders().get(\u0026#34;Authorization\u0026#34;); if (authHeader == null || !authHeader.startsWith(\u0026#34;Bearer \u0026#34;)) { System.out.println(\u0026#34;ç¼ºå°‘èªè­‰ä»¤ç‰Œ\u0026#34;); return; } String token = authHeader.substring(7); try { UserInfo userInfo = authService.validateToken(token); if (userInfo != null) { request.addParameter(\u0026#34;userId\u0026#34;, userInfo.getUserId()); request.addParameter(\u0026#34;username\u0026#34;, userInfo.getUsername()); System.out.println(\u0026#34;èªè­‰æˆåŠŸ: \u0026#34; + userInfo.getUsername()); chain.next(request); } else { System.out.println(\u0026#34;ç„¡æ•ˆçš„èªè­‰ä»¤ç‰Œ\u0026#34;); } } catch (Exception e) { System.out.println(\u0026#34;èªè­‰å¤±æ•—: \u0026#34; + e.getMessage()); } } } // æˆæ¬Šä¸­ä»‹è»Ÿé«” public class AuthorizationMiddleware implements Middleware\u0026lt;HttpRequestContext\u0026gt; { private final AuthorizationService authzService; public AuthorizationMiddleware(AuthorizationService authzService) { this.authzService = authzService; } @Override public void process(HttpRequestContext request, MiddlewareChain\u0026lt;HttpRequestContext\u0026gt; chain) { System.out.println(\u0026#34;åŸ·è¡Œæˆæ¬Šä¸­ä»‹è»Ÿé«”\u0026#34;); String userId = request.getParameters().get(\u0026#34;userId\u0026#34;); if (userId == null) { System.out.println(\u0026#34;ç”¨æˆ¶æœªèªè­‰\u0026#34;); return; } try { boolean hasPermission = authzService.hasPermission(userId, request.getPath(), request.getMethod()); if (hasPermission) { System.out.println(\u0026#34;æˆæ¬ŠæˆåŠŸ: \u0026#34; + userId + \u0026#34; è¨ªå• \u0026#34; + request.getPath()); chain.next(request); } else { System.out.println(\u0026#34;æˆæ¬Šå¤±æ•—: ç”¨æˆ¶ \u0026#34; + userId + \u0026#34; ç„¡æ¬Šè¨ªå• \u0026#34; + request.getPath()); } } catch (Exception e) { System.out.println(\u0026#34;æˆæ¬Šæª¢æŸ¥å¤±æ•—: \u0026#34; + e.getMessage()); } } } // æ—¥èªŒä¸­ä»‹è»Ÿé«” public class LoggingMiddleware implements Middleware\u0026lt;HttpRequestContext\u0026gt; { private final LoggingService loggingService; public LoggingMiddleware(LoggingService loggingService) { this.loggingService = loggingService; } @Override public void process(HttpRequestContext request, MiddlewareChain\u0026lt;HttpRequestContext\u0026gt; chain) { long startTime = System.currentTimeMillis(); System.out.println(\u0026#34;è«‹æ±‚é–‹å§‹: \u0026#34; + request.getMethod() + \u0026#34; \u0026#34; + request.getPath()); try { chain.next(request); } finally { long endTime = System.currentTimeMillis(); long duration = endTime - startTime; LogEntry logEntry = new LogEntry( request.getMethod(), request.getPath(), request.getClientIp(), request.getParameters().get(\u0026#34;userId\u0026#34;), duration, request.getTimestamp() ); loggingService.log(logEntry); System.out.println(\u0026#34;è«‹æ±‚å®Œæˆ: \u0026#34; + request.getMethod() + \u0026#34; \u0026#34; + request.getPath() + \u0026#34; è€—æ™‚: \u0026#34; + duration + \u0026#34;ms\u0026#34;); } } } // æ¥­å‹™è™•ç†ä¸­ä»‹è»Ÿé«” public class BusinessProcessingMiddleware implements Middleware\u0026lt;HttpRequestContext\u0026gt; { private final BusinessService businessService; public BusinessProcessingMiddleware(BusinessService businessService) { this.businessService = businessService; } @Override public void process(HttpRequestContext request, MiddlewareChain\u0026lt;HttpRequestContext\u0026gt; chain) { System.out.println(\u0026#34;åŸ·è¡Œæ¥­å‹™è™•ç†ä¸­ä»‹è»Ÿé«”\u0026#34;); try { BusinessResult result = businessService.processRequest(request); if (result.isSuccess()) { System.out.println(\u0026#34;æ¥­å‹™è™•ç†æˆåŠŸ: \u0026#34; + result.getMessage()); request.addParameter(\u0026#34;result\u0026#34;, result.getData()); } else { System.out.println(\u0026#34;æ¥­å‹™è™•ç†å¤±æ•—: \u0026#34; + result.getErrorMessage()); } } catch (Exception e) { System.out.println(\u0026#34;æ¥­å‹™è™•ç†ç•°å¸¸: \u0026#34; + e.getMessage()); } } } 2. å·¥ä½œæµç¨‹è™•ç†ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 // å·¥ä½œæµç¨‹è«‹æ±‚ public class WorkflowRequest { private String workflowId; private String requestId; private String initiator; private WorkflowType type; private Map\u0026lt;String, Object\u0026gt; data; private WorkflowStatus status; private LocalDateTime createdAt; private LocalDateTime updatedAt; public WorkflowRequest(String workflowId, String initiator, WorkflowType type) { this.workflowId = workflowId; this.requestId = UUID.randomUUID().toString(); this.initiator = initiator; this.type = type; this.data = new HashMap\u0026lt;\u0026gt;(); this.status = WorkflowStatus.PENDING; this.createdAt = LocalDateTime.now(); this.updatedAt = LocalDateTime.now(); } // Getter å’Œ Setter æ–¹æ³• public String getWorkflowId() { return workflowId; } public String getRequestId() { return requestId; } public String getInitiator() { return initiator; } public WorkflowType getType() { return type; } public Map\u0026lt;String, Object\u0026gt; getData() { return data; } public WorkflowStatus getStatus() { return status; } public void setStatus(WorkflowStatus status) { this.status = status; this.updatedAt = LocalDateTime.now(); } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getUpdatedAt() { return updatedAt; } public void addData(String key, Object value) { data.put(key, value); } public Object getData(String key) { return data.get(key); } } // å·¥ä½œæµç¨‹é¡å‹ public enum WorkflowType { LEAVE_REQUEST, EXPENSE_REPORT, PURCHASE_ORDER, DOCUMENT_APPROVAL } // å·¥ä½œæµç¨‹ç‹€æ…‹ public enum WorkflowStatus { PENDING, IN_PROGRESS, APPROVED, REJECTED, CANCELLED } // å·¥ä½œæµç¨‹æ­¥é©Ÿè™•ç†è€… public abstract class WorkflowStepHandler { protected WorkflowStepHandler nextHandler; protected String stepName; public WorkflowStepHandler(String stepName) { this.stepName = stepName; } public void setNext(WorkflowStepHandler handler) { this.nextHandler = handler; } public abstract boolean canHandle(WorkflowRequest request); public abstract StepResult handle(WorkflowRequest request); public StepResult process(WorkflowRequest request) { if (canHandle(request)) { System.out.println(\u0026#34;åŸ·è¡Œæ­¥é©Ÿ: \u0026#34; + stepName); StepResult result = handle(request); if (result.isSuccess() \u0026amp;\u0026amp; nextHandler != null) { return nextHandler.process(request); } return result; } else if (nextHandler != null) { return nextHandler.process(request); } else { return StepResult.failure(\u0026#34;æ²’æœ‰é©ç•¶çš„è™•ç†è€…è™•ç†æ­¤è«‹æ±‚\u0026#34;); } } } // æ­¥é©Ÿçµæœ public class StepResult { private boolean success; private String message; private Object data; private StepResult(boolean success, String message, Object data) { this.success = success; this.message = message; this.data = data; } public static StepResult success(String message) { return new StepResult(true, message, null); } public static StepResult success(String message, Object data) { return new StepResult(true, message, data); } public static StepResult failure(String message) { return new StepResult(false, message, null); } // Getter æ–¹æ³• public boolean isSuccess() { return success; } public String getMessage() { return message; } public Object getData() { return data; } } // è«‹å‡ç”³è«‹åˆå§‹æª¢æŸ¥è™•ç†è€… public class LeaveRequestInitialCheckHandler extends WorkflowStepHandler { private final LeaveService leaveService; public LeaveRequestInitialCheckHandler(LeaveService leaveService) { super(\u0026#34;è«‹å‡ç”³è«‹åˆå§‹æª¢æŸ¥\u0026#34;); this.leaveService = leaveService; } @Override public boolean canHandle(WorkflowRequest request) { return request.getType() == WorkflowType.LEAVE_REQUEST \u0026amp;\u0026amp; request.getStatus() == WorkflowStatus.PENDING; } @Override public StepResult handle(WorkflowRequest request) { try { // æª¢æŸ¥åŸºæœ¬ä¿¡æ¯ String employeeId = (String) request.getData(\u0026#34;employeeId\u0026#34;); LocalDate startDate = (LocalDate) request.getData(\u0026#34;startDate\u0026#34;); LocalDate endDate = (LocalDate) request.getData(\u0026#34;endDate\u0026#34;); String reason = (String) request.getData(\u0026#34;reason\u0026#34;); if (employeeId == null || startDate == null || endDate == null || reason == null) { return StepResult.failure(\u0026#34;ç¼ºå°‘å¿…è¦çš„è«‹å‡ä¿¡æ¯\u0026#34;); } // æª¢æŸ¥æ—¥æœŸæœ‰æ•ˆæ€§ if (startDate.isAfter(endDate)) { return StepResult.failure(\u0026#34;é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ\u0026#34;); } if (startDate.isBefore(LocalDate.now())) { return StepResult.failure(\u0026#34;ä¸èƒ½ç”³è«‹éå»çš„æ—¥æœŸ\u0026#34;); } // æª¢æŸ¥è«‹å‡å¤©æ•¸ long days = ChronoUnit.DAYS.between(startDate, endDate) + 1; if (days \u0026gt; 30) { return StepResult.failure(\u0026#34;å–®æ¬¡è«‹å‡ä¸èƒ½è¶…é30å¤©\u0026#34;); } // æª¢æŸ¥å‰©é¤˜å‡æœŸ int remainingDays = leaveService.getRemainingLeaveDays(employeeId); if (days \u0026gt; remainingDays) { return StepResult.failure(\u0026#34;è«‹å‡å¤©æ•¸è¶…éå‰©é¤˜å‡æœŸ\u0026#34;); } request.setStatus(WorkflowStatus.IN_PROGRESS); request.addData(\u0026#34;leaveDays\u0026#34;, days); request.addData(\u0026#34;checkTime\u0026#34;, LocalDateTime.now()); return StepResult.success(\u0026#34;åˆå§‹æª¢æŸ¥é€šé\u0026#34;); } catch (Exception e) { return StepResult.failure(\u0026#34;åˆå§‹æª¢æŸ¥å¤±æ•—: \u0026#34; + e.getMessage()); } } } // ä¸»ç®¡å¯©æ‰¹è™•ç†è€… public class ManagerApprovalHandler extends WorkflowStepHandler { private final ManagerService managerService; public ManagerApprovalHandler(ManagerService managerService) { super(\u0026#34;ä¸»ç®¡å¯©æ‰¹\u0026#34;); this.managerService = managerService; } @Override public boolean canHandle(WorkflowRequest request) { return request.getType() == WorkflowType.LEAVE_REQUEST \u0026amp;\u0026amp; request.getStatus() == WorkflowStatus.IN_PROGRESS \u0026amp;\u0026amp; request.getData(\u0026#34;managerApproval\u0026#34;) == null; } @Override public StepResult handle(WorkflowRequest request) { try { String employeeId = (String) request.getData(\u0026#34;employeeId\u0026#34;); Long leaveDays = (Long) request.getData(\u0026#34;leaveDays\u0026#34;); // ç²å–å“¡å·¥çš„ç›´å±¬ä¸»ç®¡ String managerId = managerService.getDirectManager(employeeId); if (managerId == null) { return StepResult.failure(\u0026#34;ç„¡æ³•æ‰¾åˆ°ç›´å±¬ä¸»ç®¡\u0026#34;); } // æ¨¡æ“¬ä¸»ç®¡å¯©æ‰¹æµç¨‹ ApprovalResult approval = managerService.requestApproval( managerId, request.getRequestId(), leaveDays ); if (approval.isApproved()) { request.addData(\u0026#34;managerApproval\u0026#34;, true); request.addData(\u0026#34;managerId\u0026#34;, managerId); request.addData(\u0026#34;managerApprovalTime\u0026#34;, LocalDateTime.now()); return StepResult.success(\u0026#34;ä¸»ç®¡å¯©æ‰¹é€šé\u0026#34;); } else { request.setStatus(WorkflowStatus.REJECTED); request.addData(\u0026#34;managerApproval\u0026#34;, false); request.addData(\u0026#34;rejectionReason\u0026#34;, approval.getReason()); return StepResult.failure(\u0026#34;ä¸»ç®¡å¯©æ‰¹æ‹’çµ•: \u0026#34; + approval.getReason()); } } catch (Exception e) { return StepResult.failure(\u0026#34;ä¸»ç®¡å¯©æ‰¹å¤±æ•—: \u0026#34; + e.getMessage()); } } } // HR å¯©æ‰¹è™•ç†è€… public class HrApprovalHandler extends WorkflowStepHandler { private final HrService hrService; public HrApprovalHandler(HrService hrService) { super(\u0026#34;HR å¯©æ‰¹\u0026#34;); this.hrService = hrService; } @Override public boolean canHandle(WorkflowRequest request) { return request.getType() == WorkflowType.LEAVE_REQUEST \u0026amp;\u0026amp; request.getStatus() == WorkflowStatus.IN_PROGRESS \u0026amp;\u0026amp; Boolean.TRUE.equals(request.getData(\u0026#34;managerApproval\u0026#34;)) \u0026amp;\u0026amp; request.getData(\u0026#34;hrApproval\u0026#34;) == null; } @Override public StepResult handle(WorkflowRequest request) { try { String employeeId = (String) request.getData(\u0026#34;employeeId\u0026#34;); Long leaveDays = (Long) request.getData(\u0026#34;leaveDays\u0026#34;); // é•·æœŸè«‹å‡éœ€è¦ HR å¯©æ‰¹ if (leaveDays \u0026gt; 5) { ApprovalResult approval = hrService.requestApproval( request.getRequestId(), employeeId, leaveDays ); if (approval.isApproved()) { request.addData(\u0026#34;hrApproval\u0026#34;, true); request.addData(\u0026#34;hrApprovalTime\u0026#34;, LocalDateTime.now()); return StepResult.success(\u0026#34;HR å¯©æ‰¹é€šé\u0026#34;); } else { request.setStatus(WorkflowStatus.REJECTED); request.addData(\u0026#34;hrApproval\u0026#34;, false); request.addData(\u0026#34;rejectionReason\u0026#34;, approval.getReason()); return StepResult.failure(\u0026#34;HR å¯©æ‰¹æ‹’çµ•: \u0026#34; + approval.getReason()); } } else { // çŸ­æœŸè«‹å‡è‡ªå‹•é€šé request.addData(\u0026#34;hrApproval\u0026#34;, true); request.addData(\u0026#34;hrApprovalTime\u0026#34;, LocalDateTime.now()); return StepResult.success(\u0026#34;HR å¯©æ‰¹è‡ªå‹•é€šé\u0026#34;); } } catch (Exception e) { return StepResult.failure(\u0026#34;HR å¯©æ‰¹å¤±æ•—: \u0026#34; + e.getMessage()); } } } // æœ€çµ‚è™•ç†è€… public class FinalProcessingHandler extends WorkflowStepHandler { private final LeaveService leaveService; private final NotificationService notificationService; public FinalProcessingHandler(LeaveService leaveService, NotificationService notificationService) { super(\u0026#34;æœ€çµ‚è™•ç†\u0026#34;); this.leaveService = leaveService; this.notificationService = notificationService; } @Override public boolean canHandle(WorkflowRequest request) { return request.getType() == WorkflowType.LEAVE_REQUEST \u0026amp;\u0026amp; request.getStatus() == WorkflowStatus.IN_PROGRESS \u0026amp;\u0026amp; Boolean.TRUE.equals(request.getData(\u0026#34;managerApproval\u0026#34;)) \u0026amp;\u0026amp; Boolean.TRUE.equals(request.getData(\u0026#34;hrApproval\u0026#34;)); } @Override public StepResult handle(WorkflowRequest request) { try { String employeeId = (String) request.getData(\u0026#34;employeeId\u0026#34;); LocalDate startDate = (LocalDate) request.getData(\u0026#34;startDate\u0026#34;); LocalDate endDate = (LocalDate) request.getData(\u0026#34;endDate\u0026#34;); Long leaveDays = (Long) request.getData(\u0026#34;leaveDays\u0026#34;); // å‰µå»ºè«‹å‡è¨˜éŒ„ LeaveRecord record = leaveService.createLeaveRecord( employeeId, startDate, endDate, leaveDays.intValue() ); // æ›´æ–°è«‹å‡é¤˜é¡ leaveService.updateLeaveBalance(employeeId, -leaveDays.intValue()); // ç™¼é€é€šçŸ¥ notificationService.sendLeaveApprovalNotification( employeeId, record.getLeaveId(), startDate, endDate ); request.setStatus(WorkflowStatus.APPROVED); request.addData(\u0026#34;leaveRecordId\u0026#34;, record.getLeaveId()); request.addData(\u0026#34;completedTime\u0026#34;, LocalDateTime.now()); return StepResult.success(\u0026#34;è«‹å‡ç”³è«‹è™•ç†å®Œæˆ\u0026#34;); } catch (Exception e) { return StepResult.failure(\u0026#34;æœ€çµ‚è™•ç†å¤±æ•—: \u0026#34; + e.getMessage()); } } } Spring Boot æ•´åˆ 1. é…ç½®é¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 @Configuration @EnableAsync public class ChainOfResponsibilityConfig { @Bean public AuthenticationService authenticationService() { return new AuthenticationService(); } @Bean public AuthorizationService authorizationService() { return new AuthorizationService(); } @Bean public SecurityService securityService() { return new SecurityService(); } @Bean public LoggingService loggingService() { return new LoggingService(); } @Bean public BusinessService businessService() { return new BusinessService(); } @Bean public MiddlewareManager\u0026lt;HttpRequestContext\u0026gt; httpMiddlewareManager( SecurityService securityService, AuthenticationService authenticationService, AuthorizationService authorizationService, LoggingService loggingService, BusinessService businessService) { return new MiddlewareManager\u0026lt;HttpRequestContext\u0026gt;() .use(new LoggingMiddleware(loggingService)) .use(new SecurityMiddleware(securityService)) .use(new AuthenticationMiddleware(authenticationService)) .use(new AuthorizationMiddleware(authorizationService)) .use(new BusinessProcessingMiddleware(businessService)); } @Bean public WorkflowStepHandler workflowChain( LeaveService leaveService, ManagerService managerService, HrService hrService, NotificationService notificationService) { WorkflowStepHandler initialCheck = new LeaveRequestInitialCheckHandler(leaveService); WorkflowStepHandler managerApproval = new ManagerApprovalHandler(managerService); WorkflowStepHandler hrApproval = new HrApprovalHandler(hrService); WorkflowStepHandler finalProcessing = new FinalProcessingHandler(leaveService, notificationService); initialCheck.setNext(managerApproval); managerApproval.setNext(hrApproval); hrApproval.setNext(finalProcessing); return initialCheck; } } 2. æ§åˆ¶å™¨å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 @RestController @RequestMapping(\u0026#34;/api/requests\u0026#34;) public class RequestController { private final MiddlewareManager\u0026lt;HttpRequestContext\u0026gt; middlewareManager; public RequestController(MiddlewareManager\u0026lt;HttpRequestContext\u0026gt; middlewareManager) { this.middlewareManager = middlewareManager; } @GetMapping(\u0026#34;/secure-data\u0026#34;) public ResponseEntity\u0026lt;ApiResponse\u0026lt;Object\u0026gt;\u0026gt; getSecureData( HttpServletRequest servletRequest, @RequestParam String resource) { HttpRequestContext context = createRequestContext(servletRequest, resource); try { middlewareManager.process(context); Object result = context.getParameters().get(\u0026#34;result\u0026#34;); if (result != null) { return ResponseEntity.ok(ApiResponse.success(result) .message(\u0026#34;æ•¸æ“šç²å–æˆåŠŸ\u0026#34;) .build()); } else { return ResponseEntity.status(HttpStatus.FORBIDDEN) .body(ApiResponse.failure(\u0026#34;è«‹æ±‚è¢«æ‹’çµ•\u0026#34;).build()); } } catch (Exception e) { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(ApiResponse.failure(\u0026#34;è™•ç†è«‹æ±‚æ™‚å‡ºéŒ¯\u0026#34;).build()); } } private HttpRequestContext createRequestContext(HttpServletRequest servletRequest, String resource) { HttpRequestContext context = new HttpRequestContext( servletRequest.getMethod(), servletRequest.getRequestURI() ); // å¾©åˆ¶è«‹æ±‚é ­ Enumeration\u0026lt;String\u0026gt; headerNames = servletRequest.getHeaderNames(); while (headerNames.hasMoreElements()) { String headerName = headerNames.nextElement(); context.addHeader(headerName, servletRequest.getHeader(headerName)); } // è¨­ç½®å®¢æˆ¶ç«¯ä¿¡æ¯ context.setClientIp(getClientIp(servletRequest)); context.setUserAgent(servletRequest.getHeader(\u0026#34;User-Agent\u0026#34;)); // æ·»åŠ è³‡æºåƒæ•¸ context.addParameter(\u0026#34;resource\u0026#34;, resource); return context; } private String getClientIp(HttpServletRequest request) { String xForwardedFor = request.getHeader(\u0026#34;X-Forwarded-For\u0026#34;); if (xForwardedFor != null \u0026amp;\u0026amp; !xForwardedFor.isEmpty()) { return xForwardedFor.split(\u0026#34;,\u0026#34;)[0].trim(); } String xRealIp = request.getHeader(\u0026#34;X-Real-IP\u0026#34;); if (xRealIp != null \u0026amp;\u0026amp; !xRealIp.isEmpty()) { return xRealIp; } return request.getRemoteAddr(); } } @RestController @RequestMapping(\u0026#34;/api/workflow\u0026#34;) public class WorkflowController { private final WorkflowStepHandler workflowChain; public WorkflowController(WorkflowStepHandler workflowChain) { this.workflowChain = workflowChain; } @PostMapping(\u0026#34;/leave-request\u0026#34;) public ResponseEntity\u0026lt;ApiResponse\u0026lt;String\u0026gt;\u0026gt; submitLeaveRequest( @RequestBody @Valid LeaveRequestDto requestDto) { try { WorkflowRequest workflowRequest = new WorkflowRequest( \u0026#34;leave-workflow\u0026#34;, requestDto.getEmployeeId(), WorkflowType.LEAVE_REQUEST ); workflowRequest.addData(\u0026#34;employeeId\u0026#34;, requestDto.getEmployeeId()); workflowRequest.addData(\u0026#34;startDate\u0026#34;, requestDto.getStartDate()); workflowRequest.addData(\u0026#34;endDate\u0026#34;, requestDto.getEndDate()); workflowRequest.addData(\u0026#34;reason\u0026#34;, requestDto.getReason()); StepResult result = workflowChain.process(workflowRequest); if (result.isSuccess()) { return ResponseEntity.ok(ApiResponse.success(workflowRequest.getRequestId()) .message(\u0026#34;è«‹å‡ç”³è«‹æäº¤æˆåŠŸ\u0026#34;) .build()); } else { return ResponseEntity.badRequest() .body(ApiResponse.\u0026lt;String\u0026gt;failure(\u0026#34;è«‹å‡ç”³è«‹è¢«æ‹’çµ•\u0026#34;) .error(result.getMessage()) .build()); } } catch (Exception e) { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(ApiResponse.\u0026lt;String\u0026gt;failure(\u0026#34;è™•ç†è«‹å‡ç”³è«‹æ™‚å‡ºéŒ¯\u0026#34;) .error(e.getMessage()) .build()); } } } // è«‹å‡ç”³è«‹ DTO public class LeaveRequestDto { @NotBlank(message = \u0026#34;å“¡å·¥ ID ä¸èƒ½ç‚ºç©º\u0026#34;) private String employeeId; @NotNull(message = \u0026#34;é–‹å§‹æ—¥æœŸä¸èƒ½ç‚ºç©º\u0026#34;) @Future(message = \u0026#34;é–‹å§‹æ—¥æœŸå¿…é ˆæ˜¯å°‡ä¾†æ—¥æœŸ\u0026#34;) private LocalDate startDate; @NotNull(message = \u0026#34;çµæŸæ—¥æœŸä¸èƒ½ç‚ºç©º\u0026#34;) @Future(message = \u0026#34;çµæŸæ—¥æœŸå¿…é ˆæ˜¯å°‡ä¾†æ—¥æœŸ\u0026#34;) private LocalDate endDate; @NotBlank(message = \u0026#34;è«‹å‡åŸå› ä¸èƒ½ç‚ºç©º\u0026#34;) @Size(max = 500, message = \u0026#34;è«‹å‡åŸå› ä¸èƒ½è¶…é500å­—\u0026#34;) private String reason; // æ§‹é€ å‡½æ•¸ã€getterã€setter ç•¥ } 3. æ¸¬è©¦å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 @SpringBootTest class ChainOfResponsibilityTest { @Test void testMiddlewareChain() { // Given SecurityService securityService = new SecurityService(); AuthenticationService authService = new AuthenticationService(); AuthorizationService authzService = new AuthorizationService(); LoggingService loggingService = new LoggingService(); BusinessService businessService = new BusinessService(); MiddlewareManager\u0026lt;HttpRequestContext\u0026gt; manager = new MiddlewareManager\u0026lt;HttpRequestContext\u0026gt;() .use(new LoggingMiddleware(loggingService)) .use(new SecurityMiddleware(securityService)) .use(new AuthenticationMiddleware(authService)) .use(new AuthorizationMiddleware(authzService)) .use(new BusinessProcessingMiddleware(businessService)); HttpRequestContext context = new HttpRequestContext(\u0026#34;GET\u0026#34;, \u0026#34;/api/secure-data\u0026#34;); context.setClientIp(\u0026#34;192.168.1.100\u0026#34;); context.setUserAgent(\u0026#34;TestClient/1.0\u0026#34;); context.addHeader(\u0026#34;Authorization\u0026#34;, \u0026#34;Bearer valid-token\u0026#34;); // When manager.process(context); // Then assertThat(context.getParameters()).containsKey(\u0026#34;userId\u0026#34;); assertThat(context.getParameters()).containsKey(\u0026#34;result\u0026#34;); } @Test void testWorkflowChain() { // Given LeaveService leaveService = mock(LeaveService.class); ManagerService managerService = mock(ManagerService.class); HrService hrService = mock(HrService.class); NotificationService notificationService = mock(NotificationService.class); when(leaveService.getRemainingLeaveDays(\u0026#34;EMP001\u0026#34;)).thenReturn(10); when(managerService.getDirectManager(\u0026#34;EMP001\u0026#34;)).thenReturn(\u0026#34;MGR001\u0026#34;); when(managerService.requestApproval(any(), any(), any())) .thenReturn(new ApprovalResult(true, \u0026#34;æ‰¹å‡†\u0026#34;)); when(hrService.requestApproval(any(), any(), any())) .thenReturn(new ApprovalResult(true, \u0026#34;æ‰¹å‡†\u0026#34;)); WorkflowStepHandler initialCheck = new LeaveRequestInitialCheckHandler(leaveService); WorkflowStepHandler managerApproval = new ManagerApprovalHandler(managerService); WorkflowStepHandler hrApproval = new HrApprovalHandler(hrService); WorkflowStepHandler finalProcessing = new FinalProcessingHandler(leaveService, notificationService); initialCheck.setNext(managerApproval); managerApproval.setNext(hrApproval); hrApproval.setNext(finalProcessing); WorkflowRequest request = new WorkflowRequest(\u0026#34;leave-workflow\u0026#34;, \u0026#34;EMP001\u0026#34;, WorkflowType.LEAVE_REQUEST); request.addData(\u0026#34;employeeId\u0026#34;, \u0026#34;EMP001\u0026#34;); request.addData(\u0026#34;startDate\u0026#34;, LocalDate.now().plusDays(1)); request.addData(\u0026#34;endDate\u0026#34;, LocalDate.now().plusDays(3)); request.addData(\u0026#34;reason\u0026#34;, \u0026#34;å€‹äººäº‹å‹™\u0026#34;); // When StepResult result = initialCheck.process(request); // Then assertThat(result.isSuccess()).isTrue(); assertThat(request.getStatus()).isEqualTo(WorkflowStatus.APPROVED); verify(leaveService).createLeaveRecord(any(), any(), any(), anyInt()); verify(notificationService).sendLeaveApprovalNotification(any(), any(), any(), any()); } @Test void testProcessorChain() { // Given ProcessorChain\u0026lt;String\u0026gt; chain = new ProcessorChain\u0026lt;String\u0026gt;() .addProcessor(request -\u0026gt; request.startsWith(\u0026#34;A\u0026#34;) ? ProcessingResult.processed(\u0026#34;è™•ç†A: \u0026#34; + request) : ProcessingResult.notProcessed()) .addProcessor(request -\u0026gt; request.startsWith(\u0026#34;B\u0026#34;) ? ProcessingResult.processed(\u0026#34;è™•ç†B: \u0026#34; + request) : ProcessingResult.notProcessed()) .addProcessor(request -\u0026gt; ProcessingResult.processed(\u0026#34;é»˜èªè™•ç†: \u0026#34; + request)); // When \u0026amp; Then ProcessingResult\u0026lt;String\u0026gt; result1 = chain.process(\u0026#34;A123\u0026#34;); assertThat(result1.isProcessed()).isTrue(); assertThat(result1.getResult()).isEqualTo(\u0026#34;è™•ç†A: A123\u0026#34;); ProcessingResult\u0026lt;String\u0026gt; result2 = chain.process(\u0026#34;B456\u0026#34;); assertThat(result2.isProcessed()).isTrue(); assertThat(result2.getResult()).isEqualTo(\u0026#34;è™•ç†B: B456\u0026#34;); ProcessingResult\u0026lt;String\u0026gt; result3 = chain.process(\u0026#34;C789\u0026#34;); assertThat(result3.isProcessed()).isTrue(); assertThat(result3.getResult()).isEqualTo(\u0026#34;é»˜èªè™•ç†: C789\u0026#34;); } } æ€§èƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. ç•°æ­¥è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 // ç•°æ­¥è²¬ä»»éˆ @Component public class AsyncChainProcessor { private final ThreadPoolTaskExecutor executor; public AsyncChainProcessor() { this.executor = new ThreadPoolTaskExecutor(); this.executor.setCorePoolSize(5); this.executor.setMaxPoolSize(20); this.executor.setQueueCapacity(100); this.executor.setThreadNamePrefix(\u0026#34;async-chain-\u0026#34;); this.executor.initialize(); } public \u0026lt;T\u0026gt; CompletableFuture\u0026lt;ProcessingResult\u0026lt;T\u0026gt;\u0026gt; processAsync( ProcessorChain\u0026lt;T\u0026gt; chain, T request) { return CompletableFuture.supplyAsync(() -\u0026gt; chain.process(request), executor); } public \u0026lt;T\u0026gt; void processAsync(MiddlewareManager\u0026lt;T\u0026gt; manager, T request) { executor.submit(() -\u0026gt; manager.process(request)); } } // æ‰¹é‡è™•ç† @Component public class BatchChainProcessor { private final AsyncChainProcessor asyncProcessor; public BatchChainProcessor(AsyncChainProcessor asyncProcessor) { this.asyncProcessor = asyncProcessor; } public \u0026lt;T\u0026gt; CompletableFuture\u0026lt;List\u0026lt;ProcessingResult\u0026lt;T\u0026gt;\u0026gt;\u0026gt; processBatch( ProcessorChain\u0026lt;T\u0026gt; chain, List\u0026lt;T\u0026gt; requests) { List\u0026lt;CompletableFuture\u0026lt;ProcessingResult\u0026lt;T\u0026gt;\u0026gt;\u0026gt; futures = requests.stream() .map(request -\u0026gt; asyncProcessor.processAsync(chain, request)) .collect(Collectors.toList()); return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])) .thenApply(v -\u0026gt; futures.stream() .map(CompletableFuture::join) .collect(Collectors.toList())); } } 2. ç·©å­˜å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // è™•ç†çµæœç·©å­˜ @Component public class CachedChainProcessor { private final Cache\u0026lt;String, ProcessingResult\u0026lt;?\u0026gt;\u0026gt; cache; public CachedChainProcessor() { this.cache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(Duration.ofMinutes(15)) .build(); } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; ProcessingResult\u0026lt;T\u0026gt; processWithCache( ProcessorChain\u0026lt;T\u0026gt; chain, T request, String cacheKey) { return (ProcessingResult\u0026lt;T\u0026gt;) cache.get(cacheKey, key -\u0026gt; chain.process(request)); } public void invalidateCache(String cacheKey) { cache.invalidate(cacheKey); } public void invalidateAll() { cache.invalidateAll(); } } ç›£æ§èˆ‡è¨ºæ–· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // è²¬ä»»éˆç›£æ§ @Component public class ChainMonitor { private final MeterRegistry meterRegistry; private final Counter requestCounter; private final Counter processedCounter; private final Timer processingTimer; public ChainMonitor(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.requestCounter = Counter.builder(\u0026#34;chain.requests\u0026#34;) .description(\u0026#34;Total number of requests processed by chain\u0026#34;) .register(meterRegistry); this.processedCounter = Counter.builder(\u0026#34;chain.processed\u0026#34;) .description(\u0026#34;Number of successfully processed requests\u0026#34;) .register(meterRegistry); this.processingTimer = Timer.builder(\u0026#34;chain.processing.time\u0026#34;) .description(\u0026#34;Time spent processing requests\u0026#34;) .register(meterRegistry); } public \u0026lt;T\u0026gt; ProcessingResult\u0026lt;T\u0026gt; monitorProcess( ProcessorChain\u0026lt;T\u0026gt; chain, T request, String chainName) { requestCounter.increment(Tags.of(\u0026#34;chain\u0026#34;, chainName)); return processingTimer.recordCallable(() -\u0026gt; { ProcessingResult\u0026lt;T\u0026gt; result = chain.process(request); if (result.isProcessed()) { processedCounter.increment(Tags.of(\u0026#34;chain\u0026#34;, chainName)); } return result; }); } } ç¸½çµ è²¬ä»»éˆæ¨¡å¼é©ç”¨æ–¼ï¼š\nè«‹æ±‚è™•ç†ç®¡é“ï¼šHTTP è«‹æ±‚ã€æ¶ˆæ¯è™•ç†ã€å·¥ä½œæµç¨‹ å‹•æ…‹è²¬ä»»åˆ†é…ï¼šæ ¹æ“šè«‹æ±‚é¡å‹å‹•æ…‹é¸æ“‡è™•ç†è€… ä¸­ä»‹è»Ÿé«”ç³»çµ±ï¼šWeb æ¡†æ¶ã€API ç¶²é—œã€ä¼æ¥­æœå‹™ç¸½ç·š æ“´å±•æ€§éœ€æ±‚ï¼šæ˜“æ–¼æ·»åŠ æ–°çš„è™•ç†è€…ï¼Œä¸å½±éŸ¿ç¾æœ‰ä»£ç¢¼ é—œéµæœ€ä½³å¯¦è¸ è™•ç†è€…è§£è€¦ï¼šæ¯å€‹è™•ç†è€…åªé—œæ³¨è‡ªå·±çš„è·è²¬ éˆå¼çµ„åˆï¼šéˆæ´»çµ„åˆä¸åŒçš„è™•ç†è€… éŒ¯èª¤è™•ç†ï¼šæ¯å€‹è™•ç†è€…éƒ½è¦è™•ç†ç•°å¸¸æƒ…æ³ æ€§èƒ½å„ªåŒ–ï¼šä½¿ç”¨ç·©å­˜ã€ç•°æ­¥è™•ç†ã€æ‰¹é‡æ“ä½œ ç›£æ§è¨ºæ–·ï¼šè¨˜éŒ„è™•ç†æµç¨‹å’Œæ€§èƒ½æŒ‡æ¨™ æ¸¬è©¦ç­–ç•¥ï¼šå–®å…ƒæ¸¬è©¦æ¯å€‹è™•ç†è€…ï¼Œé›†æˆæ¸¬è©¦æ•´å€‹éˆ ","permalink":"https://xinqilin.github.io/post/architecture/chainofresponsibility/","tags":["Design Pattern","Chain of Responsibility","Behavioral Pattern","Request Processing","Loose Coupling","Flow Control","Java","Spring Boot","Enterprise Architecture","Handler Chain","Middleware","Pipeline Pattern","Request Response"],"title":"è²¬ä»»éˆæ¨¡å¼ (Chain of Responsibility Pattern) å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šè«‹æ±‚è™•ç†çš„å‹•æ…‹æµç¨‹æ§åˆ¶"},{"content":"Mediator Mediator é€šéé˜»æ­¢å°è±¡é¡¯å¼åœ°ç›¸äº’å¼•ç”¨ä¾†ä¿ƒé€²é¬†æ•£è€¦åˆï¼Œä¸¦ä¸”å®ƒå…è¨±æ‚¨ç¨ç«‹åœ°æ”¹è®Šå®ƒå€‘çš„äº¤äº’ã€‚ æˆ‘å€‘ä½¿ç”¨ä¸­ä»‹è€…è¨­è¨ˆæ¨¡å¼åœ¨ç³»çµ±ä¸­çš„ä¸åŒå°è±¡ä¹‹é–“æä¾›é›†ä¸­çš„é€šä¿¡åª’ä»‹ã€‚\nä¸­ä»‹è€…æ¨¡å¼å°ˆæ³¨æ–¼åœ¨å°è±¡ä¹‹é–“æä¾›ä¸€å€‹ä¸­ä»‹è€…é€²è¡Œäº’å‹•ï¼Œä¸¦å¹«åŠ©å¯¦ç¾å°è±¡ä¹‹é–“çš„ä¸Ÿå¤±è€¦åˆã€‚å°åƒè¦æ±‚ä¸­ä»‹è€…ä»£è¡¨å®ƒå€‘é€²è¡Œäº¤äº’ï¼Œè€Œä¸æ˜¯ç›´æ¥ç›¸äº’äº¤äº’ã€‚å®ƒå°è‡´å¯é‡ç”¨æ€§å’Œé¬†æ•£è€¦åˆã€‚æ­¤å¤–ï¼Œå®ƒå°è£äº†å°è±¡ä¹‹é–“çš„äº¤äº’ï¼Œä½¿å®ƒå€‘ç›¸äº’ç¨ç«‹ã€‚é€™ä¹Ÿå…è¨±ä»–å€‘é€šéå¯¦ç¾ä¸åŒçš„ä¸­ä»‹ä»¥å®Œå…¨ä¸åŒçš„æ–¹å¼æ”¹è®Šèˆ‡å…¶ä»–å°è±¡çš„äº¤äº’ã€‚èª¿è§£å™¨æœ‰åŠ©æ–¼é™ä½é¡çš„è¤‡é›œæ€§ã€‚æ­¤å¤–ï¼Œæ¯å€‹å°åƒä¸å†éœ€è¦è©³ç´°äº†è§£å¦‚ä½•èˆ‡å…¶ä»–å°è±¡äº¤äº’ã€‚å°è±¡ä¹‹é–“çš„è€¦åˆå¾ç·Šç·»åƒµç¡¬åˆ°é¬†æ•£å„ªé›…ã€‚ ä¸­ä»‹è€…è¨­è¨ˆæ¨¡å¼åœ¨å¤šå€‹å°è±¡ç›¸äº’äº¤äº’çš„ä¼æ¥­æ‡‰ç”¨ç¨‹åºä¸­éå¸¸æœ‰ç”¨ã€‚å¦‚æœå°è±¡ç›´æ¥ç›¸äº’äº¤äº’ï¼Œç³»çµ±çµ„ä»¶å°±æœƒç›¸äº’ç·Šå¯†è€¦åˆã€‚å®ƒå€‘é‚„ä½¿å¯ç¶­è­·æ€§æˆæœ¬æ›´é«˜ï¼Œä¸¦ä¸”ä¸èƒ½éˆæ´»åœ°è¼•é¬†æ“´å±•ã€‚\nä¾‹å¦‚ï¼Œç©ºä¸­äº¤é€šç®¡åˆ¶å“¡æ˜¯èª¿è§£å“¡æ¨¡å¼çš„ä¸€å€‹å¾ˆå¥½çš„ä¾‹å­ï¼Œå…¶ä¸­æ©Ÿå ´æ§åˆ¶å®¤å……ç•¶ä¸åŒèˆªç­ä¹‹é–“é€šä¿¡çš„èª¿è§£å“¡ã€‚ä¸­ä»‹ä½œç‚ºå°è±¡ä¹‹é–“çš„è·¯ç”±å™¨å·¥ä½œï¼Œå®ƒå¯ä»¥æœ‰è‡ªå·±çš„é‚è¼¯ä¾†æä¾›é€šä¿¡æ–¹å¼ã€‚\nMediator: å®šç¾©ä¸€å€‹èˆ‡åŒäº‹å°è±¡é€šä¿¡çš„ interface ConcreteMediator: é€šéå”èª¿ Colleague å°è±¡ä¾†å¯¦ç¾å”ä½œè¡Œç‚ºã€‚å®ƒé‚„äº†è§£ä¸¦ç¶­è­·å…¶åŒäº‹ã€‚ Colleague Classes: æ¯å€‹ Colleague class éƒ½çŸ¥é“å®ƒçš„ Mediator å°è±¡ã€‚æ¯ä½åŒäº‹åœ¨æœ¬æ‡‰èˆ‡å¦ä¸€ä½åŒäº‹æºé€šæ™‚éƒ½æœƒèˆ‡å…¶èª¿è§£å“¡æºé€šã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 public interface IMediator { public void talk(); public void fight(); public void registerA(ColleagueA a); public void registerB(ColleagueB b); } public class ConcreteMediator implements IMediator { ColleagueA talk; ColleagueB fight; @Override public void talk() { System.out.println(\u0026#34;Mediator is talking\u0026#34;); } @Override public void fight() { System.out.println(\u0026#34;Mediator is fighting\u0026#34;); } @Override public void registerA(ColleagueA a) { this.talk = a; } @Override public void registerB(ColleagueB b) { this.fight = b; } } // =========== public abstract class Colleague { IMediator mediator; public abstract void doSomething(); } public class ColleagueA extends Colleague { public ColleagueA(IMediator mediator) { this.mediator = mediator; this.mediator.registerA(this); } @Override public void doSomething() { this.mediator.talk(); } } public class ColleagueB extends Colleague { public ColleagueB(IMediator mediator) { this.mediator = mediator; this.mediator.registerB(this); } @Override public void doSomething() { this.mediator.fight(); } } 1 2 3 4 5 6 7 8 9 10 public static void main(String[] args) { IMediator mediator = new ConcreteMediator(); ColleagueA talkColleague= new ColleagueA(mediator); talkColleague.doSomething(); ColleagueB fightColleague = new ColleagueB(mediator); fightColleague.doSomething(); } ä¸€çµ„å°åƒä»¥å®šç¾©æ˜ç¢ºä½†è¤‡é›œçš„æ–¹å¼é€²è¡Œäº’å‹•ã€‚ç”±æ­¤ç”¢ç”Ÿçš„ç›¸äº’ä¾è³´æ˜¯éçµæ§‹åŒ–çš„ä¸¦ä¸”é›£ä»¥ç†è§£ã€‚ é‡ç”¨ä¸€å€‹å°åƒå¾ˆå›°é›£ï¼Œå› ç‚ºå®ƒå¼•ç”¨äº†è¨±å¤šå…¶ä»–å°è±¡ä¸¦èˆ‡ä¹‹äº’å‹•ã€‚ åˆ†ä½ˆåœ¨å¤šå€‹é¡ä¹‹é–“çš„è¡Œç‚ºæ‡‰è©²æ˜¯å¯å®šåˆ¶çš„ï¼Œç„¡éœ€å¤§é‡å­é¡åŒ–ã€‚ ","permalink":"https://xinqilin.github.io/post/architecture/mediator/","tags":[],"title":"DesignPattern - Behavioral - Mediator"},{"content":"æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern) å®Œæ•´å¯¦ä½œæŒ‡å— æ¨¡å¼æ¦‚è¿° æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç¨®è¡Œç‚ºè¨­è¨ˆæ¨¡å¼ï¼Œå®ƒåœ¨è¶…é¡ä¸­å®šç¾©äº†ä¸€å€‹ç®—æ³•çš„éª¨æ¶ï¼Œå…è¨±å­é¡åœ¨ä¸æ”¹è®Šç®—æ³•çµæ§‹çš„å‰æä¸‹é‡æ–°å®šç¾©ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥é©Ÿã€‚é€™å€‹æ¨¡å¼é«”ç¾äº†ã€Œå¥½èŠå¡¢åŸå‰‡ã€(Hollywood Principle) - \u0026ldquo;Don\u0026rsquo;t call us, we\u0026rsquo;ll call you\u0026rdquo;ï¼Œå³çˆ¶é¡èª¿ç”¨å­é¡çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯å­é¡èª¿ç”¨çˆ¶é¡æ–¹æ³•ã€‚\næ ¸å¿ƒæ¦‚å¿µ 1. æ¨¡æ¿æ–¹æ³•æ¨¡å¼è§£æ±ºçš„å•é¡Œ ä»£ç¢¼é‡è¤‡ï¼šå¤šå€‹é¡åˆ¥ä¸­å­˜åœ¨ç›¸ä¼¼çš„ç®—æ³•æµç¨‹ ç®—æ³•è®Šé«”ï¼šç›¸åŒçš„ç®—æ³•éª¨æ¶ï¼Œä½†æŸäº›æ­¥é©Ÿéœ€è¦ä¸åŒå¯¦ç¾ æµç¨‹æ§åˆ¶ï¼šéœ€è¦ç¢ºä¿ç®—æ³•åŸ·è¡Œçš„é †åºå’Œå®Œæ•´æ€§ æ“´å±•æ€§ï¼šåœ¨ä¸ä¿®æ”¹åŸæœ‰ä»£ç¢¼çš„æƒ…æ³ä¸‹å¢åŠ æ–°çš„ç®—æ³•è®Šé«” 2. æ¨¡å¼çµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 // æŠ½è±¡æ¨¡æ¿é¡åˆ¥ public abstract class AbstractTemplate { // æ¨¡æ¿æ–¹æ³• - å®šç¾©ç®—æ³•éª¨æ¶ public final void templateMethod() { step1(); step2(); if (hook()) { step3(); } step4(); } // å…·é«”æ–¹æ³• - æ‰€æœ‰å­é¡å…±åŒçš„å¯¦ç¾ protected final void step1() { System.out.println(\u0026#34;åŸ·è¡Œé€šç”¨æ­¥é©Ÿ1\u0026#34;); } // æŠ½è±¡æ–¹æ³• - å­é¡å¿…é ˆå¯¦ç¾ protected abstract void step2(); protected abstract void step4(); // å¯é¸æ­¥é©Ÿ - é è¨­å¯¦ç¾ protected void step3() { System.out.println(\u0026#34;åŸ·è¡Œé è¨­æ­¥é©Ÿ3\u0026#34;); } // é‰¤å­æ–¹æ³• - æ§åˆ¶æµç¨‹ protected boolean hook() { return true; } } // å…·é«”å¯¦ç¾é¡åˆ¥ public class ConcreteTemplateA extends AbstractTemplate { @Override protected void step2() { System.out.println(\u0026#34;ConcreteA å¯¦ç¾æ­¥é©Ÿ2\u0026#34;); } @Override protected void step4() { System.out.println(\u0026#34;ConcreteA å¯¦ç¾æ­¥é©Ÿ4\u0026#34;); } @Override protected boolean hook() { return false; // è·³éæ­¥é©Ÿ3 } } public class ConcreteTemplateB extends AbstractTemplate { @Override protected void step2() { System.out.println(\u0026#34;ConcreteB å¯¦ç¾æ­¥é©Ÿ2\u0026#34;); } @Override protected void step4() { System.out.println(\u0026#34;ConcreteB å¯¦ç¾æ­¥é©Ÿ4\u0026#34;); } @Override protected void step3() { System.out.println(\u0026#34;ConcreteB è‡ªå®šç¾©æ­¥é©Ÿ3\u0026#34;); } } åŸºç¤å¯¦ä½œç¯„ä¾‹ 1. è¨‚å–®è™•ç†æµç¨‹æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 /** * è¨‚å–®è™•ç†æŠ½è±¡æ¨¡æ¿ */ public abstract class OrderProcessingTemplate { /** * è¨‚å–®è™•ç†ä¸»æµç¨‹ - æ¨¡æ¿æ–¹æ³• */ public final OrderResult processOrder(OrderRequest request) { try { // 1. è¨‚å–®é©—è­‰ validateOrder(request); logStep(\u0026#34;è¨‚å–®é©—è­‰å®Œæˆ\u0026#34;); // 2. åº«å­˜æª¢æŸ¥ checkInventory(request); logStep(\u0026#34;åº«å­˜æª¢æŸ¥å®Œæˆ\u0026#34;); // 3. åƒ¹æ ¼è¨ˆç®— BigDecimal totalPrice = calculatePrice(request); logStep(\u0026#34;åƒ¹æ ¼è¨ˆç®—å®Œæˆ: \u0026#34; + totalPrice); // 4. æ”¯ä»˜è™•ç† (å¯é¸) if (requiresPayment()) { processPayment(request, totalPrice); logStep(\u0026#34;æ”¯ä»˜è™•ç†å®Œæˆ\u0026#34;); } // 5. è¨‚å–®ç¢ºèª String orderId = confirmOrder(request, totalPrice); logStep(\u0026#34;è¨‚å–®ç¢ºèªå®Œæˆ: \u0026#34; + orderId); // 6. å¾ŒçºŒè™•ç† (é‰¤å­æ–¹æ³•) if (needsPostProcessing()) { performPostProcessing(request, orderId); logStep(\u0026#34;å¾ŒçºŒè™•ç†å®Œæˆ\u0026#34;); } return new OrderResult(orderId, totalPrice, \u0026#34;è¨‚å–®è™•ç†æˆåŠŸ\u0026#34;); } catch (Exception e) { handleError(request, e); return new OrderResult(null, null, \u0026#34;è¨‚å–®è™•ç†å¤±æ•—: \u0026#34; + e.getMessage()); } } // é€šç”¨æ–¹æ³• - finalï¼Œä¸å¯è¦†å¯« protected final void logStep(String message) { System.out.println(\u0026#34;[\u0026#34; + LocalDateTime.now() + \u0026#34;] \u0026#34; + message); } // æŠ½è±¡æ–¹æ³• - å­é¡å¿…é ˆå¯¦ç¾ protected abstract void validateOrder(OrderRequest request); protected abstract void checkInventory(OrderRequest request); protected abstract BigDecimal calculatePrice(OrderRequest request); protected abstract String confirmOrder(OrderRequest request, BigDecimal totalPrice); // å¯é¸æ–¹æ³• - æœ‰é è¨­å¯¦ç¾ protected void processPayment(OrderRequest request, BigDecimal amount) { System.out.println(\u0026#34;åŸ·è¡Œé è¨­æ”¯ä»˜è™•ç†: \u0026#34; + amount); } protected void performPostProcessing(OrderRequest request, String orderId) { System.out.println(\u0026#34;åŸ·è¡Œé è¨­å¾ŒçºŒè™•ç†\u0026#34;); } protected void handleError(OrderRequest request, Exception e) { System.err.println(\u0026#34;è¨‚å–®è™•ç†éŒ¯èª¤: \u0026#34; + e.getMessage()); } // é‰¤å­æ–¹æ³• - æ§åˆ¶æµç¨‹ protected boolean requiresPayment() { return true; } protected boolean needsPostProcessing() { return false; } } /** * ç·šä¸Šè¨‚å–®è™•ç† */ public class OnlineOrderProcessor extends OrderProcessingTemplate { @Override protected void validateOrder(OrderRequest request) { if (request.getCustomerId() == null) { throw new IllegalArgumentException(\u0026#34;ç·šä¸Šè¨‚å–®å¿…é ˆæœ‰å®¢æˆ¶ID\u0026#34;); } if (request.getShippingAddress() == null) { throw new IllegalArgumentException(\u0026#34;ç·šä¸Šè¨‚å–®å¿…é ˆæœ‰é…é€åœ°å€\u0026#34;); } } @Override protected void checkInventory(OrderRequest request) { // æª¢æŸ¥ç·šä¸Šåº«å­˜ for (OrderItem item : request.getItems()) { System.out.println(\u0026#34;æª¢æŸ¥ç·šä¸Šåº«å­˜: \u0026#34; + item.getProductName()); // æ¨¡æ“¬åº«å­˜æª¢æŸ¥é‚è¼¯ } } @Override protected BigDecimal calculatePrice(OrderRequest request) { BigDecimal total = request.getItems().stream() .map(item -\u0026gt; item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity()))) .reduce(BigDecimal.ZERO, BigDecimal::add); // ç·šä¸Šè¨‚å–®åŠ ä¸Šé‹è²» BigDecimal shippingFee = new BigDecimal(\u0026#34;50\u0026#34;); return total.add(shippingFee); } @Override protected void processPayment(OrderRequest request, BigDecimal amount) { System.out.println(\u0026#34;è™•ç†ç·šä¸Šæ”¯ä»˜: \u0026#34; + amount); // æ•´åˆç·šä¸Šæ”¯ä»˜ç³»çµ± } @Override protected String confirmOrder(OrderRequest request, BigDecimal totalPrice) { String orderId = \u0026#34;ON-\u0026#34; + System.currentTimeMillis(); System.out.println(\u0026#34;ç¢ºèªç·šä¸Šè¨‚å–®: \u0026#34; + orderId); return orderId; } @Override protected void performPostProcessing(OrderRequest request, String orderId) { System.out.println(\u0026#34;ç™¼é€è¨‚å–®ç¢ºèªéƒµä»¶\u0026#34;); System.out.println(\u0026#34;å®‰æ’é…é€\u0026#34;); } @Override protected boolean needsPostProcessing() { return true; // ç·šä¸Šè¨‚å–®éœ€è¦å¾ŒçºŒè™•ç† } } /** * å¯¦é«”åº—è¨‚å–®è™•ç† */ public class StoreOrderProcessor extends OrderProcessingTemplate { @Override protected void validateOrder(OrderRequest request) { if (request.getStoreId() == null) { throw new IllegalArgumentException(\u0026#34;å¯¦é«”åº—è¨‚å–®å¿…é ˆæœ‰åº—é‹ªID\u0026#34;); } } @Override protected void checkInventory(OrderRequest request) { // æª¢æŸ¥åº—é‹ªåº«å­˜ for (OrderItem item : request.getItems()) { System.out.println(\u0026#34;æª¢æŸ¥åº—é‹ªåº«å­˜: \u0026#34; + item.getProductName()); } } @Override protected BigDecimal calculatePrice(OrderRequest request) { BigDecimal total = request.getItems().stream() .map(item -\u0026gt; item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity()))) .reduce(BigDecimal.ZERO, BigDecimal::add); // å¯¦é«”åº—å¯èƒ½æœ‰æœƒå“¡æŠ˜æ‰£ if (request.isMember()) { total = total.multiply(new BigDecimal(\u0026#34;0.9\u0026#34;)); // 9æŠ˜ } return total; } @Override protected void processPayment(OrderRequest request, BigDecimal amount) { System.out.println(\u0026#34;è™•ç†ç¾é‡‘/åˆ·å¡æ”¯ä»˜: \u0026#34; + amount); } @Override protected String confirmOrder(OrderRequest request, BigDecimal totalPrice) { String orderId = \u0026#34;ST-\u0026#34; + System.currentTimeMillis(); System.out.println(\u0026#34;ç¢ºèªå¯¦é«”åº—è¨‚å–®: \u0026#34; + orderId); return orderId; } @Override protected boolean requiresPayment() { return true; // å¯¦é«”åº—å³æ™‚ä»˜æ¬¾ } @Override protected boolean needsPostProcessing() { return false; // å¯¦é«”åº—é€šå¸¸ä¸éœ€è¦å¾ŒçºŒè™•ç† } } /** * æ‰¹ç™¼è¨‚å–®è™•ç† */ public class WholesaleOrderProcessor extends OrderProcessingTemplate { @Override protected void validateOrder(OrderRequest request) { if (request.getCompanyId() == null) { throw new IllegalArgumentException(\u0026#34;æ‰¹ç™¼è¨‚å–®å¿…é ˆæœ‰å…¬å¸ID\u0026#34;); } // æ‰¹ç™¼è¨‚å–®æœ€å°æ•¸é‡é™åˆ¶ int totalQuantity = request.getItems().stream() .mapToInt(OrderItem::getQuantity) .sum(); if (totalQuantity \u0026lt; 100) { throw new IllegalArgumentException(\u0026#34;æ‰¹ç™¼è¨‚å–®æœ€å°æ•¸é‡ç‚º100ä»¶\u0026#34;); } } @Override protected void checkInventory(OrderRequest request) { System.out.println(\u0026#34;æª¢æŸ¥æ‰¹ç™¼å€‰åº«åº«å­˜\u0026#34;); // æ‰¹ç™¼å¯èƒ½éœ€è¦é ç•™åº«å­˜ } @Override protected BigDecimal calculatePrice(OrderRequest request) { BigDecimal total = request.getItems().stream() .map(item -\u0026gt; { BigDecimal unitPrice = item.getPrice(); int quantity = item.getQuantity(); // æ‰¹ç™¼åƒ¹æ ¼éšæ¢¯æŠ˜æ‰£ if (quantity \u0026gt;= 1000) { unitPrice = unitPrice.multiply(new BigDecimal(\u0026#34;0.7\u0026#34;)); // 7æŠ˜ } else if (quantity \u0026gt;= 500) { unitPrice = unitPrice.multiply(new BigDecimal(\u0026#34;0.8\u0026#34;)); // 8æŠ˜ } else if (quantity \u0026gt;= 100) { unitPrice = unitPrice.multiply(new BigDecimal(\u0026#34;0.9\u0026#34;)); // 9æŠ˜ } return unitPrice.multiply(BigDecimal.valueOf(quantity)); }) .reduce(BigDecimal.ZERO, BigDecimal::add); return total; } @Override protected void processPayment(OrderRequest request, BigDecimal amount) { System.out.println(\u0026#34;è™•ç†æ‰¹ç™¼ä»˜æ¬¾ï¼ˆå¯èƒ½æ˜¯è³’å¸³ï¼‰: \u0026#34; + amount); } @Override protected String confirmOrder(OrderRequest request, BigDecimal totalPrice) { String orderId = \u0026#34;WS-\u0026#34; + System.currentTimeMillis(); System.out.println(\u0026#34;ç¢ºèªæ‰¹ç™¼è¨‚å–®: \u0026#34; + orderId); return orderId; } @Override protected void performPostProcessing(OrderRequest request, String orderId) { System.out.println(\u0026#34;ç”Ÿæˆæ‰¹ç™¼ç™¼ç¥¨\u0026#34;); System.out.println(\u0026#34;å®‰æ’ç‰©æµé…é€\u0026#34;); System.out.println(\u0026#34;æ›´æ–°å®¢æˆ¶ä¿¡ç”¨è¨˜éŒ„\u0026#34;); } @Override protected boolean requiresPayment() { return false; // æ‰¹ç™¼å¯èƒ½å…è¨±è³’å¸³ } @Override protected boolean needsPostProcessing() { return true; // æ‰¹ç™¼éœ€è¦æ›´å¤šå¾ŒçºŒè™•ç† } } 2. è¼”åŠ©é¡åˆ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 /** * è¨‚å–®è«‹æ±‚ */ public class OrderRequest { private String customerId; private String storeId; private String companyId; private List\u0026lt;OrderItem\u0026gt; items; private String shippingAddress; private boolean member; public OrderRequest(List\u0026lt;OrderItem\u0026gt; items) { this.items = items; } // Getters and Setters public String getCustomerId() { return customerId; } public void setCustomerId(String customerId) { this.customerId = customerId; } public String getStoreId() { return storeId; } public void setStoreId(String storeId) { this.storeId = storeId; } public String getCompanyId() { return companyId; } public void setCompanyId(String companyId) { this.companyId = companyId; } public List\u0026lt;OrderItem\u0026gt; getItems() { return items; } public String getShippingAddress() { return shippingAddress; } public void setShippingAddress(String shippingAddress) { this.shippingAddress = shippingAddress; } public boolean isMember() { return member; } public void setMember(boolean member) { this.member = member; } } /** * è¨‚å–®é …ç›® */ public class OrderItem { private String productId; private String productName; private BigDecimal price; private int quantity; public OrderItem(String productId, String productName, BigDecimal price, int quantity) { this.productId = productId; this.productName = productName; this.price = price; this.quantity = quantity; } // Getters public String getProductId() { return productId; } public String getProductName() { return productName; } public BigDecimal getPrice() { return price; } public int getQuantity() { return quantity; } } /** * è¨‚å–®çµæœ */ public class OrderResult { private String orderId; private BigDecimal totalPrice; private String message; private LocalDateTime timestamp; public OrderResult(String orderId, BigDecimal totalPrice, String message) { this.orderId = orderId; this.totalPrice = totalPrice; this.message = message; this.timestamp = LocalDateTime.now(); } // Getters public String getOrderId() { return orderId; } public BigDecimal getTotalPrice() { return totalPrice; } public String getMessage() { return message; } public LocalDateTime getTimestamp() { return timestamp; } @Override public String toString() { return String.format(\u0026#34;OrderResult{orderId=\u0026#39;%s\u0026#39;, totalPrice=%s, message=\u0026#39;%s\u0026#39;}\u0026#34;, orderId, totalPrice, message); } } 3. ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 /** * è¨‚å–®è™•ç†ç³»çµ±ç¤ºç¯„ */ public class OrderProcessingExample { public static void main(String[] args) { // å‰µå»ºæ¸¬è©¦æ•¸æ“š List\u0026lt;OrderItem\u0026gt; items = Arrays.asList( new OrderItem(\u0026#34;P001\u0026#34;, \u0026#34;ç­†è¨˜å‹é›»è…¦\u0026#34;, new BigDecimal(\u0026#34;30000\u0026#34;), 2), new OrderItem(\u0026#34;P002\u0026#34;, \u0026#34;æ»‘é¼ \u0026#34;, new BigDecimal(\u0026#34;500\u0026#34;), 5) ); // æ¸¬è©¦ç·šä¸Šè¨‚å–® System.out.println(\u0026#34;=== ç·šä¸Šè¨‚å–®è™•ç† ===\u0026#34;); testOnlineOrder(items); // æ¸¬è©¦å¯¦é«”åº—è¨‚å–® System.out.println(\u0026#34;\\n=== å¯¦é«”åº—è¨‚å–®è™•ç† ===\u0026#34;); testStoreOrder(items); // æ¸¬è©¦æ‰¹ç™¼è¨‚å–® System.out.println(\u0026#34;\\n=== æ‰¹ç™¼è¨‚å–®è™•ç† ===\u0026#34;); testWholesaleOrder(items); } private static void testOnlineOrder(List\u0026lt;OrderItem\u0026gt; items) { OrderProcessingTemplate processor = new OnlineOrderProcessor(); OrderRequest request = new OrderRequest(items); request.setCustomerId(\u0026#34;CUST-001\u0026#34;); request.setShippingAddress(\u0026#34;å°åŒ—å¸‚ä¿¡ç¾©å€xxxè·¯123è™Ÿ\u0026#34;); OrderResult result = processor.processOrder(request); System.out.println(\u0026#34;ç·šä¸Šè¨‚å–®çµæœ: \u0026#34; + result); } private static void testStoreOrder(List\u0026lt;OrderItem\u0026gt; items) { OrderProcessingTemplate processor = new StoreOrderProcessor(); OrderRequest request = new OrderRequest(items); request.setStoreId(\u0026#34;STORE-001\u0026#34;); request.setMember(true); OrderResult result = processor.processOrder(request); System.out.println(\u0026#34;å¯¦é«”åº—è¨‚å–®çµæœ: \u0026#34; + result); } private static void testWholesaleOrder(List\u0026lt;OrderItem\u0026gt; items) { // æ‰¹ç™¼è¨‚å–®éœ€è¦æ›´å¤§æ•¸é‡ List\u0026lt;OrderItem\u0026gt; wholesaleItems = Arrays.asList( new OrderItem(\u0026#34;P001\u0026#34;, \u0026#34;ç­†è¨˜å‹é›»è…¦\u0026#34;, new BigDecimal(\u0026#34;30000\u0026#34;), 50), new OrderItem(\u0026#34;P002\u0026#34;, \u0026#34;æ»‘é¼ \u0026#34;, new BigDecimal(\u0026#34;500\u0026#34;), 200) ); OrderProcessingTemplate processor = new WholesaleOrderProcessor(); OrderRequest request = new OrderRequest(wholesaleItems); request.setCompanyId(\u0026#34;COMP-001\u0026#34;); OrderResult result = processor.processOrder(request); System.out.println(\u0026#34;æ‰¹ç™¼è¨‚å–®çµæœ: \u0026#34; + result); } } Spring Boot æ•´åˆ 1. Spring Boot é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 /** * æ¨¡æ¿æ–¹æ³•æ¨¡å¼ Spring Boot é…ç½® */ @Configuration @EnableConfigurationProperties(OrderProcessingProperties.class) public class TemplateMethodConfig { @Bean @ConditionalOnProperty(name = \u0026#34;order.processing.type\u0026#34;, havingValue = \u0026#34;online\u0026#34;) public OrderProcessingTemplate onlineOrderProcessor() { return new OnlineOrderProcessor(); } @Bean @ConditionalOnProperty(name = \u0026#34;order.processing.type\u0026#34;, havingValue = \u0026#34;store\u0026#34;) public OrderProcessingTemplate storeOrderProcessor() { return new StoreOrderProcessor(); } @Bean @ConditionalOnProperty(name = \u0026#34;order.processing.type\u0026#34;, havingValue = \u0026#34;wholesale\u0026#34;) public OrderProcessingTemplate wholesaleOrderProcessor() { return new WholesaleOrderProcessor(); } @Bean public OrderProcessingService orderProcessingService( List\u0026lt;OrderProcessingTemplate\u0026gt; processors) { return new OrderProcessingService(processors); } } /** * é…ç½®å±¬æ€§ */ @ConfigurationProperties(prefix = \u0026#34;order.processing\u0026#34;) @Data public class OrderProcessingProperties { private String type = \u0026#34;online\u0026#34;; private boolean enablePostProcessing = true; private Duration timeout = Duration.ofMinutes(5); private int maxRetries = 3; } /** * Spring Boot è¨‚å–®è™•ç†æœå‹™ */ @Service @Transactional public class OrderProcessingService { private final Map\u0026lt;String, OrderProcessingTemplate\u0026gt; processorMap; private final ApplicationEventPublisher eventPublisher; public OrderProcessingService(List\u0026lt;OrderProcessingTemplate\u0026gt; processors, ApplicationEventPublisher eventPublisher) { this.eventPublisher = eventPublisher; this.processorMap = processors.stream() .collect(Collectors.toMap( processor -\u0026gt; determineProcessorType(processor), processor -\u0026gt; processor )); } public OrderResult processOrder(OrderRequest request, String processorType) { OrderProcessingTemplate processor = processorMap.get(processorType); if (processor == null) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„è™•ç†å™¨é¡å‹: \u0026#34; + processorType); } // ç™¼å¸ƒè™•ç†é–‹å§‹äº‹ä»¶ eventPublisher.publishEvent(new OrderProcessingStartedEvent(request)); try { OrderResult result = processor.processOrder(request); // ç™¼å¸ƒè™•ç†å®Œæˆäº‹ä»¶ eventPublisher.publishEvent(new OrderProcessingCompletedEvent(request, result)); return result; } catch (Exception e) { // ç™¼å¸ƒè™•ç†å¤±æ•—äº‹ä»¶ eventPublisher.publishEvent(new OrderProcessingFailedEvent(request, e)); throw e; } } private String determineProcessorType(OrderProcessingTemplate processor) { if (processor instanceof OnlineOrderProcessor) return \u0026#34;online\u0026#34;; if (processor instanceof StoreOrderProcessor) return \u0026#34;store\u0026#34;; if (processor instanceof WholesaleOrderProcessor) return \u0026#34;wholesale\u0026#34;; return \u0026#34;unknown\u0026#34;; } } 2. REST API æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 /** * è¨‚å–®è™•ç† REST API */ @RestController @RequestMapping(\u0026#34;/api/orders\u0026#34;) @Validated public class OrderController { private final OrderProcessingService orderService; public OrderController(OrderProcessingService orderService) { this.orderService = orderService; } @PostMapping(\u0026#34;/process/{type}\u0026#34;) public ResponseEntity\u0026lt;OrderResponse\u0026gt; processOrder( @PathVariable @Pattern(regexp = \u0026#34;online|store|wholesale\u0026#34;) String type, @Valid @RequestBody OrderRequest request) { try { OrderResult result = orderService.processOrder(request, type); return ResponseEntity.ok(OrderResponse.success(result)); } catch (IllegalArgumentException e) { return ResponseEntity.badRequest() .body(OrderResponse.error(e.getMessage())); } catch (Exception e) { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(OrderResponse.error(\u0026#34;è¨‚å–®è™•ç†å¤±æ•—: \u0026#34; + e.getMessage())); } } @GetMapping(\u0026#34;/processors\u0026#34;) public ResponseEntity\u0026lt;List\u0026lt;String\u0026gt;\u0026gt; getAvailableProcessors() { List\u0026lt;String\u0026gt; processors = Arrays.asList(\u0026#34;online\u0026#34;, \u0026#34;store\u0026#34;, \u0026#34;wholesale\u0026#34;); return ResponseEntity.ok(processors); } } /** * API å›æ‡‰å°è£ */ public class OrderResponse { private boolean success; private String message; private OrderResult data; private LocalDateTime timestamp; private OrderResponse(boolean success, String message, OrderResult data) { this.success = success; this.message = message; this.data = data; this.timestamp = LocalDateTime.now(); } public static OrderResponse success(OrderResult result) { return new OrderResponse(true, \u0026#34;è™•ç†æˆåŠŸ\u0026#34;, result); } public static OrderResponse error(String message) { return new OrderResponse(false, message, null); } // Getters public boolean isSuccess() { return success; } public String getMessage() { return message; } public OrderResult getData() { return data; } public LocalDateTime getTimestamp() { return timestamp; } } é€²éšä¸»é¡Œ 1. æ•ˆèƒ½å„ªåŒ–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 /** * é«˜æ•ˆèƒ½æ¨¡æ¿æ–¹æ³•å¯¦ä½œ */ public abstract class OptimizedOrderProcessingTemplate extends OrderProcessingTemplate { private final Cache\u0026lt;String, BigDecimal\u0026gt; priceCache; private final ExecutorService executorService; public OptimizedOrderProcessingTemplate() { this.priceCache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(10, TimeUnit.MINUTES) .build(); this.executorService = Executors.newFixedThreadPool(5); } @Override protected BigDecimal calculatePrice(OrderRequest request) { String cacheKey = generatePriceCacheKey(request); return priceCache.get(cacheKey, key -\u0026gt; { return performActualPriceCalculation(request); }); } // ç•°æ­¥å¾ŒçºŒè™•ç† @Override protected void performPostProcessing(OrderRequest request, String orderId) { CompletableFuture.runAsync(() -\u0026gt; { doAsyncPostProcessing(request, orderId); }, executorService); } protected abstract BigDecimal performActualPriceCalculation(OrderRequest request); protected abstract void doAsyncPostProcessing(OrderRequest request, String orderId); private String generatePriceCacheKey(OrderRequest request) { return request.getItems().stream() .map(item -\u0026gt; item.getProductId() + \u0026#34;:\u0026#34; + item.getQuantity()) .collect(Collectors.joining(\u0026#34;,\u0026#34;)); } } 2. æ¸¬è©¦ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 /** * æ¨¡æ¿æ–¹æ³•æ¨¡å¼å–®å…ƒæ¸¬è©¦ */ @ExtendWith(MockitoExtension.class) class OrderProcessingTemplateTest { @Test void testOnlineOrderProcessing() { // Given OnlineOrderProcessor processor = new OnlineOrderProcessor(); OrderRequest request = createTestOrderRequest(); request.setCustomerId(\u0026#34;CUST-001\u0026#34;); request.setShippingAddress(\u0026#34;Test Address\u0026#34;); // When OrderResult result = processor.processOrder(request); // Then assertThat(result.getOrderId()).startsWith(\u0026#34;ON-\u0026#34;); assertThat(result.getTotalPrice()).isGreaterThan(BigDecimal.ZERO); assertThat(result.getMessage()).contains(\u0026#34;æˆåŠŸ\u0026#34;); } @Test void testTemplateMethodFlow() { // Given OrderProcessingTemplate processor = new TestOrderProcessor(); OrderRequest request = createTestOrderRequest(); // When OrderResult result = processor.processOrder(request); // Then // é©—è­‰æ¨¡æ¿æ–¹æ³•çš„åŸ·è¡Œé †åº verify(processor).validateOrder(request); verify(processor).checkInventory(request); verify(processor).calculatePrice(request); verify(processor).confirmOrder(eq(request), any(BigDecimal.class)); } private OrderRequest createTestOrderRequest() { List\u0026lt;OrderItem\u0026gt; items = Arrays.asList( new OrderItem(\u0026#34;P001\u0026#34;, \u0026#34;Test Product\u0026#34;, new BigDecimal(\u0026#34;100\u0026#34;), 1) ); return new OrderRequest(items); } // æ¸¬è©¦å°ˆç”¨çš„è™•ç†å™¨å¯¦ç¾ private static class TestOrderProcessor extends OrderProcessingTemplate { @Override protected void validateOrder(OrderRequest request) {} @Override protected void checkInventory(OrderRequest request) {} @Override protected BigDecimal calculatePrice(OrderRequest request) { return new BigDecimal(\u0026#34;100\u0026#34;); } @Override protected String confirmOrder(OrderRequest request, BigDecimal totalPrice) { return \u0026#34;TEST-ORDER-123\u0026#34;; } } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. è¨­è¨ˆåŸå‰‡ é–‹é–‰åŸå‰‡ï¼šæ–°å¢è™•ç†å™¨é¡å‹ä¸éœ€ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ é‡Œæ°æ›¿æ›åŸå‰‡ï¼šç¢ºä¿å­é¡èƒ½å®Œå…¨æ›¿æ›çˆ¶é¡ å–®ä¸€è·è²¬åŸå‰‡ï¼šæ¯å€‹è™•ç†å™¨è² è²¬ç‰¹å®šé¡å‹çš„è¨‚å–®è™•ç† 2. å¸¸è¦‹é™·é˜± é¿å…åœ¨æ¨¡æ¿æ–¹æ³•ä¸­æ‹‹å‡ºç•°å¸¸ 1 2 3 4 5 6 7 8 9 10 // âœ… å¥½çš„è¨­è¨ˆ - çµ±ä¸€ç•°å¸¸è™•ç† public final OrderResult processOrder(OrderRequest request) { try { // æ¨¡æ¿æ–¹æ³•é‚è¼¯ return createSuccessResult(); } catch (Exception e) { handleError(request, e); return createErrorResult(e); } } é©ç•¶ä½¿ç”¨ final ä¿®é£¾ç¬¦ 1 2 3 4 // âœ… æ¨¡æ¿æ–¹æ³•æ‡‰è©²æ˜¯ final public final OrderResult processOrder(OrderRequest request) { // ç®—æ³•éª¨æ¶ä¸å¯è®Š } 3. ä½¿ç”¨å»ºè­° é©ç”¨å ´æ™¯ï¼šæ¥­å‹™æµç¨‹å›ºå®šï¼Œä½†å¯¦ç¾ç´°ç¯€ä¸åŒ è¨­è¨ˆè¦é»ï¼šæ˜ç¢ºå€åˆ†è®ŠåŒ–å’Œä¸è®Šçš„éƒ¨åˆ† èˆ‡å…¶ä»–æ¨¡å¼çµåˆï¼šå¯èˆ‡ç­–ç•¥æ¨¡å¼ã€å·¥å» æ¨¡å¼çµ„åˆä½¿ç”¨ ç¸½çµ æ¨¡æ¿æ–¹æ³•æ¨¡å¼é€šéå°‡ç®—æ³•éª¨æ¶å›ºå®šåœ¨çˆ¶é¡ä¸­ï¼Œè®“å­é¡å¯¦ç¾ç‰¹å®šçš„è®ŠåŒ–éƒ¨åˆ†ï¼Œå¯¦ç¾äº†ä»£ç¢¼é‡ç”¨å’Œæµç¨‹æ§åˆ¶çš„çµ±ä¸€ã€‚åœ¨ä¼æ¥­ç´šæ‡‰ç”¨ä¸­ï¼Œé€™å€‹æ¨¡å¼ç‰¹åˆ¥é©åˆå·¥ä½œæµç¨‹ã€æ•¸æ“šè™•ç†ç®¡é“ã€æ¥­å‹™æµç¨‹æ§åˆ¶ç­‰å ´æ™¯ã€‚\nä¸»è¦å„ªé» ä»£ç¢¼é‡ç”¨ï¼šæå–å…¬å…±é‚è¼¯åˆ°çˆ¶é¡ æµç¨‹æ§åˆ¶ï¼šç¢ºä¿ç®—æ³•åŸ·è¡Œé †åº æ“´å±•æ€§å¼·ï¼šæ˜“æ–¼å¢åŠ æ–°çš„ç®—æ³•è®Šé«” ä¸»è¦ç¼ºé» ç¹¼æ‰¿é™åˆ¶ï¼šéœ€è¦ä½¿ç”¨ç¹¼æ‰¿é—œä¿‚ èª¿è©¦å›°é›£ï¼šçˆ¶é¡èª¿ç”¨å­é¡æ–¹æ³•çš„æµç¨‹ä¸ç›´è§€ æ­£ç¢ºä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¯ä»¥å¤§å¹…æå‡ä»£ç¢¼çš„å¯ç¶­è­·æ€§å’Œå¯æ“´å±•æ€§ï¼Œæ˜¯ä¼æ¥­ç´šæ‡‰ç”¨é–‹ç™¼ä¸­çš„é‡è¦è¨­è¨ˆæ¨¡å¼ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/templatemethod/","tags":["Design Pattern","Template Method Pattern","Behavioral Pattern","Algorithm Framework","Inheritance","Hook Methods","Process Control","Java","Spring Boot","Enterprise Architecture","Workflow","Business Process","Code Reuse","Hollywood Principle","Abstract Methods","Final Methods","Best Practices"],"title":"æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern) å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šç®—æ³•éª¨æ¶è¨­è¨ˆèˆ‡ä¼æ¥­ç´šæµç¨‹æ§åˆ¶æœ€ä½³å¯¦è¸"},{"content":"Decorator Pattern æ¦‚è¿° Decorator Pattern æ˜¯ä¸€ç¨®çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œå®ƒå…è¨±åœ¨é‹è¡Œæ™‚å‹•æ…‹åœ°ç‚ºå°è±¡æ·»åŠ æ–°åŠŸèƒ½ï¼Œè€Œç„¡éœ€ä¿®æ”¹å…¶åŸå§‹é¡ã€‚é€šéå‰µå»ºåŒ…è£å™¨å°è±¡ï¼ŒDecorator æä¾›äº†ä¸€ç¨®éˆæ´»çš„æ›¿ä»£ç¹¼æ‰¿çš„æ–¹æ³•ä¾†æ“´å±•å°è±¡çš„è¡Œç‚ºã€‚\næ ¸å¿ƒæ¦‚å¿µ é—œéµç‰¹æ€§ å‹•æ…‹æ“´å±•: åœ¨é‹è¡Œæ™‚æ·»åŠ æˆ–ç§»é™¤åŠŸèƒ½ é€æ˜æ€§: è£é£¾å™¨èˆ‡åŸå§‹å°è±¡å…·æœ‰ç›¸åŒçš„æ¥å£ çµ„åˆå„ªæ–¼ç¹¼æ‰¿: é¿å…è¤‡é›œçš„ç¹¼æ‰¿å±¤æ¬¡çµæ§‹ è²¬ä»»éˆ: å¯ä»¥å †ç–Šå¤šå€‹è£é£¾å™¨ çµæ§‹çµ„ä»¶ Component: å®šç¾©åŸå§‹å°è±¡å’Œè£é£¾å™¨çš„é€šç”¨æ¥å£ ConcreteComponent: å…·é«”çš„åŸå§‹å°è±¡ BaseDecorator: æŠ½è±¡è£é£¾å™¨åŸºé¡ ConcreteDecorator: å…·é«”çš„è£é£¾å™¨å¯¦ç¾ åŸºæœ¬å¯¦ç¾ 1. ç¶“å…¸ Decorator å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 // çµ„ä»¶æ¥å£ public interface Coffee { String getDescription(); double getCost(); } // å…·é«”çµ„ä»¶ public class SimpleCoffee implements Coffee { @Override public String getDescription() { return \u0026#34;Simple Coffee\u0026#34;; } @Override public double getCost() { return 2.0; } } // æŠ½è±¡è£é£¾å™¨ public abstract class CoffeeDecorator implements Coffee { protected Coffee coffee; public CoffeeDecorator(Coffee coffee) { this.coffee = coffee; } @Override public String getDescription() { return coffee.getDescription(); } @Override public double getCost() { return coffee.getCost(); } } // å…·é«”è£é£¾å™¨ public class MilkDecorator extends CoffeeDecorator { public MilkDecorator(Coffee coffee) { super(coffee); } @Override public String getDescription() { return coffee.getDescription() + \u0026#34; + Milk\u0026#34;; } @Override public double getCost() { return coffee.getCost() + 0.5; } } public class SugarDecorator extends CoffeeDecorator { public SugarDecorator(Coffee coffee) { super(coffee); } @Override public String getDescription() { return coffee.getDescription() + \u0026#34; + Sugar\u0026#34;; } @Override public double getCost() { return coffee.getCost() + 0.3; } } public class WhippedCreamDecorator extends CoffeeDecorator { public WhippedCreamDecorator(Coffee coffee) { super(coffee); } @Override public String getDescription() { return coffee.getDescription() + \u0026#34; + Whipped Cream\u0026#34;; } @Override public double getCost() { return coffee.getCost() + 0.8; } } 2. æ¸¬è©¦ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public class DecoratorPatternDemo { public static void main(String[] args) { // åŸºæœ¬å’–å•¡ Coffee coffee = new SimpleCoffee(); System.out.println(coffee.getDescription() + \u0026#34; - $\u0026#34; + coffee.getCost()); // æ·»åŠ ç‰›å¥¶ coffee = new MilkDecorator(coffee); System.out.println(coffee.getDescription() + \u0026#34; - $\u0026#34; + coffee.getCost()); // æ·»åŠ ç³– coffee = new SugarDecorator(coffee); System.out.println(coffee.getDescription() + \u0026#34; - $\u0026#34; + coffee.getCost()); // æ·»åŠ é®®å¥¶æ²¹ coffee = new WhippedCreamDecorator(coffee); System.out.println(coffee.getDescription() + \u0026#34; - $\u0026#34; + coffee.getCost()); // è¼¸å‡º: // Simple Coffee - $2.0 // Simple Coffee + Milk - $2.5 // Simple Coffee + Milk + Sugar - $2.8 // Simple Coffee + Milk + Sugar + Whipped Cream - $3.6 } } ç¾ä»£ Java å¯¦ç¾ 1. ä½¿ç”¨ Java 8+ åŠŸèƒ½å¼æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 // ä½¿ç”¨å‡½æ•¸å¼æ¥å£ @FunctionalInterface public interface DataProcessor { String process(String data); } // åŸºæœ¬è™•ç†å™¨ public class BaseProcessor implements DataProcessor { @Override public String process(String data) { return data; } } // å‡½æ•¸å¼è£é£¾å™¨ public class FunctionalDecorator { public static DataProcessor withLogging(DataProcessor processor) { return data -\u0026gt; { System.out.println(\u0026#34;Processing: \u0026#34; + data); String result = processor.process(data); System.out.println(\u0026#34;Result: \u0026#34; + result); return result; }; } public static DataProcessor withUpperCase(DataProcessor processor) { return data -\u0026gt; processor.process(data).toUpperCase(); } public static DataProcessor withTrimming(DataProcessor processor) { return data -\u0026gt; processor.process(data.trim()); } public static DataProcessor withTimestamp(DataProcessor processor) { return data -\u0026gt; { String timestamp = LocalDateTime.now().toString(); return \u0026#34;[\u0026#34; + timestamp + \u0026#34;] \u0026#34; + processor.process(data); }; } } // ä½¿ç”¨ç¤ºä¾‹ public class FunctionalDecoratorDemo { public static void main(String[] args) { DataProcessor processor = new BaseProcessor(); // çµ„åˆå¤šå€‹è£é£¾å™¨ DataProcessor decoratedProcessor = FunctionalDecorator.withLogging( FunctionalDecorator.withTimestamp( FunctionalDecorator.withUpperCase( FunctionalDecorator.withTrimming(processor) ) ) ); String result = decoratedProcessor.process(\u0026#34; hello world \u0026#34;); System.out.println(\u0026#34;Final result: \u0026#34; + result); } } 2. ä½¿ç”¨ Builder æ¨¡å¼çš„è£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 public class DecoratorBuilder\u0026lt;T\u0026gt; { private T component; private List\u0026lt;Function\u0026lt;T, T\u0026gt;\u0026gt; decorators = new ArrayList\u0026lt;\u0026gt;(); public DecoratorBuilder(T component) { this.component = component; } public DecoratorBuilder\u0026lt;T\u0026gt; addDecorator(Function\u0026lt;T, T\u0026gt; decorator) { decorators.add(decorator); return this; } public T build() { return decorators.stream() .reduce(Function.identity(), Function::compose) .apply(component); } } // ä½¿ç”¨ç¤ºä¾‹ public class BuilderDecoratorDemo { public static void main(String[] args) { DataProcessor processor = new DecoratorBuilder\u0026lt;\u0026gt;(new BaseProcessor()) .addDecorator(FunctionalDecorator::withTrimming) .addDecorator(FunctionalDecorator::withUpperCase) .addDecorator(FunctionalDecorator::withTimestamp) .addDecorator(FunctionalDecorator::withLogging) .build(); String result = processor.process(\u0026#34; hello world \u0026#34;); } } ä¼æ¥­ç´šæ‡‰ç”¨æ¨¡å¼ 1. æ—¥èªŒè£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 // æ—¥èªŒè£é£¾å™¨ public class LoggingDecorator\u0026lt;T\u0026gt; { private final T target; private final Logger logger; public LoggingDecorator(T target, Logger logger) { this.target = target; this.logger = logger; } public T getTarget() { return target; } // é€šéåå°„å‰µå»ºä»£ç† @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public static \u0026lt;T\u0026gt; T createProxy(T target, Logger logger) { return (T) Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new LoggingInvocationHandler\u0026lt;\u0026gt;(target, logger) ); } private static class LoggingInvocationHandler\u0026lt;T\u0026gt; implements InvocationHandler { private final T target; private final Logger logger; public LoggingInvocationHandler(T target, Logger logger) { this.target = target; this.logger = logger; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { String methodName = method.getName(); logger.info(\u0026#34;Calling method: {} with args: {}\u0026#34;, methodName, Arrays.toString(args)); long startTime = System.currentTimeMillis(); try { Object result = method.invoke(target, args); long endTime = System.currentTimeMillis(); logger.info(\u0026#34;Method {} completed in {} ms with result: {}\u0026#34;, methodName, endTime - startTime, result); return result; } catch (Exception e) { logger.error(\u0026#34;Method {} threw exception: {}\u0026#34;, methodName, e.getMessage()); throw e; } } } } // æ¥­å‹™æœå‹™æ¥å£ public interface UserService { User findById(Long id); User save(User user); void deleteById(Long id); } // å…·é«”æœå‹™å¯¦ç¾ @Service public class UserServiceImpl implements UserService { @Autowired private UserRepository userRepository; @Override public User findById(Long id) { return userRepository.findById(id).orElse(null); } @Override public User save(User user) { return userRepository.save(user); } @Override public void deleteById(Long id) { userRepository.deleteById(id); } } // ä½¿ç”¨ç¤ºä¾‹ @Configuration public class ServiceConfiguration { @Bean public UserService userService(UserServiceImpl userServiceImpl) { Logger logger = LoggerFactory.getLogger(UserService.class); return LoggingDecorator.createProxy(userServiceImpl, logger); } } 2. ç·©å­˜è£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 // ç·©å­˜è£é£¾å™¨ public class CacheDecorator\u0026lt;T\u0026gt; { private final T target; private final Cache cache; private final Set\u0026lt;String\u0026gt; cacheableMethods; public CacheDecorator(T target, Cache cache, Set\u0026lt;String\u0026gt; cacheableMethods) { this.target = target; this.cache = cache; this.cacheableMethods = cacheableMethods; } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public static \u0026lt;T\u0026gt; T createProxy(T target, Cache cache, Set\u0026lt;String\u0026gt; cacheableMethods) { return (T) Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new CacheInvocationHandler\u0026lt;\u0026gt;(target, cache, cacheableMethods) ); } private static class CacheInvocationHandler\u0026lt;T\u0026gt; implements InvocationHandler { private final T target; private final Cache cache; private final Set\u0026lt;String\u0026gt; cacheableMethods; public CacheInvocationHandler(T target, Cache cache, Set\u0026lt;String\u0026gt; cacheableMethods) { this.target = target; this.cache = cache; this.cacheableMethods = cacheableMethods; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { String methodName = method.getName(); if (cacheableMethods.contains(methodName)) { String cacheKey = generateCacheKey(methodName, args); // å˜—è©¦å¾ç·©å­˜ç²å– Object cachedResult = cache.get(cacheKey); if (cachedResult != null) { return cachedResult; } // èª¿ç”¨åŸå§‹æ–¹æ³• Object result = method.invoke(target, args); // æ”¾å…¥ç·©å­˜ cache.put(cacheKey, result); return result; } return method.invoke(target, args); } private String generateCacheKey(String methodName, Object[] args) { return methodName + \u0026#34;:\u0026#34; + Arrays.toString(args); } } } // ç°¡å–®ç·©å­˜å¯¦ç¾ public class SimpleCache implements Cache { private final Map\u0026lt;String, Object\u0026gt; cache = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Override public Object get(String key) { return cache.get(key); } @Override public void put(String key, Object value) { cache.put(key, value); } @Override public void evict(String key) { cache.remove(key); } @Override public void clear() { cache.clear(); } } // ä½¿ç”¨ç¤ºä¾‹ @Configuration public class CacheConfiguration { @Bean public Cache userCache() { return new SimpleCache(); } @Bean public UserService cachedUserService(UserServiceImpl userServiceImpl, Cache userCache) { Set\u0026lt;String\u0026gt; cacheableMethods = Set.of(\u0026#34;findById\u0026#34;, \u0026#34;findByUsername\u0026#34;); return CacheDecorator.createProxy(userServiceImpl, userCache, cacheableMethods); } } 3. å®‰å…¨è£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 // å®‰å…¨è£é£¾å™¨ public class SecurityDecorator\u0026lt;T\u0026gt; { private final T target; private final SecurityContext securityContext; private final Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; methodPermissions; public SecurityDecorator(T target, SecurityContext securityContext, Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; methodPermissions) { this.target = target; this.securityContext = securityContext; this.methodPermissions = methodPermissions; } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public static \u0026lt;T\u0026gt; T createProxy(T target, SecurityContext securityContext, Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; methodPermissions) { return (T) Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new SecurityInvocationHandler\u0026lt;\u0026gt;(target, securityContext, methodPermissions) ); } private static class SecurityInvocationHandler\u0026lt;T\u0026gt; implements InvocationHandler { private final T target; private final SecurityContext securityContext; private final Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; methodPermissions; public SecurityInvocationHandler(T target, SecurityContext securityContext, Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; methodPermissions) { this.target = target; this.securityContext = securityContext; this.methodPermissions = methodPermissions; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { String methodName = method.getName(); // æª¢æŸ¥æ–¹æ³•æ¬Šé™ if (methodPermissions.containsKey(methodName)) { Set\u0026lt;String\u0026gt; requiredPermissions = methodPermissions.get(methodName); if (!securityContext.hasPermissions(requiredPermissions)) { throw new SecurityException(\u0026#34;Access denied: insufficient permissions for method \u0026#34; + methodName); } } return method.invoke(target, args); } } } // å®‰å…¨ä¸Šä¸‹æ–‡ public class SecurityContext { private final Set\u0026lt;String\u0026gt; userPermissions; public SecurityContext(Set\u0026lt;String\u0026gt; userPermissions) { this.userPermissions = userPermissions; } public boolean hasPermission(String permission) { return userPermissions.contains(permission); } public boolean hasPermissions(Set\u0026lt;String\u0026gt; permissions) { return userPermissions.containsAll(permissions); } } // ä½¿ç”¨ç¤ºä¾‹ @Configuration public class SecurityConfiguration { @Bean public UserService securedUserService(UserServiceImpl userServiceImpl, SecurityContext securityContext) { Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; methodPermissions = Map.of( \u0026#34;save\u0026#34;, Set.of(\u0026#34;USER_WRITE\u0026#34;), \u0026#34;deleteById\u0026#34;, Set.of(\u0026#34;USER_DELETE\u0026#34;), \u0026#34;findById\u0026#34;, Set.of(\u0026#34;USER_READ\u0026#34;) ); return SecurityDecorator.createProxy(userServiceImpl, securityContext, methodPermissions); } } Spring AOP é›†æˆ 1. åŸºæ–¼è¨»è§£çš„ AOP è£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 // è‡ªå®šç¾©è¨»è§£ @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) public @interface Loggable { String value() default \u0026#34;\u0026#34;; boolean logParameters() default true; boolean logResult() default true; boolean logExecutionTime() default true; } @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) public @interface Cacheable { String value() default \u0026#34;\u0026#34;; int ttl() default 300; // seconds String keyGenerator() default \u0026#34;\u0026#34;; } @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) public @interface Secured { String[] permissions() default {}; String role() default \u0026#34;\u0026#34;; } // AOP åˆ‡é¢ @Aspect @Component public class LoggingAspect { private static final Logger logger = LoggerFactory.getLogger(LoggingAspect.class); @Around(\u0026#34;@annotation(loggable)\u0026#34;) public Object logExecutionTime(ProceedingJoinPoint joinPoint, Loggable loggable) throws Throwable { String methodName = joinPoint.getSignature().getName(); if (loggable.logParameters()) { logger.info(\u0026#34;Entering method: {} with parameters: {}\u0026#34;, methodName, Arrays.toString(joinPoint.getArgs())); } long startTime = System.currentTimeMillis(); try { Object result = joinPoint.proceed(); long endTime = System.currentTimeMillis(); if (loggable.logExecutionTime()) { logger.info(\u0026#34;Method {} executed in {} ms\u0026#34;, methodName, endTime - startTime); } if (loggable.logResult()) { logger.info(\u0026#34;Method {} returned: {}\u0026#34;, methodName, result); } return result; } catch (Exception e) { logger.error(\u0026#34;Method {} threw exception: {}\u0026#34;, methodName, e.getMessage()); throw e; } } } @Aspect @Component public class CacheAspect { @Autowired private CacheManager cacheManager; @Around(\u0026#34;@annotation(cacheable)\u0026#34;) public Object cacheResult(ProceedingJoinPoint joinPoint, Cacheable cacheable) throws Throwable { String cacheName = cacheable.value().isEmpty() ? joinPoint.getSignature().getDeclaringType().getSimpleName() : cacheable.value(); Cache cache = cacheManager.getCache(cacheName); if (cache == null) { return joinPoint.proceed(); } String key = generateKey(joinPoint); Cache.ValueWrapper cachedValue = cache.get(key); if (cachedValue != null) { return cachedValue.get(); } Object result = joinPoint.proceed(); cache.put(key, result); return result; } private String generateKey(ProceedingJoinPoint joinPoint) { StringBuilder keyBuilder = new StringBuilder(); keyBuilder.append(joinPoint.getSignature().getName()); for (Object arg : joinPoint.getArgs()) { keyBuilder.append(\u0026#34;:\u0026#34;).append(arg); } return keyBuilder.toString(); } } @Aspect @Component public class SecurityAspect { @Autowired private SecurityContext securityContext; @Before(\u0026#34;@annotation(secured)\u0026#34;) public void checkSecurity(JoinPoint joinPoint, Secured secured) { String[] requiredPermissions = secured.permissions(); String requiredRole = secured.role(); if (requiredPermissions.length \u0026gt; 0) { if (!securityContext.hasPermissions(Set.of(requiredPermissions))) { throw new SecurityException(\u0026#34;Access denied: insufficient permissions\u0026#34;); } } if (!requiredRole.isEmpty()) { if (!securityContext.hasRole(requiredRole)) { throw new SecurityException(\u0026#34;Access denied: insufficient role\u0026#34;); } } } } 2. ä½¿ç”¨ AOP è¨»è§£çš„æœå‹™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Service public class EnhancedUserService implements UserService { @Autowired private UserRepository userRepository; @Override @Loggable(logParameters = true, logResult = true, logExecutionTime = true) @Cacheable(value = \u0026#34;users\u0026#34;, ttl = 600) @Secured(permissions = {\u0026#34;USER_READ\u0026#34;}) public User findById(Long id) { return userRepository.findById(id).orElse(null); } @Override @Loggable(logParameters = true, logResult = false) @Secured(permissions = {\u0026#34;USER_WRITE\u0026#34;}) public User save(User user) { return userRepository.save(user); } @Override @Loggable(logParameters = true) @Secured(permissions = {\u0026#34;USER_DELETE\u0026#34;}) public void deleteById(Long id) { userRepository.deleteById(id); } @Loggable @Cacheable(value = \u0026#34;users\u0026#34;, ttl = 300) @Secured(permissions = {\u0026#34;USER_READ\u0026#34;}) public List\u0026lt;User\u0026gt; findByRole(String role) { return userRepository.findByRole(role); } } 3. Spring Boot è‡ªå‹•é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 @Configuration @EnableAspectJAutoProxy public class AopConfiguration { @Bean public CacheManager cacheManager() { return new ConcurrentMapCacheManager(\u0026#34;users\u0026#34;, \u0026#34;roles\u0026#34;, \u0026#34;permissions\u0026#34;); } @Bean public SecurityContext securityContext() { // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™æœƒå¾ Spring Security ç²å– Set\u0026lt;String\u0026gt; permissions = Set.of(\u0026#34;USER_READ\u0026#34;, \u0026#34;USER_WRITE\u0026#34;, \u0026#34;USER_DELETE\u0026#34;); return new SecurityContext(permissions); } } // è‡ªå‹•é…ç½®é¡ @Configuration @ConditionalOnClass(ProceedingJoinPoint.class) @EnableConfigurationProperties(DecoratorProperties.class) public class DecoratorAutoConfiguration { @Bean @ConditionalOnMissingBean public LoggingAspect loggingAspect() { return new LoggingAspect(); } @Bean @ConditionalOnMissingBean public CacheAspect cacheAspect() { return new CacheAspect(); } @Bean @ConditionalOnMissingBean public SecurityAspect securityAspect() { return new SecurityAspect(); } } // é…ç½®å±¬æ€§ @ConfigurationProperties(prefix = \u0026#34;app.decorator\u0026#34;) public class DecoratorProperties { private boolean loggingEnabled = true; private boolean cachingEnabled = true; private boolean securityEnabled = true; private LoggingProperties logging = new LoggingProperties(); private CachingProperties caching = new CachingProperties(); // Getters and setters public static class LoggingProperties { private boolean logParameters = true; private boolean logResult = true; private boolean logExecutionTime = true; // Getters and setters } public static class CachingProperties { private int defaultTtl = 300; private String[] cacheNames = {\u0026#34;default\u0026#34;}; // Getters and setters } } å¯¦éš›æ‡‰ç”¨å ´æ™¯ 1. HTTP å®¢æˆ¶ç«¯è£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 // HTTP å®¢æˆ¶ç«¯æ¥å£ public interface HttpClient { HttpResponse get(String url); HttpResponse post(String url, String body); HttpResponse put(String url, String body); HttpResponse delete(String url); } // åŸºæœ¬å¯¦ç¾ public class BasicHttpClient implements HttpClient { @Override public HttpResponse get(String url) { // åŸºæœ¬ HTTP GET å¯¦ç¾ return new HttpResponse(200, \u0026#34;GET response from \u0026#34; + url); } @Override public HttpResponse post(String url, String body) { // åŸºæœ¬ HTTP POST å¯¦ç¾ return new HttpResponse(201, \u0026#34;POST response from \u0026#34; + url); } @Override public HttpResponse put(String url, String body) { // åŸºæœ¬ HTTP PUT å¯¦ç¾ return new HttpResponse(200, \u0026#34;PUT response from \u0026#34; + url); } @Override public HttpResponse delete(String url) { // åŸºæœ¬ HTTP DELETE å¯¦ç¾ return new HttpResponse(204, \u0026#34;DELETE response from \u0026#34; + url); } } // é‡è©¦è£é£¾å™¨ public class RetryHttpClient implements HttpClient { private final HttpClient httpClient; private final int maxRetries; private final long retryDelay; public RetryHttpClient(HttpClient httpClient, int maxRetries, long retryDelay) { this.httpClient = httpClient; this.maxRetries = maxRetries; this.retryDelay = retryDelay; } @Override public HttpResponse get(String url) { return executeWithRetry(() -\u0026gt; httpClient.get(url)); } @Override public HttpResponse post(String url, String body) { return executeWithRetry(() -\u0026gt; httpClient.post(url, body)); } @Override public HttpResponse put(String url, String body) { return executeWithRetry(() -\u0026gt; httpClient.put(url, body)); } @Override public HttpResponse delete(String url) { return executeWithRetry(() -\u0026gt; httpClient.delete(url)); } private HttpResponse executeWithRetry(Supplier\u0026lt;HttpResponse\u0026gt; operation) { for (int attempt = 0; attempt \u0026lt; maxRetries; attempt++) { try { HttpResponse response = operation.get(); if (response.isSuccess()) { return response; } if (attempt \u0026lt; maxRetries - 1) { Thread.sleep(retryDelay); } } catch (Exception e) { if (attempt == maxRetries - 1) { throw new RuntimeException(\u0026#34;Max retries exceeded\u0026#34;, e); } try { Thread.sleep(retryDelay); } catch (InterruptedException ie) { Thread.currentThread().interrupt(); throw new RuntimeException(\u0026#34;Interrupted during retry\u0026#34;, ie); } } } throw new RuntimeException(\u0026#34;Max retries exceeded\u0026#34;); } } // é™æµè£é£¾å™¨ public class RateLimitedHttpClient implements HttpClient { private final HttpClient httpClient; private final RateLimiter rateLimiter; public RateLimitedHttpClient(HttpClient httpClient, int requestsPerSecond) { this.httpClient = httpClient; this.rateLimiter = RateLimiter.create(requestsPerSecond); } @Override public HttpResponse get(String url) { rateLimiter.acquire(); return httpClient.get(url); } @Override public HttpResponse post(String url, String body) { rateLimiter.acquire(); return httpClient.post(url, body); } @Override public HttpResponse put(String url, String body) { rateLimiter.acquire(); return httpClient.put(url, body); } @Override public HttpResponse delete(String url) { rateLimiter.acquire(); return httpClient.delete(url); } } // ä½¿ç”¨ç¤ºä¾‹ @Service public class HttpClientService { @Bean public HttpClient httpClient() { HttpClient basicClient = new BasicHttpClient(); // æ·»åŠ é‡è©¦åŠŸèƒ½ HttpClient retryClient = new RetryHttpClient(basicClient, 3, 1000); // æ·»åŠ é™æµåŠŸèƒ½ HttpClient rateLimitedClient = new RateLimitedHttpClient(retryClient, 10); // æ·»åŠ æ—¥èªŒåŠŸèƒ½ return LoggingDecorator.createProxy(rateLimitedClient, LoggerFactory.getLogger(HttpClient.class)); } } 2. æ•¸æ“šåº«é€£æ¥è£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 // æ•¸æ“šåº«é€£æ¥æ¥å£ public interface DatabaseConnection { ResultSet executeQuery(String sql); int executeUpdate(String sql); void close(); } // åŸºæœ¬å¯¦ç¾ public class BasicDatabaseConnection implements DatabaseConnection { private final Connection connection; public BasicDatabaseConnection(Connection connection) { this.connection = connection; } @Override public ResultSet executeQuery(String sql) { try { return connection.createStatement().executeQuery(sql); } catch (SQLException e) { throw new RuntimeException(\u0026#34;Query execution failed\u0026#34;, e); } } @Override public int executeUpdate(String sql) { try { return connection.createStatement().executeUpdate(sql); } catch (SQLException e) { throw new RuntimeException(\u0026#34;Update execution failed\u0026#34;, e); } } @Override public void close() { try { connection.close(); } catch (SQLException e) { throw new RuntimeException(\u0026#34;Connection close failed\u0026#34;, e); } } } // äº‹å‹™è£é£¾å™¨ public class TransactionalDatabaseConnection implements DatabaseConnection { private final DatabaseConnection connection; private boolean inTransaction = false; public TransactionalDatabaseConnection(DatabaseConnection connection) { this.connection = connection; } public void beginTransaction() { inTransaction = true; } public void commit() { inTransaction = false; } public void rollback() { inTransaction = false; } @Override public ResultSet executeQuery(String sql) { return connection.executeQuery(sql); } @Override public int executeUpdate(String sql) { return connection.executeUpdate(sql); } @Override public void close() { if (inTransaction) { rollback(); } connection.close(); } } // é€£æ¥æ± è£é£¾å™¨ public class PooledDatabaseConnection implements DatabaseConnection { private final DatabaseConnection connection; private final ConnectionPool pool; public PooledDatabaseConnection(DatabaseConnection connection, ConnectionPool pool) { this.connection = connection; this.pool = pool; } @Override public ResultSet executeQuery(String sql) { return connection.executeQuery(sql); } @Override public int executeUpdate(String sql) { return connection.executeUpdate(sql); } @Override public void close() { pool.returnConnection(connection); } } æ€§èƒ½å„ªåŒ–å’Œæœ€ä½³å¯¦è¸ 1. æ€§èƒ½ç›£æ§è£é£¾å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 // æ€§èƒ½ç›£æ§è£é£¾å™¨ public class PerformanceMonitoringDecorator\u0026lt;T\u0026gt; { private final T target; private final MeterRegistry meterRegistry; private final String serviceName; public PerformanceMonitoringDecorator(T target, MeterRegistry meterRegistry, String serviceName) { this.target = target; this.meterRegistry = meterRegistry; this.serviceName = serviceName; } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public static \u0026lt;T\u0026gt; T createProxy(T target, MeterRegistry meterRegistry, String serviceName) { return (T) Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new PerformanceInvocationHandler\u0026lt;\u0026gt;(target, meterRegistry, serviceName) ); } private static class PerformanceInvocationHandler\u0026lt;T\u0026gt; implements InvocationHandler { private final T target; private final MeterRegistry meterRegistry; private final String serviceName; public PerformanceInvocationHandler(T target, MeterRegistry meterRegistry, String serviceName) { this.target = target; this.meterRegistry = meterRegistry; this.serviceName = serviceName; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { String methodName = method.getName(); Timer.Sample sample = Timer.start(meterRegistry); try { Object result = method.invoke(target, args); // è¨˜éŒ„æˆåŠŸæŒ‡æ¨™ Counter.builder(\u0026#34;method.calls\u0026#34;) .tag(\u0026#34;service\u0026#34;, serviceName) .tag(\u0026#34;method\u0026#34;, methodName) .tag(\u0026#34;status\u0026#34;, \u0026#34;success\u0026#34;) .register(meterRegistry) .increment(); return result; } catch (Exception e) { // è¨˜éŒ„å¤±æ•—æŒ‡æ¨™ Counter.builder(\u0026#34;method.calls\u0026#34;) .tag(\u0026#34;service\u0026#34;, serviceName) .tag(\u0026#34;method\u0026#34;, methodName) .tag(\u0026#34;status\u0026#34;, \u0026#34;error\u0026#34;) .register(meterRegistry) .increment(); throw e; } finally { // è¨˜éŒ„åŸ·è¡Œæ™‚é–“ sample.stop(Timer.builder(\u0026#34;method.execution.time\u0026#34;) .tag(\u0026#34;service\u0026#34;, serviceName) .tag(\u0026#34;method\u0026#34;, methodName) .register(meterRegistry)); } } } } 2. æ‰¹é‡æ“ä½œå„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // æ‰¹é‡æ“ä½œè£é£¾å™¨ public class BatchingDecorator\u0026lt;T\u0026gt; { private final T target; private final int batchSize; private final Map\u0026lt;String, List\u0026lt;Object[]\u0026gt;\u0026gt; batchQueue = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final ScheduledExecutorService scheduler; public BatchingDecorator(T target, int batchSize, long flushInterval) { this.target = target; this.batchSize = batchSize; this.scheduler = Executors.newScheduledThreadPool(1); // å®šæœŸåˆ·æ–°æ‰¹é‡æ“ä½œ scheduler.scheduleAtFixedRate(this::flushBatches, flushInterval, flushInterval, TimeUnit.MILLISECONDS); } private void flushBatches() { for (Map.Entry\u0026lt;String, List\u0026lt;Object[]\u0026gt;\u0026gt; entry : batchQueue.entrySet()) { String methodName = entry.getKey(); List\u0026lt;Object[]\u0026gt; batch = entry.getValue(); if (!batch.isEmpty()) { processBatch(methodName, batch); batch.clear(); } } } private void processBatch(String methodName, List\u0026lt;Object[]\u0026gt; batch) { try { Method method = target.getClass().getMethod(\u0026#34;batch\u0026#34; + methodName, List.class); method.invoke(target, batch); } catch (Exception e) { // è™•ç†æ‰¹é‡æ“ä½œå¤±æ•— } } public void addToBatch(String methodName, Object[] args) { batchQueue.computeIfAbsent(methodName, k -\u0026gt; new CopyOnWriteArrayList\u0026lt;\u0026gt;()).add(args); List\u0026lt;Object[]\u0026gt; batch = batchQueue.get(methodName); if (batch.size() \u0026gt;= batchSize) { processBatch(methodName, batch); batch.clear(); } } } æ¸¬è©¦ç­–ç•¥ 1. è£é£¾å™¨æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 @ExtendWith(MockitoExtension.class) class DecoratorPatternTest { @Mock private UserService mockUserService; @Mock private Logger mockLogger; @Test void testLoggingDecorator() { User user = new User(1L, \u0026#34;testUser\u0026#34;); when(mockUserService.findById(1L)).thenReturn(user); UserService loggingService = LoggingDecorator.createProxy(mockUserService, mockLogger); User result = loggingService.findById(1L); assertEquals(user, result); verify(mockUserService).findById(1L); // é©—è­‰æ—¥èªŒè¨˜éŒ„ } @Test void testCacheDecorator() { Cache cache = new SimpleCache(); Set\u0026lt;String\u0026gt; cacheableMethods = Set.of(\u0026#34;findById\u0026#34;); User user = new User(1L, \u0026#34;testUser\u0026#34;); when(mockUserService.findById(1L)).thenReturn(user); UserService cachedService = CacheDecorator.createProxy(mockUserService, cache, cacheableMethods); // ç¬¬ä¸€æ¬¡èª¿ç”¨ User result1 = cachedService.findById(1L); assertEquals(user, result1); // ç¬¬äºŒæ¬¡èª¿ç”¨æ‡‰è©²å¾ç·©å­˜ç²å– User result2 = cachedService.findById(1L); assertEquals(user, result2); // åªæ‡‰è©²èª¿ç”¨ä¸€æ¬¡å¯¦éš›æ–¹æ³• verify(mockUserService, times(1)).findById(1L); } @Test void testSecurityDecorator() { SecurityContext securityContext = new SecurityContext(Set.of(\u0026#34;USER_READ\u0026#34;)); Map\u0026lt;String, Set\u0026lt;String\u0026gt;\u0026gt; methodPermissions = Map.of( \u0026#34;findById\u0026#34;, Set.of(\u0026#34;USER_READ\u0026#34;), \u0026#34;save\u0026#34;, Set.of(\u0026#34;USER_WRITE\u0026#34;) ); UserService securedService = SecurityDecorator.createProxy( mockUserService, securityContext, methodPermissions); // æ‡‰è©²å…è¨±è®€å–æ“ä½œ assertDoesNotThrow(() -\u0026gt; securedService.findById(1L)); // æ‡‰è©²æ‹’çµ•å¯«å…¥æ“ä½œ assertThrows(SecurityException.class, () -\u0026gt; securedService.save(new User())); } } 2. AOP æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 @SpringBootTest @EnableAspectJAutoProxy class AopDecoratorTest { @Autowired private UserService userService; @MockBean private UserRepository userRepository; @Test void testLoggingAspect() { User user = new User(1L, \u0026#34;testUser\u0026#34;); when(userRepository.findById(1L)).thenReturn(Optional.of(user)); User result = userService.findById(1L); assertEquals(user, result); // é©—è­‰æ—¥èªŒè¼¸å‡º } @Test void testCacheAspect() { User user = new User(1L, \u0026#34;testUser\u0026#34;); when(userRepository.findById(1L)).thenReturn(Optional.of(user)); // ç¬¬ä¸€æ¬¡èª¿ç”¨ User result1 = userService.findById(1L); assertEquals(user, result1); // ç¬¬äºŒæ¬¡èª¿ç”¨æ‡‰è©²å¾ç·©å­˜ç²å– User result2 = userService.findById(1L); assertEquals(user, result2); // åªæ‡‰è©²èª¿ç”¨ä¸€æ¬¡æ•¸æ“šåº« verify(userRepository, times(1)).findById(1L); } } æœ€ä½³å¯¦è¸ 1. è¨­è¨ˆåŸå‰‡ å–®ä¸€è·è²¬: æ¯å€‹è£é£¾å™¨åªè™•ç†ä¸€å€‹æ©«åˆ‡é—œæ³¨é» é–‹æ”¾å°é–‰: æ˜“æ–¼æ·»åŠ æ–°è£é£¾å™¨è€Œä¸ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ çµ„åˆå„ªæ–¼ç¹¼æ‰¿: ä½¿ç”¨çµ„åˆä¾†æ“´å±•è¡Œç‚º æ¥å£éš”é›¢: å®šç¾©æ¸…æ™°çš„æ¥å£å¥‘ç´„ 2. å¯¦ç¾å»ºè­° ä½¿ç”¨ä¸å¯è®Šå°è±¡æé«˜ç·šç¨‹å®‰å…¨æ€§ è€ƒæ…®è£é£¾å™¨çš„é †åºï¼Œç‰¹åˆ¥æ˜¯åœ¨éˆå¼èª¿ç”¨ä¸­ å¯¦ç¾é©ç•¶çš„ç•°å¸¸è™•ç† æä¾›é…ç½®é¸é …ä¾†æ§åˆ¶è£é£¾å™¨è¡Œç‚º 3. æ€§èƒ½è€ƒæ…® é¿å…éåº¦è£é£¾å°è‡´æ€§èƒ½ä¸‹é™ ä½¿ç”¨ç·©å­˜ä¾†æé«˜é‡è¤‡æ“ä½œçš„æ€§èƒ½ è€ƒæ…®ç•°æ­¥è™•ç†ä¾†æ¸›å°‘é˜»å¡ ç›£æ§è£é£¾å™¨çš„æ€§èƒ½å½±éŸ¿ 4. å¸¸è¦‹é™·é˜± é¿å…è£é£¾å™¨éˆéé•· æ³¨æ„å¾ªç’°ä¾è³´å•é¡Œ æ­£ç¢ºè™•ç†ç•°å¸¸å‚³æ’­ è€ƒæ…®ç·šç¨‹å®‰å…¨æ€§ é©ç”¨å ´æ™¯ ä½•æ™‚ä½¿ç”¨ æ©«åˆ‡é—œæ³¨é»: éœ€è¦æ·»åŠ æ—¥èªŒã€å®‰å…¨ã€ç·©å­˜ç­‰æ©«åˆ‡åŠŸèƒ½ å‹•æ…‹è¡Œç‚º: éœ€è¦åœ¨é‹è¡Œæ™‚å‹•æ…‹æ·»åŠ æˆ–ç§»é™¤åŠŸèƒ½ é¿å…ç¹¼æ‰¿: ç•¶ç¹¼æ‰¿æœƒå°è‡´é¡çˆ†ç‚¸æ™‚ é€æ˜æ“´å±•: éœ€è¦é€æ˜åœ°æ“´å±•å°è±¡åŠŸèƒ½ ä½•æ™‚é¿å… ç°¡å–®å ´æ™¯: ç•¶åŠŸèƒ½æ“´å±•å¾ˆç°¡å–®æ™‚ æ€§èƒ½é—œéµ: ç•¶æ€§èƒ½æ˜¯é—œéµå› ç´ æ™‚ éåº¦ä½¿ç”¨: ç•¶è£é£¾å™¨å±¤æ¬¡éå¤šæ™‚ é¡å‹å®‰å…¨: ç•¶éœ€è¦å¼·é¡å‹æª¢æŸ¥æ™‚ ç¸½çµ Decorator Pattern æ˜¯ä¸€å€‹å¼·å¤§çš„çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œç‰¹åˆ¥é©åˆåœ¨ä¼æ¥­ç´šæ‡‰ç”¨ä¸­è™•ç†æ©«åˆ‡é—œæ³¨é»ã€‚é€šéèˆ‡ Spring AOP çš„çµåˆä½¿ç”¨ï¼Œæˆ‘å€‘å¯ä»¥å‰µå»ºå‡ºéå¸¸éˆæ´»å’Œå¯ç¶­è­·çš„ç³»çµ±ã€‚\nç¾ä»£ Java çš„å‡½æ•¸å¼ç·¨ç¨‹ç‰¹æ€§ç‚º Decorator Pattern æä¾›äº†æ–°çš„å¯¦ç¾æ–¹å¼ï¼Œä½¿å¾—ä»£ç¢¼æ›´åŠ ç°¡æ½”å’Œæ˜“è®€ã€‚åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé—œéµæ˜¯è¦ç†è§£ä½•æ™‚ä½¿ç”¨é€™å€‹æ¨¡å¼ï¼Œä»¥åŠå¦‚ä½•æ­£ç¢ºåœ°çµ„åˆå¤šå€‹è£é£¾å™¨ä¾†é”åˆ°æ‰€éœ€çš„æ•ˆæœã€‚\né€šéåˆç†ä½¿ç”¨ Decorator Patternï¼Œæˆ‘å€‘å¯ä»¥æ§‹å»ºå‡ºæ—¢éˆæ´»åˆå¯ç¶­è­·çš„ä¼æ¥­ç´šæ‡‰ç”¨ï¼ŒåŒæ™‚ä¿æŒä»£ç¢¼çš„æ¸…æ™°æ€§å’Œå¯æ¸¬è©¦æ€§ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/decorator/","tags":["Design Pattern","Structural","Decorator","AOP","Spring"],"title":"DesignPattern - Structural - Decorator"},{"content":"æ©‹æ¥æ¨¡å¼ (Bridge Pattern) å®Œæ•´å¯¦ä½œæŒ‡å— æ¨¡å¼æ¦‚è¿° æ©‹æ¥æ¨¡å¼æ˜¯ä¸€ç¨®çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œå®ƒå°‡æŠ½è±¡éƒ¨åˆ†èˆ‡å¯¦ç¾éƒ¨åˆ†åˆ†é›¢ï¼Œä½¿å®ƒå€‘éƒ½å¯ä»¥ç¨ç«‹åœ°è®ŠåŒ–ã€‚æ©‹æ¥æ¨¡å¼é€šéçµ„åˆå»ºç«‹æŠ½è±¡å’Œå¯¦ç¾ä¹‹é–“çš„æ©‹æ¢ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç¹¼æ‰¿å°‡å®ƒå€‘çµåˆåœ¨ä¸€èµ·ã€‚\næ ¸å¿ƒæ€æƒ³ æ©‹æ¥æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯**ã€Œçµ„åˆå„ªæ–¼ç¹¼æ‰¿ã€**ï¼Œå®ƒè§£æ±ºäº†åœ¨å¤šå€‹ç¶­åº¦ä¸Šè®ŠåŒ–çš„å•é¡Œï¼Œé¿å…äº†é¡çˆ†ç‚¸çš„å•é¡Œã€‚\næ¨¡å¼çµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 // æŠ½è±¡ (Abstraction) public abstract class Shape { protected Color color; public Shape(Color color) { this.color = color; } public abstract void draw(); public abstract double getArea(); } // å¯¦ç¾ä»‹é¢ (Implementor) public interface Color { void fill(); } // å…·é«”å¯¦ç¾ (Concrete Implementor) public class Red implements Color { @Override public void fill() { System.out.println(\u0026#34;å¡«å……ç´…è‰²\u0026#34;); } } public class Blue implements Color { @Override public void fill() { System.out.println(\u0026#34;å¡«å……è—è‰²\u0026#34;); } } // ç´°åŒ–æŠ½è±¡ (Refined Abstraction) public class Circle extends Shape { private double radius; public Circle(Color color, double radius) { super(color); this.radius = radius; } @Override public void draw() { System.out.print(\u0026#34;ç•«åœ“å½¢ï¼ŒåŠå¾‘ï¼š\u0026#34; + radius + \u0026#34;ï¼Œ\u0026#34;); color.fill(); } @Override public double getArea() { return Math.PI * radius * radius; } } public class Rectangle extends Shape { private double width; private double height; public Rectangle(Color color, double width, double height) { super(color); this.width = width; this.height = height; } @Override public void draw() { System.out.print(\u0026#34;ç•«çŸ©å½¢ï¼Œå¯¬ï¼š\u0026#34; + width + \u0026#34;ï¼Œé«˜ï¼š\u0026#34; + height + \u0026#34;ï¼Œ\u0026#34;); color.fill(); } @Override public double getArea() { return width * height; } } ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯ 1. æ•¸æ“šåº«æŠ½è±¡å±¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 // æ•¸æ“šåº«æ“ä½œæŠ½è±¡ public abstract class DatabaseOperation { protected DatabaseDriver driver; public DatabaseOperation(DatabaseDriver driver) { this.driver = driver; } public abstract void execute(String sql); public abstract ResultSet query(String sql); public abstract boolean update(String sql); protected void logOperation(String operation) { System.out.println(\u0026#34;åŸ·è¡Œæ•¸æ“šåº«æ“ä½œ: \u0026#34; + operation); } } // æ•¸æ“šåº«é©…å‹•ä»‹é¢ public interface DatabaseDriver { Connection getConnection(); void closeConnection(Connection connection); PreparedStatement prepareStatement(String sql); boolean supportsTransaction(); void beginTransaction(); void commit(); void rollback(); } // MySQLé©…å‹•å¯¦ç¾ @Component public class MySQLDriver implements DatabaseDriver { private static final String DRIVER_NAME = \u0026#34;com.mysql.cj.jdbc.Driver\u0026#34;; private final String connectionUrl; private final String username; private final String password; public MySQLDriver(@Value(\u0026#34;${database.mysql.url}\u0026#34;) String connectionUrl, @Value(\u0026#34;${database.mysql.username}\u0026#34;) String username, @Value(\u0026#34;${database.mysql.password}\u0026#34;) String password) { this.connectionUrl = connectionUrl; this.username = username; this.password = password; } @Override public Connection getConnection() { try { Class.forName(DRIVER_NAME); return DriverManager.getConnection(connectionUrl, username, password); } catch (ClassNotFoundException | SQLException e) { throw new DatabaseConnectionException(\u0026#34;ç„¡æ³•é€£æ¥åˆ°MySQLæ•¸æ“šåº«\u0026#34;, e); } } @Override public void closeConnection(Connection connection) { try { if (connection != null \u0026amp;\u0026amp; !connection.isClosed()) { connection.close(); } } catch (SQLException e) { throw new DatabaseConnectionException(\u0026#34;é—œé–‰MySQLé€£æ¥å¤±æ•—\u0026#34;, e); } } @Override public PreparedStatement prepareStatement(String sql) { try { Connection connection = getConnection(); return connection.prepareStatement(sql); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;å‰µå»ºMySQL PreparedStatementå¤±æ•—\u0026#34;, e); } } @Override public boolean supportsTransaction() { return true; } @Override public void beginTransaction() { try { Connection connection = getConnection(); connection.setAutoCommit(false); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;é–‹å§‹MySQLäº‹å‹™å¤±æ•—\u0026#34;, e); } } @Override public void commit() { try { Connection connection = getConnection(); connection.commit(); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;æäº¤MySQLäº‹å‹™å¤±æ•—\u0026#34;, e); } } @Override public void rollback() { try { Connection connection = getConnection(); connection.rollback(); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;å›æ»¾MySQLäº‹å‹™å¤±æ•—\u0026#34;, e); } } } // PostgreSQLé©…å‹•å¯¦ç¾ @Component public class PostgreSQLDriver implements DatabaseDriver { private static final String DRIVER_NAME = \u0026#34;org.postgresql.Driver\u0026#34;; private final String connectionUrl; private final String username; private final String password; public PostgreSQLDriver(@Value(\u0026#34;${database.postgresql.url}\u0026#34;) String connectionUrl, @Value(\u0026#34;${database.postgresql.username}\u0026#34;) String username, @Value(\u0026#34;${database.postgresql.password}\u0026#34;) String password) { this.connectionUrl = connectionUrl; this.username = username; this.password = password; } @Override public Connection getConnection() { try { Class.forName(DRIVER_NAME); return DriverManager.getConnection(connectionUrl, username, password); } catch (ClassNotFoundException | SQLException e) { throw new DatabaseConnectionException(\u0026#34;ç„¡æ³•é€£æ¥åˆ°PostgreSQLæ•¸æ“šåº«\u0026#34;, e); } } @Override public void closeConnection(Connection connection) { try { if (connection != null \u0026amp;\u0026amp; !connection.isClosed()) { connection.close(); } } catch (SQLException e) { throw new DatabaseConnectionException(\u0026#34;é—œé–‰PostgreSQLé€£æ¥å¤±æ•—\u0026#34;, e); } } @Override public PreparedStatement prepareStatement(String sql) { try { Connection connection = getConnection(); return connection.prepareStatement(sql); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;å‰µå»ºPostgreSQL PreparedStatementå¤±æ•—\u0026#34;, e); } } @Override public boolean supportsTransaction() { return true; } @Override public void beginTransaction() { try { Connection connection = getConnection(); connection.setAutoCommit(false); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;é–‹å§‹PostgreSQLäº‹å‹™å¤±æ•—\u0026#34;, e); } } @Override public void commit() { try { Connection connection = getConnection(); connection.commit(); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;æäº¤PostgreSQLäº‹å‹™å¤±æ•—\u0026#34;, e); } } @Override public void rollback() { try { Connection connection = getConnection(); connection.rollback(); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;å›æ»¾PostgreSQLäº‹å‹™å¤±æ•—\u0026#34;, e); } } } // ç”¨æˆ¶æ•¸æ“šæ“ä½œ @Repository public class UserDatabaseOperation extends DatabaseOperation { public UserDatabaseOperation(DatabaseDriver driver) { super(driver); } @Override public void execute(String sql) { Connection connection = null; PreparedStatement statement = null; try { connection = driver.getConnection(); statement = connection.prepareStatement(sql); statement.execute(); logOperation(\u0026#34;åŸ·è¡Œç”¨æˆ¶ç›¸é—œSQL: \u0026#34; + sql); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;åŸ·è¡Œç”¨æˆ¶SQLå¤±æ•—\u0026#34;, e); } finally { closeResources(statement, connection); } } @Override public ResultSet query(String sql) { try { Connection connection = driver.getConnection(); PreparedStatement statement = connection.prepareStatement(sql); ResultSet resultSet = statement.executeQuery(); logOperation(\u0026#34;æŸ¥è©¢ç”¨æˆ¶æ•¸æ“š: \u0026#34; + sql); return resultSet; } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;æŸ¥è©¢ç”¨æˆ¶æ•¸æ“šå¤±æ•—\u0026#34;, e); } } @Override public boolean update(String sql) { Connection connection = null; PreparedStatement statement = null; try { connection = driver.getConnection(); statement = connection.prepareStatement(sql); int affectedRows = statement.executeUpdate(); logOperation(\u0026#34;æ›´æ–°ç”¨æˆ¶æ•¸æ“š: \u0026#34; + sql + \u0026#34;, å½±éŸ¿è¡Œæ•¸: \u0026#34; + affectedRows); return affectedRows \u0026gt; 0; } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;æ›´æ–°ç”¨æˆ¶æ•¸æ“šå¤±æ•—\u0026#34;, e); } finally { closeResources(statement, connection); } } public User findUserById(Long id) { String sql = \u0026#34;SELECT * FROM users WHERE id = ?\u0026#34;; try (Connection connection = driver.getConnection(); PreparedStatement statement = connection.prepareStatement(sql)) { statement.setLong(1, id); ResultSet resultSet = statement.executeQuery(); if (resultSet.next()) { return mapResultSetToUser(resultSet); } return null; } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;æ ¹æ“šIDæŸ¥è©¢ç”¨æˆ¶å¤±æ•—\u0026#34;, e); } } public void createUser(User user) { String sql = \u0026#34;INSERT INTO users (name, email, created_at) VALUES (?, ?, ?)\u0026#34;; try (Connection connection = driver.getConnection(); PreparedStatement statement = connection.prepareStatement(sql)) { statement.setString(1, user.getName()); statement.setString(2, user.getEmail()); statement.setTimestamp(3, Timestamp.valueOf(user.getCreatedAt())); statement.executeUpdate(); logOperation(\u0026#34;å‰µå»ºç”¨æˆ¶: \u0026#34; + user.getName()); } catch (SQLException e) { throw new DatabaseOperationException(\u0026#34;å‰µå»ºç”¨æˆ¶å¤±æ•—\u0026#34;, e); } } public void updateUser(User user) { if (!driver.supportsTransaction()) { throw new UnsupportedOperationException(\u0026#34;ç•¶å‰æ•¸æ“šåº«ä¸æ”¯æŒäº‹å‹™æ“ä½œ\u0026#34;); } String sql = \u0026#34;UPDATE users SET name = ?, email = ?, updated_at = ? WHERE id = ?\u0026#34;; Connection connection = null; PreparedStatement statement = null; try { connection = driver.getConnection(); driver.beginTransaction(); statement = connection.prepareStatement(sql); statement.setString(1, user.getName()); statement.setString(2, user.getEmail()); statement.setTimestamp(3, Timestamp.valueOf(LocalDateTime.now())); statement.setLong(4, user.getId()); int affectedRows = statement.executeUpdate(); if (affectedRows == 0) { throw new DatabaseOperationException(\u0026#34;æœªæ‰¾åˆ°è¦æ›´æ–°çš„ç”¨æˆ¶\u0026#34;); } driver.commit(); logOperation(\u0026#34;æ›´æ–°ç”¨æˆ¶: \u0026#34; + user.getName()); } catch (SQLException e) { driver.rollback(); throw new DatabaseOperationException(\u0026#34;æ›´æ–°ç”¨æˆ¶å¤±æ•—\u0026#34;, e); } finally { closeResources(statement, connection); } } private User mapResultSetToUser(ResultSet resultSet) throws SQLException { return User.builder() .id(resultSet.getLong(\u0026#34;id\u0026#34;)) .name(resultSet.getString(\u0026#34;name\u0026#34;)) .email(resultSet.getString(\u0026#34;email\u0026#34;)) .createdAt(resultSet.getTimestamp(\u0026#34;created_at\u0026#34;).toLocalDateTime()) .build(); } private void closeResources(PreparedStatement statement, Connection connection) { try { if (statement != null) { statement.close(); } } catch (SQLException e) { // è¨˜éŒ„æ—¥èªŒä½†ä¸æ‹‹å‡ºç•°å¸¸ } driver.closeConnection(connection); } } 2. æ¶ˆæ¯ç™¼é€ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 // æ¶ˆæ¯æŠ½è±¡ public abstract class Message { protected MessageSender sender; protected String content; protected String recipient; protected LocalDateTime timestamp; public Message(MessageSender sender, String content, String recipient) { this.sender = sender; this.content = content; this.recipient = recipient; this.timestamp = LocalDateTime.now(); } public abstract void send(); public abstract boolean isDelivered(); public abstract void resend(); protected void logMessage(String action) { System.out.println(String.format(\u0026#34;[%s] %s - æ”¶ä»¶äºº: %s\u0026#34;, timestamp.format(DateTimeFormatter.ofPattern(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;)), action, recipient)); } } // æ¶ˆæ¯ç™¼é€è€…ä»‹é¢ public interface MessageSender { void sendMessage(String recipient, String content); boolean isAvailable(); String getSenderType(); void configure(Map\u0026lt;String, Object\u0026gt; configuration); DeliveryStatus getDeliveryStatus(String messageId); } // é›»å­éƒµä»¶ç™¼é€å™¨ @Component public class EmailSender implements MessageSender { private final JavaMailSender mailSender; private final EmailConfiguration emailConfig; public EmailSender(JavaMailSender mailSender, EmailConfiguration emailConfig) { this.mailSender = mailSender; this.emailConfig = emailConfig; } @Override public void sendMessage(String recipient, String content) { try { SimpleMailMessage message = new SimpleMailMessage(); message.setFrom(emailConfig.getFromAddress()); message.setTo(recipient); message.setSubject(emailConfig.getDefaultSubject()); message.setText(content); mailSender.send(message); } catch (Exception e) { throw new MessageSendException(\u0026#34;ç™¼é€é›»å­éƒµä»¶å¤±æ•—\u0026#34;, e); } } @Override public boolean isAvailable() { try { return mailSender != null \u0026amp;\u0026amp; emailConfig.isEnabled(); } catch (Exception e) { return false; } } @Override public String getSenderType() { return \u0026#34;EMAIL\u0026#34;; } @Override public void configure(Map\u0026lt;String, Object\u0026gt; configuration) { if (configuration.containsKey(\u0026#34;subject\u0026#34;)) { emailConfig.setDefaultSubject((String) configuration.get(\u0026#34;subject\u0026#34;)); } if (configuration.containsKey(\u0026#34;fromAddress\u0026#34;)) { emailConfig.setFromAddress((String) configuration.get(\u0026#34;fromAddress\u0026#34;)); } } @Override public DeliveryStatus getDeliveryStatus(String messageId) { // å¯¦éš›å¯¦ç¾éœ€è¦èˆ‡éƒµä»¶æœå‹™å™¨APIæ•´åˆ return DeliveryStatus.DELIVERED; } } // SMSç™¼é€å™¨ @Component public class SMSSender implements MessageSender { private final SmsClient smsClient; private final SmsConfiguration smsConfig; public SMSSender(SmsClient smsClient, SmsConfiguration smsConfig) { this.smsClient = smsClient; this.smsConfig = smsConfig; } @Override public void sendMessage(String recipient, String content) { try { SmsRequest request = SmsRequest.builder() .phoneNumber(recipient) .message(content) .apiKey(smsConfig.getApiKey()) .build(); SmsResponse response = smsClient.sendSms(request); if (!response.isSuccess()) { throw new MessageSendException(\u0026#34;SMSç™¼é€å¤±æ•—: \u0026#34; + response.getErrorMessage()); } } catch (Exception e) { throw new MessageSendException(\u0026#34;ç™¼é€SMSå¤±æ•—\u0026#34;, e); } } @Override public boolean isAvailable() { return smsClient != null \u0026amp;\u0026amp; smsConfig.isEnabled() \u0026amp;\u0026amp; smsConfig.getApiKey() != null; } @Override public String getSenderType() { return \u0026#34;SMS\u0026#34;; } @Override public void configure(Map\u0026lt;String, Object\u0026gt; configuration) { if (configuration.containsKey(\u0026#34;apiKey\u0026#34;)) { smsConfig.setApiKey((String) configuration.get(\u0026#34;apiKey\u0026#34;)); } } @Override public DeliveryStatus getDeliveryStatus(String messageId) { try { return smsClient.getDeliveryStatus(messageId); } catch (Exception e) { return DeliveryStatus.UNKNOWN; } } } // æ¨é€é€šçŸ¥ç™¼é€å™¨ @Component public class PushNotificationSender implements MessageSender { private final PushNotificationService pushService; private final PushConfiguration pushConfig; public PushNotificationSender(PushNotificationService pushService, PushConfiguration pushConfig) { this.pushService = pushService; this.pushConfig = pushConfig; } @Override public void sendMessage(String recipient, String content) { try { PushNotification notification = PushNotification.builder() .deviceToken(recipient) .message(content) .badge(1) .sound(\u0026#34;default\u0026#34;) .build(); pushService.send(notification); } catch (Exception e) { throw new MessageSendException(\u0026#34;ç™¼é€æ¨é€é€šçŸ¥å¤±æ•—\u0026#34;, e); } } @Override public boolean isAvailable() { return pushService != null \u0026amp;\u0026amp; pushConfig.isEnabled(); } @Override public String getSenderType() { return \u0026#34;PUSH\u0026#34;; } @Override public void configure(Map\u0026lt;String, Object\u0026gt; configuration) { if (configuration.containsKey(\u0026#34;appId\u0026#34;)) { pushConfig.setAppId((String) configuration.get(\u0026#34;appId\u0026#34;)); } } @Override public DeliveryStatus getDeliveryStatus(String messageId) { try { return pushService.getDeliveryStatus(messageId); } catch (Exception e) { return DeliveryStatus.UNKNOWN; } } } // é€šçŸ¥æ¶ˆæ¯ public class NotificationMessage extends Message { private String messageId; private int retryCount; private final int maxRetries; public NotificationMessage(MessageSender sender, String content, String recipient) { super(sender, content, recipient); this.messageId = generateMessageId(); this.retryCount = 0; this.maxRetries = 3; } @Override public void send() { if (!sender.isAvailable()) { throw new MessageSendException(\u0026#34;æ¶ˆæ¯ç™¼é€å™¨ä¸å¯ç”¨: \u0026#34; + sender.getSenderType()); } try { sender.sendMessage(recipient, content); logMessage(\u0026#34;é€šçŸ¥å·²ç™¼é€ - \u0026#34; + sender.getSenderType()); } catch (Exception e) { logMessage(\u0026#34;é€šçŸ¥ç™¼é€å¤±æ•— - \u0026#34; + sender.getSenderType()); throw e; } } @Override public boolean isDelivered() { try { DeliveryStatus status = sender.getDeliveryStatus(messageId); return status == DeliveryStatus.DELIVERED; } catch (Exception e) { return false; } } @Override public void resend() { if (retryCount \u0026gt;= maxRetries) { throw new MessageSendException(\u0026#34;å·²é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸\u0026#34;); } retryCount++; logMessage(\u0026#34;é‡æ–°ç™¼é€é€šçŸ¥ (ç¬¬\u0026#34; + retryCount + \u0026#34;æ¬¡) - \u0026#34; + sender.getSenderType()); send(); } private String generateMessageId() { return UUID.randomUUID().toString(); } } // ç‡ŸéŠ·æ¶ˆæ¯ public class MarketingMessage extends Message { private String campaignId; private Map\u0026lt;String, Object\u0026gt; personalizationData; public MarketingMessage(MessageSender sender, String content, String recipient, String campaignId, Map\u0026lt;String, Object\u0026gt; personalizationData) { super(sender, content, recipient); this.campaignId = campaignId; this.personalizationData = personalizationData; } @Override public void send() { if (!sender.isAvailable()) { throw new MessageSendException(\u0026#34;æ¶ˆæ¯ç™¼é€å™¨ä¸å¯ç”¨: \u0026#34; + sender.getSenderType()); } String personalizedContent = personalizeContent(); try { sender.sendMessage(recipient, personalizedContent); logMessage(\u0026#34;ç‡ŸéŠ·æ¶ˆæ¯å·²ç™¼é€ - æ´»å‹•ID: \u0026#34; + campaignId + \u0026#34; - \u0026#34; + sender.getSenderType()); } catch (Exception e) { logMessage(\u0026#34;ç‡ŸéŠ·æ¶ˆæ¯ç™¼é€å¤±æ•— - æ´»å‹•ID: \u0026#34; + campaignId + \u0026#34; - \u0026#34; + sender.getSenderType()); throw e; } } @Override public boolean isDelivered() { try { DeliveryStatus status = sender.getDeliveryStatus(campaignId); return status == DeliveryStatus.DELIVERED; } catch (Exception e) { return false; } } @Override public void resend() { logMessage(\u0026#34;é‡æ–°ç™¼é€ç‡ŸéŠ·æ¶ˆæ¯ - æ´»å‹•ID: \u0026#34; + campaignId + \u0026#34; - \u0026#34; + sender.getSenderType()); send(); } private String personalizeContent() { String personalizedContent = content; if (personalizationData != null) { for (Map.Entry\u0026lt;String, Object\u0026gt; entry : personalizationData.entrySet()) { String placeholder = \u0026#34;{{\u0026#34; + entry.getKey() + \u0026#34;}}\u0026#34;; personalizedContent = personalizedContent.replace(placeholder, entry.getValue().toString()); } } return personalizedContent; } } 3. å ±å‘Šç”Ÿæˆç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 // å ±å‘ŠæŠ½è±¡ public abstract class Report { protected ReportGenerator generator; protected String title; protected LocalDateTime generatedAt; protected Map\u0026lt;String, Object\u0026gt; data; public Report(ReportGenerator generator, String title, Map\u0026lt;String, Object\u0026gt; data) { this.generator = generator; this.title = title; this.data = data; this.generatedAt = LocalDateTime.now(); } public abstract void generate(); public abstract void export(String filePath); public abstract String getContent(); protected void logReportActivity(String activity) { System.out.println(String.format(\u0026#34;[%s] %s - å ±å‘Š: %s\u0026#34;, generatedAt.format(DateTimeFormatter.ofPattern(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;)), activity, title)); } } // å ±å‘Šç”Ÿæˆå™¨ä»‹é¢ public interface ReportGenerator { String generateContent(String title, Map\u0026lt;String, Object\u0026gt; data); void exportToFile(String content, String filePath); String getFormat(); boolean supportsCharts(); void setTemplate(String template); } // PDFå ±å‘Šç”Ÿæˆå™¨ @Component public class PDFReportGenerator implements ReportGenerator { private final PDFService pdfService; private String template; public PDFReportGenerator(PDFService pdfService) { this.pdfService = pdfService; } @Override public String generateContent(String title, Map\u0026lt;String, Object\u0026gt; data) { try { PDFDocument document = new PDFDocument(); // æ·»åŠ æ¨™é¡Œ document.addTitle(title); document.addGeneratedDate(LocalDateTime.now()); // æ·»åŠ æ•¸æ“šå…§å®¹ if (data.containsKey(\u0026#34;summary\u0026#34;)) { document.addSection(\u0026#34;æ‘˜è¦\u0026#34;, data.get(\u0026#34;summary\u0026#34;).toString()); } if (data.containsKey(\u0026#34;tableData\u0026#34;)) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; tableData = (List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt;) data.get(\u0026#34;tableData\u0026#34;); document.addTable(tableData); } if (data.containsKey(\u0026#34;chartData\u0026#34;) \u0026amp;\u0026amp; supportsCharts()) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) Map\u0026lt;String, Object\u0026gt; chartData = (Map\u0026lt;String, Object\u0026gt;) data.get(\u0026#34;chartData\u0026#34;); document.addChart(chartData); } return document.build(); } catch (Exception e) { throw new ReportGenerationException(\u0026#34;ç”ŸæˆPDFå ±å‘Šå…§å®¹å¤±æ•—\u0026#34;, e); } } @Override public void exportToFile(String content, String filePath) { try { pdfService.saveToPDF(content, filePath); } catch (Exception e) { throw new ReportGenerationException(\u0026#34;å°å‡ºPDFå ±å‘Šå¤±æ•—\u0026#34;, e); } } @Override public String getFormat() { return \u0026#34;PDF\u0026#34;; } @Override public boolean supportsCharts() { return true; } @Override public void setTemplate(String template) { this.template = template; } } // Excelå ±å‘Šç”Ÿæˆå™¨ @Component public class ExcelReportGenerator implements ReportGenerator { private final ExcelService excelService; private String template; public ExcelReportGenerator(ExcelService excelService) { this.excelService = excelService; } @Override public String generateContent(String title, Map\u0026lt;String, Object\u0026gt; data) { try { Workbook workbook = new XSSFWorkbook(); Sheet sheet = workbook.createSheet(title); int rowIndex = 0; // æ·»åŠ æ¨™é¡Œè¡Œ Row titleRow = sheet.createRow(rowIndex++); Cell titleCell = titleRow.createCell(0); titleCell.setCellValue(title); // æ·»åŠ ç”Ÿæˆæ™‚é–“ Row dateRow = sheet.createRow(rowIndex++); Cell dateCell = dateRow.createCell(0); dateCell.setCellValue(\u0026#34;ç”Ÿæˆæ™‚é–“: \u0026#34; + LocalDateTime.now().format(DateTimeFormatter.ofPattern(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;))); // ç©ºè¡Œ rowIndex++; // æ·»åŠ æ•¸æ“šè¡¨æ ¼ if (data.containsKey(\u0026#34;tableData\u0026#34;)) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; tableData = (List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt;) data.get(\u0026#34;tableData\u0026#34;); if (!tableData.isEmpty()) { // æ·»åŠ è¡¨é ­ Row headerRow = sheet.createRow(rowIndex++); Set\u0026lt;String\u0026gt; headers = tableData.get(0).keySet(); int colIndex = 0; for (String header : headers) { Cell headerCell = headerRow.createCell(colIndex++); headerCell.setCellValue(header); } // æ·»åŠ æ•¸æ“šè¡Œ for (Map\u0026lt;String, Object\u0026gt; row : tableData) { Row dataRow = sheet.createRow(rowIndex++); colIndex = 0; for (String header : headers) { Cell dataCell = dataRow.createCell(colIndex++); Object value = row.get(header); if (value != null) { dataCell.setCellValue(value.toString()); } } } } } // è‡ªå‹•èª¿æ•´åˆ—å¯¬ for (int i = 0; i \u0026lt; sheet.getRow(0).getLastCellNum(); i++) { sheet.autoSizeColumn(i); } return workbook.toString(); // å¯¦éš›å¯¦ç¾éœ€è¦åºåˆ—åŒ–workbook } catch (Exception e) { throw new ReportGenerationException(\u0026#34;ç”ŸæˆExcelå ±å‘Šå…§å®¹å¤±æ•—\u0026#34;, e); } } @Override public void exportToFile(String content, String filePath) { try { excelService.saveToExcel(content, filePath); } catch (Exception e) { throw new ReportGenerationException(\u0026#34;å°å‡ºExcelå ±å‘Šå¤±æ•—\u0026#34;, e); } } @Override public String getFormat() { return \u0026#34;EXCEL\u0026#34;; } @Override public boolean supportsCharts() { return true; } @Override public void setTemplate(String template) { this.template = template; } } // HTMLå ±å‘Šç”Ÿæˆå™¨ @Component public class HTMLReportGenerator implements ReportGenerator { private final TemplateEngine templateEngine; private String template; public HTMLReportGenerator(TemplateEngine templateEngine) { this.templateEngine = templateEngine; } @Override public String generateContent(String title, Map\u0026lt;String, Object\u0026gt; data) { try { Map\u0026lt;String, Object\u0026gt; templateData = new HashMap\u0026lt;\u0026gt;(); templateData.put(\u0026#34;title\u0026#34;, title); templateData.put(\u0026#34;generatedAt\u0026#34;, LocalDateTime.now()); templateData.putAll(data); if (template != null) { return templateEngine.process(template, templateData); } else { return generateDefaultHTML(title, data); } } catch (Exception e) { throw new ReportGenerationException(\u0026#34;ç”ŸæˆHTMLå ±å‘Šå…§å®¹å¤±æ•—\u0026#34;, e); } } @Override public void exportToFile(String content, String filePath) { try (FileWriter writer = new FileWriter(filePath)) { writer.write(content); } catch (IOException e) { throw new ReportGenerationException(\u0026#34;å°å‡ºHTMLå ±å‘Šå¤±æ•—\u0026#34;, e); } } @Override public String getFormat() { return \u0026#34;HTML\u0026#34;; } @Override public boolean supportsCharts() { return true; // æ”¯æŒJavaScriptåœ–è¡¨ } @Override public void setTemplate(String template) { this.template = template; } private String generateDefaultHTML(String title, Map\u0026lt;String, Object\u0026gt; data) { StringBuilder html = new StringBuilder(); html.append(\u0026#34;\u0026lt;!DOCTYPE html\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;html\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;head\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;title\u0026gt;\u0026#34;).append(title).append(\u0026#34;\u0026lt;/title\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;style\u0026gt;\u0026#34;) .append(\u0026#34;body { font-family: Arial, sans-serif; margin: 20px; }\u0026#34;) .append(\u0026#34;table { border-collapse: collapse; width: 100%; }\u0026#34;) .append(\u0026#34;th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\u0026#34;) .append(\u0026#34;th { background-color: #f2f2f2; }\u0026#34;) .append(\u0026#34;\u0026lt;/style\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;/head\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;body\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;h1\u0026gt;\u0026#34;).append(title).append(\u0026#34;\u0026lt;/h1\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;p\u0026gt;ç”Ÿæˆæ™‚é–“: \u0026#34;).append(LocalDateTime.now().format(DateTimeFormatter.ofPattern(\u0026#34;yyyy-MM-dd HH:mm:ss\u0026#34;))).append(\u0026#34;\u0026lt;/p\u0026gt;\u0026#34;); if (data.containsKey(\u0026#34;summary\u0026#34;)) { html.append(\u0026#34;\u0026lt;h2\u0026gt;æ‘˜è¦\u0026lt;/h2\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;p\u0026gt;\u0026#34;).append(data.get(\u0026#34;summary\u0026#34;)).append(\u0026#34;\u0026lt;/p\u0026gt;\u0026#34;); } if (data.containsKey(\u0026#34;tableData\u0026#34;)) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; tableData = (List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt;) data.get(\u0026#34;tableData\u0026#34;); if (!tableData.isEmpty()) { html.append(\u0026#34;\u0026lt;h2\u0026gt;æ•¸æ“šè¡¨æ ¼\u0026lt;/h2\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;table\u0026gt;\u0026#34;); // è¡¨é ­ Set\u0026lt;String\u0026gt; headers = tableData.get(0).keySet(); html.append(\u0026#34;\u0026lt;tr\u0026gt;\u0026#34;); for (String header : headers) { html.append(\u0026#34;\u0026lt;th\u0026gt;\u0026#34;).append(header).append(\u0026#34;\u0026lt;/th\u0026gt;\u0026#34;); } html.append(\u0026#34;\u0026lt;/tr\u0026gt;\u0026#34;); // æ•¸æ“šè¡Œ for (Map\u0026lt;String, Object\u0026gt; row : tableData) { html.append(\u0026#34;\u0026lt;tr\u0026gt;\u0026#34;); for (String header : headers) { Object value = row.get(header); html.append(\u0026#34;\u0026lt;td\u0026gt;\u0026#34;).append(value != null ? value.toString() : \u0026#34;\u0026#34;).append(\u0026#34;\u0026lt;/td\u0026gt;\u0026#34;); } html.append(\u0026#34;\u0026lt;/tr\u0026gt;\u0026#34;); } html.append(\u0026#34;\u0026lt;/table\u0026gt;\u0026#34;); } } html.append(\u0026#34;\u0026lt;/body\u0026gt;\u0026#34;) .append(\u0026#34;\u0026lt;/html\u0026gt;\u0026#34;); return html.toString(); } } // éŠ·å”®å ±å‘Š public class SalesReport extends Report { private String period; public SalesReport(ReportGenerator generator, String title, Map\u0026lt;String, Object\u0026gt; data, String period) { super(generator, title, data); this.period = period; } @Override public void generate() { logReportActivity(\u0026#34;é–‹å§‹ç”ŸæˆéŠ·å”®å ±å‘Š - æœŸé–“: \u0026#34; + period); // æº–å‚™éŠ·å”®æ•¸æ“š prepareSalesData(); // ç”Ÿæˆå ±å‘Šå…§å®¹ String content = generator.generateContent(title, data); logReportActivity(\u0026#34;éŠ·å”®å ±å‘Šç”Ÿæˆå®Œæˆ - æ ¼å¼: \u0026#34; + generator.getFormat()); } @Override public void export(String filePath) { String content = getContent(); generator.exportToFile(content, filePath); logReportActivity(\u0026#34;éŠ·å”®å ±å‘Šå·²å°å‡º - æ–‡ä»¶: \u0026#34; + filePath); } @Override public String getContent() { return generator.generateContent(title, data); } private void prepareSalesData() { // æº–å‚™éŠ·å”®æ‘˜è¦ data.put(\u0026#34;summary\u0026#34;, \u0026#34;æœ¬å ±å‘Šå±•ç¤ºäº†\u0026#34; + period + \u0026#34;æœŸé–“çš„éŠ·å”®æ¥­ç¸¾å’Œè¶¨å‹¢åˆ†æ\u0026#34;); // æº–å‚™éŠ·å”®æ•¸æ“šè¡¨æ ¼ List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; salesData = new ArrayList\u0026lt;\u0026gt;(); salesData.add(Map.of(\u0026#34;ç”¢å“\u0026#34;, \u0026#34;ç”¢å“A\u0026#34;, \u0026#34;éŠ·å”®é¡\u0026#34;, 10000, \u0026#34;æ•¸é‡\u0026#34;, 100)); salesData.add(Map.of(\u0026#34;ç”¢å“\u0026#34;, \u0026#34;ç”¢å“B\u0026#34;, \u0026#34;éŠ·å”®é¡\u0026#34;, 15000, \u0026#34;æ•¸é‡\u0026#34;, 150)); salesData.add(Map.of(\u0026#34;ç”¢å“\u0026#34;, \u0026#34;ç”¢å“C\u0026#34;, \u0026#34;éŠ·å”®é¡\u0026#34;, 8000, \u0026#34;æ•¸é‡\u0026#34;, 80)); data.put(\u0026#34;tableData\u0026#34;, salesData); // æº–å‚™åœ–è¡¨æ•¸æ“š if (generator.supportsCharts()) { Map\u0026lt;String, Object\u0026gt; chartData = new HashMap\u0026lt;\u0026gt;(); chartData.put(\u0026#34;type\u0026#34;, \u0026#34;bar\u0026#34;); chartData.put(\u0026#34;labels\u0026#34;, List.of(\u0026#34;ç”¢å“A\u0026#34;, \u0026#34;ç”¢å“B\u0026#34;, \u0026#34;ç”¢å“C\u0026#34;)); chartData.put(\u0026#34;values\u0026#34;, List.of(10000, 15000, 8000)); data.put(\u0026#34;chartData\u0026#34;, chartData); } } } // ç”¨æˆ¶å ±å‘Š public class UserReport extends Report { private String userSegment; public UserReport(ReportGenerator generator, String title, Map\u0026lt;String, Object\u0026gt; data, String userSegment) { super(generator, title, data); this.userSegment = userSegment; } @Override public void generate() { logReportActivity(\u0026#34;é–‹å§‹ç”Ÿæˆç”¨æˆ¶å ±å‘Š - ç”¨æˆ¶ç¾¤: \u0026#34; + userSegment); // æº–å‚™ç”¨æˆ¶æ•¸æ“š prepareUserData(); // ç”Ÿæˆå ±å‘Šå…§å®¹ String content = generator.generateContent(title, data); logReportActivity(\u0026#34;ç”¨æˆ¶å ±å‘Šç”Ÿæˆå®Œæˆ - æ ¼å¼: \u0026#34; + generator.getFormat()); } @Override public void export(String filePath) { String content = getContent(); generator.exportToFile(content, filePath); logReportActivity(\u0026#34;ç”¨æˆ¶å ±å‘Šå·²å°å‡º - æ–‡ä»¶: \u0026#34; + filePath); } @Override public String getContent() { return generator.generateContent(title, data); } private void prepareUserData() { // æº–å‚™ç”¨æˆ¶åˆ†ææ‘˜è¦ data.put(\u0026#34;summary\u0026#34;, \u0026#34;æœ¬å ±å‘Šåˆ†æäº†\u0026#34; + userSegment + \u0026#34;ç”¨æˆ¶ç¾¤çš„è¡Œç‚ºæ¨¡å¼å’Œç‰¹å¾µ\u0026#34;); // æº–å‚™ç”¨æˆ¶æ•¸æ“šè¡¨æ ¼ List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; userData = new ArrayList\u0026lt;\u0026gt;(); userData.add(Map.of(\u0026#34;ç”¨æˆ¶ID\u0026#34;, \u0026#34;U001\u0026#34;, \u0026#34;å§“å\u0026#34;, \u0026#34;å¼µä¸‰\u0026#34;, \u0026#34;æ´»èºåº¦\u0026#34;, \u0026#34;é«˜\u0026#34;, \u0026#34;æ¶ˆè²»é‡‘é¡\u0026#34;, 5000)); userData.add(Map.of(\u0026#34;ç”¨æˆ¶ID\u0026#34;, \u0026#34;U002\u0026#34;, \u0026#34;å§“å\u0026#34;, \u0026#34;æå››\u0026#34;, \u0026#34;æ´»èºåº¦\u0026#34;, \u0026#34;ä¸­\u0026#34;, \u0026#34;æ¶ˆè²»é‡‘é¡\u0026#34;, 3000)); userData.add(Map.of(\u0026#34;ç”¨æˆ¶ID\u0026#34;, \u0026#34;U003\u0026#34;, \u0026#34;å§“å\u0026#34;, \u0026#34;ç‹äº”\u0026#34;, \u0026#34;æ´»èºåº¦\u0026#34;, \u0026#34;ä½\u0026#34;, \u0026#34;æ¶ˆè²»é‡‘é¡\u0026#34;, 1000)); data.put(\u0026#34;tableData\u0026#34;, userData); // æº–å‚™åœ–è¡¨æ•¸æ“š if (generator.supportsCharts()) { Map\u0026lt;String, Object\u0026gt; chartData = new HashMap\u0026lt;\u0026gt;(); chartData.put(\u0026#34;type\u0026#34;, \u0026#34;pie\u0026#34;); chartData.put(\u0026#34;labels\u0026#34;, List.of(\u0026#34;é«˜æ´»èºåº¦\u0026#34;, \u0026#34;ä¸­æ´»èºåº¦\u0026#34;, \u0026#34;ä½æ´»èºåº¦\u0026#34;)); chartData.put(\u0026#34;values\u0026#34;, List.of(1, 1, 1)); data.put(\u0026#34;chartData\u0026#34;, chartData); } } } é…ç½®å’Œç®¡ç† 1. Spring Booté…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 @Configuration @EnableConfigurationProperties({DatabaseProperties.class, MessageProperties.class}) public class BridgePatternConfig { @Bean @ConditionalOnProperty(name = \u0026#34;database.type\u0026#34;, havingValue = \u0026#34;mysql\u0026#34;) public DatabaseDriver mysqlDriver(DatabaseProperties properties) { return new MySQLDriver( properties.getMysql().getUrl(), properties.getMysql().getUsername(), properties.getMysql().getPassword() ); } @Bean @ConditionalOnProperty(name = \u0026#34;database.type\u0026#34;, havingValue = \u0026#34;postgresql\u0026#34;) public DatabaseDriver postgresqlDriver(DatabaseProperties properties) { return new PostgreSQLDriver( properties.getPostgresql().getUrl(), properties.getPostgresql().getUsername(), properties.getPostgresql().getPassword() ); } @Bean @ConditionalOnProperty(name = \u0026#34;messaging.email.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public MessageSender emailSender(JavaMailSender mailSender, EmailConfiguration emailConfig) { return new EmailSender(mailSender, emailConfig); } @Bean @ConditionalOnProperty(name = \u0026#34;messaging.sms.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public MessageSender smsSender(SmsClient smsClient, SmsConfiguration smsConfig) { return new SMSSender(smsClient, smsConfig); } @Bean @ConditionalOnProperty(name = \u0026#34;messaging.push.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public MessageSender pushSender(PushNotificationService pushService, PushConfiguration pushConfig) { return new PushNotificationSender(pushService, pushConfig); } @Bean @ConditionalOnProperty(name = \u0026#34;reports.pdf.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public ReportGenerator pdfGenerator(PDFService pdfService) { return new PDFReportGenerator(pdfService); } @Bean @ConditionalOnProperty(name = \u0026#34;reports.excel.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public ReportGenerator excelGenerator(ExcelService excelService) { return new ExcelReportGenerator(excelService); } @Bean @ConditionalOnProperty(name = \u0026#34;reports.html.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public ReportGenerator htmlGenerator(TemplateEngine templateEngine) { return new HTMLReportGenerator(templateEngine); } } 2. çµ±ä¸€æœå‹™ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 @Service public class BridgePatternService { private final List\u0026lt;DatabaseDriver\u0026gt; databaseDrivers; private final List\u0026lt;MessageSender\u0026gt; messageSenders; private final List\u0026lt;ReportGenerator\u0026gt; reportGenerators; public BridgePatternService(List\u0026lt;DatabaseDriver\u0026gt; databaseDrivers, List\u0026lt;MessageSender\u0026gt; messageSenders, List\u0026lt;ReportGenerator\u0026gt; reportGenerators) { this.databaseDrivers = databaseDrivers; this.messageSenders = messageSenders; this.reportGenerators = reportGenerators; } public void processUserData(User user) { // ä½¿ç”¨é©ç•¶çš„æ•¸æ“šåº«é©…å‹• DatabaseDriver driver = selectDatabaseDriver(); UserDatabaseOperation operation = new UserDatabaseOperation(driver); operation.createUser(user); // ç™¼é€é€šçŸ¥ MessageSender sender = selectMessageSender(\u0026#34;EMAIL\u0026#34;); if (sender != null) { NotificationMessage message = new NotificationMessage( sender, \u0026#34;æ­¡è¿åŠ å…¥æˆ‘å€‘çš„æœå‹™ï¼\u0026#34;, user.getEmail() ); message.send(); } // ç”Ÿæˆç”¨æˆ¶å ±å‘Š ReportGenerator generator = selectReportGenerator(\u0026#34;PDF\u0026#34;); if (generator != null) { Map\u0026lt;String, Object\u0026gt; data = new HashMap\u0026lt;\u0026gt;(); data.put(\u0026#34;user\u0026#34;, user); UserReport report = new UserReport(generator, \u0026#34;æ–°ç”¨æˆ¶å ±å‘Š\u0026#34;, data, \u0026#34;æ–°ç”¨æˆ¶\u0026#34;); report.generate(); report.export(\u0026#34;/reports/user_\u0026#34; + user.getId() + \u0026#34;.pdf\u0026#34;); } } private DatabaseDriver selectDatabaseDriver() { return databaseDrivers.stream() .findFirst() .orElseThrow(() -\u0026gt; new RuntimeException(\u0026#34;æ²’æœ‰å¯ç”¨çš„æ•¸æ“šåº«é©…å‹•\u0026#34;)); } private MessageSender selectMessageSender(String type) { return messageSenders.stream() .filter(sender -\u0026gt; sender.getSenderType().equals(type)) .filter(MessageSender::isAvailable) .findFirst() .orElse(null); } private ReportGenerator selectReportGenerator(String format) { return reportGenerators.stream() .filter(generator -\u0026gt; generator.getFormat().equals(format)) .findFirst() .orElse(null); } } æ¸¬è©¦ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 @ExtendWith(MockitoExtension.class) class BridgePatternTest { @Mock private DatabaseDriver mockDatabaseDriver; @Mock private MessageSender mockMessageSender; @Mock private ReportGenerator mockReportGenerator; @Test void testUserDatabaseOperation() { // Given Connection mockConnection = mock(Connection.class); PreparedStatement mockStatement = mock(PreparedStatement.class); when(mockDatabaseDriver.getConnection()).thenReturn(mockConnection); when(mockConnection.prepareStatement(anyString())).thenReturn(mockStatement); UserDatabaseOperation operation = new UserDatabaseOperation(mockDatabaseDriver); User user = User.builder() .name(\u0026#34;æ¸¬è©¦ç”¨æˆ¶\u0026#34;) .email(\u0026#34;test@example.com\u0026#34;) .createdAt(LocalDateTime.now()) .build(); // When operation.createUser(user); // Then verify(mockDatabaseDriver).getConnection(); verify(mockStatement).setString(1, \u0026#34;æ¸¬è©¦ç”¨æˆ¶\u0026#34;); verify(mockStatement).setString(2, \u0026#34;test@example.com\u0026#34;); verify(mockStatement).executeUpdate(); } @Test void testNotificationMessage() { // Given when(mockMessageSender.isAvailable()).thenReturn(true); when(mockMessageSender.getSenderType()).thenReturn(\u0026#34;EMAIL\u0026#34;); NotificationMessage message = new NotificationMessage( mockMessageSender, \u0026#34;æ¸¬è©¦æ¶ˆæ¯\u0026#34;, \u0026#34;test@example.com\u0026#34; ); // When message.send(); // Then verify(mockMessageSender).sendMessage(\u0026#34;test@example.com\u0026#34;, \u0026#34;æ¸¬è©¦æ¶ˆæ¯\u0026#34;); } @Test void testSalesReport() { // Given when(mockReportGenerator.getFormat()).thenReturn(\u0026#34;PDF\u0026#34;); when(mockReportGenerator.supportsCharts()).thenReturn(true); when(mockReportGenerator.generateContent(anyString(), any())).thenReturn(\u0026#34;PDFå…§å®¹\u0026#34;); SalesReport report = new SalesReport( mockReportGenerator, \u0026#34;éŠ·å”®å ±å‘Š\u0026#34;, new HashMap\u0026lt;\u0026gt;(), \u0026#34;2023å¹´ç¬¬ä¸€å­£åº¦\u0026#34; ); // When report.generate(); // Then verify(mockReportGenerator).generateContent(eq(\u0026#34;éŠ·å”®å ±å‘Š\u0026#34;), any()); } } æ€§èƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. é€£æ¥æ± ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Component public class DatabaseConnectionPool { private final Map\u0026lt;String, HikariDataSource\u0026gt; dataSources = new ConcurrentHashMap\u0026lt;\u0026gt;(); public Connection getConnection(String driverType) { HikariDataSource dataSource = dataSources.computeIfAbsent(driverType, this::createDataSource); try { return dataSource.getConnection(); } catch (SQLException e) { throw new DatabaseConnectionException(\u0026#34;ç„¡æ³•å¾é€£æ¥æ± ç²å–é€£æ¥\u0026#34;, e); } } private HikariDataSource createDataSource(String driverType) { HikariConfig config = new HikariConfig(); // æ ¹æ“šé©…å‹•é¡å‹é…ç½®é€£æ¥æ±  return new HikariDataSource(config); } } 2. ç•°æ­¥æ¶ˆæ¯è™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 @Component public class AsyncMessageProcessor { private final TaskExecutor taskExecutor; public AsyncMessageProcessor(TaskExecutor taskExecutor) { this.taskExecutor = taskExecutor; } public CompletableFuture\u0026lt;Void\u0026gt; sendMessageAsync(Message message) { return CompletableFuture.runAsync(() -\u0026gt; { try { message.send(); } catch (Exception e) { // è¨˜éŒ„éŒ¯èª¤ä¸¦é€²è¡Œé‡è©¦ handleMessageError(message, e); } }, taskExecutor); } private void handleMessageError(Message message, Exception e) { // éŒ¯èª¤è™•ç†é‚è¼¯ } } ç›£æ§èˆ‡è¨ºæ–· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Component public class BridgePatternMonitor { private final MeterRegistry meterRegistry; public BridgePatternMonitor(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; } public void recordDatabaseOperation(String operation, String driver, boolean success) { Counter.builder(\u0026#34;bridge.database.operations\u0026#34;) .tag(\u0026#34;operation\u0026#34;, operation) .tag(\u0026#34;driver\u0026#34;, driver) .tag(\u0026#34;success\u0026#34;, String.valueOf(success)) .register(meterRegistry) .increment(); } public void recordMessageSent(String senderType, boolean success) { Counter.builder(\u0026#34;bridge.message.sent\u0026#34;) .tag(\u0026#34;sender\u0026#34;, senderType) .tag(\u0026#34;success\u0026#34;, String.valueOf(success)) .register(meterRegistry) .increment(); } public void recordReportGenerated(String format, long durationMs) { Timer.builder(\u0026#34;bridge.report.generation\u0026#34;) .tag(\u0026#34;format\u0026#34;, format) .register(meterRegistry) .record(durationMs, TimeUnit.MILLISECONDS); } } ç¸½çµ æ©‹æ¥æ¨¡å¼æ˜¯ä¸€ç¨®å¼·å¤§çš„çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œç‰¹åˆ¥é©ç”¨æ–¼ï¼š\nå¤šç¶­åº¦è®ŠåŒ–ï¼šç•¶ç³»çµ±éœ€è¦åœ¨å¤šå€‹ç¶­åº¦ä¸Šè®ŠåŒ–æ™‚ æŠ½è±¡èˆ‡å¯¦ç¾åˆ†é›¢ï¼šéœ€è¦å°‡æŠ½è±¡å’Œå¯¦ç¾è§£è€¦ é‹è¡Œæ™‚åˆ‡æ›ï¼šéœ€è¦åœ¨é‹è¡Œæ™‚å‹•æ…‹åˆ‡æ›å¯¦ç¾ é¿å…é¡çˆ†ç‚¸ï¼šæ¸›å°‘ç¹¼æ‰¿å±¤æ¬¡çµæ§‹çš„è¤‡é›œæ€§ é—œéµæœ€ä½³å¯¦è¸ æ˜ç¢ºè·è²¬åˆ†é›¢ï¼šæ¸…æ¥šå€åˆ†æŠ½è±¡å’Œå¯¦ç¾çš„è·è²¬ ä»‹é¢è¨­è¨ˆï¼šè¨­è¨ˆç©©å®šçš„å¯¦ç¾è€…ä»‹é¢ ä¾è³´æ³¨å…¥ï¼šä½¿ç”¨ä¾è³´æ³¨å…¥ç®¡ç†å¯¦ç¾è€… é…ç½®é©…å‹•ï¼šé€šéé…ç½®é¸æ“‡é©ç•¶çš„å¯¦ç¾ ç›£æ§è¨ºæ–·ï¼šè¿½è¹¤æ©‹æ¥æ¨¡å¼çš„ä½¿ç”¨æƒ…æ³ æ©‹æ¥æ¨¡å¼è®“æŠ½è±¡å’Œå¯¦ç¾å¯ä»¥ç¨ç«‹è®ŠåŒ–ï¼Œæ˜¯æ§‹å»ºéˆæ´»ã€å¯æ“´å±•ç³»çµ±çš„é‡è¦å·¥å…·ã€‚æ­£ç¢ºä½¿ç”¨æ©‹æ¥æ¨¡å¼å¯ä»¥å¤§å¹…æå‡ç³»çµ±çš„ç¶­è­·æ€§å’Œæ“´å±•æ€§ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/bridge/","tags":["Design Pattern","Bridge Pattern","Structural Pattern","Abstraction","Implementation","Decoupling","Architecture","Java","Spring Boot","Best Practices","Enterprise Development","SOLID Principles","Software Design"],"title":"æ©‹æ¥æ¨¡å¼ (Bridge Pattern) å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šæŠ½è±¡èˆ‡å¯¦ç¾åˆ†é›¢çš„æ¶æ§‹è¨­è¨ˆæœ€ä½³å¯¦è¸"},{"content":"Facade Pattern æ¦‚è¿° Facade Pattern æ˜¯ä¸€ç¨®çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œå®ƒç‚ºå­ç³»çµ±ä¸­çš„ä¸€çµ„æ¥å£æä¾›çµ±ä¸€çš„å…¥å£ã€‚Facade å®šç¾©äº†ä¸€å€‹æ›´é«˜ç´šåˆ¥çš„æ¥å£ï¼Œä½¿å­ç³»çµ±æ›´æ˜“æ–¼ä½¿ç”¨ã€‚å®ƒé€šééš±è—è¤‡é›œæ€§ä¸¦æš´éœ²ç°¡å–®çš„æ¥å£ä¾†å¯¦ç¾æŠ½è±¡ï¼Œä¿ƒé€²é¬†æ•£è€¦åˆã€‚\næ ¸å¿ƒæ¦‚å¿µ é—œéµç‰¹æ€§ ç°¡åŒ–æ¥å£: æä¾›æ›´ç°¡å–®çš„æ¥å£ä¾†è¨ªå•è¤‡é›œçš„å­ç³»çµ± è§£è€¦: å°‡å®¢æˆ¶ç«¯èˆ‡å­ç³»çµ±çš„å…§éƒ¨å·¥ä½œè§£è€¦ çµ±ä¸€è¨ªå•é»: ç‚ºå¤šå€‹å­ç³»çµ±æä¾›çµ±ä¸€çš„è¨ªå•å…¥å£ å°è£è¤‡é›œæ€§: éš±è—å­ç³»çµ±çš„è¤‡é›œå¯¦ç¾ç´°ç¯€ èˆ‡å…¶ä»–æ¨¡å¼çš„å€åˆ¥ Facade vs Adapter: Facade ç°¡åŒ–æ¥å£ï¼ŒAdapter è½‰æ›æ¥å£ Facade vs Mediator: Facade å­ç³»çµ±ä¸çŸ¥é“ Facade å­˜åœ¨ï¼ŒMediator ä¸­å„çµ„ä»¶éƒ½çŸ¥é“ Mediator Facade vs Proxy: Facade ç°¡åŒ–è¨ªå•ï¼ŒProxy æ§åˆ¶è¨ªå• çµæ§‹çµ„ä»¶ Facade: å¤–è§€é¡ï¼Œæä¾›ç°¡åŒ–çš„æ¥å£ Subsystem Classes: å­ç³»çµ±é¡ï¼Œå¯¦ç¾å…·é«”åŠŸèƒ½ Client: å®¢æˆ¶ç«¯ï¼Œé€šé Facade è¨ªå•å­ç³»çµ± åŸºæœ¬å¯¦ç¾ 1. ç¶“å…¸ Facade å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 // å­ç³»çµ±é¡ public class AudioSystem { public void turnOn() { System.out.println(\u0026#34;Audio system is now ON\u0026#34;); } public void turnOff() { System.out.println(\u0026#34;Audio system is now OFF\u0026#34;); } public void setVolume(int level) { System.out.println(\u0026#34;Audio volume set to \u0026#34; + level); } } public class VideoSystem { public void turnOn() { System.out.println(\u0026#34;Video system is now ON\u0026#34;); } public void turnOff() { System.out.println(\u0026#34;Video system is now OFF\u0026#34;); } public void setBrightness(int level) { System.out.println(\u0026#34;Video brightness set to \u0026#34; + level); } } public class LightingSystem { public void turnOn() { System.out.println(\u0026#34;Lighting system is now ON\u0026#34;); } public void turnOff() { System.out.println(\u0026#34;Lighting system is now OFF\u0026#34;); } public void setIntensity(int level) { System.out.println(\u0026#34;Lighting intensity set to \u0026#34; + level); } } // Facade å¯¦ç¾ public class HomeTheaterFacade { private final AudioSystem audioSystem; private final VideoSystem videoSystem; private final LightingSystem lightingSystem; public HomeTheaterFacade() { this.audioSystem = new AudioSystem(); this.videoSystem = new VideoSystem(); this.lightingSystem = new LightingSystem(); } public void watchMovie() { System.out.println(\u0026#34;Starting movie experience...\u0026#34;); lightingSystem.turnOn(); lightingSystem.setIntensity(20); audioSystem.turnOn(); audioSystem.setVolume(70); videoSystem.turnOn(); videoSystem.setBrightness(50); System.out.println(\u0026#34;Movie experience ready!\u0026#34;); } public void endMovie() { System.out.println(\u0026#34;Ending movie experience...\u0026#34;); videoSystem.turnOff(); audioSystem.turnOff(); lightingSystem.setIntensity(100); System.out.println(\u0026#34;Movie experience ended!\u0026#34;); } public void partyMode() { System.out.println(\u0026#34;Starting party mode...\u0026#34;); lightingSystem.turnOn(); lightingSystem.setIntensity(100); audioSystem.turnOn(); audioSystem.setVolume(90); System.out.println(\u0026#34;Party mode activated!\u0026#34;); } } 2. æ¸¬è©¦ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public class FacadePatternDemo { public static void main(String[] args) { HomeTheaterFacade homeTheater = new HomeTheaterFacade(); // è§€çœ‹é›»å½± homeTheater.watchMovie(); System.out.println(\u0026#34;\\n--- After movie ---\\n\u0026#34;); // çµæŸé›»å½± homeTheater.endMovie(); System.out.println(\u0026#34;\\n--- Starting party ---\\n\u0026#34;); // æ´¾å°æ¨¡å¼ homeTheater.partyMode(); } } ç¾ä»£ Java å¯¦ç¾ 1. å‡½æ•¸å¼ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 // ä½¿ç”¨å‡½æ•¸å¼æ¥å£ @FunctionalInterface public interface ServiceOperation { void execute(); } public class FunctionalFacade { private final Map\u0026lt;String, List\u0026lt;ServiceOperation\u0026gt;\u0026gt; workflows = new HashMap\u0026lt;\u0026gt;(); public FunctionalFacade() { initializeWorkflows(); } private void initializeWorkflows() { // å®šç¾©å·¥ä½œæµ workflows.put(\u0026#34;startup\u0026#34;, Arrays.asList( () -\u0026gt; System.out.println(\u0026#34;Initializing database connections\u0026#34;), () -\u0026gt; System.out.println(\u0026#34;Loading configuration\u0026#34;), () -\u0026gt; System.out.println(\u0026#34;Starting web server\u0026#34;), () -\u0026gt; System.out.println(\u0026#34;Registering services\u0026#34;) )); workflows.put(\u0026#34;shutdown\u0026#34;, Arrays.asList( () -\u0026gt; System.out.println(\u0026#34;Stopping web server\u0026#34;), () -\u0026gt; System.out.println(\u0026#34;Closing database connections\u0026#34;), () -\u0026gt; System.out.println(\u0026#34;Saving state\u0026#34;), () -\u0026gt; System.out.println(\u0026#34;Cleanup completed\u0026#34;) )); } public void executeWorkflow(String workflowName) { List\u0026lt;ServiceOperation\u0026gt; operations = workflows.get(workflowName); if (operations != null) { System.out.println(\u0026#34;Executing workflow: \u0026#34; + workflowName); operations.forEach(ServiceOperation::execute); } } public void addOperation(String workflowName, ServiceOperation operation) { workflows.computeIfAbsent(workflowName, k -\u0026gt; new ArrayList\u0026lt;\u0026gt;()).add(operation); } } 2. Builder æ¨¡å¼çš„ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 public class FluentFacade { private final List\u0026lt;ServiceOperation\u0026gt; operations = new ArrayList\u0026lt;\u0026gt;(); public FluentFacade initialize() { operations.add(() -\u0026gt; System.out.println(\u0026#34;System initialized\u0026#34;)); return this; } public FluentFacade configure(String config) { operations.add(() -\u0026gt; System.out.println(\u0026#34;Configured with: \u0026#34; + config)); return this; } public FluentFacade start() { operations.add(() -\u0026gt; System.out.println(\u0026#34;System started\u0026#34;)); return this; } public FluentFacade stop() { operations.add(() -\u0026gt; System.out.println(\u0026#34;System stopped\u0026#34;)); return this; } public void execute() { operations.forEach(ServiceOperation::execute); operations.clear(); } } // ä½¿ç”¨ç¤ºä¾‹ public class FluentFacadeDemo { public static void main(String[] args) { FluentFacade facade = new FluentFacade(); facade.initialize() .configure(\u0026#34;production\u0026#34;) .start() .execute(); } } ä¼æ¥­ç´šæ‡‰ç”¨æ¨¡å¼ 1. æœå‹™ç·¨æ’ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 // æœå‹™æ¥å£ public interface UserService { User findById(Long id); User save(User user); void deleteById(Long id); } public interface OrderService { Order createOrder(Order order); List\u0026lt;Order\u0026gt; getOrdersByUserId(Long userId); void cancelOrder(Long orderId); } public interface PaymentService { Payment processPayment(Payment payment); PaymentStatus getPaymentStatus(Long paymentId); } public interface NotificationService { void sendEmail(String to, String subject, String body); void sendSms(String to, String message); } // ä¼æ¥­ç´š Facade å¯¦ç¾ @Service public class ECommerceFacade { @Autowired private UserService userService; @Autowired private OrderService orderService; @Autowired private PaymentService paymentService; @Autowired private NotificationService notificationService; @Transactional public OrderResult placeOrder(OrderRequest orderRequest) { try { // 1. é©—è­‰ç”¨æˆ¶ User user = userService.findById(orderRequest.getUserId()); if (user == null) { throw new IllegalArgumentException(\u0026#34;User not found\u0026#34;); } // 2. å‰µå»ºè¨‚å–® Order order = new Order(); order.setUserId(orderRequest.getUserId()); order.setItems(orderRequest.getItems()); order.setTotalAmount(calculateTotal(orderRequest.getItems())); Order createdOrder = orderService.createOrder(order); // 3. è™•ç†æ”¯ä»˜ Payment payment = new Payment(); payment.setOrderId(createdOrder.getId()); payment.setAmount(createdOrder.getTotalAmount()); payment.setPaymentMethod(orderRequest.getPaymentMethod()); Payment processedPayment = paymentService.processPayment(payment); // 4. ç™¼é€é€šçŸ¥ notificationService.sendEmail( user.getEmail(), \u0026#34;Order Confirmation\u0026#34;, \u0026#34;Your order #\u0026#34; + createdOrder.getId() + \u0026#34; has been placed successfully\u0026#34; ); return new OrderResult(createdOrder, processedPayment, \u0026#34;SUCCESS\u0026#34;); } catch (Exception e) { return new OrderResult(null, null, \u0026#34;ERROR: \u0026#34; + e.getMessage()); } } @Transactional public CancellationResult cancelOrder(Long orderId, Long userId) { try { // 1. é©—è­‰ç”¨æˆ¶æ¬Šé™ User user = userService.findById(userId); if (user == null) { throw new IllegalArgumentException(\u0026#34;User not found\u0026#34;); } // 2. å–æ¶ˆè¨‚å–® orderService.cancelOrder(orderId); // 3. è™•ç†é€€æ¬¾ // (é€€æ¬¾é‚è¼¯) // 4. ç™¼é€å–æ¶ˆé€šçŸ¥ notificationService.sendEmail( user.getEmail(), \u0026#34;Order Cancellation\u0026#34;, \u0026#34;Your order #\u0026#34; + orderId + \u0026#34; has been cancelled\u0026#34; ); return new CancellationResult(orderId, \u0026#34;SUCCESS\u0026#34;); } catch (Exception e) { return new CancellationResult(orderId, \u0026#34;ERROR: \u0026#34; + e.getMessage()); } } public UserDashboard getUserDashboard(Long userId) { User user = userService.findById(userId); List\u0026lt;Order\u0026gt; orders = orderService.getOrdersByUserId(userId); return new UserDashboard(user, orders); } private BigDecimal calculateTotal(List\u0026lt;OrderItem\u0026gt; items) { return items.stream() .map(item -\u0026gt; item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity()))) .reduce(BigDecimal.ZERO, BigDecimal::add); } } 2. æ¥­å‹™æµç¨‹ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 // æ¥­å‹™æµç¨‹å®šç¾© public interface BusinessProcess { ProcessResult execute(ProcessContext context); void rollback(ProcessContext context); String getProcessName(); } // å…·é«”æ¥­å‹™æµç¨‹ @Component public class UserRegistrationProcess implements BusinessProcess { @Autowired private UserService userService; @Autowired private EmailService emailService; @Override public ProcessResult execute(ProcessContext context) { try { UserRegistrationData data = context.getData(UserRegistrationData.class); // å‰µå»ºç”¨æˆ¶ User user = new User(); user.setEmail(data.getEmail()); user.setName(data.getName()); user.setStatus(UserStatus.PENDING); User savedUser = userService.save(user); // ç™¼é€é©—è­‰éƒµä»¶ emailService.sendVerificationEmail(savedUser.getEmail(), savedUser.getId()); context.setResult(\u0026#34;userId\u0026#34;, savedUser.getId()); return ProcessResult.success(\u0026#34;User registration initiated\u0026#34;); } catch (Exception e) { return ProcessResult.failure(\u0026#34;Registration failed: \u0026#34; + e.getMessage()); } } @Override public void rollback(ProcessContext context) { Long userId = context.getResult(\u0026#34;userId\u0026#34;, Long.class); if (userId != null) { userService.deleteById(userId); } } @Override public String getProcessName() { return \u0026#34;USER_REGISTRATION\u0026#34;; } } // æ¥­å‹™æµç¨‹ Facade @Service public class BusinessProcessFacade { private final Map\u0026lt;String, BusinessProcess\u0026gt; processes; public BusinessProcessFacade(List\u0026lt;BusinessProcess\u0026gt; businessProcesses) { this.processes = businessProcesses.stream() .collect(Collectors.toMap( BusinessProcess::getProcessName, Function.identity() )); } public ProcessResult executeProcess(String processName, ProcessContext context) { BusinessProcess process = processes.get(processName); if (process == null) { return ProcessResult.failure(\u0026#34;Process not found: \u0026#34; + processName); } try { return process.execute(context); } catch (Exception e) { return ProcessResult.failure(\u0026#34;Process execution failed: \u0026#34; + e.getMessage()); } } public void rollbackProcess(String processName, ProcessContext context) { BusinessProcess process = processes.get(processName); if (process != null) { process.rollback(context); } } public List\u0026lt;String\u0026gt; getAvailableProcesses() { return new ArrayList\u0026lt;\u0026gt;(processes.keySet()); } } å¾®æœå‹™ Facade 1. API Gateway Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 // å¾®æœå‹™å®¢æˆ¶ç«¯ @FeignClient(name = \u0026#34;user-service\u0026#34;) public interface UserServiceClient { @GetMapping(\u0026#34;/users/{id}\u0026#34;) User getUser(@PathVariable Long id); @PostMapping(\u0026#34;/users\u0026#34;) User createUser(@RequestBody User user); } @FeignClient(name = \u0026#34;order-service\u0026#34;) public interface OrderServiceClient { @GetMapping(\u0026#34;/orders/{id}\u0026#34;) Order getOrder(@PathVariable Long id); @PostMapping(\u0026#34;/orders\u0026#34;) Order createOrder(@RequestBody Order order); @GetMapping(\u0026#34;/orders/user/{userId}\u0026#34;) List\u0026lt;Order\u0026gt; getOrdersByUserId(@PathVariable Long userId); } @FeignClient(name = \u0026#34;payment-service\u0026#34;) public interface PaymentServiceClient { @PostMapping(\u0026#34;/payments\u0026#34;) Payment processPayment(@RequestBody Payment payment); @GetMapping(\u0026#34;/payments/{id}\u0026#34;) Payment getPayment(@PathVariable Long id); } // API Gateway Facade @RestController @RequestMapping(\u0026#34;/api/v1\u0026#34;) public class ApiGatewayFacade { @Autowired private UserServiceClient userService; @Autowired private OrderServiceClient orderService; @Autowired private PaymentServiceClient paymentService; @GetMapping(\u0026#34;/users/{id}/profile\u0026#34;) public ResponseEntity\u0026lt;UserProfile\u0026gt; getUserProfile(@PathVariable Long id) { try { // ä¸¦è¡Œç²å–ç”¨æˆ¶è³‡æ–™å’Œè¨‚å–® CompletableFuture\u0026lt;User\u0026gt; userFuture = CompletableFuture.supplyAsync(() -\u0026gt; userService.getUser(id)); CompletableFuture\u0026lt;List\u0026lt;Order\u0026gt;\u0026gt; ordersFuture = CompletableFuture.supplyAsync(() -\u0026gt; orderService.getOrdersByUserId(id)); // ç­‰å¾…æ‰€æœ‰è«‹æ±‚å®Œæˆ User user = userFuture.get(); List\u0026lt;Order\u0026gt; orders = ordersFuture.get(); // çµ„åˆæ•¸æ“š UserProfile profile = new UserProfile(user, orders); return ResponseEntity.ok(profile); } catch (Exception e) { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(new UserProfile(null, null)); } } @PostMapping(\u0026#34;/checkout\u0026#34;) public ResponseEntity\u0026lt;CheckoutResult\u0026gt; checkout(@RequestBody CheckoutRequest request) { try { // å‰µå»ºè¨‚å–® Order order = new Order(); order.setUserId(request.getUserId()); order.setItems(request.getItems()); order.setTotalAmount(request.getTotalAmount()); Order createdOrder = orderService.createOrder(order); // è™•ç†æ”¯ä»˜ Payment payment = new Payment(); payment.setOrderId(createdOrder.getId()); payment.setAmount(createdOrder.getTotalAmount()); payment.setPaymentMethod(request.getPaymentMethod()); Payment processedPayment = paymentService.processPayment(payment); CheckoutResult result = new CheckoutResult(createdOrder, processedPayment); return ResponseEntity.ok(result); } catch (Exception e) { return ResponseEntity.status(HttpStatus.BAD_REQUEST) .body(new CheckoutResult(null, null)); } } } 2. æœå‹™èšåˆ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // æœå‹™èšåˆå™¨ @Service public class ServiceAggregatorFacade { @Autowired private UserServiceClient userService; @Autowired private OrderServiceClient orderService; @Autowired private PaymentServiceClient paymentService; @Autowired private ProductServiceClient productService; @Async public CompletableFuture\u0026lt;DashboardData\u0026gt; getUserDashboard(Long userId) { // ä¸¦è¡Œç²å–å¤šå€‹æœå‹™çš„æ•¸æ“š CompletableFuture\u0026lt;User\u0026gt; userFuture = CompletableFuture.supplyAsync(() -\u0026gt; userService.getUser(userId)); CompletableFuture\u0026lt;List\u0026lt;Order\u0026gt;\u0026gt; ordersFuture = CompletableFuture.supplyAsync(() -\u0026gt; orderService.getOrdersByUserId(userId)); CompletableFuture\u0026lt;List\u0026lt;Product\u0026gt;\u0026gt; recommendationsFuture = CompletableFuture.supplyAsync(() -\u0026gt; productService.getRecommendations(userId)); // çµ„åˆæ‰€æœ‰çµæœ return CompletableFuture.allOf(userFuture, ordersFuture, recommendationsFuture) .thenApply(v -\u0026gt; { User user = userFuture.join(); List\u0026lt;Order\u0026gt; orders = ordersFuture.join(); List\u0026lt;Product\u0026gt; recommendations = recommendationsFuture.join(); return new DashboardData(user, orders, recommendations); }); } public OrderSummary getOrderSummary(Long orderId) { // ç²å–è¨‚å–®è©³æƒ… Order order = orderService.getOrder(orderId); // ä¸¦è¡Œç²å–ç”¨æˆ¶å’Œæ”¯ä»˜ä¿¡æ¯ CompletableFuture\u0026lt;User\u0026gt; userFuture = CompletableFuture.supplyAsync(() -\u0026gt; userService.getUser(order.getUserId())); CompletableFuture\u0026lt;Payment\u0026gt; paymentFuture = CompletableFuture.supplyAsync(() -\u0026gt; paymentService.getPayment(order.getPaymentId())); try { User user = userFuture.get(); Payment payment = paymentFuture.get(); return new OrderSummary(order, user, payment); } catch (Exception e) { throw new RuntimeException(\u0026#34;Failed to get order summary\u0026#34;, e); } } } 3. å¾®æœå‹™ç·¨æ’ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 // å¾®æœå‹™ç·¨æ’æ¨¡å¼ @Service public class MicroserviceOrchestrator { @Autowired private UserServiceClient userService; @Autowired private InventoryServiceClient inventoryService; @Autowired private OrderServiceClient orderService; @Autowired private PaymentServiceClient paymentService; @Autowired private NotificationServiceClient notificationService; @Transactional public CompletableFuture\u0026lt;OrderProcessingResult\u0026gt; processOrder(OrderRequest request) { return CompletableFuture.supplyAsync(() -\u0026gt; { try { // 1. é©—è­‰ç”¨æˆ¶ User user = userService.getUser(request.getUserId()); if (user == null) { throw new IllegalArgumentException(\u0026#34;User not found\u0026#34;); } // 2. æª¢æŸ¥åº«å­˜ InventoryCheckResult inventoryResult = inventoryService.checkAvailability( request.getItems()); if (!inventoryResult.isAvailable()) { throw new IllegalStateException(\u0026#34;Insufficient inventory\u0026#34;); } // 3. å‰µå»ºè¨‚å–® Order order = orderService.createOrder(buildOrder(request)); // 4. è™•ç†æ”¯ä»˜ Payment payment = paymentService.processPayment( buildPayment(order, request.getPaymentMethod())); // 5. æ›´æ–°åº«å­˜ inventoryService.reserveItems(request.getItems()); // 6. ç™¼é€é€šçŸ¥ notificationService.sendOrderConfirmation(user.getEmail(), order.getId()); return new OrderProcessingResult(order, payment, \u0026#34;SUCCESS\u0026#34;); } catch (Exception e) { return new OrderProcessingResult(null, null, \u0026#34;ERROR: \u0026#34; + e.getMessage()); } }); } private Order buildOrder(OrderRequest request) { Order order = new Order(); order.setUserId(request.getUserId()); order.setItems(request.getItems()); order.setTotalAmount(calculateTotal(request.getItems())); order.setStatus(OrderStatus.PENDING); return order; } private Payment buildPayment(Order order, PaymentMethod method) { Payment payment = new Payment(); payment.setOrderId(order.getId()); payment.setAmount(order.getTotalAmount()); payment.setPaymentMethod(method); return payment; } private BigDecimal calculateTotal(List\u0026lt;OrderItem\u0026gt; items) { return items.stream() .map(item -\u0026gt; item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity()))) .reduce(BigDecimal.ZERO, BigDecimal::add); } } Spring Boot é›†æˆ 1. è‡ªå‹•é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 @Configuration @EnableConfigurationProperties(FacadeProperties.class) public class FacadeAutoConfiguration { @Bean @ConditionalOnMissingBean public BusinessProcessFacade businessProcessFacade(List\u0026lt;BusinessProcess\u0026gt; processes) { return new BusinessProcessFacade(processes); } @Bean @ConditionalOnMissingBean public ServiceAggregatorFacade serviceAggregatorFacade() { return new ServiceAggregatorFacade(); } @Bean @ConditionalOnProperty(prefix = \u0026#34;facade.api-gateway\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public ApiGatewayFacade apiGatewayFacade() { return new ApiGatewayFacade(); } @Bean @ConditionalOnProperty(prefix = \u0026#34;facade.orchestrator\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public MicroserviceOrchestrator microserviceOrchestrator() { return new MicroserviceOrchestrator(); } } // é…ç½®å±¬æ€§ @ConfigurationProperties(prefix = \u0026#34;facade\u0026#34;) @Data public class FacadeProperties { private ApiGateway apiGateway = new ApiGateway(); private Orchestrator orchestrator = new Orchestrator(); private CircuitBreaker circuitBreaker = new CircuitBreaker(); @Data public static class ApiGateway { private boolean enabled = true; private int timeout = 5000; private int maxConcurrentRequests = 100; } @Data public static class Orchestrator { private boolean enabled = true; private int maxRetries = 3; private long retryDelay = 1000; } @Data public static class CircuitBreaker { private boolean enabled = true; private int failureThreshold = 5; private long timeout = 60000; } } 2. å¥åº·æª¢æŸ¥ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 @Component public class HealthCheckFacade { @Autowired private List\u0026lt;HealthIndicator\u0026gt; healthIndicators; @Autowired private MeterRegistry meterRegistry; public HealthStatus getOverallHealth() { Map\u0026lt;String, Health\u0026gt; healthDetails = new HashMap\u0026lt;\u0026gt;(); boolean allHealthy = true; for (HealthIndicator indicator : healthIndicators) { try { Health health = indicator.health(); healthDetails.put(indicator.getClass().getSimpleName(), health); if (health.getStatus() != Status.UP) { allHealthy = false; } } catch (Exception e) { Health errorHealth = Health.down() .withDetail(\u0026#34;error\u0026#34;, e.getMessage()) .build(); healthDetails.put(indicator.getClass().getSimpleName(), errorHealth); allHealthy = false; } } // è¨˜éŒ„å¥åº·ç‹€æ…‹æŒ‡æ¨™ meterRegistry.gauge(\u0026#34;health.status\u0026#34;, allHealthy ? 1 : 0); return new HealthStatus(allHealthy ? Status.UP : Status.DOWN, healthDetails); } public Health getServiceHealth(String serviceName) { return healthIndicators.stream() .filter(indicator -\u0026gt; indicator.getClass().getSimpleName().equals(serviceName)) .findFirst() .map(HealthIndicator::health) .orElse(Health.unknown().withDetail(\u0026#34;service\u0026#34;, \u0026#34;not found\u0026#34;).build()); } } 3. é…ç½®ç®¡ç† Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 @Service public class ConfigurationFacade { @Autowired private Environment environment; @Autowired private ApplicationContext applicationContext; private final Map\u0026lt;String, Object\u0026gt; runtimeConfig = new ConcurrentHashMap\u0026lt;\u0026gt;(); public String getProperty(String key) { return environment.getProperty(key); } public String getProperty(String key, String defaultValue) { return environment.getProperty(key, defaultValue); } public \u0026lt;T\u0026gt; T getProperty(String key, Class\u0026lt;T\u0026gt; targetType) { return environment.getProperty(key, targetType); } public void setRuntimeProperty(String key, Object value) { runtimeConfig.put(key, value); } public Object getRuntimeProperty(String key) { return runtimeConfig.get(key); } public Map\u0026lt;String, Object\u0026gt; getAllRuntimeProperties() { return new HashMap\u0026lt;\u0026gt;(runtimeConfig); } public ConfigurationSummary getConfigurationSummary() { Map\u0026lt;String, Object\u0026gt; activeProfiles = Map.of( \u0026#34;active\u0026#34;, Arrays.asList(environment.getActiveProfiles()), \u0026#34;default\u0026#34;, Arrays.asList(environment.getDefaultProfiles()) ); return new ConfigurationSummary(activeProfiles, runtimeConfig); } public void refreshConfiguration() { // åˆ·æ–°é…ç½®é‚è¼¯ applicationContext.publishEvent(new EnvironmentChangeEvent(runtimeConfig.keySet())); } } æ€§èƒ½å„ªåŒ–å’Œæœ€ä½³å¯¦è¸ 1. ç·©å­˜ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 @Service public class CachingFacade { @Autowired private CacheManager cacheManager; @Autowired private RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; public \u0026lt;T\u0026gt; T getFromCache(String cacheName, String key, Class\u0026lt;T\u0026gt; type, Supplier\u0026lt;T\u0026gt; valueLoader) { Cache cache = cacheManager.getCache(cacheName); if (cache != null) { Cache.ValueWrapper cached = cache.get(key); if (cached != null) { return type.cast(cached.get()); } } T value = valueLoader.get(); if (value != null \u0026amp;\u0026amp; cache != null) { cache.put(key, value); } return value; } public void evictFromCache(String cacheName, String key) { Cache cache = cacheManager.getCache(cacheName); if (cache != null) { cache.evict(key); } } public void clearCache(String cacheName) { Cache cache = cacheManager.getCache(cacheName); if (cache != null) { cache.clear(); } } public CacheStatistics getCacheStatistics(String cacheName) { // ç²å–ç·©å­˜çµ±è¨ˆä¿¡æ¯ return new CacheStatistics(cacheName, 0, 0, 0); // ç°¡åŒ–å¯¦ç¾ } } 2. æ‰¹è™•ç† Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @Service public class BatchProcessingFacade { @Autowired private TaskExecutor taskExecutor; private final Map\u0026lt;String, List\u0026lt;BatchOperation\u0026gt;\u0026gt; batchQueues = new ConcurrentHashMap\u0026lt;\u0026gt;(); public void addToBatch(String batchId, BatchOperation operation) { batchQueues.computeIfAbsent(batchId, k -\u0026gt; new ArrayList\u0026lt;\u0026gt;()).add(operation); } public CompletableFuture\u0026lt;BatchResult\u0026gt; processBatch(String batchId) { List\u0026lt;BatchOperation\u0026gt; operations = batchQueues.remove(batchId); if (operations == null || operations.isEmpty()) { return CompletableFuture.completedFuture(new BatchResult(batchId, 0, 0)); } return CompletableFuture.supplyAsync(() -\u0026gt; { int successful = 0; int failed = 0; for (BatchOperation operation : operations) { try { operation.execute(); successful++; } catch (Exception e) { failed++; } } return new BatchResult(batchId, successful, failed); }, taskExecutor); } public void schedulePeriodicBatch(String batchId, long interval) { ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1); scheduler.scheduleAtFixedRate(() -\u0026gt; { if (batchQueues.containsKey(batchId)) { processBatch(batchId); } }, interval, interval, TimeUnit.MILLISECONDS); } } 3. ç›£æ§ Facade 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 @Service public class MonitoringFacade { @Autowired private MeterRegistry meterRegistry; private final Map\u0026lt;String, Timer\u0026gt; timers = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final Map\u0026lt;String, Counter\u0026gt; counters = new ConcurrentHashMap\u0026lt;\u0026gt;(); public \u0026lt;T\u0026gt; T monitorOperation(String operationName, Supplier\u0026lt;T\u0026gt; operation) { Timer timer = timers.computeIfAbsent(operationName, name -\u0026gt; Timer.builder(name).register(meterRegistry)); Counter successCounter = counters.computeIfAbsent(operationName + \u0026#34;.success\u0026#34;, name -\u0026gt; Counter.builder(name).register(meterRegistry)); Counter errorCounter = counters.computeIfAbsent(operationName + \u0026#34;.error\u0026#34;, name -\u0026gt; Counter.builder(name).register(meterRegistry)); return timer.recordCallable(() -\u0026gt; { try { T result = operation.get(); successCounter.increment(); return result; } catch (Exception e) { errorCounter.increment(); throw e; } }); } public void recordMetric(String name, double value) { Gauge.builder(name) .register(meterRegistry, value, val -\u0026gt; val); } public void incrementCounter(String name) { Counter counter = counters.computeIfAbsent(name, counterName -\u0026gt; Counter.builder(counterName).register(meterRegistry)); counter.increment(); } public MetricsSummary getMetricsSummary() { return new MetricsSummary( timers.size(), counters.size(), meterRegistry.getMeters().size() ); } } æ¸¬è©¦ç­–ç•¥ 1. å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 @ExtendWith(MockitoExtension.class) class ECommerceFacadeTest { @Mock private UserService userService; @Mock private OrderService orderService; @Mock private PaymentService paymentService; @Mock private NotificationService notificationService; @InjectMocks private ECommerceFacade eCommerceFacade; @Test void testPlaceOrder_Success() { // æº–å‚™æ¸¬è©¦æ•¸æ“š OrderRequest request = new OrderRequest(); request.setUserId(1L); request.setItems(Arrays.asList(new OrderItem(\u0026#34;Product1\u0026#34;, 2, BigDecimal.valueOf(100)))); request.setPaymentMethod(PaymentMethod.CREDIT_CARD); User user = new User(1L, \u0026#34;John Doe\u0026#34;, \u0026#34;john@example.com\u0026#34;); Order order = new Order(1L, 1L, BigDecimal.valueOf(200)); Payment payment = new Payment(1L, 1L, BigDecimal.valueOf(200)); // æ¨¡æ“¬æœå‹™èª¿ç”¨ when(userService.findById(1L)).thenReturn(user); when(orderService.createOrder(any(Order.class))).thenReturn(order); when(paymentService.processPayment(any(Payment.class))).thenReturn(payment); // åŸ·è¡Œæ¸¬è©¦ OrderResult result = eCommerceFacade.placeOrder(request); // é©—è­‰çµæœ assertThat(result.getStatus()).isEqualTo(\u0026#34;SUCCESS\u0026#34;); assertThat(result.getOrder()).isNotNull(); assertThat(result.getPayment()).isNotNull(); // é©—è­‰æœå‹™èª¿ç”¨ verify(userService).findById(1L); verify(orderService).createOrder(any(Order.class)); verify(paymentService).processPayment(any(Payment.class)); verify(notificationService).sendEmail(eq(user.getEmail()), anyString(), anyString()); } @Test void testPlaceOrder_UserNotFound() { // æº–å‚™æ¸¬è©¦æ•¸æ“š OrderRequest request = new OrderRequest(); request.setUserId(999L); when(userService.findById(999L)).thenReturn(null); // åŸ·è¡Œæ¸¬è©¦ OrderResult result = eCommerceFacade.placeOrder(request); // é©—è­‰çµæœ assertThat(result.getStatus()).startsWith(\u0026#34;ERROR\u0026#34;); assertThat(result.getOrder()).isNull(); assertThat(result.getPayment()).isNull(); } } 2. é›†æˆæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @SpringBootTest @AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE) class ApiGatewayFacadeIntegrationTest { @Autowired private TestRestTemplate restTemplate; @MockBean private UserServiceClient userServiceClient; @MockBean private OrderServiceClient orderServiceClient; @Test void testGetUserProfile() { // æº–å‚™æ¸¬è©¦æ•¸æ“š User user = new User(1L, \u0026#34;John Doe\u0026#34;, \u0026#34;john@example.com\u0026#34;); List\u0026lt;Order\u0026gt; orders = Arrays.asList( new Order(1L, 1L, BigDecimal.valueOf(100)), new Order(2L, 1L, BigDecimal.valueOf(200)) ); when(userServiceClient.getUser(1L)).thenReturn(user); when(orderServiceClient.getOrdersByUserId(1L)).thenReturn(orders); // åŸ·è¡Œæ¸¬è©¦ ResponseEntity\u0026lt;UserProfile\u0026gt; response = restTemplate.getForEntity( \u0026#34;/api/v1/users/1/profile\u0026#34;, UserProfile.class); // é©—è­‰çµæœ assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK); assertThat(response.getBody().getUser()).isEqualTo(user); assertThat(response.getBody().getOrders()).hasSize(2); } } æœ€ä½³å¯¦è¸ 1. è¨­è¨ˆåŸå‰‡ å–®ä¸€è·è²¬: æ¯å€‹ Facade åªè² è²¬ä¸€å€‹æ¥­å‹™é ˜åŸŸ ç°¡åŒ–æ¥å£: æä¾›ç°¡æ½”æ˜“ç”¨çš„æ¥å£ æ¾è€¦åˆ: é¿å… Facade èˆ‡å­ç³»çµ±ç·Šå¯†è€¦åˆ å¯æ¸¬è©¦æ€§: ç¢ºä¿ Facade æ˜“æ–¼æ¸¬è©¦ 2. å¯¦ç¾å»ºè­° ä½¿ç”¨ä¾è³´æ³¨å…¥ç®¡ç†å­ç³»çµ±ä¾è³´ å¯¦ç¾é©ç•¶çš„ç•°å¸¸è™•ç† è€ƒæ…®ä½¿ç”¨ç•°æ­¥è™•ç†æé«˜æ€§èƒ½ æä¾›è©³ç´°çš„æ—¥èªŒè¨˜éŒ„ 3. æ€§èƒ½è€ƒæ…® ä½¿ç”¨ç·©å­˜æ¸›å°‘é‡è¤‡è¨ˆç®— å¯¦ç¾æ‰¹è™•ç†æ¸›å°‘ç¶²çµ¡èª¿ç”¨ è€ƒæ…®ä½¿ç”¨ä¸¦è¡Œè™•ç† ç›£æ§å’Œå„ªåŒ–é—œéµè·¯å¾‘ 4. å¸¸è¦‹é™·é˜± é¿å… Facade è®Šå¾—éæ–¼è¤‡é›œ ä¸è¦åœ¨ Facade ä¸­å¯¦ç¾æ¥­å‹™é‚è¼¯ é¿å… Facade ä¹‹é–“çš„å¾ªç’°ä¾è³´ æ³¨æ„äº‹å‹™é‚Šç•Œå’Œä¸€è‡´æ€§ é©ç”¨å ´æ™¯ ä½•æ™‚ä½¿ç”¨ è¤‡é›œå­ç³»çµ±: ç•¶å­ç³»çµ±éæ–¼è¤‡é›œæ™‚ å¤šæœå‹™é›†æˆ: éœ€è¦æ•´åˆå¤šå€‹æœå‹™æ™‚ API ç°¡åŒ–: éœ€è¦ç°¡åŒ– API æ¥å£æ™‚ å¾®æœå‹™èšåˆ: éœ€è¦èšåˆå¤šå€‹å¾®æœå‹™æ™‚ ä½•æ™‚é¿å… ç°¡å–®ç³»çµ±: ç•¶ç³»çµ±è¶³å¤ ç°¡å–®æ™‚ æ€§èƒ½é—œéµ: ç•¶é¡å¤–çš„æŠ½è±¡å±¤æœƒå½±éŸ¿æ€§èƒ½æ™‚ é »ç¹è®Šæ›´: ç•¶å­ç³»çµ±é »ç¹è®Šæ›´æ™‚ ç¸½çµ Facade Pattern æ˜¯ä¸€å€‹éå¸¸å¯¦ç”¨çš„è¨­è¨ˆæ¨¡å¼ï¼Œç‰¹åˆ¥é©åˆç¾ä»£ä¼æ¥­ç´šæ‡‰ç”¨å’Œå¾®æœå‹™æ¶æ§‹ã€‚é€šéæä¾›çµ±ä¸€çš„æ¥å£ï¼Œå®ƒèƒ½å¤ æœ‰æ•ˆåœ°éš±è—ç³»çµ±çš„è¤‡é›œæ€§ï¼Œæé«˜ç³»çµ±çš„å¯ç”¨æ€§å’Œå¯ç¶­è­·æ€§ã€‚\nåœ¨å¾®æœå‹™æ¶æ§‹ä¸­ï¼ŒFacade Pattern å¯ä»¥ä½œç‚º API Gateway æˆ–æœå‹™èšåˆå™¨ï¼Œå¹«åŠ©ç®¡ç†è¤‡é›œçš„æœå‹™é–“é€šä¿¡ã€‚çµåˆ Spring Boot çš„è‡ªå‹•é…ç½®å’Œä¾è³´æ³¨å…¥åŠŸèƒ½ï¼Œæˆ‘å€‘å¯ä»¥å‰µå»ºå‡ºæ—¢éˆæ´»åˆé«˜æ•ˆçš„ Facade å¯¦ç¾ã€‚\né—œéµæ˜¯è¦ç†è§£ä½•æ™‚ä½¿ç”¨ Facade Patternï¼Œä»¥åŠå¦‚ä½•æ­£ç¢ºåœ°è¨­è¨ˆå’Œå¯¦ç¾å®ƒã€‚é€šéåˆç†ä½¿ç”¨ Facade Patternï¼Œæˆ‘å€‘å¯ä»¥æ§‹å»ºå‡ºæ—¢ç°¡æ½”åˆåŠŸèƒ½å¼·å¤§çš„ä¼æ¥­ç´šæ‡‰ç”¨ç³»çµ±ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/facade/","tags":["Design Pattern","Structural","Facade","Spring","Microservices","Enterprise"],"title":"DesignPattern - Structural - Facade"},{"content":"Flyweight Flyweight ä¸­ï¼Œæˆ‘å€‘é‡è¤‡ä½¿ç”¨å°è±¡ï¼Œè€Œä¸æ˜¯å‰µå»ºå¤§é‡ç›¸ä¼¼çš„å°è±¡ã€‚æˆ‘å€‘å¯ä»¥ä½¿ç”¨å®ƒä¾†æ¸›å°‘å…§å­˜éœ€æ±‚å’Œå¯¦ä¾‹åŒ–æ™‚é–“ä»¥åŠç›¸é—œæˆæœ¬ã€‚\nåœ¨æˆ‘å€‘æ‡‰ç”¨ Flyweight ä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦è€ƒæ…®ä»¥ä¸‹å› ç´ ï¼š\nå¦‚æœæ‡‰ç”¨ç¨‹åºä¸­æ‰€éœ€çš„å°åƒæ•¸é‡å·¨å¤§ã€‚ å¦‚æœå°è±¡å‰µå»ºä½”ç”¨å¤§é‡å…§å­˜ä¸¦ä¸”ä¹Ÿå¯èƒ½å¾ˆè€—æ™‚ã€‚ å¤ªå¤šçš„å°è±¡æœƒé™ä½æ‡‰ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚é¡¯ç„¶ï¼Œå¤ªå¤šçš„å°è±¡å¯èƒ½æœƒæ¶ˆè€—æ›´å¤§çš„å…§å­˜ã€‚æ­¤å¤–ï¼Œå®ƒå€‘å¯èƒ½æœƒé™ä½æ‡‰ç”¨ç¨‹åºçš„é€Ÿåº¦ï¼Œç”šè‡³å¯èƒ½å°è‡´å…§å­˜ä¸è¶³å•é¡Œã€‚ åœ¨æ‡‰ç”¨ç¨‹åºä¸­æ§åˆ¶å®ƒã€‚ç•¶æˆ‘å€‘æœ‰å¾ˆå¤šç›¸ä¼¼çš„å°è±¡ä¸¦ä¸”æ± ä¸­çš„å…©å€‹å°è±¡ä¹‹é–“æ²’æœ‰å¤ªå¤šå·®ç•°æ™‚ï¼Œå°¤å…¶å¦‚æ­¤ã€‚ æœ‰æ™‚ï¼Œæ‡‰ç”¨ç¨‹åºä¸­çš„å°è±¡å¯èƒ½å…·æœ‰å¾ˆå¤§çš„ç›¸ä¼¼æ€§ä¸¦ä¸”å±¬æ–¼ç›¸ä¼¼é¡å‹ï¼ˆæ­¤è™•çš„ç›¸ä¼¼é¡å‹æ„å‘³è‘—å®ƒå€‘çš„å¤§å¤šæ•¸å±¬æ€§å…·æœ‰ç›¸ä¼¼çš„å€¼ï¼Œä¸¦ä¸”åªæœ‰å°‘æ•¸å±¬æ€§å€¼ä¸åŒï¼‰ã€‚å¦‚æœå®ƒå€‘ä¹Ÿæ˜¯è¦å‰µå»ºçš„é‡ç‰©ï¼Œæ‡‰ç”¨ç¨‹åºé–‹ç™¼äººå“¡æ‡‰è©²æ§åˆ¶å®ƒå€‘ã€‚å¦å‰‡ï¼Œå®ƒå€‘å¯èƒ½æœƒæ¶ˆè€—å¤§é‡å…§å­˜ä¸¦æœ€çµ‚æ¸›æ…¢æ•´å€‹æ‡‰ç”¨ç¨‹åºçš„é€Ÿåº¦ã€‚\nFlyweight æ—¨åœ¨æ§åˆ¶æ­¤é¡å°è±¡çš„å‰µå»ºï¼Œä¸¦ç‚ºæ‚¨æä¾›åŸºæœ¬çš„ç·©å­˜æ©Ÿåˆ¶ã€‚å®ƒå…è¨±æ‚¨ç‚ºæ¯ç¨®é¡å‹å‰µå»ºä¸€å€‹å°è±¡ï¼ˆæ­¤è™•çš„é¡å‹å› è©²å°è±¡çš„å±¬æ€§è€Œç•°ï¼‰ï¼Œå¦‚æœæ‚¨è«‹æ±‚å…·æœ‰ç›¸åŒå±¬æ€§çš„å°è±¡ï¼ˆå·²å‰µå»ºï¼‰ï¼Œå®ƒå°‡è¿”å›ç›¸åŒçš„å°è±¡è€Œä¸æ˜¯å‰µå»ºä¸€å€‹æ–°çš„å°è±¡ä¸€ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 public interface Msg { public void show(String msg); } public class EmergentMsg implements Msg { private String key; EmergentMsg(String key) { this.key = key; System.out.println(\u0026#34;send \u0026#34; + key + \u0026#34; emergent msg\u0026#34;); } public void show(String msg) { System.out.println(msg); } } public class MsgFactory { private static MsgFactory FACTORY = new MsgFactory(); private static Map\u0026lt;String, Msg\u0026gt; msgs = new HashMap\u0026lt;\u0026gt;(); public static MsgFactory getInstance() { // çœ‹è¦ä¸è¦ double lock check return FACTORY; } public Msg getMsg(String key) { Msg msg = (Msg)msgs.get(key); if (msg != null) { System.out.println(\u0026#34;msg \u0026#34; + key + \u0026#34; exist\u0026#34;); } else { msg = new EmergentMsg(key); msgs.put(key, msg); } return msg; } } æœ‰é»åƒè³‡æºé‡è¤‡ä½¿ç”¨ maybe, service locator pattern !?\n","permalink":"https://xinqilin.github.io/post/architecture/flyweight/","tags":[],"title":"DesignPattern - Structural - Flyweight"},{"content":"Proxy Pattern æ¦‚è¿° Proxy Pattern æ˜¯ä¸€ç¨®çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œå®ƒç‚ºå¦ä¸€å€‹å°è±¡æä¾›ä¸€å€‹ä»£ç†æˆ–å ä½ç¬¦ï¼Œä»¥æ§åˆ¶å°å®ƒçš„è¨ªå•ã€‚ä»£ç†å°è±¡èˆ‡åŸå§‹å°è±¡å…·æœ‰ç›¸åŒçš„æ¥å£ï¼Œå› æ­¤å®¢æˆ¶ç«¯å¯ä»¥é€æ˜åœ°ä½¿ç”¨ä»£ç†è€Œç„¡éœ€çŸ¥é“å®ƒå€‘æ­£åœ¨èˆ‡ä»£ç†äº¤äº’ã€‚\næ ¸å¿ƒæ¦‚å¿µ é—œéµç‰¹æ€§ è¨ªå•æ§åˆ¶: æ§åˆ¶å°åŸå§‹å°è±¡çš„è¨ªå• æ‡¶åŠ è¼‰: å»¶é²å°è±¡çš„å‰µå»ºç›´åˆ°çœŸæ­£éœ€è¦æ™‚ ç·©å­˜: ç·©å­˜çµæœä»¥æé«˜æ€§èƒ½ æ—¥èªŒè¨˜éŒ„: è¨˜éŒ„æ–¹æ³•èª¿ç”¨å’Œçµæœ æ¬Šé™æª¢æŸ¥: åœ¨è¨ªå•å‰é€²è¡Œå®‰å…¨æª¢æŸ¥ ä»£ç†é¡å‹ è™›æ“¬ä»£ç†: æ§åˆ¶å°æ˜‚è²´å°è±¡çš„è¨ªå• é ç¨‹ä»£ç†: æ§åˆ¶å°é ç¨‹å°è±¡çš„è¨ªå• ä¿è­·ä»£ç†: æ§åˆ¶å°æ•æ„Ÿå°è±¡çš„è¨ªå• æ™ºèƒ½ä»£ç†: æä¾›é¡å¤–åŠŸèƒ½å¦‚å¼•ç”¨è¨ˆæ•¸ã€ç·©å­˜ç­‰ çµæ§‹çµ„ä»¶ Subject: å®šç¾©ä»£ç†å’ŒçœŸå¯¦å°è±¡çš„å…±åŒæ¥å£ RealSubject: çœŸå¯¦å°è±¡ï¼Œå¯¦ç¾å¯¦éš›çš„æ¥­å‹™é‚è¼¯ Proxy: ä»£ç†å°è±¡ï¼Œæ§åˆ¶å°çœŸå¯¦å°è±¡çš„è¨ªå• åŸºæœ¬å¯¦ç¾ 1. ç¶“å…¸ä»£ç†å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 // ä¸»é¡Œæ¥å£ public interface Subject { void request(); String getData(); } // çœŸå¯¦å°è±¡ public class RealSubject implements Subject { private String data; public RealSubject() { // æ¨¡æ“¬æ˜‚è²´çš„åˆå§‹åŒ–éç¨‹ System.out.println(\u0026#34;RealSubject: Initializing...\u0026#34;); try { Thread.sleep(1000); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } this.data = \u0026#34;Important data\u0026#34;; System.out.println(\u0026#34;RealSubject: Initialized\u0026#34;); } @Override public void request() { System.out.println(\u0026#34;RealSubject: Handling request\u0026#34;); } @Override public String getData() { return data; } } // ä»£ç†å°è±¡ public class Proxy implements Subject { private RealSubject realSubject; private String cachedData; private boolean accessGranted; public Proxy(boolean accessGranted) { this.accessGranted = accessGranted; } @Override public void request() { if (!accessGranted) { System.out.println(\u0026#34;Proxy: Access denied\u0026#34;); return; } System.out.println(\u0026#34;Proxy: Checking access before request\u0026#34;); if (realSubject == null) { realSubject = new RealSubject(); } System.out.println(\u0026#34;Proxy: Logging request\u0026#34;); realSubject.request(); System.out.println(\u0026#34;Proxy: Request completed\u0026#34;); } @Override public String getData() { if (!accessGranted) { return \u0026#34;Access denied\u0026#34;; } // ç·©å­˜å¯¦ç¾ if (cachedData != null) { System.out.println(\u0026#34;Proxy: Returning cached data\u0026#34;); return cachedData; } if (realSubject == null) { realSubject = new RealSubject(); } cachedData = realSubject.getData(); System.out.println(\u0026#34;Proxy: Data cached\u0026#34;); return cachedData; } } 2. æ¸¬è©¦ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class ProxyPatternDemo { public static void main(String[] args) { System.out.println(\u0026#34;=== Testing with access granted ===\u0026#34;); Subject proxy1 = new Proxy(true); proxy1.request(); System.out.println(\u0026#34;\\n=== Testing caching ===\u0026#34;); String data1 = proxy1.getData(); String data2 = proxy1.getData(); // æ‡‰è©²è¿”å›ç·©å­˜æ•¸æ“š System.out.println(\u0026#34;\\n=== Testing with access denied ===\u0026#34;); Subject proxy2 = new Proxy(false); proxy2.request(); String data3 = proxy2.getData(); System.out.println(\u0026#34;Data1: \u0026#34; + data1); System.out.println(\u0026#34;Data2: \u0026#34; + data2); System.out.println(\u0026#34;Data3: \u0026#34; + data3); } } å‹•æ…‹ä»£ç†å¯¦ç¾ 1. Java å‹•æ…‹ä»£ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 // æ¥­å‹™æ¥å£ public interface UserService { User findById(Long id); User save(User user); void deleteById(Long id); List\u0026lt;User\u0026gt; findAll(); } // æ¥­å‹™å¯¦ç¾ public class UserServiceImpl implements UserService { private final Map\u0026lt;Long, User\u0026gt; users = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Override public User findById(Long id) { System.out.println(\u0026#34;UserServiceImpl: Finding user with id \u0026#34; + id); return users.get(id); } @Override public User save(User user) { System.out.println(\u0026#34;UserServiceImpl: Saving user \u0026#34; + user.getName()); users.put(user.getId(), user); return user; } @Override public void deleteById(Long id) { System.out.println(\u0026#34;UserServiceImpl: Deleting user with id \u0026#34; + id); users.remove(id); } @Override public List\u0026lt;User\u0026gt; findAll() { System.out.println(\u0026#34;UserServiceImpl: Finding all users\u0026#34;); return new ArrayList\u0026lt;\u0026gt;(users.values()); } } // å‹•æ…‹ä»£ç†è™•ç†å™¨ public class ServiceInvocationHandler implements InvocationHandler { private final Object target; private final Map\u0026lt;String, Object\u0026gt; cache = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final Set\u0026lt;String\u0026gt; cacheableMethods = Set.of(\u0026#34;findById\u0026#34;, \u0026#34;findAll\u0026#34;); public ServiceInvocationHandler(Object target) { this.target = target; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { String methodName = method.getName(); // æ—¥èªŒè¨˜éŒ„ System.out.println(\u0026#34;Proxy: Before method \u0026#34; + methodName); long startTime = System.currentTimeMillis(); try { // ç·©å­˜é‚è¼¯ if (cacheableMethods.contains(methodName)) { String cacheKey = generateCacheKey(methodName, args); Object cachedResult = cache.get(cacheKey); if (cachedResult != null) { System.out.println(\u0026#34;Proxy: Returning cached result for \u0026#34; + methodName); return cachedResult; } Object result = method.invoke(target, args); cache.put(cacheKey, result); System.out.println(\u0026#34;Proxy: Result cached for \u0026#34; + methodName); return result; } // æ¸…é™¤ç·©å­˜é‚è¼¯ if (methodName.startsWith(\u0026#34;save\u0026#34;) || methodName.startsWith(\u0026#34;delete\u0026#34;)) { cache.clear(); System.out.println(\u0026#34;Proxy: Cache cleared due to \u0026#34; + methodName); } return method.invoke(target, args); } catch (Exception e) { System.out.println(\u0026#34;Proxy: Exception in method \u0026#34; + methodName + \u0026#34;: \u0026#34; + e.getMessage()); throw e; } finally { long endTime = System.currentTimeMillis(); System.out.println(\u0026#34;Proxy: Method \u0026#34; + methodName + \u0026#34; completed in \u0026#34; + (endTime - startTime) + \u0026#34;ms\u0026#34;); } } private String generateCacheKey(String methodName, Object[] args) { return methodName + \u0026#34;:\u0026#34; + Arrays.toString(args); } } // ä»£ç†å·¥å»  public class ProxyFactory { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public static \u0026lt;T\u0026gt; T createProxy(T target, Class\u0026lt;T\u0026gt; interfaceClass) { return (T) Proxy.newProxyInstance( interfaceClass.getClassLoader(), new Class[]{interfaceClass}, new ServiceInvocationHandler(target) ); } } 2. ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class DynamicProxyDemo { public static void main(String[] args) { UserService userService = new UserServiceImpl(); UserService proxy = ProxyFactory.createProxy(userService, UserService.class); // æ¸¬è©¦ç·©å­˜ User user = new User(1L, \u0026#34;John Doe\u0026#34;); proxy.save(user); // ç¬¬ä¸€æ¬¡æŸ¥è©¢ User found1 = proxy.findById(1L); // ç¬¬äºŒæ¬¡æŸ¥è©¢ï¼ˆæ‡‰è©²å¾ç·©å­˜ç²å–ï¼‰ User found2 = proxy.findById(1L); // ä¿®æ”¹æ•¸æ“šï¼ˆæ‡‰è©²æ¸…é™¤ç·©å­˜ï¼‰ proxy.save(new User(2L, \u0026#34;Jane Smith\u0026#34;)); // å†æ¬¡æŸ¥è©¢ï¼ˆæ‡‰è©²é‡æ–°åŸ·è¡Œï¼‰ User found3 = proxy.findById(1L); } } Spring AOP ä»£ç† 1. Spring AOP è¨»è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // è‡ªå®šç¾©è¨»è§£ @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) public @interface Cacheable { String value() default \u0026#34;\u0026#34;; int ttl() default 300; boolean condition() default true; } @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) public @interface RateLimited { int value() default 10; // requests per second String key() default \u0026#34;\u0026#34;; } @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) public @interface Audited { String value() default \u0026#34;\u0026#34;; AuditLevel level() default AuditLevel.INFO; } @Target({ElementType.METHOD, ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) public @interface Secured { String[] roles() default {}; String[] permissions() default {}; } // å¯©è¨ˆç´šåˆ¥ public enum AuditLevel { INFO, WARN, ERROR } 2. Spring AOP åˆ‡é¢å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 @Aspect @Component public class CachingAspect { @Autowired private CacheManager cacheManager; @Around(\u0026#34;@annotation(cacheable)\u0026#34;) public Object cacheResult(ProceedingJoinPoint joinPoint, Cacheable cacheable) throws Throwable { String cacheName = cacheable.value().isEmpty() ? joinPoint.getSignature().getDeclaringType().getSimpleName() : cacheable.value(); Cache cache = cacheManager.getCache(cacheName); if (cache == null) { return joinPoint.proceed(); } String key = generateCacheKey(joinPoint); Cache.ValueWrapper cachedValue = cache.get(key); if (cachedValue != null) { return cachedValue.get(); } Object result = joinPoint.proceed(); cache.put(key, result); return result; } private String generateCacheKey(ProceedingJoinPoint joinPoint) { StringBuilder keyBuilder = new StringBuilder(); keyBuilder.append(joinPoint.getSignature().getName()); for (Object arg : joinPoint.getArgs()) { keyBuilder.append(\u0026#34;:\u0026#34;).append(arg); } return keyBuilder.toString(); } } @Aspect @Component public class RateLimitingAspect { private final Map\u0026lt;String, RateLimiter\u0026gt; rateLimiters = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Before(\u0026#34;@annotation(rateLimited)\u0026#34;) public void checkRateLimit(JoinPoint joinPoint, RateLimited rateLimited) { String key = rateLimited.key().isEmpty() ? joinPoint.getSignature().toShortString() : rateLimited.key(); RateLimiter rateLimiter = rateLimiters.computeIfAbsent(key, k -\u0026gt; RateLimiter.create(rateLimited.value())); if (!rateLimiter.tryAcquire()) { throw new RateLimitExceededException(\u0026#34;Rate limit exceeded for \u0026#34; + key); } } } @Aspect @Component public class AuditingAspect { private static final Logger logger = LoggerFactory.getLogger(AuditingAspect.class); @Around(\u0026#34;@annotation(audited)\u0026#34;) public Object audit(ProceedingJoinPoint joinPoint, Audited audited) throws Throwable { String methodName = joinPoint.getSignature().getName(); String auditMessage = audited.value().isEmpty() ? methodName : audited.value(); logger.info(\u0026#34;Audit: Starting method {} with args: {}\u0026#34;, methodName, Arrays.toString(joinPoint.getArgs())); long startTime = System.currentTimeMillis(); try { Object result = joinPoint.proceed(); long endTime = System.currentTimeMillis(); logger.info(\u0026#34;Audit: Method {} completed successfully in {}ms\u0026#34;, methodName, endTime - startTime); return result; } catch (Exception e) { logger.error(\u0026#34;Audit: Method {} failed with exception: {}\u0026#34;, methodName, e.getMessage()); throw e; } } } @Aspect @Component public class SecurityAspect { @Autowired private SecurityService securityService; @Before(\u0026#34;@annotation(secured)\u0026#34;) public void checkSecurity(JoinPoint joinPoint, Secured secured) { String[] requiredRoles = secured.roles(); String[] requiredPermissions = secured.permissions(); Authentication authentication = SecurityContextHolder.getContext().getAuthentication(); if (authentication == null || !authentication.isAuthenticated()) { throw new SecurityException(\u0026#34;User not authenticated\u0026#34;); } if (requiredRoles.length \u0026gt; 0) { for (String role : requiredRoles) { if (!securityService.hasRole(authentication, role)) { throw new SecurityException(\u0026#34;Insufficient role: \u0026#34; + role); } } } if (requiredPermissions.length \u0026gt; 0) { for (String permission : requiredPermissions) { if (!securityService.hasPermission(authentication, permission)) { throw new SecurityException(\u0026#34;Insufficient permission: \u0026#34; + permission); } } } } } 3. ä½¿ç”¨ AOP ä»£ç†çš„æœå‹™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @Service @Transactional public class EnhancedUserService implements UserService { @Autowired private UserRepository userRepository; @Override @Cacheable(value = \u0026#34;users\u0026#34;, ttl = 600) @RateLimited(value = 20) @Audited(\u0026#34;Finding user by ID\u0026#34;) @Secured(permissions = {\u0026#34;USER_READ\u0026#34;}) public User findById(Long id) { return userRepository.findById(id).orElse(null); } @Override @RateLimited(value = 5) @Audited(\u0026#34;Saving user\u0026#34;) @Secured(permissions = {\u0026#34;USER_WRITE\u0026#34;}) public User save(User user) { return userRepository.save(user); } @Override @RateLimited(value = 2) @Audited(value = \u0026#34;Deleting user\u0026#34;, level = AuditLevel.WARN) @Secured(permissions = {\u0026#34;USER_DELETE\u0026#34;}) public void deleteById(Long id) { userRepository.deleteById(id); } @Override @Cacheable(value = \u0026#34;users\u0026#34;, ttl = 300) @RateLimited(value = 10) @Audited(\u0026#34;Finding all users\u0026#34;) @Secured(permissions = {\u0026#34;USER_READ\u0026#34;}) public List\u0026lt;User\u0026gt; findAll() { return userRepository.findAll(); } } ä¼æ¥­ç´šä»£ç†æ¨¡å¼ 1. æ•¸æ“šåº«é€£æ¥æ± ä»£ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 // æ•¸æ“šåº«é€£æ¥æ¥å£ public interface DatabaseConnection { ResultSet executeQuery(String sql); int executeUpdate(String sql); void close(); boolean isClosed(); } // çœŸå¯¦é€£æ¥å¯¦ç¾ public class RealDatabaseConnection implements DatabaseConnection { private final Connection connection; public RealDatabaseConnection(String url, String username, String password) throws SQLException { this.connection = DriverManager.getConnection(url, username, password); } @Override public ResultSet executeQuery(String sql) { try { return connection.createStatement().executeQuery(sql); } catch (SQLException e) { throw new RuntimeException(\u0026#34;Query execution failed\u0026#34;, e); } } @Override public int executeUpdate(String sql) { try { return connection.createStatement().executeUpdate(sql); } catch (SQLException e) { throw new RuntimeException(\u0026#34;Update execution failed\u0026#34;, e); } } @Override public void close() { try { connection.close(); } catch (SQLException e) { throw new RuntimeException(\u0026#34;Connection close failed\u0026#34;, e); } } @Override public boolean isClosed() { try { return connection.isClosed(); } catch (SQLException e) { return true; } } } // é€£æ¥æ± ä»£ç† public class ConnectionPoolProxy implements DatabaseConnection { private final DatabaseConnection realConnection; private final ConnectionPool pool; private boolean closed = false; public ConnectionPoolProxy(DatabaseConnection realConnection, ConnectionPool pool) { this.realConnection = realConnection; this.pool = pool; } @Override public ResultSet executeQuery(String sql) { if (closed) { throw new IllegalStateException(\u0026#34;Connection is closed\u0026#34;); } return realConnection.executeQuery(sql); } @Override public int executeUpdate(String sql) { if (closed) { throw new IllegalStateException(\u0026#34;Connection is closed\u0026#34;); } return realConnection.executeUpdate(sql); } @Override public void close() { if (!closed) { closed = true; pool.returnConnection(realConnection); } } @Override public boolean isClosed() { return closed; } } // é€£æ¥æ± å¯¦ç¾ @Component public class ConnectionPool { private final Queue\u0026lt;DatabaseConnection\u0026gt; availableConnections = new ConcurrentLinkedQueue\u0026lt;\u0026gt;(); private final Set\u0026lt;DatabaseConnection\u0026gt; usedConnections = ConcurrentHashMap.newKeySet(); private final String url; private final String username; private final String password; private final int maxPoolSize; public ConnectionPool(@Value(\u0026#34;${db.url}\u0026#34;) String url, @Value(\u0026#34;${db.username}\u0026#34;) String username, @Value(\u0026#34;${db.password}\u0026#34;) String password, @Value(\u0026#34;${db.pool.maxSize:10}\u0026#34;) int maxPoolSize) { this.url = url; this.username = username; this.password = password; this.maxPoolSize = maxPoolSize; // åˆå§‹åŒ–é€£æ¥æ±  initializePool(); } private void initializePool() { for (int i = 0; i \u0026lt; maxPoolSize / 2; i++) { try { availableConnections.offer(new RealDatabaseConnection(url, username, password)); } catch (SQLException e) { throw new RuntimeException(\u0026#34;Failed to initialize connection pool\u0026#34;, e); } } } public DatabaseConnection getConnection() { DatabaseConnection connection = availableConnections.poll(); if (connection == null) { if (usedConnections.size() \u0026lt; maxPoolSize) { try { connection = new RealDatabaseConnection(url, username, password); } catch (SQLException e) { throw new RuntimeException(\u0026#34;Failed to create new connection\u0026#34;, e); } } else { throw new RuntimeException(\u0026#34;Connection pool exhausted\u0026#34;); } } usedConnections.add(connection); return new ConnectionPoolProxy(connection, this); } public void returnConnection(DatabaseConnection connection) { if (usedConnections.remove(connection)) { if (!connection.isClosed()) { availableConnections.offer(connection); } } } } 2. å¾®æœå‹™ä»£ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 // å¾®æœå‹™å®¢æˆ¶ç«¯æ¥å£ public interface OrderService { Order createOrder(Order order); Order getOrder(Long orderId); List\u0026lt;Order\u0026gt; getOrdersByUserId(Long userId); void cancelOrder(Long orderId); } // é ç¨‹æœå‹™ä»£ç† @Component public class OrderServiceProxy implements OrderService { @Autowired private RestTemplate restTemplate; @Value(\u0026#34;${order.service.url}\u0026#34;) private String orderServiceUrl; private final CircuitBreaker circuitBreaker; private final Cache cache; public OrderServiceProxy(CircuitBreaker circuitBreaker, Cache cache) { this.circuitBreaker = circuitBreaker; this.cache = cache; } @Override @Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000)) public Order createOrder(Order order) { return circuitBreaker.executeSupplier(() -\u0026gt; { String url = orderServiceUrl + \u0026#34;/orders\u0026#34;; return restTemplate.postForObject(url, order, Order.class); }); } @Override public Order getOrder(Long orderId) { String cacheKey = \u0026#34;order:\u0026#34; + orderId; Order cachedOrder = cache.get(cacheKey, Order.class); if (cachedOrder != null) { return cachedOrder; } Order order = circuitBreaker.executeSupplier(() -\u0026gt; { String url = orderServiceUrl + \u0026#34;/orders/\u0026#34; + orderId; return restTemplate.getForObject(url, Order.class); }); if (order != null) { cache.put(cacheKey, order); } return order; } @Override public List\u0026lt;Order\u0026gt; getOrdersByUserId(Long userId) { String cacheKey = \u0026#34;orders:user:\u0026#34; + userId; List\u0026lt;Order\u0026gt; cachedOrders = cache.get(cacheKey, List.class); if (cachedOrders != null) { return cachedOrders; } List\u0026lt;Order\u0026gt; orders = circuitBreaker.executeSupplier(() -\u0026gt; { String url = orderServiceUrl + \u0026#34;/orders?userId=\u0026#34; + userId; return Arrays.asList(restTemplate.getForObject(url, Order[].class)); }); if (orders != null) { cache.put(cacheKey, orders); } return orders; } @Override public void cancelOrder(Long orderId) { circuitBreaker.executeSupplier(() -\u0026gt; { String url = orderServiceUrl + \u0026#34;/orders/\u0026#34; + orderId + \u0026#34;/cancel\u0026#34;; restTemplate.put(url, null); // æ¸…é™¤ç›¸é—œç·©å­˜ cache.evict(\u0026#34;order:\u0026#34; + orderId); return null; }); } } 3. ç·©å­˜ä»£ç†å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 // å¤šç´šç·©å­˜ä»£ç† @Component public class MultiLevelCacheProxy\u0026lt;T\u0026gt; { private final Cache l1Cache; // æœ¬åœ°ç·©å­˜ private final Cache l2Cache; // åˆ†å¸ƒå¼ç·©å­˜ private final int l1Ttl; private final int l2Ttl; public MultiLevelCacheProxy(@Qualifier(\u0026#34;l1Cache\u0026#34;) Cache l1Cache, @Qualifier(\u0026#34;l2Cache\u0026#34;) Cache l2Cache, @Value(\u0026#34;${cache.l1.ttl:300}\u0026#34;) int l1Ttl, @Value(\u0026#34;${cache.l2.ttl:3600}\u0026#34;) int l2Ttl) { this.l1Cache = l1Cache; this.l2Cache = l2Cache; this.l1Ttl = l1Ttl; this.l2Ttl = l2Ttl; } public T get(String key, Class\u0026lt;T\u0026gt; type, Supplier\u0026lt;T\u0026gt; dataLoader) { // å…ˆæŸ¥ L1 ç·©å­˜ T value = l1Cache.get(key, type); if (value != null) { return value; } // å†æŸ¥ L2 ç·©å­˜ value = l2Cache.get(key, type); if (value != null) { // å›å¯«åˆ° L1 ç·©å­˜ l1Cache.put(key, value); return value; } // å¾æ•¸æ“šæºåŠ è¼‰ value = dataLoader.get(); if (value != null) { // å¯«å…¥ L2 ç·©å­˜ l2Cache.put(key, value); // å¯«å…¥ L1 ç·©å­˜ l1Cache.put(key, value); } return value; } public void put(String key, T value) { l1Cache.put(key, value); l2Cache.put(key, value); } public void evict(String key) { l1Cache.evict(key); l2Cache.evict(key); } } // æ™ºèƒ½ç·©å­˜ä»£ç† @Component public class SmartCacheProxy { private final RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; private final Map\u0026lt;String, LocalDateTime\u0026gt; accessTimes = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final Map\u0026lt;String, Integer\u0026gt; hitCounts = new ConcurrentHashMap\u0026lt;\u0026gt;(); public SmartCacheProxy(RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate) { this.redisTemplate = redisTemplate; } public \u0026lt;T\u0026gt; T get(String key, Class\u0026lt;T\u0026gt; type, Supplier\u0026lt;T\u0026gt; dataLoader) { // è¨˜éŒ„è¨ªå•æ™‚é–“ accessTimes.put(key, LocalDateTime.now()); // å˜—è©¦å¾ç·©å­˜ç²å– Object cached = redisTemplate.opsForValue().get(key); if (cached != null) { // å¢åŠ å‘½ä¸­æ¬¡æ•¸ hitCounts.merge(key, 1, Integer::sum); return type.cast(cached); } // å¾æ•¸æ“šæºåŠ è¼‰ T value = dataLoader.get(); if (value != null) { // å‹•æ…‹ TTL ç­–ç•¥ int ttl = calculateTtl(key); redisTemplate.opsForValue().set(key, value, ttl, TimeUnit.SECONDS); } return value; } private int calculateTtl(String key) { int baseTime = 300; // 5åˆ†é˜ int hitCount = hitCounts.getOrDefault(key, 0); // ç†±é»æ•¸æ“šå»¶é•·ç·©å­˜æ™‚é–“ if (hitCount \u0026gt; 100) { return baseTime * 4; // 20åˆ†é˜ } else if (hitCount \u0026gt; 50) { return baseTime * 2; // 10åˆ†é˜ } return baseTime; } } Spring Boot é›†æˆ 1. è‡ªå‹•é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 @Configuration @EnableAspectJAutoProxy @EnableConfigurationProperties(ProxyProperties.class) public class ProxyAutoConfiguration { @Bean @ConditionalOnMissingBean public CacheManager cacheManager() { return new ConcurrentMapCacheManager(); } @Bean @ConditionalOnMissingBean public CachingAspect cachingAspect(CacheManager cacheManager) { return new CachingAspect(); } @Bean @ConditionalOnMissingBean public RateLimitingAspect rateLimitingAspect() { return new RateLimitingAspect(); } @Bean @ConditionalOnMissingBean public AuditingAspect auditingAspect() { return new AuditingAspect(); } @Bean @ConditionalOnMissingBean public SecurityAspect securityAspect() { return new SecurityAspect(); } @Bean @ConditionalOnProperty(prefix = \u0026#34;proxy.connection-pool\u0026#34;, name = \u0026#34;enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public ConnectionPool connectionPool(ProxyProperties properties) { ProxyProperties.ConnectionPool poolConfig = properties.getConnectionPool(); return new ConnectionPool( poolConfig.getUrl(), poolConfig.getUsername(), poolConfig.getPassword(), poolConfig.getMaxSize() ); } } // é…ç½®å±¬æ€§ @ConfigurationProperties(prefix = \u0026#34;proxy\u0026#34;) @Data public class ProxyProperties { private Cache cache = new Cache(); private RateLimit rateLimit = new RateLimit(); private ConnectionPool connectionPool = new ConnectionPool(); @Data public static class Cache { private boolean enabled = true; private int defaultTtl = 300; private String[] cacheNames = {\u0026#34;default\u0026#34;}; } @Data public static class RateLimit { private boolean enabled = true; private int defaultRate = 10; private TimeUnit timeUnit = TimeUnit.SECONDS; } @Data public static class ConnectionPool { private boolean enabled = false; private String url; private String username; private String password; private int maxSize = 10; private int minSize = 2; } } 2. ä½¿ç”¨é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # application.yml proxy: cache: enabled: true default-ttl: 600 cache-names: - users - orders - products rate-limit: enabled: true default-rate: 20 time-unit: SECONDS connection-pool: enabled: true url: jdbc:mysql://localhost:3306/mydb username: user password: password max-size: 20 min-size: 5 spring: cache: type: redis redis: host: localhost port: 6379 æ€§èƒ½ç›£æ§å’Œæ¸¬è©¦ 1. æ€§èƒ½ç›£æ§ä»£ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @Component public class PerformanceMonitoringProxy { private final MeterRegistry meterRegistry; private final Map\u0026lt;String, Timer\u0026gt; timers = new ConcurrentHashMap\u0026lt;\u0026gt;(); public PerformanceMonitoringProxy(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; } public \u0026lt;T\u0026gt; T monitor(String operationName, Supplier\u0026lt;T\u0026gt; operation) { Timer timer = timers.computeIfAbsent(operationName, name -\u0026gt; Timer.builder(name) .description(\u0026#34;Operation performance timer\u0026#34;) .register(meterRegistry)); return timer.recordCallable(() -\u0026gt; { Counter.builder(\u0026#34;operation.calls\u0026#34;) .tag(\u0026#34;operation\u0026#34;, operationName) .register(meterRegistry) .increment(); try { T result = operation.get(); Counter.builder(\u0026#34;operation.success\u0026#34;) .tag(\u0026#34;operation\u0026#34;, operationName) .register(meterRegistry) .increment(); return result; } catch (Exception e) { Counter.builder(\u0026#34;operation.error\u0026#34;) .tag(\u0026#34;operation\u0026#34;, operationName) .tag(\u0026#34;error\u0026#34;, e.getClass().getSimpleName()) .register(meterRegistry) .increment(); throw e; } }); } } 2. æ¸¬è©¦ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 @ExtendWith(MockitoExtension.class) class ProxyPatternTest { @Mock private UserService mockUserService; @Mock private CacheManager mockCacheManager; @Mock private Cache mockCache; @Test void testCachingProxy() { // æº–å‚™æ¸¬è©¦æ•¸æ“š User user = new User(1L, \u0026#34;John Doe\u0026#34;); when(mockUserService.findById(1L)).thenReturn(user); when(mockCacheManager.getCache(\u0026#34;users\u0026#34;)).thenReturn(mockCache); when(mockCache.get(\u0026#34;findById:1\u0026#34;)).thenReturn(null, new SimpleValueWrapper(user)); // å‰µå»ºä»£ç† UserService proxy = ProxyFactory.createProxy(mockUserService, UserService.class); // ç¬¬ä¸€æ¬¡èª¿ç”¨ User result1 = proxy.findById(1L); assertEquals(user, result1); // ç¬¬äºŒæ¬¡èª¿ç”¨æ‡‰è©²å¾ç·©å­˜ç²å– User result2 = proxy.findById(1L); assertEquals(user, result2); // é©—è­‰åªèª¿ç”¨äº†ä¸€æ¬¡å¯¦éš›æœå‹™ verify(mockUserService, times(1)).findById(1L); } @Test void testRateLimitingProxy() throws InterruptedException { RateLimiter rateLimiter = RateLimiter.create(1.0); // 1 request per second // ç¬¬ä¸€æ¬¡èª¿ç”¨æ‡‰è©²æˆåŠŸ assertTrue(rateLimiter.tryAcquire()); // ç«‹å³ç¬¬äºŒæ¬¡èª¿ç”¨æ‡‰è©²å¤±æ•— assertFalse(rateLimiter.tryAcquire()); // ç­‰å¾…ä¸€ç§’å¾Œæ‡‰è©²å¯ä»¥å†æ¬¡èª¿ç”¨ Thread.sleep(1100); assertTrue(rateLimiter.tryAcquire()); } } @SpringBootTest class ProxyIntegrationTest { @Autowired private UserService userService; @MockBean private UserRepository userRepository; @Test void testAopProxy() { User user = new User(1L, \u0026#34;John Doe\u0026#34;); when(userRepository.findById(1L)).thenReturn(Optional.of(user)); // æ¸¬è©¦ç·©å­˜ User result1 = userService.findById(1L); User result2 = userService.findById(1L); assertEquals(user, result1); assertEquals(user, result2); // ç”±æ–¼ç·©å­˜ï¼Œåªæ‡‰è©²èª¿ç”¨ä¸€æ¬¡ verify(userRepository, times(1)).findById(1L); } } æœ€ä½³å¯¦è¸ 1. è¨­è¨ˆåŸå‰‡ é€æ˜æ€§: ä»£ç†æ‡‰è©²å°å®¢æˆ¶ç«¯é€æ˜ å–®ä¸€è·è²¬: æ¯å€‹ä»£ç†åªè™•ç†ä¸€å€‹é—œæ³¨é» æ€§èƒ½: é¿å…ä¸å¿…è¦çš„ä»£ç†å±¤ ç·šç¨‹å®‰å…¨: ç¢ºä¿ä»£ç†æ˜¯ç·šç¨‹å®‰å…¨çš„ 2. å¯¦ç¾å»ºè­° ä½¿ç”¨æ¥å£è€Œä¸æ˜¯å…·é«”é¡ è€ƒæ…®ä½¿ç”¨çµ„åˆè€Œéç¹¼æ‰¿ å¯¦ç¾é©ç•¶çš„éŒ¯èª¤è™•ç† æä¾›é…ç½®é¸é … 3. æ€§èƒ½è€ƒæ…® é¿å…éåº¦ä»£ç† ä½¿ç”¨åˆé©çš„ç·©å­˜ç­–ç•¥ ç›£æ§ä»£ç†æ€§èƒ½ è€ƒæ…®ç•°æ­¥è™•ç† 4. å¸¸è¦‹é™·é˜± é¿å…ç„¡é™éæ­¸ æ³¨æ„å…§å­˜æ´©æ¼ æ­£ç¢ºè™•ç†ç•°å¸¸ è€ƒæ…®ä¸¦ç™¼å•é¡Œ é©ç”¨å ´æ™¯ ä½•æ™‚ä½¿ç”¨ è¨ªå•æ§åˆ¶: éœ€è¦æ§åˆ¶å°å°è±¡çš„è¨ªå• æ‡¶åŠ è¼‰: å»¶é²å°è±¡çš„å‰µå»º ç·©å­˜: ç·©å­˜æ˜‚è²´çš„æ“ä½œçµæœ é ç¨‹è¨ªå•: è¨ªå•é ç¨‹å°è±¡ æ—¥èªŒè¨˜éŒ„: è¨˜éŒ„æ–¹æ³•èª¿ç”¨ ä½•æ™‚é¿å… ç°¡å–®å ´æ™¯: ç•¶ä»£ç†æ²’æœ‰æä¾›é¡å¤–åƒ¹å€¼æ™‚ æ€§èƒ½é—œéµ: ç•¶ä»£ç†æœƒé¡¯è‘—å½±éŸ¿æ€§èƒ½æ™‚ éåº¦è¤‡é›œ: ç•¶ä»£ç†å±¤æ¬¡éå¤šæ™‚ ç¸½çµ Proxy Pattern æ˜¯ä¸€å€‹éå¸¸å¼·å¤§å’Œéˆæ´»çš„è¨­è¨ˆæ¨¡å¼ï¼Œç‰¹åˆ¥æ˜¯åœ¨ä¼æ¥­ç´šæ‡‰ç”¨ä¸­ã€‚é€šéèˆ‡ Spring AOP çš„çµåˆï¼Œæˆ‘å€‘å¯ä»¥å‰µå»ºå‡ºéå¸¸å„ªé›…å’ŒåŠŸèƒ½è±å¯Œçš„ä»£ç†å¯¦ç¾ã€‚\nç¾ä»£ Java çš„å‹•æ…‹ä»£ç†æ©Ÿåˆ¶ç‚ºæˆ‘å€‘æä¾›äº†å¼·å¤§çš„å·¥å…·ä¾†å¯¦ç¾å„ç¨®ä»£ç†æ¨¡å¼ï¼Œè€Œ Spring Boot çš„è‡ªå‹•é…ç½®åŠŸèƒ½ä½¿å¾—é›†æˆè®Šå¾—éå¸¸ç°¡å–®ã€‚\né—œéµæ˜¯è¦ç†è§£ä¸åŒé¡å‹çš„ä»£ç†æ¨¡å¼ï¼Œä»¥åŠå¦‚ä½•æ ¹æ“šå…·é«”éœ€æ±‚é¸æ“‡åˆé©çš„å¯¦ç¾æ–¹å¼ã€‚é€šéåˆç†ä½¿ç”¨ä»£ç†æ¨¡å¼ï¼Œæˆ‘å€‘å¯ä»¥æ§‹å»ºå‡ºæ—¢é«˜æ•ˆåˆæ˜“æ–¼ç¶­è­·çš„ä¼æ¥­ç´šæ‡‰ç”¨ç³»çµ±ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/proxy/","tags":["Design Pattern","Structural","Proxy","AOP","Spring","Caching"],"title":"DesignPattern - Structural - Proxy"},{"content":"Composite Pattern æ¦‚è¿° Composite Pattern è®“å®¢æˆ¶ç«¯å¯ä»¥çµ±ä¸€è™•ç†å–®å€‹å°è±¡å’Œå°è±¡çš„çµ„åˆã€‚å®ƒå°‡å°è±¡çµ„ç¹”æˆæ¨¹ç‹€çµæ§‹ï¼Œä½¿å¾—å®¢æˆ¶ç«¯èƒ½å¤ ä»¥ä¸€è‡´çš„æ–¹å¼è™•ç†å€‹åˆ¥å°è±¡å’Œçµ„åˆå°è±¡ã€‚\næ ¸å¿ƒæ¦‚å¿µ çµæ§‹çµ„ä»¶ Component: æ‰€æœ‰çµ„åˆå°è±¡çš„é€šç”¨æ¥å£ï¼Œå®šç¾©äº†è‘‰å­å’Œçµ„åˆç¯€é»çš„å…±åŒæ“ä½œ Leaf: è‘‰å­ç¯€é»ï¼Œå¯¦ç¾ Component æ¥å£ï¼Œä¸åŒ…å«å­ç¯€é» Composite: çµ„åˆç¯€é»ï¼ŒåŒ…å«å­ç¯€é»ï¼ˆå¯ä»¥æ˜¯è‘‰å­æˆ–å…¶ä»–çµ„åˆç¯€é»ï¼‰ é—œéµç‰¹æ€§ çµ±ä¸€æ“ä½œ: å°è‘‰å­å’Œçµ„åˆç¯€é»åŸ·è¡Œç›¸åŒçš„æ“ä½œ æ¨¹ç‹€çµæ§‹: æ”¯æŒéæ­¸çµ„åˆ é€æ˜æ€§: å®¢æˆ¶ç«¯ä¸éœ€è¦å€åˆ†è‘‰å­å’Œçµ„åˆç¯€é» åŸºæœ¬å¯¦ç¾ 1. å“¡å·¥å±¤æ¬¡çµæ§‹ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 // Component æ¥å£ public interface Employee { void add(Employee employee); void remove(Employee employee); Employee getChild(int index); String getName(); double getSalary(); void print(); void printStructure(String indent); } // Leaf å¯¦ç¾ - é–‹ç™¼è€… public class Developer implements Employee { private String name; private double salary; private String position; public Developer(String name, double salary, String position) { this.name = name; this.salary = salary; this.position = position; } @Override public void add(Employee employee) { throw new UnsupportedOperationException(\u0026#34;Developer cannot add employees\u0026#34;); } @Override public void remove(Employee employee) { throw new UnsupportedOperationException(\u0026#34;Developer cannot remove employees\u0026#34;); } @Override public Employee getChild(int index) { throw new UnsupportedOperationException(\u0026#34;Developer has no children\u0026#34;); } @Override public String getName() { return name; } @Override public double getSalary() { return salary; } @Override public void print() { System.out.println(\u0026#34;Developer: \u0026#34; + name + \u0026#34;, Salary: \u0026#34; + salary + \u0026#34;, Position: \u0026#34; + position); } @Override public void printStructure(String indent) { System.out.println(indent + \u0026#34;â””â”€â”€ \u0026#34; + name + \u0026#34; (\u0026#34; + position + \u0026#34;)\u0026#34;); } } // Composite å¯¦ç¾ - ç®¡ç†è€… public class Manager implements Employee { private String name; private double salary; private String department; private List\u0026lt;Employee\u0026gt; subordinates = new ArrayList\u0026lt;\u0026gt;(); public Manager(String name, double salary, String department) { this.name = name; this.salary = salary; this.department = department; } @Override public void add(Employee employee) { subordinates.add(employee); } @Override public void remove(Employee employee) { subordinates.remove(employee); } @Override public Employee getChild(int index) { return subordinates.get(index); } @Override public String getName() { return name; } @Override public double getSalary() { return salary; } @Override public void print() { System.out.println(\u0026#34;Manager: \u0026#34; + name + \u0026#34;, Salary: \u0026#34; + salary + \u0026#34;, Department: \u0026#34; + department); System.out.println(\u0026#34;Subordinates:\u0026#34;); for (Employee emp : subordinates) { emp.print(); } } @Override public void printStructure(String indent) { System.out.println(indent + \u0026#34;â”œâ”€â”€ \u0026#34; + name + \u0026#34; (\u0026#34; + department + \u0026#34; Manager)\u0026#34;); for (int i = 0; i \u0026lt; subordinates.size(); i++) { String newIndent = indent + \u0026#34;â”‚ \u0026#34;; if (i == subordinates.size() - 1) { newIndent = indent + \u0026#34; \u0026#34;; } subordinates.get(i).printStructure(newIndent); } } public double getTotalSalary() { double total = salary; for (Employee emp : subordinates) { total += emp.getSalary(); if (emp instanceof Manager) { total += ((Manager) emp).getTotalSalary() - emp.getSalary(); } } return total; } } 2. æ¸¬è©¦ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public class CompositePatternDemo { public static void main(String[] args) { // å‰µå»ºé–‹ç™¼è€… Employee dev1 = new Developer(\u0026#34;Alice\u0026#34;, 80000, \u0026#34;Senior Java Developer\u0026#34;); Employee dev2 = new Developer(\u0026#34;Bob\u0026#34;, 70000, \u0026#34;Frontend Developer\u0026#34;); Employee dev3 = new Developer(\u0026#34;Charlie\u0026#34;, 85000, \u0026#34;Full Stack Developer\u0026#34;); // å‰µå»ºåœ˜éšŠç¶“ç† Manager teamLead = new Manager(\u0026#34;David\u0026#34;, 100000, \u0026#34;Development Team\u0026#34;); teamLead.add(dev1); teamLead.add(dev2); // å‰µå»ºæŠ€è¡“ç¶“ç† Manager techManager = new Manager(\u0026#34;Eve\u0026#34;, 120000, \u0026#34;Technology\u0026#34;); techManager.add(dev3); techManager.add(teamLead); // å‰µå»ºéƒ¨é–€ç¶“ç† Manager deptManager = new Manager(\u0026#34;Frank\u0026#34;, 150000, \u0026#34;Engineering\u0026#34;); deptManager.add(techManager); // æ‰“å°çµ„ç¹”çµæ§‹ System.out.println(\u0026#34;=== Organization Structure ===\u0026#34;); deptManager.printStructure(\u0026#34;\u0026#34;); System.out.println(\u0026#34;\\n=== Total Department Salary: \u0026#34; + deptManager.getTotalSalary() + \u0026#34; ===\u0026#34;); } } ç¾ä»£ Java å¯¦ç¾ 1. ä½¿ç”¨ Java 8+ ç‰¹æ€§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 // ä½¿ç”¨ Optional å’Œ Stream API public interface ModernComponent { String getName(); double getValue(); Optional\u0026lt;List\u0026lt;ModernComponent\u0026gt;\u0026gt; getChildren(); default void process() { System.out.println(\u0026#34;Processing: \u0026#34; + getName()); getChildren().ifPresent(children -\u0026gt; children.forEach(ModernComponent::process) ); } default double getTotalValue() { return getValue() + getChildren().orElse(Collections.emptyList()) .stream() .mapToDouble(ModernComponent::getTotalValue) .sum(); } default long countElements() { return 1 + getChildren().orElse(Collections.emptyList()) .stream() .mapToLong(ModernComponent::countElements) .sum(); } } // è‘‰å­ç¯€é»å¯¦ç¾ public class ModernLeaf implements ModernComponent { private final String name; private final double value; public ModernLeaf(String name, double value) { this.name = name; this.value = value; } @Override public String getName() { return name; } @Override public double getValue() { return value; } @Override public Optional\u0026lt;List\u0026lt;ModernComponent\u0026gt;\u0026gt; getChildren() { return Optional.empty(); } } // çµ„åˆç¯€é»å¯¦ç¾ public class ModernComposite implements ModernComponent { private final String name; private final double value; private final List\u0026lt;ModernComponent\u0026gt; children = new CopyOnWriteArrayList\u0026lt;\u0026gt;(); public ModernComposite(String name, double value) { this.name = name; this.value = value; } public void add(ModernComponent component) { children.add(component); } public void remove(ModernComponent component) { children.remove(component); } @Override public String getName() { return name; } @Override public double getValue() { return value; } @Override public Optional\u0026lt;List\u0026lt;ModernComponent\u0026gt;\u0026gt; getChildren() { return Optional.of(Collections.unmodifiableList(children)); } } 2. å‡½æ•¸å¼ç·¨ç¨‹ç‰ˆæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // ä½¿ç”¨å‡½æ•¸å¼æ¥å£ @FunctionalInterface public interface ComponentProcessor\u0026lt;T\u0026gt; { void process(T item); } // é€šç”¨çš„çµ„åˆæ¨¡å¼æ“ä½œ public class FunctionalComposite\u0026lt;T\u0026gt; { private final T value; private final List\u0026lt;FunctionalComposite\u0026lt;T\u0026gt;\u0026gt; children = new ArrayList\u0026lt;\u0026gt;(); public FunctionalComposite(T value) { this.value = value; } public void add(FunctionalComposite\u0026lt;T\u0026gt; child) { children.add(child); } public void forEach(ComponentProcessor\u0026lt;T\u0026gt; processor) { processor.process(value); children.forEach(child -\u0026gt; child.forEach(processor)); } public \u0026lt;R\u0026gt; R reduce(R identity, BinaryOperator\u0026lt;R\u0026gt; accumulator, Function\u0026lt;T, R\u0026gt; mapper) { R result = accumulator.apply(identity, mapper.apply(value)); for (FunctionalComposite\u0026lt;T\u0026gt; child : children) { result = accumulator.apply(result, child.reduce(identity, accumulator, mapper)); } return result; } public Stream\u0026lt;T\u0026gt; stream() { return Stream.concat( Stream.of(value), children.stream().flatMap(FunctionalComposite::stream) ); } } Spring Boot é›†æˆ 1. æœå‹™å±¤çµ„åˆæ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 // æŠ½è±¡æœå‹™çµ„ä»¶ public abstract class ServiceComponent { protected String name; protected boolean enabled; public ServiceComponent(String name) { this.name = name; this.enabled = true; } public abstract void execute(); public abstract List\u0026lt;ServiceComponent\u0026gt; getChildren(); public void setEnabled(boolean enabled) { this.enabled = enabled; } public boolean isEnabled() { return enabled; } public String getName() { return name; } } // è‘‰å­æœå‹™ @Component public class EmailService extends ServiceComponent { private static final Logger logger = LoggerFactory.getLogger(EmailService.class); public EmailService() { super(\u0026#34;Email Service\u0026#34;); } @Override public void execute() { if (enabled) { logger.info(\u0026#34;Executing email service...\u0026#34;); // Email sending logic } } @Override public List\u0026lt;ServiceComponent\u0026gt; getChildren() { return Collections.emptyList(); } } // çµ„åˆæœå‹™ @Component public class NotificationService extends ServiceComponent { private static final Logger logger = LoggerFactory.getLogger(NotificationService.class); private final List\u0026lt;ServiceComponent\u0026gt; services = new ArrayList\u0026lt;\u0026gt;(); public NotificationService() { super(\u0026#34;Notification Service\u0026#34;); } @Autowired public void setServices(List\u0026lt;ServiceComponent\u0026gt; services) { this.services.addAll(services.stream() .filter(service -\u0026gt; !service.equals(this)) .collect(Collectors.toList())); } @Override public void execute() { if (enabled) { logger.info(\u0026#34;Executing notification service...\u0026#34;); services.forEach(ServiceComponent::execute); } } @Override public List\u0026lt;ServiceComponent\u0026gt; getChildren() { return Collections.unmodifiableList(services); } } // æœå‹™ç·¨æ’å™¨ @Service public class ServiceOrchestrator { private final List\u0026lt;ServiceComponent\u0026gt; rootServices; public ServiceOrchestrator(List\u0026lt;ServiceComponent\u0026gt; services) { this.rootServices = services.stream() .filter(service -\u0026gt; service instanceof NotificationService) .collect(Collectors.toList()); } public void executeAll() { rootServices.forEach(ServiceComponent::execute); } public void executeService(String serviceName) { findService(serviceName).ifPresent(ServiceComponent::execute); } private Optional\u0026lt;ServiceComponent\u0026gt; findService(String name) { return rootServices.stream() .filter(service -\u0026gt; service.getName().equals(name)) .findFirst(); } } 2. é…ç½®ç®¡ç†çµ„åˆæ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 @Configuration @ConfigurationProperties(prefix = \u0026#34;app\u0026#34;) public class CompositeConfiguration { @Component public static class ConfigNode { private String name; private String value; private List\u0026lt;ConfigNode\u0026gt; children = new ArrayList\u0026lt;\u0026gt;(); public void addChild(ConfigNode child) { children.add(child); } public Optional\u0026lt;String\u0026gt; getValue(String path) { if (path.equals(name)) { return Optional.ofNullable(value); } return children.stream() .map(child -\u0026gt; child.getValue(path)) .filter(Optional::isPresent) .findFirst() .orElse(Optional.empty()); } // Getters and setters } @Bean public ConfigNode rootConfig() { ConfigNode root = new ConfigNode(); root.setName(\u0026#34;application\u0026#34;); ConfigNode database = new ConfigNode(); database.setName(\u0026#34;database\u0026#34;); database.setValue(\u0026#34;mysql://localhost:3306/app\u0026#34;); ConfigNode cache = new ConfigNode(); cache.setName(\u0026#34;cache\u0026#34;); cache.setValue(\u0026#34;redis://localhost:6379\u0026#34;); root.addChild(database); root.addChild(cache); return root; } } å¯¦éš›æ‡‰ç”¨å ´æ™¯ 1. æ–‡ä»¶ç³»çµ± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 // æ–‡ä»¶ç³»çµ±çµ„åˆæ¨¡å¼ public abstract class FileSystemNode { protected String name; protected long size; protected Date lastModified; public FileSystemNode(String name) { this.name = name; this.lastModified = new Date(); } public abstract long getSize(); public abstract void display(String indent); public abstract List\u0026lt;FileSystemNode\u0026gt; getChildren(); public String getName() { return name; } } public class File extends FileSystemNode { private long fileSize; public File(String name, long size) { super(name); this.fileSize = size; } @Override public long getSize() { return fileSize; } @Override public void display(String indent) { System.out.println(indent + \u0026#34;ğŸ“„ \u0026#34; + name + \u0026#34; (\u0026#34; + fileSize + \u0026#34; bytes)\u0026#34;); } @Override public List\u0026lt;FileSystemNode\u0026gt; getChildren() { return Collections.emptyList(); } } public class Directory extends FileSystemNode { private List\u0026lt;FileSystemNode\u0026gt; contents = new ArrayList\u0026lt;\u0026gt;(); public Directory(String name) { super(name); } public void add(FileSystemNode node) { contents.add(node); } @Override public long getSize() { return contents.stream() .mapToLong(FileSystemNode::getSize) .sum(); } @Override public void display(String indent) { System.out.println(indent + \u0026#34;ğŸ“ \u0026#34; + name + \u0026#34;/\u0026#34;); contents.forEach(node -\u0026gt; node.display(indent + \u0026#34; \u0026#34;)); } @Override public List\u0026lt;FileSystemNode\u0026gt; getChildren() { return Collections.unmodifiableList(contents); } } 2. GUI çµ„ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 // GUI çµ„åˆæ¨¡å¼ public abstract class UIComponent { protected String name; protected boolean visible = true; public UIComponent(String name) { this.name = name; } public abstract void render(); public abstract void addChild(UIComponent child); public abstract void removeChild(UIComponent child); public abstract List\u0026lt;UIComponent\u0026gt; getChildren(); public void setVisible(boolean visible) { this.visible = visible; } public boolean isVisible() { return visible; } } public class Button extends UIComponent { private String text; public Button(String name, String text) { super(name); this.text = text; } @Override public void render() { if (visible) { System.out.println(\u0026#34;Rendering button: \u0026#34; + text); } } @Override public void addChild(UIComponent child) { throw new UnsupportedOperationException(\u0026#34;Button cannot have children\u0026#34;); } @Override public void removeChild(UIComponent child) { throw new UnsupportedOperationException(\u0026#34;Button cannot have children\u0026#34;); } @Override public List\u0026lt;UIComponent\u0026gt; getChildren() { return Collections.emptyList(); } } public class Panel extends UIComponent { private List\u0026lt;UIComponent\u0026gt; children = new ArrayList\u0026lt;\u0026gt;(); public Panel(String name) { super(name); } @Override public void render() { if (visible) { System.out.println(\u0026#34;Rendering panel: \u0026#34; + name); children.forEach(UIComponent::render); } } @Override public void addChild(UIComponent child) { children.add(child); } @Override public void removeChild(UIComponent child) { children.remove(child); } @Override public List\u0026lt;UIComponent\u0026gt; getChildren() { return Collections.unmodifiableList(children); } } æ€§èƒ½å„ªåŒ– 1. æ‡¶åŠ è¼‰å’Œç·©å­˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public class OptimizedComposite { private final String name; private final Supplier\u0026lt;List\u0026lt;OptimizedComposite\u0026gt;\u0026gt; childrenSupplier; private List\u0026lt;OptimizedComposite\u0026gt; cachedChildren; private final Map\u0026lt;String, Object\u0026gt; computedValues = new ConcurrentHashMap\u0026lt;\u0026gt;(); public OptimizedComposite(String name, Supplier\u0026lt;List\u0026lt;OptimizedComposite\u0026gt;\u0026gt; childrenSupplier) { this.name = name; this.childrenSupplier = childrenSupplier; } public List\u0026lt;OptimizedComposite\u0026gt; getChildren() { if (cachedChildren == null) { cachedChildren = childrenSupplier.get(); } return cachedChildren; } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; T computeIfAbsent(String key, Function\u0026lt;OptimizedComposite, T\u0026gt; computer) { return (T) computedValues.computeIfAbsent(key, k -\u0026gt; computer.apply(this)); } public void invalidateCache() { cachedChildren = null; computedValues.clear(); } } 2. ä¸¦è¡Œè™•ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public class ParallelComposite { private final String name; private final List\u0026lt;ParallelComposite\u0026gt; children = new CopyOnWriteArrayList\u0026lt;\u0026gt;(); private final ForkJoinPool customThreadPool; public ParallelComposite(String name, int parallelism) { this.name = name; this.customThreadPool = new ForkJoinPool(parallelism); } public void processParallel(Consumer\u0026lt;String\u0026gt; processor) { List\u0026lt;CompletableFuture\u0026lt;Void\u0026gt;\u0026gt; futures = new ArrayList\u0026lt;\u0026gt;(); // è™•ç†ç•¶å‰ç¯€é» futures.add(CompletableFuture.runAsync(() -\u0026gt; processor.accept(name), customThreadPool)); // ä¸¦è¡Œè™•ç†å­ç¯€é» for (ParallelComposite child : children) { futures.add(CompletableFuture.runAsync(() -\u0026gt; child.processParallel(processor), customThreadPool)); } // ç­‰å¾…æ‰€æœ‰ä»»å‹™å®Œæˆ CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join(); } } æ¸¬è©¦ç­–ç•¥ 1. å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 @ExtendWith(MockitoExtension.class) class CompositePatternTest { @Test void testLeafNode() { Employee developer = new Developer(\u0026#34;John\u0026#34;, 80000, \u0026#34;Java Developer\u0026#34;); assertEquals(\u0026#34;John\u0026#34;, developer.getName()); assertEquals(80000, developer.getSalary()); assertThrows(UnsupportedOperationException.class, () -\u0026gt; developer.add(null)); assertThrows(UnsupportedOperationException.class, () -\u0026gt; developer.remove(null)); assertThrows(UnsupportedOperationException.class, () -\u0026gt; developer.getChild(0)); } @Test void testCompositeNode() { Manager manager = new Manager(\u0026#34;Alice\u0026#34;, 120000, \u0026#34;Engineering\u0026#34;); Employee dev1 = new Developer(\u0026#34;Bob\u0026#34;, 80000, \u0026#34;Senior Developer\u0026#34;); Employee dev2 = new Developer(\u0026#34;Charlie\u0026#34;, 70000, \u0026#34;Junior Developer\u0026#34;); manager.add(dev1); manager.add(dev2); assertEquals(\u0026#34;Alice\u0026#34;, manager.getName()); assertEquals(120000, manager.getSalary()); assertEquals(270000, manager.getTotalSalary()); // 120000 + 80000 + 70000 assertEquals(dev1, manager.getChild(0)); assertEquals(dev2, manager.getChild(1)); } @Test void testHierarchicalStructure() { Employee dev = new Developer(\u0026#34;John\u0026#34;, 80000, \u0026#34;Developer\u0026#34;); Manager teamLead = new Manager(\u0026#34;Alice\u0026#34;, 100000, \u0026#34;Team Lead\u0026#34;); Manager director = new Manager(\u0026#34;Bob\u0026#34;, 150000, \u0026#34;Director\u0026#34;); teamLead.add(dev); director.add(teamLead); assertEquals(330000, director.getTotalSalary()); } } 2. é›†æˆæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 @SpringBootTest class CompositeServiceTest { @Autowired private ServiceOrchestrator orchestrator; @Test void testServiceExecution() { // æ¸¬è©¦æœå‹™ç·¨æ’å™¨æ˜¯å¦æ­£ç¢ºåŸ·è¡Œæ‰€æœ‰æœå‹™ assertDoesNotThrow(() -\u0026gt; orchestrator.executeAll()); } @Test void testSpecificServiceExecution() { // æ¸¬è©¦ç‰¹å®šæœå‹™çš„åŸ·è¡Œ assertDoesNotThrow(() -\u0026gt; orchestrator.executeService(\u0026#34;Notification Service\u0026#34;)); } } æœ€ä½³å¯¦è¸ 1. è¨­è¨ˆåŸå‰‡ çµ±ä¸€æ¥å£: ç¢ºä¿è‘‰å­å’Œçµ„åˆç¯€é»å¯¦ç¾ç›¸åŒçš„æ¥å£ é€æ˜æ€§: å®¢æˆ¶ç«¯ä¸éœ€è¦çŸ¥é“è™•ç†çš„æ˜¯è‘‰å­é‚„æ˜¯çµ„åˆç¯€é» å®‰å…¨æ€§: åœ¨ä¸é©ç•¶çš„æ“ä½œä¸Šæ‹‹å‡ºç•°å¸¸ æ€§èƒ½: è€ƒæ…®æ‡¶åŠ è¼‰å’Œç·©å­˜æ©Ÿåˆ¶ 2. å¯¦ç¾å»ºè­° ä½¿ç”¨ä¸å¯è®Šå°è±¡æé«˜ç·šç¨‹å®‰å…¨æ€§ å¯¦ç¾ equals() å’Œ hashCode() æ–¹æ³• æä¾›ä¾¿åˆ©çš„å·¥å» æ–¹æ³• è€ƒæ…®ä½¿ç”¨ Builder æ¨¡å¼æ§‹å»ºè¤‡é›œçµæ§‹ 3. å¸¸è¦‹é™·é˜± é¿å…å¾ªç’°å¼•ç”¨ æ³¨æ„å…§å­˜æ´©æ¼ï¼ˆç‰¹åˆ¥æ˜¯åœ¨å¤§å‹æ¨¹çµæ§‹ä¸­ï¼‰ æ­£ç¢ºè™•ç†ä½µç™¼è¨ªå• é¿å…éåº¦ä½¿ç”¨ï¼ˆç•¶çµæ§‹ç°¡å–®æ™‚ï¼‰ é©ç”¨å ´æ™¯ ä½•æ™‚ä½¿ç”¨ å±¤æ¬¡çµæ§‹: éœ€è¦è¡¨ç¤ºéƒ¨åˆ†-æ•´é«”çš„å±¤æ¬¡çµæ§‹ çµ±ä¸€è™•ç†: å¸Œæœ›çµ±ä¸€è™•ç†å€‹åˆ¥å°è±¡å’Œçµ„åˆå°è±¡ æ¨¹ç‹€çµ„ç¹”: æ•¸æ“šè‡ªç„¶å½¢æˆæ¨¹ç‹€çµæ§‹ éæ­¸æ“ä½œ: éœ€è¦å°çµæ§‹é€²è¡Œéæ­¸æ“ä½œ ä½•æ™‚é¿å… ç°¡å–®çµæ§‹: ç•¶çµæ§‹éæ–¼ç°¡å–®æ™‚æœƒå¢åŠ ä¸å¿…è¦çš„è¤‡é›œæ€§ é¡å‹å®‰å…¨: ç•¶éœ€è¦å¼·é¡å‹æª¢æŸ¥æ™‚ æ€§èƒ½é—œéµ: ç•¶æ€§èƒ½æ˜¯é—œéµå› ç´ ä¸”çµæ§‹é »ç¹è®ŠåŒ–æ™‚ ç¸½çµ Composite Pattern æ˜¯ä¸€å€‹å¼·å¤§çš„çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œå®ƒèƒ½å¤ å„ªé›…åœ°è™•ç†æ¨¹ç‹€çµæ§‹çš„æ•¸æ“šã€‚é€šéçµ±ä¸€çš„æ¥å£ï¼Œå®ƒè®“å®¢æˆ¶ç«¯èƒ½å¤ é€æ˜åœ°è™•ç†å–®å€‹å°è±¡å’Œå°è±¡çµ„åˆï¼Œå¤§å¤§ç°¡åŒ–äº†ä»£ç¢¼çš„è¤‡é›œæ€§ã€‚åœ¨ç¾ä»£ Java é–‹ç™¼ä¸­ï¼Œçµåˆ Stream APIã€Optional å’Œ Spring Bootï¼Œæˆ‘å€‘å¯ä»¥å‰µå»ºæ›´åŠ éˆæ´»ã€é«˜æ•ˆå’Œæ˜“æ–¼ç¶­è­·çš„çµ„åˆæ¨¡å¼å¯¦ç¾ã€‚\né—œéµæ˜¯è¦ç†è§£ä½•æ™‚ä½¿ç”¨é€™å€‹æ¨¡å¼ï¼Œä¸¦æ ¹æ“šå…·é«”çš„æ¥­å‹™éœ€æ±‚é¸æ“‡åˆé©çš„å¯¦ç¾æ–¹å¼ã€‚ç„¡è«–æ˜¯ç°¡å–®çš„çµ„ç¹”çµæ§‹é‚„æ˜¯è¤‡é›œçš„ä¼æ¥­ç´šæ‡‰ç”¨ï¼ŒComposite Pattern éƒ½èƒ½æä¾›æ¸…æ™°ã€å¯æ“´å±•çš„è§£æ±ºæ–¹æ¡ˆã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/composite/","tags":["Design Pattern","Structural","Composite","Tree Structure"],"title":"DesignPattern - Structural - Composite"},{"content":"é©é…å™¨æ¨¡å¼ (Adapter Pattern) å®Œæ•´å¯¦ä½œæŒ‡å— æ¨¡å¼æ¦‚è¿° é©é…å™¨æ¨¡å¼æ˜¯ä¸€ç¨®çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œå®ƒå…è¨±åŸæœ¬ç”±æ–¼ä»‹é¢ä¸ç›¸å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é¡åˆ¥å”åŒå·¥ä½œã€‚é©é…å™¨æ¨¡å¼å°±åƒç¾å¯¦ç”Ÿæ´»ä¸­çš„é›»æºé©é…å™¨ï¼Œå®ƒèƒ½å¤ å°‡ä¸€å€‹é¡åˆ¥çš„ä»‹é¢è½‰æ›æˆå®¢æˆ¶ç«¯æ‰€æœŸæœ›çš„å¦ä¸€å€‹ä»‹é¢ã€‚\næ¨¡å¼çµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // ç›®æ¨™ä»‹é¢ - å®¢æˆ¶ç«¯æ‰€æœŸæœ›çš„ä»‹é¢ public interface Target { void request(); } // é©é…è€… - éœ€è¦è¢«é©é…çš„ç¾æœ‰é¡åˆ¥ public class Adaptee { public void specificRequest() { System.out.println(\u0026#34;åŸ·è¡Œç‰¹å®šè«‹æ±‚\u0026#34;); } } // é©é…å™¨ - å°‡ Adaptee è½‰æ›ç‚º Target ä»‹é¢ public class Adapter implements Target { private Adaptee adaptee; public Adapter(Adaptee adaptee) { this.adaptee = adaptee; } @Override public void request() { adaptee.specificRequest(); } } // å®¢æˆ¶ç«¯ public class Client { public void makeRequest(Target target) { target.request(); } } é©é…å™¨æ¨¡å¼çš„å…©ç¨®å¯¦ç¾æ–¹å¼ 1. å°è±¡é©é…å™¨ (Object Adapter) - ä½¿ç”¨çµ„åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 // æ”¯ä»˜ä»‹é¢ public interface PaymentProcessor { PaymentResult processPayment(double amount, String currency); } // ç¬¬ä¸‰æ–¹æ”¯ä»˜SDK public class ThirdPartyPaymentSDK { public boolean makePayment(String amount, String currencyCode, Map\u0026lt;String, String\u0026gt; metadata) { System.out.println(\u0026#34;ä½¿ç”¨ç¬¬ä¸‰æ–¹SDKè™•ç†æ”¯ä»˜: \u0026#34; + amount + \u0026#34; \u0026#34; + currencyCode); // æ¨¡æ“¬æ”¯ä»˜è™•ç† return Math.random() \u0026gt; 0.1; // 90%æˆåŠŸç‡ } public String getTransactionId() { return \u0026#34;TXN_\u0026#34; + System.currentTimeMillis(); } } // å°è±¡é©é…å™¨ public class ThirdPartyPaymentAdapter implements PaymentProcessor { private ThirdPartyPaymentSDK thirdPartySDK; public ThirdPartyPaymentAdapter(ThirdPartyPaymentSDK thirdPartySDK) { this.thirdPartySDK = thirdPartySDK; } @Override public PaymentResult processPayment(double amount, String currency) { try { // è½‰æ›åƒæ•¸æ ¼å¼ String amountStr = String.valueOf(amount); Map\u0026lt;String, String\u0026gt; metadata = new HashMap\u0026lt;\u0026gt;(); metadata.put(\u0026#34;source\u0026#34;, \u0026#34;adapter\u0026#34;); metadata.put(\u0026#34;timestamp\u0026#34;, String.valueOf(System.currentTimeMillis())); // èª¿ç”¨ç¬¬ä¸‰æ–¹SDK boolean success = thirdPartySDK.makePayment(amountStr, currency, metadata); // è½‰æ›è¿”å›çµæœ return new PaymentResult( success, success ? \u0026#34;æ”¯ä»˜æˆåŠŸ\u0026#34; : \u0026#34;æ”¯ä»˜å¤±æ•—\u0026#34;, thirdPartySDK.getTransactionId(), amount, currency ); } catch (Exception e) { return new PaymentResult(false, \u0026#34;æ”¯ä»˜ç•°å¸¸: \u0026#34; + e.getMessage(), null, amount, currency); } } } // çµæœé¡ public class PaymentResult { private boolean success; private String message; private String transactionId; private double amount; private String currency; public PaymentResult(boolean success, String message, String transactionId, double amount, String currency) { this.success = success; this.message = message; this.transactionId = transactionId; this.amount = amount; this.currency = currency; } // getters and setters public boolean isSuccess() { return success; } public String getMessage() { return message; } public String getTransactionId() { return transactionId; } public double getAmount() { return amount; } public String getCurrency() { return currency; } } 2. é¡é©é…å™¨ (Class Adapter) - ä½¿ç”¨ç¹¼æ‰¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // éºç•™ç³»çµ±çš„æ—¥èªŒé¡åˆ¥ public class LegacyLogger { public void writeLog(String level, String message) { System.out.println(\u0026#34;[\u0026#34; + level + \u0026#34;] \u0026#34; + new Date() + \u0026#34; - \u0026#34; + message); } } // ç¾ä»£æ—¥èªŒä»‹é¢ public interface ModernLogger { void info(String message); void warn(String message); void error(String message); void debug(String message); } // é¡é©é…å™¨ public class LegacyLoggerAdapter extends LegacyLogger implements ModernLogger { @Override public void info(String message) { writeLog(\u0026#34;INFO\u0026#34;, message); } @Override public void warn(String message) { writeLog(\u0026#34;WARN\u0026#34;, message); } @Override public void error(String message) { writeLog(\u0026#34;ERROR\u0026#34;, message); } @Override public void debug(String message) { writeLog(\u0026#34;DEBUG\u0026#34;, message); } } ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯ 1. æ•¸æ“šæºé©é…å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 // çµ±ä¸€æ•¸æ“šæºä»‹é¢ public interface DataSource { List\u0026lt;Record\u0026gt; fetchData(QueryParameters params); void saveData(List\u0026lt;Record\u0026gt; records); } // æ•¸æ“šåº«æ•¸æ“šæº public class DatabaseDataSource implements DataSource { private JdbcTemplate jdbcTemplate; public DatabaseDataSource(JdbcTemplate jdbcTemplate) { this.jdbcTemplate = jdbcTemplate; } @Override public List\u0026lt;Record\u0026gt; fetchData(QueryParameters params) { String sql = buildSqlQuery(params); return jdbcTemplate.query(sql, new RecordRowMapper()); } @Override public void saveData(List\u0026lt;Record\u0026gt; records) { String sql = \u0026#34;INSERT INTO records (id, name, value) VALUES (?, ?, ?)\u0026#34;; jdbcTemplate.batchUpdate(sql, new BatchPreparedStatementSetter() { @Override public void setValues(PreparedStatement ps, int i) throws SQLException { Record record = records.get(i); ps.setString(1, record.getId()); ps.setString(2, record.getName()); ps.setString(3, record.getValue()); } @Override public int getBatchSize() { return records.size(); } }); } private String buildSqlQuery(QueryParameters params) { StringBuilder sql = new StringBuilder(\u0026#34;SELECT * FROM records WHERE 1=1\u0026#34;); if (params.getName() != null) { sql.append(\u0026#34; AND name = \u0026#39;\u0026#34;).append(params.getName()).append(\u0026#34;\u0026#39;\u0026#34;); } if (params.getDateRange() != null) { sql.append(\u0026#34; AND created_date BETWEEN \u0026#39;\u0026#34;) .append(params.getDateRange().getStart()) .append(\u0026#34;\u0026#39; AND \u0026#39;\u0026#34;) .append(params.getDateRange().getEnd()) .append(\u0026#34;\u0026#39;\u0026#34;); } return sql.toString(); } } // REST API æ•¸æ“šæºé©é…å™¨ public class RestApiDataSourceAdapter implements DataSource { private RestTemplate restTemplate; private String baseUrl; public RestApiDataSourceAdapter(RestTemplate restTemplate, String baseUrl) { this.restTemplate = restTemplate; this.baseUrl = baseUrl; } @Override public List\u0026lt;Record\u0026gt; fetchData(QueryParameters params) { String url = baseUrl + \u0026#34;/api/records\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); // è½‰æ›æŸ¥è©¢åƒæ•¸ Map\u0026lt;String, Object\u0026gt; requestBody = new HashMap\u0026lt;\u0026gt;(); if (params.getName() != null) { requestBody.put(\u0026#34;name\u0026#34;, params.getName()); } if (params.getDateRange() != null) { requestBody.put(\u0026#34;startDate\u0026#34;, params.getDateRange().getStart()); requestBody.put(\u0026#34;endDate\u0026#34;, params.getDateRange().getEnd()); } HttpEntity\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(requestBody, headers); try { ResponseEntity\u0026lt;ApiResponse\u0026gt; response = restTemplate.postForEntity(url, request, ApiResponse.class); return convertApiResponseToRecords(response.getBody()); } catch (RestClientException e) { throw new DataSourceException(\u0026#34;ç„¡æ³•å¾REST APIç²å–æ•¸æ“š\u0026#34;, e); } } @Override public void saveData(List\u0026lt;Record\u0026gt; records) { String url = baseUrl + \u0026#34;/api/records/batch\u0026#34;; HttpHeaders headers = new HttpHeaders(); headers.setContentType(MediaType.APPLICATION_JSON); List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; apiRecords = records.stream() .map(this::convertRecordToApiFormat) .collect(Collectors.toList()); HttpEntity\u0026lt;List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt;\u0026gt; request = new HttpEntity\u0026lt;\u0026gt;(apiRecords, headers); try { restTemplate.postForObject(url, request, ApiResponse.class); } catch (RestClientException e) { throw new DataSourceException(\u0026#34;ç„¡æ³•ä¿å­˜æ•¸æ“šåˆ°REST API\u0026#34;, e); } } private List\u0026lt;Record\u0026gt; convertApiResponseToRecords(ApiResponse response) { return response.getData().stream() .map(item -\u0026gt; new Record( item.get(\u0026#34;id\u0026#34;).toString(), item.get(\u0026#34;name\u0026#34;).toString(), item.get(\u0026#34;value\u0026#34;).toString() )) .collect(Collectors.toList()); } private Map\u0026lt;String, Object\u0026gt; convertRecordToApiFormat(Record record) { Map\u0026lt;String, Object\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;id\u0026#34;, record.getId()); map.put(\u0026#34;name\u0026#34;, record.getName()); map.put(\u0026#34;value\u0026#34;, record.getValue()); return map; } } // æ–‡ä»¶æ•¸æ“šæºé©é…å™¨ public class FileDataSourceAdapter implements DataSource { private String filePath; private ObjectMapper objectMapper; public FileDataSourceAdapter(String filePath) { this.filePath = filePath; this.objectMapper = new ObjectMapper(); } @Override public List\u0026lt;Record\u0026gt; fetchData(QueryParameters params) { try { List\u0026lt;Record\u0026gt; allRecords = readRecordsFromFile(); return filterRecords(allRecords, params); } catch (IOException e) { throw new DataSourceException(\u0026#34;ç„¡æ³•è®€å–æ–‡ä»¶æ•¸æ“š\u0026#34;, e); } } @Override public void saveData(List\u0026lt;Record\u0026gt; records) { try { writeRecordsToFile(records); } catch (IOException e) { throw new DataSourceException(\u0026#34;ç„¡æ³•ä¿å­˜æ•¸æ“šåˆ°æ–‡ä»¶\u0026#34;, e); } } private List\u0026lt;Record\u0026gt; readRecordsFromFile() throws IOException { File file = new File(filePath); if (!file.exists()) { return new ArrayList\u0026lt;\u0026gt;(); } TypeReference\u0026lt;List\u0026lt;Record\u0026gt;\u0026gt; typeRef = new TypeReference\u0026lt;List\u0026lt;Record\u0026gt;\u0026gt;() {}; return objectMapper.readValue(file, typeRef); } private void writeRecordsToFile(List\u0026lt;Record\u0026gt; records) throws IOException { File file = new File(filePath); objectMapper.writeValue(file, records); } private List\u0026lt;Record\u0026gt; filterRecords(List\u0026lt;Record\u0026gt; records, QueryParameters params) { return records.stream() .filter(record -\u0026gt; { if (params.getName() != null \u0026amp;\u0026amp; !params.getName().equals(record.getName())) { return false; } // æ·»åŠ å…¶ä»–éæ¿¾æ¢ä»¶ return true; }) .collect(Collectors.toList()); } } 2. æ¶ˆæ¯ç³»çµ±é©é…å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 // çµ±ä¸€æ¶ˆæ¯ç™¼é€ä»‹é¢ public interface MessageSender { void sendMessage(String recipient, String subject, String content); void sendBroadcast(String subject, String content); boolean isAvailable(); } // éƒµä»¶æœå‹™é©é…å™¨ public class EmailServiceAdapter implements MessageSender { private JavaMailSender mailSender; private String fromAddress; public EmailServiceAdapter(JavaMailSender mailSender, String fromAddress) { this.mailSender = mailSender; this.fromAddress = fromAddress; } @Override public void sendMessage(String recipient, String subject, String content) { try { SimpleMailMessage message = new SimpleMailMessage(); message.setFrom(fromAddress); message.setTo(recipient); message.setSubject(subject); message.setText(content); mailSender.send(message); } catch (Exception e) { throw new MessageSendException(\u0026#34;éƒµä»¶ç™¼é€å¤±æ•—\u0026#34;, e); } } @Override public void sendBroadcast(String subject, String content) { // å¯¦ç¾ç¾¤ç™¼é‚è¼¯ List\u0026lt;String\u0026gt; recipients = getSubscriberEmails(); for (String recipient : recipients) { sendMessage(recipient, subject, content); } } @Override public boolean isAvailable() { try { // æª¢æŸ¥éƒµä»¶æœå‹™æ˜¯å¦å¯ç”¨ return mailSender != null; } catch (Exception e) { return false; } } private List\u0026lt;String\u0026gt; getSubscriberEmails() { // ç²å–è¨‚é–±è€…éƒµç®±åˆ—è¡¨ return Arrays.asList(\u0026#34;user1@example.com\u0026#34;, \u0026#34;user2@example.com\u0026#34;); } } // SMS æœå‹™é©é…å™¨ public class SmsServiceAdapter implements MessageSender { private SmsClient smsClient; private String apiKey; public SmsServiceAdapter(SmsClient smsClient, String apiKey) { this.smsClient = smsClient; this.apiKey = apiKey; } @Override public void sendMessage(String recipient, String subject, String content) { try { // SMSé€šå¸¸ä¸æ”¯æŒä¸»é¡Œï¼Œå°‡ä¸»é¡Œä½µå…¥å…§å®¹ String fullContent = subject + \u0026#34;: \u0026#34; + content; SmsRequest request = new SmsRequest(); request.setApiKey(apiKey); request.setPhoneNumber(recipient); request.setMessage(fullContent); SmsResponse response = smsClient.sendSms(request); if (!response.isSuccess()) { throw new MessageSendException(\u0026#34;SMSç™¼é€å¤±æ•—: \u0026#34; + response.getErrorMessage()); } } catch (Exception e) { throw new MessageSendException(\u0026#34;SMSç™¼é€ç•°å¸¸\u0026#34;, e); } } @Override public void sendBroadcast(String subject, String content) { List\u0026lt;String\u0026gt; phoneNumbers = getSubscriberPhoneNumbers(); for (String phoneNumber : phoneNumbers) { sendMessage(phoneNumber, subject, content); } } @Override public boolean isAvailable() { try { return smsClient.checkConnection(); } catch (Exception e) { return false; } } private List\u0026lt;String\u0026gt; getSubscriberPhoneNumbers() { // ç²å–è¨‚é–±è€…æ‰‹æ©Ÿè™Ÿç¢¼åˆ—è¡¨ return Arrays.asList(\u0026#34;+1234567890\u0026#34;, \u0026#34;+0987654321\u0026#34;); } } // æ¨é€é€šçŸ¥é©é…å™¨ public class PushNotificationAdapter implements MessageSender { private PushNotificationService pushService; public PushNotificationAdapter(PushNotificationService pushService) { this.pushService = pushService; } @Override public void sendMessage(String recipient, String subject, String content) { try { PushNotification notification = new PushNotification(); notification.setDeviceToken(recipient); notification.setTitle(subject); notification.setBody(content); notification.setBadge(1); pushService.send(notification); } catch (Exception e) { throw new MessageSendException(\u0026#34;æ¨é€é€šçŸ¥ç™¼é€å¤±æ•—\u0026#34;, e); } } @Override public void sendBroadcast(String subject, String content) { try { BroadcastNotification broadcast = new BroadcastNotification(); broadcast.setTitle(subject); broadcast.setBody(content); broadcast.setTopic(\u0026#34;all_users\u0026#34;); pushService.sendBroadcast(broadcast); } catch (Exception e) { throw new MessageSendException(\u0026#34;å»£æ’­æ¨é€ç™¼é€å¤±æ•—\u0026#34;, e); } } @Override public boolean isAvailable() { return pushService.isConnected(); } } 3. å¤šé€šé“æ¶ˆæ¯ç®¡ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 @Service public class MessageManager { private final Map\u0026lt;String, MessageSender\u0026gt; messageSenders; private final MessageSender defaultSender; public MessageManager(@Qualifier(\u0026#34;emailSender\u0026#34;) MessageSender emailSender, @Qualifier(\u0026#34;smsSender\u0026#34;) MessageSender smsSender, @Qualifier(\u0026#34;pushSender\u0026#34;) MessageSender pushSender) { this.messageSenders = new HashMap\u0026lt;\u0026gt;(); this.messageSenders.put(\u0026#34;email\u0026#34;, emailSender); this.messageSenders.put(\u0026#34;sms\u0026#34;, smsSender); this.messageSenders.put(\u0026#34;push\u0026#34;, pushSender); this.defaultSender = emailSender; } public void sendMessage(String channel, String recipient, String subject, String content) { MessageSender sender = messageSenders.getOrDefault(channel, defaultSender); if (!sender.isAvailable()) { // å˜—è©¦ä½¿ç”¨å‚™ç”¨é€šé“ sender = findAvailableSender(); if (sender == null) { throw new MessageSendException(\u0026#34;æ‰€æœ‰æ¶ˆæ¯é€šé“å‡ä¸å¯ç”¨\u0026#34;); } } sender.sendMessage(recipient, subject, content); } public void sendMultiChannelMessage(List\u0026lt;String\u0026gt; channels, String recipient, String subject, String content) { List\u0026lt;Exception\u0026gt; exceptions = new ArrayList\u0026lt;\u0026gt;(); for (String channel : channels) { try { sendMessage(channel, recipient, subject, content); } catch (Exception e) { exceptions.add(e); } } if (exceptions.size() == channels.size()) { throw new MessageSendException(\u0026#34;æ‰€æœ‰é€šé“ç™¼é€å¤±æ•—\u0026#34;, exceptions.get(0)); } } private MessageSender findAvailableSender() { return messageSenders.values().stream() .filter(MessageSender::isAvailable) .findFirst() .orElse(null); } } ç·©å­˜ç³»çµ±é©é…å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 // çµ±ä¸€ç·©å­˜ä»‹é¢ public interface CacheService { void put(String key, Object value, Duration ttl); \u0026lt;T\u0026gt; T get(String key, Class\u0026lt;T\u0026gt; type); void remove(String key); void clear(); boolean exists(String key); } // Redis ç·©å­˜é©é…å™¨ @Service public class RedisCacheAdapter implements CacheService { private final RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate; public RedisCacheAdapter(RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate) { this.redisTemplate = redisTemplate; } @Override public void put(String key, Object value, Duration ttl) { redisTemplate.opsForValue().set(key, value, ttl); } @Override @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; T get(String key, Class\u0026lt;T\u0026gt; type) { Object value = redisTemplate.opsForValue().get(key); if (value == null) { return null; } if (type.isAssignableFrom(value.getClass())) { return (T) value; } throw new ClassCastException(\u0026#34;ç„¡æ³•å°‡ç·©å­˜å€¼è½‰æ›ç‚º \u0026#34; + type.getName()); } @Override public void remove(String key) { redisTemplate.delete(key); } @Override public void clear() { Set\u0026lt;String\u0026gt; keys = redisTemplate.keys(\u0026#34;*\u0026#34;); if (keys != null \u0026amp;\u0026amp; !keys.isEmpty()) { redisTemplate.delete(keys); } } @Override public boolean exists(String key) { return Boolean.TRUE.equals(redisTemplate.hasKey(key)); } } // å…§å­˜ç·©å­˜é©é…å™¨ @Service public class MemoryCacheAdapter implements CacheService { private final Map\u0026lt;String, CacheEntry\u0026gt; cache = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1); public MemoryCacheAdapter() { // å®šæœŸæ¸…ç†éæœŸé …ç›® scheduler.scheduleAtFixedRate(this::cleanupExpiredEntries, 1, 1, TimeUnit.MINUTES); } @Override public void put(String key, Object value, Duration ttl) { long expirationTime = System.currentTimeMillis() + ttl.toMillis(); cache.put(key, new CacheEntry(value, expirationTime)); } @Override @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; T get(String key, Class\u0026lt;T\u0026gt; type) { CacheEntry entry = cache.get(key); if (entry == null || entry.isExpired()) { cache.remove(key); return null; } Object value = entry.getValue(); if (type.isAssignableFrom(value.getClass())) { return (T) value; } throw new ClassCastException(\u0026#34;ç„¡æ³•å°‡ç·©å­˜å€¼è½‰æ›ç‚º \u0026#34; + type.getName()); } @Override public void remove(String key) { cache.remove(key); } @Override public void clear() { cache.clear(); } @Override public boolean exists(String key) { CacheEntry entry = cache.get(key); return entry != null \u0026amp;\u0026amp; !entry.isExpired(); } private void cleanupExpiredEntries() { cache.entrySet().removeIf(entry -\u0026gt; entry.getValue().isExpired()); } private static class CacheEntry { private final Object value; private final long expirationTime; public CacheEntry(Object value, long expirationTime) { this.value = value; this.expirationTime = expirationTime; } public Object getValue() { return value; } public boolean isExpired() { return System.currentTimeMillis() \u0026gt; expirationTime; } } } çµ±ä¸€æœå‹™ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 // çµ±ä¸€æœå‹™ç®¡ç†å™¨ @Service public class UnifiedServiceManager { private final DataSource dataSource; private final MessageSender messageSender; private final CacheService cacheService; public UnifiedServiceManager( @Qualifier(\u0026#34;selectedDataSource\u0026#34;) DataSource dataSource, @Qualifier(\u0026#34;selectedMessageSender\u0026#34;) MessageSender messageSender, @Qualifier(\u0026#34;selectedCacheService\u0026#34;) CacheService cacheService) { this.dataSource = dataSource; this.messageSender = messageSender; this.cacheService = cacheService; } public void processBusinessLogic(String userId, String action) { // å¾ç·©å­˜ç²å–ç”¨æˆ¶ä¿¡æ¯ String cacheKey = \u0026#34;user:\u0026#34; + userId; User user = cacheService.get(cacheKey, User.class); if (user == null) { // ç·©å­˜æœªå‘½ä¸­ï¼Œå¾æ•¸æ“šæºç²å– QueryParameters params = new QueryParameters(); params.setName(userId); List\u0026lt;Record\u0026gt; records = dataSource.fetchData(params); if (!records.isEmpty()) { user = convertRecordToUser(records.get(0)); cacheService.put(cacheKey, user, Duration.ofMinutes(30)); } } if (user != null) { // è™•ç†æ¥­å‹™é‚è¼¯ processAction(user, action); // ç™¼é€é€šçŸ¥ messageSender.sendMessage( user.getEmail(), \u0026#34;æ“ä½œé€šçŸ¥\u0026#34;, \u0026#34;æ‚¨çš„æ“ä½œ \u0026#34; + action + \u0026#34; å·²å®Œæˆ\u0026#34; ); } } private User convertRecordToUser(Record record) { return new User(record.getId(), record.getName(), record.getValue()); } private void processAction(User user, String action) { // å…·é«”çš„æ¥­å‹™é‚è¼¯è™•ç† System.out.println(\u0026#34;è™•ç†ç”¨æˆ¶ \u0026#34; + user.getName() + \u0026#34; çš„æ“ä½œ: \u0026#34; + action); } } Spring Boot é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 @Configuration public class AdapterPatternConfig { @Bean @Primary @Qualifier(\u0026#34;selectedDataSource\u0026#34;) public DataSource dataSource( @Value(\u0026#34;${app.datasource.type:database}\u0026#34;) String type, JdbcTemplate jdbcTemplate, RestTemplate restTemplate, @Value(\u0026#34;${app.api.base-url}\u0026#34;) String apiBaseUrl, @Value(\u0026#34;${app.file.data-path}\u0026#34;) String filePath) { switch (type.toLowerCase()) { case \u0026#34;api\u0026#34;: return new RestApiDataSourceAdapter(restTemplate, apiBaseUrl); case \u0026#34;file\u0026#34;: return new FileDataSourceAdapter(filePath); case \u0026#34;database\u0026#34;: default: return new DatabaseDataSource(jdbcTemplate); } } @Bean @Qualifier(\u0026#34;selectedMessageSender\u0026#34;) public MessageSender messageSender( @Value(\u0026#34;${app.messaging.type:email}\u0026#34;) String type, JavaMailSender mailSender, @Value(\u0026#34;${app.email.from}\u0026#34;) String fromAddress, SmsClient smsClient, @Value(\u0026#34;${app.sms.api-key}\u0026#34;) String smsApiKey, PushNotificationService pushService) { switch (type.toLowerCase()) { case \u0026#34;sms\u0026#34;: return new SmsServiceAdapter(smsClient, smsApiKey); case \u0026#34;push\u0026#34;: return new PushNotificationAdapter(pushService); case \u0026#34;email\u0026#34;: default: return new EmailServiceAdapter(mailSender, fromAddress); } } @Bean @Qualifier(\u0026#34;selectedCacheService\u0026#34;) public CacheService cacheService( @Value(\u0026#34;${app.cache.type:redis}\u0026#34;) String type, RedisTemplate\u0026lt;String, Object\u0026gt; redisTemplate) { switch (type.toLowerCase()) { case \u0026#34;memory\u0026#34;: return new MemoryCacheAdapter(); case \u0026#34;redis\u0026#34;: default: return new RedisCacheAdapter(redisTemplate); } } } æ¸¬è©¦ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 @ExtendWith(MockitoExtension.class) class AdapterPatternTest { @Mock private ThirdPartyPaymentSDK mockPaymentSDK; @Mock private JavaMailSender mockMailSender; @InjectMocks private ThirdPartyPaymentAdapter paymentAdapter; @InjectMocks private EmailServiceAdapter emailAdapter; @Test void testPaymentAdapter_Success() { // Given when(mockPaymentSDK.makePayment(anyString(), anyString(), anyMap())) .thenReturn(true); when(mockPaymentSDK.getTransactionId()) .thenReturn(\u0026#34;TXN_12345\u0026#34;); // When PaymentResult result = paymentAdapter.processPayment(100.0, \u0026#34;USD\u0026#34;); // Then assertTrue(result.isSuccess()); assertEquals(\u0026#34;æ”¯ä»˜æˆåŠŸ\u0026#34;, result.getMessage()); assertEquals(\u0026#34;TXN_12345\u0026#34;, result.getTransactionId()); assertEquals(100.0, result.getAmount()); assertEquals(\u0026#34;USD\u0026#34;, result.getCurrency()); verify(mockPaymentSDK).makePayment(\u0026#34;100.0\u0026#34;, \u0026#34;USD\u0026#34;, anyMap()); verify(mockPaymentSDK).getTransactionId(); } @Test void testPaymentAdapter_Failure() { // Given when(mockPaymentSDK.makePayment(anyString(), anyString(), anyMap())) .thenReturn(false); // When PaymentResult result = paymentAdapter.processPayment(100.0, \u0026#34;USD\u0026#34;); // Then assertFalse(result.isSuccess()); assertEquals(\u0026#34;æ”¯ä»˜å¤±æ•—\u0026#34;, result.getMessage()); assertNull(result.getTransactionId()); } @Test void testEmailAdapter_SendMessage() { // Given doNothing().when(mockMailSender).send(any(SimpleMailMessage.class)); // When emailAdapter.sendMessage(\u0026#34;test@example.com\u0026#34;, \u0026#34;æ¸¬è©¦ä¸»é¡Œ\u0026#34;, \u0026#34;æ¸¬è©¦å…§å®¹\u0026#34;); // Then verify(mockMailSender).send(any(SimpleMailMessage.class)); } @Test void testEmailAdapter_SendMessageException() { // Given doThrow(new RuntimeException(\u0026#34;éƒµä»¶æœå‹™ä¸å¯ç”¨\u0026#34;)) .when(mockMailSender).send(any(SimpleMailMessage.class)); // When \u0026amp; Then assertThrows(MessageSendException.class, () -\u0026gt; emailAdapter.sendMessage(\u0026#34;test@example.com\u0026#34;, \u0026#34;æ¸¬è©¦ä¸»é¡Œ\u0026#34;, \u0026#34;æ¸¬è©¦å…§å®¹\u0026#34;)); } } @SpringBootTest class AdapterPatternIntegrationTest { @Autowired private UnifiedServiceManager serviceManager; @Test void testUnifiedServiceManager_ProcessBusinessLogic() { // Given String userId = \u0026#34;testUser\u0026#34;; String action = \u0026#34;login\u0026#34;; // When serviceManager.processBusinessLogic(userId, action); // Then // é©—è­‰æ¥­å‹™é‚è¼¯æ˜¯å¦æ­£ç¢ºåŸ·è¡Œ // é€™è£¡å¯ä»¥æª¢æŸ¥æ—¥èªŒã€æ•¸æ“šåº«ç‹€æ…‹ç­‰ } } æ€§èƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. é©é…å™¨å¿«å– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 public class CachedAdapterWrapper\u0026lt;T\u0026gt; implements DataSource { private final T originalAdapter; private final CacheService cacheService; private final Duration cacheTtl; public CachedAdapterWrapper(T originalAdapter, CacheService cacheService, Duration cacheTtl) { this.originalAdapter = originalAdapter; this.cacheService = cacheService; this.cacheTtl = cacheTtl; } @Override public List\u0026lt;Record\u0026gt; fetchData(QueryParameters params) { String cacheKey = generateCacheKey(params); List\u0026lt;Record\u0026gt; cachedResult = cacheService.get(cacheKey, List.class); if (cachedResult != null) { return cachedResult; } List\u0026lt;Record\u0026gt; result = ((DataSource) originalAdapter).fetchData(params); cacheService.put(cacheKey, result, cacheTtl); return result; } private String generateCacheKey(QueryParameters params) { return \u0026#34;query:\u0026#34; + params.hashCode(); } } 2. ç•°æ­¥é©é…å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 @Service public class AsyncMessageAdapter implements MessageSender { private final MessageSender originalSender; private final TaskExecutor taskExecutor; public AsyncMessageAdapter(MessageSender originalSender, TaskExecutor taskExecutor) { this.originalSender = originalSender; this.taskExecutor = taskExecutor; } @Override public void sendMessage(String recipient, String subject, String content) { taskExecutor.execute(() -\u0026gt; { try { originalSender.sendMessage(recipient, subject, content); } catch (Exception e) { // è¨˜éŒ„éŒ¯èª¤ï¼Œå¯èƒ½éœ€è¦é‡è©¦æ©Ÿåˆ¶ log.error(\u0026#34;ç•°æ­¥æ¶ˆæ¯ç™¼é€å¤±æ•—\u0026#34;, e); } }); } @Override public void sendBroadcast(String subject, String content) { taskExecutor.execute(() -\u0026gt; { try { originalSender.sendBroadcast(subject, content); } catch (Exception e) { log.error(\u0026#34;ç•°æ­¥å»£æ’­ç™¼é€å¤±æ•—\u0026#34;, e); } }); } @Override public boolean isAvailable() { return originalSender.isAvailable(); } } ç›£æ§èˆ‡è¨ºæ–· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Component public class AdapterMonitor { private final MeterRegistry meterRegistry; private final Counter adaptationCounter; private final Timer adaptationTimer; public AdapterMonitor(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.adaptationCounter = Counter.builder(\u0026#34;adapter.invocations\u0026#34;) .description(\u0026#34;Number of adapter invocations\u0026#34;) .register(meterRegistry); this.adaptationTimer = Timer.builder(\u0026#34;adapter.duration\u0026#34;) .description(\u0026#34;Time spent in adapter methods\u0026#34;) .register(meterRegistry); } public \u0026lt;T\u0026gt; T monitorAdapterCall(String adapterName, String methodName, Supplier\u0026lt;T\u0026gt; supplier) { return Timer.Sample.start(meterRegistry) .stop(adaptationTimer.withTag(\u0026#34;adapter\u0026#34;, adapterName).withTag(\u0026#34;method\u0026#34;, methodName)) .recordCallable(() -\u0026gt; { adaptationCounter.increment(Tags.of(\u0026#34;adapter\u0026#34;, adapterName, \u0026#34;method\u0026#34;, methodName)); return supplier.get(); }); } } ç¸½çµ é©é…å™¨æ¨¡å¼æ˜¯ä¸€ç¨®å¼·å¤§çš„çµæ§‹å‹è¨­è¨ˆæ¨¡å¼ï¼Œç‰¹åˆ¥é©ç”¨æ–¼ï¼š\néºç•™ç³»çµ±æ•´åˆï¼šå°‡èˆŠç³»çµ±ä»‹é¢é©é…åˆ°æ–°ç³»çµ± ç¬¬ä¸‰æ–¹APIæ•´åˆï¼šçµ±ä¸€ä¸åŒç¬¬ä¸‰æ–¹æœå‹™çš„ä»‹é¢ å¤šè³‡æ–™æºæ”¯æ´ï¼šæä¾›çµ±ä¸€çš„æ•¸æ“šå­˜å–ä»‹é¢ ç³»çµ±è§£è€¦ï¼šæ¸›å°‘ç³»çµ±é–“çš„ç›´æ¥ä¾è³´ é—œéµæœ€ä½³å¯¦è¸ å–®ä¸€è·è²¬ï¼šæ¯å€‹é©é…å™¨åªè² è²¬ä¸€ç¨®ä»‹é¢è½‰æ› ä»‹é¢çµ±ä¸€ï¼šè¨­è¨ˆæ¸…æ™°ã€ä¸€è‡´çš„ç›®æ¨™ä»‹é¢ éŒ¯èª¤è™•ç†ï¼šå¦¥å–„è™•ç†é©é…éç¨‹ä¸­çš„ç•°å¸¸ æ€§èƒ½è€ƒé‡ï¼šé©ç•¶ä½¿ç”¨å¿«å–å’Œç•°æ­¥è™•ç† ç›£æ§è¨ºæ–·ï¼šè¿½è¹¤é©é…å™¨çš„ä½¿ç”¨æƒ…æ³å’Œæ€§èƒ½ é©é…å™¨æ¨¡å¼è®“ä¸ç›¸å®¹çš„ä»‹é¢èƒ½å¤ å”åŒå·¥ä½œï¼Œæ˜¯ä¼æ¥­ç´šæ‡‰ç”¨ä¸­ä¸å¯æˆ–ç¼ºçš„è¨­è¨ˆæ¨¡å¼ã€‚æ­£ç¢ºä½¿ç”¨é©é…å™¨æ¨¡å¼å¯ä»¥å¤§å¹…æå‡ç³»çµ±çš„å¯ç¶­è­·æ€§å’Œæ“´å±•æ€§ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/adapter/","tags":["Design Pattern","Adapter Pattern","Structural Pattern","Interface Conversion","System Integration","Legacy System","Third-party API","Java","Spring Boot","Best Practices","Enterprise Architecture"],"title":"é©é…å™¨æ¨¡å¼ (Adapter Pattern) å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šä»‹é¢è½‰æ›èˆ‡ç³»çµ±æ•´åˆæœ€ä½³å¯¦è¸"},{"content":"åŸå‹æ¨¡å¼ (Prototype Pattern) å®Œæ•´å¯¦ä½œæŒ‡å— æ¨¡å¼æ¦‚è¿° åŸå‹æ¨¡å¼æ˜¯ä¸€ç¨®å‰µå»ºå‹è¨­è¨ˆæ¨¡å¼ï¼Œå®ƒå…è¨±é€šéè¤‡è£½ç¾æœ‰çš„å¯¦ä¾‹ä¾†å‰µå»ºæ–°å°è±¡ï¼Œè€Œä¸éœ€è¦çŸ¥é“å…·é«”å‰µå»ºéç¨‹çš„ç´°ç¯€ã€‚é€™å€‹æ¨¡å¼ç‰¹åˆ¥é©ç”¨æ–¼å‰µå»ºæˆæœ¬é«˜æ˜‚æˆ–è¤‡é›œçš„å°è±¡ï¼Œé€šéå…‹éš†å·²å­˜åœ¨çš„åŸå‹å¯¦ä¾‹ä¾†é¿å…é‡è¤‡çš„åˆå§‹åŒ–éç¨‹ã€‚\næ ¸å¿ƒæ¦‚å¿µ 1. åŸå‹æ¨¡å¼è§£æ±ºçš„å•é¡Œ æ˜‚è²´çš„å°è±¡å‰µå»ºï¼šé¿å…é‡è¤‡åŸ·è¡Œè€—æ™‚çš„åˆå§‹åŒ–æ“ä½œ è¤‡é›œçš„å°è±¡æ§‹é€ ï¼šç°¡åŒ–å…·æœ‰å¤šå€‹åƒæ•¸æˆ–è¤‡é›œç‹€æ…‹çš„å°è±¡å‰µå»º é‹è¡Œæ™‚å°è±¡å‰µå»ºï¼šåœ¨é‹è¡Œæ™‚å‹•æ…‹æ±ºå®šè¦å‰µå»ºçš„å°è±¡é¡å‹ æ¡†æ¶ç´šå°è±¡ç®¡ç†ï¼šå¦‚ Spring å®¹å™¨ä¸­çš„ prototype scope beans 2. æ·ºæ‹·è² vs æ·±æ‹·è² 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 /** * ç¤ºç¯„æ·ºæ‹·è²å’Œæ·±æ‹·è²çš„å·®ç•° */ public class CopyExample { public static class Address { private String street; private String city; public Address(String street, String city) { this.street = street; this.city = city; } // Copy constructor for deep copy public Address(Address address) { this.street = address.street; this.city = address.city; } // Getters and setters public String getStreet() { return street; } public void setStreet(String street) { this.street = street; } public String getCity() { return city; } public void setCity(String city) { this.city = city; } @Override public String toString() { return String.format(\u0026#34;Address{street=\u0026#39;%s\u0026#39;, city=\u0026#39;%s\u0026#39;}\u0026#34;, street, city); } } public static class Person implements Cloneable { private String name; private int age; private Address address; // Reference type public Person(String name, int age, Address address) { this.name = name; this.age = age; this.address = address; } /** * æ·ºæ‹·è² - åªè¤‡è£½åŸºæœ¬é¡å‹å’Œå¼•ç”¨åœ°å€ */ @Override public Person clone() throws CloneNotSupportedException { return (Person) super.clone(); // æ·ºæ‹·è² } /** * æ·±æ‹·è² - éæ­¸è¤‡è£½æ‰€æœ‰å¼•ç”¨å°è±¡ */ public Person deepClone() { Address newAddress = new Address(this.address); return new Person(this.name, this.age, newAddress); } // Getters and setters public String getName() { return name; } public void setName(String name) { this.name = name; } public int getAge() { return age; } public void setAge(int age) { this.age = age; } public Address getAddress() { return address; } public void setAddress(Address address) { this.address = address; } @Override public String toString() { return String.format(\u0026#34;Person{name=\u0026#39;%s\u0026#39;, age=%d, address=%s}\u0026#34;, name, age, address); } } public static void main(String[] args) throws CloneNotSupportedException { // åŸå§‹å°è±¡ Address originalAddress = new Address(\u0026#34;123 Main St\u0026#34;, \u0026#34;å°åŒ—å¸‚\u0026#34;); Person originalPerson = new Person(\u0026#34;John\u0026#34;, 30, originalAddress); // æ·ºæ‹·è²æ¸¬è©¦ Person shallowCopy = originalPerson.clone(); System.out.println(\u0026#34;=== æ·ºæ‹·è²æ¸¬è©¦ ===\u0026#34;); System.out.println(\u0026#34;åŸå§‹: \u0026#34; + originalPerson); System.out.println(\u0026#34;æ·ºæ‹·è²: \u0026#34; + shallowCopy); // ä¿®æ”¹æ·ºæ‹·è²çš„åœ°å€ shallowCopy.getAddress().setStreet(\u0026#34;456 Oak Ave\u0026#34;); System.out.println(\u0026#34;ä¿®æ”¹æ·ºæ‹·è²åœ°å€å¾Œ:\u0026#34;); System.out.println(\u0026#34;åŸå§‹: \u0026#34; + originalPerson); // ä¹Ÿè¢«æ”¹è®Šï¼ System.out.println(\u0026#34;æ·ºæ‹·è²: \u0026#34; + shallowCopy); // æ·±æ‹·è²æ¸¬è©¦ originalAddress.setStreet(\u0026#34;123 Main St\u0026#34;); // é‡ç½® Person deepCopy = originalPerson.deepClone(); System.out.println(\u0026#34;\\n=== æ·±æ‹·è²æ¸¬è©¦ ===\u0026#34;); System.out.println(\u0026#34;åŸå§‹: \u0026#34; + originalPerson); System.out.println(\u0026#34;æ·±æ‹·è²: \u0026#34; + deepCopy); // ä¿®æ”¹æ·±æ‹·è²çš„åœ°å€ deepCopy.getAddress().setStreet(\u0026#34;789 Pine Rd\u0026#34;); System.out.println(\u0026#34;ä¿®æ”¹æ·±æ‹·è²åœ°å€å¾Œ:\u0026#34;); System.out.println(\u0026#34;åŸå§‹: \u0026#34; + originalPerson); // ä¸å—å½±éŸ¿ System.out.println(\u0026#34;æ·±æ‹·è²: \u0026#34; + deepCopy); } } åŸºç¤å¯¦ä½œç¯„ä¾‹ 1. åŸå‹æ¥å£è¨­è¨ˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /** * é€šç”¨åŸå‹æ¥å£ */ public interface Prototype\u0026lt;T\u0026gt; { T clone(); T deepClone(); } /** * å¯åºåˆ—åŒ–çš„æ·±æ‹·è²æ¥å£ */ public interface SerializablePrototype\u0026lt;T\u0026gt; extends Prototype\u0026lt;T\u0026gt;, Serializable { /** * ä½¿ç”¨åºåˆ—åŒ–å¯¦ç¾æ·±æ‹·è² */ @SuppressWarnings(\u0026#34;unchecked\u0026#34;) default T deepCloneViaSerialization() { try (ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream out = new ObjectOutputStream(bos)) { out.writeObject(this); try (ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray()); ObjectInputStream in = new ObjectInputStream(bis)) { return (T) in.readObject(); } } catch (IOException | ClassNotFoundException e) { throw new RuntimeException(\u0026#34;æ·±æ‹·è²å¤±æ•—\u0026#34;, e); } } } 2. ä¼æ¥­ç´šåŸå‹ç®¡ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 /** * åŸå‹ç®¡ç†å™¨ - ç®¡ç†å’Œå‰µå»ºå„ç¨®åŸå‹å¯¦ä¾‹ */ @Component public class PrototypeManager { private final Map\u0026lt;String, Prototype\u0026lt;?\u0026gt;\u0026gt; prototypes = new ConcurrentHashMap\u0026lt;\u0026gt;(); private final Logger logger = LoggerFactory.getLogger(PrototypeManager.class); /** * è¨»å†ŠåŸå‹ */ public \u0026lt;T\u0026gt; void registerPrototype(String key, Prototype\u0026lt;T\u0026gt; prototype) { prototypes.put(key, prototype); logger.info(\u0026#34;è¨»å†ŠåŸå‹: {} -\u0026gt; {}\u0026#34;, key, prototype.getClass().getSimpleName()); } /** * ç²å–åŸå‹çš„æ·ºæ‹·è² */ @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; T getClone(String key) { Prototype\u0026lt;T\u0026gt; prototype = (Prototype\u0026lt;T\u0026gt;) prototypes.get(key); if (prototype == null) { throw new IllegalArgumentException(\u0026#34;æ‰¾ä¸åˆ°åŸå‹: \u0026#34; + key); } T clone = prototype.clone(); logger.debug(\u0026#34;å‰µå»ºæ·ºæ‹·è²: {} -\u0026gt; {}\u0026#34;, key, clone.getClass().getSimpleName()); return clone; } /** * ç²å–åŸå‹çš„æ·±æ‹·è² */ @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; T getDeepClone(String key) { Prototype\u0026lt;T\u0026gt; prototype = (Prototype\u0026lt;T\u0026gt;) prototypes.get(key); if (prototype == null) { throw new IllegalArgumentException(\u0026#34;æ‰¾ä¸åˆ°åŸå‹: \u0026#34; + key); } T deepClone = prototype.deepClone(); logger.debug(\u0026#34;å‰µå»ºæ·±æ‹·è²: {} -\u0026gt; {}\u0026#34;, key, deepClone.getClass().getSimpleName()); return deepClone; } /** * åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„åŸå‹ */ public Set\u0026lt;String\u0026gt; getAvailablePrototypes() { return Collections.unmodifiableSet(prototypes.keySet()); } /** * æ¸…é™¤æ‰€æœ‰åŸå‹ */ public void clearPrototypes() { prototypes.clear(); logger.info(\u0026#34;æ¸…é™¤æ‰€æœ‰åŸå‹\u0026#34;); } } 3. è¤‡é›œå°è±¡åŸå‹å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 /** * ä¼æ¥­ç´šç”¨æˆ¶é…ç½®åŸå‹ */ public class UserProfile implements SerializablePrototype\u0026lt;UserProfile\u0026gt; { private String userId; private String username; private String email; private List\u0026lt;String\u0026gt; roles; private Map\u0026lt;String, Object\u0026gt; preferences; private UserSettings settings; private LocalDateTime createdAt; private LocalDateTime lastModified; public UserProfile() { this.roles = new ArrayList\u0026lt;\u0026gt;(); this.preferences = new HashMap\u0026lt;\u0026gt;(); this.settings = new UserSettings(); this.createdAt = LocalDateTime.now(); this.lastModified = LocalDateTime.now(); } public UserProfile(String userId, String username, String email) { this(); this.userId = userId; this.username = username; this.email = email; } /** * æ·ºæ‹·è²å¯¦ç¾ */ @Override public UserProfile clone() { try { return (UserProfile) super.clone(); } catch (CloneNotSupportedException e) { throw new RuntimeException(\u0026#34;å…‹éš†å¤±æ•—\u0026#34;, e); } } /** * æ·±æ‹·è²å¯¦ç¾ */ @Override public UserProfile deepClone() { UserProfile cloned = new UserProfile(); cloned.userId = this.userId; cloned.username = this.username; cloned.email = this.email; cloned.roles = new ArrayList\u0026lt;\u0026gt;(this.roles); cloned.preferences = new HashMap\u0026lt;\u0026gt;(this.preferences); cloned.settings = this.settings.deepClone(); cloned.createdAt = this.createdAt; cloned.lastModified = LocalDateTime.now(); return cloned; } /** * ç”¨æˆ¶è¨­ç½®å…§éƒ¨é¡ */ public static class UserSettings implements Serializable { private String theme; private String language; private boolean emailNotifications; private Map\u0026lt;String, String\u0026gt; customSettings; public UserSettings() { this.theme = \u0026#34;default\u0026#34;; this.language = \u0026#34;zh-TW\u0026#34;; this.emailNotifications = true; this.customSettings = new HashMap\u0026lt;\u0026gt;(); } public UserSettings deepClone() { UserSettings cloned = new UserSettings(); cloned.theme = this.theme; cloned.language = this.language; cloned.emailNotifications = this.emailNotifications; cloned.customSettings = new HashMap\u0026lt;\u0026gt;(this.customSettings); return cloned; } // Getters and setters public String getTheme() { return theme; } public void setTheme(String theme) { this.theme = theme; } public String getLanguage() { return language; } public void setLanguage(String language) { this.language = language; } public boolean isEmailNotifications() { return emailNotifications; } public void setEmailNotifications(boolean emailNotifications) { this.emailNotifications = emailNotifications; } public Map\u0026lt;String, String\u0026gt; getCustomSettings() { return customSettings; } public void setCustomSettings(Map\u0026lt;String, String\u0026gt; customSettings) { this.customSettings = customSettings; } } // Getters and setters public String getUserId() { return userId; } public void setUserId(String userId) { this.userId = userId; } public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getEmail() { return email; } public void setEmail(String email) { this.email = email; } public List\u0026lt;String\u0026gt; getRoles() { return roles; } public void setRoles(List\u0026lt;String\u0026gt; roles) { this.roles = roles; } public Map\u0026lt;String, Object\u0026gt; getPreferences() { return preferences; } public void setPreferences(Map\u0026lt;String, Object\u0026gt; preferences) { this.preferences = preferences; } public UserSettings getSettings() { return settings; } public void setSettings(UserSettings settings) { this.settings = settings; } public LocalDateTime getCreatedAt() { return createdAt; } public LocalDateTime getLastModified() { return lastModified; } public void setLastModified(LocalDateTime lastModified) { this.lastModified = lastModified; } @Override public String toString() { return String.format(\u0026#34;UserProfile{userId=\u0026#39;%s\u0026#39;, username=\u0026#39;%s\u0026#39;, email=\u0026#39;%s\u0026#39;, roles=%s}\u0026#34;, userId, username, email, roles); } } Spring Boot æ•´åˆ 1. Spring Prototype Scope é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 /** * Spring Prototype Scope é…ç½® */ @Configuration public class PrototypePatternConfig { /** * Prototype scope bean - æ¯æ¬¡æ³¨å…¥æ™‚å‰µå»ºæ–°å¯¦ä¾‹ */ @Bean @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE) public UserProfile prototypeUserProfile() { UserProfile profile = new UserProfile(); profile.setUsername(\u0026#34;prototype-user\u0026#34;); profile.setEmail(\u0026#34;prototype@example.com\u0026#34;); profile.getRoles().add(\u0026#34;USER\u0026#34;); return profile; } /** * ä½¿ç”¨ @Lookup æ–¹æ³•æ³¨å…¥ prototype bean */ @Component public static abstract class UserProfileFactory { @Lookup public abstract UserProfile createUserProfile(); /** * å‰µå»ºè‡ªå®šç¾©ç”¨æˆ¶é…ç½® */ public UserProfile createCustomUserProfile(String userId, String username, String email) { UserProfile profile = createUserProfile(); profile.setUserId(userId); profile.setUsername(username); profile.setEmail(email); return profile; } } /** * åŸå‹ç®¡ç†å™¨é…ç½® */ @Bean public PrototypeManager prototypeManager() { PrototypeManager manager = new PrototypeManager(); // è¨»å†Šé è¨­åŸå‹ manager.registerPrototype(\u0026#34;admin-user\u0026#34;, createAdminUserProfile()); manager.registerPrototype(\u0026#34;guest-user\u0026#34;, createGuestUserProfile()); manager.registerPrototype(\u0026#34;vip-user\u0026#34;, createVipUserProfile()); return manager; } private UserProfile createAdminUserProfile() { UserProfile admin = new UserProfile(\u0026#34;admin\u0026#34;, \u0026#34;Administrator\u0026#34;, \u0026#34;admin@company.com\u0026#34;); admin.getRoles().addAll(Arrays.asList(\u0026#34;ADMIN\u0026#34;, \u0026#34;USER\u0026#34;, \u0026#34;MODERATOR\u0026#34;)); admin.getPreferences().put(\u0026#34;theme\u0026#34;, \u0026#34;dark\u0026#34;); admin.getPreferences().put(\u0026#34;language\u0026#34;, \u0026#34;en-US\u0026#34;); return admin; } private UserProfile createGuestUserProfile() { UserProfile guest = new UserProfile(\u0026#34;guest\u0026#34;, \u0026#34;Guest User\u0026#34;, \u0026#34;guest@example.com\u0026#34;); guest.getRoles().add(\u0026#34;GUEST\u0026#34;); guest.getPreferences().put(\u0026#34;theme\u0026#34;, \u0026#34;light\u0026#34;); guest.getPreferences().put(\u0026#34;language\u0026#34;, \u0026#34;zh-TW\u0026#34;); return guest; } private UserProfile createVipUserProfile() { UserProfile vip = new UserProfile(\u0026#34;vip\u0026#34;, \u0026#34;VIP User\u0026#34;, \u0026#34;vip@company.com\u0026#34;); vip.getRoles().addAll(Arrays.asList(\u0026#34;VIP\u0026#34;, \u0026#34;USER\u0026#34;)); vip.getPreferences().put(\u0026#34;theme\u0026#34;, \u0026#34;premium\u0026#34;); vip.getPreferences().put(\u0026#34;notifications\u0026#34;, \u0026#34;immediate\u0026#34;); return vip; } } 2. Spring Boot æœå‹™å±¤æ•´åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 /** * ç”¨æˆ¶é…ç½®æœå‹™ */ @Service @Transactional public class UserProfileService { private final PrototypeManager prototypeManager; private final UserProfileFactory userProfileFactory; private final ApplicationEventPublisher eventPublisher; private final Logger logger = LoggerFactory.getLogger(UserProfileService.class); public UserProfileService(PrototypeManager prototypeManager, UserProfileFactory userProfileFactory, ApplicationEventPublisher eventPublisher) { this.prototypeManager = prototypeManager; this.userProfileFactory = userProfileFactory; this.eventPublisher = eventPublisher; } /** * åŸºæ–¼åŸå‹å‰µå»ºç”¨æˆ¶é…ç½® */ public UserProfile createUserProfileFromPrototype(String prototypeKey, String userId) { try { UserProfile template = prototypeManager.getDeepClone(prototypeKey); template.setUserId(userId); template.setLastModified(LocalDateTime.now()); logger.info(\u0026#34;åŸºæ–¼åŸå‹ {} å‰µå»ºç”¨æˆ¶é…ç½®: {}\u0026#34;, prototypeKey, userId); eventPublisher.publishEvent(new UserProfileCreatedEvent(template, prototypeKey)); return template; } catch (Exception e) { logger.error(\u0026#34;å‰µå»ºç”¨æˆ¶é…ç½®å¤±æ•—: prototype={}, userId={}\u0026#34;, prototypeKey, userId, e); throw new UserProfileCreationException(\u0026#34;ç„¡æ³•å‰µå»ºç”¨æˆ¶é…ç½®\u0026#34;, e); } } /** * æ‰¹é‡å‰µå»ºç”¨æˆ¶é…ç½® */ public List\u0026lt;UserProfile\u0026gt; createBatchUserProfiles(String prototypeKey, List\u0026lt;String\u0026gt; userIds) { return userIds.stream() .map(userId -\u0026gt; createUserProfileFromPrototype(prototypeKey, userId)) .collect(Collectors.toList()); } /** * å¾ Spring prototype scope å‰µå»ºé…ç½® */ public UserProfile createUserProfileFromSpringPrototype(String userId, String username, String email) { UserProfile profile = userProfileFactory.createCustomUserProfile(userId, username, email); logger.info(\u0026#34;å¾ Spring prototype å‰µå»ºç”¨æˆ¶é…ç½®: {}\u0026#34;, userId); eventPublisher.publishEvent(new UserProfileCreatedEvent(profile, \u0026#34;spring-prototype\u0026#34;)); return profile; } /** * è¤‡è£½ç¾æœ‰ç”¨æˆ¶é…ç½® */ public UserProfile cloneUserProfile(UserProfile source, String newUserId, boolean deepCopy) { UserProfile cloned = deepCopy ? source.deepClone() : source.clone(); cloned.setUserId(newUserId); cloned.setCreatedAt(LocalDateTime.now()); cloned.setLastModified(LocalDateTime.now()); String copyType = deepCopy ? \u0026#34;æ·±æ‹·è²\u0026#34; : \u0026#34;æ·ºæ‹·è²\u0026#34;; logger.info(\u0026#34;{}ç”¨æˆ¶é…ç½®: {} -\u0026gt; {}\u0026#34;, copyType, source.getUserId(), newUserId); return cloned; } } /** * ç”¨æˆ¶é…ç½®å‰µå»ºäº‹ä»¶ */ public class UserProfileCreatedEvent { private final UserProfile userProfile; private final String sourceType; private final LocalDateTime timestamp; public UserProfileCreatedEvent(UserProfile userProfile, String sourceType) { this.userProfile = userProfile; this.sourceType = sourceType; this.timestamp = LocalDateTime.now(); } // Getters public UserProfile getUserProfile() { return userProfile; } public String getSourceType() { return sourceType; } public LocalDateTime getTimestamp() { return timestamp; } } /** * è‡ªå®šç¾©ç•°å¸¸ */ public class UserProfileCreationException extends RuntimeException { public UserProfileCreationException(String message, Throwable cause) { super(message, cause); } } 3. REST API æ§åˆ¶å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 /** * ç”¨æˆ¶é…ç½® REST API */ @RestController @RequestMapping(\u0026#34;/api/user-profiles\u0026#34;) @Validated public class UserProfileController { private final UserProfileService userProfileService; private final PrototypeManager prototypeManager; public UserProfileController(UserProfileService userProfileService, PrototypeManager prototypeManager) { this.userProfileService = userProfileService; this.prototypeManager = prototypeManager; } /** * åŸºæ–¼åŸå‹å‰µå»ºç”¨æˆ¶é…ç½® */ @PostMapping(\u0026#34;/create/{prototypeKey}\u0026#34;) public ResponseEntity\u0026lt;UserProfileResponse\u0026gt; createFromPrototype( @PathVariable String prototypeKey, @RequestParam String userId) { try { UserProfile profile = userProfileService.createUserProfileFromPrototype(prototypeKey, userId); return ResponseEntity.ok(UserProfileResponse.success(profile)); } catch (IllegalArgumentException e) { return ResponseEntity.badRequest() .body(UserProfileResponse.error(\u0026#34;ç„¡æ•ˆçš„åŸå‹: \u0026#34; + prototypeKey)); } catch (Exception e) { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(UserProfileResponse.error(\u0026#34;å‰µå»ºå¤±æ•—: \u0026#34; + e.getMessage())); } } /** * æ‰¹é‡å‰µå»ºç”¨æˆ¶é…ç½® */ @PostMapping(\u0026#34;/batch/{prototypeKey}\u0026#34;) public ResponseEntity\u0026lt;BatchUserProfileResponse\u0026gt; createBatch( @PathVariable String prototypeKey, @RequestBody @Valid BatchCreateRequest request) { try { List\u0026lt;UserProfile\u0026gt; profiles = userProfileService.createBatchUserProfiles( prototypeKey, request.getUserIds()); return ResponseEntity.ok(BatchUserProfileResponse.success(profiles)); } catch (Exception e) { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(BatchUserProfileResponse.error(\u0026#34;æ‰¹é‡å‰µå»ºå¤±æ•—: \u0026#34; + e.getMessage())); } } /** * è¤‡è£½ç”¨æˆ¶é…ç½® */ @PostMapping(\u0026#34;/clone\u0026#34;) public ResponseEntity\u0026lt;UserProfileResponse\u0026gt; cloneProfile( @RequestBody @Valid CloneProfileRequest request) { // é€™è£¡ç°¡åŒ–ç‚ºå¾åŸå‹å…‹éš†ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­å¯èƒ½å¾ç¾æœ‰ç”¨æˆ¶é…ç½®å…‹éš† UserProfile source = userProfileService.createUserProfileFromPrototype( request.getSourcePrototype(), \u0026#34;temp\u0026#34;); UserProfile cloned = userProfileService.cloneUserProfile( source, request.getNewUserId(), request.isDeepCopy()); return ResponseEntity.ok(UserProfileResponse.success(cloned)); } /** * ç²å–å¯ç”¨çš„åŸå‹ */ @GetMapping(\u0026#34;/prototypes\u0026#34;) public ResponseEntity\u0026lt;Set\u0026lt;String\u0026gt;\u0026gt; getAvailablePrototypes() { Set\u0026lt;String\u0026gt; prototypes = prototypeManager.getAvailablePrototypes(); return ResponseEntity.ok(prototypes); } } /** * è«‹æ±‚ DTO */ public static class BatchCreateRequest { @NotEmpty private List\u0026lt;String\u0026gt; userIds; public List\u0026lt;String\u0026gt; getUserIds() { return userIds; } public void setUserIds(List\u0026lt;String\u0026gt; userIds) { this.userIds = userIds; } } public static class CloneProfileRequest { @NotBlank private String sourcePrototype; @NotBlank private String newUserId; private boolean deepCopy = true; public String getSourcePrototype() { return sourcePrototype; } public void setSourcePrototype(String sourcePrototype) { this.sourcePrototype = sourcePrototype; } public String getNewUserId() { return newUserId; } public void setNewUserId(String newUserId) { this.newUserId = newUserId; } public boolean isDeepCopy() { return deepCopy; } public void setDeepCopy(boolean deepCopy) { this.deepCopy = deepCopy; } } /** * å›æ‡‰ DTO */ public static class UserProfileResponse { private boolean success; private String message; private UserProfile data; private LocalDateTime timestamp; private UserProfileResponse(boolean success, String message, UserProfile data) { this.success = success; this.message = message; this.data = data; this.timestamp = LocalDateTime.now(); } public static UserProfileResponse success(UserProfile profile) { return new UserProfileResponse(true, \u0026#34;æ“ä½œæˆåŠŸ\u0026#34;, profile); } public static UserProfileResponse error(String message) { return new UserProfileResponse(false, message, null); } // Getters public boolean isSuccess() { return success; } public String getMessage() { return message; } public UserProfile getData() { return data; } public LocalDateTime getTimestamp() { return timestamp; } } public static class BatchUserProfileResponse { private boolean success; private String message; private List\u0026lt;UserProfile\u0026gt; data; private int totalCount; private LocalDateTime timestamp; private BatchUserProfileResponse(boolean success, String message, List\u0026lt;UserProfile\u0026gt; data) { this.success = success; this.message = message; this.data = data; this.totalCount = data != null ? data.size() : 0; this.timestamp = LocalDateTime.now(); } public static BatchUserProfileResponse success(List\u0026lt;UserProfile\u0026gt; profiles) { return new BatchUserProfileResponse(true, \u0026#34;æ‰¹é‡æ“ä½œæˆåŠŸ\u0026#34;, profiles); } public static BatchUserProfileResponse error(String message) { return new BatchUserProfileResponse(false, message, null); } // Getters public boolean isSuccess() { return success; } public String getMessage() { return message; } public List\u0026lt;UserProfile\u0026gt; getData() { return data; } public int getTotalCount() { return totalCount; } public LocalDateTime getTimestamp() { return timestamp; } } é€²éšä¸»é¡Œ 1. æ•ˆèƒ½å„ªåŒ–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 /** * é«˜æ•ˆèƒ½åŸå‹ç®¡ç†å™¨ */ @Component public class OptimizedPrototypeManager extends PrototypeManager { private final Cache\u0026lt;String, Object\u0026gt; prototypeCache; private final ExecutorService executorService; private final AtomicLong cloneCounter = new AtomicLong(0); public OptimizedPrototypeManager() { this.prototypeCache = Caffeine.newBuilder() .maximumSize(500) .expireAfterAccess(30, TimeUnit.MINUTES) .recordStats() .build(); this.executorService = Executors.newFixedThreadPool( Runtime.getRuntime().availableProcessors()); } /** * ç•°æ­¥æ‰¹é‡å…‹éš† */ public \u0026lt;T\u0026gt; CompletableFuture\u0026lt;List\u0026lt;T\u0026gt;\u0026gt; asyncBatchClone(String prototypeKey, int count) { return CompletableFuture.supplyAsync(() -\u0026gt; { List\u0026lt;T\u0026gt; results = new ArrayList\u0026lt;\u0026gt;(count); for (int i = 0; i \u0026lt; count; i++) { results.add(getDeepClone(prototypeKey)); } cloneCounter.addAndGet(count); return results; }, executorService); } /** * å¸¶å¿«å–çš„å…‹éš† */ @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; T getCachedClone(String key, Duration cacheDuration) { String cacheKey = key + \u0026#34;_cached\u0026#34;; return (T) prototypeCache.get(cacheKey, k -\u0026gt; { T clone = getDeepClone(key); // è¨­å®šå¿«å–éæœŸæ™‚é–“ï¼ˆç°¡åŒ–å¯¦ç¾ï¼‰ return clone; }); } /** * æ•ˆèƒ½çµ±è¨ˆ */ public PrototypeManagerStats getStats() { CacheStats cacheStats = prototypeCache.stats(); return new PrototypeManagerStats( cloneCounter.get(), cacheStats.hitRate(), cacheStats.missRate(), cacheStats.evictionCount() ); } public static class PrototypeManagerStats { private final long totalClones; private final double cacheHitRate; private final double cacheMissRate; private final long cacheEvictions; public PrototypeManagerStats(long totalClones, double cacheHitRate, double cacheMissRate, long cacheEvictions) { this.totalClones = totalClones; this.cacheHitRate = cacheHitRate; this.cacheMissRate = cacheMissRate; this.cacheEvictions = cacheEvictions; } // Getters public long getTotalClones() { return totalClones; } public double getCacheHitRate() { return cacheHitRate; } public double getCacheMissRate() { return cacheMissRate; } public long getCacheEvictions() { return cacheEvictions; } @Override public String toString() { return String.format(\u0026#34;PrototypeManagerStats{totalClones=%d, hitRate=%.2f%%, missRate=%.2f%%, evictions=%d}\u0026#34;, totalClones, cacheHitRate * 100, cacheMissRate * 100, cacheEvictions); } } } 2. æ¸¬è©¦ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 /** * åŸå‹æ¨¡å¼å–®å…ƒæ¸¬è©¦ */ @ExtendWith(MockitoExtension.class) class PrototypePatternTest { @InjectMocks private PrototypeManager prototypeManager; @Test void testShallowVsDeepCopy() { // Given UserProfile original = createTestUserProfile(); // When - æ·ºæ‹·è² UserProfile shallowCopy = original.clone(); shallowCopy.getSettings().setTheme(\u0026#34;dark\u0026#34;); // Then - åŸå§‹å°è±¡ä¹Ÿè¢«ä¿®æ”¹ assertThat(original.getSettings().getTheme()).isEqualTo(\u0026#34;dark\u0026#34;); // When - æ·±æ‹·è² UserProfile deepCopy = original.deepClone(); deepCopy.getSettings().setTheme(\u0026#34;blue\u0026#34;); // Then - åŸå§‹å°è±¡ä¸å—å½±éŸ¿ assertThat(original.getSettings().getTheme()).isEqualTo(\u0026#34;dark\u0026#34;); assertThat(deepCopy.getSettings().getTheme()).isEqualTo(\u0026#34;blue\u0026#34;); } @Test void testPrototypeManagerRegistration() { // Given UserProfile adminPrototype = createAdminUserProfile(); // When prototypeManager.registerPrototype(\u0026#34;admin\u0026#34;, adminPrototype); // Then assertThat(prototypeManager.getAvailablePrototypes()).contains(\u0026#34;admin\u0026#34;); UserProfile cloned = prototypeManager.getDeepClone(\u0026#34;admin\u0026#34;); assertThat(cloned).isNotSameAs(adminPrototype); assertThat(cloned.getUsername()).isEqualTo(adminPrototype.getUsername()); } @Test void testSerializationDeepCopy() { // Given UserProfile original = createTestUserProfile(); // When UserProfile serializedCopy = original.deepCloneViaSerialization(); // Then assertThat(serializedCopy).isNotSameAs(original); assertThat(serializedCopy.getSettings()).isNotSameAs(original.getSettings()); assertThat(serializedCopy.getUsername()).isEqualTo(original.getUsername()); } @Test void testPrototypeNotFound() { // When \u0026amp; Then assertThatThrownBy(() -\u0026gt; prototypeManager.getClone(\u0026#34;non-existent\u0026#34;)) .isInstanceOf(IllegalArgumentException.class) .hasMessageContaining(\u0026#34;æ‰¾ä¸åˆ°åŸå‹\u0026#34;); } private UserProfile createTestUserProfile() { UserProfile profile = new UserProfile(\u0026#34;test-001\u0026#34;, \u0026#34;testuser\u0026#34;, \u0026#34;test@example.com\u0026#34;); profile.getRoles().add(\u0026#34;USER\u0026#34;); profile.getPreferences().put(\u0026#34;language\u0026#34;, \u0026#34;zh-TW\u0026#34;); return profile; } private UserProfile createAdminUserProfile() { UserProfile admin = new UserProfile(\u0026#34;admin-001\u0026#34;, \u0026#34;admin\u0026#34;, \u0026#34;admin@company.com\u0026#34;); admin.getRoles().addAll(Arrays.asList(\u0026#34;ADMIN\u0026#34;, \u0026#34;USER\u0026#34;)); admin.getPreferences().put(\u0026#34;theme\u0026#34;, \u0026#34;admin\u0026#34;); return admin; } } /** * Spring Boot æ•´åˆæ¸¬è©¦ */ @SpringBootTest @TestPropertySource(properties = { \u0026#34;logging.level.com.example.prototype=DEBUG\u0026#34; }) class PrototypePatternIntegrationTest { @Autowired private UserProfileService userProfileService; @Autowired private PrototypeManager prototypeManager; @Test void testSpringPrototypeScopeCreation() { // When UserProfile profile1 = userProfileService.createUserProfileFromSpringPrototype( \u0026#34;user1\u0026#34;, \u0026#34;testuser1\u0026#34;, \u0026#34;test1@example.com\u0026#34;); UserProfile profile2 = userProfileService.createUserProfileFromSpringPrototype( \u0026#34;user2\u0026#34;, \u0026#34;testuser2\u0026#34;, \u0026#34;test2@example.com\u0026#34;); // Then assertThat(profile1).isNotSameAs(profile2); assertThat(profile1.getUserId()).isEqualTo(\u0026#34;user1\u0026#34;); assertThat(profile2.getUserId()).isEqualTo(\u0026#34;user2\u0026#34;); } @Test void testPrototypeManagerIntegration() { // Given Set\u0026lt;String\u0026gt; availablePrototypes = prototypeManager.getAvailablePrototypes(); assertThat(availablePrototypes).isNotEmpty(); // When String prototypeKey = availablePrototypes.iterator().next(); UserProfile profile = userProfileService.createUserProfileFromPrototype(prototypeKey, \u0026#34;integration-test\u0026#34;); // Then assertThat(profile).isNotNull(); assertThat(profile.getUserId()).isEqualTo(\u0026#34;integration-test\u0026#34;); } @Test void testBatchUserProfileCreation() { // Given List\u0026lt;String\u0026gt; userIds = Arrays.asList(\u0026#34;batch1\u0026#34;, \u0026#34;batch2\u0026#34;, \u0026#34;batch3\u0026#34;); // When List\u0026lt;UserProfile\u0026gt; profiles = userProfileService.createBatchUserProfiles(\u0026#34;guest-user\u0026#34;, userIds); // Then assertThat(profiles).hasSize(3); assertThat(profiles.stream().map(UserProfile::getUserId)) .containsExactlyInAnyOrder(\u0026#34;batch1\u0026#34;, \u0026#34;batch2\u0026#34;, \u0026#34;batch3\u0026#34;); } } æœ€ä½³å¯¦è¸èˆ‡å»ºè­° 1. è¨­è¨ˆåŸå‰‡ æ˜ç¢ºæ‹·è²èªç¾©ï¼šæ¸…æ¥šå®šç¾©ä½•æ™‚ä½¿ç”¨æ·ºæ‹·è²ï¼Œä½•æ™‚ä½¿ç”¨æ·±æ‹·è² ç•°å¸¸è™•ç†ï¼šç¢ºä¿å…‹éš†éç¨‹ä¸­çš„ç•°å¸¸å¾—åˆ°é©ç•¶è™•ç† æ•ˆèƒ½è€ƒé‡ï¼šå°æ–¼é »ç¹å…‹éš†çš„å°è±¡è€ƒæ…®ä½¿ç”¨å°è±¡æ± æˆ–å¿«å– 2. å¸¸è¦‹é™·é˜± é¿å…åœ¨æ‹·è²éç¨‹ä¸­ä¿®æ”¹ç‹€æ…‹ 1 2 3 4 5 6 7 8 9 10 11 12 // âŒ éŒ¯èª¤çš„è¨­è¨ˆ - åœ¨å…‹éš†ä¸­ä¿®æ”¹ç‹€æ…‹ public UserProfile clone() { UserProfile cloned = (UserProfile) super.clone(); cloned.setLastModified(LocalDateTime.now()); // å¯èƒ½å°è‡´ä½µç™¼å•é¡Œ return cloned; } // âœ… æ­£ç¢ºçš„è¨­è¨ˆ - åœ¨å…‹éš†å¾Œè¨­å®šç‹€æ…‹ public UserProfile clone() { UserProfile cloned = (UserProfile) super.clone(); return cloned; } æ­£ç¢ºè™•ç†åºåˆ—åŒ–ç‰ˆæœ¬ 1 2 3 4 5 // âœ… æ·»åŠ  serialVersionUID ç¢ºä¿åºåˆ—åŒ–å…¼å®¹æ€§ public class UserProfile implements SerializablePrototype\u0026lt;UserProfile\u0026gt; { private static final long serialVersionUID = 1L; // ... } 3. ä½¿ç”¨å»ºè­° é©ç”¨å ´æ™¯ï¼šæ˜‚è²´å°è±¡å‰µå»ºã€è¤‡é›œç‹€æ…‹åˆå§‹åŒ–ã€å‹•æ…‹å°è±¡é¡å‹é¸æ“‡ Spring æ•´åˆï¼šå–„ç”¨ prototype scope å’Œ @Lookup æ–¹æ³•æ³¨å…¥ æ•ˆèƒ½å„ªåŒ–ï¼šè€ƒæ…®ä½¿ç”¨å°è±¡æ± ã€å¿«å–å’Œç•°æ­¥è™•ç† ç¸½çµ åŸå‹æ¨¡å¼é€šéè¤‡è£½ç¾æœ‰å°è±¡ä¾†å‰µå»ºæ–°å¯¦ä¾‹ï¼Œé¿å…äº†é‡è¤‡çš„åˆå§‹åŒ–éç¨‹ï¼Œç‰¹åˆ¥é©åˆå‰µå»ºæˆæœ¬é«˜æ˜‚æˆ–ç‹€æ…‹è¤‡é›œçš„å°è±¡ã€‚åœ¨ä¼æ¥­ç´šæ‡‰ç”¨ä¸­ï¼Œçµåˆ Spring æ¡†æ¶çš„ prototype scope å’Œä¾è³´æ³¨å…¥æ©Ÿåˆ¶ï¼Œå¯ä»¥å¯¦ç¾éˆæ´»ä¸”é«˜æ•ˆçš„å°è±¡å‰µå»ºç­–ç•¥ã€‚\nä¸»è¦å„ªé» æ•ˆèƒ½æå‡ï¼šé¿å…æ˜‚è²´çš„å°è±¡å‰µå»ºéç¨‹ ç°¡åŒ–å‰µå»ºï¼šéš±è—è¤‡é›œçš„å°è±¡æ§‹é€ é‚è¼¯ å‹•æ…‹é¡å‹ï¼šé‹è¡Œæ™‚æ±ºå®šå‰µå»ºçš„å°è±¡é¡å‹ ç‹€æ…‹ä¿æŒï¼šä¿æŒåŸå‹å°è±¡çš„åˆå§‹ç‹€æ…‹ ä¸»è¦ç¼ºé» æ·±æ‹·è²è¤‡é›œæ€§ï¼šè™•ç†å¾ªç’°å¼•ç”¨å’Œæ·±å±¤åµŒå¥—å°è±¡ å…‹éš†å¯¦ç¾è¦æ±‚ï¼šæ¯å€‹é¡éƒ½éœ€è¦å¯¦ç¾å…‹éš†é‚è¼¯ å…§å­˜ä½¿ç”¨ï¼šå¯èƒ½å¢åŠ å…§å­˜ä½”ç”¨ æ­£ç¢ºä½¿ç”¨åŸå‹æ¨¡å¼å¯ä»¥æœ‰æ•ˆæå‡å°è±¡å‰µå»ºçš„æ•ˆç‡å’Œéˆæ´»æ€§ï¼Œæ˜¯ä¼æ¥­ç´šæ‡‰ç”¨é–‹ç™¼ä¸­é‡è¦çš„å‰µå»ºå‹è¨­è¨ˆæ¨¡å¼ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/prototype/","tags":["Design Pattern","Prototype Pattern","Creational Pattern","Object Cloning","Deep Copy","Shallow Copy","Spring Prototype","Bean Scope","Java","Spring Boot","Enterprise Architecture","Object Creation","Memory Management","Performance Optimization","Serialization","Copy Constructor","Best Practices"],"title":"åŸå‹æ¨¡å¼ (Prototype Pattern) å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šæ·±æ·ºæ‹·è²ã€Spring Prototype Scope èˆ‡ä¼æ¥­ç´šå°è±¡å‰µå»ºæœ€ä½³å¯¦è¸"},{"content":"å»ºé€ è€…æ¨¡å¼ (Builder Pattern) å®Œæ•´å¯¦ä½œæŒ‡å— æ¨¡å¼æ¦‚è¿° å»ºé€ è€…æ¨¡å¼æ˜¯ä¸€ç¨®å‰µå»ºå‹è¨­è¨ˆæ¨¡å¼ï¼Œå®ƒå°‡è¤‡é›œå°è±¡çš„æ§‹é€ èˆ‡å…¶è¡¨ç¤ºåˆ†é›¢ï¼Œä½¿å¾—åŒæ¨£çš„æ§‹é€ éç¨‹å¯ä»¥å‰µå»ºä¸åŒçš„è¡¨ç¤ºã€‚è©²æ¨¡å¼ç‰¹åˆ¥é©ç”¨æ–¼æ§‹é€ åƒæ•¸çœ¾å¤šã€é…ç½®è¤‡é›œçš„å°è±¡ã€‚\næ ¸å¿ƒæ¦‚å¿µ å»ºé€ è€…æ¨¡å¼è§£æ±ºçš„æ ¸å¿ƒå•é¡Œï¼š\nè¤‡é›œå°è±¡æ§‹é€ ï¼šç•¶å°è±¡æœ‰å¤šå€‹å¯é¸åƒæ•¸æ™‚ï¼Œé¿å…æ§‹é€ å‡½æ•¸åƒæ•¸éå¤š æ­¥é©ŸåŒ–æ§‹é€ ï¼šå°‡å°è±¡æ§‹é€ éç¨‹åˆ†è§£ç‚ºå¤šå€‹æ­¥é©Ÿ ä¸è®Šæ€§ä¿è­‰ï¼šç¢ºä¿æ§‹é€ å®Œæˆçš„å°è±¡æ˜¯ä¸å¯è®Šçš„ å¯è®€æ€§æå‡ï¼šæä¾›æ¸…æ™°ã€ç›´è§€çš„å°è±¡æ§‹é€ æ–¹å¼ å‚³çµ±å»ºé€ è€…æ¨¡å¼å¯¦ç¾ 1. åŸºæœ¬çµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 // ç”¢å“é¡ - è¦æ§‹é€ çš„è¤‡é›œå°è±¡ public class Computer { private String cpu; private String memory; private String storage; private String graphics; private String motherboard; private String powerSupply; private String coolingSystem; private boolean isOverclocked; // ç§æœ‰æ§‹é€ å‡½æ•¸ï¼Œåªèƒ½é€šéBuilderå‰µå»º private Computer(Builder builder) { this.cpu = builder.cpu; this.memory = builder.memory; this.storage = builder.storage; this.graphics = builder.graphics; this.motherboard = builder.motherboard; this.powerSupply = builder.powerSupply; this.coolingSystem = builder.coolingSystem; this.isOverclocked = builder.isOverclocked; } // æŠ½è±¡å»ºé€ è€…æ¥å£ public interface ComputerBuilder { ComputerBuilder setCpu(String cpu); ComputerBuilder setMemory(String memory); ComputerBuilder setStorage(String storage); ComputerBuilder setGraphics(String graphics); ComputerBuilder setMotherboard(String motherboard); ComputerBuilder setPowerSupply(String powerSupply); ComputerBuilder setCoolingSystem(String coolingSystem); ComputerBuilder setOverclocked(boolean overclocked); Computer build(); } // å…·é«”å»ºé€ è€…å¯¦ç¾ public static class Builder implements ComputerBuilder { private String cpu; private String memory; private String storage; private String graphics; private String motherboard; private String powerSupply; private String coolingSystem; private boolean isOverclocked; @Override public Builder setCpu(String cpu) { this.cpu = cpu; return this; } @Override public Builder setMemory(String memory) { this.memory = memory; return this; } @Override public Builder setStorage(String storage) { this.storage = storage; return this; } @Override public Builder setGraphics(String graphics) { this.graphics = graphics; return this; } @Override public Builder setMotherboard(String motherboard) { this.motherboard = motherboard; return this; } @Override public Builder setPowerSupply(String powerSupply) { this.powerSupply = powerSupply; return this; } @Override public Builder setCoolingSystem(String coolingSystem) { this.coolingSystem = coolingSystem; return this; } @Override public Builder setOverclocked(boolean overclocked) { this.isOverclocked = overclocked; return this; } @Override public Computer build() { validateConfiguration(); return new Computer(this); } private void validateConfiguration() { if (cpu == null) { throw new IllegalStateException(\u0026#34;CPU æ˜¯å¿…éœ€çš„çµ„ä»¶\u0026#34;); } if (memory == null) { throw new IllegalStateException(\u0026#34;è¨˜æ†¶é«”æ˜¯å¿…éœ€çš„çµ„ä»¶\u0026#34;); } if (storage == null) { throw new IllegalStateException(\u0026#34;å„²å­˜è¨­å‚™æ˜¯å¿…éœ€çš„çµ„ä»¶\u0026#34;); } if (isOverclocked \u0026amp;\u0026amp; coolingSystem == null) { throw new IllegalStateException(\u0026#34;è¶…é »é…ç½®éœ€è¦å†·å»ç³»çµ±\u0026#34;); } } } // æŒ‡å°è€…é¡ - å®šç¾©æ§‹é€ æ­¥é©Ÿ public static class Director { public Computer buildGamingComputer() { return new Builder() .setCpu(\u0026#34;Intel i9-13900K\u0026#34;) .setMemory(\u0026#34;32GB DDR5\u0026#34;) .setStorage(\u0026#34;1TB NVMe SSD\u0026#34;) .setGraphics(\u0026#34;RTX 4080\u0026#34;) .setMotherboard(\u0026#34;ASUS ROG Maximus\u0026#34;) .setPowerSupply(\u0026#34;850W 80+ Gold\u0026#34;) .setCoolingSystem(\u0026#34;AIO 240mm\u0026#34;) .setOverclocked(true) .build(); } public Computer buildOfficeComputer() { return new Builder() .setCpu(\u0026#34;Intel i5-13400\u0026#34;) .setMemory(\u0026#34;16GB DDR4\u0026#34;) .setStorage(\u0026#34;512GB SATA SSD\u0026#34;) .setGraphics(\u0026#34;Intel UHD Graphics\u0026#34;) .setMotherboard(\u0026#34;MSI B660\u0026#34;) .setPowerSupply(\u0026#34;500W 80+ Bronze\u0026#34;) .build(); } public Computer buildWorkstationComputer() { return new Builder() .setCpu(\u0026#34;AMD Ryzen 9 7950X\u0026#34;) .setMemory(\u0026#34;64GB DDR5\u0026#34;) .setStorage(\u0026#34;2TB NVMe SSD\u0026#34;) .setGraphics(\u0026#34;RTX 4090\u0026#34;) .setMotherboard(\u0026#34;ASUS ProArt\u0026#34;) .setPowerSupply(\u0026#34;1000W 80+ Platinum\u0026#34;) .setCoolingSystem(\u0026#34;Custom Loop\u0026#34;) .build(); } } // Getter æ–¹æ³• public String getCpu() { return cpu; } public String getMemory() { return memory; } public String getStorage() { return storage; } public String getGraphics() { return graphics; } public String getMotherboard() { return motherboard; } public String getPowerSupply() { return powerSupply; } public String getCoolingSystem() { return coolingSystem; } public boolean isOverclocked() { return isOverclocked; } @Override public String toString() { return \u0026#34;Computer{\u0026#34; + \u0026#34;cpu=\u0026#39;\u0026#34; + cpu + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, memory=\u0026#39;\u0026#34; + memory + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, storage=\u0026#39;\u0026#34; + storage + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, graphics=\u0026#39;\u0026#34; + graphics + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, motherboard=\u0026#39;\u0026#34; + motherboard + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, powerSupply=\u0026#39;\u0026#34; + powerSupply + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, coolingSystem=\u0026#39;\u0026#34; + coolingSystem + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, isOverclocked=\u0026#34; + isOverclocked + \u0026#39;}\u0026#39;; } } 2. ä½¿ç”¨ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public class BuilderPatternExample { public static void main(String[] args) { // ä½¿ç”¨ Director æ§‹é€ é å®šç¾©é…ç½® Computer.Director director = new Computer.Director(); Computer gamingPC = director.buildGamingComputer(); System.out.println(\u0026#34;éŠæˆ²é›»è…¦: \u0026#34; + gamingPC); Computer officePC = director.buildOfficeComputer(); System.out.println(\u0026#34;è¾¦å…¬é›»è…¦: \u0026#34; + officePC); // ç›´æ¥ä½¿ç”¨ Builder è‡ªå®šç¾©é…ç½® Computer customPC = new Computer.Builder() .setCpu(\u0026#34;AMD Ryzen 7 7800X3D\u0026#34;) .setMemory(\u0026#34;32GB DDR5\u0026#34;) .setStorage(\u0026#34;1TB NVMe SSD\u0026#34;) .setGraphics(\u0026#34;RTX 4070\u0026#34;) .setMotherboard(\u0026#34;MSI MAG X670E\u0026#34;) .setPowerSupply(\u0026#34;750W 80+ Gold\u0026#34;) .setCoolingSystem(\u0026#34;Air Cooler\u0026#34;) .build(); System.out.println(\u0026#34;è‡ªå®šç¾©é›»è…¦: \u0026#34; + customPC); } } ç¾ä»£å»ºé€ è€…æ¨¡å¼å¯¦ç¾ 1. æµå¼ä»‹é¢å»ºé€ è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 // ç¾ä»£åŒ–çš„å»ºé€ è€…æ¨¡å¼å¯¦ç¾ public class DatabaseConfiguration { private final String host; private final int port; private final String database; private final String username; private final String password; private final int connectionPoolSize; private final int connectionTimeout; private final boolean useSSL; private final boolean autoReconnect; private final Map\u0026lt;String, String\u0026gt; properties; private DatabaseConfiguration(Builder builder) { this.host = builder.host; this.port = builder.port; this.database = builder.database; this.username = builder.username; this.password = builder.password; this.connectionPoolSize = builder.connectionPoolSize; this.connectionTimeout = builder.connectionTimeout; this.useSSL = builder.useSSL; this.autoReconnect = builder.autoReconnect; this.properties = Collections.unmodifiableMap(new HashMap\u0026lt;\u0026gt;(builder.properties)); } public static class Builder { // å¿…éœ€åƒæ•¸ private String host; private int port; private String database; private String username; private String password; // å¯é¸åƒæ•¸ï¼Œæä¾›é»˜èªå€¼ private int connectionPoolSize = 10; private int connectionTimeout = 30000; private boolean useSSL = false; private boolean autoReconnect = true; private Map\u0026lt;String, String\u0026gt; properties = new HashMap\u0026lt;\u0026gt;(); // å¿…éœ€åƒæ•¸çš„æ§‹é€ å‡½æ•¸ public Builder(String host, int port, String database, String username, String password) { this.host = requireNonNull(host, \u0026#34;Host ä¸èƒ½ç‚ºç©º\u0026#34;); this.port = requireValidPort(port); this.database = requireNonNull(database, \u0026#34;Database ä¸èƒ½ç‚ºç©º\u0026#34;); this.username = requireNonNull(username, \u0026#34;Username ä¸èƒ½ç‚ºç©º\u0026#34;); this.password = requireNonNull(password, \u0026#34;Password ä¸èƒ½ç‚ºç©º\u0026#34;); } public Builder connectionPoolSize(int size) { if (size \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;é€£æ¥æ± å¤§å°å¿…é ˆå¤§æ–¼0\u0026#34;); } this.connectionPoolSize = size; return this; } public Builder connectionTimeout(int timeout) { if (timeout \u0026lt; 0) { throw new IllegalArgumentException(\u0026#34;é€£æ¥è¶…æ™‚ä¸èƒ½ç‚ºè² æ•¸\u0026#34;); } this.connectionTimeout = timeout; return this; } public Builder useSSL(boolean useSSL) { this.useSSL = useSSL; return this; } public Builder autoReconnect(boolean autoReconnect) { this.autoReconnect = autoReconnect; return this; } public Builder property(String key, String value) { this.properties.put(requireNonNull(key), requireNonNull(value)); return this; } public Builder properties(Map\u0026lt;String, String\u0026gt; properties) { this.properties.putAll(requireNonNull(properties)); return this; } public DatabaseConfiguration build() { validateConfiguration(); return new DatabaseConfiguration(this); } private void validateConfiguration() { if (useSSL \u0026amp;\u0026amp; port == 3306) { throw new IllegalStateException(\u0026#34;SSL é€£æ¥å»ºè­°ä½¿ç”¨éæ¨™æº–ç«¯å£\u0026#34;); } if (connectionPoolSize \u0026gt; 100) { throw new IllegalStateException(\u0026#34;é€£æ¥æ± å¤§å°éå¤§ï¼Œå»ºè­°ä¸è¶…é100\u0026#34;); } } private String requireNonNull(String value, String message) { if (value == null || value.trim().isEmpty()) { throw new IllegalArgumentException(message); } return value; } private String requireNonNull(String value) { return requireNonNull(value, \u0026#34;å€¼ä¸èƒ½ç‚ºç©º\u0026#34;); } private int requireValidPort(int port) { if (port \u0026lt; 1 || port \u0026gt; 65535) { throw new IllegalArgumentException(\u0026#34;ç«¯å£å¿…é ˆåœ¨1-65535ä¹‹é–“\u0026#34;); } return port; } } // Getter æ–¹æ³• public String getHost() { return host; } public int getPort() { return port; } public String getDatabase() { return database; } public String getUsername() { return username; } public String getPassword() { return password; } public int getConnectionPoolSize() { return connectionPoolSize; } public int getConnectionTimeout() { return connectionTimeout; } public boolean isUseSSL() { return useSSL; } public boolean isAutoReconnect() { return autoReconnect; } public Map\u0026lt;String, String\u0026gt; getProperties() { return properties; } @Override public String toString() { return \u0026#34;DatabaseConfiguration{\u0026#34; + \u0026#34;host=\u0026#39;\u0026#34; + host + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, port=\u0026#34; + port + \u0026#34;, database=\u0026#39;\u0026#34; + database + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, username=\u0026#39;\u0026#34; + username + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, connectionPoolSize=\u0026#34; + connectionPoolSize + \u0026#34;, connectionTimeout=\u0026#34; + connectionTimeout + \u0026#34;, useSSL=\u0026#34; + useSSL + \u0026#34;, autoReconnect=\u0026#34; + autoReconnect + \u0026#34;, properties=\u0026#34; + properties + \u0026#39;}\u0026#39;; } } 2. æ³›å‹å»ºé€ è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 // æ³›å‹å»ºé€ è€…åŸºé¡ public abstract class GenericBuilder\u0026lt;T\u0026gt; { protected abstract T build(); protected void validate() { // å­é¡å¯ä»¥é‡å¯«æ­¤æ–¹æ³•é€²è¡Œé©—è­‰ } } // HTTP å®¢æˆ¶ç«¯é…ç½®å»ºé€ è€… public class HttpClientConfig { private final String baseUrl; private final int connectionTimeout; private final int readTimeout; private final Map\u0026lt;String, String\u0026gt; headers; private final boolean followRedirects; private final ProxyConfig proxy; private final SSLConfig sslConfig; private HttpClientConfig(Builder builder) { this.baseUrl = builder.baseUrl; this.connectionTimeout = builder.connectionTimeout; this.readTimeout = builder.readTimeout; this.headers = Collections.unmodifiableMap(builder.headers); this.followRedirects = builder.followRedirects; this.proxy = builder.proxy; this.sslConfig = builder.sslConfig; } public static class Builder extends GenericBuilder\u0026lt;HttpClientConfig\u0026gt; { private String baseUrl; private int connectionTimeout = 5000; private int readTimeout = 10000; private Map\u0026lt;String, String\u0026gt; headers = new HashMap\u0026lt;\u0026gt;(); private boolean followRedirects = true; private ProxyConfig proxy; private SSLConfig sslConfig; public Builder baseUrl(String baseUrl) { this.baseUrl = baseUrl; return this; } public Builder connectionTimeout(int timeout) { this.connectionTimeout = timeout; return this; } public Builder readTimeout(int timeout) { this.readTimeout = timeout; return this; } public Builder header(String name, String value) { this.headers.put(name, value); return this; } public Builder headers(Map\u0026lt;String, String\u0026gt; headers) { this.headers.putAll(headers); return this; } public Builder followRedirects(boolean follow) { this.followRedirects = follow; return this; } public Builder proxy(ProxyConfig proxy) { this.proxy = proxy; return this; } public Builder sslConfig(SSLConfig sslConfig) { this.sslConfig = sslConfig; return this; } @Override protected void validate() { if (baseUrl == null || baseUrl.trim().isEmpty()) { throw new IllegalStateException(\u0026#34;BaseUrl ä¸èƒ½ç‚ºç©º\u0026#34;); } if (connectionTimeout \u0026lt; 0) { throw new IllegalStateException(\u0026#34;é€£æ¥è¶…æ™‚ä¸èƒ½ç‚ºè² æ•¸\u0026#34;); } if (readTimeout \u0026lt; 0) { throw new IllegalStateException(\u0026#34;è®€å–è¶…æ™‚ä¸èƒ½ç‚ºè² æ•¸\u0026#34;); } } @Override protected HttpClientConfig build() { validate(); return new HttpClientConfig(this); } } // Getter æ–¹æ³• public String getBaseUrl() { return baseUrl; } public int getConnectionTimeout() { return connectionTimeout; } public int getReadTimeout() { return readTimeout; } public Map\u0026lt;String, String\u0026gt; getHeaders() { return headers; } public boolean isFollowRedirects() { return followRedirects; } public ProxyConfig getProxy() { return proxy; } public SSLConfig getSslConfig() { return sslConfig; } // è¼”åŠ©é¡ public static class ProxyConfig { private final String host; private final int port; private final String username; private final String password; public ProxyConfig(String host, int port, String username, String password) { this.host = host; this.port = port; this.username = username; this.password = password; } // Getter æ–¹æ³• public String getHost() { return host; } public int getPort() { return port; } public String getUsername() { return username; } public String getPassword() { return password; } } public static class SSLConfig { private final boolean verifyHostname; private final String trustStore; private final String trustStorePassword; public SSLConfig(boolean verifyHostname, String trustStore, String trustStorePassword) { this.verifyHostname = verifyHostname; this.trustStore = trustStore; this.trustStorePassword = trustStorePassword; } // Getter æ–¹æ³• public boolean isVerifyHostname() { return verifyHostname; } public String getTrustStore() { return trustStore; } public String getTrustStorePassword() { return trustStorePassword; } } } ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯ 1. è¤‡é›œ API éŸ¿æ‡‰æ§‹é€  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 // API éŸ¿æ‡‰å»ºé€ è€… public class ApiResponse\u0026lt;T\u0026gt; { private final boolean success; private final String message; private final T data; private final List\u0026lt;String\u0026gt; errors; private final Map\u0026lt;String, Object\u0026gt; metadata; private final long timestamp; private final String traceId; private ApiResponse(Builder\u0026lt;T\u0026gt; builder) { this.success = builder.success; this.message = builder.message; this.data = builder.data; this.errors = builder.errors != null ? Collections.unmodifiableList(new ArrayList\u0026lt;\u0026gt;(builder.errors)) : Collections.emptyList(); this.metadata = builder.metadata != null ? Collections.unmodifiableMap(new HashMap\u0026lt;\u0026gt;(builder.metadata)) : Collections.emptyMap(); this.timestamp = builder.timestamp; this.traceId = builder.traceId; } public static class Builder\u0026lt;T\u0026gt; { private boolean success = true; private String message; private T data; private List\u0026lt;String\u0026gt; errors; private Map\u0026lt;String, Object\u0026gt; metadata; private long timestamp = System.currentTimeMillis(); private String traceId = generateTraceId(); public Builder\u0026lt;T\u0026gt; success(boolean success) { this.success = success; return this; } public Builder\u0026lt;T\u0026gt; message(String message) { this.message = message; return this; } public Builder\u0026lt;T\u0026gt; data(T data) { this.data = data; return this; } public Builder\u0026lt;T\u0026gt; error(String error) { if (this.errors == null) { this.errors = new ArrayList\u0026lt;\u0026gt;(); } this.errors.add(error); this.success = false; return this; } public Builder\u0026lt;T\u0026gt; errors(List\u0026lt;String\u0026gt; errors) { this.errors = errors; this.success = false; return this; } public Builder\u0026lt;T\u0026gt; metadata(String key, Object value) { if (this.metadata == null) { this.metadata = new HashMap\u0026lt;\u0026gt;(); } this.metadata.put(key, value); return this; } public Builder\u0026lt;T\u0026gt; metadata(Map\u0026lt;String, Object\u0026gt; metadata) { if (this.metadata == null) { this.metadata = new HashMap\u0026lt;\u0026gt;(); } this.metadata.putAll(metadata); return this; } public Builder\u0026lt;T\u0026gt; timestamp(long timestamp) { this.timestamp = timestamp; return this; } public Builder\u0026lt;T\u0026gt; traceId(String traceId) { this.traceId = traceId; return this; } public ApiResponse\u0026lt;T\u0026gt; build() { return new ApiResponse\u0026lt;\u0026gt;(this); } private String generateTraceId() { return UUID.randomUUID().toString().replace(\u0026#34;-\u0026#34;, \u0026#34;\u0026#34;); } } // éœæ…‹å·¥å» æ–¹æ³• public static \u0026lt;T\u0026gt; Builder\u0026lt;T\u0026gt; success() { return new Builder\u0026lt;T\u0026gt;().success(true); } public static \u0026lt;T\u0026gt; Builder\u0026lt;T\u0026gt; success(T data) { return new Builder\u0026lt;T\u0026gt;().success(true).data(data); } public static \u0026lt;T\u0026gt; Builder\u0026lt;T\u0026gt; failure(String message) { return new Builder\u0026lt;T\u0026gt;().success(false).message(message); } public static \u0026lt;T\u0026gt; Builder\u0026lt;T\u0026gt; failure(List\u0026lt;String\u0026gt; errors) { return new Builder\u0026lt;T\u0026gt;().errors(errors); } // Getter æ–¹æ³• public boolean isSuccess() { return success; } public String getMessage() { return message; } public T getData() { return data; } public List\u0026lt;String\u0026gt; getErrors() { return errors; } public Map\u0026lt;String, Object\u0026gt; getMetadata() { return metadata; } public long getTimestamp() { return timestamp; } public String getTraceId() { return traceId; } } // ä½¿ç”¨ç¤ºä¾‹ @RestController public class UserController { @GetMapping(\u0026#34;/users/{id}\u0026#34;) public ApiResponse\u0026lt;User\u0026gt; getUser(@PathVariable Long id) { try { User user = userService.findById(id); return ApiResponse.success(user) .message(\u0026#34;ç”¨æˆ¶æŸ¥è©¢æˆåŠŸ\u0026#34;) .metadata(\u0026#34;query_time\u0026#34;, System.currentTimeMillis()) .build(); } catch (UserNotFoundException e) { return ApiResponse.\u0026lt;User\u0026gt;failure(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨\u0026#34;) .metadata(\u0026#34;user_id\u0026#34;, id) .build(); } } @PostMapping(\u0026#34;/users\u0026#34;) public ApiResponse\u0026lt;User\u0026gt; createUser(@RequestBody @Valid CreateUserRequest request) { try { User user = userService.create(request); return ApiResponse.success(user) .message(\u0026#34;ç”¨æˆ¶å‰µå»ºæˆåŠŸ\u0026#34;) .metadata(\u0026#34;created_at\u0026#34;, user.getCreatedAt()) .build(); } catch (ValidationException e) { return ApiResponse.\u0026lt;User\u0026gt;failure(e.getErrors()) .metadata(\u0026#34;validation_failed\u0026#34;, true) .build(); } } } 2. æŸ¥è©¢æ¢ä»¶å»ºé€ è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 // è¤‡é›œæŸ¥è©¢æ¢ä»¶å»ºé€ è€… public class SearchCriteria { private final String keyword; private final List\u0026lt;String\u0026gt; categories; private final DateRange dateRange; private final PriceRange priceRange; private final SortOptions sortOptions; private final PaginationOptions paginationOptions; private final List\u0026lt;Filter\u0026gt; filters; private final boolean includeDeleted; private final boolean fuzzySearch; private SearchCriteria(Builder builder) { this.keyword = builder.keyword; this.categories = builder.categories != null ? Collections.unmodifiableList(new ArrayList\u0026lt;\u0026gt;(builder.categories)) : Collections.emptyList(); this.dateRange = builder.dateRange; this.priceRange = builder.priceRange; this.sortOptions = builder.sortOptions; this.paginationOptions = builder.paginationOptions; this.filters = builder.filters != null ? Collections.unmodifiableList(new ArrayList\u0026lt;\u0026gt;(builder.filters)) : Collections.emptyList(); this.includeDeleted = builder.includeDeleted; this.fuzzySearch = builder.fuzzySearch; } public static class Builder { private String keyword; private List\u0026lt;String\u0026gt; categories; private DateRange dateRange; private PriceRange priceRange; private SortOptions sortOptions; private PaginationOptions paginationOptions; private List\u0026lt;Filter\u0026gt; filters; private boolean includeDeleted = false; private boolean fuzzySearch = true; public Builder keyword(String keyword) { this.keyword = keyword; return this; } public Builder category(String category) { if (this.categories == null) { this.categories = new ArrayList\u0026lt;\u0026gt;(); } this.categories.add(category); return this; } public Builder categories(List\u0026lt;String\u0026gt; categories) { this.categories = categories; return this; } public Builder dateRange(LocalDate startDate, LocalDate endDate) { this.dateRange = new DateRange(startDate, endDate); return this; } public Builder priceRange(BigDecimal minPrice, BigDecimal maxPrice) { this.priceRange = new PriceRange(minPrice, maxPrice); return this; } public Builder sortBy(String field, SortDirection direction) { this.sortOptions = new SortOptions(field, direction); return this; } public Builder page(int page, int size) { this.paginationOptions = new PaginationOptions(page, size); return this; } public Builder filter(String field, FilterOperator operator, Object value) { if (this.filters == null) { this.filters = new ArrayList\u0026lt;\u0026gt;(); } this.filters.add(new Filter(field, operator, value)); return this; } public Builder includeDeleted(boolean includeDeleted) { this.includeDeleted = includeDeleted; return this; } public Builder fuzzySearch(boolean fuzzySearch) { this.fuzzySearch = fuzzySearch; return this; } public SearchCriteria build() { validateCriteria(); return new SearchCriteria(this); } private void validateCriteria() { if (keyword != null \u0026amp;\u0026amp; keyword.trim().isEmpty()) { throw new IllegalArgumentException(\u0026#34;é—œéµå­—ä¸èƒ½ç‚ºç©ºå­—ç¬¦ä¸²\u0026#34;); } if (dateRange != null \u0026amp;\u0026amp; !dateRange.isValid()) { throw new IllegalArgumentException(\u0026#34;æ—¥æœŸç¯„åœç„¡æ•ˆ\u0026#34;); } if (priceRange != null \u0026amp;\u0026amp; !priceRange.isValid()) { throw new IllegalArgumentException(\u0026#34;åƒ¹æ ¼ç¯„åœç„¡æ•ˆ\u0026#34;); } if (paginationOptions != null \u0026amp;\u0026amp; !paginationOptions.isValid()) { throw new IllegalArgumentException(\u0026#34;åˆ†é åƒæ•¸ç„¡æ•ˆ\u0026#34;); } } } // Getter æ–¹æ³• public String getKeyword() { return keyword; } public List\u0026lt;String\u0026gt; getCategories() { return categories; } public DateRange getDateRange() { return dateRange; } public PriceRange getPriceRange() { return priceRange; } public SortOptions getSortOptions() { return sortOptions; } public PaginationOptions getPaginationOptions() { return paginationOptions; } public List\u0026lt;Filter\u0026gt; getFilters() { return filters; } public boolean isIncludeDeleted() { return includeDeleted; } public boolean isFuzzySearch() { return fuzzySearch; } // è¼”åŠ©é¡ public static class DateRange { private final LocalDate startDate; private final LocalDate endDate; public DateRange(LocalDate startDate, LocalDate endDate) { this.startDate = startDate; this.endDate = endDate; } public boolean isValid() { return startDate != null \u0026amp;\u0026amp; endDate != null \u0026amp;\u0026amp; !startDate.isAfter(endDate); } public LocalDate getStartDate() { return startDate; } public LocalDate getEndDate() { return endDate; } } public static class PriceRange { private final BigDecimal minPrice; private final BigDecimal maxPrice; public PriceRange(BigDecimal minPrice, BigDecimal maxPrice) { this.minPrice = minPrice; this.maxPrice = maxPrice; } public boolean isValid() { return minPrice != null \u0026amp;\u0026amp; maxPrice != null \u0026amp;\u0026amp; minPrice.compareTo(maxPrice) \u0026lt;= 0 \u0026amp;\u0026amp; minPrice.compareTo(BigDecimal.ZERO) \u0026gt;= 0; } public BigDecimal getMinPrice() { return minPrice; } public BigDecimal getMaxPrice() { return maxPrice; } } public static class SortOptions { private final String field; private final SortDirection direction; public SortOptions(String field, SortDirection direction) { this.field = field; this.direction = direction; } public String getField() { return field; } public SortDirection getDirection() { return direction; } } public static class PaginationOptions { private final int page; private final int size; public PaginationOptions(int page, int size) { this.page = page; this.size = size; } public boolean isValid() { return page \u0026gt;= 0 \u0026amp;\u0026amp; size \u0026gt; 0 \u0026amp;\u0026amp; size \u0026lt;= 1000; } public int getPage() { return page; } public int getSize() { return size; } } public static class Filter { private final String field; private final FilterOperator operator; private final Object value; public Filter(String field, FilterOperator operator, Object value) { this.field = field; this.operator = operator; this.value = value; } public String getField() { return field; } public FilterOperator getOperator() { return operator; } public Object getValue() { return value; } } public enum SortDirection { ASC, DESC } public enum FilterOperator { EQUALS, NOT_EQUALS, GREATER_THAN, LESS_THAN, GREATER_THAN_OR_EQUAL, LESS_THAN_OR_EQUAL, CONTAINS, NOT_CONTAINS, IN, NOT_IN } } // ä½¿ç”¨ç¤ºä¾‹ @Service public class ProductSearchService { public Page\u0026lt;Product\u0026gt; searchProducts(SearchCriteria criteria) { return productRepository.search(criteria); } public void demonstrateUsage() { // è¤‡é›œæŸ¥è©¢æ§‹é€  SearchCriteria criteria = new SearchCriteria.Builder() .keyword(\u0026#34;æ™ºèƒ½æ‰‹æ©Ÿ\u0026#34;) .category(\u0026#34;é›»å­ç”¢å“\u0026#34;) .category(\u0026#34;æ‰‹æ©Ÿ\u0026#34;) .priceRange(new BigDecimal(\u0026#34;1000\u0026#34;), new BigDecimal(\u0026#34;5000\u0026#34;)) .dateRange(LocalDate.now().minusMonths(3), LocalDate.now()) .sortBy(\u0026#34;price\u0026#34;, SearchCriteria.SortDirection.ASC) .page(0, 20) .filter(\u0026#34;brand\u0026#34;, SearchCriteria.FilterOperator.IN, Arrays.asList(\u0026#34;Apple\u0026#34;, \u0026#34;Samsung\u0026#34;, \u0026#34;Huawei\u0026#34;)) .filter(\u0026#34;rating\u0026#34;, SearchCriteria.FilterOperator.GREATER_THAN_OR_EQUAL, 4.0) .fuzzySearch(true) .build(); Page\u0026lt;Product\u0026gt; results = searchProducts(criteria); System.out.println(\u0026#34;æ‰¾åˆ° \u0026#34; + results.getTotalElements() + \u0026#34; å€‹ç”¢å“\u0026#34;); } } 3. é…ç½®æ–‡ä»¶å»ºé€ è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 // æ‡‰ç”¨é…ç½®å»ºé€ è€… public class ApplicationConfig { private final String applicationName; private final String version; private final ServerConfig serverConfig; private final DatabaseConfig databaseConfig; private final CacheConfig cacheConfig; private final SecurityConfig securityConfig; private final LoggingConfig loggingConfig; private final Map\u0026lt;String, String\u0026gt; customProperties; private ApplicationConfig(Builder builder) { this.applicationName = builder.applicationName; this.version = builder.version; this.serverConfig = builder.serverConfig; this.databaseConfig = builder.databaseConfig; this.cacheConfig = builder.cacheConfig; this.securityConfig = builder.securityConfig; this.loggingConfig = builder.loggingConfig; this.customProperties = builder.customProperties != null ? Collections.unmodifiableMap(new HashMap\u0026lt;\u0026gt;(builder.customProperties)) : Collections.emptyMap(); } public static class Builder { private String applicationName; private String version; private ServerConfig serverConfig; private DatabaseConfig databaseConfig; private CacheConfig cacheConfig; private SecurityConfig securityConfig; private LoggingConfig loggingConfig; private Map\u0026lt;String, String\u0026gt; customProperties; public Builder applicationName(String name) { this.applicationName = name; return this; } public Builder version(String version) { this.version = version; return this; } public Builder server(Consumer\u0026lt;ServerConfig.Builder\u0026gt; configurer) { ServerConfig.Builder builder = new ServerConfig.Builder(); configurer.accept(builder); this.serverConfig = builder.build(); return this; } public Builder database(Consumer\u0026lt;DatabaseConfig.Builder\u0026gt; configurer) { DatabaseConfig.Builder builder = new DatabaseConfig.Builder(); configurer.accept(builder); this.databaseConfig = builder.build(); return this; } public Builder cache(Consumer\u0026lt;CacheConfig.Builder\u0026gt; configurer) { CacheConfig.Builder builder = new CacheConfig.Builder(); configurer.accept(builder); this.cacheConfig = builder.build(); return this; } public Builder security(Consumer\u0026lt;SecurityConfig.Builder\u0026gt; configurer) { SecurityConfig.Builder builder = new SecurityConfig.Builder(); configurer.accept(builder); this.securityConfig = builder.build(); return this; } public Builder logging(Consumer\u0026lt;LoggingConfig.Builder\u0026gt; configurer) { LoggingConfig.Builder builder = new LoggingConfig.Builder(); configurer.accept(builder); this.loggingConfig = builder.build(); return this; } public Builder property(String key, String value) { if (this.customProperties == null) { this.customProperties = new HashMap\u0026lt;\u0026gt;(); } this.customProperties.put(key, value); return this; } public ApplicationConfig build() { validateConfiguration(); return new ApplicationConfig(this); } private void validateConfiguration() { if (applicationName == null || applicationName.trim().isEmpty()) { throw new IllegalStateException(\u0026#34;æ‡‰ç”¨åç¨±ä¸èƒ½ç‚ºç©º\u0026#34;); } if (version == null || version.trim().isEmpty()) { throw new IllegalStateException(\u0026#34;ç‰ˆæœ¬è™Ÿä¸èƒ½ç‚ºç©º\u0026#34;); } } } // Getter æ–¹æ³• public String getApplicationName() { return applicationName; } public String getVersion() { return version; } public ServerConfig getServerConfig() { return serverConfig; } public DatabaseConfig getDatabaseConfig() { return databaseConfig; } public CacheConfig getCacheConfig() { return cacheConfig; } public SecurityConfig getSecurityConfig() { return securityConfig; } public LoggingConfig getLoggingConfig() { return loggingConfig; } public Map\u0026lt;String, String\u0026gt; getCustomProperties() { return customProperties; } // åµŒå¥—é…ç½®é¡ public static class ServerConfig { private final int port; private final String contextPath; private final boolean enableCompression; private final int maxConnections; private ServerConfig(Builder builder) { this.port = builder.port; this.contextPath = builder.contextPath; this.enableCompression = builder.enableCompression; this.maxConnections = builder.maxConnections; } public static class Builder { private int port = 8080; private String contextPath = \u0026#34;/\u0026#34;; private boolean enableCompression = true; private int maxConnections = 200; public Builder port(int port) { this.port = port; return this; } public Builder contextPath(String contextPath) { this.contextPath = contextPath; return this; } public Builder enableCompression(boolean enable) { this.enableCompression = enable; return this; } public Builder maxConnections(int maxConnections) { this.maxConnections = maxConnections; return this; } public ServerConfig build() { return new ServerConfig(this); } } // Getter æ–¹æ³• public int getPort() { return port; } public String getContextPath() { return contextPath; } public boolean isEnableCompression() { return enableCompression; } public int getMaxConnections() { return maxConnections; } } public static class DatabaseConfig { private final String url; private final String username; private final String password; private final int maxPoolSize; private final int minPoolSize; private DatabaseConfig(Builder builder) { this.url = builder.url; this.username = builder.username; this.password = builder.password; this.maxPoolSize = builder.maxPoolSize; this.minPoolSize = builder.minPoolSize; } public static class Builder { private String url; private String username; private String password; private int maxPoolSize = 10; private int minPoolSize = 5; public Builder url(String url) { this.url = url; return this; } public Builder username(String username) { this.username = username; return this; } public Builder password(String password) { this.password = password; return this; } public Builder maxPoolSize(int maxPoolSize) { this.maxPoolSize = maxPoolSize; return this; } public Builder minPoolSize(int minPoolSize) { this.minPoolSize = minPoolSize; return this; } public DatabaseConfig build() { return new DatabaseConfig(this); } } // Getter æ–¹æ³• public String getUrl() { return url; } public String getUsername() { return username; } public String getPassword() { return password; } public int getMaxPoolSize() { return maxPoolSize; } public int getMinPoolSize() { return minPoolSize; } } public static class CacheConfig { private final String type; private final int maxSize; private final int ttlMinutes; private CacheConfig(Builder builder) { this.type = builder.type; this.maxSize = builder.maxSize; this.ttlMinutes = builder.ttlMinutes; } public static class Builder { private String type = \u0026#34;redis\u0026#34;; private int maxSize = 1000; private int ttlMinutes = 60; public Builder type(String type) { this.type = type; return this; } public Builder maxSize(int maxSize) { this.maxSize = maxSize; return this; } public Builder ttlMinutes(int ttlMinutes) { this.ttlMinutes = ttlMinutes; return this; } public CacheConfig build() { return new CacheConfig(this); } } // Getter æ–¹æ³• public String getType() { return type; } public int getMaxSize() { return maxSize; } public int getTtlMinutes() { return ttlMinutes; } } public static class SecurityConfig { private final boolean enableSecurity; private final String jwtSecret; private final int jwtExpirationHours; private SecurityConfig(Builder builder) { this.enableSecurity = builder.enableSecurity; this.jwtSecret = builder.jwtSecret; this.jwtExpirationHours = builder.jwtExpirationHours; } public static class Builder { private boolean enableSecurity = true; private String jwtSecret; private int jwtExpirationHours = 24; public Builder enableSecurity(boolean enable) { this.enableSecurity = enable; return this; } public Builder jwtSecret(String secret) { this.jwtSecret = secret; return this; } public Builder jwtExpirationHours(int hours) { this.jwtExpirationHours = hours; return this; } public SecurityConfig build() { return new SecurityConfig(this); } } // Getter æ–¹æ³• public boolean isEnableSecurity() { return enableSecurity; } public String getJwtSecret() { return jwtSecret; } public int getJwtExpirationHours() { return jwtExpirationHours; } } public static class LoggingConfig { private final String level; private final String pattern; private final boolean enableFileOutput; private LoggingConfig(Builder builder) { this.level = builder.level; this.pattern = builder.pattern; this.enableFileOutput = builder.enableFileOutput; } public static class Builder { private String level = \u0026#34;INFO\u0026#34;; private String pattern = \u0026#34;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n\u0026#34;; private boolean enableFileOutput = false; public Builder level(String level) { this.level = level; return this; } public Builder pattern(String pattern) { this.pattern = pattern; return this; } public Builder enableFileOutput(boolean enable) { this.enableFileOutput = enable; return this; } public LoggingConfig build() { return new LoggingConfig(this); } } // Getter æ–¹æ³• public String getLevel() { return level; } public String getPattern() { return pattern; } public boolean isEnableFileOutput() { return enableFileOutput; } } } // ä½¿ç”¨ç¤ºä¾‹ public class ApplicationConfigExample { public static void main(String[] args) { ApplicationConfig config = new ApplicationConfig.Builder() .applicationName(\u0026#34;é›»å•†ç³»çµ±\u0026#34;) .version(\u0026#34;1.0.0\u0026#34;) .server(server -\u0026gt; server .port(8080) .contextPath(\u0026#34;/api\u0026#34;) .enableCompression(true) .maxConnections(500)) .database(db -\u0026gt; db .url(\u0026#34;jdbc:mysql://localhost:3306/ecommerce\u0026#34;) .username(\u0026#34;root\u0026#34;) .password(\u0026#34;password\u0026#34;) .maxPoolSize(20) .minPoolSize(5)) .cache(cache -\u0026gt; cache .type(\u0026#34;redis\u0026#34;) .maxSize(10000) .ttlMinutes(30)) .security(security -\u0026gt; security .enableSecurity(true) .jwtSecret(\u0026#34;mySecretKey\u0026#34;) .jwtExpirationHours(24)) .logging(logging -\u0026gt; logging .level(\u0026#34;INFO\u0026#34;) .enableFileOutput(true)) .property(\u0026#34;custom.feature.enabled\u0026#34;, \u0026#34;true\u0026#34;) .property(\u0026#34;custom.timeout\u0026#34;, \u0026#34;5000\u0026#34;) .build(); System.out.println(\u0026#34;é…ç½®å‰µå»ºæˆåŠŸï¼š\u0026#34; + config.getApplicationName()); } } Spring Boot æ•´åˆ 1. é…ç½®é¡å»ºé€ è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 @Configuration public class BuilderPatternConfig { @Bean @ConfigurationProperties(prefix = \u0026#34;app.database\u0026#34;) public DatabaseConfiguration databaseConfiguration() { return new DatabaseConfiguration.Builder( \u0026#34;localhost\u0026#34;, 3306, \u0026#34;myapp\u0026#34;, \u0026#34;user\u0026#34;, \u0026#34;password\u0026#34; ).build(); } @Bean @ConditionalOnProperty(name = \u0026#34;app.http.client.enabled\u0026#34;, havingValue = \u0026#34;true\u0026#34;) public HttpClientConfig httpClientConfig( @Value(\u0026#34;${app.http.client.base-url}\u0026#34;) String baseUrl, @Value(\u0026#34;${app.http.client.timeout:5000}\u0026#34;) int timeout) { return new HttpClientConfig.Builder() .baseUrl(baseUrl) .connectionTimeout(timeout) .readTimeout(timeout * 2) .header(\u0026#34;User-Agent\u0026#34;, \u0026#34;MyApp/1.0\u0026#34;) .header(\u0026#34;Accept\u0026#34;, \u0026#34;application/json\u0026#34;) .followRedirects(true) .build(); } } @RestController public class SearchController { @PostMapping(\u0026#34;/search\u0026#34;) public ApiResponse\u0026lt;Page\u0026lt;Product\u0026gt;\u0026gt; search(@RequestBody SearchRequest request) { try { SearchCriteria criteria = new SearchCriteria.Builder() .keyword(request.getKeyword()) .categories(request.getCategories()) .priceRange(request.getMinPrice(), request.getMaxPrice()) .sortBy(request.getSortField(), request.getSortDirection()) .page(request.getPage(), request.getSize()) .fuzzySearch(request.isFuzzySearch()) .build(); Page\u0026lt;Product\u0026gt; results = productService.search(criteria); return ApiResponse.\u0026lt;Page\u0026lt;Product\u0026gt;\u0026gt;success(results) .message(\u0026#34;æœç´¢æˆåŠŸ\u0026#34;) .metadata(\u0026#34;total\u0026#34;, results.getTotalElements()) .metadata(\u0026#34;pages\u0026#34;, results.getTotalPages()) .build(); } catch (Exception e) { return ApiResponse.\u0026lt;Page\u0026lt;Product\u0026gt;\u0026gt;failure(\u0026#34;æœç´¢å¤±æ•—\u0026#34;) .error(e.getMessage()) .build(); } } } 2. æ¸¬è©¦å»ºé€ è€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 @ExtendWith(MockitoExtension.class) class BuilderPatternTest { @Test void testComputerBuilder_GamingConfiguration() { // Given Computer.Director director = new Computer.Director(); // When Computer gamingPC = director.buildGamingComputer(); // Then assertThat(gamingPC.getCpu()).isEqualTo(\u0026#34;Intel i9-13900K\u0026#34;); assertThat(gamingPC.getMemory()).isEqualTo(\u0026#34;32GB DDR5\u0026#34;); assertThat(gamingPC.getGraphics()).isEqualTo(\u0026#34;RTX 4080\u0026#34;); assertThat(gamingPC.isOverclocked()).isTrue(); assertThat(gamingPC.getCoolingSystem()).isNotNull(); } @Test void testDatabaseConfigurationBuilder_ValidConfiguration() { // When DatabaseConfiguration config = new DatabaseConfiguration.Builder( \u0026#34;localhost\u0026#34;, 3306, \u0026#34;testdb\u0026#34;, \u0026#34;user\u0026#34;, \u0026#34;pass\u0026#34; ) .connectionPoolSize(20) .connectionTimeout(5000) .useSSL(true) .property(\u0026#34;charset\u0026#34;, \u0026#34;utf8mb4\u0026#34;) .build(); // Then assertThat(config.getHost()).isEqualTo(\u0026#34;localhost\u0026#34;); assertThat(config.getPort()).isEqualTo(3306); assertThat(config.getConnectionPoolSize()).isEqualTo(20); assertThat(config.isUseSSL()).isTrue(); assertThat(config.getProperties()).containsEntry(\u0026#34;charset\u0026#34;, \u0026#34;utf8mb4\u0026#34;); } @Test void testApiResponseBuilder_SuccessResponse() { // Given User user = new User(\u0026#34;testUser\u0026#34;, \u0026#34;test@example.com\u0026#34;); // When ApiResponse\u0026lt;User\u0026gt; response = ApiResponse.success(user) .message(\u0026#34;ç”¨æˆ¶ç²å–æˆåŠŸ\u0026#34;) .metadata(\u0026#34;cached\u0026#34;, true) .build(); // Then assertThat(response.isSuccess()).isTrue(); assertThat(response.getData()).isEqualTo(user); assertThat(response.getMessage()).isEqualTo(\u0026#34;ç”¨æˆ¶ç²å–æˆåŠŸ\u0026#34;); assertThat(response.getMetadata()).containsEntry(\u0026#34;cached\u0026#34;, true); assertThat(response.getTraceId()).isNotNull(); assertThat(response.getErrors()).isEmpty(); } @Test void testApiResponseBuilder_FailureResponse() { // Given List\u0026lt;String\u0026gt; errors = Arrays.asList(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨\u0026#34;, \u0026#34;è«‹æ±‚åƒæ•¸ç„¡æ•ˆ\u0026#34;); // When ApiResponse\u0026lt;User\u0026gt; response = ApiResponse.\u0026lt;User\u0026gt;failure(errors) .metadata(\u0026#34;error_code\u0026#34;, \u0026#34;USER_NOT_FOUND\u0026#34;) .build(); // Then assertThat(response.isSuccess()).isFalse(); assertThat(response.getData()).isNull(); assertThat(response.getErrors()).hasSize(2); assertThat(response.getErrors()).contains(\u0026#34;ç”¨æˆ¶ä¸å­˜åœ¨\u0026#34;, \u0026#34;è«‹æ±‚åƒæ•¸ç„¡æ•ˆ\u0026#34;); assertThat(response.getMetadata()).containsEntry(\u0026#34;error_code\u0026#34;, \u0026#34;USER_NOT_FOUND\u0026#34;); } @Test void testSearchCriteriaBuilder_ComplexQuery() { // Given LocalDate startDate = LocalDate.now().minusMonths(1); LocalDate endDate = LocalDate.now(); // When SearchCriteria criteria = new SearchCriteria.Builder() .keyword(\u0026#34;æ™ºèƒ½æ‰‹æ©Ÿ\u0026#34;) .category(\u0026#34;é›»å­ç”¢å“\u0026#34;) .dateRange(startDate, endDate) .priceRange(new BigDecimal(\u0026#34;1000\u0026#34;), new BigDecimal(\u0026#34;5000\u0026#34;)) .sortBy(\u0026#34;price\u0026#34;, SearchCriteria.SortDirection.ASC) .page(0, 20) .filter(\u0026#34;brand\u0026#34;, SearchCriteria.FilterOperator.IN, Arrays.asList(\u0026#34;Apple\u0026#34;, \u0026#34;Samsung\u0026#34;)) .fuzzySearch(true) .build(); // Then assertThat(criteria.getKeyword()).isEqualTo(\u0026#34;æ™ºèƒ½æ‰‹æ©Ÿ\u0026#34;); assertThat(criteria.getCategories()).contains(\u0026#34;é›»å­ç”¢å“\u0026#34;); assertThat(criteria.getDateRange().getStartDate()).isEqualTo(startDate); assertThat(criteria.getDateRange().getEndDate()).isEqualTo(endDate); assertThat(criteria.getPriceRange().getMinPrice()).isEqualTo(new BigDecimal(\u0026#34;1000\u0026#34;)); assertThat(criteria.isFuzzySearch()).isTrue(); assertThat(criteria.getFilters()).hasSize(1); } @Test void testBuilderValidation_ThrowsException() { // When \u0026amp; Then assertThatThrownBy(() -\u0026gt; new DatabaseConfiguration.Builder(null, 3306, \u0026#34;db\u0026#34;, \u0026#34;user\u0026#34;, \u0026#34;pass\u0026#34;).build() ).isInstanceOf(IllegalArgumentException.class) .hasMessage(\u0026#34;Host ä¸èƒ½ç‚ºç©º\u0026#34;); assertThatThrownBy(() -\u0026gt; new Computer.Builder() .setMemory(\u0026#34;16GB\u0026#34;) .setStorage(\u0026#34;1TB SSD\u0026#34;) .setOverclocked(true) .build() ).isInstanceOf(IllegalStateException.class) .hasMessage(\u0026#34;è¶…é »é…ç½®éœ€è¦å†·å»ç³»çµ±\u0026#34;); } } @SpringBootTest class BuilderPatternIntegrationTest { @Autowired private DatabaseConfiguration databaseConfig; @Autowired private HttpClientConfig httpClientConfig; @Test void testConfigurationBeans_LoadedCorrectly() { assertThat(databaseConfig).isNotNull(); assertThat(databaseConfig.getHost()).isNotNull(); assertThat(databaseConfig.getPort()).isPositive(); assertThat(httpClientConfig).isNotNull(); assertThat(httpClientConfig.getBaseUrl()).isNotNull(); assertThat(httpClientConfig.getConnectionTimeout()).isPositive(); } } æ€§èƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸ 1. å»ºé€ è€…å°è±¡æ±  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // å»ºé€ è€…å°è±¡æ±  public class BuilderPool\u0026lt;T extends GenericBuilder\u0026lt;?\u0026gt;\u0026gt; { private final Queue\u0026lt;T\u0026gt; pool = new ConcurrentLinkedQueue\u0026lt;\u0026gt;(); private final Supplier\u0026lt;T\u0026gt; builderFactory; private final int maxPoolSize; public BuilderPool(Supplier\u0026lt;T\u0026gt; builderFactory, int maxPoolSize) { this.builderFactory = builderFactory; this.maxPoolSize = maxPoolSize; } public T acquire() { T builder = pool.poll(); if (builder == null) { builder = builderFactory.get(); } return builder; } public void release(T builder) { if (pool.size() \u0026lt; maxPoolSize) { // é‡ç½®å»ºé€ è€…ç‹€æ…‹ if (builder instanceof Resettable) { ((Resettable) builder).reset(); } pool.offer(builder); } } } // å¯é‡ç½®æ¥å£ public interface Resettable { void reset(); } // å¯¦ç¾å¯é‡ç½®çš„å»ºé€ è€… public class PooledApiResponseBuilder\u0026lt;T\u0026gt; extends ApiResponse.Builder\u0026lt;T\u0026gt; implements Resettable { @Override public void reset() { this.success(true) .message(null) .data(null) .timestamp(System.currentTimeMillis()) .traceId(generateTraceId()); if (this.errors != null) { this.errors.clear(); } if (this.metadata != null) { this.metadata.clear(); } } } 2. å»ºé€ è€…å¿«å– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // å»ºé€ è€…çµæœå¿«å– @Component public class CachedBuilderService { private final Cache\u0026lt;String, Object\u0026gt; builderCache; public CachedBuilderService() { this.builderCache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(Duration.ofMinutes(30)) .build(); } public \u0026lt;T\u0026gt; T getOrBuild(String key, Supplier\u0026lt;T\u0026gt; builderSupplier) { return (T) builderCache.get(key, k -\u0026gt; builderSupplier.get()); } public void invalidate(String key) { builderCache.invalidate(key); } public void invalidateAll() { builderCache.invalidateAll(); } } ç›£æ§èˆ‡è¨ºæ–· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // å»ºé€ è€…ç›£æ§ @Component public class BuilderMonitor { private final MeterRegistry meterRegistry; private final Counter builderUsageCounter; private final Timer builderBuildTimer; public BuilderMonitor(MeterRegistry meterRegistry) { this.meterRegistry = meterRegistry; this.builderUsageCounter = Counter.builder(\u0026#34;builder.usage\u0026#34;) .description(\u0026#34;Number of builder usages\u0026#34;) .register(meterRegistry); this.builderBuildTimer = Timer.builder(\u0026#34;builder.build.time\u0026#34;) .description(\u0026#34;Time spent building objects\u0026#34;) .register(meterRegistry); } public \u0026lt;T\u0026gt; T monitorBuild(String builderType, Supplier\u0026lt;T\u0026gt; buildSupplier) { builderUsageCounter.increment(Tags.of(\u0026#34;type\u0026#34;, builderType)); return Timer.Sample.start(meterRegistry) .stop(builderBuildTimer.withTag(\u0026#34;type\u0026#34;, builderType)) .recordCallable(() -\u0026gt; buildSupplier.get()); } } ç¸½çµ å»ºé€ è€…æ¨¡å¼æ˜¯ä¸€ç¨®å¼·å¤§çš„å‰µå»ºå‹è¨­è¨ˆæ¨¡å¼ï¼Œç‰¹åˆ¥é©ç”¨æ–¼ï¼š\nè¤‡é›œå°è±¡æ§‹é€ ï¼šç•¶å°è±¡æœ‰å¤šå€‹å¯é¸åƒæ•¸æ™‚ æ­¥é©ŸåŒ–æ§‹é€ ï¼šéœ€è¦æŒ‰ç‰¹å®šé †åºæ§‹é€ å°è±¡æ™‚ ä¸è®Šæ€§ä¿è­‰ï¼šç¢ºä¿æ§‹é€ å®Œæˆçš„å°è±¡ä¸å¯è®Š å¯è®€æ€§æå‡ï¼šæä¾›æ¸…æ™°çš„å°è±¡æ§‹é€ æ–¹å¼ é—œéµæœ€ä½³å¯¦è¸ åƒæ•¸é©—è­‰ï¼šåœ¨ build() æ–¹æ³•ä¸­é€²è¡Œå®Œæ•´çš„åƒæ•¸é©—è­‰ ä¸è®Šæ€§ï¼šç¢ºä¿æ§‹é€ çš„å°è±¡æ˜¯ä¸å¯è®Šçš„ æµå¼ä»‹é¢ï¼šæä¾›éˆå¼èª¿ç”¨çš„æµå¼ä»‹é¢ é è¨­å€¼ï¼šç‚ºå¯é¸åƒæ•¸æä¾›åˆç†çš„é è¨­å€¼ ç•°å¸¸è™•ç†ï¼šæä¾›æ¸…æ™°çš„éŒ¯èª¤æ¶ˆæ¯å’Œç•°å¸¸è™•ç† æ€§èƒ½å„ªåŒ–ï¼šé©ç•¶ä½¿ç”¨å°è±¡æ± å’Œå¿«å–æ©Ÿåˆ¶ å»ºé€ è€…æ¨¡å¼è®“è¤‡é›œå°è±¡çš„æ§‹é€ è®Šå¾—ç°¡å–®ã€ç›´è§€ä¸”å®‰å…¨ï¼Œæ˜¯ä¼æ¥­ç´šæ‡‰ç”¨ä¸­ä¸å¯æˆ–ç¼ºçš„è¨­è¨ˆæ¨¡å¼ã€‚æ­£ç¢ºä½¿ç”¨å»ºé€ è€…æ¨¡å¼å¯ä»¥å¤§å¹…æå‡ä»£ç¢¼çš„å¯è®€æ€§å’Œç¶­è­·æ€§ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/builder/","tags":["Design Pattern","Builder Pattern","Creational Pattern","Object Construction","Fluent Interface","Method Chaining","Java","Spring Boot","Best Practices","Enterprise Development","Complex Objects","Configuration Management","API Design"],"title":"å»ºé€ è€…æ¨¡å¼ (Builder Pattern) å®Œæ•´å¯¦ä½œæŒ‡å—ï¼šè¤‡é›œå°è±¡æ§‹é€ çš„æœ€ä½³å¯¦è¸"},{"content":"Factory Pattern å·¥å» æ¨¡å¼ Factory Pattern æ˜¯å‰µå»ºå‹è¨­è¨ˆæ¨¡å¼ä¹‹ä¸€ï¼Œæä¾›äº†ä¸€ç¨®å‰µå»ºå°è±¡çš„æœ€ä½³æ–¹å¼ã€‚åœ¨å·¥å» æ¨¡å¼ä¸­ï¼Œæˆ‘å€‘åœ¨ä¸å‘å®¢æˆ¶ç«¯æš´éœ²å‰µå»ºé‚è¼¯çš„æƒ…æ³ä¸‹å‰µå»ºå°è±¡ï¼Œä¸¦ä¸”é€šéä½¿ç”¨ä¸€å€‹å…±åŒçš„æ¥å£ä¾†æŒ‡å‘æ–°å‰µå»ºçš„å°è±¡ã€‚\næ ¸å¿ƒæ¦‚å¿µ å·¥å» æ¨¡å¼è§£æ±ºäº†ç›´æ¥å¯¦ä¾‹åŒ–å°è±¡æ‰€å¸¶ä¾†çš„å•é¡Œï¼Œå®ƒå°è£äº†å°è±¡å‰µå»ºçš„è¤‡é›œæ€§ï¼Œè®“å®¢æˆ¶ç«¯ç¨‹åºå¯ä»¥é€šéç°¡å–®çš„æ¥å£ç²å–æ‰€éœ€çš„å°è±¡ï¼Œè€Œç„¡éœ€äº†è§£å°è±¡å‰µå»ºçš„å…·é«”éç¨‹ã€‚\nä¸»è¦å„ªå‹¢ è§£è€¦: å®¢æˆ¶ç«¯ä»£ç¢¼èˆ‡å…·é«”å¯¦ç¾é¡è§£è€¦ å¯æ“´å±•æ€§: å®¹æ˜“æ·»åŠ æ–°çš„ç”¢å“é¡å‹ é›†ä¸­ç®¡ç†: å°è±¡å‰µå»ºé‚è¼¯é›†ä¸­åœ¨å·¥å» ä¸­ ä¸€è‡´æ€§: ç¢ºä¿å°è±¡å‰µå»ºçš„ä¸€è‡´æ€§ æ¸¬è©¦å‹å¥½: ä¾¿æ–¼å–®å…ƒæ¸¬è©¦å’Œæ¨¡æ“¬ 1. Simple Factory Pattern ç°¡å–®å·¥å» æ¨¡å¼ æœ€åŸºæœ¬çš„å·¥å» æ¨¡å¼å¯¦ç¾ï¼Œé€šéä¸€å€‹å·¥å» é¡ä¾†å‰µå»ºæ‰€æœ‰ç›¸é—œçš„å°è±¡ã€‚\nåŸºç¤å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 // ç”¢å“æ¥å£ public interface Vehicle { void start(); void stop(); void accelerate(); String getType(); } // å…·é«”ç”¢å“å¯¦ç¾ public class Car implements Vehicle { private String brand; public Car(String brand) { this.brand = brand; } @Override public void start() { System.out.println(brand + \u0026#34; æ±½è»Šå•Ÿå‹•å¼•æ“\u0026#34;); } @Override public void stop() { System.out.println(brand + \u0026#34; æ±½è»Šåœæ­¢\u0026#34;); } @Override public void accelerate() { System.out.println(brand + \u0026#34; æ±½è»ŠåŠ é€Ÿ\u0026#34;); } @Override public String getType() { return \u0026#34;Car - \u0026#34; + brand; } } public class Motorcycle implements Vehicle { private String brand; public Motorcycle(String brand) { this.brand = brand; } @Override public void start() { System.out.println(brand + \u0026#34; æ©Ÿè»Šå•Ÿå‹•\u0026#34;); } @Override public void stop() { System.out.println(brand + \u0026#34; æ©Ÿè»Šåœæ­¢\u0026#34;); } @Override public void accelerate() { System.out.println(brand + \u0026#34; æ©Ÿè»ŠåŠ é€Ÿ\u0026#34;); } @Override public String getType() { return \u0026#34;Motorcycle - \u0026#34; + brand; } } public class Truck implements Vehicle { private String brand; private int capacity; public Truck(String brand, int capacity) { this.brand = brand; this.capacity = capacity; } @Override public void start() { System.out.println(brand + \u0026#34; å¡è»Šå•Ÿå‹• (è¼‰é‡: \u0026#34; + capacity + \u0026#34;å™¸)\u0026#34;); } @Override public void stop() { System.out.println(brand + \u0026#34; å¡è»Šåœæ­¢\u0026#34;); } @Override public void accelerate() { System.out.println(brand + \u0026#34; å¡è»Šç·©æ…¢åŠ é€Ÿ\u0026#34;); } @Override public String getType() { return \u0026#34;Truck - \u0026#34; + brand + \u0026#34; (\u0026#34; + capacity + \u0026#34;t)\u0026#34;; } } ç°¡å–®å·¥å» å¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // è»Šè¼›é¡å‹æšèˆ‰ public enum VehicleType { CAR, MOTORCYCLE, TRUCK } // ç°¡å–®å·¥å» é¡ public class VehicleFactory { public static Vehicle createVehicle(VehicleType type, String brand) { return createVehicle(type, brand, 0); } public static Vehicle createVehicle(VehicleType type, String brand, int capacity) { switch (type) { case CAR: return new Car(brand); case MOTORCYCLE: return new Motorcycle(brand); case TRUCK: if (capacity \u0026lt;= 0) { throw new IllegalArgumentException(\u0026#34;å¡è»Šå¿…é ˆæŒ‡å®šè¼‰é‡å®¹é‡\u0026#34;); } return new Truck(brand, capacity); default: throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„è»Šè¼›é¡å‹: \u0026#34; + type); } } // åŸºæ–¼å­—ç¬¦ä¸²çš„å·¥å» æ–¹æ³•ï¼ˆè¼ƒä¸æ¨è–¦ï¼‰ public static Vehicle createVehicle(String type, String brand) { if (type == null || type.trim().isEmpty()) { throw new IllegalArgumentException(\u0026#34;è»Šè¼›é¡å‹ä¸èƒ½ç‚ºç©º\u0026#34;); } switch (type.toLowerCase()) { case \u0026#34;car\u0026#34;: return new Car(brand); case \u0026#34;motorcycle\u0026#34;: return new Motorcycle(brand); case \u0026#34;truck\u0026#34;: return new Truck(brand, 5); // é è¨­è¼‰é‡ default: throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„è»Šè¼›é¡å‹: \u0026#34; + type); } } } ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public class SimpleFactoryDemo { public static void main(String[] args) { // ä½¿ç”¨æšèˆ‰å‰µå»ºè»Šè¼› Vehicle car = VehicleFactory.createVehicle(VehicleType.CAR, \u0026#34;BMW\u0026#34;); Vehicle motorcycle = VehicleFactory.createVehicle(VehicleType.MOTORCYCLE, \u0026#34;Harley-Davidson\u0026#34;); Vehicle truck = VehicleFactory.createVehicle(VehicleType.TRUCK, \u0026#34;Volvo\u0026#34;, 10); // æ¸¬è©¦è»Šè¼›åŠŸèƒ½ testVehicle(car); testVehicle(motorcycle); testVehicle(truck); // ä½¿ç”¨å­—ç¬¦ä¸²å‰µå»ºï¼ˆä¸æ¨è–¦ä½†æœ‰æ™‚å¿…è¦ï¼‰ Vehicle stringBasedCar = VehicleFactory.createVehicle(\u0026#34;car\u0026#34;, \u0026#34;Mercedes\u0026#34;); testVehicle(stringBasedCar); } private static void testVehicle(Vehicle vehicle) { System.out.println(\u0026#34;\\n=== æ¸¬è©¦ \u0026#34; + vehicle.getType() + \u0026#34; ===\u0026#34;); vehicle.start(); vehicle.accelerate(); vehicle.stop(); } } 2. Factory Method Pattern å·¥å» æ–¹æ³•æ¨¡å¼ å·¥å» æ–¹æ³•æ¨¡å¼å®šç¾©äº†ä¸€å€‹å‰µå»ºå°è±¡çš„æ¥å£ï¼Œä½†è®“å­é¡æ±ºå®šè¦å¯¦ä¾‹åŒ–çš„é¡æ˜¯å“ªä¸€å€‹ã€‚å·¥å» æ–¹æ³•è®“é¡æŠŠå¯¦ä¾‹åŒ–æ¨é²åˆ°å­é¡ã€‚\næ ¸å¿ƒçµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 // æŠ½è±¡ç”¢å“ public abstract class Document { protected String title; protected String content; public Document(String title) { this.title = title; } public abstract void create(); public abstract void save(); public abstract void export(String format); // é€šç”¨æ–¹æ³• public String getTitle() { return title; } public void setContent(String content) { this.content = content; } } // å…·é«”ç”¢å“å¯¦ç¾ public class WordDocument extends Document { public WordDocument(String title) { super(title); } @Override public void create() { System.out.println(\u0026#34;å‰µå»º Word æ–‡æª”: \u0026#34; + title); this.content = \u0026#34;Word æ–‡æª”å…§å®¹æ¨¡æ¿\u0026#34;; } @Override public void save() { System.out.println(\u0026#34;ä¿å­˜ Word æ–‡æª”: \u0026#34; + title + \u0026#34;.docx\u0026#34;); } @Override public void export(String format) { System.out.println(\u0026#34;å°‡ Word æ–‡æª”å°å‡ºç‚º \u0026#34; + format + \u0026#34; æ ¼å¼\u0026#34;); } } public class PdfDocument extends Document { public PdfDocument(String title) { super(title); } @Override public void create() { System.out.println(\u0026#34;å‰µå»º PDF æ–‡æª”: \u0026#34; + title); this.content = \u0026#34;PDF æ–‡æª”å…§å®¹æ¨¡æ¿\u0026#34;; } @Override public void save() { System.out.println(\u0026#34;ä¿å­˜ PDF æ–‡æª”: \u0026#34; + title + \u0026#34;.pdf\u0026#34;); } @Override public void export(String format) { System.out.println(\u0026#34;å°‡ PDF æ–‡æª”å°å‡ºç‚º \u0026#34; + format + \u0026#34; æ ¼å¼\u0026#34;); } } public class ExcelDocument extends Document { public ExcelDocument(String title) { super(title); } @Override public void create() { System.out.println(\u0026#34;å‰µå»º Excel æ–‡æª”: \u0026#34; + title); this.content = \u0026#34;Excel æ–‡æª”æ•¸æ“šæ¨¡æ¿\u0026#34;; } @Override public void save() { System.out.println(\u0026#34;ä¿å­˜ Excel æ–‡æª”: \u0026#34; + title + \u0026#34;.xlsx\u0026#34;); } @Override public void export(String format) { System.out.println(\u0026#34;å°‡ Excel æ–‡æª”å°å‡ºç‚º \u0026#34; + format + \u0026#34; æ ¼å¼\u0026#34;); } } æŠ½è±¡å·¥å» å‰µå»ºè€… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 // æŠ½è±¡å‰µå»ºè€… public abstract class DocumentCreator { protected String author; public DocumentCreator(String author) { this.author = author; } // å·¥å» æ–¹æ³• - å­é¡å¿…é ˆå¯¦ç¾ public abstract Document createDocument(String title); // æ¨¡æ¿æ–¹æ³• - å®šç¾©æ–‡æª”å‰µå»ºæµç¨‹ public Document processDocument(String title, String content) { Document document = createDocument(title); document.setContent(content); document.create(); return document; } // é€šç”¨æ–¹æ³• public String getAuthor() { return author; } } // å…·é«”å‰µå»ºè€…å¯¦ç¾ public class WordDocumentCreator extends DocumentCreator { public WordDocumentCreator(String author) { super(author); } @Override public Document createDocument(String title) { return new WordDocument(title); } } public class PdfDocumentCreator extends DocumentCreator { public PdfDocumentCreator(String author) { super(author); } @Override public Document createDocument(String title) { return new PdfDocument(title); } } public class ExcelDocumentCreator extends DocumentCreator { public ExcelDocumentCreator(String author) { super(author); } @Override public Document createDocument(String title) { return new ExcelDocument(title); } } å·¥å» æ–¹æ³•ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public class FactoryMethodDemo { public static void main(String[] args) { // å‰µå»ºä¸åŒé¡å‹çš„æ–‡æª”å‰µå»ºè€… DocumentCreator wordCreator = new WordDocumentCreator(\u0026#34;Bill.Lin\u0026#34;); DocumentCreator pdfCreator = new PdfDocumentCreator(\u0026#34;Bill.Lin\u0026#34;); DocumentCreator excelCreator = new ExcelDocumentCreator(\u0026#34;Bill.Lin\u0026#34;); // ä½¿ç”¨å·¥å» æ–¹æ³•å‰µå»ºæ–‡æª” Document reportWord = wordCreator.processDocument(\u0026#34;æœˆå ±å‘Š\u0026#34;, \u0026#34;æœ¬æœˆéŠ·å”®æ•¸æ“šåˆ†æ...\u0026#34;); Document contractPdf = pdfCreator.processDocument(\u0026#34;åˆåŒ\u0026#34;, \u0026#34;ç”²ä¹™é›™æ–¹å”è­°æ¢æ¬¾...\u0026#34;); Document dataExcel = excelCreator.processDocument(\u0026#34;æ•¸æ“šè¡¨\u0026#34;, \u0026#34;éŠ·å”®æ•¸æ“šçµ±è¨ˆ...\u0026#34;); // ä¿å­˜æ–‡æª” reportWord.save(); contractPdf.save(); dataExcel.save(); // å°å‡ºæ–‡æª” reportWord.export(\u0026#34;PDF\u0026#34;); contractPdf.export(\u0026#34;Word\u0026#34;); dataExcel.export(\u0026#34;CSV\u0026#34;); } } 3. Abstract Factory Pattern æŠ½è±¡å·¥å» æ¨¡å¼ æŠ½è±¡å·¥å» æ¨¡å¼æä¾›äº†ä¸€å€‹å‰µå»ºä¸€ç³»åˆ—ç›¸é—œæˆ–ç›¸äº’ä¾è³´å°è±¡çš„æ¥å£ï¼Œè€Œç„¡éœ€æŒ‡å®šå®ƒå€‘å…·é«”çš„é¡ã€‚\næŠ½è±¡å·¥å» çµæ§‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 // æŠ½è±¡ç”¢å“æ— - ç”¨æˆ¶ç•Œé¢å…ƒä»¶ public interface Button { void render(); void onClick(); } public interface CheckBox { void render(); void toggle(); } public interface TextField { void render(); void setText(String text); String getText(); } // Windows é¢¨æ ¼å¯¦ç¾ public class WindowsButton implements Button { @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ Windows é¢¨æ ¼æŒ‰éˆ•\u0026#34;); } @Override public void onClick() { System.out.println(\u0026#34;Windows æŒ‰éˆ•é»æ“Šäº‹ä»¶\u0026#34;); } } public class WindowsCheckBox implements CheckBox { private boolean checked = false; @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ Windows é¢¨æ ¼è¤‡é¸æ¡†\u0026#34;); } @Override public void toggle() { checked = !checked; System.out.println(\u0026#34;Windows è¤‡é¸æ¡†ç‹€æ…‹: \u0026#34; + (checked ? \u0026#34;é¸ä¸­\u0026#34; : \u0026#34;æœªé¸ä¸­\u0026#34;)); } } public class WindowsTextField implements TextField { private String text = \u0026#34;\u0026#34;; @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ Windows é¢¨æ ¼æ–‡æœ¬æ¡†\u0026#34;); } @Override public void setText(String text) { this.text = text; System.out.println(\u0026#34;Windows æ–‡æœ¬æ¡†è¨­ç½®å…§å®¹: \u0026#34; + text); } @Override public String getText() { return text; } } // macOS é¢¨æ ¼å¯¦ç¾ public class MacButton implements Button { @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ macOS é¢¨æ ¼æŒ‰éˆ•\u0026#34;); } @Override public void onClick() { System.out.println(\u0026#34;macOS æŒ‰éˆ•é»æ“Šäº‹ä»¶\u0026#34;); } } public class MacCheckBox implements CheckBox { private boolean checked = false; @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ macOS é¢¨æ ¼è¤‡é¸æ¡†\u0026#34;); } @Override public void toggle() { checked = !checked; System.out.println(\u0026#34;macOS è¤‡é¸æ¡†ç‹€æ…‹: \u0026#34; + (checked ? \u0026#34;é¸ä¸­\u0026#34; : \u0026#34;æœªé¸ä¸­\u0026#34;)); } } public class MacTextField implements TextField { private String text = \u0026#34;\u0026#34;; @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ macOS é¢¨æ ¼æ–‡æœ¬æ¡†\u0026#34;); } @Override public void setText(String text) { this.text = text; System.out.println(\u0026#34;macOS æ–‡æœ¬æ¡†è¨­ç½®å…§å®¹: \u0026#34; + text); } @Override public String getText() { return text; } } // Linux é¢¨æ ¼å¯¦ç¾ public class LinuxButton implements Button { @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ Linux é¢¨æ ¼æŒ‰éˆ•\u0026#34;); } @Override public void onClick() { System.out.println(\u0026#34;Linux æŒ‰éˆ•é»æ“Šäº‹ä»¶\u0026#34;); } } public class LinuxCheckBox implements CheckBox { private boolean checked = false; @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ Linux é¢¨æ ¼è¤‡é¸æ¡†\u0026#34;); } @Override public void toggle() { checked = !checked; System.out.println(\u0026#34;Linux è¤‡é¸æ¡†ç‹€æ…‹: \u0026#34; + (checked ? \u0026#34;é¸ä¸­\u0026#34; : \u0026#34;æœªé¸ä¸­\u0026#34;)); } } public class LinuxTextField implements TextField { private String text = \u0026#34;\u0026#34;; @Override public void render() { System.out.println(\u0026#34;æ¸²æŸ“ Linux é¢¨æ ¼æ–‡æœ¬æ¡†\u0026#34;); } @Override public void setText(String text) { this.text = text; System.out.println(\u0026#34;Linux æ–‡æœ¬æ¡†è¨­ç½®å…§å®¹: \u0026#34; + text); } @Override public String getText() { return text; } } æŠ½è±¡å·¥å» æ¥å£å’Œå¯¦ç¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 // æŠ½è±¡å·¥å» æ¥å£ public interface GUIFactory { Button createButton(); CheckBox createCheckBox(); TextField createTextField(); } // å…·é«”å·¥å» å¯¦ç¾ public class WindowsFactory implements GUIFactory { @Override public Button createButton() { return new WindowsButton(); } @Override public CheckBox createCheckBox() { return new WindowsCheckBox(); } @Override public TextField createTextField() { return new WindowsTextField(); } } public class MacFactory implements GUIFactory { @Override public Button createButton() { return new MacButton(); } @Override public CheckBox createCheckBox() { return new MacCheckBox(); } @Override public TextField createTextField() { return new MacTextField(); } } public class LinuxFactory implements GUIFactory { @Override public Button createButton() { return new LinuxButton(); } @Override public CheckBox createCheckBox() { return new LinuxCheckBox(); } @Override public TextField createTextField() { return new LinuxTextField(); } } å·¥å» è¨»å†Šå™¨å’Œé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // å·¥å» è¨»å†Šå™¨ public class GUIFactoryRegistry { private static final Map\u0026lt;String, GUIFactory\u0026gt; factories = new HashMap\u0026lt;\u0026gt;(); static { register(\u0026#34;windows\u0026#34;, new WindowsFactory()); register(\u0026#34;macos\u0026#34;, new MacFactory()); register(\u0026#34;linux\u0026#34;, new LinuxFactory()); } public static void register(String type, GUIFactory factory) { factories.put(type.toLowerCase(), factory); } public static GUIFactory getFactory(String type) { GUIFactory factory = factories.get(type.toLowerCase()); if (factory == null) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„å¹³å°é¡å‹: \u0026#34; + type); } return factory; } public static GUIFactory detectPlatform() { String osName = System.getProperty(\u0026#34;os.name\u0026#34;).toLowerCase(); if (osName.contains(\u0026#34;windows\u0026#34;)) { return getFactory(\u0026#34;windows\u0026#34;); } else if (osName.contains(\u0026#34;mac\u0026#34;)) { return getFactory(\u0026#34;macos\u0026#34;); } else { return getFactory(\u0026#34;linux\u0026#34;); } } } // æ‡‰ç”¨ç¨‹åºé¡ public class Application { private Button button; private CheckBox checkBox; private TextField textField; public Application(GUIFactory factory) { this.button = factory.createButton(); this.checkBox = factory.createCheckBox(); this.textField = factory.createTextField(); } public void createUI() { System.out.println(\u0026#34;=== å‰µå»ºç”¨æˆ¶ç•Œé¢ ===\u0026#34;); button.render(); checkBox.render(); textField.render(); } public void simulateUserInteraction() { System.out.println(\u0026#34;\\n=== æ¨¡æ“¬ç”¨æˆ¶äº¤äº’ ===\u0026#34;); button.onClick(); checkBox.toggle(); textField.setText(\u0026#34;Hello Factory Pattern!\u0026#34;); System.out.println(\u0026#34;æ–‡æœ¬æ¡†å…§å®¹: \u0026#34; + textField.getText()); } } æŠ½è±¡å·¥å» ä½¿ç”¨ç¯„ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public class AbstractFactoryDemo { public static void main(String[] args) { // æ–¹å¼1: æ‰‹å‹•æŒ‡å®šå¹³å° System.out.println(\u0026#34;=== æ‰‹å‹•æŒ‡å®šå¹³å° ===\u0026#34;); testPlatform(\u0026#34;windows\u0026#34;); testPlatform(\u0026#34;macos\u0026#34;); testPlatform(\u0026#34;linux\u0026#34;); // æ–¹å¼2: è‡ªå‹•æª¢æ¸¬å¹³å° System.out.println(\u0026#34;\\n=== è‡ªå‹•æª¢æ¸¬å¹³å° ===\u0026#34;); GUIFactory autoFactory = GUIFactoryRegistry.detectPlatform(); Application autoApp = new Application(autoFactory); autoApp.createUI(); autoApp.simulateUserInteraction(); } private static void testPlatform(String platform) { System.out.println(\u0026#34;\\n--- æ¸¬è©¦ \u0026#34; + platform.toUpperCase() + \u0026#34; å¹³å° ---\u0026#34;); GUIFactory factory = GUIFactoryRegistry.getFactory(platform); Application app = new Application(factory); app.createUI(); app.simulateUserInteraction(); } } 4. ç¾ä»£ Java Factory Pattern å¯¦ç¾ ä½¿ç”¨ Lambda è¡¨é”å¼å’Œå‡½æ•¸å¼æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 import java.util.function.Supplier; import java.util.function.Function; // å‡½æ•¸å¼å·¥å» æ¥å£ @FunctionalInterface public interface VehicleSupplier extends Supplier\u0026lt;Vehicle\u0026gt; { } // å‡½æ•¸å¼å·¥å» å¯¦ç¾ public class FunctionalVehicleFactory { private static final Map\u0026lt;VehicleType, Function\u0026lt;String, Vehicle\u0026gt;\u0026gt; factoryMap = Map.of( VehicleType.CAR, Car::new, VehicleType.MOTORCYCLE, Motorcycle::new, VehicleType.TRUCK, brand -\u0026gt; new Truck(brand, 5) ); public static Vehicle createVehicle(VehicleType type, String brand) { Function\u0026lt;String, Vehicle\u0026gt; factory = factoryMap.get(type); if (factory == null) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„è»Šè¼›é¡å‹: \u0026#34; + type); } return factory.apply(brand); } // ä½¿ç”¨ Supplier çš„å·¥å» æ–¹æ³• public static Vehicle createVehicle(VehicleSupplier supplier) { return supplier.get(); } } // ä½¿ç”¨ç¯„ä¾‹ public class FunctionalFactoryDemo { public static void main(String[] args) { // ä½¿ç”¨ Map-based å·¥å»  Vehicle car = FunctionalVehicleFactory.createVehicle(VehicleType.CAR, \u0026#34;Tesla\u0026#34;); // ä½¿ç”¨ Lambda è¡¨é”å¼ Vehicle motorcycle = FunctionalVehicleFactory.createVehicle(() -\u0026gt; new Motorcycle(\u0026#34;Yamaha\u0026#34;)); // ä½¿ç”¨æ–¹æ³•å¼•ç”¨ Vehicle truck = FunctionalVehicleFactory.createVehicle(() -\u0026gt; new Truck(\u0026#34;Mercedes\u0026#34;, 15)); // æ¸¬è©¦è»Šè¼› Stream.of(car, motorcycle, truck) .forEach(vehicle -\u0026gt; { vehicle.start(); vehicle.accelerate(); vehicle.stop(); System.out.println(\u0026#34;---\u0026#34;); }); } } ä½¿ç”¨ Enum çš„å·¥å» æ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // å¢å¼·çš„æšèˆ‰å·¥å»  public enum VehicleFactoryEnum { CAR(\u0026#34;æ±½è»Š\u0026#34;) { @Override public Vehicle create(String brand, Object... params) { return new Car(brand); } }, MOTORCYCLE(\u0026#34;æ©Ÿè»Š\u0026#34;) { @Override public Vehicle create(String brand, Object... params) { return new Motorcycle(brand); } }, TRUCK(\u0026#34;å¡è»Š\u0026#34;) { @Override public Vehicle create(String brand, Object... params) { if (params.length \u0026gt; 0 \u0026amp;\u0026amp; params[0] instanceof Integer) { return new Truck(brand, (Integer) params[0]); } return new Truck(brand, 5); // é è¨­è¼‰é‡ } }; private final String description; VehicleFactoryEnum(String description) { this.description = description; } public abstract Vehicle create(String brand, Object... params); public String getDescription() { return description; } // éœæ…‹å·¥å» æ–¹æ³• public static Vehicle createVehicle(String type, String brand, Object... params) { try { VehicleFactoryEnum factory = VehicleFactoryEnum.valueOf(type.toUpperCase()); return factory.create(brand, params); } catch (IllegalArgumentException e) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„è»Šè¼›é¡å‹: \u0026#34; + type); } } } 5. Spring Boot ä¸­çš„ Factory Pattern Spring Configuration Factory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.Profile; import org.springframework.boot.context.properties.ConfigurationProperties; // é…ç½®å±¬æ€§ @ConfigurationProperties(prefix = \u0026#34;app.notification\u0026#34;) public class NotificationProperties { private String provider = \u0026#34;email\u0026#34;; private String apiKey; private String baseUrl; // getters and setters public String getProvider() { return provider; } public void setProvider(String provider) { this.provider = provider; } public String getApiKey() { return apiKey; } public void setApiKey(String apiKey) { this.apiKey = apiKey; } public String getBaseUrl() { return baseUrl; } public void setBaseUrl(String baseUrl) { this.baseUrl = baseUrl; } } // é€šçŸ¥æœå‹™æ¥å£ public interface NotificationService { void sendNotification(String recipient, String message); boolean isAvailable(); } // å…·é«”å¯¦ç¾ @Component public class EmailNotificationService implements NotificationService { private final String apiKey; public EmailNotificationService(@Value(\u0026#34;${app.notification.api-key}\u0026#34;) String apiKey) { this.apiKey = apiKey; } @Override public void sendNotification(String recipient, String message) { System.out.println(\u0026#34;ç™¼é€éƒµä»¶åˆ° \u0026#34; + recipient + \u0026#34;: \u0026#34; + message); // å¯¦éš›éƒµä»¶ç™¼é€é‚è¼¯ } @Override public boolean isAvailable() { return apiKey != null \u0026amp;\u0026amp; !apiKey.isEmpty(); } } @Component public class SmsNotificationService implements NotificationService { private final String apiKey; public SmsNotificationService(@Value(\u0026#34;${app.notification.api-key}\u0026#34;) String apiKey) { this.apiKey = apiKey; } @Override public void sendNotification(String recipient, String message) { System.out.println(\u0026#34;ç™¼é€çŸ­ä¿¡åˆ° \u0026#34; + recipient + \u0026#34;: \u0026#34; + message); // å¯¦éš›çŸ­ä¿¡ç™¼é€é‚è¼¯ } @Override public boolean isAvailable() { return apiKey != null \u0026amp;\u0026amp; !apiKey.isEmpty(); } } @Component public class PushNotificationService implements NotificationService { private final String baseUrl; public PushNotificationService(@Value(\u0026#34;${app.notification.base-url}\u0026#34;) String baseUrl) { this.baseUrl = baseUrl; } @Override public void sendNotification(String recipient, String message) { System.out.println(\u0026#34;ç™¼é€æ¨é€é€šçŸ¥åˆ° \u0026#34; + recipient + \u0026#34;: \u0026#34; + message); // å¯¦éš›æ¨é€é€šçŸ¥é‚è¼¯ } @Override public boolean isAvailable() { return baseUrl != null \u0026amp;\u0026amp; !baseUrl.isEmpty(); } } Spring Factory Configuration 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 // é€šçŸ¥å·¥å» æ¥å£ public interface NotificationFactory { NotificationService createNotificationService(String type); List\u0026lt;NotificationService\u0026gt; getAllAvailableServices(); } // Spring ç®¡ç†çš„å·¥å» å¯¦ç¾ @Component public class SpringNotificationFactory implements NotificationFactory { private final Map\u0026lt;String, NotificationService\u0026gt; services; public SpringNotificationFactory(List\u0026lt;NotificationService\u0026gt; notificationServices) { this.services = notificationServices.stream() .collect(Collectors.toMap( service -\u0026gt; service.getClass().getSimpleName().toLowerCase().replace(\u0026#34;notificationservice\u0026#34;, \u0026#34;\u0026#34;), Function.identity() )); } @Override public NotificationService createNotificationService(String type) { NotificationService service = services.get(type.toLowerCase()); if (service == null) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„é€šçŸ¥é¡å‹: \u0026#34; + type); } if (!service.isAvailable()) { throw new IllegalStateException(\u0026#34;é€šçŸ¥æœå‹™ä¸å¯ç”¨: \u0026#34; + type); } return service; } @Override public List\u0026lt;NotificationService\u0026gt; getAllAvailableServices() { return services.values().stream() .filter(NotificationService::isAvailable) .collect(Collectors.toList()); } } // é…ç½®é¡ @Configuration @EnableConfigurationProperties(NotificationProperties.class) public class NotificationConfig { @Bean @Primary public NotificationService primaryNotificationService( NotificationProperties properties, NotificationFactory factory) { return factory.createNotificationService(properties.getProvider()); } @Bean @Profile(\u0026#34;development\u0026#34;) public NotificationService devNotificationService() { return new NotificationService() { @Override public void sendNotification(String recipient, String message) { System.out.println(\u0026#34;[DEV] æ¨¡æ“¬é€šçŸ¥ - æ”¶ä»¶äºº: \u0026#34; + recipient + \u0026#34;, æ¶ˆæ¯: \u0026#34; + message); } @Override public boolean isAvailable() { return true; } }; } } Spring Boot Factory æœå‹™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 // é€šçŸ¥ç®¡ç†å™¨æœå‹™ @Service public class NotificationManager { private final NotificationFactory notificationFactory; private final NotificationProperties properties; public NotificationManager(NotificationFactory notificationFactory, NotificationProperties properties) { this.notificationFactory = notificationFactory; this.properties = properties; } public void sendNotification(String type, String recipient, String message) { try { NotificationService service = notificationFactory.createNotificationService(type); service.sendNotification(recipient, message); } catch (Exception e) { // é™ç´šåˆ°ä¸»è¦é€šçŸ¥æœå‹™ NotificationService fallbackService = notificationFactory.createNotificationService(properties.getProvider()); fallbackService.sendNotification(recipient, \u0026#34;åŸé€šçŸ¥å¤±æ•—ï¼Œæ”¹ç”¨ \u0026#34; + properties.getProvider() + \u0026#34;: \u0026#34; + message); } } public void sendBroadcast(String message) { List\u0026lt;NotificationService\u0026gt; availableServices = notificationFactory.getAllAvailableServices(); availableServices.parallelStream() .forEach(service -\u0026gt; { try { service.sendNotification(\u0026#34;broadcast\u0026#34;, message); } catch (Exception e) { System.err.println(\u0026#34;å»£æ’­é€šçŸ¥å¤±æ•—: \u0026#34; + e.getMessage()); } }); } } // æ§åˆ¶å™¨ä½¿ç”¨ç¯„ä¾‹ @RestController @RequestMapping(\u0026#34;/api/notifications\u0026#34;) public class NotificationController { private final NotificationManager notificationManager; public NotificationController(NotificationManager notificationManager) { this.notificationManager = notificationManager; } @PostMapping(\u0026#34;/send\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; sendNotification( @RequestParam String type, @RequestParam String recipient, @RequestParam String message) { try { notificationManager.sendNotification(type, recipient, message); return ResponseEntity.ok(\u0026#34;é€šçŸ¥ç™¼é€æˆåŠŸ\u0026#34;); } catch (Exception e) { return ResponseEntity.badRequest().body(\u0026#34;é€šçŸ¥ç™¼é€å¤±æ•—: \u0026#34; + e.getMessage()); } } @PostMapping(\u0026#34;/broadcast\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; broadcast(@RequestParam String message) { notificationManager.sendBroadcast(message); return ResponseEntity.ok(\u0026#34;å»£æ’­é€šçŸ¥å·²ç™¼é€\u0026#34;); } } 6. ä¼æ¥­ç´š Factory Pattern å¯¦ç¾ æ•¸æ“šæºå·¥å»  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 // æ•¸æ“šæºé¡å‹ public enum DataSourceType { MYSQL(\u0026#34;MySQL æ•¸æ“šåº«\u0026#34;), POSTGRESQL(\u0026#34;PostgreSQL æ•¸æ“šåº«\u0026#34;), ORACLE(\u0026#34;Oracle æ•¸æ“šåº«\u0026#34;), MONGODB(\u0026#34;MongoDB æ•¸æ“šåº«\u0026#34;), REDIS(\u0026#34;Redis ç·©å­˜\u0026#34;); private final String description; DataSourceType(String description) { this.description = description; } public String getDescription() { return description; } } // æ•¸æ“šæºé…ç½® public class DataSourceConfig { private String url; private String username; private String password; private String driverClassName; private int maxPoolSize = 20; private int minPoolSize = 5; private long connectionTimeout = 30000; // å»ºæ§‹å™¨æ¨¡å¼ public static class Builder { private final DataSourceConfig config = new DataSourceConfig(); public Builder url(String url) { config.url = url; return this; } public Builder username(String username) { config.username = username; return this; } public Builder password(String password) { config.password = password; return this; } public Builder driverClassName(String driverClassName) { config.driverClassName = driverClassName; return this; } public Builder maxPoolSize(int maxPoolSize) { config.maxPoolSize = maxPoolSize; return this; } public Builder minPoolSize(int minPoolSize) { config.minPoolSize = minPoolSize; return this; } public Builder connectionTimeout(long connectionTimeout) { config.connectionTimeout = connectionTimeout; return this; } public DataSourceConfig build() { if (config.url == null) { throw new IllegalArgumentException(\u0026#34;æ•¸æ“šæº URL ä¸èƒ½ç‚ºç©º\u0026#34;); } return config; } } // getters public String getUrl() { return url; } public String getUsername() { return username; } public String getPassword() { return password; } public String getDriverClassName() { return driverClassName; } public int getMaxPoolSize() { return maxPoolSize; } public int getMinPoolSize() { return minPoolSize; } public long getConnectionTimeout() { return connectionTimeout; } } // æŠ½è±¡æ•¸æ“šæºå·¥å»  public abstract class DataSourceFactory { protected final DataSourceConfig config; public DataSourceFactory(DataSourceConfig config) { this.config = config; } public abstract DataSource createDataSource(); public abstract boolean testConnection(); // æ¨¡æ¿æ–¹æ³• public DataSource createAndTestDataSource() { DataSource dataSource = createDataSource(); if (!testConnection()) { throw new RuntimeException(\u0026#34;æ•¸æ“šæºé€£æ¥æ¸¬è©¦å¤±æ•—\u0026#34;); } return dataSource; } } // å…·é«”æ•¸æ“šæºå·¥å» å¯¦ç¾ public class MySQLDataSourceFactory extends DataSourceFactory { public MySQLDataSourceFactory(DataSourceConfig config) { super(config); } @Override public DataSource createDataSource() { HikariConfig hikariConfig = new HikariConfig(); hikariConfig.setJdbcUrl(config.getUrl()); hikariConfig.setUsername(config.getUsername()); hikariConfig.setPassword(config.getPassword()); hikariConfig.setDriverClassName(\u0026#34;com.mysql.cj.jdbc.Driver\u0026#34;); hikariConfig.setMaximumPoolSize(config.getMaxPoolSize()); hikariConfig.setMinimumIdle(config.getMinPoolSize()); hikariConfig.setConnectionTimeout(config.getConnectionTimeout()); return new HikariDataSource(hikariConfig); } @Override public boolean testConnection() { try (Connection conn = createDataSource().getConnection()) { return conn.isValid(5); } catch (SQLException e) { return false; } } } public class PostgreSQLDataSourceFactory extends DataSourceFactory { public PostgreSQLDataSourceFactory(DataSourceConfig config) { super(config); } @Override public DataSource createDataSource() { HikariConfig hikariConfig = new HikariConfig(); hikariConfig.setJdbcUrl(config.getUrl()); hikariConfig.setUsername(config.getUsername()); hikariConfig.setPassword(config.getPassword()); hikariConfig.setDriverClassName(\u0026#34;org.postgresql.Driver\u0026#34;); hikariConfig.setMaximumPoolSize(config.getMaxPoolSize()); hikariConfig.setMinimumIdle(config.getMinPoolSize()); hikariConfig.setConnectionTimeout(config.getConnectionTimeout()); return new HikariDataSource(hikariConfig); } @Override public boolean testConnection() { try (Connection conn = createDataSource().getConnection()) { return conn.isValid(5); } catch (SQLException e) { return false; } } } ä¼æ¥­ç´šå·¥å» ç®¡ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // æ•¸æ“šæºå·¥å» ç®¡ç†å™¨ @Component public class DataSourceFactoryManager { private static final Map\u0026lt;DataSourceType, Class\u0026lt;? extends DataSourceFactory\u0026gt;\u0026gt; factoryRegistry = Map.of( DataSourceType.MYSQL, MySQLDataSourceFactory.class, DataSourceType.POSTGRESQL, PostgreSQLDataSourceFactory.class ); private final ApplicationContext applicationContext; public DataSourceFactoryManager(ApplicationContext applicationContext) { this.applicationContext = applicationContext; } public DataSourceFactory createFactory(DataSourceType type, DataSourceConfig config) { Class\u0026lt;? extends DataSourceFactory\u0026gt; factoryClass = factoryRegistry.get(type); if (factoryClass == null) { throw new IllegalArgumentException(\u0026#34;ä¸æ”¯æ´çš„æ•¸æ“šæºé¡å‹: \u0026#34; + type); } try { Constructor\u0026lt;? extends DataSourceFactory\u0026gt; constructor = factoryClass.getConstructor(DataSourceConfig.class); return constructor.newInstance(config); } catch (Exception e) { throw new RuntimeException(\u0026#34;å‰µå»ºæ•¸æ“šæºå·¥å» å¤±æ•—\u0026#34;, e); } } @Cacheable(\u0026#34;dataSources\u0026#34;) public DataSource getDataSource(DataSourceType type, DataSourceConfig config) { DataSourceFactory factory = createFactory(type, config); return factory.createAndTestDataSource(); } } 7. å·¥å» æ¨¡å¼çš„æœ€ä½³å¯¦è¸ éŒ¯èª¤è™•ç†å’Œé©—è­‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 // å¢å¼·çš„å·¥å» å¯¦ç¾ï¼ŒåŒ…å«å®Œæ•´çš„éŒ¯èª¤è™•ç† public class RobustVehicleFactory { private static final Logger logger = LoggerFactory.getLogger(RobustVehicleFactory.class); // ç”¢å“é©—è­‰å™¨ private static final Map\u0026lt;VehicleType, Predicate\u0026lt;String\u0026gt;\u0026gt; validators = Map.of( VehicleType.CAR, brand -\u0026gt; brand != null \u0026amp;\u0026amp; brand.length() \u0026gt; 2, VehicleType.MOTORCYCLE, brand -\u0026gt; brand != null \u0026amp;\u0026amp; brand.length() \u0026gt; 1, VehicleType.TRUCK, brand -\u0026gt; brand != null \u0026amp;\u0026amp; brand.length() \u0026gt; 3 ); public static Vehicle createVehicle(VehicleType type, String brand) { return createVehicle(type, brand, null); } public static Vehicle createVehicle(VehicleType type, String brand, Integer capacity) { // è¼¸å…¥é©—è­‰ validateInputs(type, brand, capacity); try { Vehicle vehicle = createVehicleInternal(type, brand, capacity); logger.info(\u0026#34;æˆåŠŸå‰µå»ºè»Šè¼›: {} - {}\u0026#34;, type, brand); return vehicle; } catch (Exception e) { logger.error(\u0026#34;å‰µå»ºè»Šè¼›å¤±æ•—: {} - {}\u0026#34;, type, brand, e); throw new VehicleCreationException(\u0026#34;å‰µå»ºè»Šè¼›å¤±æ•—: \u0026#34; + e.getMessage(), e); } } private static void validateInputs(VehicleType type, String brand, Integer capacity) { if (type == null) { throw new IllegalArgumentException(\u0026#34;è»Šè¼›é¡å‹ä¸èƒ½ç‚ºç©º\u0026#34;); } Predicate\u0026lt;String\u0026gt; validator = validators.get(type); if (validator != null \u0026amp;\u0026amp; !validator.test(brand)) { throw new IllegalArgumentException(\u0026#34;å“ç‰Œåç¨±ä¸ç¬¦åˆè¦æ±‚: \u0026#34; + brand); } if (type == VehicleType.TRUCK \u0026amp;\u0026amp; (capacity == null || capacity \u0026lt;= 0)) { throw new IllegalArgumentException(\u0026#34;å¡è»Šå¿…é ˆæŒ‡å®šæœ‰æ•ˆçš„è¼‰é‡å®¹é‡\u0026#34;); } } private static Vehicle createVehicleInternal(VehicleType type, String brand, Integer capacity) { switch (type) { case CAR: return new Car(brand); case MOTORCYCLE: return new Motorcycle(brand); case TRUCK: return new Truck(brand, capacity != null ? capacity : 5); default: throw new UnsupportedOperationException(\u0026#34;ä¸æ”¯æ´çš„è»Šè¼›é¡å‹: \u0026#34; + type); } } } // è‡ªå®šç¾©ç•°å¸¸ public class VehicleCreationException extends RuntimeException { public VehicleCreationException(String message) { super(message); } public VehicleCreationException(String message, Throwable cause) { super(message, cause); } } å·¥å» æ¨¡å¼æ€§èƒ½å„ªåŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // ç·©å­˜å„ªåŒ–çš„å·¥å»  public class CachedVehicleFactory { private static final Cache\u0026lt;String, Vehicle\u0026gt; vehicleCache = Caffeine.newBuilder() .maximumSize(1000) .expireAfterWrite(1, TimeUnit.HOURS) .build(); public static Vehicle createVehicle(VehicleType type, String brand) { String cacheKey = type + \u0026#34;:\u0026#34; + brand; return vehicleCache.get(cacheKey, key -\u0026gt; { // åªæœ‰ç•¶ç·©å­˜ä¸­æ²’æœ‰æ™‚æ‰å‰µå»ºæ–°å¯¦ä¾‹ return RobustVehicleFactory.createVehicle(type, brand); }); } // åŸå‹æ¨¡å¼çµåˆ - ç”¨æ–¼æ˜‚è²´å°è±¡ public static Vehicle createVehicleWithPrototype(VehicleType type, String brand) { Vehicle prototype = createVehicle(type, brand); try { return (Vehicle) prototype.clone(); // éœ€è¦å¯¦ç¾ Cloneable } catch (CloneNotSupportedException e) { throw new RuntimeException(\u0026#34;å…‹éš†è»Šè¼›å¤±æ•—\u0026#34;, e); } } // æ¸…ç†ç·©å­˜ public static void clearCache() { vehicleCache.invalidateAll(); } // ç²å–ç·©å­˜çµ±è¨ˆ public static void printCacheStats() { CacheStats stats = vehicleCache.stats(); System.out.printf(\u0026#34;ç·©å­˜çµ±è¨ˆ - å‘½ä¸­ç‡: %.2f%%, å‘½ä¸­æ¬¡æ•¸: %d, æœªå‘½ä¸­æ¬¡æ•¸: %d%n\u0026#34;, stats.hitRate() * 100, stats.hitCount(), stats.missCount()); } } 8. å·¥å» æ¨¡å¼çš„åæ¨¡å¼å’Œæ³¨æ„äº‹é … å¸¸è¦‹åæ¨¡å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 // âŒ åæ¨¡å¼ 1: å·¥å» é¡éæ–¼é¾å¤§ public class BadGiantFactory { // é•èƒŒäº†å–®ä¸€è·è²¬åŸå‰‡ public Object createAnything(String type, String subType, Map\u0026lt;String, Object\u0026gt; params) { if (\u0026#34;vehicle\u0026#34;.equals(type)) { if (\u0026#34;car\u0026#34;.equals(subType)) { // 100 è¡Œè»Šè¼›å‰µå»ºé‚è¼¯ } else if (\u0026#34;motorcycle\u0026#34;.equals(subType)) { // 80 è¡Œæ©Ÿè»Šå‰µå»ºé‚è¼¯ } } else if (\u0026#34;document\u0026#34;.equals(type)) { if (\u0026#34;word\u0026#34;.equals(subType)) { // 120 è¡Œæ–‡æª”å‰µå»ºé‚è¼¯ } } // ... æ›´å¤šé¡å‹ return null; } } // âœ… æ­£ç¢ºåšæ³•: æŒ‰è·è²¬åˆ†é›¢å·¥å»  public interface SpecializedFactory\u0026lt;T\u0026gt; { T create(String type, Map\u0026lt;String, Object\u0026gt; params); } public class VehicleFactory implements SpecializedFactory\u0026lt;Vehicle\u0026gt; { @Override public Vehicle create(String type, Map\u0026lt;String, Object\u0026gt; params) { // å°ˆæ³¨æ–¼è»Šè¼›å‰µå»º return null; } } public class DocumentFactory implements SpecializedFactory\u0026lt;Document\u0026gt; { @Override public Document create(String type, Map\u0026lt;String, Object\u0026gt; params) { // å°ˆæ³¨æ–¼æ–‡æª”å‰µå»º return null; } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // âŒ åæ¨¡å¼ 2: ç›´æ¥åœ¨å·¥å» ä¸­ç¡¬ç·¨ç¢¼ä¾è³´ public class BadDependencyFactory { public UserService createUserService() { // ç¡¬ç·¨ç¢¼ä¾è³´ï¼Œé›£ä»¥æ¸¬è©¦å’Œæ“´å±• UserRepository repo = new DatabaseUserRepository(); EmailService email = new SmtpEmailService(); return new UserService(repo, email); } } // âœ… æ­£ç¢ºåšæ³•: ä½¿ç”¨ä¾è³´æ³¨å…¥ @Component public class UserServiceFactory { private final UserRepository userRepository; private final EmailService emailService; public UserServiceFactory(UserRepository userRepository, EmailService emailService) { this.userRepository = userRepository; this.emailService = emailService; } public UserService createUserService() { return new UserService(userRepository, emailService); } } æœ€ä½³å¯¦è¸ç¸½çµ å–®ä¸€è·è²¬: æ¯å€‹å·¥å» åªè² è²¬å‰µå»ºä¸€é¡ç›¸é—œçš„å°è±¡ é–‹é–‰åŸå‰‡: å°æ“´å±•é–‹æ”¾ï¼Œå°ä¿®æ”¹é—œé–‰ ä¾è³´æ³¨å…¥: åœ¨ Spring ç’°å¢ƒä¸­å„ªå…ˆä½¿ç”¨ä¾è³´æ³¨å…¥ ç•°å¸¸è™•ç†: æä¾›æ¸…æ™°çš„éŒ¯èª¤ä¿¡æ¯å’Œæ¢å¾©æ©Ÿåˆ¶ æ€§èƒ½è€ƒæ…®: å°æ–¼æ˜‚è²´å°è±¡ä½¿ç”¨ç·©å­˜æˆ–å°è±¡æ±  é¡å‹å®‰å…¨: ä½¿ç”¨æšèˆ‰å’Œæ³›å‹æé«˜é¡å‹å®‰å…¨ å¯æ¸¬è©¦æ€§: è¨­è¨ˆæ™‚è€ƒæ…®å–®å…ƒæ¸¬è©¦çš„ä¾¿åˆ©æ€§ 9. å·¥å» æ¨¡å¼ vs å…¶ä»–å‰µå»ºå‹æ¨¡å¼ Factory vs Builder 1 2 3 4 5 6 7 8 9 10 11 12 // Factory: é©åˆç°¡å–®å°è±¡å‰µå»º Vehicle car = VehicleFactory.createVehicle(VehicleType.CAR, \u0026#34;BMW\u0026#34;); // Builder: é©åˆè¤‡é›œå°è±¡å‰µå»º Car complexCar = new Car.Builder() .brand(\u0026#34;BMW\u0026#34;) .model(\u0026#34;X5\u0026#34;) .year(2023) .color(\u0026#34;Black\u0026#34;) .engine(new Engine(\u0026#34;V8\u0026#34;, 400)) .transmission(\u0026#34;Automatic\u0026#34;) .build(); Factory vs Singleton 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // Factory: æ¯æ¬¡èª¿ç”¨å‰µå»ºæ–°å¯¦ä¾‹ public class VehicleFactory { public static Vehicle createVehicle() { return new Car(\u0026#34;Default\u0026#34;); // æ–°å¯¦ä¾‹ } } // Singleton: ç¢ºä¿åªæœ‰ä¸€å€‹å¯¦ä¾‹ public class ConfigurationManager { private static ConfigurationManager instance; public static ConfigurationManager getInstance() { if (instance == null) { synchronized (ConfigurationManager.class) { if (instance == null) { instance = new ConfigurationManager(); } } } return instance; // ç›¸åŒå¯¦ä¾‹ } } 10. æ¸¬è©¦ç­–ç•¥ å·¥å» æ¨¡å¼å–®å…ƒæ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 @ExtendWith(MockitoExtension.class) class VehicleFactoryTest { @Test void should_create_car_when_type_is_car() { // Given VehicleType type = VehicleType.CAR; String brand = \u0026#34;BMW\u0026#34;; // When Vehicle vehicle = VehicleFactory.createVehicle(type, brand); // Then assertThat(vehicle).isInstanceOf(Car.class); assertThat(vehicle.getType()).contains(\u0026#34;BMW\u0026#34;); } @Test void should_create_truck_with_capacity() { // Given VehicleType type = VehicleType.TRUCK; String brand = \u0026#34;Volvo\u0026#34;; int capacity = 10; // When Vehicle vehicle = VehicleFactory.createVehicle(type, brand, capacity); // Then assertThat(vehicle).isInstanceOf(Truck.class); assertThat(vehicle.getType()).contains(\u0026#34;10t\u0026#34;); } @Test void should_throw_exception_when_invalid_type() { // Given String invalidType = \u0026#34;invalid\u0026#34;; String brand = \u0026#34;BMW\u0026#34;; // When \u0026amp; Then assertThatThrownBy(() -\u0026gt; VehicleFactory.createVehicle(invalidType, brand)) .isInstanceOf(IllegalArgumentException.class) .hasMessageContaining(\u0026#34;ä¸æ”¯æ´çš„è»Šè¼›é¡å‹\u0026#34;); } @Test void should_throw_exception_when_truck_without_capacity() { // Given VehicleType type = VehicleType.TRUCK; String brand = \u0026#34;Volvo\u0026#34;; // When \u0026amp; Then assertThatThrownBy(() -\u0026gt; VehicleFactory.createVehicle(type, brand)) .isInstanceOf(IllegalArgumentException.class) .hasMessageContaining(\u0026#34;å¡è»Šå¿…é ˆæŒ‡å®šè¼‰é‡å®¹é‡\u0026#34;); } } // Spring Boot é›†æˆæ¸¬è©¦ @SpringBootTest class NotificationFactoryIntegrationTest { @Autowired private NotificationFactory notificationFactory; @Test void should_create_email_service_when_configured() { // When NotificationService service = notificationFactory.createNotificationService(\u0026#34;email\u0026#34;); // Then assertThat(service).isInstanceOf(EmailNotificationService.class); assertThat(service.isAvailable()).isTrue(); } @Test void should_return_all_available_services() { // When List\u0026lt;NotificationService\u0026gt; services = notificationFactory.getAllAvailableServices(); // Then assertThat(services).isNotEmpty(); assertThat(services).allMatch(NotificationService::isAvailable); } } 11. ç¸½çµ é©ç”¨å ´æ™¯ ç°¡å–®å·¥å» æ¨¡å¼:\nç”¢å“é¡è¼ƒå°‘ä¸”ç›¸å°ç©©å®š å®¢æˆ¶ç«¯åªéœ€è¦çŸ¥é“å‚³å…¥å·¥å» é¡çš„åƒæ•¸ ä¸éœ€è¦é »ç¹æ“´å±•ç”¢å“é¡ å·¥å» æ–¹æ³•æ¨¡å¼:\néœ€è¦éˆæ´»çš„ç”¢å“å‰µå»ºæ©Ÿåˆ¶ ç”¢å“é¡å¯èƒ½æœƒé »ç¹æ“´å±• éœ€è¦éµå¾ªé–‹é–‰åŸå‰‡ æŠ½è±¡å·¥å» æ¨¡å¼:\néœ€è¦å‰µå»ºä¸€ç³»åˆ—ç›¸é—œçš„ç”¢å“ ç³»çµ±éœ€è¦åœ¨å¤šå€‹ç”¢å“æ—ä¸­åˆ‡æ› éœ€è¦ç¢ºä¿ç”¢å“æ—çš„ä¸€è‡´æ€§ é—œéµè¦é» è·è²¬åˆ†é›¢: å°‡å°è±¡å‰µå»ºé‚è¼¯èˆ‡æ¥­å‹™é‚è¼¯åˆ†é›¢ æ“´å±•æ€§: æ–°å¢ç”¢å“é¡å‹æ™‚ä¸éœ€è¦ä¿®æ”¹ç¾æœ‰ä»£ç¢¼ ä¸€è‡´æ€§: é€šéå·¥å» ç¢ºä¿å°è±¡å‰µå»ºçš„ä¸€è‡´æ€§ å¯æ¸¬è©¦æ€§: ä¾¿æ–¼é€²è¡Œå–®å…ƒæ¸¬è©¦å’Œæ¨¡æ“¬ Spring Boot é›†æˆå„ªå‹¢ ä¾è³´æ³¨å…¥: è‡ªå‹•ç®¡ç†å·¥å» å’Œç”¢å“çš„ä¾è³´é—œä¿‚ é…ç½®é©…å‹•: é€šéé…ç½®æ–‡ä»¶å‹•æ…‹é¸æ“‡å¯¦ç¾ AOP æ”¯æŒ: å¯ä»¥åœ¨å°è±¡å‰µå»ºéç¨‹ä¸­æ·»åŠ æ©«åˆ‡é—œæ³¨é» è‡ªå‹•é…ç½®: åŸºæ–¼æ¢ä»¶è‡ªå‹•é…ç½®åˆé©çš„å·¥å» å¯¦ç¾ å·¥å» æ¨¡å¼æ˜¯ä¼æ¥­ç´šæ‡‰ç”¨é–‹ç™¼ä¸­æœ€é‡è¦çš„è¨­è¨ˆæ¨¡å¼ä¹‹ä¸€ï¼Œåˆç†ä½¿ç”¨å¯ä»¥å¤§å¤§æé«˜ä»£ç¢¼çš„å¯ç¶­è­·æ€§ã€å¯æ“´å±•æ€§å’Œå¯æ¸¬è©¦æ€§ã€‚åœ¨ Spring Boot ç’°å¢ƒä¸­ï¼Œçµåˆä¾è³´æ³¨å…¥å’Œè‡ªå‹•é…ç½®ï¼Œå¯ä»¥æ§‹å»ºå‡ºæ›´åŠ éˆæ´»å’Œå¼·å¤§çš„æ‡‰ç”¨ç³»çµ±ã€‚\n","permalink":"https://xinqilin.github.io/post/architecture/factory/","tags":[],"title":"DesignPattern - Creational - Factory Pattern"},{"content":"æ¦‚è¿° Singletonï¼ˆå–®ä¾‹æ¨¡å¼ï¼‰æ˜¯æœ€å¸¸è¦‹çš„å‰µå»ºå‹è¨­è¨ˆæ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒç¢ºä¿ä¸€å€‹é¡åˆ¥åœ¨æ•´å€‹æ‡‰ç”¨ç¨‹å¼ç”Ÿå‘½é€±æœŸä¸­åªæœ‰ä¸€å€‹å¯¦ä¾‹å­˜åœ¨ï¼Œä¸¦æä¾›å…¨åŸŸè¨ªå•é»ã€‚é€™å€‹æ¨¡å¼å»£æ³›æ‡‰ç”¨æ–¼è³‡æ–™åº«é€£ç·šæ± ã€æ—¥å¿—è¨˜éŒ„å™¨ã€å¿«å–ç®¡ç†å™¨ã€è¨­å®šç®¡ç†å™¨ç­‰å ´æ™¯ã€‚\nå–®ä¾‹æ¨¡å¼çš„æ ¸å¿ƒç‰¹å¾µ å”¯ä¸€å¯¦ä¾‹ï¼šç¢ºä¿é¡åˆ¥åªæœ‰ä¸€å€‹å¯¦ä¾‹ å…¨åŸŸè¨ªå•ï¼šæä¾›å…¨åŸŸè¨ªå•è©²å¯¦ä¾‹çš„æ–¹æ³• è‡ªæˆ‘å¯¦ä¾‹åŒ–ï¼šé¡åˆ¥è‡ªå·±è² è²¬å‰µå»ºå’Œç®¡ç†å¯¦ä¾‹ å»¶é²åˆå§‹åŒ–ï¼šé€šå¸¸åœ¨é¦–æ¬¡éœ€è¦æ™‚æ‰å‰µå»ºå¯¦ä¾‹ å‚³çµ±å¯¦ä½œæ–¹å¼ 1. é¤“æ¼¢å¼ï¼ˆEager Initializationï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 /** * é¤“æ¼¢å¼å–®ä¾‹ - é¡åˆ¥è¼‰å…¥æ™‚ç«‹å³å‰µå»ºå¯¦ä¾‹ * å„ªé»ï¼šåŸ·è¡Œç·’å®‰å…¨ã€å¯¦ä½œç°¡å–® * ç¼ºé»ï¼šä¸ç®¡æ˜¯å¦ä½¿ç”¨éƒ½æœƒå‰µå»ºå¯¦ä¾‹ï¼Œå¯èƒ½é€ æˆè³‡æºæµªè²» */ public class EagerSingleton { // åœ¨é¡åˆ¥è¼‰å…¥æ™‚å°±å‰µå»ºå¯¦ä¾‹ private static final EagerSingleton INSTANCE = new EagerSingleton(); // ç§æœ‰å»ºæ§‹å­é˜²æ­¢å¤–éƒ¨å¯¦ä¾‹åŒ– private EagerSingleton() { // é˜²æ­¢åå°„æ”»æ“Š if (INSTANCE != null) { throw new IllegalStateException(\u0026#34;å–®ä¾‹å·²å­˜åœ¨ï¼Œä¸èƒ½å‰µå»ºæ–°å¯¦ä¾‹\u0026#34;); } System.out.println(\u0026#34;EagerSingleton å¯¦ä¾‹å‰µå»º\u0026#34;); } public static EagerSingleton getInstance() { return INSTANCE; } // æ¥­å‹™æ–¹æ³•ç¯„ä¾‹ public void doSomething() { System.out.println(\u0026#34;åŸ·è¡Œ EagerSingleton æ¥­å‹™é‚è¼¯\u0026#34;); } // é˜²æ­¢å…‹éš†æ”»æ“Š @Override protected Object clone() throws CloneNotSupportedException { throw new CloneNotSupportedException(\u0026#34;å–®ä¾‹ä¸æ”¯æ´å…‹éš†\u0026#34;); } // é˜²æ­¢åºåˆ—åŒ–æ”»æ“Š private Object readResolve() { return INSTANCE; } } 2. æ‡¶æ¼¢å¼ï¼ˆLazy Initializationï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /** * æ‡¶æ¼¢å¼å–®ä¾‹ - å»¶é²å‰µå»ºå¯¦ä¾‹ * å•é¡Œï¼šåŸ·è¡Œç·’ä¸å®‰å…¨ */ public class LazySingleton { private static LazySingleton instance; private LazySingleton() { System.out.println(\u0026#34;LazySingleton å¯¦ä¾‹å‰µå»º\u0026#34;); } // âŒ åŸ·è¡Œç·’ä¸å®‰å…¨çš„å¯¦ä½œ public static LazySingleton getInstance() { if (instance == null) { instance = new LazySingleton(); } return instance; } } 3. åŸ·è¡Œç·’å®‰å…¨çš„æ‡¶æ¼¢å¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 /** * åŸ·è¡Œç·’å®‰å…¨çš„æ‡¶æ¼¢å¼å–®ä¾‹ * å„ªé»ï¼šåŸ·è¡Œç·’å®‰å…¨ã€å»¶é²åˆå§‹åŒ– * ç¼ºé»ï¼šæ€§èƒ½é–‹éŠ·å¤§ï¼ˆæ¯æ¬¡è¨ªå•éƒ½éœ€è¦åŒæ­¥ï¼‰ */ public class ThreadSafeLazySingleton { private static ThreadSafeLazySingleton instance; private ThreadSafeLazySingleton() { System.out.println(\u0026#34;ThreadSafeLazySingleton å¯¦ä¾‹å‰µå»º\u0026#34;); } // âŒ æ€§èƒ½è¼ƒå·®çš„åŒæ­¥æ–¹æ³• public static synchronized ThreadSafeLazySingleton getInstance() { if (instance == null) { instance = new ThreadSafeLazySingleton(); } return instance; } } æ¨è–¦çš„ç¾ä»£åŒ–å¯¦ä½œæ–¹å¼ 1. Double-Checked Lockingï¼ˆé›™é‡æª¢æŸ¥é–å®šï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 /** * é›™é‡æª¢æŸ¥é–å®šå–®ä¾‹ * å„ªé»ï¼šåŸ·è¡Œç·’å®‰å…¨ã€æ€§èƒ½å¥½ã€å»¶é²åˆå§‹åŒ– * æ¨è–¦ï¼šç¾ä»£ Java æ‡‰ç”¨çš„æ¨™æº–å¯¦ä½œ */ public class DoubleCheckedSingleton { // volatile é—œéµå­—ç¢ºä¿å¯è¦‹æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’åº private static volatile DoubleCheckedSingleton instance; private DoubleCheckedSingleton() { // é˜²æ­¢åå°„æ”»æ“Š if (instance != null) { throw new IllegalStateException(\u0026#34;å–®ä¾‹å·²å­˜åœ¨ï¼Œä¸èƒ½å‰µå»ºæ–°å¯¦ä¾‹\u0026#34;); } // æ¨¡æ“¬è¤‡é›œçš„åˆå§‹åŒ–éç¨‹ try { Thread.sleep(100); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } System.out.println(\u0026#34;DoubleCheckedSingleton å¯¦ä¾‹å‰µå»º\u0026#34;); } public static DoubleCheckedSingleton getInstance() { // ç¬¬ä¸€æ¬¡æª¢æŸ¥ï¼šé¿å…ä¸å¿…è¦çš„åŒæ­¥ if (instance == null) { synchronized (DoubleCheckedSingleton.class) { // ç¬¬äºŒæ¬¡æª¢æŸ¥ï¼šç¢ºä¿åªå‰µå»ºä¸€å€‹å¯¦ä¾‹ if (instance == null) { instance = new DoubleCheckedSingleton(); } } } return instance; } public void performOperation() { System.out.println(\u0026#34;åŸ·è¡Œ DoubleCheckedSingleton æ“ä½œ\u0026#34;); } // é˜²æ­¢å…‹éš†æ”»æ“Š @Override protected Object clone() throws CloneNotSupportedException { throw new CloneNotSupportedException(\u0026#34;å–®ä¾‹ä¸æ”¯æ´å…‹éš†\u0026#34;); } // é˜²æ­¢åºåˆ—åŒ–æ”»æ“Š private Object readResolve() { return instance; } } 2. éœæ…‹å…§éƒ¨é¡åˆ¥ï¼ˆInitialization-on-demand Holderï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 /** * éœæ…‹å…§éƒ¨é¡åˆ¥å–®ä¾‹ * å„ªé»ï¼šåŸ·è¡Œç·’å®‰å…¨ã€å»¶é²åˆå§‹åŒ–ã€æ€§èƒ½æœ€ä½³ã€ç¨‹å¼ç¢¼ç°¡æ½” * æ¨è–¦ï¼šæœ€å„ªé›…çš„å¯¦ä½œæ–¹å¼ */ public class StaticHolderSingleton { private StaticHolderSingleton() { System.out.println(\u0026#34;StaticHolderSingleton å¯¦ä¾‹å‰µå»º\u0026#34;); } // éœæ…‹å…§éƒ¨é¡åˆ¥ï¼Œåªæœ‰åœ¨è¢«å¼•ç”¨æ™‚æ‰æœƒè¼‰å…¥ private static class SingletonHolder { private static final StaticHolderSingleton INSTANCE = new StaticHolderSingleton(); } public static StaticHolderSingleton getInstance() { return SingletonHolder.INSTANCE; } public void executeTask() { System.out.println(\u0026#34;åŸ·è¡Œ StaticHolderSingleton ä»»å‹™\u0026#34;); } } 3. æšèˆ‰å–®ä¾‹ï¼ˆæ¨è–¦ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 /** * æšèˆ‰å–®ä¾‹ * å„ªé»ï¼šåŸ·è¡Œç·’å®‰å…¨ã€é˜²æ­¢åå°„å’Œåºåˆ—åŒ–æ”»æ“Šã€ç¨‹å¼ç¢¼æœ€ç°¡æ½” * æ¨è–¦ï¼šJoshua Bloch æ¨è–¦çš„æœ€ä½³å¯¦ä½œæ–¹å¼ */ public enum EnumSingleton { INSTANCE; // å¯¦ä¾‹è®Šæ•¸ private String data; // å»ºæ§‹å­ï¼ˆæšèˆ‰çš„å»ºæ§‹å­ç¸½æ˜¯ç§æœ‰çš„ï¼‰ EnumSingleton() { this.data = \u0026#34;EnumSingleton åˆå§‹åŒ–è³‡æ–™\u0026#34;; System.out.println(\u0026#34;EnumSingleton å¯¦ä¾‹å‰µå»º\u0026#34;); } // æ¥­å‹™æ–¹æ³• public void setData(String data) { this.data = data; } public String getData() { return data; } public void processData() { System.out.println(\u0026#34;è™•ç†è³‡æ–™: \u0026#34; + data); } // å¯ä»¥å¯¦ä½œä»‹é¢ public void performAction() { System.out.println(\u0026#34;åŸ·è¡Œ EnumSingleton å‹•ä½œ\u0026#34;); } } // ä½¿ç”¨ç¯„ä¾‹ class EnumSingletonExample { public static void main(String[] args) { EnumSingleton singleton = EnumSingleton.INSTANCE; singleton.setData(\u0026#34;æ›´æ–°çš„è³‡æ–™\u0026#34;); singleton.processData(); } } å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹ 1. è³‡æ–™åº«é€£ç·šç®¡ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 /** * è³‡æ–™åº«é€£ç·šç®¡ç†å™¨å–®ä¾‹ * ä½¿ç”¨éœæ…‹å…§éƒ¨é¡åˆ¥å¯¦ä½œ */ public class DatabaseManager { private final HikariDataSource dataSource; private DatabaseManager() { // åˆå§‹åŒ–é€£ç·šæ± é…ç½® HikariConfig config = new HikariConfig(); config.setJdbcUrl(\u0026#34;jdbc:mysql://localhost:3306/mydb\u0026#34;); config.setUsername(\u0026#34;user\u0026#34;); config.setPassword(\u0026#34;password\u0026#34;); config.setMaximumPoolSize(20); config.setMinimumIdle(5); config.setConnectionTimeout(30000); config.setIdleTimeout(600000); config.setMaxLifetime(1800000); this.dataSource = new HikariDataSource(config); System.out.println(\u0026#34;è³‡æ–™åº«é€£ç·šæ± åˆå§‹åŒ–å®Œæˆ\u0026#34;); } private static class Holder { private static final DatabaseManager INSTANCE = new DatabaseManager(); } public static DatabaseManager getInstance() { return Holder.INSTANCE; } public Connection getConnection() throws SQLException { return dataSource.getConnection(); } public void closeDataSource() { if (dataSource != null \u0026amp;\u0026amp; !dataSource.isClosed()) { dataSource.close(); System.out.println(\u0026#34;è³‡æ–™åº«é€£ç·šæ± å·²é—œé–‰\u0026#34;); } } // JVM é—œé–‰æ™‚æ¸…ç†è³‡æº static { Runtime.getRuntime().addShutdownHook(new Thread(() -\u0026gt; { DatabaseManager.getInstance().closeDataSource(); })); } } 2. æ‡‰ç”¨ç¨‹å¼è¨­å®šç®¡ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 /** * æ‡‰ç”¨ç¨‹å¼è¨­å®šç®¡ç†å™¨ * ä½¿ç”¨æšèˆ‰å¯¦ä½œï¼Œæ”¯æ´å‹•æ…‹è¨­å®šæ›´æ–° */ public enum ConfigurationManager { INSTANCE; private final Properties properties; private final Map\u0026lt;String, Object\u0026gt; runtimeConfig; private final ReadWriteLock lock; ConfigurationManager() { this.properties = new Properties(); this.runtimeConfig = new ConcurrentHashMap\u0026lt;\u0026gt;(); this.lock = new ReentrantReadWriteLock(); loadConfiguration(); } private void loadConfiguration() { try (InputStream input = getClass().getClassLoader() .getResourceAsStream(\u0026#34;application.properties\u0026#34;)) { if (input != null) { properties.load(input); System.out.println(\u0026#34;è¨­å®šæª”è¼‰å…¥å®Œæˆ\u0026#34;); } else { System.out.println(\u0026#34;æ‰¾ä¸åˆ°è¨­å®šæª”ï¼Œä½¿ç”¨é è¨­è¨­å®š\u0026#34;); loadDefaultConfiguration(); } } catch (IOException e) { System.err.println(\u0026#34;è¼‰å…¥è¨­å®šæª”å¤±æ•—: \u0026#34; + e.getMessage()); loadDefaultConfiguration(); } } private void loadDefaultConfiguration() { properties.setProperty(\u0026#34;app.name\u0026#34;, \u0026#34;MyApplication\u0026#34;); properties.setProperty(\u0026#34;app.version\u0026#34;, \u0026#34;1.0.0\u0026#34;); properties.setProperty(\u0026#34;app.environment\u0026#34;, \u0026#34;development\u0026#34;); properties.setProperty(\u0026#34;database.pool.max\u0026#34;, \u0026#34;20\u0026#34;); properties.setProperty(\u0026#34;cache.ttl\u0026#34;, \u0026#34;3600\u0026#34;); } public String getProperty(String key) { lock.readLock().lock(); try { return properties.getProperty(key); } finally { lock.readLock().unlock(); } } public String getProperty(String key, String defaultValue) { lock.readLock().lock(); try { return properties.getProperty(key, defaultValue); } finally { lock.readLock().unlock(); } } public void setProperty(String key, String value) { lock.writeLock().lock(); try { properties.setProperty(key, value); System.out.println(\u0026#34;è¨­å®šå·²æ›´æ–°: \u0026#34; + key + \u0026#34; = \u0026#34; + value); } finally { lock.writeLock().unlock(); } } public int getIntProperty(String key, int defaultValue) { try { String value = getProperty(key); return value != null ? Integer.parseInt(value) : defaultValue; } catch (NumberFormatException e) { return defaultValue; } } public boolean getBooleanProperty(String key, boolean defaultValue) { String value = getProperty(key); return value != null ? Boolean.parseBoolean(value) : defaultValue; } // åŸ·è¡Œæ™‚è¨­å®šï¼ˆä¸æœƒæŒä¹…åŒ–ï¼‰ public void setRuntimeConfig(String key, Object value) { runtimeConfig.put(key, value); } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; T getRuntimeConfig(String key, Class\u0026lt;T\u0026gt; type, T defaultValue) { Object value = runtimeConfig.get(key); return type.isInstance(value) ? (T) value : defaultValue; } public void reloadConfiguration() { lock.writeLock().lock(); try { properties.clear(); loadConfiguration(); System.out.println(\u0026#34;è¨­å®šå·²é‡æ–°è¼‰å…¥\u0026#34;); } finally { lock.writeLock().unlock(); } } public Map\u0026lt;String, String\u0026gt; getAllProperties() { lock.readLock().lock(); try { Map\u0026lt;String, String\u0026gt; result = new HashMap\u0026lt;\u0026gt;(); for (String key : properties.stringPropertyNames()) { result.put(key, properties.getProperty(key)); } return result; } finally { lock.readLock().unlock(); } } } 3. æ—¥å¿—ç®¡ç†å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 /** * è‡ªè¨‚æ—¥å¿—ç®¡ç†å™¨å–®ä¾‹ * ä½¿ç”¨é›™é‡æª¢æŸ¥é–å®šå¯¦ä½œ */ public class LoggerManager { private static volatile LoggerManager instance; private final Map\u0026lt;String, Logger\u0026gt; loggers; private final String logLevel; private final boolean enableConsoleOutput; private final String logFilePath; private LoggerManager() { this.loggers = new ConcurrentHashMap\u0026lt;\u0026gt;(); // å¾è¨­å®šç®¡ç†å™¨ç²å–è¨­å®š ConfigurationManager config = ConfigurationManager.INSTANCE; this.logLevel = config.getProperty(\u0026#34;log.level\u0026#34;, \u0026#34;INFO\u0026#34;); this.enableConsoleOutput = config.getBooleanProperty(\u0026#34;log.console.enabled\u0026#34;, true); this.logFilePath = config.getProperty(\u0026#34;log.file.path\u0026#34;, \u0026#34;logs/application.log\u0026#34;); initializeLoggers(); System.out.println(\u0026#34;æ—¥å¿—ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ\u0026#34;); } public static LoggerManager getInstance() { if (instance == null) { synchronized (LoggerManager.class) { if (instance == null) { instance = new LoggerManager(); } } } return instance; } private void initializeLoggers() { // åˆå§‹åŒ–é è¨­æ—¥å¿—è¨˜éŒ„å™¨ createLogger(\u0026#34;DEFAULT\u0026#34;); createLogger(\u0026#34;DATABASE\u0026#34;); createLogger(\u0026#34;SECURITY\u0026#34;); createLogger(\u0026#34;PERFORMANCE\u0026#34;); } public Logger getLogger(String name) { return loggers.computeIfAbsent(name, this::createLogger); } private Logger createLogger(String name) { Logger logger = LoggerFactory.getLogger(name); // é€™è£¡å¯ä»¥æ ¹æ“šéœ€è¦é…ç½® logger çš„ appender å’Œ level // å¯¦éš›æ‡‰ç”¨ä¸­é€šå¸¸ä½¿ç”¨ logback.xml æˆ– log4j2.xml é…ç½® System.out.println(\u0026#34;å‰µå»º Logger: \u0026#34; + name); return logger; } public void logInfo(String loggerName, String message) { getLogger(loggerName).info(message); } public void logError(String loggerName, String message, Throwable throwable) { getLogger(loggerName).error(message, throwable); } public void logDebug(String loggerName, String message) { getLogger(loggerName).debug(message); } public void logWarn(String loggerName, String message) { getLogger(loggerName).warn(message); } // ç²å–æ‰€æœ‰ logger çš„çµ±è¨ˆè³‡è¨Š public Map\u0026lt;String, String\u0026gt; getLoggerStats() { Map\u0026lt;String, String\u0026gt; stats = new HashMap\u0026lt;\u0026gt;(); stats.put(\u0026#34;totalLoggers\u0026#34;, String.valueOf(loggers.size())); stats.put(\u0026#34;logLevel\u0026#34;, logLevel); stats.put(\u0026#34;consoleOutput\u0026#34;, String.valueOf(enableConsoleOutput)); stats.put(\u0026#34;logFilePath\u0026#34;, logFilePath); return stats; } } Spring æ¡†æ¶ä¸­çš„å–®ä¾‹æ¨¡å¼ 1. Spring Bean çš„å–®ä¾‹ä½œç”¨åŸŸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 /** * Spring ä¸­çš„å–®ä¾‹ Bean * Spring é è¨­ä½¿ç”¨å–®ä¾‹ä½œç”¨åŸŸç®¡ç† Bean */ @Component @Scope(ConfigurableBeanFactory.SCOPE_SINGLETON) // é è¨­å€¼ï¼Œå¯çœç•¥ public class SpringSingletonService { private final String instanceId; private final LocalDateTime createdAt; public SpringSingletonService() { this.instanceId = UUID.randomUUID().toString(); this.createdAt = LocalDateTime.now(); System.out.println(\u0026#34;SpringSingletonService å¯¦ä¾‹å‰µå»º: \u0026#34; + instanceId); } public String getInstanceInfo() { return String.format(\u0026#34;å¯¦ä¾‹ID: %s, å‰µå»ºæ™‚é–“: %s\u0026#34;, instanceId, createdAt); } @PostConstruct private void init() { System.out.println(\u0026#34;SpringSingletonService åˆå§‹åŒ–å®Œæˆ\u0026#34;); } @PreDestroy private void destroy() { System.out.println(\u0026#34;SpringSingletonService éŠ·æ¯€: \u0026#34; + instanceId); } } /** * ä½¿ç”¨ @Configuration å’Œ @Bean è¨»è§£å‰µå»ºå–®ä¾‹ */ @Configuration public class SingletonBeanConfiguration { @Bean @Scope(ConfigurableBeanFactory.SCOPE_SINGLETON) public CacheManager cacheManager() { return new ConcurrentMapCacheManager(\u0026#34;users\u0026#34;, \u0026#34;products\u0026#34;, \u0026#34;orders\u0026#34;); } @Bean public TaskExecutor taskExecutor() { ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor(); executor.setCorePoolSize(5); executor.setMaxPoolSize(20); executor.setQueueCapacity(100); executor.setThreadNamePrefix(\u0026#34;App-\u0026#34;); executor.initialize(); return executor; } } 2. Spring Boot ä¸­çš„å–®ä¾‹æœå‹™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 /** * Spring Boot ä¸­çš„å–®ä¾‹æœå‹™ç¯„ä¾‹ */ @Service public class UserService { private final UserRepository userRepository; private final CacheManager cacheManager; private final String serviceId; public UserService(UserRepository userRepository, CacheManager cacheManager) { this.userRepository = userRepository; this.cacheManager = cacheManager; this.serviceId = UUID.randomUUID().toString(); System.out.println(\u0026#34;UserService å–®ä¾‹å‰µå»º: \u0026#34; + serviceId); } @Cacheable(\u0026#34;users\u0026#34;) public User findById(Long id) { System.out.println(\u0026#34;å¾è³‡æ–™åº«è¼‰å…¥ç”¨æˆ¶: \u0026#34; + id); return userRepository.findById(id).orElse(null); } @CacheEvict(value = \u0026#34;users\u0026#34;, key = \u0026#34;#user.id\u0026#34;) public User save(User user) { return userRepository.save(user); } public String getServiceInfo() { return \u0026#34;UserService å¯¦ä¾‹ID: \u0026#34; + serviceId; } } å–®ä¾‹æ¨¡å¼çš„æ½›åœ¨å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ 1. åå°„æ”»æ“Šé˜²è­· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 /** * é˜²ç¯„åå°„æ”»æ“Šçš„å–®ä¾‹å¯¦ä½œ */ public class ReflectionSafeSingleton { private static volatile ReflectionSafeSingleton instance; private static boolean instanceCreated = false; private ReflectionSafeSingleton() { synchronized (ReflectionSafeSingleton.class) { if (instanceCreated) { throw new IllegalStateException(\u0026#34;å–®ä¾‹å·²å­˜åœ¨ï¼Œç¦æ­¢é€éåå°„å‰µå»ºæ–°å¯¦ä¾‹\u0026#34;); } instanceCreated = true; } System.out.println(\u0026#34;ReflectionSafeSingleton å¯¦ä¾‹å‰µå»º\u0026#34;); } public static ReflectionSafeSingleton getInstance() { if (instance == null) { synchronized (ReflectionSafeSingleton.class) { if (instance == null) { instance = new ReflectionSafeSingleton(); } } } return instance; } } // æ¸¬è©¦åå°„æ”»æ“Š class ReflectionAttackTest { public static void main(String[] args) { try { ReflectionSafeSingleton singleton1 = ReflectionSafeSingleton.getInstance(); Constructor\u0026lt;ReflectionSafeSingleton\u0026gt; constructor = ReflectionSafeSingleton.class.getDeclaredConstructor(); constructor.setAccessible(true); // é€™è£¡æœƒæ‹‹å‡º IllegalStateException ReflectionSafeSingleton singleton2 = constructor.newInstance(); } catch (Exception e) { System.out.println(\u0026#34;åå°„æ”»æ“Šè¢«é˜»æ­¢: \u0026#34; + e.getMessage()); } } } 2. åºåˆ—åŒ–æ”»æ“Šé˜²è­· 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 /** * é˜²ç¯„åºåˆ—åŒ–æ”»æ“Šçš„å–®ä¾‹å¯¦ä½œ */ public class SerializationSafeSingleton implements Serializable { private static final long serialVersionUID = 1L; private static volatile SerializationSafeSingleton instance; private SerializationSafeSingleton() { System.out.println(\u0026#34;SerializationSafeSingleton å¯¦ä¾‹å‰µå»º\u0026#34;); } public static SerializationSafeSingleton getInstance() { if (instance == null) { synchronized (SerializationSafeSingleton.class) { if (instance == null) { instance = new SerializationSafeSingleton(); } } } return instance; } // é˜²æ­¢åºåˆ—åŒ–æ”»æ“Šçš„é—œéµæ–¹æ³• private Object readResolve() { return getInstance(); } // å¯é¸ï¼šè‡ªè¨‚åºåˆ—åŒ–é‚è¼¯ private void writeObject(ObjectOutputStream out) throws IOException { out.defaultWriteObject(); } private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException { in.defaultReadObject(); } } 3. å¤šåŸ·è¡Œç·’æ¸¬è©¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 /** * å¤šåŸ·è¡Œç·’ç’°å¢ƒä¸‹çš„å–®ä¾‹æ¸¬è©¦ */ public class SingletonThreadTest { public static void main(String[] args) throws InterruptedException { final int threadCount = 1000; final CountDownLatch startLatch = new CountDownLatch(1); final CountDownLatch endLatch = new CountDownLatch(threadCount); final Set\u0026lt;Integer\u0026gt; instanceHashCodes = ConcurrentHashMap.newKeySet(); // å‰µå»ºå¤šå€‹åŸ·è¡Œç·’åŒæ™‚ç²å–å–®ä¾‹ for (int i = 0; i \u0026lt; threadCount; i++) { new Thread(() -\u0026gt; { try { startLatch.await(); // ç­‰å¾…é–‹å§‹ä¿¡è™Ÿ // æ¸¬è©¦ä¸åŒçš„å–®ä¾‹å¯¦ä½œ DoubleCheckedSingleton instance1 = DoubleCheckedSingleton.getInstance(); StaticHolderSingleton instance2 = StaticHolderSingleton.getInstance(); EnumSingleton instance3 = EnumSingleton.INSTANCE; instanceHashCodes.add(System.identityHashCode(instance1)); instanceHashCodes.add(System.identityHashCode(instance2)); instanceHashCodes.add(System.identityHashCode(instance3)); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } finally { endLatch.countDown(); } }).start(); } System.out.println(\u0026#34;é–‹å§‹å¤šåŸ·è¡Œç·’å–®ä¾‹æ¸¬è©¦...\u0026#34;); startLatch.countDown(); // ç™¼å‡ºé–‹å§‹ä¿¡è™Ÿ endLatch.await(); // ç­‰å¾…æ‰€æœ‰åŸ·è¡Œç·’å®Œæˆ System.out.println(\u0026#34;æ¸¬è©¦å®Œæˆ\u0026#34;); System.out.println(\u0026#34;DoubleCheckedSingleton ä¸åŒå¯¦ä¾‹æ•¸é‡: \u0026#34; + (instanceHashCodes.size() \u0026gt;= 3 ? \u0026#34;3 å€‹ï¼ˆæ­£å¸¸ï¼‰\u0026#34; : \u0026#34;ç•°å¸¸\u0026#34;)); } } å–®ä¾‹æ¨¡å¼çš„æ•ˆèƒ½æ¯”è¼ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 /** * ä¸åŒå–®ä¾‹å¯¦ä½œçš„æ•ˆèƒ½æ¸¬è©¦ */ public class SingletonPerformanceTest { private static final int ITERATIONS = 10_000_000; public static void main(String[] args) { // é ç†± JVM warmUp(); // æ¸¬è©¦ä¸åŒå¯¦ä½œçš„æ•ˆèƒ½ testEagerSingleton(); testDoubleCheckedSingleton(); testStaticHolderSingleton(); testEnumSingleton(); } private static void warmUp() { for (int i = 0; i \u0026lt; 100_000; i++) { EagerSingleton.getInstance(); DoubleCheckedSingleton.getInstance(); StaticHolderSingleton.getInstance(); EnumSingleton.INSTANCE.getData(); } } private static void testEagerSingleton() { long startTime = System.nanoTime(); for (int i = 0; i \u0026lt; ITERATIONS; i++) { EagerSingleton.getInstance(); } long endTime = System.nanoTime(); System.out.printf(\u0026#34;EagerSingleton: %.2f ms%n\u0026#34;, (endTime - startTime) / 1_000_000.0); } private static void testDoubleCheckedSingleton() { long startTime = System.nanoTime(); for (int i = 0; i \u0026lt; ITERATIONS; i++) { DoubleCheckedSingleton.getInstance(); } long endTime = System.nanoTime(); System.out.printf(\u0026#34;DoubleCheckedSingleton: %.2f ms%n\u0026#34;, (endTime - startTime) / 1_000_000.0); } private static void testStaticHolderSingleton() { long startTime = System.nanoTime(); for (int i = 0; i \u0026lt; ITERATIONS; i++) { StaticHolderSingleton.getInstance(); } long endTime = System.nanoTime(); System.out.printf(\u0026#34;StaticHolderSingleton: %.2f ms%n\u0026#34;, (endTime - startTime) / 1_000_000.0); } private static void testEnumSingleton() { long startTime = System.nanoTime(); for (int i = 0; i \u0026lt; ITERATIONS; i++) { EnumSingleton.INSTANCE.getData(); } long endTime = System.nanoTime(); System.out.printf(\u0026#34;EnumSingleton: %.2f ms%n\u0026#34;, (endTime - startTime) / 1_000_000.0); } } ç¸½çµèˆ‡æœ€ä½³å¯¦è¸ æ¨è–¦çš„å¯¦ä½œæ–¹å¼ æšèˆ‰å–®ä¾‹ï¼šé©åˆå¤§å¤šæ•¸æƒ…æ³ï¼Œæœ€å®‰å…¨ã€æœ€ç°¡æ½” éœæ…‹å…§éƒ¨é¡åˆ¥ï¼šé©åˆéœ€è¦å»¶é²åˆå§‹åŒ–çš„å ´æ™¯ é›™é‡æª¢æŸ¥é–å®šï¼šé©åˆè¤‡é›œåˆå§‹åŒ–é‚è¼¯çš„å ´æ™¯ é¸æ“‡æŒ‡å— å ´æ™¯ æ¨è–¦å¯¦ä½œ åŸå›  ä¸€èˆ¬ç”¨é€” æšèˆ‰å–®ä¾‹ æœ€å®‰å…¨ã€æœ€ç°¡æ½” Spring æ‡‰ç”¨ Spring Bean æ¡†æ¶ç®¡ç†ç”Ÿå‘½é€±æœŸ å»¶é²åˆå§‹åŒ– éœæ…‹å…§éƒ¨é¡åˆ¥ æ€§èƒ½æœ€ä½³ã€åŸ·è¡Œç·’å®‰å…¨ è¤‡é›œåˆå§‹åŒ– é›™é‡æª¢æŸ¥é–å®š éˆæ´»æ€§é«˜ ç°¡å–®å ´æ™¯ é¤“æ¼¢å¼ å¯¦ä½œç°¡å–® æ³¨æ„äº‹é … é¿å…éåº¦ä½¿ç”¨ï¼šå–®ä¾‹æœƒå¢åŠ ç¨‹å¼ç¢¼çš„è€¦åˆåº¦ è€ƒæ…®æ¸¬è©¦æ€§ï¼šå–®ä¾‹å¯èƒ½å½±éŸ¿å–®å…ƒæ¸¬è©¦çš„ç¨ç«‹æ€§ åŸ·è¡Œç·’å®‰å…¨ï¼šç¢ºä¿åœ¨å¤šåŸ·è¡Œç·’ç’°å¢ƒä¸‹çš„æ­£ç¢ºæ€§ è³‡æºæ¸…ç†ï¼šé©ç•¶æ™‚å€™é‡‹æ”¾å–®ä¾‹æŒæœ‰çš„è³‡æº åºåˆ—åŒ–è€ƒæ…®ï¼šå¯¦ä½œ readResolve() æ–¹æ³•é˜²æ­¢åºåˆ—åŒ–æ”»æ“Š ç¾ä»£æ›¿ä»£æ–¹æ¡ˆ åœ¨ç¾ä»£æ‡‰ç”¨é–‹ç™¼ä¸­ï¼Œå¯ä»¥è€ƒæ…®ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆï¼š\nä¾è³´æ³¨å…¥å®¹å™¨ï¼šå¦‚ Spring IoC å®¹å™¨ éœæ…‹å·¥å» æ–¹æ³•ï¼šæä¾›æ›´å¥½çš„æ¸¬è©¦æ€§ Builder æ¨¡å¼ï¼šé©åˆè¤‡é›œå°è±¡çš„å‰µå»º Registry æ¨¡å¼ï¼šç®¡ç†å¤šå€‹ç›¸é—œçš„å–®ä¾‹ å–®ä¾‹æ¨¡å¼é›–ç„¶ç°¡å–®ï¼Œä½†åœ¨å¯¦éš›æ‡‰ç”¨ä¸­éœ€è¦è¬¹æ…è€ƒæ…®å…¶é©ç”¨æ€§å’Œå¯¦ä½œæ–¹å¼ã€‚é¸æ“‡åˆé©çš„å¯¦ä½œæ–¹æ¡ˆèƒ½å¤ ç¢ºä¿ç¨‹å¼ç¢¼çš„å¥å£¯æ€§å’Œå¯ç¶­è­·æ€§ã€‚\nåƒè€ƒè³‡æ–™ Effective Java by Joshua Bloch Design Patterns: Elements of Reusable Object-Oriented Software Java Concurrency in Practice Spring Framework Documentation ","permalink":"https://xinqilin.github.io/post/architecture/singleton/","tags":["Design Pattern","Singleton","Java","Thread Safety","Best Practices","Creational Pattern"],"title":"Singleton è¨­è¨ˆæ¨¡å¼å®Œæ•´æŒ‡å—ï¼šå–®ä¾‹å¯¦ä½œèˆ‡ç¾ä»£åŒ–æœ€ä½³å¯¦è¸"}]